<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/icons/tuba-icon-32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/icons/tuba-icon-16.png">
    <link rel="shortcut icon" href="/icons/tuba-icon-32.png">
    <link rel="apple-touch-icon" href="/icons/tuba-icon-180.png?v=20260105">
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/tuba-icon-180.png?v=20260105">
    <link rel="apple-touch-icon" sizes="167x167" href="/icons/tuba-icon-167.png?v=20260105">
    <link rel="apple-touch-icon" sizes="152x152" href="/icons/tuba-icon-152.png?v=20260105">
    <link rel="apple-touch-icon" sizes="120x120" href="/icons/tuba-icon-120.png?v=20260105">
    <link rel="apple-touch-icon-precomposed" href="/icons/tuba-icon-180.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/icons/tuba-icon-512.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/icons/tuba-icon-192.png">
    <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
    <meta http-equiv="Content-Security-Policy"
        content="default-src 'self' https: data: blob:; img-src 'self' https: data: blob:; style-src 'self' 'unsafe-inline' https:; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com; connect-src 'self' https://ipatajqjrbwaicwdzpnp.supabase.co https://*.supabase.co https://*.supabase.in https://cdn.jsdelivr.net https://cdnjs.cloudflare.com; object-src 'none'; base-uri 'self'; form-action 'self';">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="TUBA">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="msapplication-TileColor" content="#000000">
    <meta name="msapplication-tap-highlight" content="no">
    <meta name="format-detection" content="telephone=no">
    <title>TUBA FINANCES APP</title>
    <link rel="manifest" href="manifest.json?v=20260105">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        html {
            -webkit-text-size-adjust: 100%;
        }

        #loginForm input,
        #signupForm input {
            font-size: 16px;
        }

        :root {
            padding-bottom: env(safe-area-inset-bottom);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
        }

        /* Mobile-specific enhancements */
        html {
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
            touch-action: manipulation;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #ffffff 0%, #f5f5f5 100%);
            padding-bottom: 70px;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
        }

        .list-scroll-container {
            max-height: 420px;
            width: 100%;
            overflow-y: auto;
            overflow-x: hidden;
            padding-right: 6px;
            padding-bottom: 40px;
            scrollbar-gutter: stable;
            contain: layout paint;
            overscroll-behavior: auto;
        }
        @media (max-height: 700px) {
            .list-scroll-container { max-height: 60vh; }
        }

        /* Removed in-app pull-to-refresh styles */

        /* Enhanced touch interactions */
        button,
        .btn,
        .nav-item,
        .stat-card,
        .item,
        .quick-nav-btn {
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            cursor: pointer;
        }

        /* Improved button feedback for mobile */
        button:active,
        .btn:active,
        .nav-item:active,
        .stat-card:active {
            transform: scale(0.98);
            transition: transform 0.1s ease;
        }

        .pin-gate-wrapper {
            position: relative;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }
        .pin-icon-status {
            position: absolute;
            right: 12px;
            top: 38px;
            width: 16px;
            height: 16px;
            display: none;
            align-items: center;
            justify-content: center;
            box-sizing: border-box;
        }
        .pin-spinner {
            display: block;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            animation: pin-spin 1s linear infinite;
        }
        @keyframes pin-spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .pin-checkmark { display: block; }
        .pin-checkmark::after {
            content: '✔';
            color: #2e7d32;
            font-weight: bold;
            font-size: 16px;
        }
        .pin-cross { display: block; }
        .pin-cross::after {
            content: '✖';
            color: #d32f2f;
            font-weight: bold;
            font-size: 16px;
        }
        .pin-toast-inline {
            font-size: 11px;
            color: #2e7d32;
            margin-top: 4px;
            opacity: 0;
            transition: opacity 0.3s ease-out;
            height: 0;
            overflow: hidden;
        }
        .pin-toast-inline.show {
            opacity: 1;
            height: auto;
        }
        .locked-content {
            opacity: 0.4;
            pointer-events: none;
            filter: grayscale(0.8);
            user-select: none;
            transition: all 0.4s ease;
        }

        /* Safe area support for notched devices */
        .header {
            padding-top: max(16px, env(safe-area-inset-top));
            padding-left: max(16px, env(safe-area-inset-left));
            padding-right: max(16px, env(safe-area-inset-right));
        }

        .bottom-nav {
            /* Extra breathing room to avoid iPhone home indicator overlap */
            padding-top: 8px;
            padding-bottom: calc(max(0px, env(safe-area-inset-bottom)) + 16px);
            padding-left: max(0px, env(safe-area-inset-left));
            padding-right: max(0px, env(safe-area-inset-right));
        }

        /* Offline banner (non-overlay, sits between header and content) */
        .offline-banner {
            display: none;
            width: 100%;
            background: linear-gradient(145deg, #b71c1c, #7f0000);
            color: #ffffff;
            text-align: center;
            font-size: 12px;
            font-weight: 600;
            padding: 6px 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.12);
            position: fixed;
            top: 70px;
            left: 0;
            z-index: 10000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        @supports (top: env(safe-area-inset-top)) {
            @media (display-mode: standalone) {
                .header { top: env(safe-area-inset-top); padding-top: 16px; }
                .content { padding-top: 70px; scroll-padding-top: 70px; }
                .offline-banner { top: calc(env(safe-area-inset-top) + 70px); }
            }
        }
        html.standalone .header { top: env(safe-area-inset-top); padding-top: 16px; }
        html.standalone .content { padding-top: 70px; scroll-padding-top: 70px; }
        html.standalone .offline-banner { top: calc(env(safe-area-inset-top) + 70px); }

        .offline-banner.clickable {
            cursor: pointer;
        }

        /* Auth banner (same style, clickable) */
        .auth-banner {
            background: linear-gradient(145deg, #1976d2, #0d47a1);
            cursor: pointer;
        }

        /* FAB (Floating Action Button) and radial tabs */
        .fab-container {
            position: fixed;
            left: 50%;
            transform: translateX(-50%);
            bottom: 8px;
            /* above bottom nav */
            z-index: 1000;
        }

        .fab {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: 1px solid rgba(184, 134, 11, 0.55);
            color: #B8860B;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 20px rgba(184, 134, 11, 0.25);
            background: rgba(255, 255, 255, 0.98);
        }

        .fab:active {
            transform: scale(0.98);
        }

        /* FAB hint: subtle pulsing ring to indicate tap */
        .fab.hint::after {
            content: '';
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 60px;
            height: 60px;
            border-radius: 50%;
            box-shadow: 0 0 0 0 rgba(184, 134, 11, 0.5);
            animation: fab-pulse 1.8s ease-out infinite;
        }

        @keyframes fab-pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(184, 134, 11, 0.45);
            }

            70% {
                box-shadow: 0 0 0 14px rgba(184, 134, 11, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(184, 134, 11, 0);
            }
        }

        /* Clear button with red hint - matches btn-small btn-secondary */
        .clear-btn {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: linear-gradient(145deg, #757575, #424242);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 6px 10px;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 10;
            box-shadow: 0 5px 16px rgba(0, 0, 0, 0.28), inset 0 -2px 5px rgba(0, 0, 0, 0.2);
            text-transform: uppercase;
            letter-spacing: 0.4px;
            width: auto;
        }

        .clear-btn.visible {
            opacity: 1;
            visibility: visible;
        }

        .clear-btn.hint {
            border: 2px solid rgba(244, 67, 54, 0.8);
            box-shadow: 0 0 0 0 rgba(244, 67, 54, 0.5);
            animation: clear-pulse 1.8s ease-out infinite;
        }
        .clear-btn.hint::after {
            content: '';
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 48px;
            height: 48px;
            border-radius: 50%;
            box-shadow: 0 0 0 0 rgba(184, 134, 11, 0.5);
            animation: fab-pulse 1.8s ease-out infinite;
            pointer-events: none;
        }

        @keyframes clear-pulse {
            0% {
                border-color: rgba(244, 67, 54, 0.8);
                box-shadow: 0 0 0 0 rgba(244, 67, 54, 0.5);
            }

            70% {
                border-color: rgba(244, 67, 54, 1);
                box-shadow: 0 0 0 8px rgba(244, 67, 54, 0);
            }

            100% {
                border-color: rgba(244, 67, 54, 0.8);
                box-shadow: 0 0 0 0 rgba(244, 67, 54, 0);
            }
        }

        .search-box {
            position: relative;
            margin: 8px 0;
        }

        .fab-menu {
            position: absolute;
            left: 50%;
            bottom: 28px;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            pointer-events: none;
            /* enable items only when open */
        }

        .fab-item {
            position: absolute;
            width: 44px;
            height: 44px;
            border-radius: 12px;
            border: none;
            color: #fff;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.25);
            background: linear-gradient(145deg, #1976d2, #0d47a1);
            transform: translate(0, 0) scale(0.6);
            opacity: 0;
            transition: transform 0.35s cubic-bezier(.2, .8, .2, 1), opacity 0.25s ease-out;
            overflow: visible;
        }

        .fab-icon {
            pointer-events: none;
            color: #fff;
        }

        .fab-label {
            position: absolute;
            top: 52px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 9px;
            font-weight: 600;
            color: #222;
            background: rgba(255, 255, 255, 0.95);
            padding: 2px 6px;
            border-radius: 10px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            white-space: nowrap;
            max-width: 96px;
            overflow: hidden;
            text-overflow: ellipsis;
            z-index: 2;
        }

        .fab-item:hover {
            filter: brightness(1.05);
        }

        .fab-container.open .fab-menu {
            pointer-events: auto;
        }

        .fab-container.open .fab-item {
            opacity: 1;
            transform: scale(1);
        }

        @keyframes fab-spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .fab-container.open .fab {
            animation: fab-spin 0.6s ease-out;
        }

        /* Splash screen styles */
        .privacy-blur {
            filter: blur(8px);
            -webkit-filter: blur(8px);
            transition: filter 0.3s ease;
        }

        /* Hide legacy bottom nav in favor of FAB menu */
        .bottom-nav {
            display: none;
        }

        .privacy-toggle-btn {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 30px;
            height: 30px;
            background: linear-gradient(145deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 12px;
            cursor: pointer;
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.4), inset 0 -1px 2px rgba(0, 0, 0, 0.2);
            z-index: 50;
            display: none;
            align-items: center;
            justify-content: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            will-change: transform;
        }

        .privacy-toggle-btn.show {
            display: flex;
        }

        .privacy-toggle-btn:hover {
            transform: translate(-50%, -50%) scale(1.1);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6), inset 0 -1px 2px rgba(0, 0, 0, 0.2);
        }

        .privacy-toggle-btn:active {
            transform: translate(-50%, -50%) scale(0.98);
        }

        .privacy-toggle-btn.bounce {
            animation: bounce 0.6s ease-in-out;
        }

        .privacy-container {
            position: relative;
            margin-bottom: 12px;
        }

        input[readonly] {
            background: rgba(0, 0, 0, 0.05);
            cursor: not-allowed;
            color: #666;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #ffffff 0%, #f5f5f5 100%);
            padding-bottom: 70px;
            overflow-x: hidden;
        }

        body.theme-dark {
            background: linear-gradient(135deg, #0f0f0f 0%, #1a1a1a 100%);
            color: #e0e0e0;
        }

        body.theme-dark .card {
            background: rgba(24, 24, 24, 0.98);
            border: 1px solid rgba(255, 255, 255, 0.08);
            color: #e0e0e0;
        }

        body.theme-dark .bottom-nav {
            background: rgba(24, 24, 24, 0.95);
            border-top: 1px solid rgba(255, 255, 255, 0.08);
        }

        body.theme-dark .nav-item {
            color: #cfcfcf;
        }

        body.theme-dark .nav-item:hover:not(.active) {
            background: rgba(102, 126, 234, 0.14);
        }

        body.theme-dark .item-title {
            color: #e6e6e6;
        }

        body.theme-dark .item-subtitle {
            color: #a8a8a8;
        }

        body.theme-dark .item {
            background: #0f1115;
            border: 1px solid rgba(255, 255, 255, 0.10);
            box-shadow: none;
        }

        body.theme-dark .note-preview {
            background: #0f1115;
            color: #e0e0e0;
            border: 1px solid rgba(255, 255, 255, 0.12);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.18), inset 0 1px 0 rgba(255, 255, 255, 0.06);
        }

        body.theme-dark .note-preview:hover {
            box-shadow: 0 12px 30px rgba(102, 126, 234, 0.18), inset 0 1px 0 rgba(255, 255, 255, 0.06);
            border-color: rgba(102, 126, 234, 0.4);
        }

        body.theme-dark .alert-info,
        body.theme-dark .alert-success,
        body.theme-dark .alert-box,
        body.theme-dark .alert-box-danger {
            background: rgba(26, 28, 32, 0.95);
            color: #e6e6e6;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.35);
        }

        body.theme-dark .modal-content {
            background: rgba(24, 24, 24, 0.98);
            border: 1px solid rgba(255, 255, 255, 0.08);
            color: #e0e0e0;
        }

        body.theme-dark .modal-title {
            color: #ffffff;
            text-shadow: none;
        }

        body.theme-dark .modal-content,
        body.theme-dark .modal-content h1,
        body.theme-dark .modal-content h2,
        body.theme-dark .modal-content h3,
        body.theme-dark .modal-content h4,
        body.theme-dark .modal-content p,
        body.theme-dark .modal-content span,
        body.theme-dark .modal-content div,
        body.theme-dark .modal-content ul,
        body.theme-dark .modal-content li,
        body.theme-dark .modal-content label,
        body.theme-dark .modal-content small,
        body.theme-dark .modal-content a {
            color: #ffffff !important;
        }

        body.theme-dark .modal-content a {
            text-decoration: underline;
        }

        body.theme-dark .modal-content input,
        body.theme-dark .modal-content select,
        body.theme-dark .modal-content textarea {
            color: #ffffff !important;
        }

        body.theme-dark .modal-content input::placeholder,
        body.theme-dark .modal-content textarea::placeholder {
            color: rgba(255, 255, 255, 0.7) !important;
        }

        body.theme-dark input,
        body.theme-dark textarea,
        body.theme-dark select {
            background: #0f1115;
            color: #e0e0e0;
            border: 1px solid rgba(255, 255, 255, 0.12);
        }

        body.theme-dark input::placeholder,
        body.theme-dark textarea::placeholder {
            color: #9aa0a6;
        }

        body.theme-dark input:focus,
        body.theme-dark textarea:focus,
        body.theme-dark select:focus {
            outline: none;
            border-color: rgba(102, 126, 234, 0.6);
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.35);
        }

        body.theme-dark .search-box input {
            background: #0f1115;
            border-color: rgba(255, 255, 255, 0.12);
            color: #e0e0e0;
        }

        body.theme-dark .money-input {
            background: #0f1115;
            color: #e0e0e0;
            border-color: rgba(255, 255, 255, 0.12);
        }

        body.theme-dark .filter-row input,
        body.theme-dark .filter-row select {
            background: #0f1115;
            color: #e0e0e0;
            border-color: rgba(255, 255, 255, 0.12);
        }

        body.theme-dark .float-balance-container {
            background: #121417;
            border: 1px solid rgba(255, 255, 255, 0.12);
            box-shadow: none;
        }

        body.theme-dark .float-balance-row {
            border-bottom: 1px solid rgba(255, 255, 255, 0.12);
        }

        body.theme-dark .float-balance-label {
            color: #ffffff;
        }

        body.theme-dark .float-balance-value {
            color: #e0e0e0;
        }

        body.theme-dark .editable-float {
            background: #0f1115;
            border: 1px solid rgba(255, 255, 255, 0.12);
            color: #e0e0e0;
        }

        body.theme-dark .bulk-actions {
            background: #0f1115;
            border: 1px solid rgba(255, 255, 255, 0.12);
            color: #e0e0e0;
            box-shadow: none;
        }

        body.theme-dark .info-box {
            background: #121417;
            color: #e0e0e0;
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        body.theme-dark .collapse-btn {
            background: #0f1115;
            color: #e0e0e0;
            border: 1px solid rgba(255, 255, 255, 0.12);
        }

        body.theme-dark .badge {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.25), inset 0 1px 0 rgba(255, 255, 255, 0.08);
        }

        body.theme-dark .badge-warning {
            color: #000;
        }

        body.theme-dark .card h1,
        body.theme-dark .card h2,
        body.theme-dark .card h3,
        body.theme-dark .card h4,
        body.theme-dark .card h5,
        body.theme-dark .card h6 {
            color: #ffffff;
        }

        body.theme-dark .form-group label,
        body.theme-dark label,
        body.theme-dark .stat-label,
        body.theme-dark .float-balance-label {
            color: #ffffff;
        }

        .form-group[data-label] { position: relative; }
        .form-group[data-label]::after {
            content: attr(data-label);
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 12px;
            color: #666;
            pointer-events: none;
        }
        .form-group[data-label] input,
        .form-group[data-label] textarea {
            padding-right: 80px;
        }
        .form-group[data-label] select {
            padding-right: 80px;
        }
        body.theme-dark .form-group[data-label]::after { color: #9aa0a6; }

        /* Comprehensive dark mode text fixes */
        body.theme-dark,
        body.theme-dark p,
        body.theme-dark span,
        body.theme-dark div,
        body.theme-dark li,
        body.theme-dark td,
        body.theme-dark th,
        body.theme-dark a,
        body.theme-dark small,
        body.theme-dark strong,
        body.theme-dark b,
        body.theme-dark i,
        body.theme-dark em {
            color: #e0e0e0;
        }

        /* Item elements - receipts, invoices, sales, etc. */
        body.theme-dark .item,
        body.theme-dark .item *,
        body.theme-dark .item-header,
        body.theme-dark .item-header *,
        body.theme-dark .item-title,
        body.theme-dark .item-subtitle,
        body.theme-dark .item-actions,
        body.theme-dark .item-actions *,
        body.theme-dark .item-info,
        body.theme-dark .item-info * {
            color: #ffffff !important;
        }

        /* Receipt specific */
        body.theme-dark .receipt-item,
        body.theme-dark .receipt-item *,
        body.theme-dark .receipt-header,
        body.theme-dark .receipt-header *,
        body.theme-dark .receipt-details,
        body.theme-dark .receipt-details * {
            color: #ffffff !important;
        }

        /* Info rows */
        body.theme-dark .info-row,
        body.theme-dark .info-row *,
        body.theme-dark .info-row span {
            color: #ffffff !important;
        }

        /* Stat cards */
        body.theme-dark .stat-card,
        body.theme-dark .stat-card *,
        body.theme-dark .stat-value,
        body.theme-dark .stat-label {
            color: #ffffff !important;
        }

        /* Tables */
        body.theme-dark table,
        body.theme-dark table *,
        body.theme-dark thead,
        body.theme-dark thead *,
        body.theme-dark tbody,
        body.theme-dark tbody *,
        body.theme-dark tr,
        body.theme-dark tr *,
        body.theme-dark td,
        body.theme-dark th {
            color: #ffffff !important;
        }

        /* Override inline styles - catch all spans, divs with inline color */
        body.theme-dark span[style*="color"],
        body.theme-dark div[style*="color"],
        body.theme-dark p[style*="color"],
        body.theme-dark a[style*="color"],
        body.theme-dark strong[style*="color"],
        body.theme-dark b[style*="color"] {
            color: #ffffff !important;
        }

        /* Specific override for dark colors in dark mode */
        body.theme-dark [style*="color: #000"],
        body.theme-dark [style*="color:#000"],
        body.theme-dark [style*="color: #333"],
        body.theme-dark [style*="color:#333"],
        body.theme-dark [style*="color: #666"],
        body.theme-dark [style*="color:#666"],
        body.theme-dark [style*="color: black"],
        body.theme-dark [style*="color:black"] {
            color: #ffffff !important;
        }

        body.theme-dark .item .badge-warning,
        body.theme-dark .badge-warning,
        .badge-warning {
            color: #000 !important;
        }


        .header {
            background: linear-gradient(145deg, #1a1a1a, #000000);
            color: white;
            padding: 16px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 12000;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            display: flex;
            justify-content: center;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-top: max(16px, env(safe-area-inset-top));
            padding-left: max(16px, env(safe-area-inset-left));
            padding-right: max(16px, env(safe-area-inset-right));
        }

        .header h1 {
            font-size: 15px;
            font-weight: 600;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
        }

        .header-btn {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            width: 40px;
            height: 40px;
            background: linear-gradient(145deg, #2e7d32, #1b5e20);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(46, 125, 50, 0.4), inset 0 -2px 5px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        .header-btn:hover {
            box-shadow: 0 6px 20px rgba(46, 125, 50, 0.6), inset 0 -2px 5px rgba(0, 0, 0, 0.2);
        }

        .header-btn:active {
            transform: translateY(-50%) scale(0.95);
            box-shadow: 0 2px 10px rgba(46, 125, 50, 0.4), inset 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        .header-btn-left {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            width: 32px;
            height: 32px;
            background: rgba(255,255,255,0.08);
            color: #fff;
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: none;
            transition: none;
        }

        .header-btn-left:hover {
            background: rgba(255,255,255,0.14);
        }

        .header-btn-left:active {
            transform: translateY(-50%) scale(0.98);
        }

        .content {
            padding: 16px;
            padding-top: calc(70px + env(safe-area-inset-top));
            padding-bottom: calc(90px + env(safe-area-inset-bottom));
            scroll-padding-top: calc(70px + env(safe-area-inset-top));
            scroll-padding-bottom: calc(90px + env(safe-area-inset-bottom));
        }

        .stat-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }

        .stat-card {
            background: linear-gradient(145deg, #1a1a1a, #000000);
            color: white;
            padding: 16px;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: transform 0.3s ease;
            cursor: pointer;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        .stat-label {
            font-size: 11px;
            opacity: 0.8;
            margin-bottom: 4px;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 22px;
            font-weight: 700;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .stat-subvalue {
            font-size: 12px;
            opacity: 0.7;
            margin-top: 4px;
        }

.card {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 16px;
            padding: 14px;
            margin-bottom: 12px;
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.12);
            border: 1px solid rgba(255, 255, 255, 0.5);
            content-visibility: auto;
            contain-intrinsic-size: 100px 500px;
    position: relative;
}
.card.dropdown-open { z-index: 9000; }

        .card:hover {
            box-shadow: 0 10px 28px rgba(0, 0, 0, 0.16);
        }

        .card h2 {
            font-size: 15px;
            font-weight: 700;
            margin-bottom: 12px;
            color: #1a1a1a;
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.5);
        }

        .card-header-buttons {
            position: absolute;
            right: 14px;
            top: 10px;
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }

        .save-offline-btn {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            gap: 1px;
            padding: 6px 8px;
            border-radius: 8px;
            border: 1px solid rgba(25, 118, 210, 0.35);
            background: linear-gradient(145deg, #1976d2, #0d47a1);
            color: #ffffff;
            font-size: 10px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(13, 71, 161, 0.35);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            width: auto;
            max-width: 160px;
            line-height: 1.2;
        }

        .save-offline-btn>span:first-child {
            font-weight: 700;
        }

        .save-offline-btn .save-offline-sub {
            font-weight: 500;
            font-size: 9px;
            color: #f5f5f5;
        }

        .save-offline-btn:hover {
            box-shadow: 0 10px 28px rgba(102, 126, 234, 0.35);
        }

        @keyframes glowPulse {
            0% {
                box-shadow: 0 6px 18px rgba(102, 126, 234, 0.25);
            }

            50% {
                box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.35), 0 12px 32px rgba(102, 126, 234, 0.35);
            }

            100% {
                box-shadow: 0 6px 18px rgba(102, 126, 234, 0.25);
            }
        }

        @keyframes miniBounce {

            0%,
            100% {
                transform: translateY(0)
            }

            50% {
                transform: translateY(-8px)
            }
        }

        .save-offline-btn.attention {
            animation: miniBounce 0.6s ease-in-out, glowPulse 1.4s ease-in-out 0s 2;
        }

        body.theme-dark .save-offline-btn {
            background: linear-gradient(145deg, #1976d2, #0d47a1);
            color: #ffffff;
            border-color: rgba(25, 118, 210, 0.45);
        }

        body.theme-dark .save-offline-btn .save-offline-sub {
            color: #f5f5f5;
        }

        body.theme-dark .save-offline-btn>span:first-child {
            color: #ffffff;
        }

        body.theme-dark .save-offline-btn:hover {
            box-shadow: 0 10px 28px rgba(102, 126, 234, 0.45);
        }

        @media (max-width: 420px) {
            .save-offline-btn {
                max-width: 140px;
                font-size: 9px;
            }

            .save-offline-btn .save-offline-sub {
                font-size: 8px;
            }
        }

        .quick-nav-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 8px;
            font-size: 10px;
            font-weight: 600;
            color: white;
            cursor: pointer;
            box-shadow: 0 3px 12px rgba(0, 0, 0, 0.18), inset 0 -2px 5px rgba(0, 0, 0, 0.1);
            white-space: nowrap;
        }

        .quick-nav-btn:hover {
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3), inset 0 -2px 5px rgba(0, 0, 0, 0.1);
        }

        .quick-nav-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2), inset 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .quick-nav-btn.products {
            background: linear-gradient(145deg, #2e7d32, #1b5e20);
        }

        .quick-nav-btn.categories {
            background: linear-gradient(145deg, #e65100, #bf360c);
        }

        .quick-nav-btn.back {
            background: linear-gradient(145deg, #1976d2, #0d47a1);
        }

        .form-group {
            margin-bottom: 10px;
        }

        .form-group label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 4px;
            color: #333;
            text-shadow: 0 1px 1px rgba(255, 255, 255, 0.8);
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            font-size: 16px !important;
            background: rgba(255, 255, 255, 0.9);
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1), inset 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        button,
        .btn {
            width: 100%;
            padding: 11px;
            background: linear-gradient(145deg, #1a1a1a, #000000);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.4px;
            box-shadow: 0 5px 16px rgba(0, 0, 0, 0.28), inset 0 -2px 5px rgba(0, 0, 0, 0.2);
        }

        button:hover {
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4), inset 0 -2px 5px rgba(0, 0, 0, 0.2);
        }

        button:active {
            transform: translateY(0);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3), inset 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(145deg, #757575, #424242);
        }

        .btn-success {
            background: linear-gradient(145deg, #2e7d32, #1b5e20);
        }

        .btn-danger {
            background: linear-gradient(145deg, #d32f2f, #b71c1c);
        }

        .btn-small {
            padding: 6px 10px;
            font-size: 12px;
            width: auto;
        }
        .btn-tag {
            background: #e8e8e8;
            color: #333;
            border: 1px solid #999;
        }
        body.theme-dark .btn-tag {
            background: #1f2937;
            color: #e5e7eb;
            border: 1px solid #374151;
        }
        .btn-tag.active {
            opacity: 0.9;
            font-weight: 700;
        }

        .tags-scroll {
            display: flex;
            align-items: center;
            gap: 6px;
            overflow-x: auto;
            overflow-y: hidden;
            padding: 6px 8px;
            border-radius: 14px;
            border: 1px solid rgba(0, 0, 0, 0.10);
            background: rgba(0, 0, 0, 0.03);
            -webkit-overflow-scrolling: touch;
            overscroll-behavior-x: auto;
            touch-action: pan-x;
            scrollbar-gutter: stable;
        }
        .tags-scroll > * { flex: 0 0 auto; }
        body.theme-dark .tags-scroll {
            border-color: rgba(255, 255, 255, 0.12);
            background: rgba(255, 255, 255, 0.06);
        }
        body.theme-blue .tags-scroll {
            border-color: rgba(255, 255, 255, 0.14);
            background: rgba(255, 255, 255, 0.06);
        }
        .tags-scroll::-webkit-scrollbar { height: 6px; }
        .tags-scroll::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.25); border-radius: 999px; }
        body.theme-dark .tags-scroll::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.22); }
        body.theme-blue .tags-scroll::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.22); }

        .tag-badge {
            white-space: nowrap;
        }

        /* Searchable dropdown minimal styles */
        .searchable-dropdown {
            position: relative;
            width: 100%;
        }

        .searchable-dropdown .dropdown-display {
            cursor: pointer;
            width: 100%;
            box-sizing: border-box;
            padding: 10px 34px 10px 10px;
            border: 2px solid rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.9);
            font-size: 16px;
            line-height: 1.2;
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.05);
            position: relative;
        }

        .searchable-dropdown .dropdown-panel {
            position: absolute;
            left: 0;
            right: 0;
            z-index: 9000;
            overflow: visible;
            z-index: 9000;
            background: rgba(255, 255, 255, 0.98);
            border: 1px solid rgba(0, 0, 0, 0.12);
            border-radius: 8px;
            box-shadow: 0 10px 24px rgba(0, 0, 0, 0.18);
            margin-top: 6px;
            padding: 8px;
        }

        .searchable-dropdown .dropdown-panel.hidden {
            display: none;
        }

        .searchable-dropdown .dropdown-search {
            width: 100%;
            padding: 8px;
            border: 1px solid rgba(0, 0, 0, 0.12);
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .searchable-dropdown .dropdown-options {
            max-height: 240px;
            overflow: auto;
            border-radius: 6px;
        }

        .searchable-dropdown .dropdown-option {
            padding: 8px 10px;
            border-radius: 6px;
            cursor: pointer;
        }

        .searchable-dropdown .dropdown-option:hover {
            background: rgba(0, 0, 0, 0.06);
        }

        .searchable-dropdown .dropdown-option.active {
            background: rgba(25, 118, 210, 0.15);
        }

        body.theme-dark .searchable-dropdown .dropdown-display {
            background: rgba(24, 24, 24, 0.96);
            border-color: rgba(255, 255, 255, 0.12);
            color: #fff;
        }

        body.theme-dark .searchable-dropdown .dropdown-panel {
            background: rgba(24, 24, 24, 0.98);
            border-color: rgba(255, 255, 255, 0.08);
            z-index: 10000;
        }

        body.theme-dark .searchable-dropdown .dropdown-search {
            background: rgba(30, 30, 30, 0.96);
            border-color: rgba(255, 255, 255, 0.12);
            color: #fff;
        }

        body.theme-dark .searchable-dropdown .dropdown-option {
            color: #fff;
        }

        body.theme-dark .searchable-dropdown .dropdown-option.active {
            background: rgba(255, 255, 255, 0.12);
        }

        .searchable-dropdown .dropdown-chevron {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
            color: inherit;
        }



        .item {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 0, 0, 0.08);
            border-radius: 12px;
            padding: 10px;
            margin-bottom: 8px;
            box-shadow: 0 3px 12px rgba(0, 0, 0, 0.07), inset 0 1px 0 rgba(255, 255, 255, 0.8);
            content-visibility: auto;
            contain-intrinsic-size: 0 80px;
        }

        .item:hover {
            transform: translateY(-2px);
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .item-title {
            font-weight: 700;
            font-size: 14px;
            color: #1a1a1a;
        }

        .item-subtitle {
            font-size: 13px;
            color: #666;
            margin-top: 4px;
        }

        .badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            display: inline-block;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        .badge-success {
            background: linear-gradient(145deg, #66bb6a, #43a047);
            color: white;
        }

        .badge-warning {
            background: linear-gradient(145deg, #ffeb3b, #fbc02d);
            color: #000;
        }

        .badge-danger {
            background: linear-gradient(145deg, #ef5350, #c62828);
            color: white;
        }

        .badge-paid {
            background: linear-gradient(145deg, #66bb6a, #43a047);
            color: white;
        }

        .badge-unpaid {
            background: linear-gradient(145deg, #ef5350, #c62828);
            color: white;
        }

        .badge-mpesa {
            background: linear-gradient(145deg, #ef5350, #c62828);
            color: white;
        }

        .badge-crdb {
            background: linear-gradient(145deg, #66bb6a, #43a047);
            color: white;
        }

        .badge-nmb {
            background: linear-gradient(145deg, #ff9800, #e65100);
            color: white;
        }

        .badge-yas {
            background: linear-gradient(145deg, #42a5f5, #1976d2);
            color: white;
        }

        .badge-airtel {
            background: linear-gradient(145deg, #d32f2f, #b71c1c);
            color: white;
        }

        .badge-halopesa {
            background: linear-gradient(145deg, #ffeb3b, #fbc02d);
            color: #333;
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #2d2d2d; /* Dark grey background */
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            overflow-x: auto;
            box-shadow: 0 -8px 32px rgba(0, 0, 0, 0.3);
            z-index: 11990;
            padding-bottom: calc(env(safe-area-inset-bottom) + 12px);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
            touch-action: pan-x;
            column-gap: 8px;
            padding-top: 6px;
        }

        .nav-item {
            flex: 1;
            min-width: 70px;
            max-width: 90px;
            padding: 10px 4px;
            text-align: center;
            cursor: pointer;
            border: none;
            background: transparent;
            color: #ffffff; /* White text */
            font-size: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            word-wrap: break-word;
            overflow: hidden;
            position: relative;
            border-radius: 12px;
            transition: background 0.2s ease, color 0.2s ease, transform 0.2s ease;
            border: 2px solid rgba(255, 255, 255, 0.25);
            touch-action: manipulation;
        }

        .nav-item span:last-child {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%;
        }

        .nav-item.active {
            background: linear-gradient(145deg, #667eea, #764ba2);
            color: #fff;
            box-shadow: 0 4px 15px rgba(118, 75, 162, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.5);
        }

        .nav-item.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 60%;
            height: 3px;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.8);
        }

        .nav-item:hover:not(.active) {
            background: rgba(102, 126, 234, 0.10);
            border-color: rgba(102, 126, 234, 0.35);
        }

        .nav-item:active {
            transform: scale(0.98);
        }

        .nav-icon {
            font-size: 20px;
            line-height: 1;
        }

        .info-box {
            background: linear-gradient(145deg, #f5f5f5, #e0e0e0);
            padding: 12px;
            border-radius: 12px;
            margin-top: 12px;
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .tsh-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background-color: #222;
            border: 2px solid #fff;
            outline: 1px solid #222;
            font-family: Arial, sans-serif;
            font-size: 10px;
            font-weight: 700;
            color: #fff;
            letter-spacing: -0.5px;
            margin-right: 6px;
            vertical-align: middle;
        }


        @keyframes autofillDetection {
            from {
                opacity: 1;
            }

            to {
                opacity: 1;
            }
        }

        input:-webkit-autofill {
            animation-name: autofillDetection;
            animation-duration: 0.001s;
            animation-iteration-count: 1;
            animation-timing-function: ease;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            font-size: 14px;
        }

        .flex-gap {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 13000;
            padding: 16px;
            overflow-x: hidden;
        }
        #pinSetModal { z-index: 13002; }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 28px;
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            overflow-x: hidden;
            overscroll-behavior: contain;
            -webkit-overflow-scrolling: touch;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3),
                0 0 0 1px rgba(255, 255, 255, 0.5),
                inset 0 1px 0 rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.5);
            position: relative;
            overflow-wrap: anywhere;
            scrollbar-width: thin;
            scrollbar-color: rgba(102, 126, 234, 0.6) rgba(0, 0, 0, 0.08);
        }

        .stocksheet-source-label {
            padding: 8px 2px;
            font-weight: 700;
        }

        .stocksheet-src-btn {
            padding: 8px 14px;
            font-size: 12px;
            transition: outline 0.2s ease, box-shadow 0.2s ease, background 0.2s ease, transform 0.1s ease;
        }

        .stocksheet-src-btn.selected {
            outline: 2px solid #d32f2f;
            outline-offset: 2px;
            box-shadow: 0 6px 18px rgba(211, 47, 47, 0.25);
        }

        .modal-content::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .modal-content::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.08);
            border-radius: 8px;
        }

        .modal-content::-webkit-scrollbar-thumb {
            background: linear-gradient(145deg, #667eea, #5a67d8);
            border-radius: 8px;
        }

        .modal-content::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(145deg, #5a67d8, #4c51bf);
        }

        #invBulkHeader {
            display: grid;
        }

        .modal-content input[type="text"],
        .modal-content input[type="email"],
        .modal-content input[type="password"],
        .modal-content input[type="tel"],
        .modal-content input[type="date"],
        .modal-content input[type="time"],
        .modal-content input[type="number"],
        .modal-content textarea,
        .modal-content select {
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }

        .modal-content input[type="checkbox"] {
            width: auto;
            height: 16px;
        }

        .checkbox-select {
            width: 16px;
            height: 16px;
            min-width: 16px;
            min-height: 16px;
        }

        .modal-close {
            position: sticky;
            top: 8px;
            float: right;
            z-index: 5;
            width: 28px;
            height: 28px;
            border: none;
            border-radius: 50%;
            background: linear-gradient(145deg, #757575, #424242);
            color: #fff;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }

        #invAddBulkBtn.floating-add {
            position: sticky;
            top: 8px;
            float: right;
            z-index: 4;
            margin-right: 40px;
            transition: all 200ms ease;
        }

        @media (max-width: 480px) {
            .modal-content {
                max-width: 95vw;
                padding: 16px;
                border-radius: 16px;
            }

            #inventoryModal .modal-content {
                max-height: 85vh;
            }

            #invToolbar {
                flex-wrap: nowrap;
            }

            #invBulkHeader {
                grid-template-columns: 1fr 1fr !important;
                row-gap: 6px;
                margin-top: 8px !important;
            }

            .inv-bulk-row {
                grid-template-columns: 1fr 1fr !important;
                row-gap: 8px;
            }

            .inv-bulk-row>div:nth-child(5) button {
                width: 100%;
            }

            .grid-2 {
                grid-template-columns: 1fr !important;
            }

            #invAddBulkBtn.floating-add {
                margin-right: 36px;
            }

            /* Commission modal mobile fixes */
            #commissionHistoryList>div {
                grid-template-columns: 1fr !important;
            }

            #commissionHistoryList>div>div:last-child {
                flex-direction: row !important;
                align-items: center !important;
            }
        }

        .modal-title {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 16px;
            color: #1a1a1a;
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        /* Commission list item styles for proper text rendering */
        #commissionHistoryList>div {
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        #commissionHistoryList>div div {
            white-space: normal;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .bulk-label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: #555;
            margin-bottom: 4px;
        }

        select option.opt-new {
            font-weight: 600;
        }

        body.theme-dark select option.opt-new {
            color: #ffd54f;
        }

        .bulk-row {
            display: flex;
            gap: 8px;
            align-items: flex-end;
            flex-wrap: wrap;
        }

        .bulk-row .form-group {
            flex: 1 1 140px;
            min-width: 140px;
        }

        .bulk-row .form-group input,
        .bulk-row .form-group select {
            width: 100%;
            box-sizing: border-box;
        }

        .bulk-row button {
            flex: 0 0 auto;
        }

        @media (max-width: 640px) {
            .bulk-row {
                flex-wrap: wrap;
            }

            .bulk-row .form-group {
                flex: 1 1 160px;
                min-width: 140px;
            }
        }

        .period-items {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }

        .period-item {
            flex: 0 1 280px;
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 10px;
            box-sizing: border-box;
        }

        .period-item .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .period-item .item-title {
            font-weight: 600;
            font-size: 14px;
        }

        .period-item .item-subtitle {
            font-size: 12px;
            color: #555;
            line-height: 1.4;
        }

        .period-item .period-actions {
            display: flex;
            gap: 6px;
            margin-top: 8px;
        }

        .queued-card .item-subtitle {
            overflow-wrap: anywhere;
            word-break: break-word;
            font-size: 12px;
        }

        .queued-grid {
            display: grid;
            gap: 12px;
            grid-template-columns: 1fr 1fr;
        }

        @media (max-width: 640px) {
            .queued-grid {
                grid-template-columns: 1fr;
            }
        }

        body.theme-dark .period-item {
            background: #1e1e1e;
            border-color: #333;
        }

        body.theme-dark .period-item .item-subtitle {
            color: #aaa;
        }

        .period-card-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }

        @media (max-width: 640px) {
            .period-item {
                flex: 0 1 calc(50% - 8px);
                padding: 8px;
            }

            .period-item .item-title {
                font-size: 12px;
            }

            .period-item .item-subtitle {
                font-size: 10px;
            }

            .period-item .badge {
                font-size: 10px;
                padding: 2px 6px;
            }

            .period-item .period-actions {
                gap: 4px;
            }

            .period-item .period-actions .btn-small {
                font-size: 11px;
                padding: 4px 6px;
                min-width: auto;
            }
        }

        .toast-bar {
            position: fixed;
            bottom: calc(env(safe-area-inset-bottom) + 80px);
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: center;
            z-index: 10050;
            pointer-events: none;
            touch-action: pan-x;
        }

        .toast {
            background: rgba(0, 0, 0, 0.94);
            color: #fff;
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 11px;
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.2s, transform 0.2s;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.2);
            text-align: center;
            pointer-events: auto;
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }


        .toast-success {
            background: linear-gradient(145deg, #2e7d32, #1b5e20);
        }

        .toast-error {
            background: linear-gradient(145deg, #d32f2f, #b71c1c);
        }

        .toast-info {
            background: linear-gradient(145deg, #1976d2, #0d47a1);
        }

        .transaction-tabs {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }

        .transaction-tab {
            padding: 14px 16px;
            border-radius: 16px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            text-align: center;
            color: white;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2), inset 0 -2px 5px rgba(0, 0, 0, 0.1);
        }

        .transaction-tab:hover {
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3), inset 0 -2px 5px rgba(0, 0, 0, 0.1);
        }

        .transaction-tab:active {
            transform: translateY(0);
        }

        .transaction-tab.mpesa {
            background: linear-gradient(145deg, #d32f2f, #b71c1c);
            opacity: 0.6;
        }

        .transaction-tab.mpesa.active {
            opacity: 1;
            box-shadow: 0 8px 25px rgba(211, 47, 47, 0.4), inset 0 -2px 5px rgba(0, 0, 0, 0.1);
        }

        .transaction-tab.crdb {
            background: linear-gradient(145deg, #2e7d32, #1b5e20);
            opacity: 0.6;
        }

        .transaction-tab.crdb.active {
            opacity: 1;
            box-shadow: 0 8px 25px rgba(46, 125, 50, 0.4), inset 0 -2px 5px rgba(0, 0, 0, 0.1);
        }

        .transaction-tab.nmb {
            background: linear-gradient(145deg, #e65100, #bf360c);
            opacity: 0.6;
        }

        .transaction-tab.nmb.active {
            opacity: 1;
            box-shadow: 0 8px 25px rgba(230, 81, 0, 0.4), inset 0 -2px 5px rgba(0, 0, 0, 0.1);
        }

        .transaction-tab.yas {
            background: linear-gradient(145deg, #0d47a1, #01579b);
            opacity: 0.6;
        }

        .transaction-tab.yas.active {
            opacity: 1;
            box-shadow: 0 8px 25px rgba(13, 71, 161, 0.4), inset 0 -2px 5px rgba(0, 0, 0, 0.1);
        }

        .transaction-tab.halopesa {
            background: linear-gradient(145deg, #fdd835, #f9a825);
            color: #000;
            opacity: 0.6;
        }

        .transaction-tab.halopesa.active {
            opacity: 1;
            box-shadow: 0 8px 25px rgba(253, 216, 53, 0.4), inset 0 -2px 5px rgba(0, 0, 0, 0.1);
        }

        .transaction-tab.airtel {
            background: linear-gradient(145deg, #b71c1c, #7f0000);
            opacity: 0.6;
        }

        .transaction-tab.airtel.active {
            opacity: 1;
            box-shadow: 0 8px 25px rgba(183, 28, 28, 0.4), inset 0 -2px 5px rgba(0, 0, 0, 0.1);
        }

        .note-preview {
            cursor: pointer;
            max-height: 80px;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 4;
            line-clamp: 4;
            -webkit-box-orient: vertical;
            line-height: 1.5;
            background: linear-gradient(145deg, #ffffff, #f5f5f5);
            border: 2px solid rgba(102, 126, 234, 0.2);
            padding: 16px;
            border-radius: 16px;
            margin-bottom: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08),
                inset 0 1px 0 rgba(255, 255, 255, 0.9);
        }

        .note-preview:hover {
            box-shadow: 0 12px 30px rgba(102, 126, 234, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.9);
            border-color: rgba(102, 126, 234, 0.4);
        }

        .note-preview:active {
            transform: translateY(-2px) scale(1.01);
        }

        .collapse-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(145deg, #f8f8f8, #e8e8e8);
            border: 2px solid rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            color: #555;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            margin: 12px 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .collapse-btn:hover {
            background: linear-gradient(145deg, #ffffff, #f0f0f0);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.8);
        }

        .collapse-btn:active {
            transform: translateY(0);
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .collapse-icon {
            font-size: 12px;
            transition: transform 0.3s;
        }

        .collapse-icon.expanded {
            transform: rotate(180deg);
        }

        .highlight-pulse {
            animation: highlightFade 1s ease-out;
        }

        .highlight-hint {
            animation: highlightFade 2s ease-out;
        }

        @keyframes highlightFade {
            0% {
                background: rgba(102, 126, 234, 0.3);
                box-shadow: 0 0 20px rgba(102, 126, 234, 0.6);
            }

            100% {
                background: transparent;
                box-shadow: none;
            }
        }

        .search-box {
            margin-bottom: 16px;
        }

        .search-box input {
            background: white;
            border: 2px solid rgba(0, 0, 0, 0.1);
        }

        .filter-row {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .filter-row input,
        .filter-row select {
            flex: 1;
            min-width: 120px;
        }

        .filter-row input[type="date"] {
            position: relative;
        }

        .filter-row input[type="date"]::-webkit-datetime-edit {
            display: block;
            padding: 0;
        }

        .filter-row input[type="date"]::-webkit-datetime-edit-fields-wrapper {
            display: block;
        }

        .filter-row input[type="date"]::-webkit-calendar-picker-indicator {
            position: absolute;
            right: 8px;
            cursor: pointer;
        }

        /* Date input sizing: prevent overflow outside cards */
        input[type="date"] {
            width: 100%;
            max-width: 220px;
            /* keep compact across devices */
            box-sizing: border-box;
            -webkit-appearance: none;
            /* normalize iOS Safari */
            appearance: none;
            height: 36px;
            line-height: 1.2;
            padding: 6px 28px 6px 10px;
            /* space for picker icon */
            border: 2px solid rgba(0, 0, 0, 0.1);
            border-radius: 8px;
        }

        .form-group input[type="date"],
        .filter-row input[type="date"] {
            flex: 0 1 220px;
            /* allow shrink/grow but cap width */
            min-width: 0;
            /* avoid flex min-content overflow */
        }

        /* Ensure date inputs can shrink within filter groups on iOS */
        .filter-row .form-group {
            min-width: 0;
            flex: 0 1 auto;
        }

        /* iOS-specific tuning */
        @supports (-webkit-touch-callout: none) {
            input[type="date"] {
                max-width: clamp(140px, 42vw, 220px);
                /* flex-basis mirrors max-width to prevent overflow */
                /* Use both to handle different flex contexts */
            }

            .form-group input[type="date"],
            .filter-row input[type="date"] {
                flex-basis: clamp(140px, 42vw, 220px);
                font-size: 16px;
            }

            .filter-row input[type="date"]::-webkit-calendar-picker-indicator {
                right: 6px;
            }
        }

        /* Inventory page date inputs: uniform and spaced */
        #invFilterFrom,
        #invFilterTo,
        #invDate,
        #invTime {
            width: 100%;
            max-width: 220px;
            margin-top: 4px;
        }

        .alert-box {
            background: linear-gradient(145deg, #fff3e0, #ffe0b2);
            border-left: 4px solid #e65100;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            box-shadow: 0 4px 15px rgba(230, 81, 0, 0.2);
            position: sticky;
            top: calc(70px + env(safe-area-inset-top));
            z-index: 9998;
        }

        .alert-box-danger {
            background: linear-gradient(145deg, #ffebee, #ffcdd2);
            border-left: 4px solid #d32f2f;
            box-shadow: 0 4px 15px rgba(211, 47, 47, 0.2);
            position: sticky;
            top: calc(70px + env(safe-area-inset-top));
            z-index: 9998;
        }

        .alert-success {
            background: linear-gradient(145deg, #e8f5e9, #c8e6c9);
            border-left: 4px solid #2e7d32;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            box-shadow: 0 4px 15px rgba(46, 125, 50, 0.2);
            position: sticky;
            top: calc(70px + env(safe-area-inset-top));
            z-index: 9998;
        }

        .alert-info {
            background: linear-gradient(145deg, #e3f2fd, #bbdefb);
            border-left: 4px solid #1976d2;
            padding: 12px 16px;
            border-radius: 8px;
            margin-top: 16px;
            box-shadow: 0 4px 15px rgba(25, 118, 210, 0.2);
            position: sticky;
            top: calc(70px + env(safe-area-inset-top));
            z-index: 9998;
        }

        .alert-info {
            background: linear-gradient(145deg, #e3f2fd, #bbdefb);
            border-left: 4px solid #1976d2;
            padding: 12px 16px;
            border-radius: 8px;
            margin-top: 16px;
            box-shadow: 0 4px 15px rgba(25, 118, 210, 0.2);
            position: sticky;
            top: calc(70px + env(safe-area-inset-top));
            z-index: 9998;
        }

        .float-balance-container {
            background: linear-gradient(145deg, #e3f2fd, #bbdefb);
            padding: 16px;
            border-radius: 16px;
            margin-bottom: 16px;
            box-shadow: 0 4px 15px rgba(25, 118, 210, 0.2);
            border: 2px solid rgba(25, 118, 210, 0.3);
        }

        .float-balance-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(25, 118, 210, 0.2);
        }

        .float-balance-row:last-child {
            border-bottom: none;
        }

        .float-balance-label {
            font-weight: 600;
            color: #0d47a1;
            font-size: 14px;
        }

        .float-balance-value {
            font-weight: 700;
            color: #1a1a1a;
            font-size: 16px;
        }

        .float-balance-value.positive {
            color: #2e7d32;
        }

        .float-balance-value.negative {
            color: #d32f2f;
        }

        .editable-float {
            padding: 8px 12px;
            border: 2px solid rgba(25, 118, 210, 0.3);
            border-radius: 8px;
            background: white;
            font-weight: 700;
            color: #1976d2;
            cursor: pointer;
            display: inline-block;
            min-width: 100px;
            text-align: right;
        }

        .editable-float:hover {
            border-color: #1976d2;
            box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.1);
        }

        .progress-bar {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            height: 8px;
            margin-top: 8px;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(90deg, #2e7d32, #66bb6a);
            height: 100%;
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        .welcome-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeOut 0.3s ease-in-out 0.5s forwards;
        }

        @keyframes fadeOut {
            to {
                opacity: 0;
                visibility: hidden;
            }
        }

        .welcome-logo {
            font-size: 80px;
            margin-bottom: 20px;
            animation: bounce 1s ease-in-out;
        }

        @keyframes bounce {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-20px);
            }
        }

        .welcome-title {
            color: white;
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
            animation: slideUp 0.8s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .welcome-subtitle {
            color: #aaa;
            font-size: 14px;
            animation: slideUp 0.8s ease-out 0.2s both;
        }

        .app-container {
            opacity: 0;
            animation: fadeIn 0.3s ease-in-out 0.8s forwards;
        }

        @keyframes fadeIn {
            to {
                opacity: 1;
            }
        }

        .quick-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            font-size: 12px;
        }

        .quick-stat-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 8px;
            border-radius: 8px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        @media (max-width: 640px) {
            .stat-grid {
                grid-template-columns: 1fr;
            }

            .transaction-tabs {
                grid-template-columns: repeat(2, 1fr);
            }

            .filter-row {
                flex-direction: column;
            }

            .filter-row input,
            .filter-row select {
                width: 100%;
            }

            .form-group input[type="date"],
            .filter-row input[type="date"] {
                max-width: 100%;
                flex: 1 1 auto;
            }
        }

        .sync-indicator {
            position: absolute;
            left: 62px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 10px;
            padding: 4px 8px;
            border-radius: 13px;
            background: linear-gradient(145deg, #2e7d32, #1b5e20);
            color: white;
            display: none;
            white-space: normal;
            /* allow two-line label */
        }

        .sync-indicator.show {
            display: block;
        }

        .sync-indicator.syncing {
            background: linear-gradient(145deg, #1976d2, #0d47a1);
            animation: pulse 1s infinite;
        }

        .sync-indicator.clickable {
            cursor: pointer;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.6;
            }

        }

        .checkbox-select {
            width: 18px;
            height: 18px;
            cursor: pointer;
            margin-right: 8px;
            accent-color: #1976d2;
        }

        .bulk-actions {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            padding: 12px;
            background: linear-gradient(145deg, #f5f5f5, #e8e8e8);
            border-radius: 12px;
            flex-wrap: wrap;
            align-items: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .bulk-actions label {
            font-size: 13px;
            font-weight: 600;
            color: #333;
            cursor: pointer;
            margin: 0;
        }

        button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .side-nav {
            position: fixed;
            top: 0;
            left: -220px;
            width: 220px;
            height: 100vh;
            background: linear-gradient(180deg, #1a1a1a 0%, #000000 100%);
            box-shadow: 4px 0 20px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            transition: left 0.3s ease;
            display: flex;
            flex-direction: column;
            overscroll-behavior: contain;
        }

        .side-nav.open {
            left: 0;
        }

        .side-nav-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(3px);
            z-index: 999;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .side-nav-overlay.show {
            display: block;
            opacity: 1;
        }

        .side-nav-header {
            padding: 16px;
            background: linear-gradient(145deg, #667eea, #764ba2);
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            flex-shrink: 0;
        }

        .side-nav-header h2 {
            font-size: 16px;
            font-weight: 700;
            margin: 0;
        }

        .side-nav-title {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .side-nav-sound {
            background: transparent;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.2s;
        }

        .side-nav-sound:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .side-nav-close {
            background: transparent;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.2s;
        }

        .side-nav-close:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .side-nav-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            color: white;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 1px solid transparent;
            font-size: 13px;
            flex-shrink: 0;
        }

        .side-nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
            border-left-color: #667eea;
        }

        .side-nav-item.active {
            background: rgba(102, 126, 234, 0.2);
            border-left-color: #667eea;
            font-weight: 600;
        }

        .side-nav-icon {
            font-size: 14px;
            width: 16px;
            text-align: center;
            flex-shrink: 0;
        }

        .side-nav-divider {
            height: 1px;
            background: rgba(255, 255, 255, 0.1);
            margin: 4px 0;
        }

        .side-nav-section-title {
            padding: 4px 16px 2px 16px;
            font-size: 10px;
            font-weight: 700;
            color: rgba(255, 255, 255, 0.5);
            text-transform: uppercase;
            letter-spacing: 1px;
            flex-shrink: 0;
        }
        

        .side-nav-content {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding-bottom: calc(env(safe-area-inset-bottom) + 240px);
            overscroll-behavior: contain;
            -webkit-overflow-scrolling: touch;
        }

        .side-nav-footer {
            padding: 40px 16px;
            text-align: center;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(0, 0, 0, 0.3);
            flex-shrink: 0;
            padding-bottom: calc(env(safe-area-inset-bottom) + 48px);
        }

        .side-nav-footer-text {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.6);
            line-height: 1.4;
        }

        .side-nav-footer-brand {
            font-size: 13px;
            font-weight: 700;
            color: white;
            margin-top: 4px;
        }
        .quick-row {
            display: flex;
            gap: 6px;
            padding: 8px 12px;
            align-items: center;
            justify-content: space-between;
        }
        .ios-download-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 6px 8px;
            border-radius: 10px;
            border: 2px solid rgba(255, 255, 255, 0.9);
            text-decoration: none;
            font-weight: 700;
            font-size: 10px;
            color: #ffffff;
            background: linear-gradient(145deg, rgba(0, 0, 0, 0.95), rgba(32, 32, 32, 0.95));
            box-shadow: 0 8px 18px rgba(0, 0, 0, 0.3);
            transition: transform 0.1s ease, box-shadow 0.2s ease;
            white-space: nowrap;
        }
        .ios-download-btn:active {
            transform: translateY(1px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.35);
        }
        .ios-download-icon {
            width: 14px;
            height: 14px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .quick-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }
        .quick-btn, .toolbar-btn {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: #fff;
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 10px;
            cursor: pointer;
            transition: background 0.2s, transform 0.06s;
        }
        .quick-btn:hover, .toolbar-btn:hover { background: rgba(255,255,255,0.14); }
        .quick-btn:active, .toolbar-btn:active { transform: scale(0.98); }
        .quick-btn.on, .toolbar-btn.on { border-color: #2e7d32; border-width: 2px; }
        .quick-btn.off, .toolbar-btn.off { border-color: #b71c1c; border-width: 2px; }
        .toolbar-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }
        .toolbar-label {
            font-size: 10px;
            line-height: 1;
            color: rgba(255,255,255,0.85);
        }
        .quick-label {
            font-size: 10px;
            line-height: 1;
            color: rgba(255,255,255,0.85);
        }

        body.theme-dark .btn-receipt {
            color: #000 !important;
        }

        .scroll-hint-btn {
            position: fixed;
            left: 16px;
            bottom: 80px;
            transform: none;
            z-index: 9999;
            display: none;
            width: 44px;
            height: 44px;
            min-width: 44px;
            min-height: 44px;
            padding: 0;
            border-radius: 50%;
            border: 1px solid rgba(0, 0, 0, 0.15);
            background: rgba(255, 255, 255, 0.98);
            color: #333;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.20);
            cursor: pointer;
            box-sizing: border-box;
            text-align: center;
            line-height: 44px;
            font-size: 18px;
        }

        .scroll-hint-btn.show {
            display: inline-block;
        }

        body.theme-dark .scroll-hint-btn {
            background: rgba(18, 18, 18, 0.98);
            color: #fff;
            border-color: rgba(255, 255, 255, 0.22);
        }

        :root { --bg:#ffffff; --text:#111111; --card:#ffffff; --accent:#5a67d8; --side-nav-bg: linear-gradient(180deg, #1a1a1a 0%, #000000 100%); }
        body { background: var(--bg); color: var(--text); }
        body.theme-blue {
            --bg:#0b1020;
            --text:#e6eaf3;
            --card:#0e1428;
            --accent:#5a67d8;
            --side-nav-bg: linear-gradient(180deg, #0e1428 0%, #0b1020 100%);
            background: linear-gradient(135deg, #0b1020 0%, #111b3a 100%);
            color: var(--text);
        }

        body.theme-blue .card {
            background: var(--card);
            border: 1px solid rgba(255, 255, 255, 0.12);
            color: #ffffff;
            box-shadow: 0 10px 28px rgba(0, 0, 0, 0.30);
        }

        body.theme-blue .bottom-nav {
            background: rgba(11, 16, 32, 0.92);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        body.theme-blue .modal-content {
            background: rgba(11, 16, 32, 0.96);
            border: 1px solid rgba(255, 255, 255, 0.10);
            color: #e6eaf3;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.35), 0 0 0 1px rgba(255, 255, 255, 0.08), inset 0 1px 0 rgba(255, 255, 255, 0.06);
        }

        body.theme-blue .modal-content,
        body.theme-blue .modal-content h1,
        body.theme-blue .modal-content h2,
        body.theme-blue .modal-content h3,
        body.theme-blue .modal-content h4,
        body.theme-blue .modal-content p,
        body.theme-blue .modal-content span,
        body.theme-blue .modal-content div,
        body.theme-blue .modal-content ul,
        body.theme-blue .modal-content li,
        body.theme-blue .modal-content label,
        body.theme-blue .modal-content small,
        body.theme-blue .modal-content a {
            color: #ffffff !important;
        }

        body.theme-blue .modal-content a { text-decoration: underline; }

        body.theme-blue input,
        body.theme-blue textarea,
        body.theme-blue select {
            background: #0e1428;
            color: #e6eaf3;
            border: 1px solid rgba(255, 255, 255, 0.16);
        }

        body.theme-blue input::placeholder,
        body.theme-blue textarea::placeholder {
            color: #9aa7c7;
        }

        body.theme-blue input:focus,
        body.theme-blue textarea:focus,
        body.theme-blue select:focus {
            outline: none;
            border-color: rgba(102, 126, 234, 0.8);
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.35);
        }

        body.theme-blue .searchable-dropdown .dropdown-display {
            background: rgba(14, 20, 40, 0.96);
            border-color: rgba(255, 255, 255, 0.16);
            color: #e6eaf3;
        }

        body.theme-blue .searchable-dropdown .dropdown-panel {
            background: rgba(11, 16, 32, 0.98);
            border-color: rgba(255, 255, 255, 0.10);
            z-index: 10000;
        }

        body.theme-blue .searchable-dropdown .dropdown-search {
            background: rgba(14, 20, 40, 0.96);
            border-color: rgba(255, 255, 255, 0.16);
            color: #e6eaf3;
        }

        body.theme-blue .searchable-dropdown .dropdown-option { color: #fff; }
        body.theme-blue .searchable-dropdown .dropdown-option.active { background: rgba(102, 126, 234, 0.22); }

        body.theme-blue button,
        body.theme-blue .btn {
            background: linear-gradient(145deg, var(--accent), #4c51bf) !important;
            color: #ffffff !important;
            border: none !important;
            box-shadow: 0 5px 16px rgba(0, 0, 0, 0.28), inset 0 -2px 5px rgba(0, 0, 0, 0.2) !important;
        }

        body.theme-blue .btn-secondary { background: linear-gradient(145deg, #334155, #1f2937) !important; }
        body.theme-blue .btn-success { background: linear-gradient(145deg, #22c55e, #16a34a) !important; }
        body.theme-blue .btn-danger { background: linear-gradient(145deg, #ef4444, #dc2626) !important; }
        body.theme-blue .collapse-btn { background: linear-gradient(145deg, #0f1730, #0b1020) !important; color: #9aa7c7 !important; }
        body.theme-blue .note-preview { background: linear-gradient(145deg, #0f1730, #0b1020); border: 2px solid rgba(102,126,234,0.25); }
        body.theme-blue .alert-box { background: linear-gradient(145deg, #1f2d5e, #16224a); border-left: 4px solid #5a67d8; color: #ffffff; box-shadow: 0 4px 15px rgba(25, 118, 210, 0.25); }
        body.theme-blue .alert-box-danger { background: linear-gradient(145deg, #3a1f1f, #2a1515); border-left: 4px solid #d32f2f; color: #ffffff; box-shadow: 0 4px 15px rgba(211, 47, 47, 0.25); }
        body.theme-blue .alert-success { background: linear-gradient(145deg, #1f3a2a, #15281e); border-left: 4px solid #22c55e; color: #ffffff; box-shadow: 0 4px 15px rgba(34, 197, 94, 0.25); }
        body.theme-blue .alert-info { background: linear-gradient(145deg, #162b52, #0f1f3a); border-left: 4px solid #1976d2; color: #ffffff; box-shadow: 0 4px 15px rgba(25, 118, 210, 0.25); }
        body.theme-blue .money-text { color: #ffffff !important; }
        body.theme-blue [style*="color"] { color: #ffffff !important; }
        body.theme-blue .item { background: #0e1428; border: 1px solid rgba(255, 255, 255, 0.12); box-shadow: none; }
        body.theme-blue .item-subtitle { color: #e6eaf3 !important; }
        body.theme-blue .period-item { background: #0e1428; border: 1px solid rgba(255, 255, 255, 0.12); }
        body.theme-blue .info-box { background: linear-gradient(145deg, #162b52, #0f1f3a); color: #ffffff; box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.3); }
        body.theme-blue .bulk-actions { background: linear-gradient(145deg, #162b52, #0f1f3a); color: #ffffff; }
        body.theme-blue h3 { color: #ffffff !important; }
        body.theme-blue .float-balance-label { color: #ffffff !important; }
        body.theme-blue .float-balance-value { color: #ffffff !important; }
        body.theme-blue .float-balance-container { background: linear-gradient(145deg, #162b52, #0f1f3a); border: 1px solid rgba(255, 255, 255, 0.12); box-shadow: 0 4px 15px rgba(0, 0, 0, 0.35); }
        body.theme-blue .float-balance-row { border-bottom: 1px solid rgba(255, 255, 255, 0.12); }
        body.theme-blue .float-balance-value.positive,
        body.theme-blue .float-balance-value.negative { color: #ffffff !important; }
        body.theme-blue .editable-float { background: #0e1428; border: 1px solid rgba(255, 255, 255, 0.16); color: #ffffff; }
        body.theme-blue .nav-item { color: #cfd6e6; }
        body.theme-blue .nav-item:hover:not(.active) { background: rgba(102, 126, 234, 0.14); }
        body.theme-blue .card h1,
        body.theme-blue .card h2,
        body.theme-blue .card h3,
        body.theme-blue .card h4,
        body.theme-blue .card h5,
        body.theme-blue .card h6 { color: #ffffff; }
        body.theme-blue .form-group label,
        body.theme-blue label,
        body.theme-blue .stat-label { color: #ffffff; }
        body.theme-blue,
        body.theme-blue p,
        body.theme-blue span,
        body.theme-blue div,
        body.theme-blue li,
        body.theme-blue td,
        body.theme-blue th,
        body.theme-blue a,
        body.theme-blue small,
        body.theme-blue strong,
        body.theme-blue b,
        body.theme-blue i,
        body.theme-blue em { color: #e6eaf3; }
        body.theme-blue .item,
        body.theme-blue .item *,
        body.theme-blue .item-header,
        body.theme-blue .item-header *,
        body.theme-blue .item-title,
        body.theme-blue .item-subtitle,
        body.theme-blue .item-actions,
        body.theme-blue .item-actions *,
        body.theme-blue .item-info,
        body.theme-blue .item-info * { color: #ffffff !important; }
        body.theme-blue .receipt-item,
        body.theme-blue .receipt-item *,
        body.theme-blue .receipt-header,
        body.theme-blue .receipt-header *,
        body.theme-blue .receipt-details,
        body.theme-blue .receipt-details * { color: #ffffff !important; }
        body.theme-blue .info-row,
        body.theme-blue .info-row *,
        body.theme-blue .info-row span { color: #ffffff !important; }
        body.theme-blue .stat-card,
        body.theme-blue .stat-card *,
        body.theme-blue .stat-value,
        body.theme-blue .stat-label { color: #ffffff !important; }
        body.theme-blue table,
        body.theme-blue table *,
        body.theme-blue thead,
        body.theme-blue thead *,
        body.theme-blue tbody,
        body.theme-blue tbody *,
        body.theme-blue tr,
        body.theme-blue tr *,
        body.theme-blue td,
        body.theme-blue th { color: #ffffff !important; }
        body.theme-blue span[style*="color"],
        body.theme-blue div[style*="color"],
        body.theme-blue p[style*="color"],
        body.theme-blue a[style*="color"],
        body.theme-blue strong[style*="color"],
        body.theme-blue b[style*="color"] { color: #ffffff !important; }
        body.theme-blue [style*="color: #000"],
        body.theme-blue [style*="color:#000"],
        body.theme-blue [style*="color: #333"],
        body.theme-blue [style*="color:#333"],
        body.theme-blue [style*="color: #666"],
        body.theme-blue [style*="color:#666"],
        body.theme-blue [style*="color: black"],
        body.theme-blue [style*="color:black"] { color: #ffffff !important; }
        body.theme-blue .item .badge-warning,
        body.theme-blue .badge-warning,
        .badge-warning { color: #000 !important; }
        body.theme-blue .btn-tag { background: #0e1428; color: #e6eaf3; border: 1px solid rgba(255, 255, 255, 0.16); }
        body.theme-blue .btn-tag.active { outline: 2px solid #f6e05e; outline-offset: 2px; border-color: #f6e05e; }
        @supports (-webkit-touch-callout: none) {
            .fab {
                background: rgba(255, 255, 255, 0.35);
                -webkit-backdrop-filter: blur(6px);
                backdrop-filter: blur(6px);
            }
            .toast {
                -webkit-backdrop-filter: blur(10px);
                backdrop-filter: blur(10px);
            }
            .scroll-hint-btn {
                background: rgba(255, 255, 255, 0.35);
                -webkit-backdrop-filter: blur(6px);
                backdrop-filter: blur(6px);
            }
            body.theme-dark .scroll-hint-btn {
                background: rgba(18, 18, 18, 0.35);
                -webkit-backdrop-filter: blur(6px);
                backdrop-filter: blur(6px);
            }
            .card {
                background: rgba(255, 255, 255, 0.90);
                -webkit-backdrop-filter: blur(10px);
                backdrop-filter: blur(10px);
            }
            body.theme-dark .card {
                background: rgba(24, 24, 24, 0.90);
                -webkit-backdrop-filter: blur(10px);
                backdrop-filter: blur(10px);
            }
            body.theme-blue .card {
                background: rgba(14, 20, 40, 0.88);
                -webkit-backdrop-filter: blur(10px);
                backdrop-filter: blur(10px);
            }
        }
    </style>
    <style>
        .tithe-card {
            position: relative;
            padding: 12px;
            cursor: pointer;
            border-radius: 12px;
            background: linear-gradient(145deg, #f5f5f5, #eaeaea);
            box-shadow: 0 6px 18px rgba(255, 215, 0, 0.2);
        }

        .dark .tithe-card {
            background: #000;
            box-shadow: 0 6px 18px rgba(255, 215, 0, 0.12);
        }

        .tithe-icon {
            font-size: 18px;
            margin-right: 6px;
        }

        .tithe-progress {
            width: 100%;
            height: 8px;
            background: rgba(0, 0, 0, 0.08);
            border-radius: 8px;
            overflow: hidden;
            margin-top: 8px;
        }

        .dark .tithe-progress {
            background: rgba(255, 255, 255, 0.08);
        }

        .tithe-bar {
            height: 100%;
            background: linear-gradient(90deg, #ffd54f, #ffc107);
            transition: width 300ms ease;
        }

        .tithe-status {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 11px;
            margin-left: 6px;
        }

        .tithe-status.paid {
            background: #2e7d32;
            color: #fff;
        }

        .tithe-status.partial {
            background: #fbc02d;
            color: #333;
        }

        .tithe-status.unpaid {
            background: #d32f2f;
            color: #fff;
        }

        .dark .tithe-card .stat-label,
        .dark .tithe-card .stat-subvalue,
        .dark .tithe-card .stat-value {
            color: #fff !important;
        }

        @keyframes softPulse {
            0% {
                box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.4);
            }

            70% {
                box-shadow: 0 0 0 12px rgba(255, 215, 0, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(255, 215, 0, 0);
            }
        }

        .tithe-pulse {
            animation: softPulse 2s infinite;
        }
    </style>
    <style>
        @media print {
            body * {
                visibility: hidden;
            }

            #printArea,
            #printArea * {
                visibility: visible;
            }

            #printArea {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                padding: 20px;
            }

            .print-header {
                text-align: center;
                margin-bottom: 12px;
            }

            .print-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 8px;
            }

            .print-section {
                margin-top: 10px;
            }

            .print-table {
                width: 100%;
                border-collapse: collapse;
            }

            .print-table th,
            .print-table td {
                border: 1px solid #ccc;
                padding: 6px;
                font-size: 12px;
            }

            .print-right {
                text-align: right;
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" defer></script>
    <script src="db.js?v=1" defer></script>
    <script src="storageManager.js?v=1" defer></script>

    <script>window.APP_VERSION = '4';</script>
    <script>
      window.DEV_CONTACT = {
        phone: '+255746838031',
        whatsapp: '+255746838031',
        email: 'tubafinancing@gmail.com'
      };
    </script>
    <script>window.__deferAuthUntilUiReady = true;</script>
    <script src="app.js?v=4" defer></script>
    <script type="module" src="main.js?v=1"></script>
</head>

<body>
    <script>
        (function () {
            try {
                var raw = localStorage.getItem('financeManagerData');
                var theme = null;
                if (raw) {
                    var parsed = JSON.parse(raw || '{}');
                    theme = parsed && parsed.theme;
                }
                if (!theme) {
                    theme = (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) ? 'dark' : 'light';
                }
                document.body.classList.toggle('theme-dark', theme === 'dark');
                document.body.classList.toggle('theme-blue', theme === 'blue' || theme === 'paywall');
                window.__preTheme = theme;
            } catch (e) { }
        })();
    </script>
    <div style="position: fixed; top: 0; left: 0; opacity: 0; pointer-events: none; width: 0; height: 0; overflow: hidden;">
        <input type="text" name="fake_email_trap" id="fake_email_trap" autocomplete="username" tabindex="-1" />
        <input type="password" name="fake_password_trap" id="fake_password_trap" autocomplete="current-password" tabindex="-1" />
    </div>
    <div id="paywall-overlay" data-guard="PAYWALL_GUARD_v1" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0b1020; z-index: 99999; flex-direction: column; flex-wrap: nowrap; align-items: center; justify-content: flex-start; gap: 12px; color: white; text-align: center; padding: 20px; overflow-y: auto; -webkit-overflow-scrolling: touch; overscroll-behavior: contain;">
        <div style="width: 92%; max-width: 420px; background: rgba(255,255,255,0.1); padding: clamp(12px, 3.5svh, 24px); border-radius: 20px; border: 1px solid rgba(255,255,255,0.2); box-sizing: border-box;">
            <div style="font-size: clamp(24px, 5.5svh, 36px); line-height: 1; margin-bottom: 8px;">🔒</div>
            <h2 style="margin-bottom: 6px; font-size: clamp(15px, 2.6svh, 18px);">Account Activation Required</h2>
            <p style="margin-bottom: 6px; line-height: 1.35; color: #ccc; font-size: clamp(11px, 1.8svh, 13px);">
                This is a one-time subscription for new users! This offer will last only for a short time.After this offer, new users will have be paying monthly fees.
            </p>
            <p style="margin-bottom: 6px; font-weight: 700; color: #ffd54f; font-size: clamp(q9px, 1.8svh, 13px);">
                Claim The offer,Own your Spot!💪.
            </p>
            <p style="margin-bottom: 10px; line-height: 1.35; color: #ccc; font-weight:700; font-size: clamp(19px, 1.8svh, 13px);">
                Subscription Amount: 35,000/= Tsh (No Bargain!)
            </p>

            <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; margin-bottom: 14px; text-align: left;">
                <p style="font-weight: bold; margin-bottom: 6px;">Admin Info (Click)</p>
                    <div style="font-size: clamp(11px, 1.8svh, 13px); color: #ddd; line-height: 1.35; word-break: break-word;">
                    <div>Email: <a id="paywallAdminEmailLink" href="#" style="color:#fff; text-decoration: underline;"></a></div>
                    <div>Phone: <a id="paywallAdminPhoneLink" href="#" style="color:#fff; text-decoration: underline;"></a></div>
                    <div>WhatsApp: <a id="paywallAdminWhatsAppLink" href="#" target="_blank" rel="noopener" style="color:#fff; text-decoration: underline;"></a></div>
                    </div>
                </div>

            <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; margin-bottom: 16px; text-align: left;">
                <p style="font-weight: bold; margin-bottom: 6px;">Payment Methods Accepted</p>
                <ul style="padding-left: 18px; color: #ddd; font-size: clamp(11px, 1.8svh, 13px); line-height: 1.35;">
                    <li>Mobile Money: M-Pesa, Mix by Yas, Airtel Money, HaloPesa (TZ)</li>
                    <li>M-Pesa Lipa: 35999929 (HAYSAM RAMADHAN)</li>
                    <li>Bank Transfer</li>
                </ul>
            </div>

            <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; margin-bottom: 20px; text-align: left;">
                <p style="font-weight: bold; margin-bottom: 6px;">Payment Instructions</p>
                <ol style="padding-left: 20px; color: #ddd; font-size: clamp(11px, 1.8svh, 13px); line-height: 1.35;">
                    <li>Pay 35,000/= Tsh via M-Pesa Lipa (35999929 - HAYSAM RAMADHAN) or any accepted method.</li>
                    <li>Call or WhatsApp me to confirm activation.</li>
                    <li>Send me your User Email after Payement </li>
                    <li>Enjoy the app - From TUBA FINANCES APP Admin !.</li>
                </ol>
            </div>

            <button onclick="window.location.reload()" style="background: #667eea; color: white; border: none; padding: clamp(10px, 2.2svh, 12px) clamp(14px, 5vw, 22px); border-radius: 50px; font-weight: bold; cursor: pointer; width: 100%; font-size: clamp(11px, 1.8svh, 13px);">
                I Have Paid (Refresh)
            </button>
            
            <p style="margin-top: 10px; font-size: clamp(10px, 1.6svh, 12px); color: #666;">
                Account ID: <span id="paywall-user-id">...</span>
            </p>
        </div>
        
    </div>
    
    <div id="hiddenFocusTarget" tabindex="-1"
        style="position: fixed; top: 0; left: 0; opacity: 0; pointer-events: none; width: 0; height: 0;"></div>

    
            <div class="side-nav-overlay" id="sideNavOverlay" onclick="toggleSideNav()"></div>
            <div class="side-nav" id="sideNav">
                <div class="side-nav-header">
                    <div class="side-nav-title">
                        <h2>TUBA FINANCES APP</h2>
                        <button class="side-nav-sound" id="sideNavSoundHeaderButton" onclick="toggleSoundNotifications()" title="Toggle sound" aria-label="Toggle sound" style="display:none;">
                            <span id="sideNavSoundHeaderIcon">🔊</span>
                        </button>
                        <button class="side-nav-sound" id="sideNavThemeHeaderButton" onclick="toggleTheme()" title="Toggle theme" aria-label="Toggle theme" style="display:none;">
                            <span id="sideNavThemeHeaderIcon">🌞</span>
                        </button>
                    </div>
                    <button class="side-nav-close" onclick="toggleSideNav()" title="Close" aria-label="Close">×</button>
                </div>
                <a id="iosInstallButton" href="/tuba.mobileconfig" download class="ios-download-btn" style="display:none; margin: 6px 12px 8px;">
                    <span class="ios-download-icon">
                        <svg width="14" height="14" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M15.07 11.45c.02-2.5 2.05-3.7 2.14-3.76-1.17-1.72-3-1.95-3.65-1.98-1.55-.16-3.03.91-3.81.91-.79 0-2-.88-3.3-.86-1.72.03-3.3.1-4.8 2.7-2.12 3.65-.54 8.95 1.51 11.9 1 1.45 2.19 3.07 3.76 3.01 1.51-.06 2.08-.98 3.9-.98s2.33.98 3.92.95c1.64-.03 2.66-1.46 3.66-2.91 1.15-1.68 1.63-3.3 1.65-3.39-.03-.02-3.18-1.22-3.21-4.88zM12.3 4.14c.7-.85 1.17-2.03 1.04-3.21-1.01.04-2.24.67-2.96 1.52-.65.75-1.22 1.95-1.07 3.1 1.13.09 2.29-.56 2.99-1.41z"/>
                        </svg>
                    </span>
                    <span>Download iOS App</span>
                </a>

                <div class="side-nav-content">
                    <div class="side-nav-section-title">Quick Actions</div>
                    <div class="quick-row">
                        <div class="quick-item">
                            <button class="quick-btn" id="quickThemeBtn" title="Theme" onclick="toggleThemeQuick(); toggleSideNav();">🎨</button>
                            <div class="quick-label">Theme</div>
                        </div>
                        <div class="quick-item">
                            <button class="quick-btn" id="quickSoundBtn" title="Sound" onclick="toggleSoundNotifications(); toggleSideNav();">🔊</button>
                            <div class="quick-label">Sound</div>
                        </div>
                        <div class="quick-item">
                            <button class="quick-btn" id="quickPushBtn" title="Notification" onclick="togglePushQuick(); toggleSideNav();">📥</button>
                            <div class="quick-label">Notification</div>
                        </div>
                        <div class="quick-item">
                            <button class="quick-btn" id="quickPrefsBtn" title="Choices" onclick="openPushPreferencesModal(); toggleSideNav();">⚙️</button>
                            <div class="quick-label">Choices</div>
                        </div>
                        <div class="quick-item" style="display:none;">
                            <button class="quick-btn" id="quickTestBtn" title="Test Alert" onclick="sendTestPush(); toggleSideNav();">🚀</button>
                            <div class="quick-label">Test</div>
                        </div>
                    </div>
                    <div class="side-nav-section-title">Main</div>
                    <div class="side-nav-item" id="sideNavAuthButton" onclick="handleSideNavAuth()">
                        <span class="side-nav-icon" id="sideNavAuthIcon">🔐</span>
                        <span id="sideNavAuthText">Login</span>
                    </div>
                    <div class="side-nav-item" onclick="navigateToTab('account')">
                        <span class="side-nav-icon">👤</span>
                        <span>Profile</span>
                    </div>
                    <div class="side-nav-item" onclick="navigateToTab('dashboard')">
                        <span class="side-nav-icon">📊</span>
                        <span>Dashboard</span>
                    </div>
                    <div class="side-nav-item" onclick="navigateToTab('sales')">
                        <span class="side-nav-icon"></span>
                        <span>Sales</span>
                    </div>
                    <div class="side-nav-item" onclick="navigateToTab('transactions')">
                        <span class="side-nav-icon">💳</span>
                        <span>Transactions</span>
                    </div>
                    <div class="side-nav-item" onclick="navigateToTab('invoices')">
                        <span class="side-nav-icon">📄</span>
                        <span>Invoices</span>
                    </div>
                    <div class="side-nav-item" onclick="openContactDeveloperModal(); toggleSideNav();">
                        <span class="side-nav-icon">📞</span>
                        <span>Contact Developer</span>
                    </div>
                    <div class="side-nav-item" onclick="downloadUserGuidePDF(); toggleSideNav();">
                        <span class="side-nav-icon">📘</span>
                        <span>User Guide (PDF)</span>
                    </div>
                    <div class="side-nav-item" onclick="openPrivacyPolicyModal(); toggleSideNav();">
                        <span class="side-nav-icon">🔐</span>
                        <span>Privacy & Policy</span>
                    </div>

                    <div class="side-nav-divider"></div>
                    <div class="side-nav-section-title">Management</div>
                    <div class="side-nav-item" onclick="navigateToTab('products')">
                        <span class="side-nav-icon">🛍️</span>
                        <span>Products/Services</span>
                    </div>
                    <div class="side-nav-item" onclick="navigateToTab('categories')">
                        <span class="side-nav-icon">📑</span>
                        <span>Categories</span>
                    </div>
                    <div class="side-nav-item" onclick="navigateToTab('inventory')">
                        <span class="side-nav-icon">📦</span>
                        <span>Stock</span>
                    </div>
                    <div class="side-nav-item" onclick="navigateToTab('inventoryPurchases')">
                        <span class="side-nav-icon">📦</span>
                        <span>Inventory</span>
                    </div>
                    <div class="side-nav-item" onclick="navigateToTab('customers')">
                        <span class="side-nav-icon">👥</span>
                        <span>Customers</span>
                    </div>

                    <div class="side-nav-item" onclick="navigateToTab('assets')">
                        <span class="side-nav-icon">🏗️</span>
                        <span>Assets</span>
                    </div>
                    <div class="side-nav-item" onclick="navigateToTab('maintenance')">
                        <span class="side-nav-icon">🛠️</span>
                        <span>Maintenance</span>
                    </div>

                    <div class="side-nav-divider"></div>
                    <div class="side-nav-section-title">Finance</div>
                    <div class="side-nav-item" onclick="navigateToTab('expenses')">
                        <span class="side-nav-icon">💸</span>
                        <span>Expenses</span>
                    </div>
                    <div class="side-nav-item" onclick="navigateToTab('income')">
                        <span class="side-nav-icon">💰</span>
                        <span>Income</span>
                    </div>
                    <div class="side-nav-item" onclick="navigateToTab('unpaid')">
                        <span class="side-nav-icon">⏳</span>
                        <span>Unpaid</span>
                    </div>
                    <div class="side-nav-item" onclick="navigateToTab('analytics')">
                        <span class="side-nav-icon">📈</span>
                        <span>Analytics</span>
                    </div>
                    <div class="side-nav-item" onclick="openProfitShareAnalyticsModal()">
                        <span class="side-nav-icon">💵</span>
                        <span>10% Profit Analysis</span>
                    </div>

                    <div class="side-nav-divider"></div>
                    <div class="side-nav-section-title">Quick Downloads</div>
                    <div class="side-nav-item" onclick="openStocksheetModal()">
                        <span class="side-nav-icon">📦</span>
                        <span>Generate Stock Sheet (PDF)</span>
                    </div>
                    <div class="side-nav-item" onclick="downloadDailyReportPDF()">
                        <span class="side-nav-icon">📆</span>
                        <span>Daily Report (PDF)</span>
                    </div>
                    <div class="side-nav-item" onclick="openReportRangeModal()">
                        <span class="side-nav-icon">📄</span>
                        <span>General Report (PDF)</span>
                    </div>
                    <div class="side-nav-item" onclick="openReportRangeModal()">
                        <span class="side-nav-icon">📗</span>
                        <span>General Report (Excel)</span>
                    </div>
                    <div class="side-nav-item" onclick="openExpensesReportRangeModal()">
                        <span class="side-nav-icon">💸</span>
                        <span>Expenses Report (PDF)</span>
                    </div>
                    <div class="side-nav-item" onclick="openIncomeReportRangeModal()">
                        <span class="side-nav-icon"></span>
                        <span>Income Report (PDF)</span>
                    </div>


            <div class="side-nav-divider"></div>
                    <div class="side-nav-section-title">Tools</div>
                    <div class="side-nav-item" onclick="navigateToTab('notes')">
                        <span class="side-nav-icon">📝</span>
                        <span>Notes</span>
                    </div>
                    <div class="side-nav-item" onclick="openTagsModal(); toggleSideNav();">
                        <span class="side-nav-icon">📌</span>
                        <span>Tags & Organization</span>
                    </div>
                    <div class="side-nav-item" id="sideNavCloudDiagnostics" style="display:none;" onclick="openCloudDiagnosticsModal(); toggleSideNav();">
                        <span class="side-nav-icon">🛡️</span>
                        <span>Cloud Diagnostics</span>
                    </div>
                    <div class="side-nav-item" id="sideNavSoundButton" onclick="toggleSoundNotifications()">
                        <span class="side-nav-icon" id="sideNavSoundIcon">🔊</span>
                        <span id="sideNavSoundText">Sound: On</span>
                    </div>
                    <div class="side-nav-item" onclick="subscribeToPush(); toggleSideNav();">
                        <span class="side-nav-icon">📥</span>
                        <span>Enable Push Notifications</span>
                    </div>
                    <div class="side-nav-item" onclick="openPushPreferencesModal(); toggleSideNav();">
                        <span class="side-nav-icon">⚙️</span>
                        <span>Push Preferences</span>
                    </div>
                    <div class="side-nav-item" onclick="resetPushSubscription(); toggleSideNav();">
                        <span class="side-nav-icon">♻️</span>
                        <span>Reset Push Notifications</span>
                    </div>
                    <div class="side-nav-item" onclick="toggleDeveloperMode(); toggleSideNav();">
                        <span class="side-nav-icon">🛠️</span>
                        <span>Developer Mode</span>
                    </div>
                    <div class="side-nav-item" id="sideNavSendTestAlert" style="display:none;" onclick="sendTestPush(); toggleSideNav();">
                        <span class="side-nav-icon">🚀</span>
                        <span>Send Test Alert</span>
                    </div>
                    
                    
        </div>

        <div class="modal" id="contactDeveloperModal">
            <div class="modal-content" style="max-width:480px;">
                <button class="modal-close" onclick="closeContactDeveloperModal()">×</button>
                <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px;">
                    <img src="./icons/tuba-icon-192.png" alt="TUBA" style="width:32px;height:32px;border-radius:8px;object-fit:contain;">
                    <div class="modal-title">TUBA - The Ultimate Business Architecture</div>
                </div>
                <div id="contactDeveloperDetails" style="font-size: 13px; color: #333; line-height: 1.6; margin-top:6px;"></div>
                <div class="flex-gap" style="margin-top:12px; justify-content:flex-end;">
                    <button class="btn-secondary btn-small" onclick="closeContactDeveloperModal()">Close</button>
                </div>
            </div>
        </div>
        <div class="modal" id="privacyPolicyModal">
            <div class="modal-content" style="max-width:640px;">
                <button class="modal-close" onclick="closePrivacyPolicyModal()">×</button>
                <div class="modal-title">Privacy & Policy</div>
                <div style="font-size:13px; color:#333; line-height:1.6; margin-top:6px;">
                    <p>Thank you for choosing TUBA. Your trust matters to us. We design TUBA to be privacy‑respectful and business‑friendly.</p>
                    <p><strong>What we store</strong><br>Business data you record in the app (for example: products, sales, income, expenses, customers, invoices, receipts, inventory, notes, and settings). This data powers features like analytics, reporting, and cloud backup.</p>
                    <p><strong>Where it is stored</strong><br>Data is saved locally on your device for offline use. When you sign in, data is synchronized to our cloud database powered by Supabase (Postgres). Learn more about how data is stored and managed here: <a href="https://supabase.com/docs/guides/database/overview" target="_blank" rel="noopener">Supabase Database Overview</a>.</p>
                    <p><strong>Who can access it</strong><br>Only the authenticated account owner can access their data. We use per‑user access controls to prevent other users from viewing or modifying your records.</p>
                    <p><strong>How we use it</strong><br>Your data is used solely to deliver app functionality (sync, reports, analytics). We do not sell your data.</p>
                    <p><strong>Security</strong><br>Connections to the cloud use secure HTTPS. Supabase manages the database infrastructure and backups for reliability.</p>
                    <p><strong>Your choices</strong><br>You can export a local backup anytime and manage cloud sync under Account. If you have questions or want your data removed from the cloud, navigate to the Account page, make sure you're logged in then click "detete account permanently", or, you can contact us using the "Contact Developer" option from your side menu.</p>
                </div>
                <div class="flex-gap" style="margin-top:12px; justify-content:flex-end;">
                    <button class="btn-secondary btn-small" onclick="closePrivacyPolicyModal()">Close</button>
                </div>
            </div>
        </div>
        <div class="modal" id="pushPreferencesModal">
            <div class="modal-content" style="max-width:480px;">
                <button class="modal-close" onclick="closePushPreferencesModal()">×</button>
                <div class="modal-title">Push Preferences</div>
                <div class="form-group">
                    <label><input type="checkbox" id="pushPrefMorning"> Morning reminder</label>
                </div>
                <div class="form-group">
                    <label><input type="checkbox" id="pushPrefEvening"> Evening reminder</label>
                </div>
                <div class="form-group">
                    <label><input type="checkbox" id="pushPrefBackup"> Backup reminder</label>
                </div>
                <div class="form-group">
                    <label><input type="checkbox" id="pushPrefDestructive"> Destructive operation alerts</label>
                </div>
                <div class="flex-gap" style="margin-top:12px; justify-content:flex-end;">
                    <button class="btn-success btn-small" onclick="savePushPreferences(); closePushPreferencesModal()">Save</button>
                    <button class="btn-secondary btn-small" onclick="closePushPreferencesModal()">Cancel</button>
                </div>
            </div>
        </div>
        <div class="modal" id="offlineInfoModal">
            <div class="modal-content">
                <button class="modal-close" onclick="closeOfflineInfoModal()">×</button>
                <div class="modal-title">Offline Usage</div>
                <div style="font-size: 13px; color: #333; line-height: 1.5;">
                    <p>You’re offline. All changes are saved locally and will sync when you’re back online.</p>
                    <p><strong>How to save a local backup:</strong><br>
                        Tap the top-right save button (💾) or click the “Consider Local Backup” toast to export a JSON
                        file.</p>
                    <p><strong>When back online:</strong><br>
                        Click the sync indicator (“Synced ☁️ → Click to 🔄”) to push data silently, or use Account →
                        Push to Cloud.</p>
                    <p><strong>Tip:</strong> You can continue recording sales, products, income, etc., while offline —
                        they’ll sync later.</p>
                </div>
                <div style="display: flex; gap: 8px; margin-top: 16px; justify-content: flex-end;">
                    <button class="btn-small btn-success" onclick="exportData('Saved', 2000)">Backup Now</button>
                    <button class="btn-small btn-secondary" onclick="closeOfflineInfoModal()">Close</button>
                </div>
            </div>
        </div>

        <div class="modal" id="notificationsModal">
            <div class="modal-content" style="max-width:480px;">
                <button class="modal-close" onclick="closeNotificationsModal()">×</button>
                <div class="modal-title">Enable Notifications</div>
                <div style="font-size: 13px; color: #333; line-height: 1.6; margin-top:6px;">
                    Turn on notifications to receive alerts and updates. You can change this later in Tools.
                </div>
                <div class="flex-gap" style="margin-top:12px;">
                    <button class="btn-primary btn-small" onclick="enableNotifications()">Enable</button>
                    <button class="btn-secondary btn-small" onclick="closeNotificationsModal()">Later</button>
                </div>
            </div>
        </div>

        <div class="modal" id="pinEntryModal">
            <div class="modal-content" style="max-width:380px;">
                <button class="modal-close" type="button" onclick="closeModalById('pinEntryModal')">×</button>
                <div class="modal-title">Confirm Action</div>
                <div style="font-size:12px; color:#555; margin-top:6px;">This PIN is required for safety of your data.</div>
                <div class="form-group">
                    <label>Enter 4-digit PIN</label>
                    <div style="display:flex;align-items:center;gap:8px;">
                        <input type="password" id="pinEntryInput" maxlength="4" inputmode="numeric" pattern="[0-9]{4}" oninput="this.value=this.value.replace(/[^0-9]/g,'').slice(0,4); var t=document.getElementById('pinEntryToggle'); if(t) t.style.display = this.value.length>0 ? 'inline-flex' : 'none'; if (this.value.length === 4) { var b=document.getElementById('pinEntryConfirm'); if (b) b.click(); }">
                        <button class="btn-secondary btn-small" id="pinEntryToggle" style="display:none;" onclick="(function(){ var i=document.getElementById('pinEntryInput'); if(!i) return; i.type = (i.type==='password')?'text':'password'; })()">👁</button>
                    </div>
                </div>
                <div class="flex-gap" style="margin-top:8px;">
                    <button class="btn-success" id="pinEntryConfirm" type="button">Confirm</button>
                    <button class="btn-secondary" id="pinEntryCancel" type="button" onclick="closeModalById('pinEntryModal')">Cancel</button>
                </div>
            </div>
        </div>

        <div class="modal" id="pinSetModal">
            <div class="modal-content" style="max-width:380px;">
                <button class="modal-close" type="button" onclick="closeModalById('pinSetModal')">×</button>
                <div class="modal-title">Set Security PIN</div>
                <div style="font-size:12px; color:#555; margin-top:6px;">This PIN is required for safety of your data.</div>
                <div class="form-group" id="pinSetCurrentGroup" style="display: none;">
                    <label>Enter your main password</label>
                    <div style="display:flex;align-items:center;gap:8px;">
                        <input type="password" id="pinSetInputCurrent" oninput="var t=document.getElementById('pinSetToggleCurrent'); if(t) t.style.display = this.value.length>0 ? 'inline-flex' : 'none';">
                        <button class="btn-secondary btn-small" id="pinSetToggleCurrent" style="display:none;" onclick="(function(){ var i=document.getElementById('pinSetInputCurrent'); if(!i) return; i.type = (i.type==='password')?'text':'password'; })()">👁</button>
                    </div>
                </div>
                <div class="form-group">
                    <label>Create 4-digit PIN</label>
                    <div style="display:flex;align-items:center;gap:8px;">
                        <input type="password" id="pinSetInput" maxlength="4" inputmode="numeric" pattern="[0-9]{4}" oninput="this.value=this.value.replace(/[^0-9]/g,'').slice(0,4); var t=document.getElementById('pinSetToggle'); if(t) t.style.display = this.value.length>0 ? 'inline-flex' : 'none';">
                        <button class="btn-secondary btn-small" id="pinSetToggle" style="display:none;" onclick="(function(){ var i=document.getElementById('pinSetInput'); if(!i) return; i.type = (i.type==='password')?'text':'password'; })()">👁</button>
                    </div>
                </div>
                <div class="form-group">
                    <label>Confirm 4-digit PIN</label>
                    <div style="display:flex;align-items:center;gap:8px;">
                        <input type="password" id="pinSetInputConfirm" maxlength="4" inputmode="numeric" pattern="[0-9]{4}" oninput="this.value=this.value.replace(/[^0-9]/g,'').slice(0,4); var t=document.getElementById('pinSetToggleConfirm'); if(t) t.style.display = this.value.length>0 ? 'inline-flex' : 'none';">
                        <button class="btn-secondary btn-small" id="pinSetToggleConfirm" style="display:none;" onclick="(function(){ var i=document.getElementById('pinSetInputConfirm'); if(!i) return; i.type = (i.type==='password')?'text':'password'; })()">👁</button>
                    </div>
                </div>
                <div class="flex-gap" style="margin-top:8px;">
                    <button class="btn-success" id="pinSetConfirm" type="button" onclick="savePinFromModal()">Save PIN</button>
                    <button class="btn-secondary" id="pinSetCancel" type="button" onclick="closeModalById('pinSetModal')">Cancel</button>
                </div>
            </div>
        </div>

        <div class="modal" id="profileSetupPromptModal">
            <div class="modal-content" style="max-width:420px;">
                <button class="modal-close" type="button" onclick="closeModalById('profileSetupPromptModal')">×</button>
                <div class="modal-title">Complete Your Profile</div>
                <div style="font-size:12px; color:#555; margin-top:6px;">Your business details appear on receipts and reports.</div>
                <div class="flex-gap" style="margin-top:12px;">
                    <button class="btn-success" id="profileSetupGo" type="button">Setup My Profile</button>
                    <button class="btn-secondary" id="profileSetupProceed" type="button">Proceed Anyway</button>
                </div>
            </div>
        </div>

        <div class="modal" id="profitShareAnalyticsModal">
            <div class="modal-content" style="max-width: 600px; font-family: inherit;">
                <button class="modal-close" onclick="closeProfitShareAnalyticsModal()">×</button>
                <div class="modal-title">💵 10% Profit Analysis</div>

                <div class="transaction-tabs" style="margin-top: 16px;">
                    <button class="transaction-tab" id="profitPeriodWeekly"
                        style="background: linear-gradient(145deg, #1976d2, #0d47a1); font-size:12px; padding:10px 12px;"
                        onclick="switchProfitSharePeriod('weekly')">
                        Weekly
                    </button>
                    <button class="transaction-tab" id="profitPeriodMonthly"
                        style="background: linear-gradient(145deg, #1976d2, #0d47a1); font-size:12px; padding:10px 12px;"
                        onclick="switchProfitSharePeriod('monthly')">
                        Monthly
                    </button>
                    <button class="transaction-tab" id="profitPeriodHalfYear"
                        style="background: linear-gradient(145deg, #1976d2, #0d47a1); font-size:12px; padding:10px 12px;"
                        onclick="switchProfitSharePeriod('halfYear')">
                        6 Months
                    </button>
                    <button class="transaction-tab" id="profitPeriodYearly"
                        style="background: linear-gradient(145deg, #1976d2, #0d47a1); font-size:12px; padding:10px 12px;"
                        onclick="switchProfitSharePeriod('yearly')">
                        Yearly
                    </button>
                </div>

                <div id="profitShareAnalyticsContent" style="margin-top: 20px;">
                </div>

                <div style="display: flex; gap: 8px; margin-top: 16px; justify-content: flex-end;">
                    <button class="btn-small btn-secondary" onclick="closeProfitShareAnalyticsModal()">Close</button>
                </div>
            </div>
        </div>


        <div class="modal" id="pdfViewerModal">
            <div class="modal-content"
                style="width: 92%; max-width: 920px; height: 85vh; display: flex; flex-direction: column;">
                <button class="modal-close" onclick="closePdfViewer()">×</button>
                <div class="modal-title" id="pdfViewerTitle">PDF Preview</div>
                <div style="flex:1; border:1px solid rgba(0,0,0,0.12); border-radius:8px; overflow:hidden;">
                    <iframe id="pdfIframe" style="width:100%; height:100%;"></iframe>
                </div>
                <div style="display: flex; gap: 8px; margin-top: 12px; justify-content: flex-end;">
                    <button class="btn-small" id="pdfDownloadBtn">Download</button>
                    <button class="btn-small btn-secondary" onclick="closePdfViewer()">Close</button>
                </div>
            </div>
        </div>



        <div class="side-nav-footer">
            <div class="side-nav-footer-text">Empowering Your Business</div>
            <div class="side-nav-footer-brand">The Ultimate Business Architecture (TUBA)</div>
        </div>
    </div>
    <div class="modal" id="expensesReportRangeModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeExpensesReportRangeModal()">×</button>
            <div class="modal-title">Expenses Report (PDF)</div>
            <div style="margin-top:8px;">
                <div class="grid-2" style="gap:8px;">
                    <div>
                        <label>From</label>
                        <input type="date" id="expensesReportFromDate" />
                    </div>
                    <div>
                        <label>To</label>
                        <input type="date" id="expensesReportToDate" />
                    </div>
                </div>
            </div>
            <div class="flex-gap" style="margin-top:12px;">
                <button class="btn-small" onclick="applyExpensesReportRange('selected')">Download Selected</button>
                <button class="btn-small" onclick="applyExpensesReportRange('all')">Download All</button>
                <button class="btn-secondary btn-small" onclick="closeExpensesReportRangeModal()">Cancel</button>
                <button class="btn-secondary btn-small" onclick="closeExpensesReportRangeModal()">Exit</button>
            </div>
        </div>
    </div>
    <div class="modal" id="incomeReportRangeModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeIncomeReportRangeModal()">×</button>
            <div class="modal-title">Income Report (PDF)</div>
            <div style="margin-top:8px;">
                <div class="grid-2" style="gap:8px;">
                    <div>
                        <label>From</label>
                        <input type="date" id="incomeReportFromDate" />
                    </div>
                    <div>
                        <label>To</label>
                        <input type="date" id="incomeReportToDate" />
                    </div>
                </div>
            </div>
            <div class="flex-gap" style="margin-top:12px;">
                <button class="btn-small" onclick="applyIncomeReportRange('selected')">Download Selected</button>
                <button class="btn-small" onclick="applyIncomeReportRange('all')">Download All</button>
                <button class="btn-secondary btn-small" onclick="closeIncomeReportRangeModal()">Cancel</button>
                <button class="btn-secondary btn-small" onclick="closeIncomeReportRangeModal()">Exit</button>
            </div>
        </div>
    </div>
    <div class="modal" id="tenPercentReportModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeTenPercentReportModal()">×</button>
            <div class="modal-title">10% Report (PDF)</div>
            <div style="margin-top:8px;">
                <div class="grid-2" style="gap:8px;">
                    <div>
                        <label>Period</label>
                        <select id="tenPercentReportMode" onchange="toggleTenPercentWeeksInput()">
                            <option value="weeks">Past weeks</option>
                            <option value="month">Current Month</option>
                            <option value="all">All (by month)</option>
                        </select>
                    </div>
                    <div id="tenPercentWeeksWrap" style="display:none;">
                        <label>Weeks</label>
                        <input type="number" id="tenPercentWeeksCount" min="1" max="52" value="1" />
                    </div>
                </div>
            </div>
            <div class="flex-gap" style="margin-top:12px;">
                <button class="btn-small" onclick="applyTenPercentReport()">Download</button>
                <button class="btn-secondary btn-small" onclick="closeTenPercentReportModal()">Cancel</button>
                <button class="btn-secondary btn-small" onclick="closeTenPercentReportModal()">Exit</button>
            </div>
        </div>
    </div>
    <div class="modal" id="tithingModal"></div>
    <div class="welcome-screen">
        <div class="welcome-logo"><img src="./icons/tuba-icon-192.png" alt="TUBA" style="width:64px;height:64px;border-radius:12px;object-fit:contain;"></div>
        <div class="welcome-title">
            TUBA FINANCES APP
        </div>
        <div class="welcome-subtitle">The Ultimate Business Architecture</div>
    </div>

    <div class="app-container">
        <div class="header">
            <button class="header-btn-left" onclick="toggleSideNav()">☰</button>
            <div class="sync-indicator" id="syncIndicator">Synced ☁️</div>
            <div style="display: flex; flex-direction: column; align-items: center; gap: 2px;">
                <h1 style="margin: 0;">TUBA</h1>
                <div id="headerDate" style="font-size: 9px; opacity: 0.8; font-weight: 400;"></div>
            </div>
            <div style="position: absolute; right: 16px; top: 50%; transform: translateY(-50%); display: flex; gap: 8px;">
                <div class="toolbar-item">
                    <button class="toolbar-btn" onclick="exportData()" title="Export" aria-label="Export">💾</button>
                    <div class="toolbar-label">Export</div>
                </div>
                <div class="toolbar-item">
                    <button class="toolbar-btn" onclick="importData()" title="Import" aria-label="Import">📥</button>
                    <div class="toolbar-label">Import</div>
                </div>
                <div class="toolbar-item">
                    <button class="toolbar-btn" onclick="refreshApp()" ontouchstart="refreshApp()" title="Refresh" aria-label="Refresh">↻</button>
                    <div class="toolbar-label">Refresh</div>
                </div>
            </div>
        </div>

        <div id="offlineBanner" class="offline-banner" role="status" aria-live="polite" aria-atomic="true"></div>
        <div id="authBanner" class="offline-banner auth-banner" role="status" aria-live="polite" aria-atomic="true">
        </div>
        <div id="installedPwaBanner" class="offline-banner" role="status" aria-live="polite" aria-atomic="true" style="display:none;"></div>

        <div class="content" id="app"></div>
        <div class="bottom-nav" id="bottomNav"></div>
        <button id="globalSearchFab" class="fab hint" title="Search" aria-label="Search" onclick="openGlobalSearch()"
            style="position: fixed; right: 16px; bottom: 80px; z-index: 1000;">🔎</button>
    </div>

        <div class="modal" id="noteModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeNoteModal()">×</button>
            <div class="modal-title">Note Details</div>
            <div id="noteModalContent"></div>
            <div id="noteModalActions" style="display: flex; gap: 8px; margin-top: 16px;">
                <button class="btn-small" onclick="copyNoteFromModal()">📋 Copy</button>
                <button class="btn-small btn-success" onclick="shareNoteFromModal()">📤 Send</button>
                <button class="btn-small" onclick="editNoteFromModal()">Edit</button>
                <button class="btn-small btn-secondary" onclick="closeNoteModal()">Close</button>
            </div>
            <div id="noteModalEditActions" style="display:none; gap: 8px; margin-top: 16px;">
                <button class="btn-small btn-success" onclick="saveNoteEditFromModal()">💾 Save</button>
                <button class="btn-small btn-secondary" onclick="cancelNoteEditFromModal()">✖ Cancel</button>
            </div>
        </div>
    </div>

    <div class="modal" id="inlineEditModal">
        <div class="modal-content" style="max-width:520px;">
            <button class="modal-close" onclick="closeInlineEditModal()">×</button>
            <div class="modal-title" id="inlineEditModalTitle">Edit</div>
            <div id="inlineEditModalContent"></div>
            <div id="inlineEditModalActions" style="display:flex; gap:8px; margin-top:16px;"></div>
        </div>
    </div>


    <div class="modal" id="cleanupModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeCleanupModal()">×</button>
            <div class="modal-title">Clean Duplicate Records</div>
            <p>This will remove duplicate entries from your local and cloud data based on ID.</p>
            <div style="display: flex; gap: 8px; margin-top: 16px;">
                <button class="btn-small btn-success" onclick="confirmCleanup()">Proceed</button>
                <button class="btn-small btn-secondary" onclick="closeCleanupModal()">Cancel</button>
            </div>
        </div>
    </div>

    <div class="modal" id="cloudDiagnosticsModal">
        <div class="modal-content" style="max-width: 640px;">
            <button class="modal-close" onclick="closeCloudDiagnosticsModal()">×</button>
            <div class="modal-title">🛡️ Cloud Sync Diagnostics</div>
            <div id="cloudDiagnosticsContent" style="font-size:13px; line-height:1.6;"></div>
            <div id="cloudFixSql"
                style="font-size:12px; line-height:1.5; margin-top:12px; white-space:pre-wrap; border:1px solid rgba(0,0,0,0.12); border-radius:8px; padding:10px; display:none;">
            </div>
            <div style="display:flex; gap:8px; margin-top:16px; justify-content:flex-end; flex-wrap:wrap;">
                <button class="btn-small" onclick="runCloudDiagnostics()">Run</button>
                <button class="btn-small" onclick="generateCloudFixSql('targeted')">Fix Targeted</button>
                <button class="btn-small" onclick="generateCloudFixSql('full')">Fix All</button>
                <button class="btn-small" onclick="copyCloudFixSql()">Copy SQL</button>
                <button class="btn-small btn-secondary" onclick="closeCloudDiagnosticsModal()">Close</button>
            </div>
        </div>
    </div>

    <div class="modal" id="unpaidSalesModal" onclick="if(event.target.id === 'unpaidSalesModal') closeUnpaidSalesModal();">
        <div class="modal-content" style="max-width: 640px;">
            <button class="modal-close" onclick="closeUnpaidSalesModal()">×</button>
            <div class="modal-title">⏳ Unpaid Sales</div>
            <div id="unpaidSalesContent" style="font-size:13px; line-height:1.6;"></div>
            <div style="display:flex; gap:8px; margin-top:16px; justify-content:flex-end;">
                <button class="btn-small btn-secondary" onclick="closeUnpaidSalesModal()">Close</button>
            </div>
        </div>
    </div>

    <div class="modal" id="saleDetailModal" onclick="if(event.target.id === 'saleDetailModal') closeSaleDetailModal();">
        <div class="modal-content" style="max-width: 640px;">
            <button class="modal-close" onclick="closeSaleDetailModal()">×</button>
            <div class="modal-title">🧾 Sale Details</div>
            <div id="saleDetailContent" style="font-size:13px; line-height:1.6;"></div>
            <div style="display:flex; gap:8px; margin-top:16px; justify-content:flex-end;">
                <button class="btn-small btn-secondary" onclick="closeSaleDetailModal()">Close</button>
            </div>
        </div>
    </div>

    <div class="modal" id="availableCapitalModal">
        <div class="modal-content" style="max-width: 640px;">
            <button class="modal-close" onclick="closeAvailableCapitalModal()">×</button>
            <div class="modal-title"> Available Capital Breakdown</div>
            <div id="availableCapitalContent" style="font-size:13px; line-height:1.6;"></div>
            <div style="display:flex; gap:8px; margin-top:16px; justify-content:flex-end;">
                <button class="btn-small btn-secondary" onclick="closeAvailableCapitalModal()">Close</button>
            </div>
        </div>
    </div>

    <div id="capitalReturnFab" style="display:none; position: fixed; right: 16px; top: 72px; z-index: 10000; align-items:center; gap:8px;">
        <button class="fab hint" title="Capital Breakdown" aria-label="Capital Breakdown" onclick="openAvailableCapitalModal()"></button>
        <button class="btn-small btn-secondary" onclick="hideCapitalReturnFab()">Close</button>
    </div>

    <div class="modal" id="floatModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeFloatModal()">×</button>
            <div class="modal-title" id="floatModalTitle"></div>
            <div id="floatModalContent"></div>
        </div>
    </div>



        <div class="modal" id="deleteEmailModal">
            <div class="modal-content">
                <button class="modal-close" onclick="closeDeleteEmailModal()">×</button>
                <div class="modal-title">Confirm Email</div>
                <div style="margin-top:8px;">Type your email to confirm permanent deletion.</div>
                <div style="margin-top:10px;">
                    <input type="email" id="deleteEmailConfirm" placeholder="you@email.com" style="width:100%;">
                </div>
                <div class="flex-gap" style="margin-top:12px;">
                    <button class="btn-danger btn-small" onclick="deleteEmailModalDeletePressed()">Delete</button>
                    <button class="btn-secondary btn-small" onclick="closeDeleteEmailModal()">Keep my Account</button>
                    <button class="btn-small" onclick="downloadSalesReportPDF()">Download App Data</button>
                </div>
            </div>
        </div>

        <div class="modal" id="installedPwaHelpModal">
            <div class="modal-content" style="max-width: 640px;">
                <button class="modal-close" onclick="closeInstalledPwaHelpModal()">×</button>
                <div class="modal-title">Open Installed App</div>
                <div style="margin-top:8px; font-size:13px; line-height:1.6;">
                    On iPhone and iPad, Safari cannot open an installed web app automatically.<br><br>
                    If you have already installed TUBA:<br>
                    • Exit Safari and tap the TUBA icon on your Home Screen to open the app.<br><br>
                    If you haven’t installed yet:<br>
                    • Tap the Share button, then choose “Add to Home Screen”, and open TUBA from your Home Screen.
                </div>
                <div class="flex-gap" style="margin-top:12px; justify-content:flex-end;">
                    <button class="btn-secondary btn-small" onclick="closeInstalledPwaHelpModal()">OK</button>
                </div>
            </div>
        </div>

        <div class="modal" id="deleteBusinessModal">
            <div class="modal-content">
                <button class="modal-close" onclick="closeDeleteBusinessModal()">×</button>
                <div class="modal-title">Confirm Business Name</div>
                <div style="margin-top:8px;">Type your business name to confirm permanent deletion.</div>
                <div style="margin-top:10px;">
                    <input type="text" id="deleteBusinessConfirm" placeholder="Business Name" style="width:100%;">
                </div>
                <div class="flex-gap" style="margin-top:12px;">
                    <button class="btn-danger btn-small" onclick="deleteBusinessModalDeletePressed()">Delete</button>
                    <button class="btn-secondary btn-small" onclick="closeDeleteBusinessModal()">Keep my Account</button>
                    <button class="btn-small" onclick="downloadSalesReportPDF()">Download App Data</button>
                </div>
            </div>
        </div>

        <div class="modal" id="deleteFinalModal">
            <div class="modal-content">
                <button class="modal-close" onclick="closeDeleteFinalModal()">×</button>
                <div class="modal-title">Final Confirmation</div>
                <div style="margin-top:8px;">
                    Are you really sure you want to delete your account? There will be no way to recover your account or any of your data. Please be sure to document all important information. Upon deletion, you will lose all subscription rights (if any).
                </div>
                <div class="flex-gap" style="margin-top:12px;">
                    <button class="btn-danger btn-small" onclick="deleteFinalModalDeletePressed()">Delete</button>
                    <button class="btn-secondary btn-small" onclick="closeDeleteFinalModal()">Keep my Account</button>
                    <button class="btn-small" onclick="downloadSalesReportPDF()">Download App Data</button>
                </div>
            </div>
        </div>

        <div class="modal" id="deletePasswordModal">
            <div class="modal-content">
                <button class="modal-close" onclick="closeDeletePasswordModal()">×</button>
                <div class="modal-title">Confirm Password</div>
                <div style="margin-top:8px;">Enter your password to delete your account.</div>
                <div style="margin-top:10px;">
                    <input type="password" id="deletePasswordConfirm" placeholder="Password" style="width:100%;">
                </div>
                <div class="flex-gap" style="margin-top:12px;">
                    <button class="btn-danger btn-small" onclick="deletePasswordModalDeletePressed()">Delete my Account</button>
                    <button class="btn-secondary btn-small" onclick="closeDeletePasswordModal()">Cancel</button>
                </div>
            </div>
        </div>

        <div class="modal" id="dataDeleteEmailModal">
            <div class="modal-content">
                <button class="modal-close" onclick="closeDataDeleteEmailModal()">×</button>
                <div class="modal-title">Confirm Email</div>
                <div style="margin-top:8px;">Type your email to confirm cloud data deletion.</div>
                <div style="margin-top:10px;">
                    <input type="email" id="dataDeleteEmailConfirm" placeholder="you@email.com" style="width:100%;">
                </div>
                <div class="flex-gap" style="margin-top:12px;">
                    <button class="btn-danger btn-small" onclick="dataDeleteEmailModalDeletePressed()">Delete</button>
                    <button class="btn-secondary btn-small" onclick="closeDataDeleteEmailModal()">Keep my Data</button>
                    <button class="btn-small" onclick="downloadSalesReportPDF()">Download App Data</button>
                </div>
            </div>
        </div>
        <div class="modal" id="dataDeleteBusinessModal">
            <div class="modal-content">
                <button class="modal-close" onclick="closeDataDeleteBusinessModal()">×</button>
                <div class="modal-title">Confirm Business Name</div>
                <div style="margin-top:8px;">Type your business name to confirm cloud data deletion.</div>
                <div style="margin-top:10px;">
                    <input type="text" id="dataDeleteBusinessConfirm" placeholder="Business Name" style="width:100%;">
                </div>
                <div class="flex-gap" style="margin-top:12px;">
                    <button class="btn-danger btn-small" onclick="dataDeleteBusinessModalDeletePressed()">Delete</button>
                    <button class="btn-secondary btn-small" onclick="closeDataDeleteBusinessModal()">Keep my Data</button>
                    <button class="btn-small" onclick="downloadSalesReportPDF()">Download App Data</button>
                </div>
            </div>
        </div>
        <div class="modal" id="dataDeleteFinalModal">
            <div class="modal-content">
                <button class="modal-close" onclick="closeDataDeleteFinalModal()">×</button>
                <div class="modal-title">Final Confirmation</div>
                <div style="margin-top:8px;">
                    This will delete all your business data from the cloud. Your account remains active. Proceed?
                </div>
                <div class="flex-gap" style="margin-top:12px;">
                    <button class="btn-danger btn-small" onclick="dataDeleteFinalModalDeletePressed()">Delete</button>
                    <button class="btn-secondary btn-small" onclick="closeDataDeleteFinalModal()">Keep my Data</button>
                    <button class="btn-small" onclick="downloadSalesReportPDF()">Download App Data</button>
                </div>
            </div>
        </div>
        <div class="modal" id="dataDeletePasswordModal">
            <div class="modal-content">
                <button class="modal-close" onclick="closeDataDeletePasswordModal()">×</button>
                <div class="modal-title">Confirm Password</div>
                <div style="margin-top:8px;">Enter your password to delete cloud data.</div>
                <div style="margin-top:10px;">
                    <input type="password" id="dataDeletePasswordConfirm" placeholder="Password" style="width:100%;">
                </div>
                <div class="flex-gap" style="margin-top:12px;">
                    <button class="btn-danger btn-small" onclick="dataDeletePasswordModalDeletePressed()">Delete my Data</button>
                    <button class="btn-secondary btn-small" onclick="closeDataDeletePasswordModal()">Cancel</button>
                </div>
            </div>
        </div>
    <div class="modal" id="inventoryModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeInventoryModal()">×</button>
            <div class="modal-title">Add Inventory Purchase</div>
            <div id="inventoryModalContent"></div>
            <div class="flex-gap" style="margin-top:12px;">
                <button class="btn-success btn-small" onclick="addInventoryRecord()">Save Purchase</button>
                <button class="btn-secondary btn-small" onclick="closeInventoryModal()">Cancel</button>
            </div>
        </div>
    </div>

    <div id="tagsModalsContainer"></div>
    <div id="bulkTagsModalContainer"></div>

    <button class="btn btn-success" title="📱 Install App" style="display:none; position: fixed; bottom: 80px; right: 16px; z-index: 1000; padding: 8px 12px; font-size: 12px; width: auto; border-radius: 20px;">📱 Install App</button>

    <script>
        var currentUser = window.currentUser || null;
        var syncEnabled = window.syncEnabled || false;
        window.currentUser = currentUser;
        window.syncEnabled = syncEnabled;
        window.reportClientError = window.reportClientError || function(){};
        function isIOSDevice() {
            try {
                const userAgent = (window.navigator && window.navigator.userAgent || '').toLowerCase();
                return /iphone|ipad|ipod/.test(userAgent);
            } catch (e) {
                return false;
            }
        }
        function setupIosInstallButton() {
            const button = document.getElementById('iosInstallButton');
            if (!button) return;
            const isStandalone = (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches) || window.navigator.standalone;
            button.style.display = (isIOSDevice() && !isStandalone) ? 'inline-flex' : 'none';
        }
        (function () {
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', setupIosInstallButton);
            } else {
                setupIosInstallButton();
            }
        })();
        // ========================================
        // PASSWORD RESET REDIRECT HANDLER
        // ========================================
        (function () {
            const urlHash = window.location.hash.substring(1);
            const params = new URLSearchParams(urlHash);
            const accessToken = params.get('access_token');
            const type = params.get('type');
            const isStandalone = (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches) || window.navigator.standalone;

            if (type === 'recovery' && accessToken) {
                if (isStandalone) {
                    openInlineRecoveryReset(accessToken);
                } else {
                    const welcomeScreenUrl = 'https://tuba-finances.vercel.app/welcome%20screen/#' + urlHash;
                    window.location.href = welcomeScreenUrl;
                }
            }
        })();

        function openInlineRecoveryReset(accessToken) {
            let resetModal = document.getElementById('inlineRecoveryResetModal');
            if (!resetModal) {
                const newModal = document.createElement('div');
                newModal.className = 'modal';
                newModal.id = 'inlineRecoveryResetModal';
                newModal.innerHTML = `
                    <div class="modal-content">
                        <button class="modal-close" onclick="closeInlineRecoveryReset()">×</button>
                        <div class="modal-title">Update Password</div>
                        <div class="form-group">
                            <label>New Password</label>
                            <input type="password" id="inlineResetPassword" placeholder="••••••••" required minlength="6">
                        </div>
                        <div class="form-group">
                            <label>Confirm Password</label>
                            <input type="password" id="inlineResetPasswordConfirm" placeholder="••••••••" required minlength="6">
                        </div>
                        <div class="flex-gap" style="margin-top:12px;">
                            <button class="btn-success btn-small" id="inlineResetSubmit">Update</button>
                            <button class="btn-secondary btn-small" onclick="closeInlineRecoveryReset()">Cancel</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(newModal);
                resetModal = document.getElementById('inlineRecoveryResetModal');
            }
            resetModal.classList.add('show');

            const submitBtn = document.getElementById('inlineResetSubmit');
            submitBtn.onclick = async function () {
                const password = (document.getElementById('inlineResetPassword')?.value || '').trim();
                const confirm = (document.getElementById('inlineResetPasswordConfirm')?.value || '').trim();
                if (!password || !confirm) { showToast('Please fill in all fields', 'error'); return; }
                if (password !== confirm) { showToast('Passwords do not match', 'error'); return; }
                if (password.length < 6) { showToast('Password must be at least 6 characters', 'error'); return; }

                submitBtn.disabled = true; submitBtn.style.opacity = '0.7'; submitBtn.style.cursor = 'not-allowed';
                try {
                    const response = await fetch(`${SUPABASE_URL}/auth/v1/user`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${accessToken}`,
                            'apikey': SUPABASE_ANON_KEY,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ password })
                    });
                    const data = await response.json().catch(() => ({}));
                    if (!response.ok) {
                        const msg = (data && (data.error_description || data.message || data.error || data.msg)) || 'Password reset failed';
                        throw new Error(msg);
                    }
                    showToast('Password updated', 'success');
                    closeInlineRecoveryReset();
                    window.history.replaceState(null, '', window.location.pathname);
                } catch (error) {
                    console.error('Password reset error:', error);
                    showToast(error.message || 'Failed to reset password. Please try again.', 'error');
                } finally {
                    submitBtn.disabled = false; submitBtn.style.opacity = '1'; submitBtn.style.cursor = 'pointer';
                }
            };
        }

        function closeInlineRecoveryReset() {
            const resetModal = document.getElementById('inlineRecoveryResetModal');
            if (resetModal) {
                resetModal.classList.remove('show');
            }
        }
        function openInstalledPwaHelpModal(){
            const m = document.getElementById('installedPwaHelpModal');
            if (m) m.classList.add('show');
            try { window.__updateModalOverflow && window.__updateModalOverflow(); } catch {}
        }
        function closeInstalledPwaHelpModal(){
            const m = document.getElementById('installedPwaHelpModal');
            if (m) m.classList.remove('show');
            try { window.__updateModalOverflow && window.__updateModalOverflow(); } catch {}
        }

        (function(){
            try {
                const k = 'tuba_pwa_installed';
                const standalone = (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches) || (typeof navigator !== 'undefined' && navigator.standalone === true);
                if (standalone) { try { localStorage.setItem(k, '1'); } catch {} }
                function updateInstalledPrompt(){
                    try {
                        const el = document.getElementById('installedPwaBanner');
                        if (!el) return;
                        const online = navigator.onLine;
                        const isStandalone = (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches) || (navigator.standalone === true);
                        if (!online || isStandalone) { el.style.display='none'; el.textContent=''; el.onclick=null; return; }
                        let installed = false;
                        if (navigator.getInstalledRelatedApps) {
                            navigator.getInstalledRelatedApps().then(list => {
                                installed = Array.isArray(list) && list.length > 0;
                                finalize(installed);
                            }).catch(()=>finalize(false));
                            return;
                        }
                        try { installed = localStorage.getItem(k) === '1'; } catch {}
                        finalize(installed);
                function finalize(ok){
                            if (!ok) { el.style.display='none'; el.textContent=''; el.onclick=null; return; }
                            const isIOS = (typeof isIOSSafari === 'function' && isIOSSafari());
                            el.innerHTML = isIOS
                                ? 'Installed on Home Screen — tap for instructions to open it.'
                                : 'Open installed app — tap to switch to the installed version.';
                            el.style.display = 'block';
                            el.onclick = function(){
                                try {
                                    if (isIOS) {
                                        openInstalledPwaHelpModal();
                                    } else {
                                        window.location.href = 'web+tuba://open';
                                    }
                                } catch {}
                            };
                        }
                    } catch {}
                }
                window.updateInstalledPwaBanner = updateInstalledPrompt;
                updateInstalledPrompt();
                window.addEventListener('online', updateInstalledPrompt);
                window.addEventListener('offline', updateInstalledPrompt);
            } catch {}
        })();

        function openCloudDiagnosticsModal() {
            const m = document.getElementById('cloudDiagnosticsModal');
            if (m) { m.classList.add('show'); }
            const c = document.getElementById('cloudDiagnosticsContent');
            if (c) { c.innerHTML = 'Running…'; }
            runCloudDiagnostics();
        }

        function closeCloudDiagnosticsModal() {
            const m = document.getElementById('cloudDiagnosticsModal');
            if (m) { m.classList.remove('show'); }
        }

        function openContactDeveloperModal() {
            const m = document.getElementById('contactDeveloperModal');
            if (m) {
                const d = window.DEV_CONTACT || {};
                const container = document.getElementById('contactDeveloperDetails');
                if (container) {
                    const phone = String(d.phone || '').trim();
                    const wa = String(d.whatsapp || '').replace(/\D+/g,'');
                    const email = String(d.email || '').trim();
                    const waUrl = wa ? ('https://wa.me/' + wa) : '';
                    container.innerHTML = `
                        <div>Thank you for using TUBA. We appreciate your support.</div>
                        <div style="margin-top:8px;">
                            <div>Phone: ${phone ? `<a href="tel:${phone}">${phone}</a>` : ''}</div>
                            <div>WhatsApp: ${wa ? `<a href="${waUrl}" target="_blank" rel="noopener">${wa}</a>` : ''}</div>
                            <div>Email: ${email ? `<a href="mailto:${email}">${email}</a>` : ''}</div>
                        </div>
                    `;
                }
                m.classList.add('show');
            }
        }
        function closeContactDeveloperModal() {
            const m = document.getElementById('contactDeveloperModal');
            if (m) { m.classList.remove('show'); }
        }
        function applyDevContactToPaywall() {
            try {
                const d = window.DEV_CONTACT || {};
                const emailEl = document.getElementById('paywallAdminEmailLink');
                const phoneEl = document.getElementById('paywallAdminPhoneLink');
                const waEl = document.getElementById('paywallAdminWhatsAppLink');
                if (emailEl && d.email) { emailEl.textContent = d.email; emailEl.href = 'mailto:' + d.email; }
                if (phoneEl && d.phone) { phoneEl.textContent = d.phone; phoneEl.href = 'tel:' + d.phone; }
                if (waEl && d.whatsapp) {
                    const wa = String(d.whatsapp).replace(/\D+/g,'');
                    waEl.textContent = d.whatsapp;
                    waEl.href = 'https://wa.me/' + wa;
                }
            } catch {}
        }
        window.addEventListener('load', function(){ applyDevContactToPaywall(); });
        function openPrivacyPolicyModal() {
            const m = document.getElementById('privacyPolicyModal');
            if (m) { m.classList.add('show'); }
        }
        function closePrivacyPolicyModal() {
            const m = document.getElementById('privacyPolicyModal');
            if (m) { m.classList.remove('show'); }
        }

        async function runCloudDiagnostics() {
            const out = [];
            window.lastDiagnosticErrors = []; // Track tables with actual errors
            if (!supabase || !syncEnabled || !currentUser) {
                out.push('<div class="alert-box-danger">Not signed in</div>');
                const c = document.getElementById('cloudDiagnosticsContent');
                if (c) c.innerHTML = out.join('');
                return;
            }
            let report = null;
            try {
                const { data, error } = await supabase.rpc('rls_health_report');
                if (!error && Array.isArray(data)) report = data;
            } catch { }
            if (report && report.length) {
                window.lastHealthReport = report;
                for (const r of report) {
                    const ok = (r.has_select && r.grant_select && r.has_insert && r.grant_insert && r.has_update && r.grant_update && r.has_delete && r.grant_delete);
                    if (!ok) window.lastDiagnosticErrors.push(r.tablename);
                    out.push(`<div class="item"><div class="item-header"><span class="item-title">${r.tablename}</span><span class="badge ${ok ? 'badge-success' : 'badge-danger'}">${ok ? 'Sync ok' : 'Needs attention'}</span></div><div class="item-subtitle">Select:${r.has_select ? 'yes' : 'no'} Grant:${r.grant_select ? 'yes' : 'no'} Insert:${r.has_insert ? 'yes' : 'no'} Update:${r.has_update ? 'yes' : 'no'} Delete:${r.has_delete ? 'yes' : 'no'}</div></div>`);
                }
            } else {
                const tbls = [
                    'products', 'categories', 'sales', 'expenses', 'income', 'customers', 'transactions', 'unpaid_entries', 'notes',
                    'inventory', 'inventory_purchases', 'inventory_purchase_periods', 'receipts', 'invoices', 'settings', 'assets',
                    'maintenance', 'audit_logs', 'transaction_floats'
                ];
                for (const t of tbls) {
                    try {
                        const { error } = await supabase.from(t).select('*').eq('user_id', currentUser.id).limit(1);
                        if (error) {
                            window.lastDiagnosticErrors.push(t);
                            out.push(`<div class="item"><div class="item-header"><span class="item-title">${t}</span><span class="badge-danger">Select error</span></div><div class="item-subtitle">${error.message || 'Error'}</div></div>`);
                        } else {
                            out.push(`<div class="item"><div class="item-header"><span class="item-title">${t}</span><span class="badge-success">Select ok</span></div><div class="item-subtitle">Policy allows select</div></div>`);
                        }
                    } catch (e) {
                        window.lastDiagnosticErrors.push(t);
                        out.push(`<div class="item"><div class="item-header"><span class="item-title">${t}</span><span class="badge-danger">Select error</span></div><div class="item-subtitle">${e.message || 'Error'}</div></div>`);
                    }
                }
            }
            try {
                await upsertOne('client_errors', { timestamp: Date.now(), message: 'diagnostics', context: 'cloud' });
                out.unshift('<div class="alert-success">Insert test ok</div>');
            } catch (e) {
                out.unshift(`<div class="alert-box-danger">Insert test failed: ${e.message || 'Error'}</div>`);
            }
            const c = document.getElementById('cloudDiagnosticsContent');
            if (c) c.innerHTML = out.join('');
            const fx = document.getElementById('cloudFixSql');
            if (fx) { fx.style.display = 'none'; fx.textContent = ''; }
        }

        function openUnpaidSalesModal() {
            const unpaid = (state.sales || []).filter(s => String(s.status || '').toLowerCase() === 'unpaid');
            if (!unpaid.length) { showToast('No unpaid sales', 'info'); return; }
            const content = unpaid.map(s => `
                <div class="item" onclick="openSaleDetailModal(${s.timestamp})" style="cursor:pointer;">
                    <div class="item-header">
                        <span class="item-title">${s.productName}</span>
                        <span class="badge badge-warning">Unpaid</span>
                    </div>
                    <div class="item-subtitle">${s.date} ${s.time}<br>${s.customer} | Qty: ${s.quantity} | ${s.payment}<br>Cost: ${formatNumber(s.totalCost)} | Price: ${formatNumber(s.totalPrice)}</div>
                    <div class="flex-gap" style="margin-top:8px;">
                        <button class="btn-small" onclick="event.stopPropagation(); openSaleDetailModal(${s.timestamp});">Open</button>
                        <button class="btn-small btn-success" onclick="event.stopPropagation(); markPaidSale(${s.timestamp})">Mark Paid</button>
                        <button class="btn-small btn-danger" onclick="event.stopPropagation(); deleteSaleByTimestamp(${s.timestamp})">Delete</button>
                    </div>
                </div>
            `).join('');
            const c = document.getElementById('unpaidSalesContent');
            if (c) c.innerHTML = content;
            const m = document.getElementById('unpaidSalesModal');
            if (m) m.classList.add('show');
        }

        function closeUnpaidSalesModal() {
            const m = document.getElementById('unpaidSalesModal');
            if (m) m.classList.remove('show');
        }

        function openAvailableCapitalModal() {
            const stats = getStats();
            const paidSalesRevenue = Number(stats.totalRevenue || 0);
            const totalIncome = Number(stats.totalIncome || 0);
            const loanInBusiness = Number(stats.loanInBusiness || 0);
            const loanOutBusiness = Number(stats.loanOutBusiness || 0);
            const expensesForCapital = Number(stats.expensesForCapital || 0);
            const stockInventorySpend = Number(stats.inventorySpendTotal || 0);
            const maintenanceBusinessTotal = Number(stats.maintenanceBusinessTotal || 0);
            const assetsBusinessTotal = Number(stats.assetsBusinessTotal || 0);
            const content = `
                <div class="flex-gap" style="margin-bottom:8px;">
                    <button class="btn-small" onclick="setAvailableCapitalFilter('today')" style="${(window.availableCapitalFilterRange||'all')==='today' ? 'font-weight:700;' : ''}">Today</button>
                    <button class="btn-small" onclick="setAvailableCapitalFilter('month')" style="${(window.availableCapitalFilterRange||'all')==='month' ? 'font-weight:700;' : ''}">This Month</button>
                    <button class="btn-small btn-secondary" onclick="setAvailableCapitalFilter('all')" style="${(window.availableCapitalFilterRange||'all')==='all' ? 'font-weight:700;' : ''}">All Time</button>
                </div>
                <div class="card" style="padding:8px; margin-bottom:8px;">
                    <div class="stat-label" style="font-size: 11px;">Money In</div>
                    <div class="item">
                        <div class="item-header">
                            <span class="item-title">Sales Revenue</span>
                            <span class="money-text">${formatNumber(paidSalesRevenue)} Tsh</span>
                        </div>
                        <div class="period-actions">
                            <button class="btn-small" onclick="navigateFromCapitalModal('sales')">View</button>
                        </div>
                    </div>
                    <div class="item">
                        <div class="item-header">
                            <span class="item-title">Income</span>
                            <span class="money-text">${formatNumber(totalIncome)} Tsh</span>
                        </div>
                        <div class="period-actions">
                            <button class="btn-small" onclick="navigateFromCapitalModal('income')">View</button>
                        </div>
                    </div>
                    <div class="item">
                        <div class="item-header">
                            <span class="item-title">Loan In Business</span>
                            <span class="money-text">${formatNumber(loanInBusiness)} Tsh</span>
                        </div>
                    </div>
                    <div class="item-subtitle">Total In: <span class="money-text">${formatNumber(paidSalesRevenue + totalIncome + loanInBusiness)} Tsh</span></div>
                </div>
                <div class="card" style="padding:8px; margin-bottom:8px;">
                    <div class="stat-label" style="font-size: 11px;">Money Out</div>
                    <div class="item">
                        <div class="item-header">
                            <span class="item-title">Expenses</span>
                            <span class="money-text">${formatNumber(expensesForCapital)} Tsh</span>
                        </div>
                        <div class="period-actions">
                            <button class="btn-small" onclick="navigateFromCapitalModal('expenses')">View</button>
                        </div>
                    </div>
                    <div class="item">
                        <div class="item-header">
                            <span class="item-title">Loan Out of Business</span>
                            <span class="money-text">${formatNumber(loanOutBusiness)} Tsh</span>
                        </div>
                    </div>
                    <div class="item">
                        <div class="item-header">
                            <span class="item-title">Stock Inventory</span>
                            <span class="money-text">${formatNumber(stockInventorySpend)} Tsh</span>
                        </div>
                        <div class="period-actions">
                            <button class="btn-small" onclick="navigateFromCapitalModal('inventoryPurchases')">View</button>
                        </div>
                    </div>
                    <div class="item">
                        <div class="item-header">
                            <span class="item-title">Maintenance (Business)</span>
                            <span class="money-text">${formatNumber(maintenanceBusinessTotal)} Tsh</span>
                        </div>
                        <div class="period-actions">
                            <button class="btn-small" onclick="navigateFromCapitalModal('maintenance')">View</button>
                        </div>
                    </div>
                    <div class="item">
                        <div class="item-header">
                            <span class="item-title">Assets (Business)</span>
                            <span class="money-text">${formatNumber(assetsBusinessTotal)} Tsh</span>
                        </div>
                        <div class="period-actions">
                            <button class="btn-small" onclick="navigateFromCapitalModal('assets')">View</button>
                        </div>
                    </div>
                    <div class="item-subtitle">Total Out: <span class="money-text">${formatNumber(expensesForCapital + loanOutBusiness + stockInventorySpend + maintenanceBusinessTotal + assetsBusinessTotal)} Tsh</span></div>
                </div>
                <div class="card" style="padding:8px;">
                    <div class="stat-label" style="font-size: 11px;">Available Capital</div>
                    <div class="stat-value" style="font-size: 16px;"><span class="money-text"> ${formatNumber(stats.availableCapital || 0)} Tsh</span></div>
                </div>
            `;
            const c = document.getElementById('availableCapitalContent');
            if (c) c.innerHTML = content;
            const m = document.getElementById('availableCapitalModal');
            if (m) m.classList.add('show');
            setAvailableCapitalFilter(window.availableCapitalFilterRange || 'all');
        }

        function setAvailableCapitalFilter(range) {
            window.availableCapitalFilterRange = range;
            const stats = getStats();
            const todayStr = (typeof getTodayDateString === 'function') ? getTodayDateString() : (new Date().toISOString().slice(0,10));
            const now = new Date();
            const ms = new Date(now.getFullYear(), now.getMonth(), 1);
            const monthStartStr = `${ms.getFullYear()}-${String(ms.getMonth() + 1).padStart(2, '0')}-${String(ms.getDate()).padStart(2, '0')}`;
            function inMonth(d) { try { return new Date(d) >= new Date(monthStartStr); } catch { return false; } }
            function compute() {
                let sales = (state.sales || []).filter(s => s.status !== 'unpaid');
                let income = (state.income || []);
                let expenses = (state.expenses || []);
                let loans = (state.loans || []);
                let purchases = (state.inventoryPurchases || []);
                let maintenance = (state.maintenance || []);
                let assets = (state.assets || []);
                if (range === 'today') {
                    sales = sales.filter(s => s.date === todayStr);
                    income = income.filter(i => i.date === todayStr);
                    expenses = expenses.filter(e => e.date === todayStr);
                    loans = loans.filter(l => String(l.date || '').slice(0,10) === todayStr);
                    purchases = purchases.filter(p => String(p.purchaseDate || p.date || '').slice(0,10) === todayStr);
                    maintenance = maintenance.filter(m => String(m.date || '').slice(0,10) === todayStr);
                    assets = assets.filter(a => String(a.purchaseDate || a.date || '').slice(0,10) === todayStr);
                } else if (range === 'month') {
                    sales = sales.filter(s => inMonth(s.date));
                    income = income.filter(i => inMonth(i.date));
                    expenses = expenses.filter(e => inMonth(e.date));
                    loans = loans.filter(l => inMonth(l.date));
                    purchases = purchases.filter(p => inMonth(p.purchaseDate || p.date));
                    maintenance = maintenance.filter(m => inMonth(m.date));
                    assets = assets.filter(a => inMonth(a.purchaseDate || a.date));
                }
                const revenue = sales.reduce((sum, s) => sum + (Number(s.totalPrice) || 0), 0);
                const incomeAmt = income.reduce((sum, i) => sum + (Number(i.amount) || 0), 0);
                const expensesAmt = expenses.filter(e => {
                    const c = String(e.category || '').toLowerCase();
                    return c !== 'loan given' && c !== 'maintenance' && c !== 'asset purchase';
                }).reduce((sum, e) => sum + (Number(e.amount) || 0), 0);
                const loanInBusiness = loans.filter(l => String(l && l.type || '').toLowerCase() === 'taken').reduce((sum, l) => sum + (Number(l && l.amount || 0)), 0);
                const loanOutBusiness = loans.filter(l => String(l && l.type || '').toLowerCase() === 'given' && String((l && (l.moneySource || l.money_source) || '')).toLowerCase() === 'business').reduce((sum, l) => sum + (Number(l && l.amount || 0)), 0);
                const invSpend = purchases.filter(p => !p.planned).reduce((sum, p) => sum + (Number(p.totalCost) || Number(p.buyingPrice) || 0), 0);
                const maintBusiness = maintenance.filter(m => String((m.moneySource || m.money_source || 'business')).toLowerCase() === 'business').reduce((sum, m) => sum + (Number(m.amount) || 0), 0);
                const assetsBusiness = assets.filter(a => String((a.moneySource || a.money_source || 'business')).toLowerCase() === 'business').reduce((sum, a) => sum + (Number(a.cost) || 0), 0);
                const available = revenue + incomeAmt + loanInBusiness - expensesAmt - loanOutBusiness - invSpend - maintBusiness - assetsBusiness;
                return { revenue, incomeAmt, expensesAmt, loanInBusiness, loanOutBusiness, invSpend, maintBusiness, assetsBusiness, available };
            }
            const val = compute();
            const c = document.getElementById('availableCapitalContent');
            if (c) {
                c.innerHTML = `
                <div class="flex-gap" style="margin-bottom:8px;">
                    <button class="btn-small" onclick="setAvailableCapitalFilter('today')" style="${(window.availableCapitalFilterRange||'all')==='today' ? 'font-weight:700;' : ''}">Today</button>
                    <button class="btn-small" onclick="setAvailableCapitalFilter('month')" style="${(window.availableCapitalFilterRange||'all')==='month' ? 'font-weight:700;' : ''}">This Month</button>
                    <button class="btn-small btn-secondary" onclick="setAvailableCapitalFilter('all')" style="${(window.availableCapitalFilterRange||'all')==='all' ? 'font-weight:700;' : ''}">All Time</button>
                </div>
                <div class="card" style="padding:8px; margin-bottom:8px;">
                    <div class="stat-label" style="font-size: 11px;">Money In</div>
                    <div class="item">
                        <div class="item-header">
                            <span class="item-title">Sales Revenue</span>
                            <span class="money-text">${formatNumber(val.revenue)} Tsh</span>
                        </div>
                        <div class="period-actions">
                            <button class="btn-small" onclick="navigateFromCapitalModal('sales')">View</button>
                        </div>
                    </div>
                    <div class="item">
                        <div class="item-header">
                            <span class="item-title">Income</span>
                            <span class="money-text">${formatNumber(val.incomeAmt)} Tsh</span>
                        </div>
                        <div class="period-actions">
                            <button class="btn-small" onclick="navigateFromCapitalModal('income')">View</button>
                        </div>
                    </div>
                    <div class="item">
                        <div class="item-header">
                            <span class="item-title">Loan In Business</span>
                            <span class="money-text">${formatNumber(val.loanInBusiness)} Tsh</span>
                        </div>
                    </div>
                    <div class="item-subtitle">Total In: <span class="money-text">${formatNumber(val.revenue + val.incomeAmt + val.loanInBusiness)} Tsh</span></div>
                </div>
                <div class="card" style="padding:8px; margin-bottom:8px;">
                    <div class="stat-label" style="font-size: 11px;">Money Out</div>
                    <div class="item">
                        <div class="item-header">
                            <span class="item-title">Expenses</span>
                            <span class="money-text">${formatNumber(val.expensesAmt)} Tsh</span>
                        </div>
                        <div class="period-actions">
                            <button class="btn-small" onclick="navigateFromCapitalModal('expenses')">View</button>
                        </div>
                    </div>
                    <div class="item">
                        <div class="item-header">
                            <span class="item-title">Loan Out of Business</span>
                            <span class="money-text">${formatNumber(val.loanOutBusiness)} Tsh</span>
                        </div>
                    </div>
                    <div class="item">
                        <div class="item-header">
                            <span class="item-title">Stock Inventory</span>
                            <span class="money-text">${formatNumber(val.invSpend)} Tsh</span>
                        </div>
                        <div class="period-actions">
                            <button class="btn-small" onclick="navigateFromCapitalModal('inventoryPurchases')">View</button>
                        </div>
                    </div>
                    <div class="item">
                        <div class="item-header">
                            <span class="item-title">Maintenance (Business)</span>
                            <span class="money-text">${formatNumber(val.maintBusiness)} Tsh</span>
                        </div>
                        <div class="period-actions">
                            <button class="btn-small" onclick="navigateFromCapitalModal('maintenance')">View</button>
                        </div>
                    </div>
                    <div class="item">
                        <div class="item-header">
                            <span class="item-title">Assets (Business)</span>
                            <span class="money-text">${formatNumber(val.assetsBusiness)} Tsh</span>
                        </div>
                        <div class="period-actions">
                            <button class="btn-small" onclick="navigateFromCapitalModal('assets')">View</button>
                        </div>
                    </div>
                    <div class="item-subtitle">Total Out: <span class="money-text">${formatNumber(val.expensesAmt + val.loanOutBusiness + val.invSpend + val.maintBusiness + val.assetsBusiness)} Tsh</span></div>
                </div>
                <div class="card" style="padding:8px;">
                    <div class="stat-label" style="font-size: 11px;">Available Capital</div>
                    <div class="stat-value" style="font-size: 16px;"><span class="money-text"> ${formatNumber(val.available)} Tsh</span></div>
                </div>
                `;
            }
        }

        function navigateFromCapitalModal(section) {
            closeAvailableCapitalModal();
            switchTab(section);
            showCapitalReturnFab();
        }

        function showCapitalReturnFab() {
            const fab = document.getElementById('capitalReturnFab');
            if (fab) {
                fab.style.display = 'flex';
                try { positionCapitalReturnFab(); } catch {}
            }
        }

        function hideCapitalReturnFab() {
            const fab = document.getElementById('capitalReturnFab');
            if (fab) fab.style.display = 'none';
        }

        function closeAvailableCapitalModal() {
            const m = document.getElementById('availableCapitalModal');
            if (m) m.classList.remove('show');
            hideCapitalReturnFab();
        }

        function positionCapitalReturnFab() {
            const fab = document.getElementById('capitalReturnFab');
            const header = document.querySelector('.header');
            if (!fab) return;
            let top = 72;
            try {
                if (header) {
                    const rect = header.getBoundingClientRect();
                    top = Math.max(64, Math.round((rect?.height || 64)) + 8);
                }
            } catch {}
            fab.style.top = top + 'px';
            fab.style.right = '16px';
        }
        try { window.addEventListener('resize', positionCapitalReturnFab); } catch {}

        function markPaidSale(ts) {
            const idx = (state.sales || []).findIndex(s => Number(s.timestamp) === Number(ts));
            if (idx === -1) return showToast('Sale not found', 'error');
            state.sales[idx].status = 'paid';
            saveData();
            render();
            showToast('Marked as paid', 'success');
            closeUnpaidSalesModal();
            refreshGlobalSearchIfOpen();
        }

        function buildPolicySqlForTable(t) {
            const lines = [];
            lines.push(`alter table public.${t} enable row level security;`);
            lines.push(`grant select, insert, update, delete on public.${t} to authenticated;`);
            lines.push(`drop policy if exists select_own_${t} on public.${t};`);
            lines.push(`drop policy if exists insert_own_${t} on public.${t};`);
            lines.push(`drop policy if exists update_own_${t} on public.${t};`);
            lines.push(`drop policy if exists delete_own_${t} on public.${t};`);
            lines.push(`create policy select_own_${t} on public.${t} for select to authenticated using (auth.uid() = user_id);`);
            lines.push(`create policy insert_own_${t} on public.${t} for insert to authenticated with check (auth.uid() = user_id);`);
            lines.push(`create policy update_own_${t} on public.${t} for update to authenticated using (auth.uid() = user_id) with check (auth.uid() = user_id);`);
            lines.push(`create policy delete_own_${t} on public.${t} for delete to authenticated using (auth.uid() = user_id);`);
            return lines.join('\n');
        }

        async function generateCloudFixSql(mode = 'targeted') {
            const allTables = [
                'products', 'categories', 'sales', 'expenses', 'income', 'customers', 'transactions', 'unpaid_entries', 'notes',
                'inventory', 'inventory_purchases', 'inventory_purchase_periods', 'receipts', 'invoices', 'settings', 'assets',
                'maintenance', 'audit_logs', 'transaction_floats'
            ];
            let target = [];

            if (mode === 'full') {
                target = allTables;
            } else {
                // Targeted mode: Only use tables that actually failed the last diagnostic check
                target = window.lastDiagnosticErrors || [];
                if (target.length === 0) {
                    return showToast('No errors detected to fix!', 'info');
                }
            }

            const sql = ['-- ' + (mode === 'full' ? 'FULL SCHEMA FIX' : 'TARGETED FIX (' + target.length + ' tables)'), 'begin;'].concat(target.map(t => buildPolicySqlForTable(t))).concat(['commit;']).join('\n\n');
            const fx = document.getElementById('cloudFixSql');
            if (fx) { fx.style.display = 'block'; fx.textContent = sql; }
            showToast(mode === 'full' ? 'Full Fix SQL generated' : 'Targeted Fix SQL generated for ' + target.length + ' tables', 'success');
        }

        function copyCloudFixSql() {
            const fx = document.getElementById('cloudFixSql');
            const txt = fx ? fx.textContent : '';
            if (txt) copyText(txt);
        }

        // Backend moved to app.js (Supabase config and session handlers)
        // ===============================
        // ID SANITIZATION & DEDUP HELPERS
        // ===============================
        function ensureItemIDs() {
            const lists = ['sales', 'products', 'income', 'customers', 'transactions', 'unpaidEntries', 'notes'];
            lists.forEach(listName => {
                if (!Array.isArray(state[listName])) return;
                state[listName] = state[listName].map(item => {
                    if (!item.id) item.id = generateID(listName);
                    return item;
                });
            });
        }

        function removeDuplicatesByID(arr) {
            const seen = new Set();
            const seenHashes = new Set();

            return arr.filter(item => {
                if (!item.id) return true;

                // Check for ID duplicates
                if (seen.has(item.id)) return false;

                // Check for content duplicates (same data, different IDs)
                const content = { ...item };
                delete content.id;
                delete content.created_at;
                delete content.updated_at;
                const contentHash = JSON.stringify(content);

                if (seenHashes.has(contentHash)) return false;

                seen.add(item.id);
                seenHashes.add(contentHash);
                return true;
            });
        }
        

        // Your existing code continues below...
        const SHOP_NAME = "";
        const SHOP_ADDRESS = "";
        const SHOP_PHONE = "";
        const SHOP_EMAIL = "";

        // ========================================
        // SUPABASE FUNCTIONS
        // ========================================

        

        

        function hasAnyLocalData() {
            try {
                const nonEmptyArrays = [
                    state.products,
                    state.sales,
                    state.expenses,
                    state.customers,
                    state.invoices,
                    state.receipts,
                    state.notes,
                    state.transactions,
                    state.unpaidEntries,
                    state.categories
                ].some(arr => Array.isArray(arr) && arr.length > 0);

                const hasInventory = state.inventory && Object.keys(state.inventory).length > 0;
                return nonEmptyArrays || hasInventory;
            } catch (e) {
                return false;
            }
        }

        async function maybeAutoPullCloudData() {
            if (!syncEnabled || !currentUser) return;
            if (autoCloudPullDone) return;

            const hasLocal = hasAnyLocalData();
            if (!hasLocal) {
                try {
                    await pullDataFromSupabase();
                } finally {
                    autoCloudPullDone = true;
                }
            }
        }

        async function loadUserProfile() {
            // First, check if we have local profile data
            const localProfile = state.userProfile;
            const hasLocalProfile = localProfile && localProfile.businessName && localProfile.phone && localProfile.address;

            if (!syncEnabled || !currentUser) {
                // Not signed in - use local profile if available
                if (!hasLocalProfile) {
                    // No local profile - set up for first-time entry
                    state.profileEditMode = true;
                    state.profileLoaded = false;
                } else {
                    // Has local profile
                    state.profileEditMode = false;
                    state.profileLoaded = true;
                }
                return;
            }

            // Signed in - check cloud profile
            try {
                const { data, error } = await supabase
                    .from('user_profiles')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .single();

                if (error && error.code !== 'PGRST116') {
                    console.error('Error loading profile:', error);
                    return;
                }

                if (data) {
                    // Cloud profile exists - use it
                    state.userProfile = {
                        businessName: data.business_name || "",
                        email: data.email || currentUser.email || "",
                        phone: data.phone || "",
                        address: data.address || "",
                        country: data.country || "",
                        city: data.city || "",
                        role: data.role || (state.userProfile && state.userProfile.role) || 'owner',
                        vatNumber: data.vat_number || (state.userProfile && state.userProfile.vatNumber) || ''
                    };
                    // Map TIN and BL-No (fallback to VAT for TIN)
                    state.userProfile.tinNumber = data.tin_number || state.userProfile.vatNumber || '';
                    state.userProfile.blNumber = data.business_license_number || state.userProfile.blNumber || '';
                    state.userProfile.hasVAT = (data.has_vat === true) || !!state.userProfile.vatNumber;
                    if (data.logo_data) {
                        state.userLogoDataUrl = data.logo_data;
                        state.userLogoMime = data.logo_mime || (String(data.logo_data).startsWith('data:image/png') ? 'image/png' : 'image/jpeg');
                    }
                    state.profileEditMode = false;
                    state.profileLoaded = true;
                    saveData();
                } else {
                    // No cloud profile
                    if (hasLocalProfile) {
                        // Has local profile - upload it to cloud
                        console.log('📤 Uploading local profile to cloud...');
                        await createProfileFromLocal();
                    } else {
                        // No profile at all - keep view mode
                        state.profileEditMode = false;
                        state.profileLoaded = true;
                        saveData();
                    }
                }
            } catch (error) {
                console.error('Load profile error:', error);
            }
        }

        async function createProfileFromLocal() {
            if (!syncEnabled || !currentUser) return;

            try {
                const { error } = await supabase
                    .from('user_profiles')
                    .insert({
                        user_id: currentUser.id,
                        business_name: state.userProfile.businessName,
                        email: state.userProfile.email || currentUser.email,
                        phone: state.userProfile.phone,
                        address: state.userProfile.address,
                        country: state.userProfile.country || null,
                        city: state.userProfile.city || null,
                        logo_data: state.userLogoDataUrl || null,
                        logo_mime: state.userLogoMime || null
                    });

                if (error) {
                    console.error('Error creating profile from local:', error);
                    return false;
                }

                console.log('✅ Local profile uploaded to cloud');
                state.profileLoaded = true;
                saveData();
                return true;
            } catch (error) {
                console.error('Create profile from local error:', error);
                return false;
            }
        }

        async function createDefaultProfile() {
            if (!syncEnabled || !currentUser) return;

            try {
                const { error } = await supabase
                    .from('user_profiles')
                    .insert({
                        user_id: currentUser.id,
                        business_name: state.userProfile.businessName,
                        email: currentUser.email,
                        phone: state.userProfile.phone,
                        address: state.userProfile.address,
                        country: state.userProfile.country || null,
                        city: state.userProfile.city || null
                    });

                if (error) {
                    console.error('Error creating profile:', error);
                }
            } catch (error) {
                console.error('Create profile error:', error);
            }
        }

        async function saveUserProfile(profileData) {
            // Always save locally first
            state.userProfile = { ...profileData };
            state.profileLoaded = true;
            saveData();

            // If signed in, also save to cloud
            if (syncEnabled && currentUser) {
                try {
                    updateSyncIndicator('syncing');

                    const { error } = await supabase
                        .from('user_profiles')
                        .upsert({
                            user_id: currentUser.id,
                            business_name: profileData.businessName,
                            email: profileData.email,
                            phone: profileData.phone,
                            address: profileData.address,
                            country: profileData.country || null,
                            city: profileData.city || null,
                            tin_number: profileData.tinNumber || null,
                            business_license_number: profileData.blNumber || null,
                            has_vat: profileData.hasVAT ? true : false,
                            vat_number: profileData.hasVAT ? (profileData.vatNumber || null) : null,
                            role: profileData.role || state.userProfile.role || 'owner',
                            logo_data: state.userLogoDataUrl || null,
                            logo_mime: state.userLogoMime || null,
                            updated_at: new Date().toISOString()
                        }, {
                            onConflict: 'user_id'
                        });

                    if (error) throw error;

                    // Verify cloud persistence
                    let verified = false;
                    try {
                        const { data: verifyData, error: verifyErr } = await supabase
                            .from('user_profiles')
                            .select('business_name,email,phone,address,country,city,logo_url,role,tin_number,business_license_number,has_vat,vat_number')
                            .eq('user_id', currentUser.id)
                            .single();
                        if (!verifyErr && verifyData) {
                            const v = verifyData;
                            verified = (
                                String(v.business_name || '') === profileData.businessName &&
                                String(v.email || '') === profileData.email &&
                                String(v.phone || '') === profileData.phone &&
                                String(v.address || '') === profileData.address &&
                                String(v.country || '') === (profileData.country || '') &&
                                String(v.city || '') === (profileData.city || '') &&
                                String(v.role || '') === (profileData.role || state.userProfile.role || 'owner')
                            );
                        }
                    } catch { }

                    updateSyncIndicator('synced');
                } catch (error) {
                    console.error('Save profile to cloud error:', error);
                    updateSyncIndicator('synced');
                }
            } else {
                console.log('✅ Profile saved locally');
            }

            return true;
        }

        function getUserProfileData() {
            return {
                businessName: state.userProfile?.businessName || "",
                email: state.userProfile?.email || currentUser?.email || "",
                phone: state.userProfile?.phone || "",
                address: state.userProfile?.address || "",
                country: state.userProfile?.country || "",
                city: state.userProfile?.city || "",
                role: state.userProfile?.role || 'owner',
                tinNumber: state.userProfile?.tinNumber || state.userProfile?.vatNumber || '',
                blNumber: state.userProfile?.blNumber || '',
                hasVAT: !!(state.userProfile?.hasVAT),
                vatNumber: state.userProfile?.vatNumber || ''
            };
        }
        function buildProfileContactLine(profile) {
            const parts = [profile.address, profile.phone, profile.email].map(v => String(v || '').trim()).filter(Boolean);
            return parts.join(' | ');
        }
        function buildProfileTaxLine(profile) {
            const parts = [];
            if (profile.tinNumber) parts.push(`TIN: ${profile.tinNumber}`);
            if (profile.blNumber) parts.push(`BL-No: ${profile.blNumber}`);
            if (profile.hasVAT && profile.vatNumber) parts.push(`VAT: ${profile.vatNumber}`);
            return parts.join(' | ');
        }

        const COUNTRY_CITY_DATA = {
            "Tanzania": ["Dar es Salaam", "Dodoma", "Arusha", "Mwanza"],
            "Kenya": ["Nairobi", "Mombasa", "Kisumu"],
            "Uganda": ["Kampala", "Entebbe", "Gulu"],
            "Rwanda": ["Kigali", "Butare", "Gisenyi"],
            "South Africa": ["Johannesburg", "Cape Town", "Durban", "Pretoria"],
            "United States": ["New York", "Los Angeles", "Chicago", "Houston"],
            "United Kingdom": ["London", "Manchester", "Birmingham"],
            "India": ["Mumbai", "Delhi", "Bengaluru", "Chennai"],
            "China": ["Beijing", "Shanghai", "Shenzhen", "Guangzhou"]
        };

        function getCountryOptionsHTML() {
            const src = new Set([...(Object.keys(COUNTRY_CITY_DATA || {})), ...Object.keys(state.countriesCities || {})]);
            return Array.from(src).sort((a, b) => String(a).localeCompare(String(b))).map(c => `<option value="${c}"></option>`).join("");
        }

        function getCityOptionsHTML(country) {
            const fromDynamic = (state.countriesCities && state.countriesCities[country]) ? state.countriesCities[country] : [];
            const fromStatic = COUNTRY_CITY_DATA[country] || [];
            const cities = fromDynamic.length ? fromDynamic : fromStatic;
            return cities.sort((a, b) => String(a).localeCompare(String(b))).map(city => `<option value="${city}"></option>`).join("");
        }

        function getCountryOptionsSelectHTML() {
            const src = new Set([...(Object.keys(COUNTRY_CITY_DATA || {})), ...Object.keys(state.countriesCities || {})]);
            return Array.from(src).sort((a, b) => String(a).localeCompare(String(b))).map(c => `<option value="${c}">${c}</option>`).join("");
        }

        function getCityOptionsSelectHTML(country) {
            const fromDynamic = (state.countriesCities && state.countriesCities[country]) ? state.countriesCities[country] : [];
            const fromStatic = COUNTRY_CITY_DATA[country] || [];
            const cities = fromDynamic.length ? fromDynamic : fromStatic;
            return cities.sort((a, b) => String(a).localeCompare(String(b))).map(city => `<option value="${city}">${city}</option>`).join("");
        }

        function onProfileCountrySelect(val) {
            const input = document.getElementById('profileCountry');
            const sel = document.getElementById('profileCountrySelect');
            const citySel = document.getElementById('profileCitySelect');
            const cityInput = document.getElementById('profileCity');
            if (!input || !sel) return;
            if (val === '__manual__') {
                input.style.display = 'block';
                input.value = '';
            } else {
                input.style.display = 'none';
                input.value = val;
            }
            if (citySel) {
                citySel.innerHTML = `<option value="">-- Select City --</option><option value="__manual__">Manual entry…</option>` + getCityOptionsSelectHTML(val);
                citySel.disabled = !state.profileEditMode;
                if (cityInput) { cityInput.style.display = 'none'; }
            }
        }

        function onProfileCitySelect(val) {
            const input = document.getElementById('profileCity');
            const sel = document.getElementById('profileCitySelect');
            if (!input || !sel) return;
            if (val === '__manual__' && state.profileEditMode) {
                input.style.display = 'block';
            } else {
                input.style.display = 'none';
                if (val !== '__manual__') input.value = val;
            }
        }

        async function initCountryCityData() {
            if (state.countriesCities) return;
            try {
                if (!navigator.onLine) return;
                const ac = new AbortController();
                const t = setTimeout(() => { try { ac.abort(); } catch { } }, 2500);
                const resp = await fetch('https://countriesnow.space/api/v0.1/countries', { signal: ac.signal });
                const json = await resp.json();
                if (json && json.data) {
                    const map = {};
                    json.data.forEach(item => { if (item.country) map[item.country] = item.cities || []; });
                    state.countriesCities = map;
                    saveData();
                }
                clearTimeout(t);
            } catch { }
        }

        function onProfileCountryChange(val) {
            try {
                const list = document.getElementById('profileCityList');
                if (list) list.innerHTML = getCityOptionsHTML(val);
                const cityInput = document.getElementById('profileCity');
                if (cityInput) cityInput.value = '';
            } catch { }
        }

        function updateSyncIndicator(status) {
            const indicator = document.getElementById('syncIndicator');
            if (!indicator) return;

            if (status === 'synced' && syncEnabled) {
                const upCount = (upsertQueue?.items || []).length;
                const delCount = (deleteQueue?.items || []).length;
                indicator.innerHTML = `Synced ☁️<br><span style="font-size:9px;opacity:0.9;">Click to 🔄</span><br><span style="font-size:9px;opacity:0.8;">Queued: ${upCount} ⬆︎ / ${delCount} ⬇︎</span>`;
                indicator.className = 'sync-indicator show clickable';
                indicator.setAttribute('title', 'Push all data to cloud');
                indicator.onclick = function () {
                    try {
                        pushToCloudSilent();
                        upsertQueue.process();
                        deleteQueue.process();
                    } catch (e) { /* no-op */ }
                };
            } else if (status === 'syncing') {
                indicator.textContent = '🔄 Syncing...';
                indicator.className = 'sync-indicator show syncing';
                indicator.removeAttribute('title');
                indicator.onclick = null;
            } else {
                indicator.className = 'sync-indicator';
                indicator.onclick = null;
            }
        }

        // Silent push-to-cloud for sync indicator click (no confirmation)
        async function pushToCloudSilent() {
            if (!syncEnabled || !currentUser) {
                return showToast('Not signed in', 'error');
            }

            updateSyncIndicator('syncing');
            try {
                await clearAndPushAllData();
                updateSyncIndicator('synced');
            } catch (error) {
                console.error('Push error:', error);
                updateSyncIndicator('synced');
                showToast('Sync failed: ' + error.message, 'error');
            }
        }

        async function signUp(email, password) {
            try {
                const { data, error } = await supabase.auth.signUp({ email, password, options: { emailRedirectTo: 'https://tubawelcomescreen.vercel.app/', data: { theme: 'dark' } } });
                if (error) throw error;
                showToast('Account created! Check your email to confirm.', 'success');
                return data;
            } catch (error) {
                showToast('Sign up error: ' + error.message, 'error');
                return null;
            }
        }

        async function signIn(email, password) {
            try {
                const { data, error } = await supabase.auth.signInWithPassword({ email, password });
                if (error) throw error;

                currentUser = data.user;
                syncEnabled = true;

                showToast('Signed in successfully!', 'success');
                try { clearAllSearchInputs(); } catch {}

                // Hide auth banner immediately after sign-in detected
                try { window.updateAuthBanner && window.updateAuthBanner(); } catch (e) { /* no-op */ }

                try {
                    state.activeTab = 'sales';
                    saveData();
                    if (typeof switchTab === 'function') switchTab('sales');
                } catch {}

                // Load user profile first
                await loadUserProfile();
                // Hydrate logo base64 for immediate UI/PDF usage
                try { await ensureLogoReady(); } catch (e) { /* no-op */ }

                // Upload logo if selected locally
                // if (state.userLogoDataUrl) {
                //     try { await uploadLogoToSupabase(state.userLogoDataUrl, state.userLogoMime || 'image/png'); } catch (e) { console.warn('Logo upload after sign-in failed:', e); }
                // }

                // Check if local data exists
                const localHasData = state.sales.length > 0 || state.products.length > 0;

                try {
                    if (localHasData) {
                        Promise.resolve().then(() => smartMergeData()).catch((syncError) => {
                            console.error('Sync error after sign in:', syncError);
                            showToast('Signed in but sync failed. Try manual sync.', 'error');
                        });
                    } else {
                        Promise.resolve().then(() => pullDataFromSupabase()).catch((syncError) => {
                            console.error('Sync error after sign in:', syncError);
                            showToast('Signed in but sync failed. Try manual sync.', 'error');
                        });
                    }
                } catch (syncError) {
                    console.error('Sync error after sign in:', syncError);
                    showToast('Signed in but sync failed. Try manual sync.', 'error');
                }

                return data;
            } catch (error) {
                console.error('Sign in error:', error);
                showToast('Sign in error: ' + error.message, 'error');
                currentUser = null;
                syncEnabled = false;
                return null;
            }
        }

        async function smartMergeData() {
            try {
                updateSyncIndicator('syncing');
                showToast('Loading Data...', 'info', null, null, 8000);
                console.log('🔄 Starting smart merge...');

                // Save local data BEFORE pulling from cloud
                const localData = {
                    sales: [...(state.sales || [])],
                    products: [...(state.products || [])],
                    expenses: [...(state.expenses || [])],
                    income: [...(state.income || [])],
                    customers: [...(state.customers || [])],
                    transactions: [...(state.transactions || [])],
                    unpaidEntries: [...(state.unpaidEntries || [])],
                    notes: [...(state.notes || [])],
                    loans: [...(state.loans || [])],
                    categories: [...(state.categories || [])]
                };

                console.log('📱 Local data counts:', {
                    sales: localData.sales.length,
                    products: localData.products.length,
                    expenses: localData.expenses.length,
                    income: (localData.income || []).length,
                    customers: localData.customers.length,
                    transactions: localData.transactions.length,
                    unpaidEntries: localData.unpaidEntries.length,
                    notes: localData.notes.length
                });

                // Fetch cloud data directly from Supabase (don't overwrite state yet)
                const cloudData = await fetchCloudDataDirect();

                console.log('☁️ Cloud data counts:', {
                    sales: cloudData.sales.length,
                    products: cloudData.products.length,
                    expenses: cloudData.expenses.length,
                    customers: cloudData.customers.length,
                    transactions: cloudData.transactions.length,
                    unpaidEntries: cloudData.unpaidEntries.length,
                    notes: cloudData.notes.length,
                    loans: (cloudData.loans || []).length
                });

                // Enhanced merge function with better duplicate detection
                const mergeByID = (local, cloud, dataType) => {
                    const idMap = new Map();
                    const seenHashes = new Set();

                    // Helper function to create content hash for duplicate detection
                    const createContentHash = (item) => {
                        const content = { ...item };
                        delete content.id;
                        delete content.created_at;
                        delete content.updated_at;
                        // Strip DB-only ownership/meta fields to compare local vs cloud consistently
                        delete content.user_id;
                        delete content.userId;
                        delete content.inserted_at;
                        delete content.deleted_at;
                        return JSON.stringify(content);
                    };

                    // Add cloud items first (they take priority for same IDs)
                    cloud.forEach(item => {
                        if (!item.id) item.id = generateID(dataType);
                        const contentHash = createContentHash(item);

                        idMap.set(item.id, item);
                        seenHashes.add(contentHash);
                    });

                    // Add local items only if ID doesn't exist AND content is unique
                    local.forEach(item => {
                        if (!item.id) item.id = generateID(dataType);
                        const contentHash = createContentHash(item);

                        // Only add if both ID and content are unique
                        if (!idMap.has(item.id) && !seenHashes.has(contentHash)) {
                            idMap.set(item.id, item);
                            seenHashes.add(contentHash);
                        }
                    });

                    return Array.from(idMap.values());
                };

                // Merge each array with proper data type identification
                state.sales = mergeByID(localData.sales, cloudData.sales, 'sales');
                state.products = mergeByID(localData.products, cloudData.products, 'products');
                state.expenses = mergeByID(localData.expenses, cloudData.expenses, 'expenses');
                state.income = mergeByID(localData.income || [], cloudData.income || [], 'income');
                state.customers = mergeByID(localData.customers, cloudData.customers, 'customers');
                state.transactions = mergeByID(localData.transactions, cloudData.transactions, 'transactions');
                state.unpaidEntries = mergeByID(localData.unpaidEntries, cloudData.unpaidEntries, 'unpaid');
                state.notes = mergeByID(localData.notes, cloudData.notes, 'notes');
                state.loans = mergeByID(localData.loans, cloudData.loans || [], 'loans');
                // Categories: merge by name (set uniqueness)
                state.categories = Array.from(new Set([...(localData.categories || []), ...((cloudData.categories) || [])]));
                state.categoryKinds = { ...(state.categoryKinds || {}), ...((cloudData.categoryKinds) || {}) };

                // Final pass: content-based deduplication per type
                state.sales = deduplicateByContent(state.sales, 'sales');
                state.products = deduplicateByContent(state.products, 'products');
                state.expenses = deduplicateByContent(state.expenses, 'expenses');
                state.income = deduplicateByContent(state.income, 'income');
                state.customers = deduplicateByContent(state.customers, 'customers');
                state.transactions = deduplicateByContent(state.transactions, 'transactions');
                state.unpaidEntries = deduplicateByContent(state.unpaidEntries, 'unpaid');
                state.notes = deduplicateByContent(state.notes, 'notes');
                state.loans = deduplicateByContent(state.loans, 'loans');

                console.log('🔀 Merged data counts:', {
                    sales: state.sales.length,
                    products: state.products.length,
                    expenses: state.expenses.length,
                    income: (state.income || []).length,
                    customers: state.customers.length,
                    transactions: state.transactions.length,
                    unpaidEntries: state.unpaidEntries.length,
                    notes: state.notes.length
                });

                // Save merged data locally
                try { ensureIDs(); } catch {}
                saveData();

                // Push merged data back to cloud (clear and push to avoid server-side duplicates)
                await clearAndPushAllData();
                updateSyncIndicator('synced');

                console.log('✅ Smart merge completed successfully');
            } catch (error) {
                console.error('Smart merge error:', error);
                updateSyncIndicator('synced');
                throw error;
            }
        }

        // Helper function to fetch cloud data without overwriting local state
        async function fetchCloudDataDirect() {
            if (!syncEnabled || !currentUser) return {
                sales: [], products: [], expenses: [], income: [], customers: [],
                transactions: [], unpaidEntries: [], notes: [], loans: []
            };

            try {
                const [
                    { data: products },
                    { data: sales },
                    { data: expenses },
                    { data: income },
                    { data: customers },
                    { data: transactions },
                    { data: unpaidEntries },
                    { data: notes },
                    { data: categories },
                    { data: loans },
                    { data: loanPayments }
                ] = await Promise.all([
                    supabase.from('products').select('*').eq('user_id', currentUser.id),
                    supabase.from('sales').select('*').eq('user_id', currentUser.id),
                    supabase.from('expenses').select('*').eq('user_id', currentUser.id),
                    supabase.from('income').select('*').eq('user_id', currentUser.id),
                    supabase.from('customers').select('*').eq('user_id', currentUser.id),
                    supabase.from('transactions').select('*').eq('user_id', currentUser.id),
                    supabase.from('unpaid_entries').select('*').eq('user_id', currentUser.id),
                    supabase.from('notes').select('*').eq('user_id', currentUser.id),
                    supabase.from('categories').select('name,kind').eq('user_id', currentUser.id),
                    supabase.from('loans').select('name,type,amount,date,notes,timestamp,money_source').eq('user_id', currentUser.id),
                    supabase.from('loan_payments').select('loan_timestamp,amount,date,timestamp,source,destination').eq('user_id', currentUser.id)
                ]);

                return {
                    sales: sales || [],
                    products: products || [],
                    expenses: expenses || [],
                    income: income || [],
                    customers: customers || [],
                    transactions: transactions || [],
                    unpaidEntries: unpaidEntries || [],
                    notes: notes || [],
                    categories: (categories || []).map(c => (c.name || '').trim()).filter(Boolean),
                    categoryKinds: (categories || []).reduce((acc, c) => { const nm=(c.name||'').trim(); if (nm && c.kind) acc[nm]=c.kind; return acc; }, {}),
                    loans: (() => {
                        const arr = (loans || []).map(l => ({ id: l.timestamp, timestamp: l.timestamp, name: l.name, type: l.type, amount: parseFloat(l.amount)||0, date: l.date, notes: l.notes || '', moneySource: l.money_source || null, payments: [] }));
                        const byTs = new Map(arr.map(l => [l.timestamp, l]));
                        (loanPayments || []).forEach(p => {
                            const host = byTs.get(p.loan_timestamp);
                            if (host) {
                                host.payments = host.payments || [];
                                host.payments.push({ amount: parseFloat(p.amount)||0, date: p.date, timestamp: p.timestamp, source: p.source || null, destination: p.destination || null });
                            }
                        });
                        return arr;
                    })()
                };
            } catch (error) {
                console.error('Error fetching cloud data:', error);
                return {
                    sales: [], products: [], expenses: [], income: [], customers: [],
                    transactions: [], unpaidEntries: [], notes: [], categories: [], loans: []
                };
            }
        }

        function getTypeFromItem(item) {
            if (item.productName) return 'sales';
            if (item.cost !== undefined && item.price !== undefined) return 'products';
            if (item.description && item.category) return 'expenses';
            if (item.email !== undefined) return 'customers';
            if (item.channel) return 'transactions';
            if (item.paid !== undefined) return 'unpaid';
            if (item.content) return 'notes';
            return 'unknown';
        }

        async function signOut() {
            playTapSound();
            hapticShort();
            try {
                // Set these first in case signOut fails
                currentUser = null;
                syncEnabled = false;
                try { window.__paywallInitialized = false; } catch {}
                updateSyncIndicator('offline');
                try { state.autoAuthDisabled = true; saveData(); } catch { }

                const { error } = await supabase.auth.signOut();
                if (error) {
                    console.error('Sign out error:', error);
                    // Still consider it signed out locally
                }

                showToast('Signed out successfully', 'info');
                try { window.updateAuthBanner && window.updateAuthBanner(); } catch (e) { /* no-op */ }
                render();
            } catch (error) {
                console.error('Sign out error:', error);
                showToast('Signed out (with errors)', 'info');
                try { window.updateAuthBanner && window.updateAuthBanner(); } catch (e) { /* no-op */ }
                render();
            }
        }
        async function pushAllDataToSupabase() { return window.pushAllDataToSupabase && window.pushAllDataToSupabase(); }

        async function syncAllData() {
            playTapSound();
            hapticShort();
            if (!syncEnabled || !currentUser) return;
            if (isSyncing) {
                console.log('Sync already in progress, skipping...');
                return;
            }

            isSyncing = true;
            updateSyncIndicator('syncing');

            try {
                console.log('🔄 Starting sync...');

                // Check if local data is essentially empty
                const localIsEmpty =
                    state.sales.length === 0 &&
                    state.products.length === 0 &&
                    state.expenses.length === 0;

                if (localIsEmpty) {
                    // Pull from cloud if local is empty
                    console.log('⬇️ Local data is empty, pulling from cloud...');
                    await pullDataFromSupabase();
                } else {
                    // Push local data to cloud
                    console.log('⬆️ Pushing local data to cloud...');
                    await clearAndPushAllData();
                }

                updateSyncIndicator('synced');
                console.log('✅ Sync complete');
                render();
            } catch (error) {
                console.error('❌ Sync error:', error);
                updateSyncIndicator('synced');
                showToast('Sync failed: ' + error.message, 'error');
            } finally {
                isSyncing = false;
            }
        }

        async function clearAndPushAllData() { return window.clearAndPushAllData && window.clearAndPushAllData(); }

        async function syncInBackground() { return window.syncInBackground && window.syncInBackground(); }

        async function pullDataFromSupabase() {
            return window.pullDataFromSupabase && window.pullDataFromSupabase();
            if (!syncEnabled || !currentUser) return;

            try {
                showToast('Loading Data...', 'info', null, null, 8000);
                console.log('📥 Pulling data from cloud (parallel)...');

                const uid = currentUser.id;
                const fetch = (table, cols) => supabase.from(table).select(cols).eq('user_id', uid);

                const [
                    productsRes,
                    salesRes,
                    categoriesRes,
                    expensesRes,
                    incomeRes,
                    customersRes,
                    invoicesRes,
                    receiptsRes,
                    inventoryRes,
                    notesRes,
                    assetsRes,
                    maintenanceRes,
                    transactionsRes,
                    unpaidRes,
                    floatsRes,
                    settingsRes,
                    periodsRes,
                    auditLogsRes,
                    purchasesRes,
                    tithingRes
                ] = await Promise.all([
                    fetch('products', 'name,category,cost,price,has_stock'),
                    supabase.from('sales').select('date,time,timestamp,product_name,customer,quantity,cost_per_unit,price_per_unit,total_cost,total_price,profit,payment,status').eq('user_id', uid).order('timestamp', { ascending: false }),
                    fetch('categories', 'name'),
                    fetch('expenses', 'id,date,time,timestamp,description,category,amount,payment,comment'),
                    fetch('income', 'date,time,timestamp,source,amount,payment,comment'),
                    fetch('customers', 'name,email,phone,address,total_purchases'),
                    fetch('invoices', 'number,customer,date,due_date,items,amount,status,subtotal,tax_rate,tax_amount,currency_code,currency_symbol'),
                    fetch('receipts', 'number,customer,customer_email,date,time,timestamp,description,amount,payment_method,currency_code,currency_symbol'),
                    fetch('inventory', 'product_name,stock,min_alert'),
                    fetch('notes', 'title,content,date,time,timestamp'),
                    fetch('assets', 'name,purchase_date,time,timestamp,cost,description'),
                    fetch('maintenance', 'asset_name,amount,date,time,timestamp,description'),
                    fetch('transactions', 'channel,customer_name,type,amount,date,time,timestamp'),
                    fetch('unpaid_entries', 'name,type,amount,date,time,timestamp,paid'),
                    fetch('transaction_floats', 'channel,initial_account_float,initial_cash_float'),
                    supabase.from('settings').select('daily_target,monthly_target,currency_code,currency_symbol,default_tax_rate,cogs_method,pin_hash,pin_updated_at').eq('user_id', uid).single(),
                    fetch('inventory_purchase_periods', 'period_number,title,start_date,end_date,notes'),
                    supabase.from('audit_logs').select('action,table_name,item_key,timestamp,created_at').eq('user_id', uid).order('timestamp', { ascending: false }).limit(50),
                    fetch('inventory_purchases', 'period_number,item_name,quantity,unit_cost,total_cost,purchase_date,supplier_name,supplier_phone,supplier_address,notes,timestamp'),
                    fetch('tithing', 'month_key,base,due,paid,history,updated_at')
                ]);

                const products = productsRes.data || [];
                if (products.length) {
                    const cloudProducts = products.map(p => ({
                        id: `P-${(p.name || '').toLowerCase().replace(/[^a-z0-9]+/g, '_')}`,
                        name: p.name,
                        category: p.category,
                        cost: parseFloat(p.cost),
                        price: parseFloat(p.price),
                        hasStock: (p.has_stock === false) ? false : true
                    }));
                    state.products = deduplicateByContent([...state.products, ...cloudProducts], 'products');
                }

                const sales = salesRes.data || [];
                if (sales.length) {
                    const cloudSales = sales.map(s => ({
                        id: `S-${s.timestamp}`,
                        date: s.date,
                        time: s.time,
                        timestamp: s.timestamp,
                        productName: s.product_name,
                        customer: s.customer,
                        quantity: s.quantity,
                        costPerUnit: parseFloat(s.cost_per_unit),
                        pricePerUnit: parseFloat(s.price_per_unit),
                        totalCost: parseFloat(s.total_cost),
                        totalPrice: parseFloat(s.total_price),
                        profit: parseFloat(s.profit),
                        payment: s.payment,
                        status: s.status || 'paid'
                    }));
                    state.sales = deduplicateByContent([...state.sales, ...cloudSales], 'sales');
                }

                const categories = categoriesRes.data || [];
                if (categories.length) {
                    const cloudCategories = categories.map(c => (c.name || '').trim()).filter(Boolean);
                    state.categories = Array.from(new Set([...(state.categories || []), ...cloudCategories]));
                }

                const expenses = expensesRes.data || [];
                if (expenses.length) {
                    const cloudExpenses = expenses.map(e => ({
                        id: e.id || `E-${e.timestamp}`,
                        date: e.date,
                        time: e.time,
                        timestamp: e.timestamp,
                        description: e.description,
                        category: e.category,
                        amount: parseFloat(e.amount),
                        payment: e.payment,
                        comment: e.comment
                    }));
                    state.expenses = deduplicateByContent([...state.expenses, ...cloudExpenses], 'expenses');
                }

                const income = incomeRes.data || [];
                if (income.length) {
                    const cloudIncome = income.map(i => ({
                        id: `INC-${i.timestamp}`,
                        date: i.date,
                        time: i.time,
                        timestamp: i.timestamp,
                        source: i.source,
                        amount: parseFloat(i.amount),
                        payment: i.payment,
                        comment: i.comment
                    }));
                    state.income = deduplicateByContent([...state.income, ...cloudIncome], 'income');
                }

                const customers = customersRes.data || [];
                if (customers.length) {
                    const cloudCustomers = customers.map(c => ({
                        id: `C-${c.name.replace(/\s+/g, '_')}_${Date.now()}`,
                        name: c.name,
                        email: c.email || '',
                        phone: c.phone || '',
                        address: c.address || '',
                        totalPurchases: parseFloat(c.total_purchases || 0)
                    }));
                    state.customers = deduplicateByContent([...state.customers, ...cloudCustomers], 'customers');
                }

                const invoices = invoicesRes.data || [];
                if (invoices.length) {
                    const cloudInvoices = invoices.map(i => ({
                        id: `INV-${i.number}`,
                        number: i.number,
                        customer: i.customer,
                        date: i.date,
                        dueDate: i.due_date,
                        items: i.items,
                        amount: parseFloat(i.amount),
                        status: i.status,
                        subtotal: parseFloat(i.subtotal || 0),
                        taxRate: parseFloat(i.tax_rate || 0),
                        taxAmount: parseFloat(i.tax_amount || 0),
                        currencyCode: i.currency_code || state.currencyCode,
                        currencySymbol: i.currency_symbol || state.currencySymbol
                    }));
                    state.invoices = deduplicateByContent([...(state.invoices || []), ...cloudInvoices], 'invoices');
                }

                const receipts = receiptsRes.data || [];
                if (receipts.length) {
                    const cloudReceipts = receipts.map(r => ({
                        id: `RCPT-${r.timestamp}`,
                        number: r.number,
                        customer: r.customer,
                        customerEmail: r.customer_email || '',
                        date: r.date,
                        time: r.time,
                        timestamp: r.timestamp,
                        description: r.description,
                        amount: parseFloat(r.amount),
                        paymentMethod: r.payment_method,
                        currencyCode: r.currency_code || state.currencyCode,
                        currencySymbol: r.currency_symbol || state.currencySymbol
                    }));
                    state.receipts = deduplicateByContent([...(state.receipts || []), ...cloudReceipts], 'receipts');
                }

                const inventory = inventoryRes.data || [];
                if (inventory.length) {
                    if (!state.inventory) state.inventory = {};
                    inventory.forEach(item => {
                        const name = item.product_name;
                        if (!(name in state.inventory)) {
                            state.inventory[name] = {
                                stock: parseInt(item.stock) || 0,
                                minAlert: parseInt(item.min_alert) || 5
                            };
                        } else {
                            const existing = state.inventory[name];
                            if (existing.stock == null) existing.stock = parseInt(item.stock) || 0;
                            if (existing.minAlert == null) existing.minAlert = parseInt(item.min_alert) || 5;
                        }
                    });
                }

                const notes = notesRes.data || [];
                if (notes.length) {
                    const cloudNotes = notes.map(n => ({
                        id: `N-${n.timestamp}`,
                        title: n.title || '',
                        content: n.content,
                        date: n.date,
                        time: n.time,
                        timestamp: n.timestamp
                    }));
                    state.notes = deduplicateByContent([...(state.notes || []), ...cloudNotes], 'notes');
                }

                const assetsCloud = assetsRes.data || [];
                if (assetsCloud.length) {
                    const cloudAssets = assetsCloud.map(a => ({
                        id: `AST-${a.timestamp}`,
                        name: a.name,
                        purchaseDate: a.purchase_date,
                        time: a.time || '',
                        timestamp: a.timestamp,
                        cost: parseFloat(a.cost || 0),
                        description: a.description || ''
                    }));
                    state.assets = deduplicateByContent([...(state.assets || []), ...cloudAssets], 'assets');
                }

                const maintenanceCloud = maintenanceRes.data || [];
                if (maintenanceCloud.length) {
                    const cloudMaint = maintenanceCloud.map(m => ({
                        id: `MTN-${m.timestamp}`,
                        assetName: m.asset_name,
                        amount: parseFloat(m.amount || 0),
                        date: m.date,
                        time: m.time || '',
                        description: m.description || '',
                        timestamp: m.timestamp
                    }));
                    state.maintenance = deduplicateByContent([...(state.maintenance || []), ...cloudMaint], 'maintenance');
                }

                const transactions = transactionsRes.data || [];
                if (transactions.length) {
                    const cloudTransactions = transactions.map(t => ({
                        id: `T-${t.timestamp}`,
                        channel: t.channel,
                        customerName: t.customer_name,
                        type: t.type,
                        amount: parseFloat(t.amount),
                        date: t.date,
                        time: t.time,
                        timestamp: t.timestamp
                    }));
                    state.transactions = deduplicateByContent([...(state.transactions || []), ...cloudTransactions], 'transactions');
                }

                const unpaidEntries = unpaidRes.data || [];
                if (unpaidEntries.length) {
                    const cloudUnpaid = unpaidEntries.map(u => ({
                        id: `U-${u.timestamp}`,
                        name: u.name,
                        type: u.type,
                        amount: parseFloat(u.amount),
                        date: u.date,
                        time: u.time,
                        timestamp: u.timestamp,
                        paid: u.paid
                    }));
                    state.unpaidEntries = deduplicateByContent([...(state.unpaidEntries || []), ...cloudUnpaid], 'unpaid');
                }

                const floats = floatsRes.data || [];
                if (floats.length) {
                    floats.forEach(f => {
                        const ch = f.channel;
                        if (state.transactionFloats[ch]) {
                            const acc = parseFloat(f.initial_account_float);
                            const cash = parseFloat(f.initial_cash_float);
                            state.transactionFloats[ch].initialAccount = isNaN(acc) ? 0 : acc;
                            state.transactionFloats[ch].initialCash = isNaN(cash) ? 0 : cash;
                            state.transactionFloats[ch].initial = state.transactionFloats[ch].initialAccount;
                        }
                    });
                }

                const settings = settingsRes.data || null;
                if (settings) {
                    state.dailyTarget = parseFloat(settings.daily_target || 0);
                    state.monthlyTarget = parseFloat(settings.monthly_target || 0);
                    state.currencyCode = String(settings.currency_code || state.currencyCode || 'TZS');
                    state.currencySymbol = String(settings.currency_symbol || state.currencySymbol || 'Tsh');
                    state.defaultTaxRate = (typeof settings.default_tax_rate === 'number') ? settings.default_tax_rate : parseFloat(settings.default_tax_rate || state.defaultTaxRate || 0);
                    state.cogsMethod = String(settings.cogs_method || state.cogsMethod || 'product_cost');
                    state.securityPinHash = settings.pin_hash || state.securityPinHash || null;
                    state.securityPinUpdatedAt = settings.pin_updated_at || state.securityPinUpdatedAt || null;
                }

                const cloudCycles = periodsRes.data || [];
                if (cloudCycles.length) {
                    const mapped = cloudCycles.map(c => ({
                        id: generateID('invCycle'),
                        number: c.period_number,
                        title: c.title || '',
                        startDate: c.start_date || '',
                        endDate: c.end_date || '',
                        notes: c.notes || ''
                    }));
                    const dedup = [];
                    const seen = new Set();
                    for (const cy of mapped) { const k = String(cy.number); if (!seen.has(k)) { seen.add(k); dedup.push(cy); } }
                    state.inventoryPurchaseCycles = dedup;
                }

                const cloudPurchases = purchasesRes.data || [];
                if (cloudPurchases.length) {
                    state.inventoryPurchases = cloudPurchases.map(p => ({
                        id: generateID('invPurchase'),
                        cycleNumber: p.period_number,
                        itemName: p.item_name,
                        quantity: parseInt(p.quantity || 0, 10),
                        unitCost: parseFloat(p.unit_cost || 0),
                        totalCost: parseFloat(p.total_cost || 0),
                        purchaseDate: p.purchase_date || '',
                        supplierName: p.supplier_name || '',
                        supplierPhone: p.supplier_phone || '',
                        supplierAddress: p.supplier_address || '',
                        notes: p.notes || '',
                        timestamp: p.timestamp
                    }));
                }
                const audits = auditLogsRes?.data || [];
                state.auditLogs = audits.map(a => ({
                    action: a.action,
                    table_name: a.table_name,
                    item_key: a.item_key || '',
                    timestamp: a.timestamp || 0,
                    created_at: a.created_at
                }));

                const tithingCloud = tithingRes?.data || [];
                if (tithingCloud.length) {
                    if (!state.tithingRecords) state.tithingRecords = {};
                    tithingCloud.forEach(r => {
                        const mk = r.month_key;
                        state.tithingRecords[mk] = {
                            monthKey: mk,
                            base: parseFloat(r.base || 0),
                            due: parseFloat(r.due || 0),
                            paid: parseFloat(r.paid || 0),
                            history: r.history || []
                        };
                    });
                }

                calculateFloatBalances();

                // Load tags from cloud
                try {
                    const { data: cloudTags, error: tagsError } = await supabase
                        .from('tags')
                        .select('tag_name,color')
                        .eq('user_id', currentUser.id);

                    if (!tagsError && cloudTags && cloudTags.length > 0) {
                        state.tags = cloudTags.map(t => t.tag_name);
                        state.tagColors = {};
                        cloudTags.forEach(t => {
                            state.tagColors[t.tag_name] = t.color || '#999999';
                        });
                    }
                } catch (e) {
                    console.warn('Error loading tags:', e);
                }

                // Load tags for items from cloud
                try {
                    const tables = ['sales', 'products', 'expenses', 'customers', 'notes', 'transactions', 'unpaid_entries', 'income'];
                    for (const table of tables) {
                        const { data: cloudItems, error } = await supabase
                            .from(table)
                            .select('*')
                            .eq('user_id', currentUser.id);

                        if (!error && cloudItems) {
                            const stateMap = {
                                'sales': state.sales,
                                'products': state.products,
                                'expenses': state.expenses,
                                'customers': state.customers,
                                'notes': state.notes,
                                'transactions': state.transactions,
                                'unpaid_entries': state.unpaidEntries,
                                'income': state.income
                            };

                            const stateArray = stateMap[table];
                            if (stateArray && Array.isArray(stateArray)) {
                                cloudItems.forEach(cloudItem => {
                                    if (cloudItem.tags) {
                                        const tagsStr = cloudItem.tags;
                                        const tagsArray = tagsStr ? tagsStr.split(',').filter(t => t.trim()) : [];

                                        // Find matching local item
                                        let localItem = null;
                                        if (table === 'products') {
                                            localItem = stateArray.find(item => item.name === cloudItem.name);
                                        } else {
                                            localItem = stateArray.find(item => item.timestamp === cloudItem.timestamp);
                                        }

                                        if (localItem) {
                                            localItem.tags = tagsArray;
                                        }
                                    }
                                });
                            }
                        }
                    }
                } catch (e) {
                    console.warn('Error loading item tags:', e);
                }

                saveData();
                render();
            } catch (error) {
                console.error('Pull error:', error);
            }
        }
        


        function auditBuildItemKey(table, src) {
            let k = '';
            switch (table) {
                case 'sales':
                case 'expenses':
                case 'notes':
                case 'transactions':
                case 'receipts':
                case 'unpaid_entries':
                case 'assets':
                case 'maintenance':
                    k = String(src.timestamp || '');
                    break;
                case 'invoices':
                    k = String(src.number || '');
                    break;
                case 'customers':
                    k = [String(src.name || ''), String(src.email || '')].join('|');
                    break;
                case 'products':
                    k = [String(src.name || ''), String(src.category || '')].join('|');
                    break;
                case 'categories':
                    k = typeof src === 'string' ? String(src) : String(src.name || src);
                    break;
                case 'inventory':
                    k = String(src.product_name || '');
                    break;
                case 'inventory_purchases':
                    k = String(src.timestamp || '');
                    break;
                case 'inventory_purchase_periods':
                    k = String(src.period_number || src.cycleNumber || src.number || '');
                    break;
                case 'settings':
                    k = 'settings';
                    break;
                default:
                    k = String(src.timestamp || '');
                    break;
            }
            return k;
        }

        

        

        function getRole() {
            const r = state?.userProfile?.role || 'owner';
            return r;
        }
        const ROLE_CAPABILITIES = {
            owner: { delete: true },
            manager: { delete: true },
            cashier: { delete: false }
        };
        
        
        function getCurrencySymbol() { return state.currencySymbol || 'Tsh'; }
        
        function applyRoleGatingToUI() {
            try {
                const role = getRole();
                const caps = ROLE_CAPABILITIES[role] || {};
                if (caps.delete) return;
                const buttons = document.querySelectorAll('.btn-delete, [data-action="delete"], .btn-danger');
                buttons.forEach(btn => {
                    const txt = String(btn.textContent || '').toLowerCase();
                    if (txt.includes('delete')) {
                        btn.disabled = true;
                        btn.style.opacity = '0.5';
                        btn.style.cursor = 'not-allowed';
                    }
                });
            } catch { }
        }
        
        function applyCurrencySymbols() {
            try {
                const s = getCurrencySymbol();
                const root = document.getElementById('app');
                if (!root || !s) return;
                // Prefer targeted nodes
                const moneyNodes = root.querySelectorAll('.money-text');
                if (moneyNodes.length > 0) {
                    moneyNodes.forEach(node => {
                        const t = String(node.textContent || '');
                        if (t.includes('Tsh')) node.textContent = t.replace(/Tsh/g, s);
                    });
                    return;
                }
                // Fallback: light scan limited to manageable size
                const walker = document.createTreeWalker(root, NodeFilter.SHOW_TEXT, null);
                const nodes = [];
                let count = 0;
                while (walker.nextNode() && count < 1200) { nodes.push(walker.currentNode); count++; }
                nodes.forEach(n => {
                    const v = n.nodeValue;
                    if (!v) return;
                    if (v.includes('Tsh')) { n.nodeValue = v.replace(/Tsh/g, s); }
                });
            } catch { }
        }

        

        try {
            window.addEventListener('error', function (e) {
                reportClientError('error', e.message, (e.filename ? (e.filename + ':' + e.lineno) : ''), (e.error && e.error.stack) ? e.error.stack : '');
            });
            window.addEventListener('unhandledrejection', function (e) {
                const r = e.reason;
                const msg = (r && r.message) ? r.message : String(r);
                const st = (r && r.stack) ? r.stack : '';
                reportClientError('unhandledrejection', msg, '', st);
            });
        } catch { }


        

        

        // ============================================
        // Offline Upsert Queue with Backoff
        // ============================================
        
        let state = {
            activeTab: 'sales',
            activeTransactionChannel: 'mpesa',
            dashboardPrivacyBlurred: true,
            products: [],
            loans: [],
            sales: [],
            expenses: [],
            income: [],
            commissions: [],
            incomeSources: ['Miscellaneous', 'Personal', 'Loan', 'Gift', 'Tip', 'Other'],
            expenseCategories: ['Rent', 'Utilities', 'Supplies', 'Salaries', 'Marketing', 'Transportation', 'Office Electricity bills', 'Waste disposal bills', 'Food Expenses', 'Miscellaneous', 'Machine Repair bills', 'Home rent'],
            customers: [],
            invoices: [],
            receipts: [],
            categories: [],
            categoryKinds: {},
            inventory: {},
            auditLogs: [],
            notes: [],
            transactions: [],
            unpaidEntries: [],
            assets: [],
            maintenance: [],
            currentNoteIndex: null,
            editingNoteIndex: null,
            editingAssetIndex: null,
            editingMaintenanceIndex: null,
            currencyCode: 'TZS',
            currencySymbol: 'Tsh',
            cogsMethod: 'product_cost',
            collapsedSections: {},
            listExpanded: {},
            selectedItems: {},
            navBusy: false,
            navDisabled: false,
            inlineEditCustomers: {},
            inlineEditProducts: {},
            inlineEditSales: {},
            inlineEditExpenses: {},
            inlineEditIncome: {},
            inlineEditTransactions: {},
            inlineEditCategories: {},
            inlineEditAssets: {},
            inlineEditMaintenance: {},
            tithingRecords: {},
            tithingMonth: (function () { const d = new Date(); return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`; })(),
            transactionFloats: {
                mpesa: { initialAccount: 0, currentAccount: 0, initialCash: 0, currentCash: 0 },
                crdb: { initialAccount: 0, currentAccount: 0, initialCash: 0, currentCash: 0 },
                nmb: { initialAccount: 0, currentAccount: 0, initialCash: 0, currentCash: 0 },
                airtel: { initialAccount: 0, currentAccount: 0, initialCash: 0, currentCash: 0 },
                halopesa: { initialAccount: 0, currentAccount: 0, initialCash: 0, currentCash: 0 },
                yas: { initialAccount: 0, currentAccount: 0, initialCash: 0, currentCash: 0 }
            },
            inventoryFilters: {
                PeriodNumber: '',
                supplier: '',
                dateFrom: '',
                dateTo: ''
            },
            searchPeriod: '',
            stockSearch: '',
            productSearch: '',
            categorySearch: '',
            customerSearch: '',
            filterDateFrom: '',
            filterDateTo: '',
            filterCategory: '',
            filterCustomer: '',
            invoiceSearch: '',
            invoiceFilter: 'all',
            customerSort: 'purchases_desc',
            dailyTarget: 0,
            monthlyTarget: 0,
            userProfile: {
                businessName: "",
                email: "",
                phone: "",
                address: "",
                country: "",
                city: ""
            },
            // User logo
            userLogoDataUrl: '',
            userLogoMime: '',
            userLogoPublicUrl: '',
            profileEditMode: false,
            profileLoaded: false,
            privacyBlurred: true,  // ADD THIS LINE
            // Daily backup reminder tracking
            backupReminder: { date: '', count: 0 }
            , soundEnabled: false
            , vibrationEnabled: false
            , pushPrefs: { morning: true, evening: true, backup: true, destructive: true }
            , theme: 'light'
            , autoAuthDisabled: false
            , bulkProductRows: []
            , bulkProductStatus: []
            , bulkCategoryRows: []
            , bulkCategoryStatus: []
            // ========== TAGGING SYSTEM ==========
            , tags: [] // Global tag library
            , tagFilters: {} // Per-section tag filters
            , tagColors: {} // Tag name -> color mapping
            , showSalesHistory: false
            , inlineLoanEdit: {}
        };

        window.state = state;
        let chartInstance = null;
        let cachedStats = null;
        let lastStatsUpdate = 0;
        let renderTimer = null;
        let isSyncing = false;
        window.__devToolsEnabled = false;
        window.__bootSilenceToasts = true;
        try { setTimeout(() => { window.__bootSilenceToasts = false; }, 9000); } catch {}
        let idCounters = {              // ADD THIS ENTIRE OBJECT
            sales: 0,
            products: 0,
            expenses: 0,
            customers: 0,
            invoices: 0,
            categories: 0,
            notes: 0,
            transactions: 0,
            unpaid: 0
        };

        function getTodayDateString() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`; // Returns: 2025-01-15
        }

        // Show a backup reminder up to 3 times per day
        function maybeShowBackupReminder() {
            try {
                const today = getTodayDateString();
                if (!state.backupReminder || state.backupReminder.date !== today) {
                    state.backupReminder = { date: today, count: 0 };
                }
                if ((state.backupReminder.count || 0) < 3) {
                    setTimeout(() => {
                        showToast('Consider Local Backup', 'info', null, null, 3000);
                    }, 600);
                    state.backupReminder.count = (state.backupReminder.count || 0) + 1;
                    saveData();
                }
            } catch (e) { /* no-op */ }
        }

        // ID Generation Functions
        function generateID(type) {
            const prefix = ({
                sales: 'S',
                products: 'P',
                customers: 'C',
                transactions: 'T',
                unpaid: 'U',
                notes: 'N',
                categories: 'CAT',
                invoices: 'INV',
                expenses: 'E',
                income: 'I',
                invCycle: 'CYC',
                invPurchase: 'PUR'
            })[type] || 'X';

            let maxId = 0;
            const items = type === 'unpaid' ? (state.unpaidEntries || []) : ((state[type] || []));

            items.forEach(item => {
                const idStr = String(item && item.id != null ? item.id : '');
                if (idStr.startsWith(prefix + '-')) {
                    const parts = idStr.split('-');
                    const num = parseInt(parts[1], 10);
                    if (!isNaN(num) && num > maxId) maxId = num;
                }
            });

            return `${prefix}-${String(maxId + 1).padStart(6, '0')}`;
        }

        function ensureIDs() {
            state.sales.forEach(s => { if (!s.id) s.id = generateID('sales'); });
            state.products.forEach(p => { if (!p.id) p.id = generateID('products'); });
            state.expenses.forEach(e => { if (!e.id) e.id = generateID('expenses'); });
            (state.income || []).forEach(i => { if (!i.id) i.id = generateID('income'); });
            (state.loans || []).forEach(l => { if (!l.id) l.id = (l.timestamp || generateID('loans')); });
            state.customers.forEach(c => { if (!c.id) c.id = generateID('customers'); });
            state.transactions.forEach(t => { if (!t.id) t.id = generateID('transactions'); });
            state.unpaidEntries.forEach(u => { if (!u.id) u.id = generateID('unpaid'); });
            state.notes.forEach(n => { if (!n.id) n.id = generateID('notes'); });
        }

        // ========================================
        // TAGGING SYSTEM
        // ========================================

        // Predefined tag colors
        const TAG_COLOR_PALETTE = [
            '#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8',
            '#F7DC6F', '#BB8FCE', '#85C1E2', '#F8B88B', '#A3E4D7',
            '#FF7675', '#52C41A', '#1890FF', '#FAAD14', '#EB2F96'
        ];

        function initTagColors() {
            if (!state.tagColors) state.tagColors = {};
            state.tags.forEach((tag, idx) => {
                if (!state.tagColors[tag]) {
                    state.tagColors[tag] = TAG_COLOR_PALETTE[idx % TAG_COLOR_PALETTE.length];
                }
            });
        }

        function addTag(tagName, assignToSection = null) {
            if (!tagName || typeof tagName !== 'string') return false;
            const tag = tagName.trim().toLowerCase();
            if (tag.length === 0) return false;

            if (!state.tags.includes(tag)) {
                state.tags.push(tag);
                if (!state.tagColors[tag]) {
                    state.tagColors[tag] = TAG_COLOR_PALETTE[state.tags.length % TAG_COLOR_PALETTE.length];
                }
                saveData();
                try {
                    if (window.supabase && window.currentUser) {
                        (async () => {
                            try {
                                await supabase.from('tags').upsert([{
                                    user_id: window.currentUser.id,
                                    tag_name: tag,
                                    color: state.tagColors[tag] || '#999999'
                                }], { onConflict: 'user_id,tag_name' });
                            } catch (e) { }
                        })();
                    }
                } catch { }
                if (syncEnabled) syncInBackground();
                return true;
            }
            return false;
        }

        function removeTag(tagName) {
            const tag = tagName.toLowerCase();
            state.tags = state.tags.filter(t => t !== tag);
            delete state.tagColors[tag];

            // Remove from all items
            ['sales', 'products', 'expenses', 'income', 'customers', 'notes', 'transactions', 'unpaidEntries'].forEach(section => {
                (state[section] || []).forEach(item => {
                    if (item.tags && Array.isArray(item.tags)) {
                        item.tags = item.tags.filter(t => t !== tag);
                    }
                });
            });

            saveData();
            if (syncEnabled) syncInBackground();
        }

        function addTagToItem(item, tagName) {
            if (!item) return false;
            const tag = tagName.toLowerCase();
            addTag(tag);

            if (!item.tags) item.tags = [];
            if (!item.tags.includes(tag)) {
                item.tags.push(tag);
                return true;
            }
            return false;
        }

        function removeTagFromItem(item, tagName) {
            if (!item || !item.tags) return false;
            const tag = tagName.toLowerCase();
            const originalLength = item.tags.length;
            item.tags = item.tags.filter(t => t !== tag);
            return item.tags.length < originalLength;
        }

        function hasTag(item, tagName) {
            if (!item || !item.tags) return false;
            const tag = tagName.toLowerCase();
            return item.tags.includes(tag);
        }

        function getItemTags(item) {
            return Array.isArray(item?.tags) ? item.tags : [];
        }

        function renderTagBadge(tag) {
            if (!tag) return '';
            const hex = state.tagColors[tag] || '#999999';
            const isDark = (state.theme === 'dark') || document.body.classList.contains('theme-dark');
            const rgb = (function (h) {
                const s = h.replace('#', '');
                const f = s.length === 3
                    ? s.split('').map(x => parseInt(x + x, 16))
                    : [parseInt(s.substring(0, 2), 16), parseInt(s.substring(2, 4), 16), parseInt(s.substring(4, 6), 16)];
                return { r: f[0] || 153, g: f[1] || 153, b: f[2] || 153 };
            })(hex);
            const border = `rgb(${rgb.r}, ${rgb.g}, ${rgb.b})`;
            const bg = (function () {
                if (isDark) {
                    const dr = Math.max(0, Math.floor(rgb.r * 0.25));
                    const dg = Math.max(0, Math.floor(rgb.g * 0.25));
                    const db = Math.max(0, Math.floor(rgb.b * 0.25));
                    return `rgb(${dr}, ${dg}, ${db})`;
                } else {
                    return `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.22)`;
                }
            })();
            const text = isDark ? '#ffffff' : '#1a1a1a';
            return `<span class="tag-badge" style="background-color:${bg};border:1px solid ${border};color:${text};padding:4px 8px;border-radius:12px;font-size:11px;font-weight:600;display:inline-flex;align-items:center;">${tag}</span>`;
        }

        function renderTagBadges(item) {
            if (!item || !item.tags || !Array.isArray(item.tags) || item.tags.length === 0) return '';
            return `<div class="tags-scroll" style="margin-top:6px;">${item.tags.map(tag => renderTagBadge(tag)).join('')}</div>`;
        }
        function renderTagChips(section) {
            const sel = (state.filterTags && state.filterTags[section]) ? state.filterTags[section] : [];
            const chips = (state.tags || []).map(t => `<button class="btn-small btn-tag ${sel.includes(t)?'active':''}" onclick="toggleTagFilter('${section}','${t}')">${t}</button>`).join('');
            return chips ? `<div class="tags-scroll">${chips}</div>` : '';
        }
        function toggleTagFilter(section, tag) {
            state.filterTags = state.filterTags || {};
            const list = state.filterTags[section] || [];
            const t = String(tag || '').toLowerCase();
            state.filterTags[section] = list.includes(t) ? list.filter(x => x !== t) : [t];
            saveData();
            render();
        }

        function filterItemsByTags(items, selectedTags, matchAll = false) {
            if (!selectedTags || selectedTags.length === 0) return items;

            return items.filter(item => {
                const itemTags = getItemTags(item);
                if (matchAll) {
                    return selectedTags.every(tag => itemTags.includes(tag));
                } else {
                    return selectedTags.some(tag => itemTags.includes(tag));
                }
            });
        }

        function getTagStats() {
            const stats = {};
            state.tags.forEach(tag => {
                const salesCount = state.sales.filter(s => hasTag(s, tag)).length;
                const productsCount = state.products.filter(p => hasTag(p, tag)).length;
                const expensesCount = state.expenses.filter(e => hasTag(e, tag)).length;
                const customersCount = state.customers.filter(c => hasTag(c, tag)).length;
                const notesCount = state.notes.filter(n => hasTag(n, tag)).length;
                const transactionsCount = state.transactions.filter(t => hasTag(t, tag)).length;
                const unpaidCount = state.unpaidEntries.filter(u => hasTag(u, tag)).length;
                const incomeCount = (state.income || []).filter(i => hasTag(i, tag)).length;
                const loansCount = (state.loans || []).filter(l => hasTag(l, tag)).length;

                stats[tag] = {
                    sales: salesCount,
                    products: productsCount,
                    expenses: expensesCount,
                    customers: customersCount,
                    notes: notesCount,
                    transactions: transactionsCount,
                    unpaid: unpaidCount,
                    income: incomeCount,
                    loans: loansCount,
                    total: salesCount + productsCount + expensesCount + customersCount + notesCount + transactionsCount + unpaidCount + incomeCount + loansCount
                };
            });
            return stats;
        }

        function renderTagsModal() {
            const stats = getTagStats();
            let html = `
                <div class="modal" id="tagsModal" style="display:none;" onclick="if(event.target.id === 'tagsModal') closeTagsModal();">
                    <div class="modal-content" style="max-width:600px;">
                        <button class="modal-close" onclick="closeTagsModal()">×</button>
                        <div class="modal-title">📌 Tags Management</div>
                        
                        <div style="margin:16px 0;">
                            <label>Create New Tag:</label>
                            <div style="display:flex;gap:8px;margin-top:8px;">
                                <input type="text" id="newTagInput" placeholder="Tag name..." style="flex:1;padding:8px;border:1px solid #ddd;border-radius:4px;">
                                <button class="btn-primary btn-small" onclick="createNewTag()">Add Tag</button>
                            </div>
                        </div>

                        <div style="border-top:1px solid #eee;padding:16px 0;">
                            <h3 style="margin:0 0 12px 0;">All Tags (${state.tags.length})</h3>
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;max-height:300px;overflow-y:auto;-webkit-overflow-scrolling:touch;overscroll-behavior:contain;">
            `;

            state.tags.forEach(tag => {
                const stat = stats[tag] || { total: 0 };
                const color = state.tagColors[tag];
                html += `
                    <div style="background:${color}15;border:1px solid ${color};border-radius:8px;padding:8px;display:flex;justify-content:space-between;align-items:center;">
                        <div>
                            <div style="font-weight:600;color:${color};">${tag}</div>
                            <div style="font-size:11px;color:#666;">used ${stat.total || 0} times</div>
                        </div>
                        <button class="btn-danger btn-small" style="padding:4px 8px;font-size:11px;" onclick="deleteTag('${tag}')">×</button>
                    </div>
                `;
            });

            html += `
                            </div>
                        </div>

                        <div style="border-top:1px solid #eee;padding:16px 0;">
                            <h3 style="margin:0 0 12px 0;">Usage Summary</h3>
                            <div style="font-size:13px;color:#666;max-height:200px;overflow-y:auto;">
            `;

            state.tags.forEach(tag => {
                const stat = stats[tag] || { sales: 0, products: 0, expenses: 0, customers: 0, notes: 0, transactions: 0, unpaid: 0, income: 0 };
                html += `
                    <div style="margin:4px 0;display:flex;align-items:center;gap:8px;">
                        <span style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:12px;line-height:1;flex:0 0 30%"><strong>${tag}</strong>:</span>
                        <span style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:12px;line-height:1;flex:1 1 70%;min-width:0;text-align:right">Sales(${stat.sales || 0}) | Products(${stat.products || 0}) | Expenses(${stat.expenses || 0}) | Customers(${stat.customers || 0}) | Notes(${stat.notes || 0}) | Income(${stat.income || 0})</span>
                    </div>
                `;
            });

            html += `
                            </div>
                        </div>

                        <div style="display:flex;gap:8px;margin-top:16px;">
                            <button class="btn-secondary btn-small" onclick="closeTagsModal()">Close</button>
                        </div>
                    </div>
                </div>
            `;

            return html;
        }

        window.openTagsModal = function () {
            const modal = document.getElementById('tagsModal');
            if (modal) {
                modal.style.display = 'flex';
                // Re-render to get fresh stats
                const container = document.getElementById('tagsModalsContainer');
                if (container) {
                    container.innerHTML = renderTagsModal();
                    const newModal = document.getElementById('tagsModal');
                    if (newModal) newModal.style.display = 'flex';
                }
            }
        };

        window.closeTagsModal = function () {
            const modal = document.getElementById('tagsModal');
            if (modal) {
                modal.style.display = 'none';
            }
        };

        window.createNewTag = function () {
            const input = document.getElementById('newTagInput');
            if (!input || !input.value.trim()) {
                showToast('Please enter a tag name', 'error');
                return;
            }
            if (addTag(input.value.trim())) {
                showToast(`✅ Tag "${input.value.trim()}" created!`, 'success');
                input.value = '';
                // Refresh modal immediately
                setTimeout(() => {
                    const container = document.getElementById('tagsModalsContainer');
                    if (container) {
                        container.innerHTML = renderTagsModal();
                        const modal = document.getElementById('tagsModal');
                        if (modal) modal.style.display = 'flex';
                    }
                }, 50);
            } else {
                showToast('Tag already exists', 'info');
            }
        };

        window.deleteTag = async function (tagName) {
            const ok = await requirePinForDestructive('delete');
            if (!ok) { showToast('Delete failed: PIN required', 'error'); return; }
            removeTag(tagName);
            showToast(`✅ Tag "${tagName}" deleted!`, 'success');
                // Sync only tags to Supabase (fast sync)
                if (syncEnabled && currentUser) {
                    try {
                        (async () => {
                            try {
                                // Sync only tags definition
                                if (state.tags && state.tags.length > 0) {
                                    const tagsData = state.tags.map(tag => ({
                                        user_id: currentUser.id,
                                        tag_name: tag,
                                        color: state.tagColors[tag] || '#999999'
                                    }));
                                    await supabase.from('tags').upsert(tagsData, { onConflict: 'user_id,tag_name' });
                                }
                                // Delete removed tag from tags table
                                await supabase.from('tags').delete().eq('user_id', currentUser.id).eq('tag_name', tagName);
                                console.log('✅ Tag deleted from cloud');
                            } catch (e) {
                                console.warn('Tag sync error:', e);
                            }
                        })();
                    } catch (e) {
                        console.warn('Sync error:', e);
                    }
                }
                // Refresh modal immediately
                setTimeout(() => {
                    const container = document.getElementById('tagsModalsContainer');
                    if (container) {
                        container.innerHTML = renderTagsModal();
                        const modal = document.getElementById('tagsModal');
                        if (modal) modal.style.display = 'flex';
                    }
                }, 50);
        };

        function renderBulkTagsModal(section) {
            const selected = Object.keys(state.selectedItems[section] || {}).filter(id => state.selectedItems[section][id]);
            const count = selected.length;
            const chips = (state.tags || []).map(t => {
                const active = (state.bulkTagSelected && state.bulkTagSelected === t);
                return `<button class="btn-small btn-tag ${active ? 'active' : ''}" onclick="chooseBulkTag('${t}')">${t}</button>`;
            }).join('');
            return `
                <div class="modal" id="bulkTagsModal" style="display:none;" onclick="if(event.target.id === 'bulkTagsModal') closeBulkTagsModal();">
                    <div class="modal-content" style="max-width:520px;">
                        <button class="modal-close" onclick="closeBulkTagsModal()">×</button>
                        <div class="modal-title">📌 Manage Tags</div>
                        <div style="margin:8px 0;color:#666;font-size:13px;">Apply a tag to ${count} selected ${section} item(s).</div>
                        ${chips ? `<div class="tags-scroll" style="margin-top:8px;">${chips}</div>` : '<div style="margin-top:8px;color:#666;">No tags yet</div>'}
                        <div style="margin-top:12px;">
                            <label>Or create new tag</label>
                            <div style="display:flex;gap:8px;margin-top:6px;">
                                <input type="text" id="bulkNewTagInput" placeholder="Tag name..." style="flex:1;padding:8px;border:1px solid #ddd;border-radius:6px;">
                                <button class="btn-small btn-primary" onclick="createBulkTag()">Add</button>
                            </div>
                        </div>
                        <div class="flex-gap" style="margin-top:12px;">
                            <button class="btn-success btn-small" onclick="applyBulkTagFromModal()">Apply Tag</button>
                            <button class="btn-secondary btn-small" onclick="closeBulkTagsModal()">Cancel</button>
                        </div>
                    </div>
                </div>
            `;
        }
        window.openBulkTagsModal = function (section) {
            state.bulkTagSection = section;
            state.bulkTagSelected = null;
            const container = document.getElementById('bulkTagsModalContainer');
            if (container) {
                container.innerHTML = renderBulkTagsModal(section);
                const m = document.getElementById('bulkTagsModal');
                if (m) m.style.display = 'flex';
            }
        };
        window.closeBulkTagsModal = function () {
            const m = document.getElementById('bulkTagsModal');
            if (m) m.style.display = 'none';
        };
        window.chooseBulkTag = function (tag) {
            state.bulkTagSelected = String(tag || '').toLowerCase();
            const container = document.getElementById('bulkTagsModalContainer');
            if (container) {
                container.innerHTML = renderBulkTagsModal(state.bulkTagSection);
                const m = document.getElementById('bulkTagsModal');
                if (m) m.style.display = 'flex';
            }
        };
        window.createBulkTag = function () {
            const input = document.getElementById('bulkNewTagInput');
            const val = (input?.value || '').trim();
            if (!val) return showToast('Enter tag name', 'error');
            addTag(val);
            state.bulkTagSelected = val.toLowerCase();
            input.value = '';
            const container = document.getElementById('bulkTagsModalContainer');
            if (container) {
                container.innerHTML = renderBulkTagsModal(state.bulkTagSection);
                const m = document.getElementById('bulkTagsModal');
                if (m) m.style.display = 'flex';
            }
        };
        window.applyBulkTagFromModal = function () {
            const section = state.bulkTagSection;
            const tag = state.bulkTagSelected;
            if (!section) return closeBulkTagsModal();
            const selected = Object.keys(state.selectedItems[section] || {}).filter(id => state.selectedItems[section][id]);
            if (selected.length === 0) { showToast('No items selected', 'info'); return; }
            if (!tag) { showToast('Choose or create a tag', 'error'); return; }
            const items = (section === 'unpaidEntries') ? state.unpaidEntries : state[section];
            selected.forEach(selId => {
                const it = items.find(x => String(x.id) === String(selId));
                if (it) addTagToItem(it, tag);
            });
            saveData();
            render();
            closeBulkTagsModal();
            showToast(`Applied "${tag}" to ${selected.length} items`, 'success');
            if (syncEnabled) syncInBackground();
        };

        function normalizeLegacyBulkTimestamps() {
            try {
                const items = Array.isArray(state.inventoryPurchases) ? state.inventoryPurchases : [];
                const tsGroups = items.reduce((acc, p) => {
                    const key = String(p.timestamp || '');
                    if (!acc[key]) acc[key] = [];
                    acc[key].push(p);
                    return acc;
                }, {});
                Object.keys(tsGroups).forEach(ts => {
                    const group = tsGroups[ts];
                    if (group.length > 1) {
                        group.forEach((p, idx) => {
                            const newTs = Number(ts) + idx;
                            if (p.timestamp !== newTs) {
                                p.timestamp = newTs;
                                try { upsertOne('inventory_purchases', p); } catch { }
                            }
                        });
                    }
                });
                saveData();
            } catch { }
        }

        function formatNumber(num) {
            try {
                if (num === null || num === undefined || isNaN(num)) return '0';
                const n = Math.round(parseFloat(num));
                const fmt = new Intl.NumberFormat(navigator.language || 'en-US');
                return fmt.format(n);
            } catch {
                if (num === null || num === undefined || isNaN(num)) return '0';
                const n = Math.round(parseFloat(num));
                const sign = n < 0 ? '-' : '';
                const abs = Math.abs(n);
                return sign + String(abs).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            }
        }
        function formatMoney(num) { return formatNumber(num); }
        function escapeHTML(str) {
            try {
                return String(str)
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#39;');
            } catch { return String(str || ''); }
        }
        function parseMoney(str) {
            if (typeof str === 'number') return str;
            if (!str) return 0;
            const s = String(str).trim();
            if (/^[\d\.\+\-\*\/\(\)\s]+$/.test(s)) {
                try {
                    const v = Function('return (' + s + ')')();
                    const n = parseFloat(v);
                    if (!isNaN(n) && isFinite(n)) return Math.round(n);
                } catch {}
            }
            const cleaned = String(str).replace(/[^0-9\-]/g, '');
            const n = parseInt(cleaned || '0', 10);
            return isNaN(n) ? 0 : n;
        }
        function attachMoneyFormatter(el, { max = 999999999, min = 0 } = {}) {
            if (!el) return;
            const fmt = (v) => formatMoney(Math.max(min, Math.min(max, v)));
            const handle = () => {
                const raw = (el.value || '').trim();
                if (raw === '') { el.dataset.numeric = ''; return; }
                const val = parseMoney(el.value);
                el.dataset.numeric = String(val);
                el.value = fmt(val);
            };
            el.addEventListener('input', handle);
            el.addEventListener('blur', handle);
            // Initialize without forcing "0" on empty fields
            handle();
        }

        function capitalizeFirstWordValue(str) {
            const s = String(str || '');
            const i = s.search(/[A-Za-z]/);
            if (i < 0) return s;
            return s.slice(0, i) + s.charAt(i).toUpperCase() + s.slice(i + 1);
        }

        function toTitleCase(str) {
            return String(str || '').replace(/\w\S*/g, (t) => t.charAt(0).toUpperCase() + t.slice(1).toLowerCase());
        }

        function toCategoryCase(str) {
            return String(str || '').toUpperCase();
        }

        function attachFirstWordCapitalizer(el) {
            if (!el) return;
            const applyCap = () => {
                try {
                    const start = el.selectionStart;
                    const end = el.selectionEnd;
                    const v = String(el.value || '');
                    const i = v.search(/[A-Za-z]/);
                    if (i >= 0 && v.charAt(i) !== v.charAt(i).toUpperCase()) {
                        el.value = v.slice(0, i) + v.charAt(i).toUpperCase() + v.slice(i + 1);
                        if (typeof start === 'number' && typeof end === 'number' && el.setSelectionRange) {
                            el.setSelectionRange(start, end);
                        }
                    }
                } catch { }
            };
            el.addEventListener('input', applyCap);
            el.addEventListener('blur', applyCap);
            applyCap();
        }

        async function hydrateStateFromIndexedDB() {
            try {
                if (!window.storageManager) return;
                await window.storageManager.loadAllIntoState(state);
            } catch {}
        }
        function loadData() {
            const saved = localStorage.getItem('financeManagerData');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    state = { ...state, ...parsed };

                    // Ensure userProfile exists
                    if (!state.userProfile) {
                        state.userProfile = {
                            businessName: "",
                            email: "",
                            phone: "",
                            address: "",
                            country: "",
                            city: ""
                        };
                    }

                    // Ensure profileEditMode exists
                    if (state.profileEditMode === undefined) {
                        state.profileEditMode = false;
                    }

                    if (state.soundEnabled === undefined) {
                        state.soundEnabled = false;
                    }

                    if (state.theme === undefined || !state.theme) {
                        state.theme = 'dark';
                    }

                    // Ensure commissions array is properly initialized
                    if (!state.commissions) {
                        state.commissions = [];
                    } else if (!Array.isArray(state.commissions)) {
                        state.commissions = [];
                    }

                    try { restoreTransactionFloats(); } catch { }

                    // Calculate current float balances
                    calculateFloatBalances();
                    try { ensureIDs(); saveData(); } catch {}
                } catch (e) {
                    console.error('Error loading data:', e);
                }
            } else {
                // Initialize commissions if no saved data exists
                state.commissions = state.commissions || [];
            }
        }

        // Logo helpers
        function triggerLogoUpload() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/png,image/jpeg';
            input.onchange = async (e) => {
                const file = e.target.files && e.target.files[0];
                if (!file) return;
                try {
                    const resized = await resizeImageFile(file, 256);
                    state.userLogoDataUrl = resized.dataUrl;
                    state.userLogoMime = resized.mime;
                    saveData();
                    render();
                    if (syncEnabled && currentUser) {
                        if (typeof upsertOne === 'function') {
                            try { await upsertOne('user_profiles', { logo_data: resized.dataUrl, logo_mime: resized.mime }); } catch {}
                        } else {
                            await supabase.from('user_profiles').upsert({ user_id: currentUser.id, logo_data: resized.dataUrl, logo_mime: resized.mime }, { onConflict: 'user_id' });
                        }
                    } else {
                        if (typeof upsertQueue !== 'undefined' && typeof upsertQueue.enqueue === 'function') {
                            try { upsertQueue.enqueue('user_profiles', { logo_data: resized.dataUrl, logo_mime: resized.mime }); } catch {}
                        }
                    }
                    showToast('Logo saved', 'success');
                } catch (err) {
                    showToast('Failed to process logo', 'error');
                }
            };
            input.click();
        }

        async function resizeImageFile(file, maxSize) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => {
                    const w0 = img.width || 1;
                    const h0 = img.height || 1;
                    const scale = Math.min(maxSize / w0, maxSize / h0, 1);
                    const w = Math.max(1, Math.round(w0 * scale));
                    const h = Math.max(1, Math.round(h0 * scale));
                    const canvas = document.createElement('canvas');
                    canvas.width = w;
                    canvas.height = h;
                    const ctx = canvas.getContext('2d');
                    if (ctx && ctx.imageSmoothingQuality) ctx.imageSmoothingQuality = 'high';
                    ctx.drawImage(img, 0, 0, w, h);
                    const mime = 'image/png';
                    const dataUrl = canvas.toDataURL(mime);
                    resolve({ dataUrl, mime });
                };
                img.onerror = reject;
                const reader = new FileReader();
                reader.onload = () => { img.src = reader.result; };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }


        function slugifyName(s) {
            return String(s || '').toLowerCase().replace(/[^a-z0-9]+/g, '_').replace(/^_+|_+$/g, '');
        }



        // async function uploadLogoToSupabase(dataUrl, mime = 'image/png') {
        //     try {
        //         if (!supabase || !currentUser) return;
        //         const blob = await (await fetch(dataUrl)).blob();
        //         const ext = mime === 'image/png' ? 'png' : 'jpg';
        //         const path = `${currentUser.id}/logo.${ext}`;
        //         const { error: upErr } = await supabase.storage.from('logos').upload(path, blob, { upsert: true, contentType: mime });
        //         if (upErr) { console.error('Supabase storage upload error:', upErr); return; }
        //         const { data: pub } = supabase.storage.from('logos').getPublicUrl(path);
        //         if (pub && pub.publicUrl) {
        //             state.userLogoPublicUrl = pub.publicUrl;
        //             saveData();
        //         }
        //     } catch (e) {
        //         console.error('Upload logo error:', e);
        //     }
        // }

        function getLogoForPdf() {
            return null;
        }

        // Ensure logo base64 is hydrated before PDF generation
        async function ensureLogoReady() {
            if (state.userLogoDataUrl) return true;
            try {
                if (typeof supabase !== 'undefined' && supabase && currentUser) {
                    const { data, error } = await supabase.from('user_profiles').select('logo_data,logo_mime').eq('user_id', currentUser.id).single();
                    if (!error && data && data.logo_data) {
                        state.userLogoDataUrl = data.logo_data;
                        state.userLogoMime = data.logo_mime || (String(data.logo_data).startsWith('data:image/png') ? 'image/png' : 'image/jpeg');
                        saveData();
                        return true;
                    }
                }
            } catch {}
            return false;
        }

        // Draw logo inside a circular placeholder, clipped to the circle and filling it
        function drawLogo(doc, x, y, size, options = {}) {
            const logo = getLogoForPdf();
            if (!logo) return false;

            const {
                borderColor = [180, 180, 180],
                borderWidth = 1
            } = options;

            const cx = x + size / 2;
            const cy = y + size / 2;
            const r = size / 2;

            try {
                // Clip to circle and draw image to fully fill the circle
                doc.saveGraphicsState();
                doc.beginPath();
                doc.circle(cx, cy, r);
                doc.clip();
                doc.addImage(logo.dataUrl, logo.format, x, y, size, size);
                doc.restoreGraphicsState();

                // Circle border on top
                doc.setDrawColor(...borderColor);
                doc.setLineWidth(borderWidth);
                doc.circle(cx, cy, r, 'S');
                return true;
            } catch (e) {
                console.warn('Logo draw error:', e);
                return false;
            }
        }

        function saveData() {
            cachedStats = null;
            try { window.cachedStats = null; window.lastStatsUpdate = 0; } catch {}
            try {
                localStorage.setItem('financeManagerData', JSON.stringify(state));
            } catch (e) {
                console.error('Error saving data:', e);
                showToast('Error saving data!', 'error');
            }
            try { globalThis.__stateBus && globalThis.__stateBus.notify({ type: 'save', payload: state }); } catch {}
            try {
                if (window.storageManager) {
                    window.storageManager.saveCollectionsFromState(state);
                    window.storageManager.saveStateSnapshot(state);
                }
            } catch {}
            try { refreshGlobalSearchIfOpen(); } catch { }
            try { saveOfflineJSSnapshot(); } catch { }
        }

        (function setupInteractionTabRestore() {
            const KEY = 'tuba-last-interaction-v1';
            const MAX_AGE_MS = 3 * 60 * 60 * 1000;
            const TAB_KEY = 'tuba-last-tab-v1';
            const TAB_AT_KEY = 'tuba-last-tab-at-v1';
            let lastWrite = 0;

            function isEditableEl(el) {
                try {
                    if (!el) return false;
                    if (el.isContentEditable) return true;
                    const tag = String(el.tagName || '').toUpperCase();
                    if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT') return true;
                    if (el.getAttribute && el.getAttribute('role') === 'textbox') return true;
                } catch { }
                return false;
            }


            function writeInteraction(payload, { force = false } = {}) {
                try {
                    const now = Date.now();
                    if (!force && now - lastWrite < 400) return;
                    lastWrite = now;
                    localStorage.setItem(KEY, JSON.stringify(payload));
                } catch { }
            }

            function markInteraction(inProgress) {
                try {
                    const tabId = String(state.activeTab || 'sales');
                    const now = Date.now();
                    state.lastInteractionTab = tabId;
                    state.lastInteractionAt = now;
                    state.lastInteractionInProgress = !!inProgress;
                    writeInteraction({ tabId, at: now, inProgress: !!inProgress });
                    try {
                        state.lastNavTab = tabId;
                        state.lastNavAt = now;
                        localStorage.setItem(TAB_KEY, tabId);
                        localStorage.setItem(TAB_AT_KEY, String(now));
                    } catch { }
                } catch { }
            }

            function clearInteractionIfIdle() {
                try {
                    const active = document.activeElement;
                    if (isEditableEl(active)) return;
                    if (state.lastInteractionInProgress) {
                        state.lastInteractionInProgress = false;
                        writeInteraction({ tabId: String(state.lastInteractionTab || state.activeTab || 'sales'), at: Number(state.lastInteractionAt || Date.now()), inProgress: false }, { force: true });
                    }
                } catch { }
            }

            window.__restoreTabFromInteraction = function () {
                try {
                    let rec = null;
                    try { rec = JSON.parse(localStorage.getItem(KEY) || 'null'); } catch { rec = null; }
                    const tabId = String((rec && rec.tabId) || state.lastInteractionTab || '');
                    const at = Number((rec && rec.at) || state.lastInteractionAt || 0);
                    const inProgress = !!((rec && rec.inProgress) || state.lastInteractionInProgress);
                    const age = at ? (Date.now() - at) : Number.POSITIVE_INFINITY;
                    const allowed = (tabs || []).some(t => String(t.id) === tabId);
                    if (tabId && allowed && (inProgress || age <= MAX_AGE_MS)) {
                        state.activeTab = tabId;
                        return;
                    }
                } catch { }
                try {
                    const lastTab = String(localStorage.getItem(TAB_KEY) || state.lastNavTab || '');
                    const lastAt = Number(localStorage.getItem(TAB_AT_KEY) || state.lastNavAt || 0);
                    const allowed2 = (tabs || []).some(t => String(t.id) === lastTab);
                    if (lastTab && allowed2) {
                        state.activeTab = lastTab;
                        return;
                    }
                } catch { }
                state.activeTab = 'sales';
            };

            document.addEventListener('focusin', (e) => {
                if (!isEditableEl(e.target)) return;
                markInteraction(true);
            }, true);
            document.addEventListener('input', (e) => {
                if (!isEditableEl(e.target)) return;
                markInteraction(true);
            }, true);
            document.addEventListener('change', (e) => {
                if (!isEditableEl(e.target)) return;
                markInteraction(true);
            }, true);
            document.addEventListener('focusout', (e) => {
                if (!isEditableEl(e.target)) return;
                setTimeout(clearInteractionIfIdle, 0);
            }, true);

            document.addEventListener('visibilitychange', () => {
                try {
                    if (document.hidden) {
                        const active = document.activeElement;
                        markInteraction(isEditableEl(active));
                        writeInteraction({ tabId: String(state.lastInteractionTab || state.activeTab || 'sales'), at: Number(state.lastInteractionAt || Date.now()), inProgress: !!state.lastInteractionInProgress }, { force: true });
                        try {
                            const now = Date.now();
                            localStorage.setItem(TAB_KEY, String(state.activeTab || 'sales'));
                            localStorage.setItem(TAB_AT_KEY, String(now));
                        } catch { }
                        try { saveData(); } catch { }
                    }
                } catch { }
            }, true);
            window.addEventListener('pagehide', () => {
                try {
                    const active = document.activeElement;
                    markInteraction(isEditableEl(active));
                    writeInteraction({ tabId: String(state.lastInteractionTab || state.activeTab || 'sales'), at: Number(state.lastInteractionAt || Date.now()), inProgress: !!state.lastInteractionInProgress }, { force: true });
                    try {
                        const now = Date.now();
                        localStorage.setItem(TAB_KEY, String(state.activeTab || 'sales'));
                        localStorage.setItem(TAB_AT_KEY, String(now));
                    } catch { }
                    try { saveData(); } catch { }
                } catch { }
            }, true);
        })();

        function buildOfflineSnapshot() {
            return {
                products: Array.isArray(state.products) ? state.products : [],
                sales: Array.isArray(state.sales) ? state.sales : [],
                customers: Array.isArray(state.customers) ? state.customers : [],
                expenses: Array.isArray(state.expenses) ? state.expenses : [],
                income: Array.isArray(state.income) ? state.income : [],
                categories: Array.isArray(state.categories) ? state.categories : [],
                inventory: (state.inventory || {}),
                invoices: Array.isArray(state.invoices) ? state.invoices : [],
                receipts: Array.isArray(state.receipts) ? state.receipts : [],
                notes: Array.isArray(state.notes) ? state.notes : [],
                transactions: Array.isArray(state.transactions) ? state.transactions : [],
                unpaidEntries: Array.isArray(state.unpaidEntries) ? state.unpaidEntries : [],
                loans: Array.isArray(state.loans) ? state.loans : [],
                assets: Array.isArray(state.assets) ? state.assets : [],
                maintenance: Array.isArray(state.maintenance) ? state.maintenance : [],
                auditLogs: Array.isArray(state.auditLogs) ? state.auditLogs : [],
                tags: Array.isArray(state.tags) ? state.tags : [],
                tagColors: (state.tagColors || {}),
                inventoryPurchases: Array.isArray(state.inventoryPurchases) ? state.inventoryPurchases : [],
                inventoryPurchaseCycles: Array.isArray(state.inventoryPurchaseCycles) ? state.inventoryPurchaseCycles : [],
                tithingRecords: (state.tithingRecords || {}),
                transactionFloats: (state.transactionFloats || {}),
                userProfile: (state.userProfile || {}),
                userLogoDataUrl: state.userLogoDataUrl || '',
                userLogoMime: state.userLogoMime || '',
                settings: {
                    currency_code: state.currencyCode,
                    currency_symbol: state.currencySymbol,
                    default_tax_rate: state.defaultTaxRate,
                    cogs_method: state.cogsMethod,
                    daily_target: state.dailyTarget,
                    monthly_target: state.monthlyTarget
                }
            };
        }

        async function saveOfflineJSSnapshot() {
            try {
                const payload = buildOfflineSnapshot();
                const userId = (window.currentUser && window.currentUser.id) || '';
                const labelRaw = (state.userProfile && state.userProfile.businessName) || (window.currentUser && window.currentUser.email) || 'user';
                const label = String(labelRaw || 'user').trim();
                if (navigator.serviceWorker && navigator.serviceWorker.controller) {
                    navigator.serviceWorker.controller.postMessage({ type: 'save-offline-js', userId, payload, label });
                } else if (navigator.serviceWorker) {
                    const reg = await navigator.serviceWorker.ready;
                    const sw = (reg && reg.active) || (navigator.serviceWorker.controller);
                    if (sw) sw.postMessage({ type: 'save-offline-js', userId, payload, label });
                }
                try {
                    const snap = { user_id: userId, label, ts: Date.now(), data: payload };
                    localStorage.setItem('tuba-offline-snapshot', JSON.stringify(snap));
                } catch {}
            } catch { }
        }

        function hydrateFromOfflineSnapshot(snap) {
            try {
                const d = snap && snap.data ? snap.data : {};
                state.products = Array.isArray(d.products) ? d.products : (state.products || []);
                state.sales = Array.isArray(d.sales) ? d.sales : (state.sales || []);
                state.customers = Array.isArray(d.customers) ? d.customers : (state.customers || []);
                state.expenses = Array.isArray(d.expenses) ? d.expenses : (state.expenses || []);
                state.income = Array.isArray(d.income) ? d.income : (state.income || []);
                state.categories = Array.isArray(d.categories) ? d.categories : (state.categories || []);
                state.inventory = d.inventory || (state.inventory || {});
                state.invoices = Array.isArray(d.invoices) ? d.invoices : (state.invoices || []);
                state.receipts = Array.isArray(d.receipts) ? d.receipts : (state.receipts || []);
                state.notes = Array.isArray(d.notes) ? d.notes : (state.notes || []);
                state.transactions = Array.isArray(d.transactions) ? d.transactions : (state.transactions || []);
                state.unpaidEntries = Array.isArray(d.unpaidEntries) ? d.unpaidEntries : (state.unpaidEntries || []);
                state.loans = Array.isArray(d.loans) ? d.loans : (state.loans || []);
                state.assets = Array.isArray(d.assets) ? d.assets : (state.assets || []);
                state.maintenance = Array.isArray(d.maintenance) ? d.maintenance : (state.maintenance || []);
                state.auditLogs = Array.isArray(d.auditLogs) ? d.auditLogs : (state.auditLogs || []);
                state.tags = Array.isArray(d.tags) ? d.tags : (state.tags || []);
                state.tagColors = d.tagColors || (state.tagColors || {});
                state.inventoryPurchases = Array.isArray(d.inventoryPurchases) ? d.inventoryPurchases : (state.inventoryPurchases || []);
                state.inventoryPurchaseCycles = Array.isArray(d.inventoryPurchaseCycles) ? d.inventoryPurchaseCycles : (state.inventoryPurchaseCycles || []);
                state.tithingRecords = d.tithingRecords || (state.tithingRecords || {});
                state.transactionFloats = d.transactionFloats || (state.transactionFloats || {});
                state.userProfile = d.userProfile || (state.userProfile || {});
                state.userLogoDataUrl = d.userLogoDataUrl || state.userLogoDataUrl || '';
                state.userLogoMime = d.userLogoMime || state.userLogoMime || '';
                const s = d.settings || {};
                if (s.currency_code && s.currency_symbol) { setCurrency(s.currency_code, s.currency_symbol); }
                if (typeof s.default_tax_rate === 'number') state.defaultTaxRate = s.default_tax_rate;
                if (s.cogs_method) state.cogsMethod = s.cogs_method;
                if (typeof s.daily_target === 'number') state.dailyTarget = s.daily_target;
                if (typeof s.monthly_target === 'number') state.monthlyTarget = s.monthly_target;
                try { initTagColors(); } catch {}
                try { ensureIDs(); } catch {}
            } catch { }
        }

        async function tryLoadOfflineSnapshot() {
            try {
                const paths = [
                    '/offline-data.json',
                    'offline-data.json',
                    './offline-data.json',
                    (window.APP_BASE_URL || '') + 'offline-data.json'
                ];
                let snap = null;
                for (let p of paths) {
                    try {
                        const res = await fetch(p, { cache: 'no-store' });
                        if (res && res.ok) { snap = await res.json(); break; }
                    } catch {}
                }
                if (!snap || !snap.data) {
                    try {
                        const raw = localStorage.getItem('tuba-offline-snapshot');
                        if (raw) {
                            const parsed = JSON.parse(raw || '{}');
                            if (parsed && parsed.data) snap = parsed;
                        }
                    } catch {}
                }
                if (!snap || !snap.data) return false;
                hydrateFromOfflineSnapshot(snap);
                try { saveData(); } catch { }
                try { render(); } catch { }
                return true;
            } catch { return false; }
        }

        function calculateFloatBalances() {
            // Initialize and migrate old shape
            Object.keys(state.transactionFloats).forEach(channel => {
                const f = state.transactionFloats[channel] = state.transactionFloats[channel] || {};
                if (f.initialAccount == null) f.initialAccount = f.initial != null ? f.initial : 0;
                if (f.initialCash == null) f.initialCash = 0;
                // Reset current balances
                f.currentAccount = f.initialAccount || 0;
                f.currentCash = f.initialCash || 0;
            });

            // Apply all transactions: move value between account float and cash
            (state.transactions || []).forEach(t => {
                const f = state.transactionFloats[t.channel];
                const amt = parseFloat(t.amount) || 0;
                if (!f || !amt) return;
                if ((t.type || '').toLowerCase() === 'deposit') {
                    // Customer withdraws from account, pays us cash
                    f.currentAccount = (f.currentAccount || 0) - amt;
                    f.currentCash = (f.currentCash || 0) + amt;
                } else if ((t.type || '').toLowerCase() === 'withdrawal') {
                    // Customer deposits into account, we give out cash
                    f.currentAccount = (f.currentAccount || 0) + amt;
                    f.currentCash = (f.currentCash || 0) - amt;
                }
            });

            // Backward compatibility mirrors
            Object.keys(state.transactionFloats).forEach(channel => {
                const f = state.transactionFloats[channel];
                f.initial = f.initialAccount;
                f.current = f.currentAccount;
            });

            try { backupTransactionFloats(); } catch { }
        }

        function backupTransactionFloats() {
            try {
                const data = JSON.stringify({ ts: Date.now(), floats: state.transactionFloats || {} });
                localStorage.setItem('transactionFloatsBackup', data);
            } catch { }
        }

        function restoreTransactionFloats() {
            try {
                const raw = localStorage.getItem('transactionFloatsBackup');
                if (!raw) return;
                const backup = JSON.parse(raw || '{}');
                const floats = backup.floats || {};
                state.transactionFloats = state.transactionFloats || {};
                Object.keys(floats).forEach(ch => {
                    const b = floats[ch] || {};
                    const f = state.transactionFloats[ch] = state.transactionFloats[ch] || {};
                    // Only restore if local is missing or zero
                    if ((f.initialAccount == null) || (Number(f.initialAccount) === 0 && Number(b.initialAccount) > 0)) {
                        f.initialAccount = Number(b.initialAccount) || 0;
                    }
                    if ((f.initialCash == null) || (Number(f.initialCash) === 0 && Number(b.initialCash) > 0)) {
                        f.initialCash = Number(b.initialCash) || 0;
                    }
                });
            } catch { }
        }

        function getStats() {
            try {
                if (typeof window.getStats === 'function') return window.getStats();
            } catch {}
            return {
                totalCapital: 0,
                totalProfit: 0,
                totalRevenue: 0,
                totalExpenses: 0,
                todaySalesCount: 0,
                todayRevenue: 0,
                todayExpenses: 0,
                todayIncomeAmt: 0,
                todayProfit: 0,
                yesterdayProfit: 0,
                monthSalesProfit: 0,
                monthRevenue: 0,
                monthExpenses: 0,
                monthIncome: 0,
                monthProfit: 0,
                totalIncome: 0,
                totalInvoiced: 0,
                totalPaid: 0,
                monthNetProfit: 0
            };
        }


        const tabs = [
            { id: 'dashboard', label: 'Dashboard', icon: '📊' },
            { id: 'account', label: 'Account', icon: '👤' },  // ADD THIS LINE
            { id: 'sales', label: 'Sales', icon: '🛒' },
            { id: 'transactions', label: 'Money', icon: '💳' },
            { id: 'products', label: 'Products/Services', icon: '🛍️' },
            { id: 'categories', label: 'Categories', icon: '📁' },
            { id: 'income', label: 'Income', icon: '💰' },
            { id: 'expenses', label: 'Expenses', icon: '💸' },
            { id: 'loans', label: 'Loans', icon: '🤝' },
            { id: 'inventory', label: 'Stock', icon: '📦' },
            { id: 'inventoryPurchases', label: 'Inventory', icon: '📦' },
            { id: 'customers', label: 'Customers', icon: '👥' },
            { id: 'invoices', label: 'Invoices & Receipts', icon: '📄' },
            { id: 'analytics', label: 'Analytics', icon: '📈' },
            { id: 'unpaid', label: 'Unpaid', icon: '⏳' },
            { id: 'notes', label: 'Notes', icon: '📝' },
            { id: 'assets', label: 'Assets', icon: '🏗️' },
            { id: 'maintenance', label: 'Maintenance', icon: '🛠️' }
        ];

        async function pushAllDataToSupabase() { return window.pushAllDataToSupabase && window.pushAllDataToSupabase(); }
        async function clearAndPushAllData() { return window.clearAndPushAllData && window.clearAndPushAllData(); }
        async function pullDataFromSupabase() { return window.pullDataFromSupabase && window.pullDataFromSupabase(); }

        function renderNav() {
            const nav = document.getElementById('bottomNav');
            nav.innerHTML = tabs.map(tab => `
                <button class="nav-item ${state.activeTab === tab.id ? 'active' : ''}" data-tab="${tab.id}" onclick="switchTab('${tab.id}')">
                    <span class="nav-icon">${tab.icon}</span>
                    <span>${tab.label}</span>
                </button>
            `).join('');
            try { positionGlobalSearchFab(); } catch { }
            try { setupBottomNavScroll(); } catch { }
        }

        function positionGlobalSearchFab() {
            const fab = document.getElementById('globalSearchFab');
            const nav = document.getElementById('bottomNav');
            if (!fab) return;
            let h = 0;
            if (nav) {
                const cs = window.getComputedStyle(nav);
                if (cs && cs.display !== 'none' && cs.visibility !== 'hidden') {
                    const rect = nav.getBoundingClientRect();
                    h = Math.max(0, Math.round(rect.height || 0));
                }
            }
            const gap = 16;
            const min = 72;
            const bottom = (h > 0 ? (h + gap) : min);
            fab.style.bottom = bottom + 'px';
        }

        try { window.addEventListener('resize', positionGlobalSearchFab); } catch { }

        function setupBottomNavScroll() {
            const nav = document.getElementById('bottomNav');
            if (!nav || nav.__scrollSetup) return;
            nav.__scrollSetup = true;
            const wheelHandler = (e) => {
                try {
                    const fine = window.matchMedia && window.matchMedia('(pointer: fine)').matches;
                    if (!fine) return;
                    const over = e.target && e.target.closest && e.target.closest('#bottomNav');
                    if (!over) return;
                    e.preventDefault();
                    const dx = (typeof e.deltaX === 'number') ? e.deltaX : 0;
                    const dy = (typeof e.deltaY === 'number') ? e.deltaY : (typeof e.wheelDelta === 'number' ? -e.wheelDelta : 0);
                    const amt = Math.abs(dx) > Math.abs(dy) ? dx : dy;
                    nav.scrollLeft += amt;
                } catch {}
            };
            nav.addEventListener('wheel', wheelHandler, { passive: false });
        }

        (function setupGlobalModalAccessibility() {
            try {
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        try { closeNoteModal(); } catch { }
                        try { closeInventoryModal(); } catch { }
                        try { closeCleanupModal(); } catch { }
                        try { closePdfViewer(); } catch { }
                        try { closeOfflineInfoModal && closeOfflineInfoModal(); } catch { }
                        try { closeFloatModal(); } catch { }
                        try { closeReportRangeModal(); } catch { }
                        try { closeExpensesReportRangeModal(); } catch { }
                    }
                });
            } catch { }
        })();

        (function setupGlobalSearchShortcut() {
            try {
                document.addEventListener('keydown', function (e) {
                    if (!e.altKey) return;
                    const k = String(e.key || '').toLowerCase();
                    if (k !== 's') return;
                    const t = e.target;
                    const tag = (t && t.tagName) || '';
                    if (t && (t.isContentEditable || tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT')) return;
                    const isMobile = (() => {
                        try {
                            return (window.matchMedia && window.matchMedia('(pointer: coarse)').matches) || /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent || '');
                        } catch { return false; }
                    })();
                    if (isMobile) return;
                    e.preventDefault();
                    try { openGlobalSearch(); } catch { }
                });
            } catch { }
        })();

        function openReportRangeModal() {
            const modal = document.getElementById('reportRangeModal');
            if (!modal) return;
            modal.classList.add('show');
            try { window.__updateModalOverflow && window.__updateModalOverflow(); } catch { }
            const handleOutside = (e) => { if (e.target === modal) { closeReportRangeModal(); } };
            modal.addEventListener('click', handleOutside, { once: true });
        }

        function closeReportRangeModal() {
            const modal = document.getElementById('reportRangeModal');
            if (modal) modal.classList.remove('show');
            try { window.__updateModalOverflow && window.__updateModalOverflow(); } catch { }
        }

        function openPushPreferencesModal() {
            const modal = document.getElementById('pushPreferencesModal');
            if (!modal) return;
            try { loadPushPreferences(); } catch {}
            const prefs = (window.state && window.state.pushPrefs) || {};
            try { document.getElementById('pushPrefMorning').checked = prefs.morning !== false; } catch {}
            try { document.getElementById('pushPrefEvening').checked = prefs.evening !== false; } catch {}
            try { document.getElementById('pushPrefBackup').checked = prefs.backup !== false; } catch {}
            try { document.getElementById('pushPrefDestructive').checked = prefs.destructive !== false; } catch {}
            modal.classList.add('show');
            try { window.__updateModalOverflow && window.__updateModalOverflow(); } catch { }
            const handleOutside = (e) => { if (e.target === modal) { closePushPreferencesModal(); } };
            modal.addEventListener('click', handleOutside, { once: true });
        }
        function closePushPreferencesModal() {
            const modal = document.getElementById('pushPreferencesModal');
            if (modal) modal.classList.remove('show');
            try { window.__updateModalOverflow && window.__updateModalOverflow(); } catch { }
        }

        function openExpensesReportRangeModal() {
            const modal = document.getElementById('expensesReportRangeModal');
            if (!modal) return;
            modal.classList.add('show');
            try { window.__updateModalOverflow && window.__updateModalOverflow(); } catch { }
            const handleOutside = (e) => { if (e.target === modal) { closeExpensesReportRangeModal(); } };
            modal.addEventListener('click', handleOutside, { once: true });
        }

        function closeExpensesReportRangeModal() {
            const modal = document.getElementById('expensesReportRangeModal');
            if (modal) modal.classList.remove('show');
            try { window.__updateModalOverflow && window.__updateModalOverflow(); } catch { }
        }

        function applyExpensesReportRange(mode) {
            const from = document.getElementById('expensesReportFromDate')?.value || '';
            const to = document.getElementById('expensesReportToDate')?.value || '';
            if (mode === 'selected') {
                if (!from && !to) { showToast('Please set a date range or use Download All', 'info'); return; }
                if (from && to) {
                    const f = new Date(from).getTime();
                    const t = new Date(to).getTime();
                    if (isNaN(f) || isNaN(t) || f > t) { showToast('Invalid date range', 'error'); return; }
                }
                closeExpensesReportRangeModal();
                downloadExpensesReportPDF(from || null, to || null);
            } else if (mode === 'all') {
                closeExpensesReportRangeModal();
                downloadExpensesReportPDF();
            }
        }

        function openIncomeReportRangeModal() {
            const modal = document.getElementById('incomeReportRangeModal');
            if (!modal) return;
            modal.classList.add('show');
            try { window.__updateModalOverflow && window.__updateModalOverflow(); } catch { }
            const handleOutside = (e) => { if (e.target === modal) { closeIncomeReportRangeModal(); } };
            modal.addEventListener('click', handleOutside, { once: true });
        }

        function closeIncomeReportRangeModal() {
            const modal = document.getElementById('incomeReportRangeModal');
            if (modal) modal.classList.remove('show');
            try { window.__updateModalOverflow && window.__updateModalOverflow(); } catch { }
        }

        function applyIncomeReportRange(mode) {
            const from = document.getElementById('incomeReportFromDate')?.value || '';
            const to = document.getElementById('incomeReportToDate')?.value || '';
            if (mode === 'selected') {
                if (!from && !to) { showToast('Please set a date range or use Download All', 'info'); return; }
                if (from && to) {
                    const f = new Date(from).getTime();
                    const t = new Date(to).getTime();
                    if (isNaN(f) || isNaN(t) || f > t) { showToast('Invalid date range', 'error'); return; }
                }
                closeIncomeReportRangeModal();
                downloadIncomeReportPDF(from || null, to || null);
            } else if (mode === 'all') {
                closeIncomeReportRangeModal();
                downloadIncomeReportPDF();
            }
        }

        function openTenPercentReportModal() {
            const modal = document.getElementById('tenPercentReportModal');
            if (!modal) return;
            modal.classList.add('show');
            try { window.__updateModalOverflow && window.__updateModalOverflow(); } catch { }
            try {
                const modeSel = document.getElementById('tenPercentReportMode');
                if (modeSel) modeSel.value = 'weeks';
                const weeksInp = document.getElementById('tenPercentWeeksCount');
                if (weeksInp) weeksInp.value = 1;
                toggleTenPercentWeeksInput();
            } catch { }
            const handleOutside = (e) => { if (e.target === modal) { closeTenPercentReportModal(); } };
            modal.addEventListener('click', handleOutside, { once: true });
        }

        function openTithingModal() {
            const modal = document.getElementById('tithingModal');
            if (!modal) return;
            modal.classList.add('show');
            try { window.__updateModalOverflow && window.__updateModalOverflow(); } catch {}
            const handleOutside = (e) => { if (e.target === modal) { closeTithingModal(); } };
            modal.addEventListener('click', handleOutside, { once: true });
            renderTithingModal();
        }
        function closeTithingModal() { const modal = document.getElementById('tithingModal'); if (modal) modal.classList.remove('show'); try { window.__updateModalOverflow && window.__updateModalOverflow(); } catch {} }
        function getMonthKey(d) { const dt = d || new Date(); return `${dt.getFullYear()}-${String(dt.getMonth() + 1).padStart(2, '0')}`; }
        function getMonthNameY(d) { return d.toLocaleString(undefined, { month: 'long' }) + ' ' + d.getFullYear(); }
        function isIncomeIncludedInTithing(i){ return !(i && (i.includeTithing === false || i.include_in_tithing === false)); }
        function ensureTithing(key) { const mk = String(key || getMonthKey()); const paidSales = (state.sales || []).filter(s => s.status !== 'unpaid' && String(s.date || '').slice(0, 7) === mk); const salesProfit = paidSales.reduce((sum, s) => sum + (Number(s.profit) || ((Number(s.totalPrice) || 0) - (Number(s.totalCost) || 0))), 0); const incomeTotal = (state.income || []).filter(i => String(i.date || '').slice(0, 7) === mk).filter(isIncomeIncludedInTithing).reduce((sum, i) => sum + (Number(i.amount) || 0), 0); const base = salesProfit + incomeTotal; const due = Math.max(0, base * 0.10); const rec = state.tithingRecords[mk] || { monthKey: mk, base, due, paid: 0, history: [] }; rec.base = base; rec.due = due; state.tithingRecords[mk] = rec; return rec; }
        function selectTithingMonth() { const sel = document.getElementById('titheMonthSelect'); const key = sel?.value; if (!key) return; state.tithingMonth = key; renderTithingModal(); saveData(); }
        function markTithingPaid() {
            const key = state.tithingMonth; const rec = ensureTithing(key); const now = new Date(); const amt = rec.due || 0; rec.paid = amt; rec.history = rec.history || []; rec.history.push({ date: now.toISOString(), amount: amt, month: key, status: 'PAID' });
            try {
                const exp = { id: generateID('expenses'), date: getTodayDateString(), time: now.toLocaleTimeString(), timestamp: now.getTime(), description: 'Tithing 10% Paid', category: 'Miscellaneous', amount: amt, payment: 'Cash', comment: 'Auto recorded', title: 'Tithing 10% Paid', updatedAt: now.getTime() };
                state.expenses.push(exp);
                saveData(); render();
                upsertOne('expenses', { date: exp.date, time: exp.time, timestamp: exp.timestamp, description: exp.description, category: exp.category, amount: exp.amount, payment: exp.payment, comment: exp.comment });
            } catch { }
            saveData(); try { upsertOne('tithing', { month_key: key, base: rec.base || 0, due: rec.due || 0, paid: rec.paid || 0, history: rec.history, updated_at: now.toISOString() }); } catch { }
            renderTithingModal(); showToast('Marked as Paid', 'success');
        }
        function recordTithingPartial() {
            const key = state.tithingMonth; const rec = ensureTithing(key); const amtStr = document.getElementById('tithePartialAmount')?.value || ''; const amt = parseMoney(amtStr) || 0; if (amt <= 0) return showToast('Enter valid amount', 'error'); const now = new Date(); rec.paid = Math.min(rec.due || 0, (rec.paid || 0) + amt); rec.history = rec.history || []; rec.history.push({ date: now.toISOString(), amount: amt, month: key, status: 'PARTIAL' });
            try {
                const exp = { id: generateID('expenses'), date: getTodayDateString(), time: now.toLocaleTimeString(), timestamp: now.getTime(), description: 'Tithing 10% Partial', category: 'Miscellaneous', amount: amt, payment: 'Cash', comment: 'Auto recorded partial', title: 'Tithing 10% Partial', updatedAt: now.getTime() };
                state.expenses.push(exp);
                saveData(); render();
                upsertOne('expenses', { date: exp.date, time: exp.time, timestamp: exp.timestamp, description: exp.description, category: exp.category, amount: exp.amount, payment: exp.payment, comment: exp.comment });
            } catch { }
            saveData(); try { upsertOne('tithing', { month_key: key, base: rec.base || 0, due: rec.due || 0, paid: rec.paid || 0, history: rec.history, updated_at: now.toISOString() }); } catch { }
            renderTithingModal(); showToast('Partial recorded', 'success');
        }
        function markTithingUnpaid() { const key = state.tithingMonth; const rec = ensureTithing(key); rec.paid = 0; rec.history.push({ date: new Date().toISOString(), amount: 0, month: key, status: 'UNPAID' }); saveData(); try { upsertOne('tithing', { month_key: key, base: rec.base || 0, due: rec.due || 0, paid: rec.paid || 0, history: rec.history, updated_at: new Date().toISOString() }); } catch { } renderTithingModal(); showToast('Marked as Unpaid', 'success'); }
        function resetTithingMonth() { if (!requireCapability('delete')) return; const key = state.tithingMonth; const rec = ensureTithing(key); rec.paid = 0; rec.history.push({ date: new Date().toISOString(), amount: 0, month: key, status: 'RESET' }); saveData(); try { upsertOne('tithing', { month_key: key, base: rec.base || 0, due: rec.due || 0, paid: rec.paid || 0, history: rec.history, updated_at: new Date().toISOString() }); } catch { } renderTithingModal(); showToast('Reset for month', 'success'); }
        function getLastMonths(n) { const arr = []; const d = new Date(); for (let i = 0; i < n; i++) { const dt = new Date(d.getFullYear(), d.getMonth() - i, 1); arr.push({ key: getMonthKey(dt), label: getMonthNameY(dt) }); } return arr; }
        function renderTithingModal() {
            const monthKey = state.tithingMonth; const dparts = monthKey.split('-'); const dt = new Date(Number(dparts[0]), Number(dparts[1]) - 1, 1); const monthLabel = getMonthNameY(dt); const rec = ensureTithing(monthKey); const due = rec.due || 0; const paid = rec.paid || 0; const remaining = Math.max(0, due - paid); const pct = due > 0 ? Math.min(100, Math.round((paid / due) * 100)) : 0; const mk = monthKey; const paidSales = (state.sales || []).filter(s => s.status !== 'unpaid' && String(s.date || '').slice(0, 7) === mk); const monthSalesProfit = paidSales.reduce((sum, s) => sum + (Number(s.profit) || ((Number(s.totalPrice) || 0) - (Number(s.totalCost) || 0))), 0); const monthIncome = (state.income || []).filter(i => String(i.date || '').slice(0, 7) === mk).filter(isIncomeIncludedInTithing).reduce((sum, i) => sum + (Number(i.amount) || 0), 0); const base = monthSalesProfit + monthIncome; const status = paid >= due ? '✅ Paid' : (paid > 0 ? '⚠ Partial' : '❌ Not Paid'); const currency = getCurrencySymbol(); const history = (rec.history || []).slice().reverse().map(h => `<div class=\"item\"><div class=\"item-header\"><span class=\"item-title\">${formatNumber(h.amount)} ${currency}</span><span class=\"badge\">${(new Date(h.date)).toLocaleString()}</span></div><div class=\"item-subtitle\">${h.status} • ${h.month}</div></div>`).join('') || '<div class=\"item-subtitle\">No history yet</div>'; const months = getLastMonths(12).map(m => `<option value=\"${m.key}\" ${m.key === monthKey ? 'selected' : ''}>${m.label}</option>`).join(''); const html = `
            <div class=\"modal-content\" style=\"max-width:720px;\">
                <button class=\"modal-close\" onclick=\"closeTithingModal()\">×</button>
                <div class=\"modal-title\">MONTHLY TITHING REPORT</div>
                <div class=\"stat-subvalue\" style=\"font-size:12px;opacity:0.85;margin-top:4px;\">${monthLabel}</div>
                <div class=\"card\" style=\"margin-top:8px;\">
                    <h3>Tithing Summary</h3>
                    <div class=\"info-row\"><span>Total Profit (sales)</span><span>${formatNumber(monthSalesProfit)} ${currency}</span></div>
                    <div class=\"info-row\"><span>Total Income</span><span>${formatNumber(monthIncome || 0)} ${currency}</span></div>
                    <div class=\"info-row\"><span>Combined Base</span><span>${formatNumber(base)} ${currency}</span></div>
                    <div class=\"info-row\"><span>10% Required</span><span>${formatNumber(due)} ${currency}</span></div>
                    <div class=\"info-row\"><span>Amount Paid</span><span>${formatNumber(paid)} ${currency}</span></div>
                    <div class=\"info-row\"><span>Remaining</span><span>${formatNumber(remaining)} ${currency}</span></div>
                </div>
                <div class=\"card\" style=\"margin-top:8px;\">
                    <h3>Payment Status</h3>
                    <div class=\"info-row\"><span>Status</span><span>${status}</span></div>
                <div class=\"tithe-progress\"><div class=\"tithe-bar\" style=\"width:${pct}%\"></div></div>
                </div>
                <div class=\"card\" style=\"margin-top:8px;\">
                    <h3>Month Selector</h3>
                    <select id=\"titheMonthSelect\" onchange=\"selectTithingMonth()\">${months}</select>
                </div>
                <div class=\"card\" style=\"margin-top:8px;\">
                    <h3>Payment Action</h3>
                    <div class=\"flex-gap\" style=\"flex-wrap:wrap;\">
                        <button class=\"btn-success\" onclick=\"markTithingPaid()\">Mark as Paid</button>
                        <button class=\"btn-secondary\" onclick=\"markTithingUnpaid()\">Mark as Unpaid</button>
                        <input type=\"text\" id=\"tithePartialAmount\" class=\"money-input\" placeholder=\"Partial amount\" style=\"max-width:160px;\">
                        <button class=\"btn-secondary\" onclick=\"recordTithingPartial()\">Record Partial Payment</button>
                        <button class=\"btn-danger\" onclick=\"resetTithingMonth()\">Reset for New Month</button>
                        <button class=\"btn-secondary\" onclick=\"closeTithingModal()\">Close</button>
                    </div>
                    <div class=\"stat-subvalue\" style=\"font-size:11px;opacity:0.7;margin-top:6px;\">“Giving faithfully increases peace, not loss.”</div>
                </div>
                <div class=\"card\" style=\"margin-top:8px;\">
                    <h3>History</h3>
                    <div style=\"max-height:180px;overflow:auto;\">${history}</div>
                </div>
                <div class=\"card\" style=\"margin-top:8px;\">
                    <h3>Month Selector</h3>
                    <select id=\"titheMonthSelect\" onchange=\"selectTithingMonth()\">${months}</select>
                </div>
            </div>`;
            document.getElementById('tithingModal').innerHTML = html;
        }

        function closeTenPercentReportModal() {
            const modal = document.getElementById('tenPercentReportModal');
            if (modal) modal.classList.remove('show');
            try { window.__updateModalOverflow && window.__updateModalOverflow(); } catch { }
        }

        function applyTenPercentReport() {
            const mode = document.getElementById('tenPercentReportMode')?.value || 'month';
            const weeksCount = parseInt(document.getElementById('tenPercentWeeksCount')?.value, 10) || 1;
            closeTenPercentReportModal();
            downloadTenPercentReportPDF(mode, weeksCount);
        }

        function toggleTenPercentWeeksInput() {
            const mode = document.getElementById('tenPercentReportMode')?.value;
            const wrap = document.getElementById('tenPercentWeeksWrap');
            if (!wrap) return;
            wrap.style.display = (mode === 'weeks') ? '' : 'none';
        }

        function applyReportRange(mode) {
            const from = document.getElementById('reportFromDate')?.value || '';
            const to = document.getElementById('reportToDate')?.value || '';
            const modeSel = document.getElementById('reportModeSelect')?.value || 'individual';
            window.reportMode = modeSel;
            if (mode === 'selected') {
                if (!from && !to) { showToast('Please set a date range or use Download All', 'info'); return; }
                if (from && to) {
                    const f = new Date(from).getTime();
                    const t = new Date(to).getTime();
                    if (isNaN(f) || isNaN(t) || f > t) { showToast('Invalid date range', 'error'); return; }
                }
                closeReportRangeModal();
                downloadSalesReportPDF(from || null, to || null, modeSel);
            } else if (mode === 'all') {
                closeReportRangeModal();
                downloadSalesReportPDF(null, null, modeSel);
            }
        }
        function applyReportExcel() {
            try {
                const modeSel = document.getElementById('reportModeSelect')?.value || 'individual';
                window.reportMode = modeSel;
                closeReportRangeModal();
                if (typeof downloadSalesReportExcelMode === 'function') {
                    downloadSalesReportExcelMode(modeSel);
                } else {
                    downloadSalesReportExcel();
                }
            } catch {}
        }



        function openStocksheetModal() {
            ensureStocksheetModal();
            const modal = document.getElementById('stocksheetModal');
            if (!modal) return;
            modal.classList.add('show');
            try { window.__updateModalOverflow && window.__updateModalOverflow(); } catch { }
            if (modal.__outsideClickHandler) {
                modal.removeEventListener('click', modal.__outsideClickHandler);
            }
            modal.__outsideClickHandler = (e) => { if (e.target === modal) { closeStocksheetModal(); } };
            modal.addEventListener('click', modal.__outsideClickHandler);
            chooseStocksheetMode('product');
        }

        function ensureStocksheetModal() {
            let modal = document.getElementById('stocksheetModal');
            if (modal) return;
            modal = document.createElement('div');
            modal.className = 'modal';
            modal.id = 'stocksheetModal';
            modal.innerHTML = `
                <div class="modal-content">
                    <button class="modal-close" onclick="closeStocksheetModal()">×</button>
                    <div class="modal-title">Stock Sheet (PDF)</div>
                    <div style="margin-top:8px;">
                        <div class="grid-2" style="gap:8px;">
                            <div>
                                <label class="stocksheet-source-label">Source</label>
                                <div class="flex-gap" style="padding:4px 0;">
                                    <button class="btn-small stocksheet-src-btn" id="stocksheetSrcProduct" onclick="chooseStocksheetMode('product')">From product</button>
                                    <button class="btn-small btn-secondary stocksheet-src-btn" id="stocksheetSrcEmpty" onclick="chooseStocksheetMode('empty')">Empty Rows</button>
                                    <button class="btn-small btn-secondary stocksheet-src-btn" id="stocksheetSrcEmptyCat" onclick="chooseStocksheetMode('empty_categories')">Empty by Categories</button>
                                </div>
                            </div>
                            <div id="stocksheetRowsWrap">
                                <label>Rows</label>
                                <input type="number" id="stocksheetEmptyRows" min="1" max="500" value="10" />
                            </div>
                            <div id="stocksheetRowsPerCatWrap" style="display:none;">
                                <label>Rows per category</label>
                                <input type="number" id="stocksheetEmptyRowsPerCat" min="1" max="500" value="10" />
                            </div>
                            <div id="stocksheetCategorySelectWrap" style="display:none;">
                                <label>Choose categories</label>
                                <div class="grid-2" style="gap:8px; align-items:start;">
                                    <div class="card" style="max-height:180px; overflow:auto;">
                                        <div style="display:flex;justify-content:space-between;align-items:center;">
                                            <strong>Product Categories</strong>
                                            <div class="flex-gap">
                                                <button class="btn-small" onclick="toggleSelectAllStocksheetCats('product', true)">Select All</button>
                                                <button class="btn-small btn-secondary" onclick="toggleSelectAllStocksheetCats('product', false)">Clear</button>
                                            </div>
                                        </div>
                                        <div id="stocksheetProductCats" style="margin-top:6px;"></div>
                                    </div>
                                    <div class="card" style="max-height:180px; overflow:auto;">
                                        <div style="display:flex;justify-content:space-between;align-items:center;">
                                            <strong>Service Categories</strong>
                                            <div class="flex-gap">
                                                <button class="btn-small" onclick="toggleSelectAllStocksheetCats('service', true)">Select All</button>
                                                <button class="btn-small btn-secondary" onclick="toggleSelectAllStocksheetCats('service', false)">Clear</button>
                                            </div>
                                        </div>
                                        <div id="stocksheetServiceCats" style="margin-top:6px;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="flex-gap" style="margin-top:12px;">
                        <button class="btn-small" onclick="applyStocksheetOptions()">Download</button>
                        <button class="btn-secondary btn-small" onclick="closeStocksheetModal()">Cancel</button>
                        <button class="btn-secondary btn-small" onclick="closeStocksheetModal()">Exit</button>
                    </div>
                </div>`;
            document.body.appendChild(modal);
        }

        function ensureCommissionModal() {
            let modal = document.getElementById('commissionModal');
            if (modal) return;
            modal = document.createElement('div');
            modal.className = 'modal';
            modal.id = 'commissionModal';
            modal.innerHTML = `
                <div class="modal-content">
                    <button class="modal-close" onclick="closeCommissionModal()">×</button>
                    <div class="modal-title">Add Monthly Commission</div>
                    <div class="card" style="margin-top:8px;">
                        <div class="form-group">
                            <label>Channel</label>
                            <select id="commissionChannel">
                                <option value="mpesa">M-Pesa</option>
                                <option value="crdb">CRDB</option>
                                <option value="nmb">NMB</option>
                                <option value="airtel">Airtel Money</option>
                                <option value="halopesa">Halopesa</option>
                                <option value="yas">Yas Tanzania</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Apply To</label>
                            <select id="commissionTarget">
                                <option value="account">Account Float</option>
                                <option value="cash">Cash Float</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Commission Amount</label>
                            <input type="text" id="commissionAmount" class="money-input" placeholder="0">
                        </div>
                        <div class="flex-gap" style="margin-top:8px;">
                            <button class="btn-small" onclick="submitCommission()">Save Commission</button>
                            <button class="btn-small btn-danger" onclick="closeCommissionModal()">Cancel</button>
                        </div>
                    </div>
                </div>`;
            document.body.appendChild(modal);
        }

        function openCommissionModal() {
            if (!canUpsertTable('transaction_commissions')) { showToast('Not permitted', 'error'); return; }
            ensureCommissionModal();
            const modal = document.getElementById('commissionModal');
            if (modal) modal.classList.add('show');
            try { window.__updateModalOverflow && window.__updateModalOverflow(); } catch { }
            try {
                const ch = document.getElementById('commissionChannel');
                const tg = document.getElementById('commissionTarget');
                const amt = document.getElementById('commissionAmount');
                if (ch && !ch.__searchableApplied) makeSearchableDropdown(ch);
                if (tg && !tg.__searchableApplied) makeSearchableDropdown(tg);
                if (amt) attachMoneyFormatter(amt);
            } catch { }
            if (modal.__outsideClickHandler) modal.removeEventListener('click', modal.__outsideClickHandler);
            modal.__outsideClickHandler = (e) => { if (e.target === modal) { closeCommissionModal(); } };
            modal.addEventListener('click', modal.__outsideClickHandler);
        }

        function closeCommissionModal() {
            const modal = document.getElementById('commissionModal');
            if (modal) modal.classList.remove('show');
            try { window.__updateModalOverflow && window.__updateModalOverflow(); } catch { }
        }

        function resetCommissionFormDefaults() {
            const ch = document.getElementById('commissionChannel');
            const tg = document.getElementById('commissionTarget');
            const amt = document.getElementById('commissionAmount');
            if (ch) ch.value = 'mpesa';
            if (tg) tg.value = 'account';
            if (amt) {
                amt.value = '';
                try { attachMoneyFormatter(amt); } catch { }
            }
        }

        async function startCommissionEdit(ts) {
            try {
                const hasPin = !!(state && state.securityPinHash);
                if (!hasPin && typeof requirePinForDestructive === 'function') {
                    const ok = await requirePinForDestructive('edit');
                    if (!ok) return;
                }
            } catch {}
            const c = (state.commissions || []).find(x => x.timestamp === ts);
            if (!c) { showToast('Commission not found', 'error'); return; }
            state.isCommissionEditing = true;
            state.currentCommissionTs = ts;
            const hist = document.getElementById('commissionHistoryModal');
            if (hist) { hist.classList.remove('show'); try { window.__updateModalOverflow && window.__updateModalOverflow(); } catch { } }
            openCommissionModal();
            const ch = document.getElementById('commissionChannel');
            const tg = document.getElementById('commissionTarget');
            const amt = document.getElementById('commissionAmount');
            if (ch) ch.value = c.channel || 'mpesa';
            if (tg) tg.value = c.target || 'account';
            if (amt) {
                amt.value = formatMoney(c.amount || 0);
                try { attachMoneyFormatter(amt); } catch { }
                try { amt.focus(); } catch { }
            }
        }

        function ensureCommissionHistoryModal() {
            let modal = document.getElementById('commissionHistoryModal');
            if (modal) return;
            modal = document.createElement('div');
            modal.className = 'modal';
            modal.id = 'commissionHistoryModal';
            modal.innerHTML = `
                <div class="modal-content">
                    <button class="modal-close" onclick="closeCommissionHistoryModal()">×</button>
                    <div class="modal-title">Commission History</div>
                    <div class="card" style="margin-top:8px;">
                        <div class="flex-gap" style="align-items:center;">
                            <span class="badge">Total: <span id="commissionHistoryTotal">0 Tsh</span></span>
                        </div>
                        <div id="commissionHistoryList" style="margin-top:8px; max-height:50vh; overflow:auto; border:1px solid rgba(0,0,0,0.12); border-radius:8px;"></div>
                    </div>
                    <div class="flex-gap" style="margin-top:12px;">
                        <button class="btn-small btn-secondary" onclick="closeCommissionHistoryModal()">Close</button>
                    </div>
                </div>`;
            document.body.appendChild(modal);
        }

        function openCommissionHistoryModal() {
            ensureCommissionHistoryModal();
            const modal = document.getElementById('commissionHistoryModal');
            if (modal) modal.classList.add('show');
            try { window.__updateModalOverflow && window.__updateModalOverflow(); } catch { }
            renderCommissionHistory();
            if (modal.__outsideClickHandler) modal.removeEventListener('click', modal.__outsideClickHandler);
            modal.__outsideClickHandler = (e) => { if (e.target === modal) { closeCommissionHistoryModal(); } };
            modal.addEventListener('click', modal.__outsideClickHandler);
        }

        function closeCommissionHistoryModal() {
            const modal = document.getElementById('commissionHistoryModal');
            if (modal) modal.classList.remove('show');
            try { window.__updateModalOverflow && window.__updateModalOverflow(); } catch { }
        }

        function renderCommissionHistory() {
            const list = document.getElementById('commissionHistoryList');
            const totalEl = document.getElementById('commissionHistoryTotal');
            const rows = (state.commissions || []).slice().sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
            const html = rows.length ? rows.map(c => `
                <div style="display:grid; grid-template-columns: 1fr auto; gap:12px; align-items:start; padding:12px; border-bottom:1px solid rgba(0,0,0,0.08); word-wrap: break-word; overflow-wrap: break-word;">
                    <div style="min-width:0; overflow:hidden;">
                        <div style="font-weight:600; word-wrap:break-word; white-space:normal;">${(c.channel || '').toUpperCase()} — ${c.target === 'cash' ? 'Cash' : 'Account'}</div>
                        <div style="font-size:12px;color:#666; word-wrap:break-word; white-space:normal;">${c.date || ''} ${c.time || ''}</div>
                    </div>
                    <div style="display:flex; flex-direction:column; align-items:flex-end; gap:6px; white-space:nowrap;">
                        <div style="font-weight:600; min-width:100px; text-align:right;">${formatNumber(c.amount || 0)} Tsh</div>
                        <div style="display:flex; gap:4px; flex-wrap:wrap; justify-content:flex-end;">
                            <button class="btn-small" style="font-size:11px; padding:4px 8px; white-space:nowrap;" onclick="startCommissionEdit(${c.timestamp})">Edit</button>
                            <button class="btn-small btn-danger" style="font-size:11px; padding:4px 8px; white-space:nowrap;" onclick="deleteCommissionByTimestamp(${c.timestamp})">Delete</button>
                        </div>
                    </div>
                </div>
            `).join('') : '<div style="padding:12px;color:#666;">No commission records yet</div>';
            if (list) list.innerHTML = html;
            const total = rows.reduce((sum, c) => sum + (c.amount || 0), 0);
            if (totalEl) totalEl.textContent = `${formatNumber(total)} Tsh`;
        }

        function ensureCommissionEditModal() {
            let modal = document.getElementById('commissionEditModal');
            if (modal) return;
            modal = document.createElement('div');
            modal.className = 'modal';
            modal.id = 'commissionEditModal';
            modal.innerHTML = `
                <div class="modal-content">
                    <button class="modal-close" onclick="closeCommissionEditModal()">×</button>
                    <div class="modal-title">Edit Commission</div>
                    <div class="card" style="margin-top:8px;">
                        <div class="form-group">
                            <label>Channel</label>
                            <select id="commissionEditChannel">
                                <option value="mpesa">M-Pesa</option>
                                <option value="crdb">CRDB</option>
                                <option value="nmb">NMB</option>
                                <option value="airtel">Airtel Money</option>
                                <option value="halopesa">Halopesa</option>
                                <option value="yas">Yas Tanzania</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Apply To</label>
                            <select id="commissionEditTarget">
                                <option value="account">Account Float</option>
                                <option value="cash">Cash Float</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Commission Amount</label>
                            <input type="text" id="commissionEditAmount" class="money-input" placeholder="0">
                        </div>
                        <div class="flex-gap" style="margin-top:8px;">
                            <button class="btn-small" onclick="submitCommissionEdit()">Save Changes</button>
                            <button class="btn-small btn-danger" onclick="closeCommissionEditModal()">Cancel</button>
                        </div>
                    </div>
                </div>`;
            document.body.appendChild(modal);
        }

        async function openCommissionEditModal(ts) {
            try {
                const hasPin = !!(state && state.securityPinHash);
                if (!hasPin && typeof requirePinForDestructive === 'function') {
                    const ok = await requirePinForDestructive('edit');
                    if (!ok) return;
                }
            } catch {}
            ensureCommissionEditModal();
            state.currentCommissionTs = ts;
            const modal = document.getElementById('commissionEditModal');
            const c = (state.commissions || []).find(x => x.timestamp === ts);
            if (!c) { showToast('Commission not found', 'error'); return; }
            const ch = document.getElementById('commissionEditChannel');
            const tg = document.getElementById('commissionEditTarget');
            const amt = document.getElementById('commissionEditAmount');
            if (ch) ch.value = c.channel || 'mpesa';
            if (tg) tg.value = c.target || 'account';
            if (amt) amt.value = formatMoney(c.amount || 0);
            try {
                if (ch && !ch.__searchableApplied) makeSearchableDropdown(ch);
                if (tg && !tg.__searchableApplied) makeSearchableDropdown(tg);
                if (amt) attachMoneyFormatter(amt);
            } catch { }
            if (modal) modal.classList.add('show');
            try { window.__updateModalOverflow && window.__updateModalOverflow(); } catch { }
            if (modal.__outsideClickHandler) modal.removeEventListener('click', modal.__outsideClickHandler);
            modal.__outsideClickHandler = (e) => { if (e.target === modal) { closeCommissionEditModal(); } };
            modal.addEventListener('click', modal.__outsideClickHandler);
        }

        function closeCommissionEditModal() {
            const modal = document.getElementById('commissionEditModal');
            if (modal) modal.classList.remove('show');
            try { window.__updateModalOverflow && window.__updateModalOverflow(); } catch { }
        }

        async function submitCommissionEdit() {
            if (!canUpsertTable('transaction_commissions')) { showToast('Not permitted', 'error'); return; }
            const ts = state.currentCommissionTs;
            const idx = (state.commissions || []).findIndex(x => x.timestamp === ts);
            if (idx === -1) { showToast('Commission not found', 'error'); return; }
            const old = state.commissions[idx];
            const oldChannelBefore = old.channel;
            const oldTargetBefore = old.target;
            const oldAmountBefore = old.amount;
            const chEl = document.getElementById('commissionEditChannel');
            const tgEl = document.getElementById('commissionEditTarget');
            const amtEl = document.getElementById('commissionEditAmount');
            const newChannel = chEl?.value || old.channel || 'mpesa';
            const newTarget = tgEl?.value || old.target || 'account';
            const newAmount = parseMoney(amtEl?.value || String(old.amount || 0));
            if (isNaN(newAmount) || newAmount <= 0) { showToast('Enter a valid amount', 'error'); return; }

            const fOld = state.transactionFloats[oldChannelBefore] || (state.transactionFloats[oldChannelBefore] = { initialAccount: 0, initialCash: 0 });
            if (oldTargetBefore === 'cash') { fOld.initialCash = (fOld.initialCash || 0) - (oldAmountBefore || 0); } else { fOld.initialAccount = (fOld.initialAccount || 0) - (oldAmountBefore || 0); }

            const fNew = state.transactionFloats[newChannel] || (state.transactionFloats[newChannel] = { initialAccount: 0, initialCash: 0 });
            if (newTarget === 'cash') { fNew.initialCash = (fNew.initialCash || 0) + newAmount; } else { fNew.initialAccount = (fNew.initialAccount || 0) + newAmount; }

            old.channel = newChannel;
            old.target = newTarget;
            old.amount = newAmount;

            calculateFloatBalances();
            saveData();
            try { backupTransactionFloats(); } catch { }
            showToast('Commission updated', 'success');
            closeCommissionEditModal();
            renderCommissionHistory();
            try { render(); } catch { }
            try {
                if (syncEnabled && currentUser) {
                    await upsertOne('transaction_commissions', { channel: old.channel, target: old.target, amount: old.amount, date: old.date, time: old.time, timestamp: old.timestamp });
                    const fPayloadOld = { channel: oldChannelBefore, initial_account_float: (state.transactionFloats[oldChannelBefore]?.initialAccount || 0), initial_cash_float: (state.transactionFloats[oldChannelBefore]?.initialCash || 0) };
                    await upsertOne('transaction_floats', fPayloadOld);
                    const fPayloadNew = { channel: newChannel, initial_account_float: (state.transactionFloats[newChannel]?.initialAccount || 0), initial_cash_float: (state.transactionFloats[newChannel]?.initialCash || 0) };
                    await upsertOne('transaction_floats', fPayloadNew);
                }
            } catch { }
        }

        async function deleteCommissionByTimestamp(ts) {
            if (!requireCapability('delete')) { return; }
            const pinOk = await requirePinForDestructive('delete');
            if (!pinOk) { showToast('Delete failed: PIN required', 'error'); return; }
            const idx = (state.commissions || []).findIndex(x => x.timestamp === ts);
            if (idx === -1) { showToast('Commission not found', 'error'); return; }
            const c = state.commissions[idx];
            const f = state.transactionFloats[c.channel] || (state.transactionFloats[c.channel] = { initialAccount: 0, initialCash: 0 });
            if (c.target === 'cash') { f.initialCash = (f.initialCash || 0) - (c.amount || 0); } else { f.initialAccount = (f.initialAccount || 0) - (c.amount || 0); }
            state.commissions.splice(idx, 1);
            calculateFloatBalances();
            saveData();
            try { backupTransactionFloats(); } catch { }
            renderCommissionHistory();
            try { render(); } catch { }
            showToast('Commission deleted', 'success');

            // Auto-sync to cloud immediately
            if (syncEnabled && currentUser) {
                try {
                    // Delete from transaction_commissions table
                    await deleteOne('transaction_commissions', { timestamp: ts });
                    // Update transaction floats in cloud
                    const fPayload = {
                        channel: c.channel,
                        initial_account_float: (f.initialAccount || 0),
                        initial_cash_float: (f.initialCash || 0)
                    };
                    await upsertOne('transaction_floats', fPayload);
                } catch (syncError) {
                    console.error('Sync error on commission delete:', syncError);
                    // Retry sync in background
                    try { syncInBackground(); } catch { }
                }
            }
        }

        async function submitCommission() {
            if (!canUpsertTable('transaction_commissions')) { showToast('Not permitted', 'error'); return; }
            const chEl = document.getElementById('commissionChannel');
            const tgEl = document.getElementById('commissionTarget');
            const amtEl = document.getElementById('commissionAmount');
            const channel = chEl?.value || 'mpesa';
            const target = tgEl?.value || 'account';
            const amount = parseMoney(amtEl?.value || '0');
            if (isNaN(amount) || amount <= 0) { showToast('Enter a valid amount', 'error'); return; }

            if (state.isCommissionEditing && state.currentCommissionTs) {
                const idx = (state.commissions || []).findIndex(x => x.timestamp === state.currentCommissionTs);
                if (idx === -1) { showToast('Commission not found', 'error'); state.isCommissionEditing = false; state.currentCommissionTs = null; return; }
                const old = state.commissions[idx];
                const oldChannelBefore = old.channel;
                const oldTargetBefore = old.target;
                const oldAmountBefore = old.amount;
                const fOld = state.transactionFloats[oldChannelBefore] || (state.transactionFloats[oldChannelBefore] = { initialAccount: 0, initialCash: 0 });
                if (oldTargetBefore === 'cash') { fOld.initialCash = (fOld.initialCash || 0) - (oldAmountBefore || 0); } else { fOld.initialAccount = (fOld.initialAccount || 0) - (oldAmountBefore || 0); }
                const fNew = state.transactionFloats[channel] || (state.transactionFloats[channel] = { initialAccount: 0, initialCash: 0 });
                if (target === 'cash') { fNew.initialCash = (fNew.initialCash || 0) + amount; } else { fNew.initialAccount = (fNew.initialAccount || 0) + amount; }
                old.channel = channel;
                old.target = target;
                old.amount = amount;
                calculateFloatBalances();
                saveData();
                try { backupTransactionFloats(); } catch { }
                state.isCommissionEditing = false;
                state.currentCommissionTs = null;
                resetCommissionFormDefaults();
                try { closeCommissionModal(); } catch { }
                showToast('Commission updated', 'success');

                // Auto-sync to cloud immediately
                if (syncEnabled && currentUser) {
                    try {
                        await upsertOne('transaction_commissions', { channel: old.channel, target: old.target, amount: old.amount, date: old.date, time: old.time, timestamp: old.timestamp });
                        const fPayloadOld = { channel: oldChannelBefore, initial_account_float: (state.transactionFloats[oldChannelBefore]?.initialAccount || 0), initial_cash_float: (state.transactionFloats[oldChannelBefore]?.initialCash || 0) };
                        await upsertOne('transaction_floats', fPayloadOld);
                        const fPayloadNew = { channel: channel, initial_account_float: (state.transactionFloats[channel]?.initialAccount || 0), initial_cash_float: (state.transactionFloats[channel]?.initialCash || 0) };
                        await upsertOne('transaction_floats', fPayloadNew);
                    } catch (syncError) {
                        console.error('Sync error on commission update:', syncError);
                        try { syncInBackground(); } catch { }
                    }
                }
                try { render(); } catch { }
                return;
            }

            const f = state.transactionFloats[channel] || (state.transactionFloats[channel] = { initialAccount: 0, initialCash: 0 });
            if (target === 'cash') { f.initialCash = (f.initialCash || 0) + amount; } else { f.initialAccount = (f.initialAccount || 0) + amount; }
            const now = new Date();
            const rec = { channel, target, amount, date: getTodayDateString(), time: now.toLocaleTimeString(), timestamp: Date.now() };
            state.commissions = state.commissions || [];
            state.commissions.push(rec);
            calculateFloatBalances();
            saveData();
            try { backupTransactionFloats(); } catch { }
            resetCommissionFormDefaults();
            try { closeCommissionModal(); } catch { }
            showToast('Commission added', 'success');

            // Auto-sync to cloud immediately
            if (syncEnabled && currentUser) {
                try {
                    const payload = { channel };
                    if (target === 'cash') payload.initial_cash_float = f.initialCash || 0; else payload.initial_account_float = f.initialAccount || 0;
                    await upsertOne('transaction_floats', payload);
                    await upsertOne('transaction_commissions', { channel, target, amount, date: rec.date, time: rec.time, timestamp: rec.timestamp });
                } catch (syncError) {
                    console.error('Sync error on commission add:', syncError);
                    try { syncInBackground(); } catch { }
                }
            }
            try { render(); } catch { }
        }

        function ensureInventoryPurchasesImportModal() {
            let modal = document.getElementById('invPurchasesImportModal');
            if (modal) return;
            modal = document.createElement('div');
            modal.className = 'modal';
            modal.id = 'invPurchasesImportModal';
            modal.innerHTML = `
                <div class="modal-content">
                    <button class="modal-close" onclick="closeInventoryPurchasesImportModal()">×</button>
                    <div class="modal-title">Import Inventory Purchases (CSV)</div>
                    <div class="card" style="margin-top:8px;">
                        <div class="flex-gap" style="margin-top:8px;align-items:center;flex-wrap:wrap;gap:8px;">
                            <input type="file" id="invPurchasesCSVFile" accept=".csv" />
                            <button class="btn-small" onclick="downloadInventoryPurchasesTemplate()">⬇️ Download Template (with your products)</button>
                            <button class="btn-small" onclick="startInventoryPurchasesCSVImport()">Import</button>
                            <button class="btn-small btn-danger" onclick="closeInventoryPurchasesImportModal()">Cancel</button>
                        </div>
                        <div style="font-size:13px;color:#666;">CSV headers: <strong>product_name</strong>, <strong>quantity</strong>, <strong>cost</strong>, <strong>date</strong> (optional), <strong>time</strong> (optional), <strong>category</strong> (optional), <strong>price</strong> (optional), <strong>type</strong> (optional: product/service), <strong>min_alert</strong> (optional), <strong>period_title</strong> (optional), <strong>period_number</strong> (optional), <strong>discount</strong> (optional), <strong>supplier_name</strong> (optional), <strong>supplier_phone</strong> (optional), <strong>supplier_address</strong> (optional), <strong>notes</strong> (optional)</div>
                        <div style="font-size:12px;color:#666;line-height:1.6;">
                            <ul style="margin:6px 0 0 16px;">
                                <li><strong>Required:</strong> product_name, quantity, cost</li>
                                <li><strong>Optional:</strong> date, time, category, price</li>
                                <li>When <strong>product_name</strong> is not found and <strong>category</strong> is provided, a new product is created automatically (Name Title Case, Category UPPERCASE)</li>
                                <li>New product <strong>price</strong> defaults to <strong>cost</strong> if omitted</li>
                                <li><strong>period_number</strong> links to an existing period; if none provided, the latest period is used or a new one is created using <strong>period_title</strong> or month/year</li>
                                <li><strong>type</strong> = service will create the product without stock and skip inventory update</li>
                                <li><strong>min_alert</strong> sets the stock alert threshold for the inventory record (default 5)</li>
                                <li><strong>discount</strong> reduces the total cost: total = (quantity × cost) − discount (not below 0)</li>
                                <li>Optional supplier/contact fields are stored with each purchase</li>
                                <li><strong>quantity</strong> &gt; 0 increases stock; purchase period is auto-created if none exists</li>
                                <li>Invalid rows are skipped; summary is shown at the end</li>
                            </ul>
                        </div>
                        <div id="invPurchasesCSVStatus" style="margin-top:8px;font-size:12px;color:#666;"></div>
                    </div>
                </div>`;
            document.body.appendChild(modal);
        }

        function openInventoryPurchasesImportModal() {
            ensureInventoryPurchasesImportModal();
            const modal = document.getElementById('invPurchasesImportModal');
            if (modal) modal.classList.add('show');
            try { window.__updateModalOverflow && window.__updateModalOverflow(); } catch { }
            if (modal.__outsideClickHandler) modal.removeEventListener('click', modal.__outsideClickHandler);
            modal.__outsideClickHandler = (e) => { if (e.target === modal) { closeInventoryPurchasesImportModal(); } };
            modal.addEventListener('click', modal.__outsideClickHandler);
        }

        function closeInventoryPurchasesImportModal() {
            const modal = document.getElementById('invPurchasesImportModal');
            if (modal) modal.classList.remove('show');
            try { window.__updateModalOverflow && window.__updateModalOverflow(); } catch { }
        }

        async function startInventoryPurchasesCSVImport() {
            const fileInput = document.getElementById('invPurchasesCSVFile');
            const status = document.getElementById('invPurchasesCSVStatus');
            if (!fileInput || !fileInput.files || fileInput.files.length === 0) { showToast('Select a CSV file', 'error'); return; }
            const file = fileInput.files[0];
            try { closeInventoryPurchasesImportModal(); showToast('Import started', 'info'); } catch { }
            const reader = new FileReader();
            reader.onload = async function (e) {
                const text = String(e.target.result || '');
                const lines = text.split(/\r?\n/).filter(l => l.trim().length > 0);
                if (lines.length < 2) { showToast('CSV has no data', 'error'); return; }
                const header = parseCSVLine(lines[0]).map(h => h.toLowerCase());
                const idx = {
                    product_name: header.indexOf('product_name'),
                    category: header.indexOf('category'),
                    quantity: header.indexOf('quantity'),
                    cost: header.indexOf('cost'),
                    date: header.indexOf('date'),
                    time: header.indexOf('time'),
                    price: header.indexOf('price'),
                    period_title: header.indexOf('period_title'),
                    period_number: header.indexOf('period_number'),
                    type: header.indexOf('type'),
                    min_alert: header.indexOf('min_alert'),
                    discount: header.indexOf('discount'),
                    supplier_name: header.indexOf('supplier_name'),
                    supplier_phone: header.indexOf('supplier_phone'),
                    supplier_address: header.indexOf('supplier_address'),
                    notes: header.indexOf('notes')
                };
                if (idx.product_name < 0 || idx.quantity < 0 || idx.cost < 0) {
                    showToast('Missing required headers', 'error');
                    return;
                }
                const total = lines.length - 1;
                let imported = 0;
                const skipped = [];
                const todayStr = getTodayDateString();
                const productsByName = new Map((state.products || []).map(p => [String(p.name || '').toLowerCase(), p]));
                for (let start = 1; start < lines.length; start += 25) {
                    const end = Math.min(lines.length, start + 25);
                    for (let k = start; k < end; k++) {
                        const row = parseCSVLine(lines[k]);
                        const nameRaw = row[idx.product_name] || '';
                        const qtyRaw = row[idx.quantity] || '';
                        const costRaw = row[idx.cost] || '';
                        const dateRaw = idx.date >= 0 ? (row[idx.date] || '') : '';
                        const timeRaw = idx.time >= 0 ? (row[idx.time] || '') : '';
                        const key = String(nameRaw).trim().toLowerCase();
                        let product = productsByName.get(key);
                        if (!product) {
                            const nameNorm = toTitleCase(String(nameRaw).trim());
                            const catRaw = idx.category >= 0 ? (row[idx.category] || '') : '';
                            const categoryNorm = toCategoryCase(String(catRaw).trim());
                            if (!nameNorm || !categoryNorm) { skipped.push({ name: nameRaw || '(blank)', reason: 'unknown product; category required to create' }); continue; }
                            const unitCostForProduct = parseFloat(costRaw);
                            const priceRaw = idx.price >= 0 ? (row[idx.price] || '') : '';
                            let initialPrice = parseFloat(priceRaw);
                            if (isNaN(initialPrice) || initialPrice < 0) initialPrice = unitCostForProduct;
                            const typeRaw = idx.type >= 0 ? String(row[idx.type] || '').toLowerCase() : '';
                            const isService = (typeRaw === 'service');
                            const newProd = { id: generateID('products'), name: nameNorm, category: categoryNorm, cost: unitCostForProduct || 0, price: initialPrice || 0, hasStock: !isService };
                            state.products = state.products || [];
                            state.products.push(newProd);
                            if (!state.categories.includes(categoryNorm)) state.categories.push(categoryNorm);
                            state.inventory = state.inventory || {};
                            const minAlertRaw = idx.min_alert >= 0 ? (row[idx.min_alert] || '') : '';
                            const minAlertVal = Math.max(0, parseInt(minAlertRaw || '5', 10) || 5);
                            if (!isService) {
                                state.inventory[nameNorm] = state.inventory[nameNorm] || { stock: 0, minAlert: minAlertVal };
                                state.inventory[nameNorm].minAlert = minAlertVal;
                            }
                            try {
                                if (syncEnabled) {
                                    await upsertOne('products', { name: newProd.name, category: newProd.category || '', cost: newProd.cost || 0, price: newProd.price || 0, has_stock: true });
                                    await upsertOne('categories', { name: newProd.category });
                                    if (!isService) {
                                        const inv = state.inventory[newProd.name] || { stock: 0, minAlert: minAlertVal };
                                        await upsertOne('inventory', { product_name: newProd.name, stock: inv.stock || 0, min_alert: inv.minAlert || 5 });
                                    }
                                }
                            } catch {}
                            productsByName.set(key, newProd);
                            product = newProd;
                        }
                        const supplierNameRaw = idx.supplier_name >= 0 ? (row[idx.supplier_name] || '') : '';
                        const supplierPhoneRaw = idx.supplier_phone >= 0 ? (row[idx.supplier_phone] || '') : '';
                        const supplierAddressRaw = idx.supplier_address >= 0 ? (row[idx.supplier_address] || '') : '';
                        const notesRaw = idx.notes >= 0 ? (row[idx.notes] || '') : '';
                        const quantity = parseFloat(qtyRaw);
                        const unitCost = parseFloat(costRaw);
                        if (isNaN(quantity) || quantity <= 0) { skipped.push({ name: product.name, reason: 'invalid quantity' }); continue; }
                        if (isNaN(unitCost) || unitCost < 0) { skipped.push({ name: product.name, reason: 'invalid cost' }); continue; }
                        const purchaseDate = (dateRaw && dateRaw.trim()) ? dateRaw.trim() : todayStr;
                        const time = (timeRaw && timeRaw.trim()) ? timeRaw.trim() : new Date().toISOString().slice(11, 16);
                        const periodTitleRaw = idx.period_title >= 0 ? (row[idx.period_title] || '') : '';
                        const periodNumberRaw = idx.period_number >= 0 ? (row[idx.period_number] || '') : '';
                        const discountRaw = idx.discount >= 0 ? (row[idx.discount] || '') : '';
                        const discountVal = Math.max(0, parseFloat(discountRaw || '0') || 0);
                        const totalCost = Math.max(0, (quantity * unitCost) - discountVal);
                        let cycleNumber = null;
                        if (periodNumberRaw) {
                            const desired = parseInt(periodNumberRaw, 10);
                            if (!isNaN(desired) && desired > 0) {
                                const existingCycle = (state.inventoryPurchaseCycles || []).find(c => c.number === desired);
                                if (existingCycle) cycleNumber = desired;
                            }
                        }
                        if (!cycleNumber) {
                            cycleNumber = (state.inventoryPurchaseCycles || []).slice(-1)[0]?.number || null;
                        }
                        if (!cycleNumber) {
                            const hint = String(periodTitleRaw || '').trim();
                            cycleNumber = ensurePeriodCreated(purchaseDate, time, hint || undefined);
                        }
                        const nowTs = Date.now();
                        const isPlanned = new Date(purchaseDate).getTime() > new Date(todayStr).getTime();
                        const rec = {
                            id: generateID('invPurchase'),
                            cycleNumber,
                            itemName: product.name,
                            quantity,
                            unitCost,
                            discount: discountVal,
                            totalCost,
                            supplierName: String(supplierNameRaw || '').trim(),
                            supplierPhone: String(supplierPhoneRaw || '').trim(),
                            supplierAddress: String(supplierAddressRaw || '').trim(),
                            purchaseDate,
                            time,
                            notes: String(notesRaw || '').trim(),
                            timestamp: nowTs + k,
                            planned: isPlanned,
                            activated: !isPlanned
                        };
                        state.inventoryPurchases = state.inventoryPurchases || [];
                        state.inventoryPurchases.push(rec);
                        // Skip stock updates for service-type products
                        if (!isPlanned && product.hasStock !== false) updateProductStock(product.name, quantity, true);
                        try {
                            if (syncEnabled) {
                                await upsertOne('inventory_purchases', {
                                    period_number: rec.cycleNumber,
                                    item_name: rec.itemName,
                                    quantity: rec.quantity,
                                    unit_cost: rec.unitCost,
                                    total_cost: rec.totalCost,
                                    purchase_date: rec.purchaseDate,
                                    supplier_name: rec.supplierName,
                                    supplier_phone: rec.supplierPhone,
                                    supplier_address: rec.supplierAddress,
                                    notes: rec.notes,
                                    timestamp: rec.timestamp
                                });
                                const inv = state.inventory[product.name] || { stock: 0, minAlert: 5 };
                                await upsertOne('inventory', { product_name: product.name, stock: inv.stock || 0, min_alert: inv.minAlert || 5 });
                            }
                        } catch { }
                        imported++;
                    }
                    if (status) status.textContent = `Processed ${Math.min(end - 1, total)} of ${total}`;
                    await new Promise(r => setTimeout(r, 0));
                }
                saveData();
                render();
                showToast(`Imported ${imported}, skipped ${skipped.length}`, skipped.length ? 'info' : 'success');
                if (skipped.length) {
                    const names = skipped.slice(0, 10).map(s => `${s.name} (${s.reason})`).join(', ');
                    showToast(names, 'info', null, null, 5000);
                }
                if (syncEnabled) syncInBackground();
            };
            reader.onerror = function () { showToast('Failed to read file', 'error'); };
            reader.readAsText(file);
        }

        function downloadInventoryPurchasesTemplate() {
            try {
                const rows = (state.products || []).filter(p => p.hasStock !== false);
                const header = ['product_name', 'category', 'quantity', 'cost', 'price', 'type', 'min_alert', 'discount', 'date', 'time', 'period_title', 'period_number', 'supplier_name', 'supplier_phone', 'supplier_address', 'notes'];
                const today = getTodayDateString();
                const nowTime = new Date().toISOString().slice(11, 16);
                const dataRows = rows.map(p => [
                    p.name,
                    p.category || '',
                    '',
                    '',
                    (typeof p.price === 'number' ? p.price : ''),
                    (p.hasStock === false ? 'service' : 'product'),
                    (state.inventory && state.inventory[p.name] ? (state.inventory[p.name].minAlert || 5) : 5),
                    '',
                    today,
                    nowTime,
                    (new Date(today).toLocaleString('en-GB', { month: 'long', year: 'numeric' }) + ' Period'),
                    '',
                    '',
                    '',
                    '',
                    ''
                ]);
                const csv = [header.join(','), ...dataRows.map(r => r.map(v => String(v).replace(/\n/g, ' ').replace(/,/g, ';')).join(','))].join('\n');
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'inventory_purchases_import_template.csv';
                a.rel = 'noopener';
                document.body.appendChild(a);
                a.click();
                setTimeout(() => { try { document.body.removeChild(a); URL.revokeObjectURL(url); } catch { } }, 500);
                showToast('Template download started', 'info');
            } catch { showToast('Failed to generate template', 'error'); }
        }

        /*
        function ensureProductsImportModal() {
            let modal = document.getElementById('productsImportModal');
            if (modal) return;
            modal = document.createElement('div');
            modal.className = 'modal';
            modal.id = 'productsImportModal';
            modal.innerHTML = `
                <div class="modal-content">
                    <button class="modal-close" onclick="closeProductsImportModal()">×</button>
                    <div class="modal-title">Import Products/Services (CSV)</div>
                    <div class="card" style="margin-top:8px;">
                        <div style="display:flex;align-items:center;gap:8px;justify-content:space-between;">
                            <div>
                                <div style="font-size:13px;color:#666;">CSV headers: <strong>name</strong>, <strong>category</strong>, <strong>cost</strong>, <strong>price</strong>, <strong>type</strong>, <strong>stock</strong></div>
                                <div style="font-size:12px;color:#666;line-height:1.6;">
                                    <ul style="margin:6px 0 0 16px;">
                                        <li>type = <strong>product</strong> or <strong>service</strong></li>
                                        <li>stock is used <em>only</em> when type = <strong>product</strong>. For services, leave stock empty</li>
                                        <li>cost, price ≥ 0; extra columns are ignored</li>
                                        <li>Duplicates (case-insensitive by name) are skipped</li>
                                        <li>New categories are created automatically</li>
                                        <li>Large files process in small batches</li>
                                    </ul>
                                </div>
                                <div class="flex-gap" style="margin-top:8px;">
                                    <a class="btn-small" href="products_import_template.csv" download onclick="downloadProductsCSVTemplate(event)">⬇️ Download CSV Template</a>
                                    <a class="btn-small" href="products_import_template.csv" target="_blank" onclick="previewProductsCSVTemplate(event)">Preview Template</a>
                                </div>
                            </div>
                            <div>
                                <input type="file" id="productsCSVFile" accept=".csv" />
                            </div>
                        </div>
                        <div id="productsCSVStatus" style="margin-top:8px;font-size:12px;color:#666;"></div>
                        <div class="flex-gap" style="margin-top:12px;">
                            <button class="btn-small" onclick="startProductsCSVImport()">Import</button>
                            <button class="btn-small btn-danger" onclick="closeProductsImportModal()">Cancel</button>
                        </div>
                    </div>
                </div>`;
            document.body.appendChild(modal);
        }

        function openProductsImportModal() {
            ensureProductsImportModal();
            const modal = document.getElementById('productsImportModal');
            if (modal) modal.classList.add('show');
            try { window.__updateModalOverflow && window.__updateModalOverflow(); } catch { }
            if (modal.__outsideClickHandler) modal.removeEventListener('click', modal.__outsideClickHandler);
            modal.__outsideClickHandler = (e) => { if (e.target === modal) { closeProductsImportModal(); } };
            modal.addEventListener('click', modal.__outsideClickHandler);
        }

        function closeProductsImportModal() {
            const modal = document.getElementById('productsImportModal');
            if (modal) modal.classList.remove('show');
            try { window.__updateModalOverflow && window.__updateModalOverflow(); } catch { }
        }
        */

        function parseCSVLine(line) {
            const out = [];
            let i = 0; let cur = ''; let inQ = false;
            while (i < line.length) {
                const ch = line[i];
                if (inQ) {
                    if (ch === '"') {
                        if (line[i + 1] === '"') { cur += '"'; i += 2; continue; }
                        inQ = false; i++; continue;
                    } else { cur += ch; i++; continue; }
                } else {
                    if (ch === '"') { inQ = true; i++; continue; }
                    if (ch === ',') { out.push(cur); cur = ''; i++; continue; }
                    cur += ch; i++; continue;
                }
            }
            out.push(cur);
            return out.map(s => s.trim());
        }

        /* async function startProductsCSVImport() {
            const fileInput = document.getElementById('productsCSVFile');
            const status = document.getElementById('productsCSVStatus');
            if (!fileInput || !fileInput.files || fileInput.files.length === 0) { showToast('Select a CSV file', 'error'); return; }
            const file = fileInput.files[0];
            try { closeProductsImportModal(); showToast('Import started', 'info'); } catch { }
            const reader = new FileReader();
            reader.onload = async function (e) {
                const text = String(e.target.result || '');
                const lines = text.split(/\r?\n/).filter(l => l.trim().length > 0);
                if (lines.length < 2) { showToast('CSV has no data', 'error'); return; }
                const header = parseCSVLine(lines[0]).map(h => h.toLowerCase());
                const idx = {
                    name: header.indexOf('name'),
                    category: header.indexOf('category'),
                    cost: header.indexOf('cost'),
                    price: header.indexOf('price'),
                    type: header.indexOf('type'),
                    stock: header.indexOf('stock')
                };
                if (idx.name < 0 || idx.category < 0 || idx.cost < 0 || idx.price < 0 || idx.type < 0) {
                    showToast('Missing required headers', 'error');
                    return;
                }
                const total = lines.length - 1;
                let imported = 0;
                const skipped = [];
                const warnings = [];
                const existing = new Set((state.products || []).map(p => String(p.name || '').toLowerCase()));
                for (let start = 1; start < lines.length; start += 25) {
                    const end = Math.min(lines.length, start + 25);
                    for (let k = start; k < end; k++) {
                        const row = parseCSVLine(lines[k]);
                        const nameRaw = row[idx.name] || '';
                        const catRaw = row[idx.category] || '';
                        const costRaw = row[idx.cost] || '';
                        const priceRaw = row[idx.price] || '';
                        const typeRaw = row[idx.type] || '';
                        const stockRaw = idx.stock >= 0 ? (row[idx.stock] || '') : '';
                        let name = toTitleCase(String(nameRaw).trim());
                        if (!name) { skipped.push({ name: nameRaw || '(blank)', reason: 'name required' }); continue; }
                        const nl = name.toLowerCase();
                        if (existing.has(nl)) { skipped.push({ name, reason: 'duplicate' }); continue; }
                        let category = toCategoryCase(String(catRaw).trim());
                        if (!category) { skipped.push({ name, reason: 'category required' }); continue; }
                        let type = String(typeRaw || '').toLowerCase();
                        if (type !== 'product' && type !== 'service') { skipped.push({ name, reason: 'invalid type' }); continue; }
                        const cost = parseFloat(costRaw);
                        const price = parseFloat(priceRaw);
                        if (isNaN(cost) || cost < 0) { skipped.push({ name, reason: 'invalid cost' }); continue; }
                        if (isNaN(price) || price < 0) { skipped.push({ name, reason: 'invalid price' }); continue; }
                        if (price < cost) { warnings.push({ name, reason: 'price < cost' }); }
                        let stock = 0;
                        if (type === 'product') {
                            stock = parseFloat(stockRaw) || 0;
                            if (isNaN(stock) || stock < 0) stock = 0;
                        }
                        if (!state.categories.includes(category)) state.categories.push(category);
                        const product = { id: generateID('products'), name, category, cost, price, hasStock: type === 'product' };
                        state.products = state.products || [];
                        state.products.push(product);
                        if (type === 'product') {
                            state.inventory = state.inventory || {};
                            state.inventory[name] = { stock: stock, minAlert: 5 };
                        }
                        try {
                            if (syncEnabled) {
                                await upsertOne('products', { name, category: category || '', cost: cost || 0, price: price || 0, has_stock: type === 'product' });
                                await upsertOne('categories', { name: category });
                                if (type === 'product') await upsertOne('inventory', { product_name: name, stock: stock || 0, min_alert: 5 });
                            }
                        } catch { }
                        imported++;
                    }
                    if (status) status.textContent = `Processed ${Math.min(end - 1, total)} of ${total}`;
                    await new Promise(r => setTimeout(r, 0));
                }
                saveData();
                render();
                showToast(`Imported ${imported}, skipped ${skipped.length}`, skipped.length ? 'info' : 'success');
                if (skipped.length) {
                    const names = skipped.slice(0, 10).map(s => `${s.name} (${s.reason})`).join(', ');
                    showToast(names, 'info', null, null, 4000);
                }
                if (warnings.length) {
                    const wn = warnings.slice(0, 10).map(s => `${s.name} (${s.reason})`).join(', ');
                    showToast(`Warnings: ${warnings.length} — ${wn}`, 'info', null, null, 5000);
                }
                if (syncEnabled) syncInBackground();
            };
            reader.onerror = function () { showToast('Failed to read file', 'error'); };
            reader.readAsText(file);
        } */

        function ensureUnifiedProductsStockImportModal() {
            let modal = document.getElementById('unifiedProductsStockImportModal');
            if (modal) return;
            modal = document.createElement('div');
            modal.className = 'modal';
            modal.id = 'unifiedProductsStockImportModal';
            modal.innerHTML = `
                <div class="modal-content">
                    <button class="modal-close" onclick="closeUnifiedProductsStockImportModal()">×</button>
                    <div class="modal-title">Import Products + Stock (CSV)</div>
                    <div class="card" style="margin-top:8px;">
                        <div style="font-size:13px;color:#666;line-height:1.6;">
                            CSV headers: <strong>name</strong>, <strong>category</strong>, <strong>cost</strong>, <strong>price</strong>, <strong>type</strong>, <strong>stock</strong> with optional <strong>purchase_date</strong>, <strong>purchase_time</strong>, <strong>supplier_name</strong>, <strong>supplier_phone</strong>, <strong>supplier_address</strong>, <strong>notes</strong>
                        </div>
                        <div style="margin-top:8px;">
                            <input type="file" id="unifiedProductsStockCSVFile" accept=".csv" />
                        </div>
                        <div class="flex-gap" style="margin-top:8px;">
                            <a class="btn-small" href="#" onclick="downloadUnifiedProductsCSVTemplate(event)">⬇️ Download CSV Template</a>
                        </div>
                        <div id="unifiedProductsStockCSVStatus" style="margin-top:8px;font-size:12px;color:#666;"></div>
                        <div class="flex-gap" style="margin-top:12px;">
                            <button class="btn-small" onclick="startUnifiedProductsStockCSVImport()">Import</button>
                            <button class="btn-small btn-danger" onclick="closeUnifiedProductsStockImportModal()">Cancel</button>
                        </div>
                    </div>
                </div>`;
            document.body.appendChild(modal);
        }

        function openUnifiedProductsStockImportModal() {
            ensureUnifiedProductsStockImportModal();
            const modal = document.getElementById('unifiedProductsStockImportModal');
            if (modal) modal.classList.add('show');
            try { window.__updateModalOverflow && window.__updateModalOverflow(); } catch { }
            if (modal.__outsideClickHandler) modal.removeEventListener('click', modal.__outsideClickHandler);
            modal.__outsideClickHandler = (e) => { if (e.target === modal) { closeUnifiedProductsStockImportModal(); } };
            modal.addEventListener('click', modal.__outsideClickHandler);
        }

        function closeUnifiedProductsStockImportModal() {
            const modal = document.getElementById('unifiedProductsStockImportModal');
            if (modal) modal.classList.remove('show');
            try { window.__updateModalOverflow && window.__updateModalOverflow(); } catch { }
        }

        async function startUnifiedProductsStockCSVImport() {
            const fileInput = document.getElementById('unifiedProductsStockCSVFile');
            const status = document.getElementById('unifiedProductsStockCSVStatus');
            if (!fileInput || !fileInput.files || fileInput.files.length === 0) { showToast('Select a CSV file', 'error'); return; }
            const file = fileInput.files[0];
            try { closeUnifiedProductsStockImportModal(); showToast('Import started', 'info'); } catch { }
            const reader = new FileReader();
            reader.onload = async function (e) {
                const text = String(e.target.result || '');
                const lines = text.split(/\r?\n/).filter(l => l.trim().length > 0);
                if (lines.length < 2) { showToast('CSV has no data', 'error'); return; }
                const header = parseCSVLine(lines[0]).map(h => h.toLowerCase());
                const idx = {
                    name: header.indexOf('name'),
                    category: header.indexOf('category'),
                    cost: header.indexOf('cost'),
                    price: header.indexOf('price'),
                    type: header.indexOf('type'),
                    stock: header.indexOf('stock'),
                    purchase_date: header.indexOf('purchase_date'),
                    purchase_time: header.indexOf('purchase_time'),
                    supplier_name: header.indexOf('supplier_name'),
                    supplier_phone: header.indexOf('supplier_phone'),
                    supplier_address: header.indexOf('supplier_address'),
                    notes: header.indexOf('notes')
                };
                if (idx.name < 0 || idx.category < 0 || idx.cost < 0 || idx.price < 0 || idx.type < 0) {
                    showToast('Missing required headers', 'error');
                    return;
                }
                const total = lines.length - 1;
                let importedProducts = 0;
                let importedPurchases = 0;
                const skipped = [];
                const warnings = [];
                const todayStr = getTodayDateString();
                const nowTime = new Date().toISOString().slice(11, 16);
                const existingNames = new Set((state.products || []).map(p => String(p.name || '').toLowerCase()));
                for (let start = 1; start < lines.length; start += 25) {
                    const end = Math.min(lines.length, start + 25);
                    for (let k = start; k < end; k++) {
                        const row = parseCSVLine(lines[k]);
                        const nameRaw = row[idx.name] || '';
                        const catRaw = row[idx.category] || '';
                        const costRaw = row[idx.cost] || '';
                        const priceRaw = row[idx.price] || '';
                        const typeRaw = row[idx.type] || '';
                        const stockRaw = idx.stock >= 0 ? (row[idx.stock] || '') : '';
                        const purchaseDateRaw = idx.purchase_date >= 0 ? (row[idx.purchase_date] || '') : '';
                        const purchaseTimeRaw = idx.purchase_time >= 0 ? (row[idx.purchase_time] || '') : '';
                        const supplierNameRaw = idx.supplier_name >= 0 ? (row[idx.supplier_name] || '') : '';
                        const supplierPhoneRaw = idx.supplier_phone >= 0 ? (row[idx.supplier_phone] || '') : '';
                        const supplierAddressRaw = idx.supplier_address >= 0 ? (row[idx.supplier_address] || '') : '';
                        const notesRaw = idx.notes >= 0 ? (row[idx.notes] || '') : '';

                        let name = toTitleCase(String(nameRaw).trim());
                        if (!name) { skipped.push({ name: nameRaw || '(blank)', reason: 'name required' }); continue; }
                        const key = String(name).toLowerCase();
                        let category = toCategoryCase(String(catRaw).trim());
                        if (!category) { skipped.push({ name, reason: 'category required' }); continue; }
                        let type = String(typeRaw || 'product').toLowerCase();
                        if (type !== 'product' && type !== 'service') { skipped.push({ name, reason: 'invalid type' }); continue; }
                        const cost = parseFloat(costRaw);
                        const price = parseFloat(priceRaw);
                        if (isNaN(cost) || cost < 0) { skipped.push({ name, reason: 'invalid cost' }); continue; }
                        if (isNaN(price) || price < 0) { skipped.push({ name, reason: 'invalid price' }); continue; }
                        if (price < cost) { warnings.push({ name, reason: 'price < cost' }); }
                        let stock = 0;
                        if (type === 'product') {
                            stock = parseFloat(stockRaw) || 0;
                            if (isNaN(stock) || stock < 0) stock = 0;
                        } else {
                            if ((stockRaw || '').trim()) warnings.push({ name, reason: 'stock ignored for service' });
                        }

                        if (!state.categories.includes(category)) state.categories.push(category);

                        if (!existingNames.has(key)) {
                            const product = { id: generateID('products'), name, category, cost, price, hasStock: type === 'product' };
                            state.products = state.products || [];
                            state.products.push(product);
                            importedProducts++;
                            try {
                                if (syncEnabled) {
                                    await upsertOne('products', { name, category: category || '', cost: cost || 0, price: price || 0, has_stock: type === 'product' });
                                    await upsertOne('categories', { name: category });
                                }
                            } catch { }
                            existingNames.add(key);
                        }

                        if (type === 'product') {
                            state.inventory = state.inventory || {};
                            state.inventory[name] = state.inventory[name] || { stock: 0, minAlert: 5 };

                            if (stock > 0) {
                                const purchaseDate = (purchaseDateRaw && purchaseDateRaw.trim()) ? purchaseDateRaw.trim() : todayStr;
                                const purchaseTime = (purchaseTimeRaw && purchaseTimeRaw.trim()) ? purchaseTimeRaw.trim() : nowTime;
                                let cycleNumber = (state.inventoryPurchaseCycles || []).slice(-1)[0]?.number || null;
                                if (!cycleNumber) { cycleNumber = ensurePeriodCreated(purchaseDate, purchaseTime); }
                                const nowTs = Date.now() + k;
                                const totalCost = Math.max(0, stock * cost);
                                const rec = {
                                    id: generateID('invPurchase'),
                                    cycleNumber,
                                    itemName: name,
                                    quantity: stock,
                                    unitCost: cost,
                                    discount: 0,
                                    totalCost,
                                    supplierName: supplierNameRaw || '',
                                    supplierPhone: supplierPhoneRaw || '',
                                    supplierAddress: supplierAddressRaw || '',
                                    purchaseDate,
                                    time: purchaseTime,
                                    notes: notesRaw || '',
                                    timestamp: nowTs,
                                    planned: false,
                                    activated: true
                                };
                                state.inventoryPurchases = state.inventoryPurchases || [];
                                state.inventoryPurchases.push(rec);
                                updateProductStock(name, stock, false);
                                importedPurchases++;
                                try {
                                    if (syncEnabled) {
                                        await upsertOne('inventory_purchases', {
                                            period_number: rec.cycleNumber,
                                            item_name: rec.itemName,
                                            quantity: rec.quantity,
                                            unit_cost: rec.unitCost,
                                            total_cost: rec.totalCost,
                                            purchase_date: rec.purchaseDate,
                                            supplier_name: rec.supplierName,
                                            supplier_phone: rec.supplierPhone,
                                            supplier_address: rec.supplierAddress,
                                            notes: rec.notes,
                                            timestamp: rec.timestamp
                                        });
                                        const inv = state.inventory[name] || { stock: 0, minAlert: 5 };
                                        await upsertOne('inventory', { product_name: name, stock: inv.stock || 0, min_alert: inv.minAlert || 5 });
                                    }
                                } catch { }
                            } else {
                                try {
                                    if (syncEnabled) {
                                        const inv = state.inventory[name] || { stock: 0, minAlert: 5 };
                                        await upsertOne('inventory', { product_name: name, stock: inv.stock || 0, min_alert: inv.minAlert || 5 });
                                    }
                                } catch { }
                            }
                        }
                    }
                    if (status) status.textContent = `Processed ${Math.min(end - 1, total)} of ${total}`;
                    await new Promise(r => setTimeout(r, 0));
                }
                saveData();
                render();
                showToast(`Imported products: ${importedProducts} • stock purchases: ${importedPurchases} • skipped: ${skipped.length}`, skipped.length ? 'info' : 'success');
                if (skipped.length) {
                    const names = skipped.slice(0, 10).map(s => `${s.name} (${s.reason})`).join(', ');
                    showToast(names, 'info', null, null, 5000);
                }
                if (warnings.length) {
                    const wn = warnings.slice(0, 10).map(s => `${s.name} (${s.reason})`).join(', ');
                    showToast(`Warnings: ${warnings.length} — ${wn}`, 'info', null, null, 5000);
                }
                if (syncEnabled) syncInBackground();
            };
            reader.onerror = function () { showToast('Failed to read file', 'error'); };
            reader.readAsText(file);
        }

        async function downloadUnifiedProductsCSVTemplate(e) {
            try {
                if (e) { e.preventDefault && e.preventDefault(); e.stopPropagation && e.stopPropagation(); }
                const today = getTodayDateString();
                const nowTime = new Date().toISOString().slice(11, 16);
                const header = ['name','category','cost','price','type','stock','purchase_date','purchase_time','supplier_name','supplier_phone','supplier_address','notes'];
                const rowsSrc = (state.products || []).map(p => {
                    const type = (p.hasStock === false) ? 'service' : 'product';
                    const inv = (state.inventory || {})[p.name] || { stock: 0 };
                    const stock = type === 'product' ? (inv.stock || 0) : '';
                    return [p.name, p.category || '', p.cost || 0, p.price || 0, type, stock, today, nowTime, '', '', '', ''];
                });
                const sample = ['Sample Product','General',0,0,'product',0,today,nowTime,'','','',''];
                const dataRows = rowsSrc.length ? rowsSrc : [sample];
                const csv = [header.join(','), ...dataRows.map(r => r.map(v => String(v).replace(/\n/g,' ').replace(/,/g,';')).join(','))].join('\n');
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'products_and_stock_import_template.csv';
                a.rel = 'noopener';
                document.body.appendChild(a);
                a.click();
                setTimeout(() => { try { document.body.removeChild(a); URL.revokeObjectURL(url); } catch {} }, 500);
                showToast('Template download started', 'info');
            } catch { showToast('Failed to generate template', 'error'); }
        }

        function isIOS() {
            try {
                const ua = navigator.userAgent || navigator.vendor || window.opera || '';
                return /iPad|iPhone|iPod/i.test(ua);
            } catch { return false; }
        }

        async function downloadProductsCSVTemplate(e) {
            try {
                if (isIOS()) {
                    if (e) { e.preventDefault(); e.stopPropagation(); }
                    const res = await fetch('products_import_template.csv');
                    const blob = await res.blob();
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'products_import_template.csv';
                    a.rel = 'noopener';
                    document.body.appendChild(a);
                    a.click();
                    setTimeout(() => { try { document.body.removeChild(a); URL.revokeObjectURL(url); } catch { } }, 500);
                    showToast('Template download started', 'info');
                }
            } catch { }
        }

        function ensureCSVViewerModal() {
            let modal = document.getElementById('csvViewerModal');
            if (modal) return;
            modal = document.createElement('div');
            modal.className = 'modal';
            modal.id = 'csvViewerModal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 640px;">
                    <button class="modal-close" onclick="closeCSVViewer()">×</button>
                    <div class="modal-title">CSV Preview</div>
                    <div id="csvViewerContent" style="margin-top:8px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; font-size:12px; white-space:pre; overflow:auto; max-height:60vh; border:1px solid rgba(0,0,0,0.12); border-radius:8px; padding:10px;"></div>
                    <div class="flex-gap" style="margin-top:12px;">
                        <button class="btn-small" onclick="downloadProductsCSVTemplate()">Download</button>
                        <button class="btn-small btn-danger" onclick="closeCSVViewer()">Close</button>
                    </div>
                </div>`;
            document.body.appendChild(modal);
        }
        async function previewProductsCSVTemplate(e) {
            if (isIOS()) {
                if (e) { e.preventDefault(); e.stopPropagation(); }
                ensureCSVViewerModal();
                const modal = document.getElementById('csvViewerModal');
                const content = document.getElementById('csvViewerContent');
                try {
                    const res = await fetch('products_import_template.csv');
                    const text = await res.text();
                    if (content) content.textContent = text;
                    if (modal) modal.classList.add('show');
                    try { window.__updateModalOverflow && window.__updateModalOverflow(); } catch { }
                } catch {
                    showToast('Unable to preview template', 'error');
                }
                return false;
            }
        }
        function closeCSVViewer() {
            const modal = document.getElementById('csvViewerModal');
            if (modal) modal.classList.remove('show');
            try { window.__updateModalOverflow && window.__updateModalOverflow(); } catch { }
        }

        function chooseStocksheetMode(mode) {
            const modal = document.getElementById('stocksheetModal');
            if (!modal) return;
            const normalized = (mode === 'empty' || mode === 'empty_categories') ? mode : 'product';
            modal.setAttribute('data-mode', normalized);
            const wrap = document.getElementById('stocksheetRowsWrap');
            const wrapCat = document.getElementById('stocksheetRowsPerCatWrap');
            const catSelectWrap = document.getElementById('stocksheetCategorySelectWrap');
            if (wrap) wrap.style.display = normalized === 'empty' ? '' : 'none';
            if (wrapCat) wrapCat.style.display = normalized === 'empty_categories' ? '' : 'none';
            if (catSelectWrap) catSelectWrap.style.display = normalized === 'empty_categories' ? '' : 'none';
            const btnProd = document.getElementById('stocksheetSrcProduct');
            const btnEmpty = document.getElementById('stocksheetSrcEmpty');
            const btnEmptyCat = document.getElementById('stocksheetSrcEmptyCat');
            if (btnProd && btnEmpty) {
                const sel = 'btn-small stocksheet-src-btn selected';
                const unsel = 'btn-small btn-secondary stocksheet-src-btn';
                btnProd.className = normalized === 'product' ? sel : unsel;
                btnEmpty.className = normalized === 'empty' ? sel : unsel;
                if (btnEmptyCat) btnEmptyCat.className = normalized === 'empty_categories' ? sel : unsel;
            }
            if (normalized === 'empty_categories') {
                try { renderStocksheetCategorySelector(); } catch {}
            }
        }

        function closeStocksheetModal() {
            const modal = document.getElementById('stocksheetModal');
            if (modal) {
                modal.classList.remove('show');
                if (modal.__outsideClickHandler) {
                    modal.removeEventListener('click', modal.__outsideClickHandler);
                }
            }
            try { window.__updateModalOverflow && window.__updateModalOverflow(); } catch { }
        }

        function applyStocksheetOptions() {
            const mode = document.getElementById('stocksheetModal')?.getAttribute('data-mode') || 'product';
            if (mode === 'empty') {
                const val = document.getElementById('stocksheetEmptyRows')?.value || '10';
                const n = parseInt(val, 10);
                if (!n || isNaN(n) || n < 1) { showToast('Enter a valid number of rows', 'error'); return; }
                closeStocksheetModal();
                downloadInventoryStockSheetPDF({ mode: 'empty', emptyRows: n });
            } else if (mode === 'empty_categories') {
                const val = document.getElementById('stocksheetEmptyRowsPerCat')?.value || '10';
                const n = parseInt(val, 10);
                if (!n || isNaN(n) || n < 1) { showToast('Enter a valid number of rows per category', 'error'); return; }
                const selected = Array.from(document.querySelectorAll('input[name="stocksheetCatChoice"]:checked')).map(el => el.value);
                if (!selected || selected.length === 0) { showToast('Choose at least one category', 'error'); return; }
                closeStocksheetModal();
                downloadInventoryStockSheetPDF({ mode: 'empty_categories', rowsPerCategory: n, categories: selected });
            } else {
                closeStocksheetModal();
                downloadInventoryStockSheetPDF();
            }
        }

        function renderStocksheetCategorySelector() {
            const proDiv = document.getElementById('stocksheetProductCats');
            const servDiv = document.getElementById('stocksheetServiceCats');
            const products = (state.products || []);
            const productCats = new Set();
            const serviceCats = new Set();
            products.forEach(p => {
                const cat = String(p.category || 'Uncategorized');
                if (p.hasStock === false) serviceCats.add(cat);
                else productCats.add(cat);
            });
            // Include categories that exist even if no products yet — consider them product categories by default
            (state.categories || []).forEach(c => { if (!serviceCats.has(c) && !productCats.has(c)) productCats.add(c); });
            const makeList = (cats, group) => {
                const arr = Array.from(cats).sort((a, b) => String(a).localeCompare(String(b)));
                if (arr.length === 0) return '<div style="color:#666;font-size:12px;">None</div>';
                return arr.map(c => `<label style="display:flex;align-items:center;gap:8px;margin:4px 0;"><input type="checkbox" name="stocksheetCatChoice" value="${c}" data-group="${group}"><span>${c}</span></label>`).join('');
            };
            if (proDiv) proDiv.innerHTML = makeList(productCats, 'product');
            if (servDiv) servDiv.innerHTML = makeList(serviceCats, 'service');
        }
        function toggleSelectAllStocksheetCats(group, checked) {
            const nodes = Array.from(document.querySelectorAll(`input[name="stocksheetCatChoice"][data-group="${group}"]`));
            nodes.forEach(n => { n.checked = !!checked; });
        }

        function switchTab(tabId) {
            if (state.navBusy) return;
            state.navBusy = true;
            try { hapticShort(); } catch { }
            state.activeTab = tabId;
            try {
                state.lastNavTab = String(tabId || '');
                state.lastNavAt = Date.now();
                localStorage.setItem('tuba-last-tab-v1', state.lastNavTab);
                localStorage.setItem('tuba-last-tab-at-v1', String(state.lastNavAt));
            } catch { }
            state.searchPeriod = '';
            try { window.scrollTo({ top: 0, behavior: 'instant' }); } catch { try { window.scrollTo(0, 0); } catch { } }
            if (tabId !== 'sales') {
                state.privacyBlurred = true;
                state.showSalesHistory = false;
            }
            if (tabId !== 'dashboard') {
                state.dashboardPrivacyBlurred = true;
            }
            state.listExpanded = {};
            state.listShowCount = {};
            state.collapsedSections = {};
            state.inventoryPeriodsShowCount = 3;
            state.unpaidEntriesShowCount = 2;
            state.paidEntriesShowCount = 2;
            render();
            if (tabId === 'unpaid') {
                setTimeout(() => {
                    try {
                        if (state.scrollToUnpaidAfterNav) {
                            const target = document.getElementById('unpaidEntriesCard');
                            if (target) target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                            state.scrollToUnpaidAfterNav = false;
                        } else {
                            const content = document.querySelector('.content');
                            if (content && typeof content.scrollTo === 'function') {
                                content.scrollTo({ top: 0, behavior: 'smooth' });
                            }
                        }
                    } catch (e) { }
                }, 100);
            }
            if (tabId === 'dashboard') {
                setTimeout(() => {
                    try {
                        if (state.scrollToDailyTargetAfterNav) {
                            const target = document.getElementById('dailyTargetCard');
                            if (target) {
                                target.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                try {
                                    target.classList.remove('highlight-hint');
                                    void target.offsetWidth;
                                    target.classList.add('highlight-hint');
                                    setTimeout(() => { try { target.classList.remove('highlight-hint'); } catch {} }, 2100);
                                } catch {}
                            }
                            state.scrollToDailyTargetAfterNav = false;
                        } else {
                            const content = document.querySelector('.content');
                            if (content && typeof content.scrollTo === 'function') {
                                content.scrollTo({ top: 0, behavior: 'smooth' });
                            }
                        }
                    } catch (e) { }
                }, 100);
            }
            setTimeout(() => { state.navBusy = false; }, 250);
        }

        function goToUnpaidFromDashboard() {
            try { playTapSound(); } catch { }
            state.scrollToUnpaidAfterNav = true;
            switchTab('unpaid');
        }

        function goToDailyTargetFromRing() {
            try { playTapSound(); } catch { }
            state.scrollToDailyTargetAfterNav = true;
            switchTab('dashboard');
        }

        function refreshApp() {
            try {
                if (navigator.serviceWorker && navigator.serviceWorker.controller) {
                    navigator.serviceWorker.controller.postMessage({ type: 'prefer-cache-next-reload' });
                }
            } catch (e) { }
            try { clearAllSearchInputs(); } catch (e) { }
            try { window.location.reload(); } catch (e) { }
        }

        // FAB features removed; bottom tabs restored

        function showToast(message, type = "info", actionText = null, actionHandler = null, durationMs = 3000, onClickHandler = null) {
            try {
                const msg = String(message || '');
                const allowBootMsg = msg.toLowerCase().includes('loading your data');
                if (window.__bootSilenceToasts && !allowBootMsg) return;
            } catch { }
            try {
                const msgLower = String(message || '').toLowerCase();
                const isPinRequiredMsg = msgLower.startsWith('delete failed: pin required') || msgLower.startsWith('edit failed: pin required');
                if (isPinRequiredMsg && window.__pinLastFailure && window.__pinLastFailure !== 'cancel') {
                    window.__pinLastFailure = null;
                    return;
                }
                if (isPinRequiredMsg && window.__pinLastFailure === 'cancel') {
                    window.__pinLastFailure = null;
                }
            } catch { }
            let bar = document.getElementById('toastBar');
            if (!bar) {
                bar = document.createElement('div');
                bar.id = 'toastBar';
                bar.className = 'toast-bar';
                document.body.appendChild(bar);
            }
            try {
                const msgLower = String(message || '').toLowerCase();
                if (msgLower.includes('loading your data')) {
                    Array.from(bar.querySelectorAll('.toast')).forEach(t => { try { t.remove(); } catch {} });
                }
            } catch { }

            const t = document.createElement('div');
            t.className = 'toast toast-' + type;
            const key = (type + ':' + message).toLowerCase();
            t.setAttribute('data-key', key);
            try {
                const existing = Array.from(bar.querySelectorAll('.toast')).find(el => el.getAttribute('data-key') === key);
                if (existing) {
                    existing.classList.remove('show');
                    setTimeout(() => existing.remove(), 0);
                }
            } catch { }
            const span = document.createElement('span');
            span.textContent = message;
            t.appendChild(span);
            if (actionText && typeof actionHandler === 'function') {
                const btn = document.createElement('button');
                btn.textContent = actionText;
                btn.style.cssText = 'margin-left:8px; padding:4px 8px; font-size:10px; border-radius:8px; border:none; background:#fff; color:#000; cursor:pointer;';
                btn.onclick = (e) => { e.stopPropagation(); try { actionHandler(); } finally { t.classList.remove('show'); setTimeout(() => t.remove(), 150); } };
                t.appendChild(btn);
            }
            if (typeof onClickHandler === 'function') {
                t.onclick = () => { try { onClickHandler(); } finally { t.classList.remove('show'); setTimeout(() => t.remove(), 150); } };
            }
            bar.prepend(t);
            requestAnimationFrame(() => t.classList.add('show'));
            setTimeout(() => { t.classList.remove('show'); setTimeout(() => t.remove(), 300); }, Math.max(1000, durationMs || 3000));
        }

        let __confirmYesCallback = null;
        function showConfirm(text, onYes) {
            let m = document.getElementById('confirmModal');
            if (!m) {
                m = document.createElement('div');
                m.className = 'modal';
                m.id = 'confirmModal';
                m.innerHTML = `
                    <div class="modal-content" style="max-width:420px;">
                        <button class="modal-close" type="button" onclick="closeConfirmModal()">×</button>
                        <div class="modal-title" id="confirmModalTitle">Confirm</div>
                        <div id="confirmModalText" style="font-size:13px;color:#444;line-height:1.6;margin-top:6px;"></div>
                        <div class="flex-gap" style="margin-top:12px;justify-content:flex-end;">
                            <button class="btn-secondary btn-small" type="button" onclick="closeConfirmModal()">Cancel</button>
                            <button class="btn-primary btn-small" type="button" onclick="confirmModalYes()">Confirm</button>
                        </div>
                    </div>`;
                document.body.appendChild(m);
            }
            const t = document.getElementById('confirmModalText');
            if (t) t.textContent = String(text || 'Are you sure?');
            __confirmYesCallback = onYes;
            try { m.classList.add('show'); m.style.display = ''; } catch {}
            try { window.__updateModalOverflow && window.__updateModalOverflow(); } catch {}
        }
        function closeConfirmModal() {
            const m = document.getElementById('confirmModal');
            if (m) { try { m.classList.remove('show'); m.style.display = 'none'; } catch {} }
            __confirmYesCallback = null;
            try { window.__updateModalOverflow && window.__updateModalOverflow(); } catch {}
        }
        function confirmModalYes() {
            try { if (typeof __confirmYesCallback === 'function') __confirmYesCallback(); } catch { }
            closeConfirmModal();
        }

        function hapticShort() {
            const n = navigator;
            if (!n || typeof n.vibrate !== 'function') return;
            if (!state || state.vibrationEnabled !== true) return;
            const ua = navigator.userAgent || navigator.vendor || window.opera;
            const isMobile = /Android|iPhone|iPad|iPod/i.test(ua);
            if (!isMobile) return;
            try { n.vibrate(30); } catch (e) { }
        }

        async function playTapSound() {
            if (state && state.soundEnabled === false) return;
            try {
                let a = window.__tapSoundAudio;
                if (a) {
                    try {
                        const base = a.src.split('?')[0];
                        a.src = base + '?v=' + Date.now();
                        a.load();
                    } catch (e) { }
                    try { a.volume = 0.5; } catch (e) { }
                    try { a.currentTime = 0; } catch (e) { }
                    await a.play();
                    return;
                }
                const srcs = ['button audio.mp3', 'tap.mp3', 'tap.wav'];
                for (let i = 0; i < srcs.length; i++) {
                    const url = encodeURI(srcs[i]) + '?v=' + Date.now();
                    const candidate = new Audio(url);
                    candidate.preload = 'auto';
                    candidate.volume = 0.5;
                    try { candidate.currentTime = 0; } catch (e) { }
                    try {
                        await candidate.play();
                        window.__tapSoundAudio = candidate;
                        return;
                    } catch (e) { }
                }
            } catch (e) { }
            try {
                let ctx = window.__tapAudioContext;
                if (!ctx) ctx = new (window.AudioContext || window.webkitAudioContext)();
                window.__tapAudioContext = ctx;
                try { await ctx.resume(); } catch (e) { }
                const o = ctx.createOscillator();
                const g = ctx.createGain();
                o.type = 'square';
                o.frequency.value = 600;
                g.gain.value = 0.05;
                o.connect(g);
                g.connect(ctx.destination);
                o.start();
                setTimeout(() => { try { o.stop(); o.disconnect(); g.disconnect(); } catch (e) { } }, 60);
            } catch (e) { }
        }

        async function playDeleteSound() {
            if (state && state.soundEnabled === false) return;
            try {
                let a = window.__deleteSoundAudio;
                if (a) {
                    try {
                        const base = a.src.split('?')[0];
                        a.src = base + '?v=' + Date.now();
                        a.load();
                    } catch (e) { }
                    try { a.volume = 0.5; } catch (e) { }
                    try { a.currentTime = 0; } catch (e) { }
                    await a.play();
                    return;
                }
                const srcs = ['delete sound.mp3', 'delete.mp3', 'delete.wav'];
                for (let i = 0; i < srcs.length; i++) {
                    const url = encodeURI(srcs[i]) + '?v=' + Date.now();
                    const candidate = new Audio(url);
                    candidate.preload = 'auto';
                    candidate.volume = 0.5;
                    try { candidate.currentTime = 0; } catch (e) { }
                    try {
                        await candidate.play();
                        window.__deleteSoundAudio = candidate;
                        return;
                    } catch (e) { }
                }
            } catch (e) { }
            try {
                let ctx = window.__deleteAudioContext;
                if (!ctx) ctx = new (window.AudioContext || window.webkitAudioContext)();
                window.__deleteAudioContext = ctx;
                try { await ctx.resume(); } catch (e) { }
                const o = ctx.createOscillator();
                const g = ctx.createGain();
                o.type = 'square';
                o.frequency.value = 250;
                g.gain.value = 0.05;
                o.connect(g);
                g.connect(ctx.destination);
                o.start();
                setTimeout(() => { try { o.stop(); o.disconnect(); g.disconnect(); } catch (e) { } }, 80);
            } catch (e) { }
        }

        async function downloadPDFSafe(doc, filename) {
            try {
                const ua = navigator.userAgent || navigator.vendor || window.opera;
                const isIOS = /iPad|iPhone|iPod/.test(ua) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
                const isAndroid = /Android/i.test(ua);
                const blob = doc.output('blob');
                const url = URL.createObjectURL(blob);

                // iOS: prefer share sheet if supported, else open viewer in new tab
                if (isIOS) {
                    if (navigator.share && navigator.canShare) {
                        try {
                            const file = new File([blob], filename, { type: 'application/pdf' });
                            if (navigator.canShare({ files: [file] })) {
                                await navigator.share({ files: [file], title: filename, text: APP_BASE_URL });
                                setTimeout(() => { try { URL.revokeObjectURL(url); } catch { } }, 10000);
                                return;
                            }
                        } catch { }
                    }
                    const w = window.open(url, '_blank');
                    if (w && typeof w.focus === 'function') { w.focus(); setTimeout(() => { try { URL.revokeObjectURL(url); } catch { } }, 10000); return; }
                }

                // Android: use native viewer (new tab), fallback to same-tab navigation
                if (isAndroid) {
                    const triggerDownload = () => {
                        try {
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = filename;
                            document.body.appendChild(a);
                            a.click();
                            setTimeout(() => { try { URL.revokeObjectURL(url); } catch { } a.remove(); }, 1000);
                        } catch { }
                    };
                    const w = window.open(url, '_blank');
                    if (w && typeof w.focus === 'function') { w.focus(); triggerDownload(); return; }
                    try { window.location.assign(url); triggerDownload(); return; } catch { }
                }

                // Other platforms or fallbacks: trigger direct download
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                setTimeout(() => { try { URL.revokeObjectURL(url); } catch { } a.remove(); }, 1000);
            } catch {
                try { doc.save(filename); } catch { }
            }
        }

        async function toGrayscaleDataURL(src) {
            try {
                return await new Promise((resolve) => {
                    const img = new Image();
                    img.crossOrigin = 'anonymous';
                    img.onload = () => {
                        try {
                            const c = document.createElement('canvas');
                            c.width = img.width; c.height = img.height;
                            const ctx = c.getContext('2d');
                            ctx.drawImage(img, 0, 0);
                            const imgData = ctx.getImageData(0, 0, c.width, c.height);
                            const d = imgData.data;
                            for (let i = 0; i < d.length; i += 4) {
                                const r = d[i], g = d[i + 1], b = d[i + 2];
                                const y = 0.299 * r + 0.587 * g + 0.114 * b;
                                d[i] = d[i + 1] = d[i + 2] = y;
                            }
                            ctx.putImageData(imgData, 0, 0);
                            resolve(c.toDataURL('image/png'));
                        } catch { resolve(src); }
                    };
                    img.onerror = () => resolve(src);
                    img.src = src;
                });
            } catch { return src; }
        }

        let __pdfViewerURL = null;
        let __pdfFilename = 'document.pdf';
        function openPdfViewer(url, filename) {
            __pdfFilename = filename || 'document.pdf';
            const modal = document.getElementById('pdfViewerModal');
            const iframe = document.getElementById('pdfIframe');
            const btn = document.getElementById('pdfDownloadBtn');
            const titleEl = document.getElementById('pdfViewerTitle');
            iframe.src = url;
            modal.classList.add('show');
            modal.setAttribute('aria-modal', 'true');
            const handleOutside = (e) => { if (e.target === modal) { closePdfViewer(); } };
            modal.addEventListener('click', handleOutside, { once: true });
            if (titleEl) {
                try { titleEl.textContent = 'PDF Preview — ' + __pdfFilename; } catch { }
            }
            btn.onclick = function () {
                (async function () {
                    try {
                        const ua = navigator.userAgent || navigator.vendor || window.opera;
                        const isIOS = /iPad|iPhone|iPod/.test(ua) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
                        if (isIOS && navigator.share && navigator.canShare) {
                            let blob;
                            try {
                                const res = await fetch(url);
                                blob = await res.blob();
                            } catch { }
                            if (blob) {
                                const file = new File([blob], __pdfFilename, { type: 'application/pdf' });
                                if (navigator.canShare({ files: [file] })) {
                                    try { await navigator.share({ files: [file], title: __pdfFilename }); return; } catch { }
                                }
                            }
                        }
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = __pdfFilename;
                        document.body.appendChild(a);
                        a.click();
                        setTimeout(() => { a.remove(); }, 100);
                    } catch { }
                })();
            };
            __pdfViewerURL = url;
        }
        function closePdfViewer() {
            const modal = document.getElementById('pdfViewerModal');
            const iframe = document.getElementById('pdfIframe');
            const titleEl = document.getElementById('pdfViewerTitle');
            modal.classList.remove('show');
            iframe.src = '';
            if (titleEl) {
                try { titleEl.textContent = 'PDF Preview'; } catch { }
            }
            if (__pdfViewerURL && __pdfViewerURL.startsWith('blob:')) {
                try { URL.revokeObjectURL(__pdfViewerURL); } catch { }
            }
            __pdfViewerURL = null;
        }

        function closeFloatModal() {
            const modal = document.getElementById('floatModal');
            if (modal) modal.classList.remove('show');
            try { document.body.style.overflow = ''; } catch { }
        }

        (function () {
            const modal = document.getElementById('floatModal');
            if (modal) {
                modal.addEventListener('click', function (e) {
                    if (e.target === modal) {
                        closeFloatModal();
                    }
                });
            }
        })();

        function openGlobalSearch() {
            const titleEl = document.getElementById('floatModalTitle');
            const contentEl = document.getElementById('floatModalContent');
            if (titleEl) titleEl.textContent = 'Global Search';
            if (contentEl) {
                contentEl.innerHTML = `
                    <div style="display:flex; gap:8px; align-items:center;">
                        <input id="globalSearchInput" type="text" placeholder="Search reports, tabs, actions" style="flex:1; padding:10px; border:1px solid #ddd; border-radius:10px; font-size:14px;" />
                    </div>
                    <div id="globalSearchResults" style="margin-top:10px; max-height:60vh; overflow:auto;"></div>
                `;
            }
            const modal = document.getElementById('floatModal');
            if (modal) modal.classList.add('show');
            try { document.body.style.overflow = 'hidden'; } catch { }
            const input = document.getElementById('globalSearchInput');
            const resultsEl = document.getElementById('globalSearchResults');
            const items = buildGlobalSearchItems();
            function render() { renderGlobalSearchResults(items, input.value, resultsEl); }
            if (input) input.addEventListener('input', render);
            setTimeout(() => { try { input && input.focus(); } catch { } }, 50);
            render();
        }

        function buildGlobalSearchItems() {
            const items = [];
            (tabs || []).forEach(t => {
                items.push({ label: t.label, group: 'Tabs', action: () => { switchTab(t.id); closeFloatModal(); }, key: (t.label + ' ' + t.id).toLowerCase() });
            });
            (state.customers || []).forEach(c => {
                const name = String(c.name || '').trim();
                if (!name) return;
                items.push({ label: name, group: 'Customers', action: () => { switchTab('customers'); closeFloatModal(); }, key: (`customer ${name} ${c.phone || ''} ${c.email || ''}`).toLowerCase() });
            });
            (state.products || []).forEach(p => {
                const name = String(p.name || '').trim();
                if (!name) return;
                items.push({ label: name, group: 'Products', action: () => { switchTab('products'); closeFloatModal(); }, key: (`product ${name} ${p.category || ''}`).toLowerCase() });
            });
            (state.invoices || []).forEach(inv => {
                const num = String(inv.number || '').trim();
                const cust = String(inv.customer || '').trim();
                if (!num && !cust) return;
                items.push({ label: num || cust, group: 'Invoices', action: () => { switchTab('invoices'); closeFloatModal(); }, key: (`invoice ${num} ${cust} ${inv.status || ''}`).toLowerCase() });
            });
            (state.categories || []).forEach(cat => {
                const nm = String(cat || '').trim();
                if (!nm) return;
                items.push({ label: nm, group: 'Categories', action: () => { switchTab('categories'); closeFloatModal(); }, key: (`category ${nm}`).toLowerCase() });
            });
            items.push({ label: 'Daily Report (PDF)', group: 'Reports', action: () => { closeFloatModal(); downloadDailyReportPDF(); }, key: 'daily report pdf' });
            items.push({ label: 'General Report (PDF)', group: 'Reports', action: () => { closeFloatModal(); openReportRangeModal(); }, key: 'general report pdf sales report' });
            items.push({ label: 'General Report (Excel)', group: 'Reports', action: () => { closeFloatModal(); downloadSalesReportExcel(); }, key: 'general report excel xlsx' });
            items.push({ label: 'Expenses Report (PDF)', group: 'Reports', action: () => { closeFloatModal(); openExpensesReportRangeModal(); }, key: 'expenses report pdf' });
            items.push({ label: 'Income Report (PDF)', group: 'Reports', action: () => { closeFloatModal(); openIncomeReportRangeModal(); }, key: 'income report pdf' });
            items.push({ label: '10% Report (PDF)', group: 'Reports', action: () => { closeFloatModal(); openTenPercentReportModal(); }, key: 'ten percent 10% report pdf' });
            items.push({ label: 'Stock Sheet (PDF)', group: 'Reports', action: () => { closeFloatModal(); openStocksheetModal(); }, key: 'stock sheet inventory pdf' });
            items.push({ label: 'Backup All Data', group: 'Tools', action: () => { closeFloatModal(); downloadBackup(); }, key: 'backup export data' });
            if (window.__devToolsEnabled) { items.push({ label: 'Cloud Diagnostics', group: 'Tools', action: () => { closeFloatModal(); openCloudDiagnosticsModal(); }, key: 'cloud diagnostics rls health' }); }
            items.push({ label: 'Unpaid Sales', group: 'Tools', action: () => { closeFloatModal(); openUnpaidSalesModal(); }, key: 'unpaid sales mark paid' });
            items.push({ label: 'Change Security PIN', group: 'Tools', action: () => { closeFloatModal(); requestPinChangeEmail(); }, key: 'change security pin' });
            items.push({ label: 'Add Income', group: 'Actions', action: () => { switchTab('income'); closeFloatModal(); }, key: 'add income' });
            items.push({ label: 'Add Expense', group: 'Actions', action: () => { switchTab('expenses'); closeFloatModal(); }, key: 'add expense' });
            items.push({ label: 'Add Sale', group: 'Actions', action: () => { switchTab('sales'); closeFloatModal(); }, key: 'add sale' });
            items.push({ label: 'Analytics', group: 'Tabs', action: () => { switchTab('analytics'); closeFloatModal(); }, key: 'analytics reports stats' });
            items.push({ label: 'Tithing Analytics Card', group: 'Analytics', action: () => { switchTab('analytics'); closeFloatModal(); }, key: 'tithing analytics card tithe 10% monthly giving', priority: 100 });
            items.push({ label: 'Customers', group: 'Tabs', action: () => { switchTab('customers'); closeFloatModal(); }, key: 'customers client' });
            items.push({ label: 'Invoices & Receipts', group: 'Tabs', action: () => { switchTab('invoices'); closeFloatModal(); }, key: 'invoices receipts' });
            items.push({ label: 'Notes', group: 'Tabs', action: () => { switchTab('notes'); closeFloatModal(); }, key: 'notes' });
            items.push({ label: 'Profile', group: 'Tabs', action: () => { switchTab('account'); closeFloatModal(); }, key: 'profile account' });
            items.push({ label: 'Stock', group: 'Tabs', action: () => { switchTab('inventory'); closeFloatModal(); }, key: 'stock inventory' });
            items.push({ label: 'Inventory', group: 'Tabs', action: () => { switchTab('inventoryPurchases'); closeFloatModal(); }, key: 'inventory purchases' });
            items.push({ label: 'Categories', group: 'Tabs', action: () => { switchTab('categories'); closeFloatModal(); }, key: 'categories' });
            items.push({ label: '10% Profit Analysis', group: 'Analytics', action: () => { closeFloatModal(); openProfitShareAnalyticsModal(); }, key: 'profit analysis 10 percent' });
            items.push({ label: 'Tags & Organization', group: 'Tools', action: () => { closeFloatModal(); openTagsModal(); }, key: 'tags organization' });

            (state.notes || []).forEach((n, i) => {
                const title = String(n.title || '').trim();
                const content = String(n.content || '').trim();
                const lbl = title || (content ? content.slice(0, 48) : 'Note');
                items.push({ label: lbl, group: 'Notes', action: () => { switchTab('notes'); closeFloatModal(); openNoteModal(i); }, key: (`note ${title} ${content}`).toLowerCase() });
            });

            (state.expenses || []).forEach((e, i) => {
                const desc = String(e.description || e.title || '').trim();
                const cat = String(e.category || '').trim();
                const lbl = desc || cat || 'Expense';
                const amt = String(e.amount || '').trim();
                const comment = String(e.comment || '').trim();
                items.push({ label: lbl, group: 'Expenses', action: () => { switchTab('expenses'); closeFloatModal(); }, key: (`expense ${desc} ${cat} ${amt} ${comment} ${e.payment || ''}`).toLowerCase() });
            });

            (state.income || []).forEach((inc, i) => {
                const src = String(inc.source || '').trim();
                const amt = String(inc.amount || '').trim();
                const comment = String(inc.comment || '').trim();
                const lbl = src || 'Income';
                items.push({ label: lbl, group: 'Income', action: () => { switchTab('income'); closeFloatModal(); }, key: (`income ${src} ${amt} ${inc.payment || ''} ${comment}`).toLowerCase() });
            });

            (state.receipts || []).forEach((r, i) => {
                const num = String(r.number || '').trim();
                const cust = String(r.customer || '').trim();
                const desc = String(r.description || '').trim();
                const lbl = num || cust || 'Receipt';
                items.push({ label: lbl, group: 'Receipts', action: () => { switchTab('invoices'); closeFloatModal(); }, key: (`receipt ${num} ${cust} ${desc}`).toLowerCase() });
            });

            (state.sales || []).forEach((s) => {
                const prod = String(s.productName || '').trim();
                const cust = String(s.customer || '').trim();
                const status = String(s.status || 'paid').trim();
                const lbl = `${prod || 'Sale'}${status === 'unpaid' ? ' — Unpaid' : ''}`;
                const key = (`sale ${prod} ${cust} ${s.payment || ''} ${status} ${s.date || ''} ${s.time || ''}`).toLowerCase();
                const action = () => { switchTab('sales'); if (status === 'unpaid') { try { openUnpaidSalesModal(); } catch { } } closeFloatModal(); };
                items.push({ label: lbl, group: 'Sales', action, key });
            });

            (state.transactions || []).forEach((t) => {
                const ch = String(t.channel || '').trim();
                const tp = String(t.type || '').trim();
                const name = String(t.customerName || '').trim();
                const amt = String(t.amount || '').trim();
                const lbl = `${ch ? ch.toUpperCase() : 'TX'} ${tp ? tp.toUpperCase() : ''} ${name || ''}`.trim();
                items.push({ label: lbl || 'Transaction', group: 'Transactions', action: () => { switchTab('transactions'); try { switchTransactionChannel(ch || 'mpesa'); } catch { } closeFloatModal(); }, key: (`transaction ${ch} ${tp} ${name} ${amt}`).toLowerCase() });
            });

            (state.unpaidEntries || []).forEach((u) => {
                const name = String(u.name || '').trim();
                const tp = String(u.type || '').trim();
                const amt = String(u.amount || '').trim();
                const lbl = `${name || 'Unpaid'} – ${tp || ''}`.trim();
                items.push({ label: lbl || 'Unpaid Entry', group: 'Unpaid', action: () => { switchTab('unpaid'); closeFloatModal(); }, key: (`unpaid ${name} ${tp} ${amt} ${u.paid ? 'paid' : 'unpaid'}`).toLowerCase() });
            });

            try {
                const months = getLastMonths(12);
                months.forEach(m => {
                    const rec = ensureTithing(m.key);
                    const due = rec.due || 0;
                    const paid = rec.paid || 0;
                    const remaining = Math.max(0, due - paid);
                    const status = paid >= due ? 'PAID' : (paid > 0 ? 'PARTIAL' : 'UNPAID');
                    const currency = getCurrencySymbol();
                    const lbl = `Tithing — ${m.label}`;
                    const key = (`tithing ${m.label} ${status} ${due} ${paid} ${remaining}`).toLowerCase();
                    items.push({ label: lbl, group: 'Tithing', action: () => { state.tithingMonth = m.key; openTithingModal(); closeFloatModal(); }, key });
                });
                const curMonthKey = state.tithingMonth;
                const curMonth = curMonthKey ? curMonthKey.split('-') : [];
                const curLabel = curMonth.length === 2 ? (new Date(Number(curMonth[0]), Number(curMonth[1]) - 1, 1)).toLocaleString(undefined, { month: 'long', year: 'numeric' }) : 'Current Month';
                items.push({ label: `Tithing — ${curLabel}`, group: 'Tithing', action: () => { openTithingModal(); closeFloatModal(); }, key: (`tithing ${curLabel}`).toLowerCase() });
            } catch { }

            const seen = new Set();
            const uniq = [];
            for (let i = 0; i < items.length; i++) {
                const it = items[i];
                const id = String(it.group || '') + '|' + String(it.label || '');
                const key = id.toLowerCase();
                if (!seen.has(key)) { seen.add(key); uniq.push(it); }
            }
            return uniq;
        }

        function renderGlobalSearchResults(items, q, el) {
            const query = String(q || '').toLowerCase().trim();
            let results = items.slice();
            if (query) {
                results = items.filter(it => it.key.includes(query) || String(it.label).toLowerCase().includes(query));
                results.sort((a, b) => {
                    const aLabel = a.label.toLowerCase();
                    const bLabel = b.label.toLowerCase();
                    const aScore = (a.key.startsWith(query) || aLabel.startsWith(query)) ? 2 : (a.key.includes(query) || aLabel.includes(query)) ? 1 : 0;
                    const bScore = (b.key.startsWith(query) || bLabel.startsWith(query)) ? 2 : (b.key.includes(query) || bLabel.includes(query)) ? 1 : 0;
                    const prA = Number(a.priority || 0);
                    const prB = Number(b.priority || 0);
                    const ag = String(a.group || '').toLowerCase();
                    const bg = String(b.group || '').toLowerCase();
                    const gpA = ag === 'tabs' ? 100 : ag === 'tithing' ? 95 : ag === 'analytics' ? 90 : (ag === 'reports' || ag === 'actions') ? 80 : ag === 'tools' ? 70 : 50;
                    const gpB = bg === 'tabs' ? 100 : bg === 'tithing' ? 95 : bg === 'analytics' ? 90 : (bg === 'reports' || bg === 'actions') ? 80 : bg === 'tools' ? 70 : 50;
                    if (prA !== prB) return prB - prA;
                    if (gpA !== gpB) return gpB - gpA;
                    if (aScore !== bScore) return bScore - aScore;
                    return a.label.localeCompare(b.label);
                });
            } else {
                if (el) { el.innerHTML = ''; }
                return;
            }
            if (el) {
                el.innerHTML = results.map((it, idx) => `
                    <div class="search-item-card" data-index="${idx}" style="padding:10px; border-radius:10px; background: rgba(25,118,210,0.08); margin-bottom:8px; display:flex; align-items:center; justify-content:space-between; cursor:pointer;">
                        <div>
                            <div style="font-weight:700; font-size:14px;">${it.label}</div>
                            <div style="font-size:11px; color:#666;">${it.group}</div>
                        </div>
                        <button class="btn-small search-item-btn" data-index="${idx}">Go</button>
                    </div>
                `).join('');
                Array.from(el.querySelectorAll('.search-item-btn')).forEach(btn => {
                    btn.addEventListener('click', function (e) {
                        e.stopPropagation();
                        const idx = Number(this.getAttribute('data-index'));
                        const it = results[idx];
                        try { closeFloatModal(); } catch { }
                        try { it.action(); } catch { }
                    });
                });
                Array.from(el.querySelectorAll('.search-item-card')).forEach(card => {
                    card.addEventListener('click', function () {
                        const idx = Number(this.getAttribute('data-index'));
                        const it = results[idx];
                        try { closeFloatModal(); } catch { }
                        try { it.action(); } catch { }
                    });
                });
            }
        }

        function refreshGlobalSearchIfOpen() {
            const modal = document.getElementById('floatModal');
            if (!modal || !modal.classList.contains('show')) return;
            const input = document.getElementById('globalSearchInput');
            const resultsEl = document.getElementById('globalSearchResults');
            const items = buildGlobalSearchItems();
            renderGlobalSearchResults(items, input ? input.value : '', resultsEl);
        }

        let __scrollHintTimer = null;
        let __scrollHintTarget = null;
        let __scrollHintDirection = 'down';
        function getRootScroller(){ try { return document.scrollingElement || document.documentElement; } catch { return document.documentElement; } }
        function canScroll(el){ try { if (!el) return false; if (el === document || el === document.body || el === document.documentElement) el = getRootScroller(); return (el.scrollHeight || 0) > (el.clientHeight || 0); } catch { return false; } }
        function initScrollHint() {
            const btn = document.createElement('button');
            btn.id = 'scrollHintBtn';
            btn.className = 'scroll-hint-btn';
            btn.setAttribute('aria-label', 'Scroll');
            btn.textContent = '↓';
            btn.onclick = handleScrollHintClick;
            document.body.appendChild(btn);
            updateScrollHintBottom();
            window.addEventListener('scroll', function () { onScrollEvent(getRootScroller()); });
            window.addEventListener('resize', updateScrollHintBottom);
            window.addEventListener('orientationchange', updateScrollHintBottom);
            document.addEventListener('scroll', function () {
                onScrollEvent(getRootScroller());
            }, true);
        }

        function updateScrollHintBottom() {
            try {
                const btn = document.getElementById('scrollHintBtn');
                if (!btn) return;
                let targetBottom = 80;
                const fab = document.getElementById('globalSearchFab');
                if (fab) {
                    const cs = window.getComputedStyle(fab);
                    const b = parseInt(cs.bottom || '80', 10);
                    if (!isNaN(b)) targetBottom = b;
                }
                const nav = document.getElementById('bottomNav');
                const navHeight = nav && nav.offsetHeight ? nav.offsetHeight : 0;
                if (navHeight > 0) {
                    targetBottom = Math.max(targetBottom, navHeight + 12);
                }
                const supportsEnv = !!(window.CSS && CSS.supports && CSS.supports('bottom', 'calc(1px + env(safe-area-inset-bottom))'));
                if (supportsEnv) {
                    btn.style.bottom = `calc(${targetBottom}px + env(safe-area-inset-bottom) + 17px)`;
                } else {
                    btn.style.bottom = (targetBottom + 17) + 'px';
                }
            } catch { }
        }
        function getScrollMetrics(el) {
            let st = 0, ch = 0, sh = 0;
            if (el === document || el === document.body || el === document.documentElement) {
                const root = getRootScroller();
                st = root.scrollTop || window.pageYOffset || 0;
                ch = root.clientHeight || document.documentElement.clientHeight;
                sh = root.scrollHeight || Math.max(document.documentElement.scrollHeight, document.body.scrollHeight);
            } else {
                st = el.scrollTop;
                ch = el.clientHeight;
                sh = el.scrollHeight;
            }
            const atTop = st <= 10;
            const atBottom = (st + ch) >= (sh - 10);
            return { st, ch, sh, atTop, atBottom };
        }
        function onScrollEvent(el) {
            const root = getRootScroller();
            __scrollHintTarget = root;
            const m = getScrollMetrics(root);
            const btn = document.getElementById('scrollHintBtn');
            if (!btn) return;
            if (!canScroll(root)) { btn.classList.remove('show'); return; }
            __scrollHintDirection = m.atBottom ? 'up' : 'down';
            if (m.atTop) __scrollHintDirection = 'down';
            btn.textContent = __scrollHintDirection === 'up' ? '↑' : '↓';
            btn.classList.add('show');
            if (__scrollHintTimer) clearTimeout(__scrollHintTimer);
            __scrollHintTimer = setTimeout(function () { try { btn.classList.remove('show'); } catch { } }, 1000);
        }
        function handleScrollHintClick() {
            const root = getRootScroller();
            const el = canScroll(__scrollHintTarget) ? __scrollHintTarget : root;
            const m = getScrollMetrics(el);
            if (__scrollHintDirection === 'up') {
                if (el === root) window.scrollTo({ top: 0, behavior: 'smooth' });
                else el.scrollTo({ top: 0, behavior: 'smooth' });
            } else {
                const dest = Math.max(0, m.sh - m.ch);
                if (el === root) window.scrollTo({ top: dest, behavior: 'smooth' });
                else el.scrollTo({ top: dest, behavior: 'smooth' });
            }
        }
        try { initScrollHint(); } catch { }




        function ensureWalkIn() {
            if (!state.customers) state.customers = [];
            const exists = state.customers.some(c => c && c.name && c.name.toString().toLowerCase().includes('walk'));
            if (!exists) {
                state.customers.unshift({ name: 'WALK IN', email: '', phone: '', address: '', totalPurchases: 0 });
                saveData();
            }
        }
        ensureWalkIn();

        function renderDashboard() {
            const stats = getStats();
            const lowStockProducts = state.products.filter(p => {
                const inv = state.inventory[p.name] || { stock: 0, minAlert: 5 };
                return (p.hasStock !== false) && (inv.stock <= inv.minAlert);
            });

            const unpaidCount = state.unpaidEntries.filter(e => !e.paid).length;
            const unpaidAmount = state.unpaidEntries.filter(e => !e.paid).reduce((sum, e) => sum + (e.amount || 0), 0);

            const dailyProgress = state.dailyTarget > 0 ? (stats.todayProfit / state.dailyTarget * 100) : 0;
            const monthlyProgress = state.monthlyTarget > 0 ? (stats.monthProfit / state.monthlyTarget * 100) : 0;

            return `
    <div class="privacy-container">
        <button class="privacy-toggle-btn show" id="dashboardPrivacyToggleBtn" onclick="toggleDashboardPrivacy()" aria-pressed="${state.dashboardPrivacyBlurred ? 'true' : 'false'}" title="Toggle privacy" aria-label="Toggle privacy">
            ${state.dashboardPrivacyBlurred ? '🔒' : '🔓'}
        </button>
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-bottom: 12px;">
            <div class="stat-card ${state.dashboardPrivacyBlurred ? 'privacy-blur' : ''}" onclick="switchTab('sales')" style="padding: 12px;">
                <div class="stat-label" style="font-size: 10px;">TODAY'S PROFIT</div>
                <div class="stat-value" style="font-size: 16px;"><span class="money-text"> ${formatMoney(stats.todayProfit)} Tsh</span></div>
                <div class="stat-subvalue" style="font-size: 11px;">${stats.todaySalesCount} sales today</div>
                ${(() => { const t = getTodayDateString(); const total = (state.expenses || []).filter(e => e.date === t).reduce((sum, e) => sum + (Number(e.amount) || 0), 0); const cap = Number(stats.todayCapital || 0); const expLine = total > 0 ? `<div class=\"stat-subvalue\" style=\"font-size: 10px;\"><span class=\"money-text\">Expenses today: ${formatNumber(total)} Tsh</span></div>` : ''; const capLine = cap > 0 ? `<div class=\"stat-subvalue\" style=\"font-size: 10px;\"><span class=\"money-text\">Capital today: ${formatNumber(cap)} Tsh</span></div>` : `<div class=\"stat-subvalue\" style=\"font-size: 10px;\"><span class=\"money-text\">Capital today: 0 Tsh</span></div>`; return expLine + capLine; })()}
            ${state.dailyTarget > 0 ? `
                <div class="progress-bar" style="height: 6px; margin-top: 6px;">
                    <div class="progress-fill" style="width: ${Math.min(dailyProgress, 100)}%"></div>
                </div>
                <div class="stat-subvalue" style="font-size: 10px; margin-top: 4px;">${dailyProgress.toFixed(0)}% of target</div>
            ` : ''}
        </div>
        
        <div class="stat-card ${state.dashboardPrivacyBlurred ? 'privacy-blur' : ''}" onclick="openAvailableCapitalModal()" style="padding: 12px;">
            <div class="stat-label" style="font-size: 10px;">AVAILABLE CAPITAL</div>
            <div class="stat-value" style="font-size: 16px;"><span class="money-text"> ${formatNumber(stats.availableCapital || 0)} Tsh</span></div>
            <div class="stat-subvalue" style="font-size: 10px;">Inventory spend: ${formatNumber(stats.inventorySpendTotal || 0)} Tsh</div>
            <div class="stat-subvalue" style="font-size: 10px;">Stock value: ${formatNumber(stats.inventoryStockValue || 0)} Tsh</div>
        </div>

        <div class="stat-card ${state.dashboardPrivacyBlurred ? 'privacy-blur' : ''}" onclick="switchTab('analytics')" style="padding: 12px;">
            <div class="stat-label" style="font-size: 10px;">MONTH PROFIT</div>
            <div class="stat-value" style="font-size: 16px;"><span class="money-text"> ${formatMoney(stats.monthProfit)} Tsh</span></div>
            <div class="stat-subvalue" style="font-size: 10px;"><span class="money-text">Revenue: ${formatMoney(stats.monthRevenue)} Tsh</span></div>
            ${(() => { const now = new Date(); const ms = new Date(now.getFullYear(), now.getMonth(), 1); const monthStart = `${ms.getFullYear()}-${String(ms.getMonth() + 1).padStart(2, '0')}-${String(ms.getDate()).padStart(2, '0')}`; const total = (state.expenses || []).filter(e => new Date(e.date) >= new Date(monthStart)).reduce((sum, e) => sum + (Number(e.amount) || 0), 0); return total > 0 ? `<div class=\"stat-subvalue\" style=\"font-size: 10px;\"><span class=\"money-text\">Expenses this month: ${formatMoney(total)} Tsh</span></div>` : ''; })()}
            ${state.monthlyTarget > 0 ? `
                <div class="progress-bar" style="height: 6px; margin-top: 6px;">
                    <div class="progress-fill" style="width: ${Math.min(monthlyProgress, 100)}%"></div>
                </div>
                <div class="stat-subvalue" style="font-size: 10px; margin-top: 4px;">${monthlyProgress.toFixed(0)}% of target</div>
            ` : ''}
        </div>

        <div class="stat-card ${state.dashboardPrivacyBlurred ? 'privacy-blur' : ''}" onclick="switchTab('analytics')" style="background: ${stats.monthNetProfit >= 0 ? '#2e7d32' : '#d32f2f'}; padding: 12px;">
            <div class="stat-label" style="font-size: 10px;">NET PROFIT (MONTH)</div>
            <div class="stat-value" style="font-size: 16px;"><span class="money-text"> ${formatMoney(stats.monthNetProfit)} Tsh</span></div>
            <div class="stat-subvalue" style="font-size: 10px;"><span class="money-text">Income: ${formatMoney(stats.monthIncome)} Tsh</span> | <span class="money-text">Expenses: ${formatMoney(stats.monthExpenses || 0)} Tsh</span></div>
        </div>

        <div class="stat-card ${state.dashboardPrivacyBlurred ? 'privacy-blur' : ''}" onclick="openTithingModal()" style="padding: 12px;">
            ${(() => {
                    const curKey = getMonthKey(new Date()); const rec = ensureTithing(curKey); const due = rec.due || 0; const paid = rec.paid || 0; const remain = Math.max(0, due - paid); return `
            <div class=\"stat-label\" style=\"font-size: 10px;\">10% (MONTH)</div>
            <div class=\"stat-value\" style=\"font-size: 16px;\"><span class=\"money-text\"> ${formatMoney(due)} Tsh</span></div>
            <div class=\"stat-subvalue\" style=\"font-size: 10px;\"><span class=\"money-text\">Paid: ${formatMoney(paid)} Tsh</span> | <span class=\"money-text\">Remaining: ${formatMoney(remain)} Tsh</span></div>
            `;
                })()}
        </div>

        <div class="stat-card ${state.dashboardPrivacyBlurred ? 'privacy-blur' : ''}" onclick="switchTab('inventory')" style="padding: 12px;">
            <div class="stat-label" style="font-size: 10px;">LOW STOCK ALERT</div>
            <div class="stat-value" style="font-size: 18px;">${lowStockProducts.length}</div>
            <div class="stat-subvalue" style="font-size: 10px;">${lowStockProducts.length > 0 ? '⚠️ Check inventory' : '✅ All good'}</div>
        </div>
    </div>
    </div>

                ${lowStockProducts.length > 0 ? `
                    <button class="collapse-btn" onclick="switchTab('inventory')" aria-label="Go to Inventory">
                        <span style="font-weight:700;">⚠️ Low Stock Alert</span>
                        <span style="font-size:12px;display:block;margin-top:4px;">${lowStockProducts.slice(0, 3).map(p => `${p.name}`).join(', ')}${lowStockProducts.length > 3 ? `, +${lowStockProducts.length - 3} more` : ''}</span>
                    </button>
                ` : ''}

                ${unpaidCount > 0 ? `
                    <button class="collapse-btn" onclick="goToUnpaidFromDashboard()" aria-label="Go to Unpaid Entries">
                        <span style="font-weight:700;"> Pending Payments</span>
                        <span style="font-size:12px;display:block;margin-top:4px;">${unpaidCount} unpaid entries • Total ${formatNumber(unpaidAmount)} Tsh</span>
                    </button>
                ` : ''}

                    <div class="card">
                    <h2>Quick Actions</h2>
                    <div class="flex-gap">
                        <button class="btn-success btn-small" onclick="switchTab('sales')">➕ New Sale</button>
                        <button class="btn-danger btn-small" onclick="switchTab('expenses')">💸 Add Expense</button>
                        <button class="btn-success btn-small" onclick="switchTab('income')"> Add Income</button>
                        <button class="btn-small" onclick="switchTab('notes')" style="background: linear-gradient(145deg, #e65100, #bf360c); color: white;">📝 Notes</button>
                        <button class="btn-small" onclick="switchTab('invoices')" style="background: linear-gradient(145deg, #1976d2, #0d47a1); color: white;">📄 Invoices</button>
                        <button class="btn-small" onclick="switchTab('analytics')" style="background: linear-gradient(145deg, #7b1fa2, #4a148c); color: white;">📈 Analytics</button>
                        <button class="btn-small" onclick="switchTab('transactions')">💳 Transactions</button>
                        <button class="btn-small" onclick="switchTab('products')">🛒 Products/Services</button>
                        <button class="btn-small" onclick="switchTab('inventoryPurchases')">📦 Inventory</button>
                        <button class="btn-small" onclick="switchTab('assets')" style="background: linear-gradient(145deg, #2e7d32, #1b5e20); color: white;">🏗️ Assets</button>
                        <button class="btn-small" onclick="switchTab('maintenance')" style="background: linear-gradient(145deg, #f57c00, #e65100); color: white;">🛠️ Maintenance</button>
                    </div>
                </div>
                <div class="card">
                    <h2>Tools</h2>
                    <div class="flex-gap">
                        ${currentUser ? `<button class="btn-small btn-secondary" type="button" onclick="openPinSetModal()">🔐 Set/Change Security PIN</button>` : ''}
                    </div>
                </div>

                <div class="card">
                    <h2>Yesterday's Profit</h2>
                    <div class="stat-value" style="font-size: 16px;"><span class="money-text"> ${formatMoney(stats.yesterdayProfit)} Tsh</span></div>
                    <div class="stat-subvalue" style="font-size: 10px;">
                        ${stats.todayProfit > stats.yesterdayProfit ? '📈 Better!' :
                            stats.todayProfit < stats.yesterdayProfit ? '📉 Lower' : '➡️ Same'}
                    </div>
                    ${(() => { const d = new Date(Date.now() - 86400000); const y = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`; const total = (state.expenses || []).filter(e => e.date === y).reduce((sum, e) => sum + (Number(e.amount) || 0), 0); return total > 0 ? `<div class=\"stat-subvalue\" style=\"font-size: 10px;\">Expenses yesterday: ${formatNumber(total)} Tsh</div>` : ''; })()}
                </div>

                <div class="card" id="dailyTargetCard">
                    <h2>Set Daily Target</h2>
                    <div class="form-group">
                        <label>Daily Profit Target (Tsh)</label>
                        <input type="text" class="money-input" id="dailyTarget" value="${formatMoney(state.dailyTarget || 0)}">
                    </div>
                    <button onclick="setDailyTarget()">Save Target</button>
                    <div class="stat-subvalue" style="font-size: 10px; margin-top: 6px;">
                        Daily target progress is shown on the Sales dashboard as a circular bar.
                    </div>
                </div>

                <div class="card">
                    <h2>Set Monthly Target</h2>
                    <div class="form-group">
                        <label>Monthly Profit Target (Tsh)</label>
                        <input type="text" class="money-input" id="monthlyTarget" value="${formatMoney(state.monthlyTarget || 0)}">
                    </div>
                    <button onclick="setMonthlyTarget()">Save Target</button>
                </div>

                <div class="card">
                    <h2>Recent Activity</h2>
                    ${state.sales.slice().sort((a, b) => Number(b.timestamp) - Number(a.timestamp)).slice(0, 3).map(s => `
                        <div class="item">
                            <div class="item-header">
                                <span class="item-title">${s.productName}</span>
                                <span style="color: #2e7d32; font-weight: 700;"> ${formatNumber(s.profit)} Tsh</span>
                            </div>
                            <div class="item-subtitle">
                                ${s.date} ${s.time} | ${s.customer}
                            </div>
                        </div>
                    `).join('') || '<p style="text-align: center; color: #666;">No recent activity</p>'}
                </div>
            `;
        }

        async function setDailyTarget() {
            const el = document.getElementById('dailyTarget');
            const value = parseMoney(el?.value) || 0;
            if (value < 0 || value > 999999999) return showToast('Enter amount between 0 and 999,999,999', 'error');
            state.dailyTarget = value;
            saveData();
            showToast('Daily target updated', 'success');
            if (syncEnabled) {
                await upsertOne('settings', { daily_target: value });
                const ok = await verifyCloudSettings('daily_target', value);
                if (!ok) { showToast('Cloud verify failed; will retry', 'info'); }
                syncInBackground();
            }
            render();
        }

        async function setMonthlyTarget() {
            const el = document.getElementById('monthlyTarget');
            const value = parseMoney(el?.value) || 0;
            if (value < 0 || value > 999999999) return showToast('Enter amount between 0 and 999,999,999', 'error');
            state.monthlyTarget = value;
            saveData();
            showToast('Monthly target updated', 'success');
            if (syncEnabled) {
                await upsertOne('settings', { monthly_target: value });
                const ok = await verifyCloudSettings('monthly_target', value);
                if (!ok) { showToast('Cloud verify failed; will retry', 'info'); }
                syncInBackground();
            }
            render();
        }

        async function verifyCloudSettings(field, expected) {
            try {
                const { data, error } = await supabase.from('settings').select(field).eq('user_id', currentUser.id).single();
                if (error) return false;
                const val = parseFloat(data?.[field] || 0);
                return Math.round(val) === Math.round(expected);
            } catch { return false; }
        }

        function renderAccount() {
            // Get profile data (works offline or online)
            const profile = getUserProfileData();

            // Check if profile is incomplete
            const isProfileIncomplete = !profile.businessName || !profile.phone || !profile.address;

            if (!currentUser) {
                // NOT SIGNED IN VIEW
                return `
            ${isProfileIncomplete && state.profileEditMode ? `
                <div class="alert-box" style="animation: highlightFade 2s ease-out;">
                    <strong>📋 Complete Your Profile!</strong><br>
                    Please fill in your business information below for personalized invoices and reports.
                </div>
            ` : ''}
            <div class="card" id="cloudSyncCard">
                <h2>☁️ Cloud Sync</h2>
                <p style="margin-bottom: 16px; color: #666;">
                    Sign in to sync your data across all devices!
                </p>
                
                <div class="transaction-tabs" style="margin-bottom: 20px;">
                    <button class="transaction-tab mpesa active" id="loginTab" onclick="switchAuthTab('login')">
                        Sign In
                    </button>
                    <button class="transaction-tab crdb" id="signupTab" onclick="switchAuthTab('signup')">
                        Sign Up
                    </button>
                </div>

                <div id="loginForm">
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="loginEmail" placeholder="your@email.com" name="username" autocomplete="username" autocapitalize="none" autocorrect="off">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <div style="display:flex;align-items:center;gap:8px;">
                            <input type="password" id="loginPassword" placeholder="••••••••" name="current-password" autocomplete="current-password" style="flex:1;" oninput="this.value=this.value; var t=document.getElementById('loginPasswordToggle'); if(t) t.style.display = this.value.length>0 ? 'inline-flex' : 'none';">
                            <button class="btn-secondary btn-small" id="loginPasswordToggle" style="display:none;" onclick="(function(){ var i=document.getElementById('loginPassword'); if(!i) return; i.type = (i.type==='password')?'text':'password'; })()" title="👁">👁</button>
                        </div>
                    </div>
                    <button onclick="handleSignIn()">Sign In</button>
                    <div style="text-align:center;margin-top:8px;"></div>
                    <div style="text-align:center;margin-top:12px;">
                        <button class="btn-small btn-secondary" style="width:auto;display:inline-block;padding:6px 12px;font-size:12px;" onclick="openPasswordResetModal()">🔑 Forgot Password?</button>
                    </div>
                </div>

                <div id="signupForm" style="display: none;">
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="signupEmail" placeholder="your@email.com">
                    </div>
                    <div class="form-group">
                        <label>Password (min 6 characters)</label>
                        <div style="display:flex;align-items:center;gap:8px;">
                            <input type="password" id="signupPassword" placeholder="••••••••" style="flex:1;" oninput="this.value=this.value; var t=document.getElementById('signupPasswordToggle'); if(t) t.style.display = this.value.length>0 ? 'inline-flex' : 'none';">
                            <button class="btn-secondary btn-small" id="signupPasswordToggle" style="display:none;" onclick="(function(){ var i=document.getElementById('signupPassword'); if(!i) return; i.type = (i.type==='password')?'text':'password'; })()" title="👁">👁</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Confirm Password</label>
                        <div style="display:flex;align-items:center;gap:8px;">
                            <input type="password" id="signupPasswordConfirm" placeholder="••••••••" style="flex:1;" oninput="this.value=this.value; var t=document.getElementById('signupPasswordConfirmToggle'); if(t) t.style.display = this.value.length>0 ? 'inline-flex' : 'none';">
                            <button class="btn-secondary btn-small" id="signupPasswordConfirmToggle" style="display:none;" onclick="(function(){ var i=document.getElementById('signupPasswordConfirm'); if(!i) return; i.type = (i.type==='password')?'text':'password'; })()" title="👁">👁</button>
                        </div>
                    </div>
                    <button onclick="handleSignUp()">Create Account</button>
                </div>

                <div class="alert-info">
                    <strong>Benefits of Cloud Sync:</strong>
                    <ul style="margin-top: 8px; padding-left: 20px; font-size: 13px; color: #666;">
                        <li>Access from any device</li>
                        <li>Automatic backup</li>
                        <li>Real-time updates</li>
                        <li>Never lose data</li>
                    </ul>
                </div>
                ${currentUser ? `
                <div class="card" style="margin-top:12px;">
                    <h3>Security</h3>
                    <p style="color:#666;font-size:13px;margin-bottom:8px;">This PIN is required for safety of your data.</p>
                    <button class="btn-secondary" type="button" onclick="openPinSetModal()">Set/Change Security PIN</button>
                </div>
                ` : ''}
            </div>
            
                <div class="card" id="userProfileCard">
                <h2>👤 User Profile (Offline Mode)</h2>
                <div class="card-header-buttons">
                    <button class="btn-small" onclick="copyUserProfile()">📋 Copy Profile</button>
                    ${!state.profileEditMode ? `<button type="button" class="btn-small" onclick="enableProfileEdit()" title="✏️ Edit">✏️ Edit</button>` : ''}
                </div>
                <div class="alert-info" style="margin-bottom: 16px;">
                    <strong>ℹ️ Offline Profile:</strong> Your profile is saved locally. Sign in to sync across devices.
                </div>
                <form onsubmit="updateUserProfile(event)">
                    <div class="form-group">
                        <label>Business Name</label>
                        <input 
                            type="text"
                            id="profileBusinessName"
                            value="${profile.businessName}"
                            placeholder="Enter business name"
                            ${state.profileEditMode ? '' : 'readonly'}
                            required>
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input 
                            type="email" 
                            id="profileEmail" 
                            value="${profile.email}" 
                            placeholder="youremail@domain.com" 
                            ${state.profileEditMode ? '' : 'readonly'}
                            required>
                    </div>
                    <div class="form-group">
                        <label>Phone Number</label>
                        <input 
                            type="tel" 
                            id="profilePhone" 
                            value="${profile.phone}" 
                            placeholder="+00000000000" 
                            ${state.profileEditMode ? '' : 'readonly'}
                            required>
                    </div>
                    <div class="form-group">
                        <label>Country</label>
                        <input type="text" id="profileCountry" value="${profile.country}" placeholder="Type country" ${state.profileEditMode ? '' : 'readonly'}>
                    </div>
                    <div class="form-group">
                        <label>City</label>
                        <input type="text" id="profileCity" value="${profile.city}" placeholder="Type city" ${state.profileEditMode ? '' : 'readonly'}>
                    </div>
                    <div class="form-group">
                        <label>Address</label>
                        <input 
                            type="text" 
                            id="profileAddress" 
                            value="${profile.address}" 
                            placeholder="your Address" 
                            ${state.profileEditMode ? '' : 'readonly'}
                            required>
                    </div>
                    <div class="form-group">
                        <label>TIN Number</label>
                        <input type="text" id="profileTIN" value="${profile.tinNumber || profile.vatNumber || ''}" ${state.profileEditMode ? '' : 'readonly'} placeholder="e.g., 12345678">
                    </div>
                    <div class="form-group">
                        <label>BL-No (Business License)</label>
                        <input type="text" id="profileBLNo" value="${profile.blNumber || ''}" ${state.profileEditMode ? '' : 'readonly'} placeholder="e.g., BL-000123">
                    </div>
                    <div class="form-group">
                        <label>Business VAT</label>
                        <select id="profileHasVAT" onchange="toggleVatInput()" ${state.profileEditMode ? '' : 'disabled'}>
                            <option value="no" ${profile.hasVAT ? '' : 'selected'}>Has no VAT</option>
                            <option value="yes" ${profile.hasVAT ? 'selected' : ''}>Has VAT</option>
                        </select>
                    </div>
                    <div class="form-group" id="vatGroup" style="${profile.hasVAT ? '' : 'display:none;'}">
                        <label>VAT Number</label>
                        <input type="text" id="profileVAT" value="${profile.vatNumber || ''}" ${state.profileEditMode ? '' : 'readonly'} placeholder="e.g., 12345678">
                    </div>
                    <div class="form-group" id="vatPlaceholder" style="${profile.hasVAT ? 'display:none;' : ''}">
                        <label>VAT Number</label>
                        <div>-</div>
                    </div>
                    
                    <div style="display: flex; gap: 12px;">
                        <button 
                            type="submit" 
                            class="btn-success" 
                            style="flex: 1; ${state.profileEditMode ? '' : 'opacity: 0.5; cursor: not-allowed;'}"
                            ${state.profileEditMode ? '' : 'disabled'}>
                            💾 Save Profile
                        </button>
                        
                        ${state.profileEditMode ? `
                            <button 
                                type="button" 
                                class="btn-secondary" 
                                style="flex: 1;"
                                onclick="cancelProfileEdit()">
                                ✖ Cancel
                            </button>
                        ` : `
                            <button 
                                type="button" 
                                class="btn" 
                                style="flex: 1;"
                                onclick="enableProfileEdit()">
                                ✏️ Edit
                            </button>
                        `}
                </div>
                </form>
                <div class="card" style="margin-top:12px;">
                    <h3>Business Settings</h3>
                    <div class="card-header-buttons">
                        ${!state.profileEditMode ? `<button type="button" class="btn-small" onclick="enableProfileEdit()" title="✏️ Edit">✏️ Edit</button>` : ''}
                    </div>
                    <div class="form-group">
                        <label>Role</label>
                        <select id="profileRole" ${state.profileEditMode ? '' : 'disabled'}>
                            <option value="owner" ${profile.role === 'owner' ? 'selected' : ''}>Owner</option>
                            <option value="manager" ${profile.role === 'manager' ? 'selected' : ''}>Manager</option>
                            <option value="cashier" ${profile.role === 'cashier' ? 'selected' : ''}>Cashier</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Currency Code</label>
                        <input type="text" id="currencyCode" value="${state.currencyCode || 'TZS'}" placeholder="TZS">
                    </div>
                <div class="form-group">
                    <label>Currency Symbol</label>
                    <input type="text" id="currencySymbol" value="${state.currencySymbol || 'Tsh'}" placeholder="Tsh">
                </div>
                <div class="form-group">
                    <label>Cost of Goods Method</label>
                    <select id="cogsMethod">
                        <option value="product_cost" ${String(state.cogsMethod || 'product_cost') === 'product_cost' ? 'selected' : ''}>Use Product Cost</option>
                        <option value="avg_purchase_cost" ${String(state.cogsMethod || 'product_cost') === 'avg_purchase_cost' ? 'selected' : ''}>Average Purchase Cost</option>
                        <option value="fifo" ${String(state.cogsMethod || 'product_cost') === 'fifo' ? 'selected' : ''}>FIFO (first-in-first-out)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Default Tax Rate (%)</label>
                    <input type="number" id="defaultTaxRate" value="${typeof state.defaultTaxRate === 'number' ? state.defaultTaxRate : 0}" step="0.01" min="0" max="100">
                </div>
                <button class="btn-success" onclick="(function(){ const roleEl=document.getElementById('profileRole'); const codeEl=document.getElementById('currencyCode'); const symEl=document.getElementById('currencySymbol'); const taxEl=document.getElementById('defaultTaxRate'); const cogsEl=document.getElementById('cogsMethod'); const newRole=roleEl?roleEl.value:'owner'; const newCode=codeEl?codeEl.value:'TZS'; const newSym=symEl?symEl.value:'Tsh'; const newTax=taxEl?parseFloat(taxEl.value||'0'):0; const newCogs=cogsEl?cogsEl.value:'product_cost'; state.userProfile.role=newRole; saveData(); setCurrency(newCode,newSym); state.__currencyAppliedOnce=false; applyCurrencySymbols(); state.defaultTaxRate=newTax; state.cogsMethod=newCogs; saveData(); if(syncEnabled&&currentUser){ upsertOne('settings',{ currency_code: state.currencyCode, currency_symbol: state.currencySymbol, default_tax_rate: state.defaultTaxRate, cogs_method: state.cogsMethod }); } showToast('Settings updated', 'success'); })()">Save Settings</button>
                </div>
                <div class="card" style="margin-top:12px;">
                    <h3>Notifications</h3>
                    <p style="color:#666;font-size:13px;margin-bottom:8px;">Enable push notifications to get alerts for new sales.</p>
                    <button class="btn" onclick="subscribeToPush()">Enable Notifications</button>
                </div>
                <div class="card" style="margin-top:12px;">
                    <h3>Push Preferences</h3>
                    <div class="form-group">
                        <label><input type="checkbox" id="pushPrefMorning" ${((state.pushPrefs||{}).morning !== false) ? 'checked' : ''}> Morning reminder</label>
                    </div>
                    <div class="form-group">
                        <label><input type="checkbox" id="pushPrefEvening" ${((state.pushPrefs||{}).evening !== false) ? 'checked' : ''}> Evening reminder</label>
                    </div>
                    <div class="form-group">
                        <label><input type="checkbox" id="pushPrefBackup" ${((state.pushPrefs||{}).backup !== false) ? 'checked' : ''}> Backup reminder</label>
                    </div>
                    <div class="form-group">
                        <label><input type="checkbox" id="pushPrefDestructive" ${((state.pushPrefs||{}).destructive !== false) ? 'checked' : ''}> Destructive operation alerts</label>
                    </div>
                    <button class="btn-success" onclick="savePushPreferences()">Save Push Preferences</button>
                </div>
                <div class="card" style="margin-top: 12px;">
                    <h3>🖼️ Business Logo</h3>
                    <p style="color:#666;font-size:13px;margin-bottom:8px;">Upload your logo (PNG/JPEG). It appears on all PDFs before your business name.</p>
                    <div style="display:flex;align-items:center;gap:12px;">
                        <div id="logoPreview" style="width:64px;height:64px;border-radius:50%;background:#f5f5f5;border:2px solid rgba(0,0,0,0.12);display:flex;align-items:center;justify-content:center;overflow:hidden;">
                        ${(state.userLogoDataUrl)
                        ? `<img src="${state.userLogoDataUrl}" alt="Logo" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">`
                        : '<span style="font-size:12px;color:#999;">No logo</span>'}
                        </div>
                        <button class="btn-secondary" onclick="triggerLogoUpload()">Upload Logo</button>
                    </div>
                    <small style="display:block;color:#888;margin-top:6px;">Recommended size: 256×256 px (auto-resized).</small>
                </div>
            </div>
            
            
        `;
            }

            // SIGNED IN VIEW
            return `
        <div class="card">
            <h2>☁️ Account</h2>
            <div class="alert-success">
                <div style="font-size: 14px; margin-bottom: 8px;">
                    ✔ Connected to Cloud
                </div>
                <div style="font-size: 13px;">
                    📧 ${currentUser.email}
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                <button onclick="pullFromCloud()" class="btn-success">
                    ⬇️ Pull from Cloud
                </button>
                <button onclick="pushToCloud()" class="btn-success">
                    ⬆️ Push to Cloud
                </button>
            </div>

            <button onclick="syncAllData()" class="btn" style="margin-bottom: 12px;">
                🔄 Smart Sync
            </button>

            <button onclick="cleanDuplicatesFromUI()" class="btn-danger" style="margin-bottom: 12px;">
                🧹 Clean Cloud Duplicates
            </button>
            ${currentUser ? `
            <button onclick="openChangePasswordModal()" class="btn" style="margin-bottom: 12px;" title="Reset Password">
                Reset Password
            </button>
            ` : ''}
            
            <button onclick="signOut()" class="btn-danger" style="margin-bottom: 12px;">
                Sign Out
            </button>
            <div class="card" style="margin-top:12px;">
                <h3>Security</h3>
                <p style="color:#666;font-size:13px;margin-bottom:8px;">This PIN is required for safety of your data.</p>
                <button class="btn-secondary" type="button" onclick="openPinSetModal()">Set/Change Security PIN</button>
            </div>


            <div class="alert-info">
                <strong>Sync Options:</strong><br>
                • <strong>Pull from Cloud:</strong> Download cloud data (overwrites local)<br>
                • <strong>Push to Cloud:</strong> Upload local data (overwrites cloud)<br>
                • <strong>Smart Sync:</strong> Auto-detect which direction to sync
            </div>
            <div class="card" style="margin-top:12px;">
                <h3>DANGER ZONE ⚠️⚠️</h3>
                <p style="color:#b91c1c;font-size:13px;margin-bottom:8px;">These actions are permanent and cannot be undone.</p>
                <div class="flex-gap" style="flex-direction:column;align-items:stretch;">
                    <button onclick="confirmDeleteAccount()" class="btn-danger" style="margin-bottom: 8px;">
                        ❌ Delete Account Permanently
                    </button>
                    <button onclick="confirmDeleteData()" class="btn-danger">
                        🗑️ Delete All My Data
                    </button>
                </div>
            </div>
        </div>

        ${isProfileIncomplete && state.profileEditMode ? `
            <div class="alert-box" style="animation: highlightFade 2s ease-out;">
                <strong>📋 Complete Your Profile!</strong><br>
                Please fill in your business information below for personalized invoices and reports.
            </div>
        ` : ''}

        <div class="card" id="userProfileCard">
            <h2>👤 User Profile</h2>
            <div class="card-header-buttons">
                <button class="btn-small" onclick="copyUserProfile()">📋 Copy Profile</button>
                ${!state.profileEditMode ? `<button type="button" class="btn-small" onclick="enableProfileEdit()" title="✏️ Edit">✏️ Edit</button>` : ''}
            </div>
            <form onsubmit="updateUserProfile(event)">
                <div class="form-group">
                    <label>Business Name</label>
                   <input 
                    type="text"
                    id="profileBusinessName"
                    value="${profile.businessName}"
                    placeholder="Enter business name"
                    ${state.profileEditMode ? '' : 'readonly'}
                    required>
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input 
                        type="email" 
                        id="profileEmail" 
                        value="${profile.email}" 
                        placeholder="youremail@domain.com" 
                        ${state.profileEditMode ? '' : 'readonly'}
                        required>
                </div>
                <div class="form-group">
                    <label>Phone Number</label>
                    <input 
                        type="tel" 
                        id="profilePhone" 
                        value="${profile.phone}" 
                        placeholder="+00000000000" 
                        ${state.profileEditMode ? '' : 'readonly'}
                        required>
                </div>
                <div class="form-group">
                    <label>Country</label>
                        <input type="text" id="profileCountry" value="${profile.country}" placeholder="Type country" ${state.profileEditMode ? '' : 'readonly'}>
                </div>
                <div class="form-group">
                    <label>City</label>
                        <input type="text" id="profileCity" value="${profile.city}" placeholder="Type city" ${state.profileEditMode ? '' : 'readonly'}>
                </div>
                <div class="form-group">
                    <label>Address</label>
                    <input 
                        type="text" 
                        id="profileAddress" 
                        value="${profile.address}" 
                        placeholder="your Address" 
                        ${state.profileEditMode ? '' : 'readonly'}
                        required>
                </div>
                <div class="form-group">
                    <label>TIN Number</label>
                    <input type="text" id="profileTIN" value="${profile.tinNumber || profile.vatNumber || ''}" ${state.profileEditMode ? '' : 'readonly'} placeholder="e.g., 12345678">
                </div>
                <div class="form-group">
                    <label>BL-No (Business License)</label>
                    <input type="text" id="profileBLNo" value="${profile.blNumber || ''}" ${state.profileEditMode ? '' : 'readonly'} placeholder="e.g., BL-000123">
                </div>
                <div class="form-group">
                    <label>Business VAT</label>
                    <select id="profileHasVAT" onchange="toggleVatInput()" ${state.profileEditMode ? '' : 'disabled'}>
                        <option value="no" ${profile.hasVAT ? '' : 'selected'}>Has no VAT</option>
                        <option value="yes" ${profile.hasVAT ? 'selected' : ''}>Has VAT</option>
                    </select>
                </div>
                <div class="form-group" id="vatGroup" style="${profile.hasVAT ? '' : 'display:none;'}">
                    <label>VAT Number</label>
                    <input type="text" id="profileVAT" value="${profile.vatNumber || ''}" ${state.profileEditMode ? '' : 'readonly'} placeholder="e.g., 12345678">
                </div>
                <div class="form-group" id="vatPlaceholder" style="${profile.hasVAT ? 'display:none;' : ''}">
                    <label>VAT Number</label>
                    <div>-</div>
                </div>
                
                <div style="display: flex; gap: 12px;">
                    <button 
                        type="submit" 
                        class="btn-success" 
                        style="flex: 1; ${state.profileEditMode ? '' : 'opacity: 0.5; cursor: not-allowed;'}"
                        ${state.profileEditMode ? '' : 'disabled'}>
                        💾 Save Profile
                    </button>
                    
                    ${state.profileEditMode ? `
                        <button 
                            type="button" 
                            class="btn-secondary" 
                            style="flex: 1;"
                            onclick="cancelProfileEdit()">
                            ✖ Cancel
                        </button>
                    ` : `
                        <button 
                            type="button" 
                            class="btn" 
                            style="flex: 1;"
                            onclick="enableProfileEdit()">
                            ✏️ Edit
                        </button>
                    `}
                </div>
            </form>
            <div class="card" style="margin-top:12px;">
                <h3>Business Settings</h3>
                <div class="card-header-buttons">
                    ${!state.profileEditMode ? `<button type="button" class="btn-small" onclick="enableProfileEdit()" title="✏️ Edit">✏️ Edit</button>` : ''}
                </div>
                <div class="form-group">
                    <label>Role</label>
                    <select id="profileRole" ${state.profileEditMode ? '' : 'disabled'}>
                        <option value="owner" ${profile.role === 'owner' ? 'selected' : ''}>Owner</option>
                        <option value="manager" ${profile.role === 'manager' ? 'selected' : ''}>Manager</option>
                        <option value="cashier" ${profile.role === 'cashier' ? 'selected' : ''}>Cashier</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Currency Code</label>
                    <input type="text" id="currencyCode" value="${state.currencyCode || 'TZS'}" placeholder="TZS">
                </div>
                <div class="form-group">
                    <label>Currency Symbol</label>
                    <input type="text" id="currencySymbol" value="${state.currencySymbol || 'Tsh'}" placeholder="Tsh">
                </div>
                <div class="form-group">
                    <label>Cost of Goods Method</label>
                    <select id="cogsMethod">
                        <option value="product_cost" ${String(state.cogsMethod || 'product_cost') === 'product_cost' ? 'selected' : ''}>Use Product Cost</option>
                        <option value="avg_purchase_cost" ${String(state.cogsMethod || 'product_cost') === 'avg_purchase_cost' ? 'selected' : ''}>Average Purchase Cost</option>
                        <option value="fifo" ${String(state.cogsMethod || 'product_cost') === 'fifo' ? 'selected' : ''}>FIFO (first-in-first-out)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Default Tax Rate (%)</label>
                    <input type="number" id="defaultTaxRate" value="${typeof state.defaultTaxRate === 'number' ? state.defaultTaxRate : 0}" step="0.01" min="0" max="100">
                </div>
                <button class="btn-success" onclick="(function(){ const roleEl=document.getElementById('profileRole'); const codeEl=document.getElementById('currencyCode'); const symEl=document.getElementById('currencySymbol'); const taxEl=document.getElementById('defaultTaxRate'); const cogsEl=document.getElementById('cogsMethod'); const newRole=roleEl?roleEl.value:'owner'; const newCode=codeEl?codeEl.value:'TZS'; const newSym=symEl?symEl.value:'Tsh'; const newTax=taxEl?parseFloat(taxEl.value||'0'):0; const newCogs=cogsEl?cogsEl.value:'product_cost'; state.userProfile.role=newRole; saveData(); setCurrency(newCode,newSym); state.__currencyAppliedOnce=false; applyCurrencySymbols(); state.defaultTaxRate=newTax; state.cogsMethod=newCogs; saveData(); if(syncEnabled&&currentUser){ upsertOne('settings',{ currency_code: state.currencyCode, currency_symbol: state.currencySymbol, default_tax_rate: state.defaultTaxRate, cogs_method: state.cogsMethod }); } showToast('Settings updated', 'success'); })()">Save Settings</button>
                </div>
                <div class="card" style="margin-top: 12px;">
                    <h3>🖼️ Business Logo</h3>
                    <p style="color:#666;font-size:13px;margin-bottom:8px;">Upload your logo (PNG/JPEG). It appears on all PDFs before your business name.</p>
                    <div style="display:flex;align-items:center;gap:12px;">
                        <div id="logoPreview" style="width:64px;height:64px;border-radius:50%;background:#f5f5f5;border:2px solid rgba(0,0,0,0.12);display:flex;align-items:center;justify-content:center;overflow:hidden;">
                            ${(state.userLogoDataUrl)
                        ? `<img src="${state.userLogoDataUrl}" alt="Logo" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">`
                        : '<span style="font-size:12px;color:#999;">No logo</span>'}
                        </div>
                        <button class="btn-secondary" onclick="triggerLogoUpload()">Upload Logo</button>
                    </div>
                    <small style="display:block;color:#888;margin-top:6px;">Recommended size: 256×256 px (auto-resized).</small>
                </div>
                
        <div class="alert-info" style="margin-top: 16px;">
            <strong>📝 Note:</strong> This information will be used in invoices, reports, and other documents throughout the app.
        </div>
        </div>

            
            `;
        }

        async function updateUserProfile(e) {
            e.preventDefault();
            playTapSound();
            hapticShort();

            const profileData = {
                businessName: document.getElementById('profileBusinessName').value.trim(),
                email: document.getElementById('profileEmail').value.trim(),
                phone: document.getElementById('profilePhone').value.trim(),
                address: document.getElementById('profileAddress').value.trim(),
                country: (document.getElementById('profileCountry')?.value || '').trim(),
                city: (document.getElementById('profileCity')?.value || '').trim(),
                role: (document.getElementById('profileRole')?.value || state.userProfile?.role || 'owner')
                , tinNumber: (document.getElementById('profileTIN')?.value || state.userProfile?.tinNumber || state.userProfile?.vatNumber || '').trim()
                , blNumber: (document.getElementById('profileBLNo')?.value || state.userProfile?.blNumber || '').trim()
                , hasVAT: (String(document.getElementById('profileHasVAT')?.value || 'no') === 'yes')
                , vatNumber: (document.getElementById('profileVAT')?.value || '').trim()
            };

            const success = await saveUserProfile(profileData);

            if (success) {
                state.profileEditMode = false;
                state.profileEditBackup = null;
                saveData();
                showToast('Profile saved successfully!', 'success');
                render();
            }
        }
        function toggleVatInput() {
            const el = document.getElementById('profileHasVAT');
            const grp = document.getElementById('vatGroup');
            const ph = document.getElementById('vatPlaceholder');
            if (!el) return;
            const hasVat = String(el.value || 'no') === 'yes';
            if (grp) grp.style.display = hasVat ? '' : 'none';
            if (ph) ph.style.display = hasVat ? 'none' : '';
        }

        function applyProfileEditMode(enabled) {
            try {
                const ids = ['profileBusinessName','profileEmail','profilePhone','profileCountry','profileCity','profileAddress','profileTIN','profileBLNo','profileVAT'];
                ids.forEach(id => {
                    const el = document.getElementById(id);
                    if (!el) return;
                    if (enabled) el.removeAttribute('readonly');
                    else el.setAttribute('readonly', '');
                });
                const vatSel = document.getElementById('profileHasVAT');
                if (vatSel) { if (enabled) vatSel.removeAttribute('disabled'); else vatSel.setAttribute('disabled',''); }
                const roleSel = document.getElementById('profileRole');
                if (roleSel) { if (enabled) roleSel.removeAttribute('disabled'); else roleSel.setAttribute('disabled',''); }
                const saveBtn = document.querySelector('#userProfileCard .btn-success[type="submit"]');
                if (saveBtn) {
                    if (enabled) { saveBtn.disabled = false; saveBtn.style.opacity = ''; saveBtn.style.cursor = ''; }
                    else { saveBtn.disabled = true; saveBtn.style.opacity = '0.5'; saveBtn.style.cursor = 'not-allowed'; }
                }
                toggleVatInput();
            } catch {}
        }

        async function enableProfileEdit() {
            const ok = await requirePinForDestructive('profile');
            if (!ok) { try { showToast('Access denied', 'error'); } catch {} return; }
            if (!state.profileEditBackup) {
                try { state.profileEditBackup = JSON.parse(JSON.stringify(state.userProfile || {})); } catch { state.profileEditBackup = null; }
            }
            state.profileEditMode = true;
            saveData();
            try { if (window._originalRender) window._originalRender(); else render(); } catch {}
            setTimeout(() => { try { applyProfileEditMode(true); } catch {} }, 0);
        }
        function cancelProfileEdit(){
            try {
                if (state.profileEditBackup) {
                    state.userProfile = JSON.parse(JSON.stringify(state.profileEditBackup));
                }
            } catch {}
            state.profileEditBackup = null;
            state.profileEditMode = false;
            saveData();
            try { if (window._originalRender) window._originalRender(); else render(); } catch {}
            setTimeout(() => { try { applyProfileEditMode(false); } catch {} }, 0);
        }

        async function submitDeleteAccount(e) {
            e.preventDefault();
            try {
                if (!navigator.onLine) { showToast('Go online to delete your account', 'error'); return; }
                if (!currentUser) { showToast('Not signed in', 'error'); return; }
                const email = (document.getElementById('deleteEmail')?.value || '').trim();
                const password = (document.getElementById('deletePassword')?.value || '').trim();
                if (!email || !password) { showToast('Provide email and password', 'error'); return; }
                if (email.toLowerCase() !== String(currentUser.email || '').toLowerCase()) { showToast('Email does not match signed-in account', 'error'); return; }
                const formEl = e.target;
                const btn = formEl.querySelector('.submit');
                if (btn) { btn.disabled = true; btn.style.opacity = '0.6'; btn.style.cursor = 'not-allowed'; }
                showToast('Verifying credentials…', 'info', null, null, 3000);
                const { data, error } = await supabase.auth.signInWithPassword({ email, password });
                if (error) { showToast('Invalid email or password', 'error'); if (btn) { btn.disabled = false; btn.style.opacity = '1'; btn.style.cursor = 'pointer'; } return; }
                await deleteUserDataAndSignOut();
            } catch (err) { showToast('Delete failed. Try again.', 'error'); } finally {
                const btn = document.querySelector('.form .submit');
                if (btn) { btn.disabled = false; btn.style.opacity = '1'; btn.style.cursor = 'pointer'; }
            }
        }

        async function deleteAccountPermanently(){
            try {
                if (!navigator.onLine) { showToast('Go online to delete your account', 'error'); return; }
                if (!currentUser) { showToast('Not signed in', 'error'); return; }
                showToast('Deleting account…', 'info', null, null, 6000);
                let ok = false;
                try {
                    if (supabase && supabase.functions && typeof supabase.functions.invoke === 'function') {
                        const { data, error } = await supabase.functions.invoke('delete-auth-user', { body: { uid: currentUser.id } });
                        if (!error && data && data.ok) ok = true;
                    }
                } catch (e) { }
                if (!ok) {
                    try {
                        const { error: rpcErr } = await supabase.rpc('delete_user_account', { p_uid: currentUser.id });
                        if (!rpcErr) ok = true;
                    } catch { }
                }
                if (!ok) { showToast('Delete failed. Try again later.', 'error'); return; }
                try { localStorage.removeItem('financeManagerData'); } catch { }
                try { localStorage.removeItem('tuba-offline-snapshot'); } catch { }
                try { window.__paywallInitialized = false; } catch {}
                try { await supabase.auth.signOut(); } catch {}
                currentUser = null; syncEnabled = false;
                render();
                showToast('Account deleted', 'success');
                setTimeout(() => { try { window.location.reload(); } catch {} }, 500);
            } catch (e) {
                showToast('Delete failed: ' + (e && e.message ? e.message : 'Unknown error'), 'error');
            }
        }
        function confirmDeleteAccount(){
            openDeleteEmailModal();
        }

        function confirmDeleteData(){
            openDataDeleteEmailModal();
        }

        function openDeleteEmailModal(){
            const modal = document.getElementById('deleteEmailModal');
            if (!modal) return;
            const inp = document.getElementById('deleteEmailConfirm');
            if (inp) { inp.value = ''; setTimeout(()=>{ try { inp.focus(); } catch {} }, 50); }
            modal.classList.add('show');
        }
        function closeDeleteEmailModal(){
            const modal = document.getElementById('deleteEmailModal');
            if (modal) modal.classList.remove('show');
        }
        function deleteEmailModalDeletePressed(){
            try {
                const value = (document.getElementById('deleteEmailConfirm')?.value || '').trim().toLowerCase();
                const expected = String((currentUser && currentUser.email) || '').trim().toLowerCase();
                if (!value || value !== expected) { showToast('Email does not match', 'error'); return; }
                closeDeleteEmailModal();
                openDeleteBusinessModal();
            } catch { }
        }

        function openDeleteBusinessModal(){
            const modal = document.getElementById('deleteBusinessModal');
            if (!modal) return;
            const inp = document.getElementById('deleteBusinessConfirm');
            if (inp) { inp.value = ''; setTimeout(()=>{ try { inp.focus(); } catch {} }, 50); }
            modal.classList.add('show');
        }
        function closeDeleteBusinessModal(){
            const modal = document.getElementById('deleteBusinessModal');
            if (modal) modal.classList.remove('show');
        }
        function deleteBusinessModalDeletePressed(){
            try {
                const profile = getUserProfileData();
                const expected = String(profile.businessName || '').trim().toLowerCase();
                const value = (document.getElementById('deleteBusinessConfirm')?.value || '').trim().toLowerCase();
                if (!expected) { showToast('Business name not set in profile', 'error'); return; }
                if (!value || value !== expected) { showToast('Business name does not match', 'error'); return; }
                closeDeleteBusinessModal();
                openDeleteFinalModal();
            } catch { }
        }

        function openDeleteFinalModal(){
            const modal = document.getElementById('deleteFinalModal');
            if (!modal) return;
            modal.classList.add('show');
        }
        function closeDeleteFinalModal(){
            const modal = document.getElementById('deleteFinalModal');
            if (modal) modal.classList.remove('show');
        }
        function deleteFinalModalDeletePressed(){
            closeDeleteFinalModal();
            openDeletePasswordModal();
        }

        function openDeletePasswordModal(){
            const modal = document.getElementById('deletePasswordModal');
            if (!modal) return;
            const inp = document.getElementById('deletePasswordConfirm');
            if (inp) { inp.value=''; setTimeout(()=>{ try{ inp.focus(); } catch{} }, 50); }
            modal.classList.add('show');
        }
        function closeDeletePasswordModal(){
            const modal = document.getElementById('deletePasswordModal');
            if (modal) modal.classList.remove('show');
        }
        async function deletePasswordModalDeletePressed(){
            try {
                if (!navigator.onLine) { showToast('Go online to delete your account', 'error'); return; }
                if (!currentUser) { showToast('Not signed in', 'error'); return; }
                const pwd = (document.getElementById('deletePasswordConfirm')?.value || '').trim();
                if (!pwd) { showToast('Enter password', 'error'); return; }
                showToast('Verifying password…', 'info', null, null, 3000);
                const { error } = await supabase.auth.signInWithPassword({ email: String(currentUser.email || ''), password: pwd });
                if (error) { showToast('Invalid password', 'error'); return; }
                closeDeletePasswordModal();
                await deleteAccountPermanently();
            } catch (e) {
                showToast('Delete failed. Try again.', 'error');
            }
        }

        async function clearCloudDataForCurrentUser(){
            try {
                if (!navigator.onLine) { showToast('Go online to delete data', 'error'); return false; }
                if (!currentUser || !syncEnabled || !supabase) { showToast('Not signed in', 'error'); return false; }
                showToast('Deleting cloud data…', 'info', null, null, 6000);
                const tables = ['products','categories','sales','expenses','income','customers','invoices','receipts','inventory','notes','transactions','transaction_floats','unpaid_entries','inventory_purchases','inventory_purchase_periods','assets','maintenance','tags','tithing'];
                for (const t of tables) {
                    try { await supabase.from(t).delete().eq('user_id', currentUser.id); } catch {}
                }
                showToast('Cloud data deleted', 'success');
                try { render(); } catch {}
                return true;
            } catch (e) { showToast('Delete failed: ' + (e && e.message ? e.message : 'Unknown error'), 'error'); return false; }
        }

        function openDataDeleteEmailModal(){
            const modal = document.getElementById('dataDeleteEmailModal');
            if (!modal) return;
            const inp = document.getElementById('dataDeleteEmailConfirm');
            if (inp) { inp.value = ''; setTimeout(()=>{ try { inp.focus(); } catch {} }, 50); }
            modal.classList.add('show');
        }
        function closeDataDeleteEmailModal(){
            const modal = document.getElementById('dataDeleteEmailModal');
            if (modal) modal.classList.remove('show');
        }
        function dataDeleteEmailModalDeletePressed(){
            try {
                const value = (document.getElementById('dataDeleteEmailConfirm')?.value || '').trim().toLowerCase();
                const expected = String((currentUser && currentUser.email) || '').trim().toLowerCase();
                if (!value || value !== expected) { showToast('Email does not match', 'error'); return; }
                closeDataDeleteEmailModal();
                openDataDeleteBusinessModal();
            } catch { }
        }
        function openDataDeleteBusinessModal(){
            const modal = document.getElementById('dataDeleteBusinessModal');
            if (!modal) return;
            const inp = document.getElementById('dataDeleteBusinessConfirm');
            if (inp) { inp.value = ''; setTimeout(()=>{ try { inp.focus(); } catch {} }, 50); }
            modal.classList.add('show');
        }
        function closeDataDeleteBusinessModal(){
            const modal = document.getElementById('dataDeleteBusinessModal');
            if (modal) modal.classList.remove('show');
        }
        function dataDeleteBusinessModalDeletePressed(){
            try {
                const profile = getUserProfileData();
                const expected = String(profile.businessName || '').trim().toLowerCase();
                const value = (document.getElementById('dataDeleteBusinessConfirm')?.value || '').trim().toLowerCase();
                if (!expected) { showToast('Business name not set in profile', 'error'); return; }
                if (!value || value !== expected) { showToast('Business name does not match', 'error'); return; }
                closeDataDeleteBusinessModal();
                openDataDeleteFinalModal();
            } catch { }
        }
        function openDataDeleteFinalModal(){
            const modal = document.getElementById('dataDeleteFinalModal');
            if (!modal) return;
            modal.classList.add('show');
        }
        function closeDataDeleteFinalModal(){
            const modal = document.getElementById('dataDeleteFinalModal');
            if (modal) modal.classList.remove('show');
        }
        function dataDeleteFinalModalDeletePressed(){
            closeDataDeleteFinalModal();
            openDataDeletePasswordModal();
        }
        function openDataDeletePasswordModal(){
            const modal = document.getElementById('dataDeletePasswordModal');
            if (!modal) return;
            const inp = document.getElementById('dataDeletePasswordConfirm');
            if (inp) { inp.value=''; setTimeout(()=>{ try{ inp.focus(); } catch{} }, 50); }
            modal.classList.add('show');
        }
        function closeDataDeletePasswordModal(){
            const modal = document.getElementById('dataDeletePasswordModal');
            if (modal) modal.classList.remove('show');
        }
        async function dataDeletePasswordModalDeletePressed(){
            try {
                if (!navigator.onLine) { showToast('Go online to delete data', 'error'); return; }
                if (!currentUser) { showToast('Not signed in', 'error'); return; }
                const pwd = (document.getElementById('dataDeletePasswordConfirm')?.value || '').trim();
                if (!pwd) { showToast('Enter password', 'error'); return; }
                showToast('Verifying password…', 'info', null, null, 3000);
                const { error } = await supabase.auth.signInWithPassword({ email: String(currentUser.email || ''), password: pwd });
                if (error) { showToast('Invalid password', 'error'); return; }
                closeDataDeletePasswordModal();
                await clearCloudDataForCurrentUser();
            } catch (e) { showToast('Delete failed. Try again.', 'error'); }
        }

        /*
        async function handleDeleteAccount() {
            // commented out by request
        }
        */

        /*
        async function deleteUserDataAndSignOut() {
            // commented out by request
        }
        */

        /*
        async function deleteAuthUserServerSide(uid) {
            // commented out by request
        }
        */


        function switchAuthTab(tab) {
            if (tab === 'login') {
                document.getElementById('loginForm').style.display = 'block';
                document.getElementById('signupForm').style.display = 'none';
                document.getElementById('loginTab').classList.add('active');
                document.getElementById('signupTab').classList.remove('active');
                try { autoSubmitLoginIfAutofilled(); } catch (e) { }
                try {
                    if (typeof isIOSSafari === 'function' && isIOSSafari()) {
                        const emailEl = document.getElementById('loginEmail');
                        emailEl && emailEl.focus();
                    }
                } catch (e) { }
            } else {
                document.getElementById('loginForm').style.display = 'none';
                document.getElementById('signupForm').style.display = 'block';
                document.getElementById('loginTab').classList.remove('active');
                document.getElementById('signupTab').classList.add('active');
            }
        }

        // Detect autofill and auto submit sign in
        function autoSubmitLoginIfAutofilled() {
            if (!navigator.onLine) return;
            if (state.autoAuthDisabled) return;
            const emailEl = document.getElementById('loginEmail');
            const passEl = document.getElementById('loginPassword');
            const btn = document.querySelector('#loginForm button[onclick="handleSignIn()"]');
            if (!emailEl || !passEl || !btn) return;

            // On iOS Safari, rely on autofill animation/visibility triggers and avoid polling
            try {
                if (typeof isIOSSafari === 'function' && isIOSSafari()) {
                    const email = (emailEl.value || '').trim();
                    const pwd = (passEl.value || '').trim();
                    if (email && pwd) {
                        try { handleSignIn(); } catch (e) { /* no-op */ }
                    }
                    return; // Skip polling on iOS Safari
                }
            } catch (e) { /* no-op */ }

            let attempts = 0;
            const maxAttempts = 10; // ~1 second
            const timer = setInterval(() => {
                attempts++;
                const email = (emailEl.value || '').trim();
                const pwd = (passEl.value || '').trim();
                if (email && pwd) {
                    clearInterval(timer);
                    try { handleSignIn(); } catch (e) { /* no-op */ }
                } else if (attempts >= maxAttempts) {
                    clearInterval(timer);
                }
            }, 200);
        }

        // iOS Face ID autofill detection via CSS animationstart (Safari only)
        function isIOSSafari() {
            const ua = navigator.userAgent || navigator.vendor || window.opera;
            const isIOS = /iPad|iPhone|iPod/.test(ua) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
            const isSafari = /^((?!chrome|android).)*safari/i.test(ua);
            return isIOS && isSafari;
        }
        if (isIOSSafari()) {
            document.addEventListener('animationstart', function (e) {
                if (e.animationName === 'autofillDetection') {
                    try { autoSubmitLoginIfAutofilled(); } catch (err) { }
                }
            }, true);
        }

        // Also trigger detection on visibility change and when inputs receive focus
        document.addEventListener('visibilitychange', function () {
            if (document.visibilityState === 'visible' && !currentUser) {
                try { attemptSilentCredentialSignIn(); } catch (e) { }
                if (!currentUser && (typeof isIOSSafari === 'function' && isIOSSafari())) {
                    try { switchTab('account'); } catch (e) { }
                    try { autoSubmitLoginIfAutofilled(); } catch (e) { }
                } else if (state.activeTab === 'account') {
                    try { autoSubmitLoginIfAutofilled(); } catch (e) { }
                }
            }
        });
        async function attemptSilentCredentialSignIn() {
            if (!navigator.onLine) return false;
            if (state.autoAuthDisabled) return false;
            if (!window.isSecureContext) return false;
            if (!navigator.credentials) return false;
            if (!window.supabase || !supabase || !supabase.auth) return false;
            try {
                const cred = await navigator.credentials.get({ password: true, mediation: 'silent' });
                if (cred && cred.type === 'password' && cred.id && cred.password) {
                    try {
                        const { data, error } = await supabase.auth.signInWithPassword({ email: cred.id, password: cred.password });
                        if (!error && data && data.user) {
                            try { refreshAuthState(); } catch (e) { }
                            return true;
                        }
                    } catch (e) { }
                }
            } catch (e) { }
            return false;
        }
        async function pullFromCloud() {
            playTapSound();
            hapticShort();
            if (!syncEnabled || !currentUser) {
                return showToast('Not signed in', 'error');
            }

            if (!confirm('This will replace ALL local data with cloud data. Continue?')) {
                return;
            }

            updateSyncIndicator('syncing');
            showToast('Loading Data...', 'info', null, null, 8000);

            try {
                console.log('⬇️ Pulling data from cloud...');

                // Clear local storage first
                localStorage.removeItem('financeManagerData');

                // Pull everything from cloud
                await pullDataFromSupabase();

                updateSyncIndicator('synced');
                render();
            } catch (error) {
                console.error('Pull error:', error);
                showToast('Pull failed: ' + error.message, 'error');
                updateSyncIndicator('synced');
            }
        }

        async function pushToCloud() {
            playTapSound();
            hapticShort();
            if (!syncEnabled || !currentUser) {
                return showToast('Not signed in', 'error');
            }

            if (!confirm('This will replace ALL cloud data with local data. Continue?')) {
                return;
            }

            updateSyncIndicator('syncing');
            showToast('Loading Data...', 'info', null, null, 8000);

            try {
                console.log('⬆️ Pushing data to cloud...');
                await clearAndPushAllData();
                updateSyncIndicator('synced');
            } catch (error) {
                console.error('Push error:', error);
                showToast('Push failed: ' + error.message, 'error');
                updateSyncIndicator('synced');
            }
        }
        // Removed in-app forceRefresh function


        async function handleSignIn() {
            playTapSound();
            hapticShort();
            try { state.autoAuthDisabled = false; saveData(); } catch { }
            const email = document.getElementById('loginEmail')?.value;
            const password = document.getElementById('loginPassword')?.value;

            if (!email || !password) {
                return showToast('Please fill in all fields', 'error');
            }

            // Disable button during sign in
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                const buttons = loginForm.querySelectorAll('button');
                buttons.forEach(btn => btn.disabled = true);
            }

            try {
                const result = await signIn(email, password);
                if (result) {
                    // Success - just render normally
                    render();
                } else {
                    // Failed - re-enable buttons
                    if (loginForm) {
                        const buttons = loginForm.querySelectorAll('button');
                        buttons.forEach(btn => btn.disabled = false);
                    }
                }
            } catch (error) {
                console.error('Handle sign in error:', error);
                if (loginForm) {
                    const buttons = loginForm.querySelectorAll('button');
                    buttons.forEach(btn => btn.disabled = false);
                }
            }
        }
        async function handleSendMagicLink() {
            playTapSound();
            hapticShort();
            const email = document.getElementById('loginEmail')?.value;
            if (!email) { return showToast('Enter your email to receive a link', 'error'); }
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                const buttons = loginForm.querySelectorAll('button');
                buttons.forEach(btn => btn.disabled = true);
            }
            try {
                showToast('Sending magic link...', 'info');
                const { error } = await supabase.auth.signInWithOtp({ email, options: { emailRedirectTo: 'https://tubawelcomescreen.vercel.app/' } });
                if (error) throw error;
                showToast('Check your email and click the sign-in link', 'success');
            } catch (err) {
                console.error('Magic link error:', err);
                showToast('Could not send link: ' + (err.message || 'Unknown error'), 'error');
            } finally {
                if (loginForm) {
                    const buttons = loginForm.querySelectorAll('button');
                    buttons.forEach(btn => btn.disabled = false);
                }
            }
        }
        function openOtpCodeModal() {
            let m = document.getElementById('otpModal');
            if (!m) {
                const el = document.createElement('div');
                el.className = 'modal';
                el.id = 'otpModal';
                el.innerHTML = `
                    <div class="modal-content" style="max-width:420px;">
                        <button class="modal-close" onclick="closeOtpCodeModal()">×</button>
                        <div class="modal-title">Email Code Sign-In</div>
                        <div class="card" style="margin-top:8px;">
                            <div class="form-group">
                                <label>Email</label>
                                <input type="email" id="otpEmail" placeholder="your@email.com" autocomplete="email">
                            </div>
                            <div class="flex-gap">
                                <button class="btn-small" onclick="sendOtpEmailCode()">Send Code</button>
                                <button class="btn-small btn-secondary" onclick="closeOtpCodeModal()">Close</button>
                            </div>
                        </div>
                        <div class="card" style="margin-top:12px;">
                            <div class="form-group">
                                <label>Enter Code</label>
                                <input type="text" id="otpCode" placeholder="6-digit code" inputmode="numeric" autocomplete="one-time-code">
                            </div>
                            <div class="flex-gap">
                                <button class="btn-small" onclick="verifyOtpEmailCode()">Verify & Sign In</button>
                                <button class="btn-small btn-secondary" onclick="closeOtpCodeModal()">Cancel</button>
                            </div>
                        </div>
                    </div>`;
                document.body.appendChild(el);
                m = document.getElementById('otpModal');
            }
            m.classList.add('show');
            try { window.__updateModalOverflow && window.__updateModalOverflow(); } catch {}
        }
        function closeOtpCodeModal() {
            const m = document.getElementById('otpModal');
            if (m) { m.classList.remove('show'); }
            try { window.__updateModalOverflow && window.__updateModalOverflow(); } catch {}
        }
        async function sendOtpEmailCode() {
            const email = document.getElementById('otpEmail')?.value;
            if (!email) { return showToast('Enter your email', 'error'); }
            try {
                showToast('Sending code...', 'info');
                const { error } = await supabase.auth.signInWithOtp({ email });
                if (error) throw error;
                showToast('Check your email for the code', 'success');
            } catch (e) {
                console.error('OTP send error:', e);
                showToast('Could not send code: ' + (e.message || 'Unknown error'), 'error');
            }
        }
        async function verifyOtpEmailCode() {
            const email = document.getElementById('otpEmail')?.value;
            const code = document.getElementById('otpCode')?.value;
            if (!email || !code) { return showToast('Enter email and code', 'error'); }
            try {
                showToast('Verifying...', 'info');
                const { data, error } = await supabase.auth.verifyOtp({ email, token: code, type: 'email' });
                if (error) throw error;
                closeOtpCodeModal();
                try { clearAllSearchInputs(); } catch {}
                render();
                showToast('Signed in', 'success');
                try { syncInBackground(); } catch { }
            } catch (e) {
                console.error('OTP verify error:', e);
                showToast('Invalid code: ' + (e.message || 'Unknown error'), 'error');
            }
        }
        async function handleSignUp() {
            const email = document.getElementById('signupEmail')?.value;
            const password = document.getElementById('signupPassword')?.value;
            const confirm = document.getElementById('signupPasswordConfirm')?.value;

            if (!email || !password || !confirm) {
                return showToast('Please fill in all fields', 'error');
            }

            if (password !== confirm) {
                return showToast('Passwords do not match', 'error');
            }

            if (password.length < 6) {
                return showToast('Password must be at least 6 characters', 'error');
            }

            await signUp(email, password);
        }

        // Password Reset Functions
        function openPasswordResetModal() {
            let resetModal = document.getElementById('passwordResetModal');
            if (!resetModal) {
                const newModal = document.createElement('div');
                newModal.className = 'modal';
                newModal.id = 'passwordResetModal';
                newModal.innerHTML = `
                    <div class="modal-content">
                        <button class="modal-close" onclick="closePasswordResetModal()">×</button>
                        <div class="modal-title">Reset Password</div>
                        <div class="card" style="margin-top:8px;">
                            <div id="resetStep1" style="display:block;">
                                <div class="form-group">
                                    <label>Enter your email address</label>
                                    <input type="email" id="resetEmail" placeholder="your@email.com" autocomplete="email">
                                </div>
                                <p style="font-size:12px;color:#666;margin:8px 0;">We'll send you a link to reset your password.</p>
                                <div class="flex-gap">
                                    <button class="btn-small" onclick="sendPasswordResetEmail()">Send Reset Link</button>
                                    <button class="btn-small btn-secondary" onclick="closePasswordResetModal()">Cancel</button>
                                </div>
                            </div>
                            <div id="resetStep2" style="display:none;">
                                <div style="text-align:center;padding:16px;">
                                    <div style="font-size:48px;margin-bottom:8px;">✓</div>
                                    <div style="font-weight:600;color:#2e7d32;margin-bottom:8px;">Email Sent!</div>
                                    <p style="color:#666;font-size:13px;line-height:1.6;">Check your email for a reset link. Click the link to create a new password.</p>
                                    <p style="color:#999;font-size:12px;margin-top:12px;">The link expires in 24 hours.</p>
                                </div>
                                <button class="btn-small" onclick="closePasswordResetModal()" style="margin-top:12px;">Done</button>
                            </div>
                        </div>
                    </div>`;
                document.body.appendChild(newModal);
                resetModal = document.getElementById('passwordResetModal');
            }
            resetModal.classList.add('show');
            try { window.__updateModalOverflow && window.__updateModalOverflow(); } catch {}
        }

        function closePasswordResetModal() {
            const resetModal = document.getElementById('passwordResetModal');
            if (resetModal) {
                resetModal.classList.remove('show');
                // Reset form for next time
                document.getElementById('resetStep1').style.display = 'block';
                document.getElementById('resetStep2').style.display = 'none';
                document.getElementById('resetEmail').value = '';
            }
            try { window.__updateModalOverflow && window.__updateModalOverflow(); } catch {}
        }

        async function sendPasswordResetEmail() {
            const email = document.getElementById('resetEmail')?.value;

            if (!email) {
                return showToast('Please enter your email address', 'error');
            }

            try {
                showToast('Sending reset link...', 'info');
                const { error } = await supabase.auth.resetPasswordForEmail(email, {
                    redirectTo: 'https://tubawelcomescreen.vercel.app/'
                });

                if (error) {
                    throw error;
                }

                // Show success step
                document.getElementById('resetStep1').style.display = 'none';
                document.getElementById('resetStep2').style.display = 'block';
                showToast('Reset link sent to your email!', 'success');
            } catch (error) {
                console.error('Password reset error:', error);
                showToast('Error: ' + (error.message || 'Could not send reset link'), 'error');
            }
        }

        function openChangePasswordModal() {
            let m = document.getElementById('changePasswordModal');
            if (!m) {
                const el = document.createElement('div');
                el.className = 'modal';
                el.id = 'changePasswordModal';
                el.innerHTML = `
                    <div class="modal-content" style="max-width:400px;">
                        <button class="modal-close" onclick="closeChangePasswordModal()">×</button>
                        <div class="modal-title">Reset Password</div>
                        <div class="card" style="margin-top:8px;">
                            <div class="form-group">
                                <label>Current Password</label>
                                <div style="display:flex;align-items:center;gap:8px;">
                                    <input type="password" id="changePwdCurrent" placeholder="••••••••" style="flex:1;" oninput="var t=document.getElementById('changePwdCurrentToggle'); if(t) t.style.display = this.value.length>0 ? 'inline-flex' : 'none';">
                                    <button class="btn-secondary btn-small" id="changePwdCurrentToggle" style="display:none;" onclick="(function(){ var i=document.getElementById('changePwdCurrent'); if(!i) return; i.type = (i.type==='password')?'text':'password'; })()" title="👁">👁</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>New Password (min 6 characters)</label>
                                <div style="display:flex;align-items:center;gap:8px;">
                                    <input type="password" id="changePwdNew" placeholder="••••••••" style="flex:1;" oninput="var t=document.getElementById('changePwdNewToggle'); if(t) t.style.display = this.value.length>0 ? 'inline-flex' : 'none';">
                                    <button class="btn-secondary btn-small" id="changePwdNewToggle" style="display:none;" onclick="(function(){ var i=document.getElementById('changePwdNew'); if(!i) return; i.type = (i.type==='password')?'text':'password'; })()" title="👁">👁</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Confirm New Password</label>
                                <div style="display:flex;align-items:center;gap:8px;">
                                    <input type="password" id="changePwdConfirm" placeholder="••••••••" style="flex:1;" oninput="var t=document.getElementById('changePwdConfirmToggle'); if(t) t.style.display = this.value.length>0 ? 'inline-flex' : 'none';">
                                    <button class="btn-secondary btn-small" id="changePwdConfirmToggle" style="display:none;" onclick="(function(){ var i=document.getElementById('changePwdConfirm'); if(!i) return; i.type = (i.type==='password')?'text':'password'; })()" title="👁">👁</button>
                                </div>
                            </div>
                            <div class="flex-gap" style="margin-top:8px;">
                                <button class="btn-success" onclick="submitChangePassword()" title="Update Password">Update Password</button>
                                <button class="btn-secondary" onclick="closeChangePasswordModal()" title="Cancel">Cancel</button>
                            </div>
                        </div>
                    </div>`;
                document.body.appendChild(el);
                m = document.getElementById('changePasswordModal');
            }
            m.classList.add('show');
            try { window.__updateModalOverflow && window.__updateModalOverflow(); } catch {}
            setTimeout(() => { try { document.getElementById('changePwdCurrent')?.focus(); } catch {} }, 50);
        }

        function closeChangePasswordModal(){
            const m = document.getElementById('changePasswordModal');
            if (m) m.classList.remove('show');
            try { window.__updateModalOverflow && window.__updateModalOverflow(); } catch {}
        }

        async function submitChangePassword(){
            try {
                if (!navigator.onLine) { showToast('Go online to change password', 'error'); return; }
                if (!supabase || !currentUser) { showToast('Not signed in', 'error'); return; }
                const current = (document.getElementById('changePwdCurrent')?.value || '').trim();
                const next = (document.getElementById('changePwdNew')?.value || '').trim();
                const confirm = (document.getElementById('changePwdConfirm')?.value || '').trim();
                if (!current || !next || !confirm) { showToast('Fill all fields', 'error'); return; }
                if (next.length < 6) { showToast('Password too short (min 6)', 'error'); return; }
                if (next !== confirm) { showToast('Passwords do not match', 'error'); return; }
                showToast('Verifying current password…', 'info');
                const { error: verifyErr } = await supabase.auth.signInWithPassword({ email: String(currentUser.email || ''), password: current });
                if (verifyErr) { showToast('Invalid current password', 'error'); return; }
                showToast('Updating password…', 'info');
                const { error: updErr } = await supabase.auth.updateUser({ password: next });
                if (updErr) { showToast('Update failed. Try again.', 'error'); return; }
                closeChangePasswordModal();
                showToast('Password updated', 'success');
            } catch (e) {
                showToast('Update failed. Try again.', 'error');
            }
        }

        // ========================================
        // TAG UI HELPERS
        // ========================================
        function renderItemTagsUI(item, section) {
            if (!item) return '';
            const tags = getItemTags(item);
            let html = `<div class="tags-scroll" style="margin-top:6px;">`;

            if (tags.length > 0) {
                html += tags.map(tag => renderTagBadge(tag)).join('');
            }

            // Add tag button
            const triggerStyle = (state.theme === 'dark')
                ? 'padding:4px 8px;font-size:11px;background:#1f2937;color:#e5e7eb;border:1px solid #374151;border-radius:12px;'
                : 'padding:4px 8px;font-size:11px;background:#f0f0f0;color:#333;border:1px solid #ddd;border-radius:12px;';
            const preferredId = (item.id != null && item.id !== '') ? item.id : (item.timestamp != null ? item.timestamp : (item.number != null ? item.number : String(item.title || item.name || '')));
            html += `
                <button class="btn-small" style="${triggerStyle}"
                    onclick="openItemTagsModal('${section}', '${preferredId}')">+ Tag</button>
            `;

            html += `</div>`;
            return html;
        }

        window.openItemTagsModal = function (section, itemId) {
            const item = findItemById(section, itemId);
            if (!item) {
                showToast('Item not found', 'error');
                return;
            }

            const availableTags = state.tags;
            const itemTags = getItemTags(item);

            let html = `
                <div class="modal" id="itemTagsModal" style="display:flex;" onclick="if(event.target.id === 'itemTagsModal') closeItemTagsModal();">
                    <div class="modal-content" style="max-width:400px;">
                        <button class="modal-close" onclick="closeItemTagsModal()">×</button>
                        <div class="modal-title">📌 Manage Tags</div>
                        
                        <div style="margin:16px 0;">
                            <label style="font-weight:600;font-size:13px;">Add Tags to this item:</label>
                            <div class="tags-scroll" style="margin-top:8px;">
            `;

            availableTags.forEach(tag => {
                const isSelected = itemTags.includes(tag);
                const color = state.tagColors[tag];
                const isDark = (state.theme === 'dark') || document.body.classList.contains('theme-dark');
                const isPaywall = (state.theme === 'blue' || state.theme === 'paywall' || document.body.classList.contains('theme-blue'));
                const unselectedBg = isDark ? '#1f2937' : '#f0f0f0';
                const unselectedText = isDark ? '#e5e7eb' : '#333';
                const bg = isSelected ? color : unselectedBg;
                const text = isSelected ? '#fff' : unselectedText;
                const borderColor = isSelected ? (isPaywall ? '#f6e05e' : color) : color;
                const outlineStyle = isSelected && isPaywall ? 'outline:2px solid #f6e05e;outline-offset:2px;' : '';
                const classes = `btn-small btn-tag${isSelected ? ' active' : ''}`;
                html += `
                    <button class="${classes}" style="
                        padding:6px 12px;
                        background:${bg};
                        color:${text};
                        border:1px solid ${borderColor};
                        ${outlineStyle}
                        border-radius:12px;
                        font-size:12px;
                        font-weight:600;
                        cursor:pointer;
                    " onclick="toggleItemTag('${section}', '${item.id}', '${tag}')">${tag}</button>
                `;
            });

            html += `
                            </div>
                        </div>

                        <div style="border-top:1px solid #eee;padding-top:12px;">
                            <label style="font-weight:600;font-size:13px;">Create new tag:</label>
                            <div style="display:flex;gap:6px;margin-top:8px;">
                                <input type="text" id="quickNewTagInput" placeholder="Tag name..." style="flex:1;padding:8px;border:1px solid #ddd;border-radius:4px;font-size:13px;">
                                <button class="btn-primary btn-small" onclick="quickAddTagToItem('${section}', '${item.id}')">Add</button>
                            </div>
                        </div>

                        <div style="display:flex;gap:8px;margin-top:16px;justify-content:flex-end;">
                            <button class="btn-secondary btn-small" onclick="closeItemTagsModal()">Done</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', html);
        };

        window.toggleItemTag = function (section, itemId, tagName) {
            const item = findItemById(section, itemId);
            if (!item) return;

            if (hasTag(item, tagName)) {
                removeTagFromItem(item, tagName);
            } else {
                addTagToItem(item, tagName);
            }

            saveData();
            syncInBackground();

            // Re-render modal
            closeItemTagsModal();
            openItemTagsModal(section, itemId);
            render();
        };

        window.quickAddTagToItem = function (section, itemId) {
            const input = document.getElementById('quickNewTagInput');
            if (!input || !input.value.trim()) return;

            const tagName = input.value.trim();
            addTag(tagName);

            const item = findItemById(section, itemId);
            if (item) {
                addTagToItem(item, tagName);
                saveData();
                syncInBackground();
            }

            closeItemTagsModal();
            openItemTagsModal(section, itemId);
            render();
        };

        window.closeItemTagsModal = function () {
            const modal = document.getElementById('itemTagsModal');
            if (modal) modal.remove();
        };

        function findItemById(section, itemId) {
            const sectionMap = {
                'sales': state.sales,
                'products': state.products,
                'expenses': state.expenses,
                'income': state.income,
                'loans': state.loans,
                'customers': state.customers,
                'notes': state.notes,
                'transactions': state.transactions,
                'unpaid': state.unpaidEntries
            };

            const items = sectionMap[section] || [];
            let found = items.find(item => String(item.id) === String(itemId));
            if (!found) {
                found = items.find(item => String(item.timestamp) === String(itemId));
            }
            return found;
        }

        function renderSales() {
            const stats = getStats();

            // Filter sales based on search and filters
            let filteredSales = state.sales.slice();
            filteredSales = filteredSales.filter(s => !(s && s.deleted === true));

            if (state.searchPeriod) {
                const Period = state.searchPeriod.toLowerCase();
                filteredSales = filteredSales.filter(s =>
                    s.productName.toLowerCase().includes(Period) ||
                    s.customer.toLowerCase().includes(Period) ||
                    s.payment.toLowerCase().includes(Period) ||
                    (s.category && s.category.toLowerCase().includes(Period))
                );
            }

            if (state.filterDateFrom) {
                filteredSales = filteredSales.filter(s => new Date(s.date) >= new Date(state.filterDateFrom));
            }

            if (state.filterDateTo) {
                filteredSales = filteredSales.filter(s => new Date(s.date) <= new Date(state.filterDateTo));
            }

            if (state.filterCustomer) {
                filteredSales = filteredSales.filter(s => s.customer === state.filterCustomer);
            }
            try {
                if (!state.showSalesHistory && !state.filterDateFrom && !state.filterDateTo) {
                    const today = getTodayDateString();
                    filteredSales = filteredSales.filter(s => String(s.date) === String(today));
                }
            } catch {}
            

            // Ensure newest-first ordering by timestamp (fallback to date+time)
            try {
                filteredSales.sort((a, b) => {
                    const ta = Number(a.timestamp) || new Date(`${a.date} ${a.time}`).getTime() || 0;
                    const tb = Number(b.timestamp) || new Date(`${b.date} ${b.time}`).getTime() || 0;
                    return tb - ta;
                });
            } catch { }
            try { state.lastFilteredSales = filteredSales.slice(); } catch {}

            return `
        <div class="privacy-container">
            <button class="privacy-toggle-btn show" id="privacyToggleBtn" onclick="togglePrivacy()">
                ${state.privacyBlurred ? '🔒' : '🔓'}
            </button>

        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-bottom: 12px;">
            <div class="stat-card ${state.privacyBlurred ? 'privacy-blur' : ''}" style="padding: 12px;">
                <div class="stat-label" style="font-size: 10px;">AVAILABLE CAPITAL</div>
                <div class="stat-value" style="font-size: 16px;"><span class="money-text"> ${formatNumber(stats.availableCapital || 0)} Tsh</span></div>
                <div class="stat-subvalue" style="font-size: 10px;">Inventory spend: ${formatNumber(stats.inventorySpendTotal || 0)} Tsh</div>
                <div class="stat-subvalue" style="font-size: 10px;">Stock value: ${formatNumber(stats.inventoryStockValue || 0)} Tsh</div>
            </div>
            <div class="stat-card ${state.privacyBlurred ? 'privacy-blur' : ''}" style="padding: 12px;">
                <div class="stat-label" style="font-size: 10px;">TOTAL PROFIT</div>
                <div class="stat-value" style="font-size: 16px;"><span class="money-text"> ${formatNumber(stats.totalProfit)} Tsh</span></div>
            </div>
                <div class="stat-card ${state.privacyBlurred ? 'privacy-blur' : ''}" style="padding: 12px; position: relative;">
                    <div class="stat-label" style="font-size: 10px;">TODAY'S PROFIT</div>
                    ${(() => {
                    const t = getTodayDateString();
                    const salesToday = (state.sales || []).filter(s => s.status !== 'unpaid' && s.date === t);
                    const profitToday = salesToday.reduce((sum, s) => sum + (Number(s.profit) || ((Number(s.totalPrice) || 0) - (Number(s.totalCost) || 0))), 0);
                    const expToday = (state.expenses || []).filter(e => e.date === t).reduce((sum, e) => sum + (Number(e.amount) || 0), 0);
                    const capToday = salesToday.reduce((sum, s) => sum + (Number(s.totalCost) || 0), 0);
                    const revenueToday = salesToday.reduce((sum, s) => sum + (Number(s.totalPrice) || 0), 0);
                    const target = Number(state.dailyTarget || 0);
                    const needsTarget = !(target > 0);
                    const pct = target > 0 ? Math.max(0, Math.min(100, Math.round((profitToday / target) * 100))) : 0;
                    const r = 14; const c = Math.round(2 * Math.PI * r);
                    const dash = Math.round((c * pct) / 100);
                    const rem = Math.max(0, c - dash);
                    const tt = String(state.theme || '').toLowerCase();
                    const isDark = (tt === 'dark') || document.body.classList.contains('theme-dark');
                    const isPaywall = (tt === 'blue' || tt === 'paywall' || document.body.classList.contains('theme-blue'));
                    const track = isPaywall ? '#1e293b' : (isDark ? '#374151' : '#e5e7eb');
                    const prog  = isPaywall ? '#ffd54f' : (isDark ? '#22c55e' : '#2e7d32');
                    const label = '#ffffff';
                    return `
                    <div class=\"stat-value\" style=\"font-size: 16px;\"><span class=\"money-text\"> ${formatNumber(profitToday)} Tsh</span></div>
                    <div class=\"stat-subvalue\" style=\"font-size: 10px;\">Expenses today: ${formatNumber(expToday)} Tsh</div>
                    <div class=\"stat-subvalue\" style=\"font-size: 10px;\">Capital today: ${formatNumber(capToday)} Tsh</div>
                    <div style=\"position:absolute; right:4px; top:4px; display:flex; align-items:center; justify-content:center;\">
                        <div style=\"position:relative;width:36px;height:36px; display:inline-flex; align-items:center; justify-content:center;${needsTarget ? 'cursor:pointer;' : ''}\" ${needsTarget ? 'onclick=\"goToDailyTargetFromRing()\" title=\"Set daily target\"' : ''}>
                            <svg viewBox=\"0 0 36 36\" style=\"width:36px;height:36px;transform:rotate(-90deg);\">
                                <circle cx=\"18\" cy=\"18\" r=\"14\" stroke=\"${track}\" stroke-width=\"3\" fill=\"none\" />
                                <circle cx=\"18\" cy=\"18\" r=\"14\" stroke=\"${prog}\" stroke-width=\"3\" fill=\"none\" stroke-linecap=\"round\" stroke-dasharray=\"${dash} ${rem}\" />
                                ${needsTarget ? '<circle cx=\"18\" cy=\"18\" r=\"10.5\" fill=\"#dc2626\" stroke=\"#dc2626\" stroke-width=\"2.5\" />' : ''}
                            </svg>
                            <div style=\"position:absolute; top:3px; left:3px; right:3px; bottom:3px; display:flex; align-items:center; justify-content:center; font-size:8px; font-weight:600; letter-spacing:-0.2px; color:${label}; pointer-events:none;\">${needsTarget ? '' : `${pct}%`}</div>
                        </div>
                    </div>
                    `;
                    })()}
                </div>
            <div class="stat-card ${state.privacyBlurred ? 'privacy-blur' : ''}" style="padding: 12px;" onclick="openTithingModal()">
                ${(() => {
                    const curKey = getMonthKey(new Date()); const rec = ensureTithing(curKey); const due = rec.due || 0; const paid = rec.paid || 0; const remain = Math.max(0, due - paid); return `
                <div class=\"stat-label\" style=\"font-size: 10px;\">10% (MONTH)</div>
                <div class=\"stat-value\" style=\"font-size: 16px;\"><span class=\"money-text\"> ${formatNumber(due)} Tsh</span></div>
                <div class=\"stat-subvalue\" style=\"font-size: 10px;\">Paid: ${formatNumber(paid)} Tsh | Remaining: ${formatNumber(remain)} Tsh</div>
                `;
                })()}
            </div>
        </div>
        </div>
        ${(() => { const unpaidCount = (state.sales || []).filter(s => s && s.deleted !== true && String(s.status || '').toLowerCase() === 'unpaid').length; return unpaidCount > 0 ? `<div class=\"alert-box\" style=\"margin-top:8px; cursor:pointer;\" onclick=\"openUnpaidSalesModal()\"><strong>Unpaid sales:</strong> ${unpaidCount} — Click to review</div>` : '' })()}
        <div class="card">
            <h2>Add Sale</h2>
            <div class="card-header-buttons">
                <button id="saleFormClearBtn" class="btn-small btn-secondary" style="${(state.currentSaleProductIndex !== '' && state.currentSaleProductIndex != null) ? 'display:inline-flex;' : 'display:none;'}" onclick="clearSaleForm()">Clear</button>
                <button class="btn-small" onclick="openQuickSaleNotesModal()">📝 Quick Note</button>
            </div>
            <form onsubmit="addSale(event)" onkeydown="handleSaleEnter(event)">
                <div class="form-group">
                    <label>Product/Service</label>
                    <select id="saleProduct" onchange="handleProductSelection()" required>
                        <option value="">-- Select Product/Service --</option>
                        <option class="opt-new" value="new" ${String(state.currentSaleProductIndex || '') === 'new' ? 'selected' : ''}>+ Add New Product/Service</option>
                        ${(() => {
                    const usage = {};
                    (state.sales || []).forEach(s => {
                        const k = String(s.productName || '');
                        const t = Number(s.timestamp) || 0;
                        if (!k) return;
                        const u = usage[k] = usage[k] || { last: 0, count: 0 };
                        u.last = Math.max(u.last, t);
                        u.count += 1;
                    });
                    const entries = (state.products || []).map((p, i) => {
                        const u = usage[p.name] || { last: 0, count: 0 };
                        return { p, i, last: u.last, count: u.count };
                    });
                    entries.sort((a, b) => {
                        if (b.last !== a.last) return b.last - a.last;
                        if (b.count !== a.count) return b.count - a.count;
                        return String(a.p.name).localeCompare(String(b.p.name));
                    });
                    return entries.map(({ p, i }) => {
                        const stockText = (p.hasStock === false) ? 'N/A' : ((state.inventory[p.name] || { stock: 0 }).stock);
                        const typeTag = p.hasStock === false ? '[Service]' : '[Product]';
                        const selected = String(state.currentSaleProductIndex || '') === String(i) ? 'selected' : '';
                        return `<option value="${i}" ${selected}>${p.name} - ${p.category} ${typeTag}${p.hasStock === false ? '' : ` (Stock: ${stockText})`}</option>`;
                    }).join('');
                })()}
                    </select>
                </div>
                <div id="newProductFields" style="${String(state.currentSaleProductIndex || '') === 'new' ? 'display:block;' : 'display:none;'}">
                    <div class="form-group bulk-row" style="display:flex; gap:8px; align-items:end;">
                        <div style="flex:1;">
                            <label>Item Type</label>
                            <select id="newProductType" onchange="toggleNewProductType(); try { state.saleNewProductType = this.value; saveData(); } catch {}">
                                <option value="product" ${String(state.saleNewProductType || 'product') === 'product' ? 'selected' : ''}>Product (has stock)</option>
                                <option value="service" ${String(state.saleNewProductType || 'product') === 'service' ? 'selected' : ''}>Service (no stock)</option>
                            </select>
                        </div>
                        <div style="flex:2;">
                            <label>New Item Name</label>
                            <input type="text" id="newProductName" placeholder="Enter name" value="${(state.saleNewProductForm && state.saleNewProductForm.name) || ''}" oninput="try { state.saleNewProductForm = state.saleNewProductForm || {}; state.saleNewProductForm.name = this.value; saveData(); } catch {}">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Category</label>
                        <select id="newProductCategory" onchange="handleCategorySelection()">
                            <option value="">-- Select Category --</option>
                            <option class="opt-new" value="new">+ Add New Category</option>
                        ${state.categories.slice().sort((a, b) => String(a).localeCompare(String(b))).map(c => `<option value="${c}" ${String(state.currentNewProductCategory || '') === String(c) ? 'selected' : ''}>${c}</option>`).join('')}
                        </select>
                    </div>
                    <div id="newCategoryField" style="${String(state.currentNewProductCategory || '') === 'new' ? 'display:block;' : 'display:none;'}">
                        <div class="form-group">
                            <label>New Category Name</label>
                            <input type="text" id="newCategoryName" placeholder="Enter category name" value="${(state.saleNewProductForm && state.saleNewProductForm.newCategoryName) || ''}" oninput="try { state.saleNewProductForm = state.saleNewProductForm || {}; state.saleNewProductForm.newCategoryName = this.value; saveData(); } catch {}">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Cost (Capital)</label>
                        <input type="text" id="newProductCost" class="money-input" placeholder="0" value="${(state.saleNewProductForm && state.saleNewProductForm.cost) || ''}" oninput="try { state.saleNewProductForm = state.saleNewProductForm || {}; state.saleNewProductForm.cost = this.value; saveData(); } catch {}">
                    </div>
                    <div class="form-group">
                        <label>Price (Selling)</label>
                        <input type="text" id="newProductPrice" class="money-input" placeholder="0" value="${(state.saleNewProductForm && state.saleNewProductForm.price) || ''}" oninput="try { state.saleNewProductForm = state.saleNewProductForm || {}; state.saleNewProductForm.price = this.value; saveData(); } catch {}">
                    </div>
                    <div class="form-group" id="newProductInitialStockGroup" style="${String(state.saleNewProductType || 'product') === 'service' ? 'display:none;' : 'display:block;'}">
                        <label>Initial Stock</label>
                        <input type="text" id="newProductStock" class="money-input" placeholder="0" value="${(state.saleNewProductForm && state.saleNewProductForm.stock) || '0'}" oninput="try { state.saleNewProductForm = state.saleNewProductForm || {}; state.saleNewProductForm.stock = this.value; saveData(); } catch {}">
                    </div>
                    <div class="flex-gap" style="margin-bottom:12px;">
                        <button type="button" class="btn-success" onclick="saveNewProductFromSales()">✅ Save New Item</button>
                        <button type="button" class="btn-secondary" onclick="cancelNewProduct()">✖ Cancel</button>
                    </div>
                </div>
                <div class="form-group">
                    <label>Customer</label>
                    <select id="saleCustomer" onchange="toggleCustomerInput(); updateSaleTotal()">
                        <option value="">-- Walk-in --</option>
                        <option value="new" ${String(state.currentSaleCustomerIndex || '') === 'new' ? 'selected' : ''}>+ Add New Customer</option>
                        ${state.customers
                    .map((c, i) => ({ c, i }))
                    .sort((a, b) => String(a.c.name).localeCompare(String(b.c.name)))
                    .map(({ c, i }) => `<option value="${i}" ${String(state.currentSaleCustomerIndex || '') === String(i) ? 'selected' : ''}>${c.name}</option>`).join('')}
                    </select>
                </div>
                <div id="newCustomerFields" style="${String(state.currentSaleCustomerIndex || '') === 'new' ? 'display:block;' : 'display:none;'}">
                    <div class="form-group">
                        <label>New Customer Name</label>
                        <input type="text" id="newCustomerName" placeholder="Enter customer name" value="${(state.saleNewCustomerForm && state.saleNewCustomerForm.name) || ''}" oninput="try { state.saleNewCustomerForm = state.saleNewCustomerForm || {}; state.saleNewCustomerForm.name = this.value; saveData(); } catch {}">
                    </div>
                    <div class="form-group">
                        <label>Phone (Optional)</label>
                        <input type="tel" id="newCustomerPhone" placeholder="+255..." value="${(state.saleNewCustomerForm && state.saleNewCustomerForm.phone) || ''}" oninput="try { state.saleNewCustomerForm = state.saleNewCustomerForm || {}; state.saleNewCustomerForm.phone = this.value; saveData(); } catch {}">
                    </div>
                </div>
                <div class="form-group">
                    <label>Quantity</label>
                    <input type="text" id="saleQuantity" class="money-input" placeholder="Qty" value="1" onchange="updateSaleTotal()" onfocus="this.value='';" onblur="(function(el){ var v=parseMoney(el.value); if (!String(el.value||'').trim() || isNaN(v) || v<1) el.value='1'; })(this); updateSaleTotal();" required>
                </div>
                <div class="form-group">
                    <label>Payment Method</label>
                    <select id="salePayment" onchange="updateSaleTotal()">
                        <option>Cash</option>
                        <option>Card</option>
                        <option>Mobile Money</option>
                        <option>M-Pesa Lipa Number</option>
                        <option>Bank Transfer</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select id="saleStatus">
                        <option value="paid" selected>Paid</option>
                        <option value="unpaid">Unpaid</option>
                    </select>
                </div>
                <div id="saleInfo" style="display:none;"></div>
                <button type="submit">Record Sale</button>
            </form>
        </div>

        <div class="card">
            <h2>Recent Sales (${filteredSales.length})</h2>
            <div class="card-header-buttons"><button class="btn-small" onclick="copyAllSales()">📋 Copy All</button></div>
            
                <div class="search-box">
                    <input type="search" name="search_field_unique_${Date.now()}" autocomplete="off" id="salesSearchInput" placeholder="🔍 Search sales..." oninput="updateSearchPeriod(this.value); toggleClearButton('salesSearchInput', 'salesClearBtn')" value="${state.searchPeriod || ''}" readonly onfocus="this.removeAttribute('readonly');">
                    <button id="salesClearBtn" class="clear-btn btn-small btn-secondary hint ${String(state.searchPeriod || '').trim() ? 'visible' : ''}" onclick="clearSalesSearch()">Clear</button>
                </div>
                <div style="margin-bottom:8px;">${renderTagChips('sales')}</div>

            <div class="filter-row">
                <div class="form-group">
                    <label>From...</label>
                    <input type="date" onchange="updateFilterDateFrom(this.value)" value="${state.filterDateFrom || ''}" placeholder="mm/dd/yyyy">
                </div>
                <div class="form-group">
                    <label>To...</label>
                    <input type="date" onchange="updateFilterDateTo(this.value)" value="${state.filterDateTo || ''}" placeholder="mm/dd/yyyy">
                </div>
                <div class="form-group">
                    <label>Customer</label>
                    <select onchange="updateFilterCustomer(this.value)">
                        <option value="">All Customers</option>
                        ${[...new Set(state.sales.map(s => s.customer))]
                    .filter(c => !!c)
                    .sort((a, b) => String(a).localeCompare(String(b)))
                    .map(c =>
                        `<option value="${c}" ${state.filterCustomer === c ? 'selected' : ''}>${c}</option>`
                    ).join('')}
                    </select>
                </div>
                <button class="btn-small btn-secondary" onclick="clearFilters()" title="Clear">Clear</button>
                <button class="btn-small" onclick="scrollToSalesHistory()" title="History">History</button>
            </div>

            ${(() => {
                    const arr = filteredSales.slice();
                    const count = (state.listShowCount && state.listShowCount.sales) ? state.listShowCount.sales : 3;
                    const bulk = `
                <div class="bulk-actions">
                    <input type="checkbox" id="selectAll_sales" onchange="toggleSelectAll('sales')" class="checkbox-select">
                    <label for="selectAll_sales">Select All</label>
                    <span style="color: #666; font-size: 12px; margin-left: 8px;">${getSelectedCount('sales')} selected</span>
                    <button class="btn-small btn-danger" onclick="bulkDelete('sales')" ${!hasSelected('sales') ? 'disabled' : ''}>🗑️ Delete Selected</button>
                    <button class="btn-small btn-tag" onclick="bulkApplyTag('sales')" ${!hasSelected('sales') ? 'disabled' : ''} title="📌 Apply Tag">📌 Apply Tag</button>
                </div>`;
                    const items = arr.slice(0, count).map((s) => {
                        const isService = (state.products.find(p => p.name === s.productName)?.hasStock === false);
                        const typeBadge = isService ? '<span class="badge badge-warning">Service</span>' : '<span class="badge badge-success">Product</span>';
                        const statusBadge = (s.status === 'unpaid') ? '<span class="badge badge-danger">Unpaid</span>' : '';
                        return `
                    <div class="item" id="sale-${s.timestamp}">
                        <div style="display: flex; gap: 12px; align-items: start;">
                            <input type="checkbox" class="checkbox-select" ${state.selectedItems.sales && state.selectedItems.sales[s.id] ? 'checked' : ''} onchange="toggleSelect('sales', '${s.id}')">
                            <div style="flex: 1;">
                                <div class="item-header">
                                    <span class="item-title">${s.productName} ${typeBadge} ${statusBadge}</span>
                                    <span style="color: #2e7d32; font-weight: 700;"><span class="money-text"> ${formatNumber(s.profit)} Tsh</span></span>
                                </div>
                                ${(() => {
                                const editing = state.inlineEditSales && state.inlineEditSales[s.timestamp]; return editing ? `
                                <div class=\"form-group\" data-label=\"Qty\"><input type=\"text\" id=\"saleQty_${s.timestamp}\" class=\"money-input\" value=\"${s.quantity}\" placeholder=\"Qty\"></div>
                                <div class=\"form-group\" data-label=\"Price\"><input type=\"text\" id=\"salePrice_${s.timestamp}\" class=\"money-input\" value=\"${s.pricePerUnit}\" placeholder=\"Price per unit\"></div>
                                <div class=\"form-group\" data-label=\"Payment\"><select id=\"salePay_${s.timestamp}\"><option ${s.payment === 'Cash' ? 'selected' : ''}>Cash</option><option ${s.payment === 'Card' ? 'selected' : ''}>Card</option><option ${s.payment === 'Mobile Money' ? 'selected' : ''}>Mobile Money</option><option ${s.payment === 'Bank Transfer' ? 'selected' : ''}>Bank Transfer</option></select></div>
                                ` : `
                                <div class=\"item-subtitle\">${s.date} ${s.time}<br>${s.customer} | Qty: ${s.quantity} | ${s.payment}<br>Cost: <span class=\"money-text\">${formatNumber(s.totalCost)} Tsh</span> | Price: <span class=\"money-text\">${formatNumber(s.totalPrice)} Tsh</span></div>
                                `;
                            })()}
                                <div class="flex-gap" style="margin-top:8px;">
                                    <button class="btn-small btn-receipt" style="background: linear-gradient(145deg, #ffeb3b, #fbc02d); color: #333;" onclick="downloadSaleReceiptPDF(${s.timestamp})">📄 Receipt</button>
                                    ${state.inlineEditSales && state.inlineEditSales[s.timestamp] ? `<button class=\"btn-small btn-success\" type=\"button\" onclick=\"saveSaleInlineEdit(${s.timestamp})\">Save</button><button class=\"btn-small btn-secondary\" type=\"button\" onclick=\"toggleSaleInlineEdit(${s.timestamp})\">Cancel</button>` : `<button class=\"btn-small\" type=\"button\" onclick=\"toggleSaleInlineEdit(${s.timestamp})\">Edit</button><button class=\"btn-small btn-danger\" type=\"button\" onclick=\"event.stopPropagation(); deleteSaleByTimestamp(${s.timestamp})\">Delete</button>`}
                                    <button class="btn-small" type="button" onclick="copySaleByTimestamp(${s.timestamp})">📋 Copy</button>
                                    <button class="btn-small" style="${state.theme === 'dark' ? 'background:#1f2937;color:#e5e7eb;border:1px solid #374151;' : 'background:#e8e8e8;color:#333;border:1px solid #999;'}" onclick="openItemTagsModal('sales', '${s.id}')">📌 Tag</button>
                                </div>
                                ${renderTagBadges(s)}
                            </div>
                        </div>
                    </div>
                    `;
                    }).join('') || '<p style="text-align: center; color: #666;">No sales found</p>';
                    const total = arr.length;
                    const hasMore = count < total;
                    const moreBtn = `<div class=\"flex-gap\" style=\"justify-content:center;margin:8px 0;flex-wrap:nowrap;\">\n                        <button class=\"collapse-btn\" onclick=\"${hasMore ? `showMoreList('sales')` : `collapseList('sales')`}\"><span class=\"collapse-icon ${hasMore ? '' : 'expanded'}\">▼</span><span>${hasMore ? 'See more' : 'Hide'}</span></button>\n                        <button class=\"collapse-btn\" onclick=\"showAllList('sales')\"><span class=\"collapse-icon\">▼</span><span>Show all</span></button>\n                    </div>`;
                    const showHistory = arr.length > 50;
                    const historyItems = showHistory ? arr.slice(50).map((s) => {
                        const isService = (state.products.find(p => p.name === s.productName)?.hasStock === false);
                        const typeBadge = isService ? '<span class="badge badge-warning">Service</span>' : '<span class="badge badge-success">Product</span>';
                        const statusBadge = (s.status === 'unpaid') ? '<span class="badge badge-danger">Unpaid</span>' : '';
                        return `
                        <div class="item" id="sale-${s.timestamp}">
                            <div class="item-header">
                                <span class="item-title">${s.productName} ${typeBadge} ${statusBadge}</span>
                                <span style="color: #2e7d32; font-weight: 700;"> ${formatNumber(s.profit)} Tsh</span>
                            </div>
                            <div class="item-subtitle">${s.date} ${s.time}<br>${s.customer} | Qty: ${s.quantity} | ${s.payment}<br>Cost: ${formatNumber(s.totalCost)} | Price: ${formatNumber(s.totalPrice)}</div>
                            ${renderTagBadges(s)}
                        </div>
                        `;
                    }).join('') : '';
                    const historyCard = showHistory ? `
                        <div class="card" id="salesHistoryCard">
                            <h2>Sales History (${Math.max(0, arr.length - 50)})</h2>
                            <div class="list-scroll-container">${historyItems}</div>
                        </div>
                    ` : '';
                    return bulk + `<div class="list-scroll-container" id="salesList"></div>` + moreBtn + historyCard;
                })()}
        </div>
    `;
        }


        function updateSearchPeriod(value) {
            state.searchPeriod = value;
            if (renderTimer) { try { clearTimeout(renderTimer); } catch {} }
            renderTimer = setTimeout(function(){ try { render(); } catch {} }, 120);
        }

        // Clear button functions
        function toggleClearButton(inputId, buttonId) {
            const input = document.getElementById(inputId);
            const button = document.getElementById(buttonId);
            if (input && button) {
                if (input.value.trim()) {
                    button.classList.add('visible');
                    button.classList.add('hint');
                } else {
                    button.classList.remove('visible');
                    setTimeout(() => button.classList.remove('hint'), 300);
                }
            }
        }

        function clearSalesSearch() {
            state.searchPeriod = '';
            document.getElementById('salesSearchInput').value = '';
            toggleClearButton('salesSearchInput', 'salesClearBtn');
            render();
        }

        function clearProductSearch() {
            state.productSearch = '';
            document.getElementById('productSearch').value = '';
            document.getElementById('productSearchBottom').value = '';
            toggleClearButton('productSearch', 'productClearBtn');
            toggleClearButton('productSearchBottom', 'productClearBtnBottom');
            searchProducts('');
        }

        function clearExpensesSearch() {
            state.searchPeriod = '';
            document.getElementById('expensesSearchInput').value = '';
            toggleClearButton('expensesSearchInput', 'expensesClearBtn');
            render();
        }

        function clearIncomeSearch() {
            state.searchPeriod = '';
            document.getElementById('incomeSearchInput').value = '';
            toggleClearButton('incomeSearchInput', 'incomeClearBtn');
            render();
        }

        function createVirtualList(containerEl, items, renderItem, rowHeight = 96, buffer = 5) {
            if (!containerEl) return;
            const h = containerEl.clientHeight || 420;
            const visibleCount = Math.max(1, Math.ceil(h / rowHeight));
            containerEl.innerHTML = '<div style="position:relative;height:100%;"><div class="vl-spacer"></div><div class="vl-viewport" style="position:absolute;left:0;right:0;top:0;"></div></div>';
            const spacer = containerEl.querySelector('.vl-spacer');
            const viewport = containerEl.querySelector('.vl-viewport');
            spacer.style.height = String(items.length * rowHeight) + 'px';
            let lastStart = -1;
            const renderChunk = (scrollTop) => {
                const start = Math.max(0, Math.floor(scrollTop / rowHeight) - buffer);
                if (start === lastStart) return;
                lastStart = start;
                const end = Math.min(items.length, start + visibleCount + buffer * 2);
                const slice = items.slice(start, end);
                viewport.style.transform = 'translateY(' + (start * rowHeight) + 'px)';
                viewport.innerHTML = slice.map(renderItem).join('');
            };
            renderChunk(containerEl.scrollTop || 0);
            containerEl.onscroll = function(){ renderChunk(containerEl.scrollTop || 0); };
        }

        function renderSaleItemHTML(s) {
            const isService = (state.products.find(p => p.name === s.productName)?.hasStock === false);
            const typeBadge = isService ? '<span class="badge badge-warning">Service</span>' : '<span class="badge badge-success">Product</span>';
            const statusBadge = (s.status === 'unpaid') ? '<span class="badge badge-danger">Unpaid</span>' : '';
            return (
                '<div class="item" id="sale-' + s.timestamp + '">' +
                '<div style="display:flex;gap:12px;align-items:start;">' +
                '<input type="checkbox" class="checkbox-select" ' + (state.selectedItems.sales && state.selectedItems.sales[s.id] ? 'checked' : '') + ' onchange="toggleSelect(\'sales\', \'' + s.id + '\')">' +
                '<div style="flex:1;">' +
                '<div class="item-header"><span class="item-title">' + s.productName + ' ' + typeBadge + ' ' + statusBadge + '</span><span style="color:#2e7d32;font-weight:700;"><span class="money-text"> ' + formatNumber(s.profit) + ' Tsh</span></span></div>' +
                (function(){ const editing = state.inlineEditSales && state.inlineEditSales[s.timestamp]; return editing ? (
                    '<div class="form-group" data-label="Qty"><input type="text" id="saleQty_' + s.timestamp + '" class="money-input" value="' + s.quantity + '" placeholder="Qty"></div>' +
                    '<div class="form-group" data-label="Price"><input type="text" id="salePrice_' + s.timestamp + '" class="money-input" value="' + s.pricePerUnit + '" placeholder="Price per unit"></div>' +
                    '<div class="form-group" data-label="Payment"><select id="salePay_' + s.timestamp + '"><option ' + (s.payment === 'Cash' ? 'selected' : '') + '>Cash</option><option ' + (s.payment === 'Card' ? 'selected' : '') + '>Card</option><option ' + (s.payment === 'Mobile Money' ? 'selected' : '') + '>Mobile Money</option><option ' + (s.payment === 'Bank Transfer' ? 'selected' : '') + '>Bank Transfer</option></select></div>'
                ) : (
                    '<div class="item-subtitle">' + s.date + ' ' + s.time + '<br>' + s.customer + ' | Qty: ' + s.quantity + ' | ' + s.payment + '<br>Cost: <span class="money-text">' + formatNumber(s.totalCost) + ' Tsh</span> | Price: <span class="money-text">' + formatNumber(s.totalPrice) + ' Tsh</span></div>'
                ); })() +
                '<div class="flex-gap" style="margin-top:8px;">' +
                '<button class="btn-small btn-receipt" style="background:linear-gradient(145deg,#ffeb3b,#fbc02d);color:#333;" onclick="downloadSaleReceiptPDF(' + s.timestamp + ')">📄 Receipt</button>' +
                (state.inlineEditSales && state.inlineEditSales[s.timestamp]
                    ? '<button class="btn-small btn-success" type="button" onclick="saveSaleInlineEdit(' + s.timestamp + ')">Save</button><button class="btn-small btn-secondary" type="button" onclick="toggleSaleInlineEdit(' + s.timestamp + ')">Cancel</button>'
                    : '<button class="btn-small" type="button" onclick="toggleSaleInlineEdit(' + s.timestamp + ')">Edit</button><button class="btn-small btn-danger" type="button" onclick="event.stopPropagation(); deleteSaleByTimestamp(' + s.timestamp + ')">Delete</button><button class="btn-small" type="button" onclick="copySaleByTimestamp(' + s.timestamp + ')">📋 Copy</button>'
                ) +
                '<button class="btn-small" style="' + (state.theme === 'dark' ? 'background:#1f2937;color:#e5e7eb;border:1px solid #374151;' : 'background:#e8e8e8;color:#333;border:1px solid #999;') + '" onclick="openItemTagsModal(\'sales\', \'' + (s.id || s.timestamp) + '\')">📌 Tag</button>' +
                '</div>' +
                renderTagBadges(s) +
                '</div>' +
                '</div>' +
                '</div>'
            );
        }

        async function setupSalesVirtual(){ try { const el=document.getElementById('salesList'); if(!el) return; let items=(state.lastFilteredSales||state.sales||[]).slice(); try{ if(window.tubaDB){ const rows=await window.tubaDB.getAll('sales', false); if(Array.isArray(rows)&&rows.length){ items=rows.slice(); } } }catch{} if(state.searchPeriod){ const q=state.searchPeriod.toLowerCase(); items=items.filter(s=> String(s.productName||'').toLowerCase().includes(q)|| String(s.customer||'').toLowerCase().includes(q)|| String(s.payment||'').toLowerCase().includes(q)); } if(state.filterDateFrom){ items=items.filter(s=> new Date(s.date) >= new Date(state.filterDateFrom)); } if(state.filterDateTo){ items=items.filter(s=> new Date(s.date) <= new Date(state.filterDateTo)); } if(state.filterCustomer){ items=items.filter(s=> s.customer===state.filterCustomer); } try{ if(!state.showSalesHistory && !state.filterDateFrom && !state.filterDateTo){ const today=getTodayDateString(); items=items.filter(s=> String(s.date)===String(today)); } }catch{} items=items.filter(s=> !(s && s.deleted===true)); try{ items.sort((a,b)=> Number(b.timestamp)-Number(a.timestamp)); }catch{} const count=(state.listShowCount && state.listShowCount.sales)? state.listShowCount.sales:3; items=items.slice(0, Math.max(0, Math.min(items.length, count))); createVirtualList(el, items, renderSaleItemHTML, 120, 6); } catch {} }

        function renderSalesList() {
            const container = document.getElementById('salesList');
            if (!container) return;

            let filteredSales = state.sales.slice();
            filteredSales = filteredSales.filter(s => !(s && s.deleted === true));

            if (state.searchPeriod) {
                const Period = state.searchPeriod.toLowerCase();
                filteredSales = filteredSales.filter(s =>
                    s.productName.toLowerCase().includes(Period) ||
                    s.customer.toLowerCase().includes(Period) ||
                    s.payment.toLowerCase().includes(Period)
                );
            }

            if (state.filterDateFrom) {
                filteredSales = filteredSales.filter(s => new Date(s.date) >= new Date(state.filterDateFrom));
            }

            if (state.filterDateTo) {
                filteredSales = filteredSales.filter(s => new Date(s.date) <= new Date(state.filterDateTo));
            }

            if (state.filterCustomer) {
                filteredSales = filteredSales.filter(s => s.customer === state.filterCustomer);
            }
            try {
                if (!state.showSalesHistory && !state.filterDateFrom && !state.filterDateTo) {
                    const today = getTodayDateString();
                    filteredSales = filteredSales.filter(s => String(s.date) === String(today));
                }
            } catch {}
            filteredSales = filterItemsByTags(filteredSales, ((state.filterTags||{}).sales)||[], false);

            // Sort newest-first by timestamp (fallback to date+time)
            try {
                filteredSales.sort((a, b) => {
                    const ta = Number(a.timestamp) || new Date(`${a.date} ${a.time}`).getTime() || 0;
                    const tb = Number(b.timestamp) || new Date(`${b.date} ${b.time}`).getTime() || 0;
                    return tb - ta;
                });
            } catch { }

            container.innerHTML = filteredSales.map(s => {
                const isService = s.hasStock === false || (state.products.find(p => p.name === s.productName)?.hasStock === false);
                const typeBadge = isService ? '<span class="badge badge-warning">Service</span>' : '<span class="badge badge-success">Product</span>';
                return `
        <div class="item" id="sale-${s.timestamp}">
            <div class="item-header">
                <span class="item-title">${s.productName} ${typeBadge} ${(s.status === 'unpaid') ? '<span class="badge badge-danger">Unpaid</span>' : ''}</span>
                <span style="color: #2e7d32; font-weight: 700;"> ${formatNumber(s.profit)} Tsh</span>
            </div>
            <div style="font-size: 12px; color: #666; margin-bottom: 4px;">Category: ${s.category || 'N/A'}</div>
            ${(() => {
                        const editing = state.inlineEditSales && state.inlineEditSales[s.timestamp];
                        return editing ? `
                <div class=\"form-group\" data-label=\"Qty\"><input type=\"text\" id=\"saleQty_${s.timestamp}\" class=\"money-input\" value=\"${s.quantity}\" placeholder=\"Qty\"></div>
                <div class=\"form-group\" data-label=\"Price\"><input type=\"text\" id=\"salePrice_${s.timestamp}\" class=\"money-input\" value=\"${s.pricePerUnit}\" placeholder=\"Price per unit\"></div>
                <div class=\"form-group\" data-label=\"Payment\"><select id=\"salePay_${s.timestamp}\"><option ${s.payment === 'Cash' ? 'selected' : ''}>Cash</option><option ${s.payment === 'Card' ? 'selected' : ''}>Card</option><option ${s.payment === 'Mobile Money' ? 'selected' : ''}>Mobile Money</option><option ${s.payment === 'Bank Transfer' ? 'selected' : ''}>Bank Transfer</option></select></div>
                ` : `
                <div class=\"item-subtitle\">${s.date} ${s.time}<br>${s.customer} | Qty: ${s.quantity} | ${s.payment}<br>Cost: ${formatNumber(s.totalCost)} | Price: ${formatNumber(s.totalPrice)}</div>
                `;
                    })()}
            ${renderItemTagsUI(s, 'sales')}
            <div class="flex-gap" style="margin-top:8px;">
                ${state.inlineEditSales && state.inlineEditSales[s.timestamp]
                        ? `<button class=\"btn-small btn-success\" type=\"button\" onclick=\"saveSaleInlineEdit(${s.timestamp})\">Save</button><button class=\"btn-small btn-secondary\" type=\"button\" onclick=\"toggleSaleInlineEdit(${s.timestamp})\">Cancel</button>`
                        : `<button class=\"btn-small\" type=\"button\" onclick=\"toggleSaleInlineEdit(${s.timestamp})\">Edit</button><button class=\"btn-small btn-danger\" type=\"button\" onclick=\"event.stopPropagation(); deleteSaleByTimestamp(${s.timestamp})\">Delete</button><button class=\"btn-small\" type=\"button\" onclick=\"copySaleByTimestamp(${s.timestamp})\">📋 Copy</button>`}
            </div>
        </div>
    `}).join('') || '<p style="text-align: center; color: #666;">No sales found</p>';
        }

        function renderExpenseItemHTML(e){
            const editing = state.inlineEditExpenses && state.inlineEditExpenses[e.timestamp];
            return (
                '<div class="item">' +
                '<div style="display:flex;gap:12px;align-items:start;">' +
                '<input type="checkbox" class="checkbox-select" ' + (state.selectedItems.expenses && state.selectedItems.expenses[e.id] ? 'checked' : '') + ' onchange="toggleSelect(\'expenses\', \'' + e.id + '\')">' +
                '<div style="flex:1;">' +
                '<div class="item-header"><span class="item-title">' + e.description + '</span><span style="color:#d32f2f;font-weight:700;"> ' + formatNumber(e.amount) + ' Tsh</span></div>' +
                (editing ? (
                    '<div class="form-group" data-label="Description"><input type="text" id="expDesc_' + e.timestamp + '" value="' + e.description + '" placeholder="Description"></div>' +
                    '<div class="form-group" data-label="Amount"><input type="text" id="expAmt_' + e.timestamp + '" class="money-input" value="' + e.amount + '" placeholder="Amount"></div>' +
                    '<div class="form-group" data-label="Payment"><select id="expPay_' + e.timestamp + '"><option ' + (e.payment === 'Cash' ? 'selected' : '') + '>Cash</option><option ' + (e.payment === 'Card' ? 'selected' : '') + '>Card</option><option ' + (e.payment === 'Mobile Money' ? 'selected' : '') + '>Mobile Money</option><option ' + (e.payment === 'Bank Transfer' ? 'selected' : '') + '>Bank Transfer</option></select></div>' +
                    '<div class="form-group" data-label="Comment"><input type="text" id="expComment_' + e.timestamp + '" value="' + (e.comment || '') + '" placeholder="Comment"></div>'
                ) : (
                    '<div class="item-subtitle">' + e.date + ' | ' + e.category + ' | ' + e.payment + (e.comment ? '<br>💬 ' + e.comment : '') + '</div>'
                )) +
                '<div class="flex-gap" style="margin-top:8px;">' +
                (editing ? '<button type="button" class="btn-small btn-success" onclick="saveExpenseInlineEdit(' + e.timestamp + ')">Save</button><button type="button" class="btn-small btn-secondary" onclick="toggleExpenseInlineEdit(' + e.timestamp + ')">Cancel</button>' : '<button type="button" class="btn-small" onclick="toggleExpenseInlineEdit(' + e.timestamp + ')">Edit</button><button type="button" class="btn-small btn-danger btn-delete" data-action="delete" onclick="deleteExpenseByTimestamp(' + e.timestamp + ')">Delete</button>') +
                '<button type="button" class="btn-small btn-tag" onclick="openItemTagsModal(\'expenses\', \'' + (e.id || e.timestamp) + '\')" title="📌 Tag">📌 Tag</button>' +
                '</div>' +
                renderTagBadges(e) +
                '</div>' +
                '</div>' +
                '</div>'
            );
        }

        async function setupExpensesVirtual(){ try { const el=document.getElementById('expensesList'); if(!el) return; let arr=(state.expenses||[]).slice(); try{ if(window.tubaDB){ const rows=await window.tubaDB.getAll('expenses', false); if(Array.isArray(rows)&&rows.length){ arr=rows.slice(); } } }catch{} if(state.searchPeriod){ const q=state.searchPeriod.toLowerCase(); arr=arr.filter(e=> String(e.description||'').toLowerCase().includes(q) || String(e.category||'').toLowerCase().includes(q) || String(e.payment||'').toLowerCase().includes(q) || String(e.comment||'').toLowerCase().includes(q)); } if(state.filterDateFrom){ arr=arr.filter(e=> new Date(e.date) >= new Date(state.filterDateFrom)); } if(state.filterDateTo){ arr=arr.filter(e=> new Date(e.date) <= new Date(state.filterDateTo)); } if(state.filterCategory){ arr=arr.filter(e=> e.category===state.filterCategory); } arr=arr.filter(e=> !(e && e.deleted===true)); try{ arr.sort((a,b)=> Number(b.timestamp)-Number(a.timestamp)); }catch{} createVirtualList(el, arr, renderExpenseItemHTML, 120, 6); } catch {} }

        function renderIncomeItemHTML(i){
            const editing = state.inlineEditIncome && state.inlineEditIncome[i.timestamp];
            const capBadge = (i && (i.asCapital === true || i.as_capital === true)) ? '<span class="badge badge-success">Capital</span>' : '';
            const noTitheBadge = (i && (i.includeTithing === false || i.include_in_tithing === false)) ? '<span class="badge badge-warning">No 10%</span>' : '';
            return (
                '<div class="item">' +
                '<div style="display:flex;gap:12px;align-items:start;">' +
                '<input type="checkbox" class="checkbox-select" ' + (state.selectedItems.income && state.selectedItems.income[i.id] ? 'checked' : '') + ' onchange="toggleSelect(\'income\', \'' + i.id + '\')">' +
                '<div style="flex:1;">' +
                '<div class="item-header"><span class="item-title">' + i.source + ' ' + capBadge + ' ' + noTitheBadge + '</span><span style="color:#2e7d32;font-weight:700;">' + formatNumber(i.amount) + ' Tsh</span></div>' +
                '<div class="item-subtitle">' + i.date + ' | ' + i.payment + (i.comment ? '<br>💬 ' + i.comment : '') + '</div>' +
                (editing ? (
                    '<div class="form-group" data-label="Source"><input type="text" id="incSource_' + i.timestamp + '" value="' + i.source + '" placeholder="Source"></div>' +
                    '<div class="form-group" data-label="Amount"><input type="text" id="incAmt_' + i.timestamp + '" class="money-input" value="' + i.amount + '" placeholder="Amount"></div>' +
                    '<div class="form-group" data-label="Payment"><select id="incPay_' + i.timestamp + '"><option ' + (i.payment === 'Cash' ? 'selected' : '') + '>Cash</option><option ' + (i.payment === 'Card' ? 'selected' : '') + '>Card</option><option ' + (i.payment === 'Mobile Money' ? 'selected' : '') + '>Mobile Money</option><option ' + (i.payment === 'Bank Transfer' ? 'selected' : '') + '>Bank Transfer</option></select></div>' +
                    '<div class="form-group" data-label="Comment"><input type="text" id="incComment_' + i.timestamp + '" value="' + (i.comment || '') + '" placeholder="Comment"></div>'
                ) : '') +
                '<div class="flex-gap" style="margin-top:8px;">' +
                (editing ? '<button class="btn-small btn-success" onclick="saveIncomeInlineEdit(' + ((state.income||[]).indexOf(i)) + ')">Save</button><button class="btn-small btn-secondary" onclick="toggleIncomeInlineEdit(' + ((state.income||[]).indexOf(i)) + ')">Cancel</button>' : '<button class="btn-small" onclick="toggleIncomeInlineEdit(' + ((state.income||[]).indexOf(i)) + ')">Edit</button><button class="btn-small btn-danger btn-delete" data-action="delete" onclick="deleteIncomeIndex(' + ((state.income||[]).indexOf(i)) + ')">Delete</button>') +
                '<button class="btn-small" style="' + (state.theme === 'dark' ? 'background:#1f2937;color:#e5e7eb;border:1px solid #374151;' : 'background:#e8e8e8;color:#333;border:1px solid #999;') + '" onclick="openItemTagsModal(\'income\', \'' + (i.id || i.timestamp) + '\')">📌 Tag</button>' +
                '</div>' +
                renderTagBadges(i) +
                '</div>' +
                '</div>' +
                '</div>'
            );
        }

        async function setupIncomeVirtual(){ try { const el=document.getElementById('incomeList'); if(!el) return; let arr=(state.income||[]).slice(); try{ if(window.tubaDB){ const rows=await window.tubaDB.getAll('income', false); if(Array.isArray(rows)&&rows.length){ arr=rows.slice(); } } }catch{} if(state.searchPeriod){ const q=state.searchPeriod.toLowerCase(); arr=arr.filter(i=> String(i.source||'').toLowerCase().includes(q) || String(i.payment||'').toLowerCase().includes(q) || String(i.comment||'').toLowerCase().includes(q)); } if(state.filterDateFrom){ arr=arr.filter(i=> new Date(i.date) >= new Date(state.filterDateFrom)); } if(state.filterDateTo){ arr=arr.filter(i=> new Date(i.date) <= new Date(state.filterDateTo)); } if(state.filterSource){ arr=arr.filter(i=> i.source===state.filterSource); } arr=arr.filter(i=> !(i && i.deleted===true)); try{ arr.sort((a,b)=> Number(b.timestamp)-Number(a.timestamp)); }catch{} createVirtualList(el, arr, renderIncomeItemHTML, 110, 6); } catch {} }

        function updateFilterDateFrom(value) {
            state.filterDateFrom = value;
            render();
        }

        function updateFilterDateTo(value) {
            state.filterDateTo = value;
            render();
        }

        function updateFilterCustomer(value) {
            state.filterCustomer = value;
            render();
        }

        function scrollToSalesHistory() {
            try {
                var btn = document.querySelector('button[onclick="scrollToSalesHistory()"]');
                var beforeTop = btn ? btn.getBoundingClientRect().top : window.scrollY;
                try { state.showSalesHistory = true; } catch {}
                try { state.searchPeriod = ''; } catch {}
                try { if (typeof showAllList === 'function') { showAllList('sales'); } } catch {}
                try {
                    requestAnimationFrame(function(){
                        try {
                            var afterTop = btn ? btn.getBoundingClientRect().top : beforeTop;
                            var delta = beforeTop - afterTop;
                            if (Math.abs(delta) > 1) window.scrollBy(0, delta);
                        } catch {}
                    });
                } catch {}
            } catch {}
        }
        function openSaleByTimestamp(ts) {
            try { state.showSalesHistory = true; } catch {}
            try { state.searchPeriod = ''; state.filterDateFrom=''; state.filterDateTo=''; state.filterCustomer=''; } catch {}
            try { switchTab('sales'); } catch {}
            try { setTimeout(function(){ try { showAllList('sales'); } catch {} }, 0); } catch {}
            setTimeout(function(){
                try {
                    const el = document.getElementById('sale-' + ts);
                    if (el) {
                        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        el.style.outline = '3px solid #1976d2';
                        setTimeout(function(){ try { el.style.outline = ''; } catch {} }, 2000);
                    }
                } catch {}
            }, 250);
        }

        function openSaleDetailModal(ts) {
            try { renderSaleDetail(ts); } catch {}
            try {
                const m = document.getElementById('saleDetailModal');
                if (m) m.classList.add('show');
            } catch {}
        }
        function closeSaleDetailModal() {
            try {
                const m = document.getElementById('saleDetailModal');
                if (m) m.classList.remove('show');
            } catch {}
        }
        function renderSaleDetail(ts) {
            const c = document.getElementById('saleDetailContent');
            if (!c) return;
            const s = (state.sales || []).find(x => Number(x.timestamp) === Number(ts));
            if (!s) { c.innerHTML = '<p style="text-align:center;color:#666;">Sale not found</p>'; return; }
            try { if (!s.id) s.id = generateID('sales'); } catch {}
            const isService = s.hasStock === false || (state.products.find(p => p.name === s.productName)?.hasStock === false);
            const typeBadge = isService ? '<span class="badge badge-warning">Service</span>' : '<span class="badge badge-success">Product</span>';
            const statusBadge = (String(s.status || '').toLowerCase() === 'unpaid') ? '<span class="badge badge-danger">Unpaid</span>' : '';
            const markPaidBtn = (String(s.status || '').toLowerCase() === 'unpaid')
                ? `<button class="btn-small btn-success" style="margin-left:6px;padding:3px 8px;font-size:11px;" onclick="markPaidSale(${s.timestamp})" title="Mark Paid">Mark Paid</button>`
                : '';
            const editing = state.inlineEditSales && state.inlineEditSales[s.timestamp];
            const header = `
                <div class="item-header">
                    <span class="item-title">${s.productName} ${typeBadge} ${statusBadge} ${markPaidBtn}</span>
                    <span style="color: #2e7d32; font-weight: 700;"><span class="money-text"> ${formatNumber(s.profit)} ${getCurrencySymbol()}</span></span>
                </div>
            `;
            const details = editing ? `
                <div class="form-group" data-label="Qty"><input type="text" id="saleQty_${s.timestamp}" class="money-input" value="${s.quantity}" placeholder="Qty"></div>
                <div class="form-group" data-label="Price"><input type="text" id="salePrice_${s.timestamp}" class="money-input" value="${s.pricePerUnit}" placeholder="Price per unit"></div>
                <div class="form-group" data-label="Payment"><select id="salePay_${s.timestamp}"><option ${s.payment === 'Cash' ? 'selected' : ''}>Cash</option><option ${s.payment === 'Card' ? 'selected' : ''}>Card</option><option ${s.payment === 'Mobile Money' ? 'selected' : ''}>Mobile Money</option><option ${s.payment === 'Bank Transfer' ? 'selected' : ''}>Bank Transfer</option></select></div>
            ` : `
                <div class="item-subtitle">${s.date} ${s.time}<br>${s.customer} | Qty: ${s.quantity} | ${s.payment}<br>Cost: <span class="money-text">${formatNumber(s.totalCost)} ${getCurrencySymbol()}</span> | Price: <span class="money-text">${formatNumber(s.totalPrice)} ${getCurrencySymbol()}</span></div>
            `;
            const actions = editing ? `
                <div class="flex-gap" style="margin-top:8px;">
                    <button class="btn-small btn-receipt" style="background: linear-gradient(145deg, #ffeb3b, #fbc02d); color: #333;" onclick="downloadSaleReceiptPDF(${s.timestamp})" title="📄 Receipt">📄 Receipt</button>
                    <button class="btn-small btn-success" type="button" onclick="saveSaleInlineEdit(${s.timestamp})" title="Save">Save</button>
                    <button class="btn-small btn-secondary" type="button" onclick="toggleSaleInlineEdit(${s.timestamp})" title="Cancel">Cancel</button>
                    <button class="btn-small btn-danger" type="button" onclick="event.stopPropagation(); deleteSaleByTimestamp(${s.timestamp})" title="Delete">Delete</button>
                    <button class="btn-small" type="button" onclick="copySaleByTimestamp(${s.timestamp})" title="📋 Copy">📋 Copy</button>
                    <button class="btn-small" style="${state.theme === 'dark' ? 'background:#1f2937;color:#e5e7eb;border:1px solid #374151;' : 'background:#e8e8e8;color:#333;border:1px solid #999;'}" onclick="openItemTagsModal('sales', '${s.id}')" title="📌 Tag">📌 Tag</button>
                </div>
            ` : `
                <div class="flex-gap" style="margin-top:8px;">
                    <button class="btn-small btn-receipt" style="background: linear-gradient(145deg, #ffeb3b, #fbc02d); color: #333;" onclick="downloadSaleReceiptPDF(${s.timestamp})" title="📄 Receipt">📄 Receipt</button>
                    <button class="btn-small" type="button" onclick="toggleSaleInlineEdit(${s.timestamp})" title="Edit">Edit</button>
                    <button class="btn-small btn-danger" type="button" onclick="event.stopPropagation(); deleteSaleByTimestamp(${s.timestamp})" title="Delete">Delete</button>
                    <button class="btn-small" type="button" onclick="copySaleByTimestamp(${s.timestamp})" title="📋 Copy">📋 Copy</button>
                    <button class="btn-small" style="${state.theme === 'dark' ? 'background:#1f2937;color:#e5e7eb;border:1px solid #374151;' : 'background:#e8e8e8;color:#333;border:1px solid #999;'}" onclick="openItemTagsModal('sales', '${s.id}')" title="📌 Tag">📌 Tag</button>
                </div>
            `;
            const tags = renderTagBadges(s);
            c.innerHTML = `<div style="flex: 1;">${header}${details}${actions}${tags}</div>`;
        }

        function clearFilters() {
            state.searchPeriod = '';
            state.filterDateFrom = '';
            state.filterDateTo = '';
            state.filterCategory = '';
            state.filterCustomer = '';
            render();
        }

        function clearAllSearchInputs() {
            try {
                state.searchPeriod = '';
                state.productSearch = '';
                state.categorySearch = '';
                state.customerSearch = '';
                state.stockSearch = '';
                state.invoiceSearch = '';
                state.transactionSearch = '';
            } catch {}
            try { const el = document.getElementById('salesSearchInput'); if (el) el.value = ''; } catch {}
            try { const el = document.getElementById('expensesSearchInput'); if (el) el.value = ''; } catch {}
            try { const el = document.getElementById('incomeSearchInput'); if (el) el.value = ''; } catch {}
            try { const el = document.getElementById('productSearch'); if (el) el.value = ''; } catch {}
            try { const el = document.getElementById('productSearchBottom'); if (el) el.value = ''; } catch {}
            try { const el = document.getElementById('categorySearch'); if (el) el.value = ''; } catch {}
            try { const el = document.getElementById('categorySearchBottom'); if (el) el.value = ''; } catch {}
            try { const el = document.getElementById('customerSearch'); if (el) el.value = ''; } catch {}
            try { const el = document.getElementById('stockSearch'); if (el) el.value = ''; } catch {}
            try { const el = document.getElementById('invoiceSearchInput'); if (el) el.value = ''; } catch {}
            try { const el = document.getElementById('transactionSearch'); if (el) el.value = ''; } catch {}
            try { const el = document.getElementById('noteSearch'); if (el) el.value = ''; } catch {}
            try { render(); } catch {}
        }

        function renderCollapsibleList(items, chunkSize, sectionKey, renderItem, emptyMessage) {
            if (!items || items.length === 0) {
                return `<p style="text-align: center; color: #666;">${emptyMessage}</p>`;
            }

            let html = '';
            for (let i = 0; i < items.length; i += chunkSize) {
                const chunk = items.slice(i, i + chunkSize);
                const chunkId = `${sectionKey}_chunk_${i}`;
                const isCollapsed = state.collapsedSections[chunkId];

                html += chunk.map((item, idx) => renderItem(item, i + idx)).join('');

                if (i + chunkSize < items.length) {
                    html += `
                        <button class="collapse-btn" onclick="toggleCollapse('${chunkId}')">
                            <span class="collapse-icon ${isCollapsed ? '' : 'expanded'}">▼</span>
                            <span>${isCollapsed ? 'Show More' : 'Show Less'}</span>
                        </button>
                    `;

                    if (isCollapsed) {
                        break;
                    }
                }
            }
            return html;
        }

        function toggleCollapse(chunkId) {
            state.collapsedSections[chunkId] = !state.collapsedSections[chunkId];
            render();
        }

        function toggleListExpanded(key) {
            if (!state.listExpanded) state.listExpanded = {};
            state.listExpanded[key] = !state.listExpanded[key];
            render();
        }

        function showMoreList(key) {
            if (!state.listShowCount) state.listShowCount = {};
            const inc = 3;
            const current = state.listShowCount[key] || 3;
            state.listShowCount[key] = current + inc;
            const x = window.scrollX, y = window.scrollY;
            saveData();
            render();
            window.scrollTo(x, y);
        }

        function collapseList(key) {
            if (!state.listShowCount) state.listShowCount = {};
            state.listShowCount[key] = 3;
            const x = window.scrollX, y = window.scrollY;
            saveData();
            render();
            window.scrollTo(x, y);
        }

        function showAllList(key) {
            if (!state.listShowCount) state.listShowCount = {};
            state.listShowCount[key] = 1000000;
            saveData();
            render();
        }

        function toggleSelectAll(type) {
            if (!state.selectedItems[type]) state.selectedItems[type] = {};
            const q = `input.checkbox-select[onchange^="toggleSelect('${type}',"]`;
            const boxes = Array.from(document.querySelectorAll(q)).filter(b => b.id !== `selectAll_${type}`);
            if (boxes.length === 0) return;
            const allSelected = boxes.every(b => b.checked);
            const newState = !allSelected;
            boxes.forEach(b => {
                const oc = String(b.getAttribute('onchange') || '');
                const m = oc.match(/^toggleSelect\('([^']+)'\s*,\s*'([^']+)'\)/);
                const id = m ? m[2] : null;
                if (id) {
                    if (!state.selectedItems[type]) state.selectedItems[type] = {};
                    state.selectedItems[type][id] = newState;
                }
                try { b.checked = newState; } catch {}
            });
            saveData();
            render();
        }

        function updateSelectAllCheckbox(type) {
            setTimeout(() => {
                const checkbox = document.getElementById(`selectAll_${type}`);
                if (!checkbox) return;
                const boxes = Array.from(document.querySelectorAll(`input.checkbox-select[onchange^="toggleSelect('${type}',"]`)).filter(b => b.id !== `selectAll_${type}`);
                if (boxes.length === 0) { checkbox.checked = false; return; }
                const allSelected = boxes.every(b => b.checked);
                checkbox.checked = allSelected;
            }, 0);
        }

        function toggleSelect(type, id) {
            if (!state.selectedItems[type]) state.selectedItems[type] = {};
            state.selectedItems[type][id] = !state.selectedItems[type][id];
            saveData();

            // Update the "Select All" checkbox state
            updateSelectAllCheckbox(type);

            // Update count display
            render();
        }

        function hasSelected(type) {
            return state.selectedItems[type] && Object.values(state.selectedItems[type]).some(v => v);
        }

        function getSelectedCount(type) {
            if (!state.selectedItems[type]) return 0;
            return Object.values(state.selectedItems[type]).filter(v => v).length;
        }

        async function bulkDelete(type) {
            const selected = Object.keys(state.selectedItems[type] || {}).filter(id => state.selectedItems[type][id]);

            if (selected.length === 0) return showToast('No items selected', 'info');
            try { playDeleteSound(); } catch (e) { }
            const ok = await requirePinForDestructive('delete');
            if (!ok) { showToast('Delete failed: PIN required', 'error'); return; }
            const items = type === 'unpaidEntries' ? state.unpaidEntries : state[type];
            if (syncEnabled) {
                try {
                    selected.forEach(selId => {
                        const it = items.find(x => x.id === selId);
                        if (!it) return;
                        switch (type) {
                            case 'sales':
                                deleteOne('sales', { timestamp: it.timestamp });
                                break;
                            case 'expenses':
                                deleteOne('expenses', { timestamp: it.timestamp });
                                break;
                            case 'income':
                                deleteOne('income', { timestamp: it.timestamp });
                                break;
                            case 'customers':
                                deleteOne('customers', { name: it.name, email: it.email || '' });
                                break;
                            case 'products':
                                deleteOne('products', { name: it.name, category: it.category || '' });
                                break;
                            case 'transactions':
                                deleteOne('transactions', { timestamp: it.timestamp });
                                break;
                            case 'unpaidEntries':
                                deleteOne('unpaid_entries', { timestamp: it.timestamp });
                                break;
                            case 'notes':
                                deleteOne('notes', { timestamp: it.timestamp });
                                break;
                            default:
                                break;
                        }
                    });
                } catch { }
            }
            const filtered = items.filter(item => !selected.includes(item.id));

            if (type === 'unpaidEntries') {
                state.unpaidEntries = filtered;
            } else {
                state[type] = filtered;
            }

            state.selectedItems[type] = {};
            saveData();
            render();

            setTimeout(() => {
                const checkbox = document.getElementById(`selectAll_${type}`);
                if (checkbox) checkbox.checked = false;
            }, 100);

            showToast(`${selected.length} items deleted`, 'success');

            if (syncEnabled) syncInBackground();
        }
        function bulkApplyTag(type) {
            const selected = Object.keys(state.selectedItems[type] || {}).filter(id => state.selectedItems[type][id]);
            if (selected.length === 0) return showToast('No items selected', 'info');
            openBulkTagsModal(type);
        }

        function bulkMarkPaid() {
            const selected = Object.keys(state.selectedItems.unpaidEntries || {})
                .filter(id => state.selectedItems.unpaidEntries[id]);

            if (selected.length === 0) return showToast('No items selected', 'info');

            showConfirm(`Mark ${selected.length} entries as paid?`, function () {
                selected.forEach(id => {
                    const entry = state.unpaidEntries.find(e => e.id === id);
                    if (entry) {
                        entry.paid = true;
                        const now = new Date();
                        state.sales.push({
                            id: generateID('sales'),
                            date: getTodayDateString(),
                            time: now.toLocaleTimeString(),
                            timestamp: now.getTime(),
                            productName: entry.type,
                            customer: entry.name,
                            quantity: 1,
                            costPerUnit: 0,
                            pricePerUnit: entry.amount,
                            totalCost: 0,
                            totalPrice: entry.amount,
                            profit: entry.amount,
                            payment: 'Unpaid Entry - Now Paid'
                        });
                    }
                });

                state.selectedItems.unpaidEntries = {};
                saveData();
                render();

                // Uncheck select all checkbox
                setTimeout(() => {
                    const checkbox = document.getElementById('selectAll_unpaidEntries');
                    if (checkbox) checkbox.checked = false;
                }, 100);

                showToast(`${selected.length} entries marked as paid`, 'success');

                if (syncEnabled) syncInBackground();
            });
        }

        function closeInlineEditModal(){
            closeModalById('inlineEditModal');
            setTimeout(() => { try { if (window._originalRender) window._originalRender(); else render(); } catch {} }, 0);
        }

        async function openInlineEditModal(title, bodyHtml, saveHandler, cancelHandler){
            try {
                const hasPin = !!(state && state.securityPinHash);
                if (!hasPin && typeof requirePinForDestructive === 'function') {
                    const ok = await requirePinForDestructive('edit');
                    if (!ok) return;
                }
            } catch {}
            const titleEl = document.getElementById('inlineEditModalTitle');
            const contentEl = document.getElementById('inlineEditModalContent');
            const actionsEl = document.getElementById('inlineEditModalActions');
            if (titleEl) titleEl.textContent = title || 'Edit';
            if (contentEl) {
                const locked = `<div id="inlineEditLockedArea" class="locked-content">${bodyHtml || ''}</div>`;
                const pinGate = `
                    <div class="pin-gate-wrapper">
                        <div class="form-group">
                            <label>Enter Security PIN to Edit</label>
                            <input type="password" id="modalPinGateInput" maxlength="4" placeholder="••••" inputmode="numeric" style="padding-right: 40px;">
                            <div id="modalPinGateIcon" class="pin-icon-status"></div>
                        </div>
                        <div id="modalPinGateToast" class="pin-toast-inline">Authenticated!.</div>
                    </div>
                `;
                contentEl.innerHTML = pinGate + locked;
            }
            if (actionsEl) {
                const cancel = cancelHandler || 'closeInlineEditModal()';
                actionsEl.innerHTML = `<button class="btn-small btn-success" type="button" onclick="${saveHandler}">Save</button><button class="btn-small btn-secondary" type="button" onclick="${cancel}">Cancel</button>`;
            }
            try { if (window.closeAllModals) closeAllModals(); } catch {}
            openModalById('inlineEditModal');
            try {
                const modal = document.getElementById('inlineEditModal');
                if (modal) {
                    if (window.__inlineEditKeyHandler) modal.removeEventListener('keydown', window.__inlineEditKeyHandler);
                    window.__inlineEditKeyHandler = function(e){
                        if (e.key === 'Escape') { e.preventDefault(); closeInlineEditModal(); return; }
                        if (e.key === 'Enter') { e.preventDefault(); const btn = document.querySelector('#inlineEditModalActions .btn-success'); if (btn) btn.click(); }
                    };
                    modal.addEventListener('keydown', window.__inlineEditKeyHandler);
                    modal.setAttribute('tabindex','-1');
                    modal.focus();
                }
            } catch {}
            try { document.querySelectorAll('#inlineEditModal .money-input').forEach(el => attachMoneyFormatter(el)); } catch {}
            try {
                const pinInput = document.getElementById('modalPinGateInput');
                const statusIcon = document.getElementById('modalPinGateIcon');
                const toastMsg = document.getElementById('modalPinGateToast');
                const lockedArea = document.getElementById('inlineEditLockedArea');
                const saveBtn = document.querySelector('#inlineEditModalActions .btn-success');
                let pinTimer;
                if (saveBtn) saveBtn.disabled = true;
                setTimeout(() => { try { pinInput && pinInput.focus(); } catch {} }, 100);
                if (pinInput) {
                    pinInput.oninput = (e) => {
                        const val = String(e.target.value || '').replace(/\D/g, '').slice(0, 4);
                        if (e.target.value !== val) e.target.value = val;
                        clearTimeout(pinTimer);
                        if (statusIcon) {
                            statusIcon.className = 'pin-icon-status';
                            statusIcon.style.display = 'none';
                        }
                        if (toastMsg) {
                            toastMsg.classList.remove('show');
                            toastMsg.textContent = 'Authenticated!.';
                        }
                        if (val.length === 4) {
                            if (statusIcon) {
                                statusIcon.style.display = 'block';
                                statusIcon.className = 'pin-icon-status pin-spinner';
                            }
                            pinTimer = setTimeout(async () => {
                                const correctHash = (state && state.securityPinHash) || '';
                                let ok = false;
                                try {
                                    const h = await window.hashPin(val);
                                    ok = !!correctHash && String(h || '') === String(correctHash || '');
                                } catch {}
                                if (ok) {
                                    if (pinInput) pinInput.style.borderColor = '';
                                    if (statusIcon) statusIcon.className = 'pin-icon-status pin-checkmark';
                                    if (toastMsg) toastMsg.classList.add('show');
                                    if (lockedArea) lockedArea.classList.remove('locked-content');
                                    if (saveBtn) saveBtn.disabled = false;
                                    setTimeout(() => { if (toastMsg) toastMsg.classList.remove('show'); }, 3000);
                                } else {
                                    if (statusIcon) {
                                        statusIcon.style.display = 'block';
                                        statusIcon.className = 'pin-icon-status pin-cross';
                                    }
                                    if (toastMsg) {
                                        toastMsg.textContent = 'Wrong PIN.';
                                        toastMsg.classList.add('show');
                                    }
                                    if (pinInput) {
                                        pinInput.style.borderColor = 'red';
                                        setTimeout(() => { try { pinInput.style.borderColor = ''; } catch {} }, 1000);
                                    }
                                }
                            }, 600);
                        }
                    };
                }
            } catch {}
        }

        function openSaleInlineEditModal(ts){
            const s = state.sales.find(x => x.timestamp === ts);
            if (!s) return showToast('Sale not found', 'error');
            const body = `
                <div class="form-group" data-label="Qty"><input type="text" id="saleQty_${ts}" class="money-input" value="${s.quantity}" placeholder="Qty"></div>
                <div class="form-group" data-label="Price"><input type="text" id="salePrice_${ts}" class="money-input" value="${s.pricePerUnit}" placeholder="Price per unit"></div>
                <div class="form-group" data-label="Payment"><select id="salePay_${ts}"><option ${s.payment === 'Cash' ? 'selected' : ''}>Cash</option><option ${s.payment === 'Card' ? 'selected' : ''}>Card</option><option ${s.payment === 'Mobile Money' ? 'selected' : ''}>Mobile Money</option><option ${s.payment === 'Bank Transfer' ? 'selected' : ''}>Bank Transfer</option></select></div>
            `;
            openInlineEditModal('Edit Sale', body, `saveSaleInlineEditFromModal(${ts})`);
        }

        function openTransactionInlineEditModal(ts){
            const t = state.transactions.find(x => x.timestamp === ts);
            if (!t) return showToast('Transaction not found', 'error');
            const body = `
                <div class="form-group" data-label="Customer"><input type="text" id="txnCustomer_${ts}" value="${escapeHTML(t.customerName || '')}" placeholder="Customer"></div>
                <div class="form-group" data-label="Type"><select id="txnType_${ts}"><option value="deposit" ${t.type === 'deposit' ? 'selected' : ''}>Deposit</option><option value="withdrawal" ${t.type === 'withdrawal' ? 'selected' : ''}>Withdrawal</option></select></div>
                <div class="form-group" data-label="Amount"><input type="text" id="txnAmount_${ts}" class="money-input" value="${t.amount}" placeholder="Amount"></div>
            `;
            openInlineEditModal('Edit Transaction', body, `saveTransactionInlineEditFromModal(${ts})`);
        }

        function openProductInlineEditModal(i){
            const p = state.products[i];
            if (!p) return showToast('Item not found', 'error');
            const inv = state.inventory[p.name] || { stock: 0, minAlert: 5 };
            const body = `
                <div class="form-group" data-label="Name"><input type="text" id="prodName_${i}" value="${escapeHTML(p.name || '')}" placeholder="Name"></div>
                <div class="form-group" data-label="Category">
                    <select id="prodCategory_${i}" onchange="toggleInlineProductCategory(${i})">
                        <option value="new">+ Add New Category</option>
                        ${(state.categories || []).map(c => `<option value="${escapeHTML(c)}" ${p.category === c ? 'selected' : ''}>${escapeHTML(c)}</option>`).join('')}
                    </select>
                    <input type="text" id="newProdCategory_${i}" style="display:none; margin-top:5px;" placeholder="New Category Name">
                </div>
                <div class="form-group" data-label="Cost"><input type="text" class="money-input" id="prodCost_${i}" value="${p.cost || 0}" placeholder="Cost"></div>
                <div class="form-group" data-label="Price"><input type="text" class="money-input" id="prodPrice_${i}" value="${p.price || 0}" placeholder="Price"></div>
                <div class="form-group"><input type="text" id="prodSaleUnit_${i}" value="${escapeHTML(p.saleUnit || '')}" placeholder="Sale Unit (e.g., piece)"></div>
                <div class="form-group"><input type="text" id="prodPurchaseUnit_${i}" value="${escapeHTML(p.purchaseUnit || '')}" placeholder="Purchase Unit (e.g., carton)"></div>
                <div class="form-group"><input type="text" class="money-input" id="prodUnitsPer_${i}" value="${(p.unitsPerPurchase!=null)?p.unitsPerPurchase:''}" placeholder="Units per Purchase (e.g., 24)"></div>
                <div class="form-group" data-label="Stock" style="${p.hasStock === false ? 'display:none;' : ''}"><input type="text" class="money-input" id="prodStock_${i}" value="${inv.stock || 0}" placeholder="Stock"></div>
                <div class="form-group" data-label="Min Alert" style="${p.hasStock === false ? 'display:none;' : ''}"><input type="text" class="money-input" id="prodMinAlert_${i}" value="${inv.minAlert || 5}" placeholder="Min Alert"></div>
                <div class="form-group"><select id="prodHasStock_${i}"><option value="yes" ${p.hasStock !== false ? 'selected' : ''}>Product (has stock)</option><option value="no" ${p.hasStock === false ? 'selected' : ''}>Service (no stock)</option></select></div>
            `;
            openInlineEditModal('Edit Product/Service', body, `saveProductInlineEditFromModal(${i})`);
            setTimeout(() => { try { toggleInlineProductCategory(i); } catch {} }, 0);
        }

        function openExpenseInlineEditModal(ts){
            const e = (state.expenses || []).find(x => x.timestamp === ts);
            if (!e) return showToast('Expense not found', 'error');
            const body = `
                <div class="form-group" data-label="Description"><input type="text" id="expDesc_${ts}" value="${escapeHTML(e.description || '')}" placeholder="Description"></div>
                <div class="form-group" data-label="Amount"><input type="text" id="expAmt_${ts}" class="money-input" value="${e.amount}" placeholder="Amount"></div>
                <div class="form-group" data-label="Payment"><select id="expPay_${ts}"><option ${e.payment === 'Cash' ? 'selected' : ''}>Cash</option><option ${e.payment === 'Card' ? 'selected' : ''}>Card</option><option ${e.payment === 'Mobile Money' ? 'selected' : ''}>Mobile Money</option><option ${e.payment === 'Bank Transfer' ? 'selected' : ''}>Bank Transfer</option></select></div>
                <div class="form-group" data-label="Comment"><input type="text" id="expComment_${ts}" value="${escapeHTML(e.comment || '')}" placeholder="Comment"></div>
            `;
            openInlineEditModal('Edit Expense', body, `saveExpenseInlineEditFromModal(${ts})`);
        }

        function openIncomeInlineEditModal(i){
            const it = (state.income || [])[i];
            if (!it) return showToast('Income not found', 'error');
            const ts = it.timestamp;
            const body = `
                <div class="form-group" data-label="Source"><input type="text" id="incSource_${ts}" value="${escapeHTML(it.source || '')}" placeholder="Source"></div>
                <div class="form-group" data-label="Amount"><input type="text" id="incAmt_${ts}" class="money-input" value="${it.amount}" placeholder="Amount"></div>
                <div class="form-group" data-label="Payment"><select id="incPay_${ts}"><option ${it.payment === 'Cash' ? 'selected' : ''}>Cash</option><option ${it.payment === 'Card' ? 'selected' : ''}>Card</option><option ${it.payment === 'Mobile Money' ? 'selected' : ''}>Mobile Money</option><option ${it.payment === 'Bank Transfer' ? 'selected' : ''}>Bank Transfer</option></select></div>
                <div class="form-group" data-label="Comment"><input type="text" id="incComment_${ts}" value="${escapeHTML(it.comment || '')}" placeholder="Comment"></div>
            `;
            openInlineEditModal('Edit Income', body, `saveIncomeInlineEditFromModal(${i})`);
        }

        function openCustomerInlineEditModal(i){
            const c = state.customers[i];
            if (!c) return showToast('Customer not found', 'error');
            const body = `
                <div class="form-group" data-label="Name"><input type="text" id="custName_${i}" value="${escapeHTML(c.name || '')}" placeholder="Name"></div>
                <div class="form-group" data-label="Email"><input type="email" id="custEmail_${i}" value="${escapeHTML(c.email || '')}" placeholder="email@example.com"></div>
                <div class="form-group" data-label="Phone"><input type="tel" id="custPhone_${i}" value="${escapeHTML(c.phone || '')}" placeholder="+255..."></div>
                <div class="form-group" data-label="Address"><input type="text" id="custAddress_${i}" value="${escapeHTML(c.address || '')}" placeholder="Address"></div>
            `;
            openInlineEditModal('Edit Customer', body, `saveCustomerInlineEditFromModal(${i})`);
        }

        function openCategoryInlineEditModal(i){
            const cat = state.categories[i];
            if (!cat) return showToast('Category not found', 'error');
            const body = `
                <div class="form-group" data-label="Category"><input type="text" id="catName_${i}" value="${escapeHTML(cat)}" placeholder="Category" style="padding:6px;border:1px solid #ddd;border-radius:6px;"></div>
                <div class="form-group"><select id="catKind_${i}"><option value="product" ${getCategoryKind(cat)==='service'?'':'selected'}>Product (has stock)</option><option value="service" ${getCategoryKind(cat)==='service'?'selected':''}>Service (no stock)</option></select></div>
            `;
            openInlineEditModal('Edit Category', body, `saveCategoryInlineEditFromModal(${i})`);
        }

        function openAssetInlineEditModal(ts){
            const a = (state.assets || []).find(x => x.timestamp === ts);
            if (!a) return showToast('Asset not found', 'error');
            const body = `
                <div class="form-group" data-label="Asset Name"><input type="text" id="assetName_${ts}" value="${escapeHTML(a.name || '')}" placeholder="Asset name" style="width:100%"></div>
                <div class="form-group" data-label="Purchase Date"><input type="date" id="assetDate_${ts}" value="${escapeHTML(a.purchaseDate || '')}" style="width:100%"></div>
                <div class="form-group" data-label="Cost"><input type="text" id="assetCost_${ts}" class="money-input" value="${String(a.cost || 0)}" placeholder="0.00" style="width:100%"></div>
                <div class="form-group" data-label="Money Source"><select id="assetSrc_${ts}" style="width:100%">
                    <option value="business" ${String(a.moneySource||'business')==='business'?'selected':''}>Business Capital</option>
                    <option value="personal" ${String(a.moneySource||'')==='personal'?'selected':''}>Personal</option>
                    <option value="loan" ${String(a.moneySource||'')==='loan'?'selected':''}>Loan</option>
                    <option value="gift" ${String(a.moneySource||'')==='gift'?'selected':''}>Gift/Reward</option>
                    <option value="other" ${String(a.moneySource||'')==='other'?'selected':''}>Other</option>
                </select></div>
                <div class="form-group" data-label="Description"><textarea id="assetDesc_${ts}" rows="2" style="width:100%">${escapeHTML(a.description || '')}</textarea></div>
            `;
            openInlineEditModal('Edit Asset', body, `saveAssetInlineEditFromModal(${ts})`);
        }

        function openMaintenanceInlineEditModal(ts){
            const m = (state.maintenance || []).find(x => x.timestamp === ts);
            if (!m) return showToast('Maintenance not found', 'error');
            const assets = state.assets || [];
            const optionsInline = assets.length
                ? `<option value="">Select Asset</option>` + assets.map(a => `<option value="${escapeHTML(a.name)}" ${a.name === m.assetName ? 'selected' : ''}>${escapeHTML(a.name)}</option>`).join('')
                : `<option value="">No assets available</option>`;
            const body = `
                <div class="form-group" data-label="Asset"><select id="maintAsset_${ts}" style="width:100%">${optionsInline}</select></div>
                <div class="form-group" data-label="Date"><input type="date" id="maintDate_${ts}" value="${escapeHTML(m.date || '')}" style="width:100%"></div>
                <div class="form-group" data-label="Amount"><input type="text" id="maintAmt_${ts}" class="money-input" value="${String(m.amount || 0)}" placeholder="0.00" style="width:100%"></div>
                <div class="form-group" data-label="Money Source"><select id="maintSrc_${ts}" style="width:100%">
                    <option value="business" ${String(m.moneySource||'business')==='business'?'selected':''}>Business Capital</option>
                    <option value="personal" ${String(m.moneySource||'')==='personal'?'selected':''}>Personal</option>
                    <option value="loan" ${String(m.moneySource||'')==='loan'?'selected':''}>Loan</option>
                    <option value="other" ${String(m.moneySource||'')==='other'?'selected':''}>Other</option>
                </select></div>
                <div class="form-group" data-label="Description"><textarea id="maintDesc_${ts}" rows="2" style="width:100%">${escapeHTML(m.description || '')}</textarea></div>
            `;
            openInlineEditModal('Edit Maintenance', body, `saveMaintenanceInlineEditFromModal(${ts})`);
        }

        async function saveSaleInlineEditFromModal(ts){
            const ok = await saveSaleInlineEdit(ts);
            if (ok) closeInlineEditModal();
        }

        async function saveTransactionInlineEditFromModal(ts){
            const ok = await saveTransactionInlineEdit(ts);
            if (ok) closeInlineEditModal();
        }

        async function saveProductInlineEditFromModal(i){
            const ok = await saveProductInlineEdit(i);
            if (ok) closeInlineEditModal();
        }

        async function saveExpenseInlineEditFromModal(ts){
            const ok = await saveExpenseInlineEdit(ts);
            if (ok) closeInlineEditModal();
        }

        async function saveIncomeInlineEditFromModal(i){
            const ok = await saveIncomeInlineEdit(i);
            if (ok) closeInlineEditModal();
        }

        async function saveCustomerInlineEditFromModal(i){
            const ok = await saveCustomerInlineEdit(i);
            if (ok) closeInlineEditModal();
        }

        async function saveCategoryInlineEditFromModal(i){
            const ok = await saveCategoryInlineEdit(i);
            if (ok) closeInlineEditModal();
        }

        async function saveAssetInlineEditFromModal(ts){
            const ok = await saveAssetInlineEdit(ts);
            if (ok) closeInlineEditModal();
        }

        async function saveMaintenanceInlineEditFromModal(ts){
            const ok = await saveMaintenanceInlineEdit(ts);
            if (ok) closeInlineEditModal();
        }

        async function toggleSaleInlineEdit(ts) {
            openSaleInlineEditModal(ts);
        }
        async function saveSaleInlineEdit(ts) {
            const idx = state.sales.findIndex(s => s.timestamp === ts);
            if (idx === -1) { showToast('Sale not found', 'error'); return false; }
            const s = state.sales[idx];
            const qty = parseMoney(document.getElementById(`saleQty_${ts}`)?.value || s.quantity);
            const price = parseMoney(document.getElementById(`salePrice_${ts}`)?.value || s.pricePerUnit);
            const pay = document.getElementById(`salePay_${ts}`)?.value || s.payment;
            if (isNaN(qty) || qty < 1 || isNaN(price) || price < 0) { showToast('Invalid values', 'error'); return false; }
            s.quantity = qty;
            s.pricePerUnit = price;
            s.totalPrice = +(price * qty).toFixed(2);
            s.totalCost = (s.costPerUnit || 0) * qty;
            s.profit = +(s.totalPrice - s.totalCost).toFixed(2);
            s.payment = pay;
            saveData();
            state.inlineEditSales[ts] = false;
            render();
            showToast('Sale updated', 'success');
            if (syncEnabled) { try { await upsertOne('sales', { date: s.date, time: s.time, timestamp: s.timestamp, product_name: s.productName, quantity: s.quantity, cost_per_unit: s.costPerUnit, price_per_unit: s.pricePerUnit, total_cost: s.totalCost, total_price: s.totalPrice, profit: s.profit, payment: s.payment, customer: s.customer }); } catch { } syncInBackground(); }
            try {
                const m = document.getElementById('saleDetailModal');
                if (m && m.classList.contains('show')) { renderSaleDetail(ts); }
            } catch {}
            return true;
        }

        function markPaidSale(ts) {
            const idx = (state.sales || []).findIndex(s => Number(s.timestamp) === Number(ts));
            if (idx === -1) return showToast('Sale not found', 'error');
            const s = state.sales[idx];
            s.status = 'paid';
            saveData();
            render();
            showToast('Marked as paid', 'success');
            closeUnpaidSalesModal();
            if (syncEnabled) { try { upsertOne('sales', { date: s.date, time: s.time, timestamp: s.timestamp, product_name: s.productName, customer: s.customer, quantity: s.quantity, cost_per_unit: s.costPerUnit, price_per_unit: s.pricePerUnit, total_cost: s.totalCost, total_price: s.totalPrice, profit: s.profit, payment: s.payment, status: s.status }); } catch { } }
            refreshGlobalSearchIfOpen();
            try {
                const m = document.getElementById('saleDetailModal');
                if (m && m.classList.contains('show')) { renderSaleDetail(ts); }
            } catch {}
        }

        async function deleteSaleByTimestamp(ts) {
            try { playDeleteSound(); } catch (e) { }
            const ok = await requirePinForDestructive('delete');
            if (!ok) { showToast('Delete failed: PIN required', 'error'); return; }
            
            const idx = state.sales.findIndex(s => s.timestamp === ts);
            if (idx === -1) return showToast("Sale not found", "error");
            const sale = state.sales[idx];

            // Return stock to inventory only if product tracks stock
            const productForSale = state.products.find(p => p.name === sale.productName);
            if (productForSale && productForSale.hasStock !== false && state.inventory[sale.productName]) {
                state.inventory[sale.productName].stock += sale.quantity;
            }

            if (sale) {
                try {
                    if (navigator.onLine && syncEnabled && currentUser) {
                        await deleteOne('sales', { timestamp: sale.timestamp });
                    } else {
                        await deleteOne('sales', { timestamp: sale.timestamp });
                    }
                } catch { }
            }
            saveData();
            render();
            showToast("Sale deleted", "success", "Undo", function(){ try { state.sales.push(sale); const p=state.products.find(p=>p.name===sale.productName); if (p && p.hasStock!==false && state.inventory[sale.productName]) { state.inventory[sale.productName].stock = Math.max(0,(state.inventory[sale.productName].stock||0)-sale.quantity); } saveData(); render(); } catch {} });
            try { closeUnpaidSalesModal(); } catch { }

            // Sync in background
             if (syncEnabled) syncInBackground();
         }

        function toggleCustomerInput() {
            const select = document.getElementById('saleCustomer');
            const fields = document.getElementById('newCustomerFields');
            if (select && fields) {
                try { state.currentSaleCustomerIndex = select.value || ''; saveData(); } catch {}
                if (select.value === 'new') {
                    fields.style.display = 'block';
                    try {
                        const nameEl = document.getElementById('newCustomerName');
                        const phoneEl = document.getElementById('newCustomerPhone');
                        if (nameEl) nameEl.value = (state.saleNewCustomerForm && state.saleNewCustomerForm.name) || '';
                        if (phoneEl) phoneEl.value = (state.saleNewCustomerForm && state.saleNewCustomerForm.phone) || '';
                    } catch {}
                } else {
                    fields.style.display = 'none';
                }
            }
        }

        function clearSaleForm() {
            try { state.currentSaleProductIndex = ''; } catch {}
            try { state.currentSaleCustomerIndex = ''; } catch {}
            try { state.saleNewProductForm = {}; } catch {}
            try { state.saleNewCustomerForm = {}; } catch {}
            try { state.saleNewProductType = 'product'; } catch {}
            try { saveData(); } catch {}
            try {
                const sp = document.getElementById('saleProduct'); if (sp) { sp.value = ''; try { sp.dispatchEvent(new Event('change', { bubbles: true })); } catch {} }
                const nf = document.getElementById('newProductFields'); if (nf) nf.style.display = 'none';
                const sc = document.getElementById('saleCustomer'); if (sc) { sc.value = ''; try { sc.dispatchEvent(new Event('change', { bubbles: true })); } catch {} try { updateSearchableDropdownDisplay(sc); } catch {} }
                const ncf = document.getElementById('newCustomerFields'); if (ncf) ncf.style.display = 'none';
                const sq = document.getElementById('saleQuantity'); if (sq) { sq.value = '1'; try { sq.dispatchEvent(new Event('change')); } catch {} }
                const pm = document.getElementById('salePayment'); if (pm) pm.value = 'Cash';
                const st = document.getElementById('saleStatus'); if (st) st.value = 'paid';
                const info = document.getElementById('saleInfo'); if (info) { info.innerHTML = ''; info.style.display = 'none'; }
                const clearBtn = document.getElementById('saleFormClearBtn'); if (clearBtn) clearBtn.style.display = 'none';
            } catch {}
        }

        function updateSaleTotal() {
            const productIndex = document.getElementById('saleProduct')?.value;
            let quantity = parseMoney(document.getElementById('saleQuantity')?.value) || 1;
            if (quantity < 1) { showToast('Quantity must be at least 1', 'error'); return; }
            const infoDiv = document.getElementById('saleInfo');
            if (!infoDiv) return;
            if (!productIndex && productIndex !== '0') { try { infoDiv.innerHTML = ''; infoDiv.style.display = 'none'; } catch {} return; }
            const product = state.products[productIndex];
            if (!product) { infoDiv.innerHTML = ''; return; }

            const isService = product.hasStock === false;
            let availableStock = null;
            if (!isService) {
                const inventoryItem = state.inventory[product.name] || { stock: 0, minAlert: 5 };
                availableStock = inventoryItem.stock;
                if (quantity > availableStock) {
                    infoDiv.innerHTML = `
                        <div class="alert-box-danger">
                            <strong>⚠️ Insufficient Stock!</strong><br>
                            Available: ${availableStock} units<br>
                            Requested: ${quantity} units
                        </div>
                    `;
                    return;
                }
            }

            const cogsMethod = String(state.cogsMethod || 'product_cost');
            const avgCost = computeAveragePurchaseCost(product.name);
            const fifoCost = computeFifoUnitCost(product.name, Date.now(), quantity);
            let unitCost = (product.cost || 0);
            if (cogsMethod === 'avg_purchase_cost' && avgCost > 0) unitCost = avgCost;
            if (cogsMethod === 'fifo' && fifoCost > 0) unitCost = fifoCost;
            const totalCost = unitCost * quantity;
            const totalPrice = product.price * quantity;
            try { infoDiv.style.display = ''; } catch {}
            infoDiv.innerHTML = `
                <div class="info-box">
                    <div class="info-row"><span>Cost/unit:</span><span> ${formatNumber(unitCost)} ${getCurrencySymbol()}</span></div>
                    <div class="info-row"><span>Price/unit:</span>
                        <input type="text" id="manualPrice" class="money-input" value="${formatMoney(product.price)}" style="width:120px;text-align:right;padding:6px;border-radius:6px;border:1px solid #ddd;">
                    </div>
                    ${isService ? `<div class=\"info-row\"><span>Item Type:</span><span>Service (no stock)</span></div>` : `<div class=\"info-row\"><span>Available Stock:</span><span>${availableStock} units</span></div>`}
                    <div class="info-row" style="font-weight:700;"><span>Total Cost:</span><span id="totalCost"> ${formatNumber(totalCost)} ${getCurrencySymbol()}</span></div>
                    <div class="info-row" style="font-weight:700;"><span>Total Price:</span><span id="totalPrice"> ${formatNumber(product.price * quantity)} ${getCurrencySymbol()}</span></div>
                    <div class="info-row" style="font-weight:700; color: #2e7d32;"><span>Profit:</span><span id="totalProfit"> ${formatNumber((product.price - unitCost) * quantity)} ${getCurrencySymbol()}</span></div>
                </div>
            `;
            const manualEl = document.getElementById('manualPrice');
            const now = new Date();
            const dateStr = getTodayDateString();
            const timeStr = now.toLocaleTimeString();
            const custSel = document.getElementById('saleCustomer')?.value;
            let custName = 'WALK IN';
            if (custSel === 'new') {
                const nm = (document.getElementById('newCustomerName')?.value || '').trim();
                if (nm) custName = nm;
            } else if (custSel) {
                const c = state.customers[custSel];
                custName = (c && c.name) ? c.name : 'WALK IN';
            }
            const payMethod = document.getElementById('salePayment')?.value || 'Cash';
            const unitPriceForPreview = manualEl ? (parseMoney(manualEl.value) || product.price) : product.price;
            const previewHTML = `<div class="item-subtitle" id="salePreview">${dateStr} ${timeStr}<br>${custName} | Qty: ${quantity} | ${payMethod}<br>Cost: ${formatNumber(unitCost * quantity)} | Price: ${formatNumber(unitPriceForPreview * quantity)}</div><div class="flex-gap" style="margin-top:8px;"><button class="btn-small" type="button" onclick="copyCurrentSaleEntry()">📋 Copy</button></div>`;
            infoDiv.innerHTML += previewHTML;
            const manual = document.getElementById('manualPrice');
            manual && manual.addEventListener('input', function () {
                const p = parseMoney(this.value) || 0;
                const totalPriceEl = document.getElementById('totalPrice');
                const totalProfitEl = document.getElementById('totalProfit');
                if (totalPriceEl) totalPriceEl.textContent = ` ${formatNumber(p * quantity)} ${getCurrencySymbol()}`;
                if (totalProfitEl) totalProfitEl.textContent = ` ${formatNumber((p - unitCost) * quantity)} ${getCurrencySymbol()}`;
                const previewEl = document.getElementById('salePreview');
                if (previewEl) {
                    const pm = document.getElementById('salePayment')?.value || 'Cash';
                    const cs = document.getElementById('saleCustomer')?.value;
                    let cn = 'WALK IN';
                    if (cs === 'new') {
                        const nm2 = (document.getElementById('newCustomerName')?.value || '').trim();
                        if (nm2) cn = nm2;
                    } else if (cs) {
                        const cc = state.customers[cs];
                        cn = (cc && cc.name) ? cc.name : 'WALK IN';
                    }
                    const now2 = new Date();
                    previewEl.innerHTML = `${getTodayDateString()} ${now2.toLocaleTimeString()}<br>${cn} | Qty: ${quantity} | ${pm}<br>Cost: ${formatNumber(unitCost * quantity)} | Price: ${formatNumber(p * quantity)}`;
                }
            });
            try { state.currentSaleProductIndex = document.getElementById('saleProduct')?.value; saveData(); } catch {}
        }

        async function addSale(e) {
            e && e.preventDefault && e.preventDefault();
            playTapSound();
            hapticShort();
            const productIndex = document.getElementById('saleProduct')?.value;
            if (productIndex === null || productIndex === '' || productIndex === undefined) return showToast('Please select a product', 'error');
            const product = state.products[productIndex];
            if (!product) return showToast('Product not found', 'error');
            const isService = product.hasStock === false;

            const customerSelect = document.getElementById('saleCustomer')?.value;
            let customer;

            if (customerSelect === 'new') {
                const newName = document.getElementById('newCustomerName')?.value.trim();
                if (!newName) return showToast('Please enter customer name', 'error');
                const newPhone = document.getElementById('newCustomerPhone')?.value.trim();
                customer = { name: newName, email: '', phone: newPhone, address: '', totalPurchases: 0 };
                state.customers.push(customer);
            } else if (customerSelect) {
                customer = state.customers[customerSelect];
            } else {
                customer = { name: 'WALK IN' };
            }

            const quantity = parseMoney(document.getElementById('saleQuantity')?.value) || 1;
            const payment = document.getElementById('salePayment')?.value || 'Cash';
            const status = document.getElementById('saleStatus')?.value || 'paid';
            const manualPriceInput = document.getElementById('manualPrice');
            const pricePerUnit = manualPriceInput ? (parseMoney(manualPriceInput.value) || product.price) : product.price;
            if (pricePerUnit < 0) return showToast('Price cannot be negative', 'error');

            // Check stock only for stock-tracked products
            if (!isService) {
                const inventoryItem = state.inventory[product.name] || { stock: 0, minAlert: 5 };
                if (quantity > inventoryItem.stock) {
                    return showToast(`Insufficient stock! Available: ${inventoryItem.stock}`, 'error');
                }
            }

            const now = new Date();
            const cogsMethod = String(state.cogsMethod || 'product_cost');
            const avgCost = computeAveragePurchaseCost(product.name);
            const fifoCost = computeFifoUnitCost(product.name, Date.now(), quantity);
            const costPerUnit = (cogsMethod === 'fifo' && fifoCost > 0) ? fifoCost : ((cogsMethod === 'avg_purchase_cost' && avgCost > 0) ? avgCost : (product.cost || 0));
            const totalCost = costPerUnit * quantity;
            const totalPrice = +(pricePerUnit * quantity).toFixed(2);
            const sale = {
                id: generateID('sales'),
                date: getTodayDateString(),
                time: now.toLocaleTimeString(),
                timestamp: Date.now(),
                productName: product.name,
                customer: customer ? customer.name : 'WALK IN',
                quantity,
                costPerUnit: costPerUnit,
                pricePerUnit,
                totalCost,
                totalPrice,
                profit: +(totalPrice - totalCost).toFixed(2),
                payment,
                status,
                category: product.category || '',
                hasStock: product.hasStock !== false
            };
            state.sales = state.sales || [];
            state.sales.push(sale);

            // Update customer total purchases
            if (customer && customer.name !== 'WALK IN') {
                const custIndex = state.customers.findIndex(c => c.name === customer.name);
                if (custIndex !== -1) {
                    state.customers[custIndex].totalPurchases = (state.customers[custIndex].totalPurchases || 0) + totalPrice;
                }
            }

            // Update inventory only if product tracks stock
            if (!isService && state.inventory && state.inventory[product.name]) {
                state.inventory[product.name].stock = Math.max(0, (state.inventory[product.name].stock || 0) - quantity);
            }

            saveData();
            render();
            showToast("Sale recorded successfully!", "success");

            // Friendly reminder to save a local backup (max 3 per day)
            maybeShowBackupReminder();

            try { state.currentSaleProductIndex = ''; state.currentSaleCustomerIndex = ''; saveData(); } catch {}
            setTimeout(() => {
                try {
                    const sp = document.getElementById('saleProduct'); if (sp) { sp.value = ''; try { sp.dispatchEvent(new Event('change', { bubbles: true })); } catch {} }
                    const nf = document.getElementById('newProductFields'); if (nf) nf.style.display = 'none';
                    const sc = document.getElementById('saleCustomer'); if (sc) { sc.value = ''; try { sc.dispatchEvent(new Event('change', { bubbles: true })); } catch {} try { updateSearchableDropdownDisplay(sc); } catch {} }
                    const ncf = document.getElementById('newCustomerFields'); if (ncf) ncf.style.display = 'none';
                    const sq = document.getElementById('saleQuantity'); if (sq) { sq.value = '1'; try { sq.dispatchEvent(new Event('change')); } catch {} }
                    const pm = document.getElementById('salePayment'); if (pm) pm.value = 'Cash';
                    const st = document.getElementById('saleStatus'); if (st) st.value = 'paid';
                    const info = document.getElementById('saleInfo'); if (info) { info.innerHTML = ''; info.style.display = 'none'; }
                    const clearBtn = document.getElementById('saleFormClearBtn'); if (clearBtn) clearBtn.style.display = 'none';
                } catch {}
            }, 50);

            try {
                document.querySelectorAll('.save-offline-btn').forEach(btn => {
                    btn.classList.add('attention');
                    setTimeout(() => { try { btn.classList.remove('attention'); } catch (e) { } }, 2000);
                });
            } catch (e) { }

            if (syncEnabled) {
                await upsertOne('sales', {
                    date: sale.date,
                    time: sale.time,
                    timestamp: sale.timestamp,
                    product_name: sale.productName,
                    customer: sale.customer,
                    quantity: sale.quantity,
                    cost_per_unit: sale.costPerUnit,
                    price_per_unit: sale.pricePerUnit,
                    total_cost: sale.totalCost,
                    total_price: sale.totalPrice,
                    profit: sale.profit,
                    payment: sale.payment,
                    status: sale.status,
                    category: sale.category || '',
                    has_stock: sale.hasStock
                });
                if (customer && customer.name !== 'WALK IN') {
                    const cust = state.customers.find(c => c.name === customer.name) || customer;
                    await upsertOne('customers', {
                        name: cust.name,
                        email: cust.email || '',
                        phone: cust.phone || '',
                        address: cust.address || '',
                        total_purchases: cust.totalPurchases || 0
                    });
                }
                if (product && product.hasStock !== false) {
                    const inv = state.inventory[product.name] || { stock: 0, minAlert: 5 };
                    await upsertOne('inventory', { product_name: product.name, stock: inv.stock || 0, min_alert: inv.minAlert || 5 });
                }
                syncInBackground();
            }
            try { syncInBackground(); } catch { }
        }

        function handleSaleEnter(e) {
            try {
                if (e && e.key === 'Enter') {
                    e.preventDefault();
                    const sel = document.getElementById('saleProduct');
                    const v = sel ? sel.value : '';
                    if (v && v !== '' && v !== 'new') { addSale(e); }
                }
            } catch { }
        }

        function renderTransactions() {
            const channels = [
                { id: 'mpesa', label: 'M-Pesa' },
                { id: 'crdb', label: 'CRDB' },
                { id: 'nmb', label: 'NMB' },
                { id: 'airtel', label: 'Airtel Money' },
                { id: 'halopesa', label: 'Halopesa' },
                { id: 'yas', label: 'Yas Tanzania' }
            ];
            const currentChannel = state.activeTransactionChannel || 'mpesa';
            const channelTransactions = (state.transactions || []).filter(t => t.channel === currentChannel).filter(t => !(t && t.deleted === true));

            const floatData = state.transactionFloats[currentChannel];
            const accountDiff = (floatData.currentAccount || 0) - (floatData.initialAccount || 0);
            const cashDiff = (floatData.currentCash || 0) - (floatData.initialCash || 0);

            return `
                <div class="transaction-tabs">
                    ${channels.map(ch => `
                        <button class="transaction-tab ${ch.id} ${currentChannel === ch.id ? 'active' : ''}" 
                             onclick="switchTransactionChannel('${ch.id}')">
                            ${ch.label}
                        </button>
                    `).join('')}
                </div>

                <div class="flex-gap" style="margin:8px 0;">
                    <button class="btn-small" onclick="openCommissionModal()">➕ Add Commission</button>
                    <div style="width:40px;height:1px;background:rgba(0,0,0,0.12);"></div>
                    <button class="btn-small" onclick="openCommissionHistoryModal()">📜 Commission History</button>
                </div>

                <div class="float-balance-container">
                    <h3 style="margin-bottom: 12px; color: #0d47a1; font-size: 16px;"> Float Balance</h3>
                    <div class="float-balance-row">
                        <span class="float-balance-label">Initial Account Float:</span>
                        <span class="editable-float" onclick="editInitialAccountFloat('${currentChannel}')">
                             ${formatNumber(floatData.initialAccount || 0)} Tsh
                        </span>
                    </div>
                    <div class="float-balance-row">
                        <span class="float-balance-label">Initial Cash Float:</span>
                        <span class="editable-float" onclick="editInitialCashFloat('${currentChannel}')">
                             ${formatNumber(floatData.initialCash || 0)} Tsh
                        </span>
                    </div>
                    <div class="float-balance-row">
                        <span class="float-balance-label">Current Account Balance:</span>
                        <span class="float-balance-value ${accountDiff >= 0 ? 'positive' : 'negative'}">
                             ${formatNumber(floatData.currentAccount || 0)} Tsh
                        </span>
                    </div>
                    <div class="float-balance-row">
                        <span class="float-balance-label">Current Cash Balance:</span>
                        <span class="float-balance-value ${cashDiff >= 0 ? 'positive' : 'negative'}">
                             ${formatNumber(floatData.currentCash || 0)} Tsh
                        </span>
                    </div>
                </div>

                </div>

        <div class="card">
            <h2>${channels.find(c => c.id === currentChannel).label} Transactions (${channelTransactions.length})</h2>
            <div class="card-header-buttons"><button class="btn-small" onclick="copyAllTransactions()">📋 Copy All</button></div>
            
            <div class="search-box">
                <input type="search" name="search_field_unique_${Date.now()}" autocomplete="off" placeholder="🔍 Search transactions..." 
                       oninput="searchTransactions(this.value)" 
                       id="transactionSearch" readonly onfocus="this.removeAttribute('readonly');">
            </div>
                <div class="card">
                    <h2>Add ${channels.find(c => c.id === currentChannel).label} Transaction</h2>
                    <form onsubmit="addTransaction(event)">
                        <div class="form-group">
                            <label>Customer Name (Optional)</label>
                            <input type="text" id="transactionCustomer" placeholder="Enter customer name">
                        </div>
                        <div class="form-group">
                            <label>Transaction Type</label>
                            <select id="transactionType" required>
                                <option value="deposit">Deposit (+)</option>
                                <option value="withdrawal">Withdrawal (-)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Amount</label>
                            <input type="text" id="transactionAmount" class="money-input" placeholder="0" required>
                        </div>
                        <button type="submit">Save Transaction</button>
                    </form>
                </div>

                <div class="card">
                    <h2>${channels.find(c => c.id === currentChannel).label} Transactions (${channelTransactions.length})</h2>
                    <div class="card-header-buttons"><button class="btn-small" onclick="copyAllTransactions()">📋 Copy All</button></div>
                    
                    ${(() => {
                    const bulk = `
                        <div class="bulk-actions">
                            <input type="checkbox" id="selectAll_transactions" onchange="toggleSelectAll('transactions')" class="checkbox-select">
                            <label for="selectAll_transactions">Select All</label>
                            <span style="color: #666; font-size: 12px; margin-left: 8px;">${getSelectedCount('transactions')} selected</span>
                            <button class="btn-small btn-danger" onclick="bulkDelete('transactions')" ${!hasSelected('transactions') ? 'disabled' : ''}>🗑️ Delete Selected</button>
                            <button class="btn-small btn-tag" onclick="bulkApplyTag('transactions')" ${!hasSelected('transactions') ? 'disabled' : ''} title="📌 Apply Tag">📌 Apply Tag</button>
                        </div>`;
                    const list = `<div id="transactionsList" class="list-scroll-container">${renderTransactionsList(channelTransactions)}</div>`;
                    const total = (() => { const q = (state.transactionSearch || '').toLowerCase(); return channelTransactions.filter(t => !q || (t.customerName && t.customerName.toLowerCase().includes(q)) || t.type.toLowerCase().includes(q) || t.channel.toLowerCase().includes(q)).length; })();
                    const count = (state.listShowCount && state.listShowCount.transactions) ? state.listShowCount.transactions : 3;
                    const hasMore = count < total;
                    const moreBtn = `<div class=\"flex-gap\" style=\"justify-content:center;margin:8px 0;flex-wrap:nowrap;\">
                        <button class=\"collapse-btn\" onclick=\"${hasMore ? `showMoreList('transactions')` : `collapseList('transactions')`}\"><span class=\"collapse-icon ${hasMore ? '' : 'expanded'}\">▼</span><span>${hasMore ? 'See more' : 'Hide'}</span></button>
                        <button class=\"collapse-btn\" onclick=\"showAllList('transactions')\"><span class=\"collapse-icon\">▼</span><span>Show all</span></button>
                    </div>`;
                    return bulk + list + moreBtn;
                })()}
                </div>
            `;
        }

        function renderTransactionsList(transactions, searchPeriod = '') {
            const q = (searchPeriod || state.transactionSearch || '').toLowerCase();
            let filtered = transactions.filter(t => !q || (t.customerName && t.customerName.toLowerCase().includes(q)) || t.type.toLowerCase().includes(q) || t.channel.toLowerCase().includes(q));
            filtered = filtered.filter(t => !(t && t.deleted === true));

            if (filtered.length === 0) {
                return '<p style="text-align: center; color: #666;">No transactions found</p>';
            }

            const count = (state.listShowCount && state.listShowCount.transactions) ? state.listShowCount.transactions : 3;
            filtered.sort((a, b) => Number(b.timestamp) - Number(a.timestamp));
            return filtered.slice(0, count).map((t, idx) => `
        <div class="item">
            <div style="display: flex; gap: 12px; align-items: start;">
                <input type="checkbox" class="checkbox-select" 
                       ${state.selectedItems.transactions && state.selectedItems.transactions[t.id] ? 'checked' : ''}
                       onchange="toggleSelect('transactions', '${t.id}')">
                <div style="flex: 1;">
                    <div class="item-header">
                        <span class="item-title">${t.customerName || 'N/A'}</span>
                        <span class="badge badge-${t.channel}">${t.type.toUpperCase()}</span>
                    </div>
                    <div class="item-subtitle">
                        ${t.date} ${t.time}<br>
                        Amount: <strong style="color: ${t.type === 'deposit' ? '#2e7d32' : '#d32f2f'};">
                            ${t.type === 'deposit' ? '+' : '-'} ${formatNumber(t.amount)} Tsh
                        </strong>
                    </div>
                    ${(() => {
                    const editing = state.inlineEditTransactions && state.inlineEditTransactions[t.timestamp]; return editing ? `
                    <div class=\"form-group\" data-label=\"Customer\"><input type=\"text\" id=\"txnCustomer_${t.timestamp}\" value=\"${t.customerName || ''}\" placeholder=\"Customer\"></div>
                    <div class=\"form-group\" data-label=\"Type\"><select id=\"txnType_${t.timestamp}\"><option value=\"deposit\" ${t.type === 'deposit' ? 'selected' : ''}>Deposit</option><option value=\"withdrawal\" ${t.type === 'withdrawal' ? 'selected' : ''}>Withdrawal</option></select></div>
                    <div class=\"form-group\" data-label=\"Amount\"><input type=\"text\" id=\"txnAmount_${t.timestamp}\" class=\"money-input\" value=\"${t.amount}\" placeholder=\"Amount\"></div>
                    <div class=\"flex-gap\" style=\"margin-top:8px;\"><button class=\"btn-small btn-success\" onclick=\"saveTransactionInlineEdit(${t.timestamp})\">Save</button><button class=\"btn-small btn-secondary\" onclick=\"toggleTransactionInlineEdit(${t.timestamp})\">Cancel</button></div>
                    ` : `
                    <div class=\"flex-gap\" style=\"margin-top:8px;\"><button class=\"btn-small\" onclick=\"toggleTransactionInlineEdit(${t.timestamp})\">Edit</button><button class=\"btn-small btn-danger btn-delete\" data-action=\"delete\" onclick=\"deleteTransactionByTimestamp(${t.timestamp})\">Delete</button><button class=\"btn-small\" onclick=\"copyTransactionByTimestamp(${t.timestamp})\">📋 Copy</button></div>
                    `;
                })()}
                </div>
            </div>
        </div>
    `).join('');
        }

        function searchTransactions(Period) {
            state.transactionSearch = Period;
            render();
        }

        async function editInitialFloat(channel) { return editInitialAccountFloat(channel); }

        async function editInitialAccountFloat(channel) {
            const f = state.transactionFloats[channel] || (state.transactionFloats[channel] = {});
            const current = f.initialAccount || 0;
            const newValue = prompt(`Set initial ACCOUNT float for ${channel.toUpperCase()}:`, current);
            if (newValue !== null) {
                const val = parseFloat(newValue);
                if (!isNaN(val) && val >= 0) {
                    f.initialAccount = val;
                    calculateFloatBalances();
                    saveData();
                    render();
                    try { backupTransactionFloats(); } catch { }
                    showToast('Account float updated', 'success');
                    if (syncEnabled) {
                        await upsertOne('transaction_floats', { channel, initial_account_float: val });
                        syncInBackground();
                    }
                } else {
                    showToast('Invalid amount', 'error');
                }
            }
        }

        async function editInitialCashFloat(channel) {
            const f = state.transactionFloats[channel] || (state.transactionFloats[channel] = {});
            const current = f.initialCash || 0;
            const newValue = prompt(`Set initial CASH float for ${channel.toUpperCase()}:`, current);
            if (newValue !== null) {
                const val = parseFloat(newValue);
                if (!isNaN(val) && val >= 0) {
                    f.initialCash = val;
                    calculateFloatBalances();
                    saveData();
                    render();
                    try { backupTransactionFloats(); } catch { }
                    showToast('Cash float updated', 'success');
                    if (syncEnabled) {
                        await upsertOne('transaction_floats', { channel, initial_cash_float: val });
                        syncInBackground();
                    }
                } else {
                    showToast('Invalid amount', 'error');
                }
            }
        }
        function switchTransactionChannel(channel) {
            state.activeTransactionChannel = channel;
            render();
        }

        async function addTransaction(e) {
            e.preventDefault();
            playTapSound();
            hapticShort();
            const now = new Date();
            const amount = parseMoney(document.getElementById('transactionAmount').value);

            if (isNaN(amount) || amount <= 0) {
                return showToast('Please enter a valid amount', 'error');
            }

            const transaction = {
                id: generateID('transactions'),
                channel: state.activeTransactionChannel,
                customerName: document.getElementById('transactionCustomer').value.trim() || 'N/A',
                type: document.getElementById('transactionType').value,
                amount: amount,
                date: getTodayDateString(),
                time: now.toLocaleTimeString(),
                timestamp: now.getTime()
            };

            state.transactions = state.transactions || [];
            state.transactions.push(transaction);

            calculateFloatBalances();
            saveData();
            try { backupTransactionFloats(); } catch { }
            render();
            showToast("Transaction recorded", "success");

            if (syncEnabled) {
                await upsertOne('transactions', {
                    channel: transaction.channel,
                    customer_name: transaction.customerName,
                    type: transaction.type,
                    amount: transaction.amount,
                    date: transaction.date,
                    time: transaction.time,
                    timestamp: transaction.timestamp
                });
                syncInBackground();
            }
        }

        async function toggleTransactionInlineEdit(ts) { openTransactionInlineEditModal(ts); }
        async function saveTransactionInlineEdit(ts) {
            const idx = state.transactions.findIndex(t => t.timestamp === ts);
            if (idx === -1) { showToast('Transaction not found', 'error'); return false; }
            const t = state.transactions[idx];
            const cust = document.getElementById(`txnCustomer_${ts}`)?.value || t.customerName;
            const type = document.getElementById(`txnType_${ts}`)?.value || t.type;
            const amt = parseMoney(document.getElementById(`txnAmount_${ts}`)?.value || t.amount);
            if (isNaN(amt) || amt <= 0) { showToast('Invalid amount', 'error'); return false; }
            t.customerName = cust.trim() || 'N/A';
            t.type = type;
            t.amount = amt;
            calculateFloatBalances();
            saveData();
            state.inlineEditTransactions[ts] = false;
            render();
            showToast('Transaction updated', 'success');
            if (syncEnabled) {
                await upsertOne('transactions', { channel: t.channel, customer_name: t.customerName, type: t.type, amount: t.amount, date: t.date, time: t.time, timestamp: t.timestamp });
                syncInBackground();
            }
            return true;
        }

        async function deleteTransactionByTimestamp(ts) {
            try { playDeleteSound(); } catch (e) { }
            const ok = await requirePinForDestructive('delete');
            if (!ok) { showToast('Delete failed: PIN required', 'error'); return; }
            
            const idx = state.transactions.findIndex(t => t.timestamp === ts);
            if (idx === -1) return showToast("Transaction not found", "error");
            const t = state.transactions[idx];
            if (t) {
                try {
                    if (navigator.onLine && syncEnabled && currentUser) {
                        await deleteOne('transactions', { timestamp: t.timestamp });
                    } else {
                        await deleteOne('transactions', { timestamp: t.timestamp });
                    }
                } catch { }
            }
            state.transactions.splice(idx, 1);
            calculateFloatBalances();
            saveData();
            render();
            showToast("Transaction deleted", "success");

            // Sync in background
            if (syncEnabled) syncInBackground();
        }

        function renderProducts() {
            const q = state.productSearch || '';
            return `
                <div class="search-box">
                    <input type="search" name="search_field_unique_${Date.now()}" autocomplete="off" placeholder="🔍 Search items..." oninput="searchProducts(this.value); toggleClearButton('productSearch', 'productClearBtn')" id="productSearch" value="${q}" readonly onfocus="this.removeAttribute('readonly');">
                    <button id="productClearBtn" class="clear-btn btn-small btn-secondary hint ${String(q || '').trim() ? 'visible' : ''}" onclick="clearProductSearch()">Clear</button>
                </div>
                <div style="margin-bottom:8px;">${renderTagChips('products')}</div>
                ${renderBulkProductsSection()}
                <div class="card">
                    <div class="flex-between">
                        <div class="flex-gap" style="align-items:center;">
                        <h2>Add Product/Service</h2>
                        <button class="btn-small" onclick="openUnifiedProductsStockImportModal()">Import Products + Stock (CSV)</button>
                        </div>
                        
                    </div>
                    <div class="flex-gap" style="justify-content:flex-end;margin-top:6px;">
                        <button class="quick-nav-btn back" onclick="switchTab('sales')">← Sales</button>
                    </div>
                    <form onsubmit="addProduct(event)">
                        <div class="form-group">
                            <label>Item Type</label>
                            <select id="productHasStock" onchange="toggleInitialStock()">
                                <option value="yes" selected>Product (has stock)</option>
                                <option value="no">Service (no stock)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Category</label>
                            <select id="productCategory" required onchange="toggleNewProductCategory()">
                                <option value="">-- Select Category --</option>
                                <option class="opt-new" value="new">+ Add New Category</option>
                                ${state.categories.slice().sort((a, b) => String(a).localeCompare(String(b))).map(c => `<option value="${c}">${c}</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-group" id="newCategoryFields" style="display:none;">
                            <label>New Category Name</label>
                            <input type="text" id="newCategoryName" placeholder="Enter new category name">
                        </div>
                        <div class="form-group">
                            <label>Sale Unit</label>
                            <input type="text" id="productSaleUnit" placeholder="Describe sale unit (e.g., piece, bottle)">
                        </div>
                        <div class="form-group">
                            <label>Purchase Unit</label>
                            <input type="text" id="productPurchaseUnit" placeholder="Describe purchase unit (e.g., carton, pack)">
                        </div>
                        <div class="form-group">
                            <label>Units per Purchase</label>
                            <input type="number" id="productUnitsPerPurchase" placeholder="Units per purchase (e.g., 24)" min="1">
                        </div>
                        <div class="form-group">
                            <label>Item Name</label>
                            <input type="text" id="productName" placeholder="Enter item name" required>
                        </div>
                        
                        <div class="form-group">
                            <label>Cost (Capital)</label>
                            <input type="text" id="productCost" class="money-input" placeholder="0" required>
                        </div>
                        <div class="form-group">
                            <label>Price (Selling)</label>
                            <input type="text" id="productPrice" class="money-input" placeholder="0" required>
                        </div>
                        <div class="form-group" id="initialStockGroup">
                            <label>Initial Stock</label>
                            <input type="text" id="productStock" class="money-input" placeholder="0" value="0">
                        </div>
                        <div class="form-group" id="productInventoryLinkGroup">
                            <label>Link to Inventory Period</label>
                            <div class="flex-gap" style="flex-wrap:wrap;align-items:end;gap:8px;">
                                <select id="productInvPeriodSelect" style="min-width:200px;">
                                    <option value="">Latest or create new</option>
                                    ${(() => {
                                        const cycles = (state.inventoryPurchaseCycles || []).slice().sort((a,b)=>Number(b.number)-Number(a.number));
                                        return cycles.map(c => `<option value="${c.number}">${c.title || ('Period ' + c.number)}</option>`).join('');
                                    })()}
                                </select>
                                <label style="font-size:12px; color:#666;">
                                    <input type="checkbox" id="productInvCreateNewPeriod"> Create New Period
                                </label>
                                <input type="text" id="productInvNewPeriodTitle" placeholder="New Period Title" style="min-width:220px;">
                            </div>
                        </div>
                        <button type="submit">Add Product</button>
                    </form>
                </div>

                <div class="card">
                    <h2>All Items (${(state.products || []).filter(p => !(p && p.deleted === true)).length})</h2>
    <div class="search-box">
        <input type="search" name="search_field_unique_${Date.now()}" autocomplete="off" placeholder="🔍 Search items..." oninput="searchProducts(this.value); toggleClearButton('productSearchBottom', 'productClearBtnBottom')" id="productSearchBottom" value="${q}" readonly onfocus="this.removeAttribute('readonly');">
        <button id="productClearBtnBottom" class="clear-btn btn-small btn-secondary hint ${String(q || '').trim() ? 'visible' : ''}" onclick="clearProductSearch()">Clear</button>
    </div>
    <div style="margin-bottom:8px;">${renderTagChips('products')}</div>
    
            ${state.products.length > 0 ? `
        <div class="bulk-actions">
            <input type="checkbox" id="selectAll_products" onchange="toggleSelectAll('products')" class="checkbox-select">
            <label for="selectAll_products">Select All</label>
            <span style="color: #666; font-size: 12px; margin-left: 8px;">
                ${getSelectedCount('products')} selected
            </span>
            <button class="btn-small btn-danger" onclick="bulkDelete('products')" ${!hasSelected('products') ? 'disabled' : ''}>
                🗑️ Delete Selected
            </button>
            <button class="btn-small btn-tag" onclick="bulkApplyTag('products')" ${!hasSelected('products') ? 'disabled' : ''} title="📌 Apply Tag">📌 Apply Tag</button>
        </div>
    ` : ''}
    
                <div id="productsList" class="list-scroll-container">${renderProductsList(q)}</div>
            ${(() => { const total = (state.products || []).filter(p => !q || p.name.toLowerCase().includes(q.toLowerCase()) || String(p.category || '').toLowerCase().includes(q.toLowerCase())).length; const count = (state.listShowCount && state.listShowCount.products) ? state.listShowCount.products : 3; const hasMore = count < total; return `<div class="flex-gap" style="justify-content:center;margin:8px 0;flex-wrap:nowrap;"><button class="collapse-btn" onclick="${hasMore ? `showMoreList('products')` : `collapseList('products')`}"><span class="collapse-icon ${hasMore ? '' : 'expanded'}">▼</span><span>${hasMore ? 'See more' : 'Hide'}</span></button><button class="collapse-btn" onclick="showAllList('products')"><span class="collapse-icon">▼</span><span>Show all</span></button></div>`; })()}
</div>
            `;
        }

        function renderBulkProductsSection() {
            state.bulkProductRows = state.bulkProductRows || [];
            const rows = state.bulkProductRows.map((r, i) => `
                <div class="bulk-row" style="display:flex; gap:8px; align-items:flex-end;">
                    <div class="form-group" style="flex:0 0 auto; min-width:auto;">
                        <label>#</label>
                        <div style="padding:6px 10px; background:#eee; border-radius:8px; font-size:12px;">${i + 1}</div>
                    </div>
                    <div class="form-group" style="flex:1;">
                        <label>Item Type</label>
                        <select onchange="updateBulkProductField('${r.id}','type',this.value)">
                            <option value="product" ${r.type === 'service' ? '' : 'selected'}>Product (has stock)</option>
                            <option value="service" ${r.type === 'service' ? 'selected' : ''}>Service (no stock)</option>
                        </select>
                    </div>
                    <div class="form-group" style="flex:2;">
                        <label>Item Name</label>
                        <input type="text" placeholder="Name" value="${r.name || ''}" oninput="updateBulkProductField('${r.id}','name',this.value)">
                    </div>
                    <div class="form-group" style="flex:0 0 120px; min-width:0;">
                        <label>Cost (Capital)</label>
                        <input type="text" class="money-input" placeholder="0" value="${r.cost || ''}" oninput="updateBulkProductField('${r.id}','cost',this.value)">
                    </div>
                    <div class="form-group" style="flex:0 0 120px; min-width:0;">
                        <label>Price (Selling)</label>
                        <input type="text" class="money-input" placeholder="0" value="${r.price || ''}" oninput="updateBulkProductField('${r.id}','price',this.value)">
                    </div>
                ${r.type === 'service' ? '' : `
                    <div class="form-group" style="flex:1;">
                        <label>Stock</label>
                        <input type="text" class="money-input" placeholder="0" value="${r.stock || ''}" oninput="updateBulkProductField('${r.id}','stock',this.value)">
                    </div>
                    <div class="form-group" style="flex:1;">
                        <label>Link to Inventory Period</label>
                        <div class="flex-gap" style="flex-wrap:wrap;align-items:end;gap:8px;">
                            <select style="min-width:180px;" onchange="updateBulkProductField('${r.id}','invPeriod',this.value)">
                                <option value="">Latest or create new</option>
                                ${(() => { const cycles = (state.inventoryPurchaseCycles || []).slice().sort((a,b)=>Number(b.number)-Number(a.number)); return cycles.map(c => `<option value="${c.number}">${c.title || ('Period ' + c.number)}</option>`).join(''); })()}
                            </select>
                            <label style="font-size:12px; color:#666;">
                                <input type="checkbox" ${r.invCreateNew ? 'checked' : ''} onchange="updateBulkProductField('${r.id}','invCreateNew',this.checked ? '1' : '')"> Create New Period
                            </label>
                            <input type="text" placeholder="New Period Title" style="min-width:200px;" value="${r.invNewPeriodTitle || ''}" oninput="updateBulkProductField('${r.id}','invNewPeriodTitle',this.value)">
                        </div>
                    </div>`}
                    <div class="form-group" style="flex:0 0 160px; min-width:0;">
                        <label>Category</label>
                        <select onchange="updateBulkProductCategorySelect('${r.id}', this.value)">
                            <option value="">-- Select Category --</option>
                            <option class="opt-new" value="new" ${r.categorySelect === 'new' ? 'selected' : ''}>+ Add New Category</option>
                            ${state.categories.slice().sort((a, b) => String(a).localeCompare(String(b))).map(c => `<option value="${c}" ${r.categorySelect === c || r.category === c ? 'selected' : ''}>${c}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group" style="flex:0 0 160px; min-width:0; ${r.categorySelect === 'new' ? '' : 'display:none;'}">
                        <label>New Category</label>
                        <input type="text" placeholder="Enter new category" value="${r.newCategoryName || ''}" oninput="updateBulkProductField('${r.id}','newCategoryName',this.value)">
                    </div>
                    <button class="btn-small btn-danger" type="button" onclick="removeBulkProductRow('${r.id}')">Remove</button>
                    <button class="btn-small" type="button" onclick="submitSingleBulkRow('${r.id}')">Submit Row</button>
                </div>
            `).join('');
            const totals = (state.bulkProductRows || []).reduce((acc, r) => {
                const c = parseFloat(r.cost || 0) || 0;
                const p = parseFloat(r.price || 0) || 0;
                acc.cost += c;
                acc.price += p;
                return acc;
            }, { cost: 0, price: 0 });
            return `
                <div class="card">
                    <h2>Bulk Add Products</h2>
                    <form onsubmit="submitBulkProducts(event)">
                        <div style="display:flex; flex-direction:column; gap:8px;">${rows}</div>
                        <div class="flex-gap" style="margin-top:4px;">
                            <span class="badge">Rows: ${(state.bulkProductRows || []).length}</span>
                            <span class="badge">Total Cost: ${formatNumber(totals.cost)} Tsh</span>
                            <span class="badge">Total Price: ${formatNumber(totals.price)} Tsh</span>
                        </div>
                        <div class="flex-gap" style="margin-top:8px;">
                            <input type="number" id="bulkAddCount" min="1" placeholder="e.g., 3" style="width:64px;" />
                            <button type="button" id="bulkAddButton" class="btn-small" onclick="addBulkProductRow()">+ Add Row</button>
                            <button type="submit" class="btn-small">Submit All</button>
                            <button type="button" class="btn-small btn-danger" onclick="clearBulkProductRows()">Remove All Rows</button>
                        </div>
                    </form>
                </div>
            `;
        }

        function addBulkProductRow() {
            state.bulkProductRows = state.bulkProductRows || [];
            const raw = document.getElementById('bulkAddCount')?.value;
            let c = parseInt((raw || '').trim(), 10);
            if (isNaN(c) || c < 1) c = 1; else c = Math.min(c, 50);
            for (let k = 0; k < c; k++) {
                const id = Date.now() + Math.random().toString().slice(2, 8) + (k ? '_' + k : '');
                state.bulkProductRows.push({ id, type: 'product', name: '', cost: 0, price: 0, stock: 0, category: '', categorySelect: '', newCategoryName: '' });
            }
            saveData();
            render();
        }

        function removeBulkProductRow(id) {
            showConfirm('Remove this row?', function () {
                state.bulkProductRows = (state.bulkProductRows || []).filter(r => r.id !== id);
                saveData();
                render();
            });
        }

        function clearBulkProductRows() {
            showConfirm('Remove all rows?', function () {
                state.bulkProductRows = [];
                saveData();
                render();
            });
        }

        function updateBulkProductField(id, field, value) {
            const rows = state.bulkProductRows || [];
            const r = rows.find(x => x.id === id);
            if (!r) return;
            if (field === 'cost' || field === 'price' || field === 'stock') {
                r[field] = parseMoney(value);
            } else {
                r[field] = value;
            }
            saveData();
            if (field === 'type') render();
        }
        function updateBulkProductCategorySelect(id, val) {
            const rows = state.bulkProductRows || [];
            const r = rows.find(x => x.id === id);
            if (!r) return;
            r.categorySelect = val;
            if (val !== 'new') {
                r.category = val;
                r.newCategoryName = '';
                const kind = getCategoryKind(val);
                r.type = (kind === 'service') ? 'service' : 'product';
            } else {
                r.category = '';
            }
            saveData();
            render();
        }

        async function submitSingleBulkRow(id) {
            const rows = state.bulkProductRows || [];
            const r = rows.find(x => x.id === id);
            state.bulkProductStatus = state.bulkProductStatus || [];
            if (!r) { showToast('Row not found', 'error', null, null, 2000); return; }
            let name = String(r.name || '').trim();
            name = capitalizeFirstWordValue(name);
            let category = String(r.categorySelect === 'new' ? (r.newCategoryName || '') : (r.category || '')).trim();
            category = capitalizeFirstWordValue(category);
            const cost = parseFloat(r.cost) || 0;
            const price = parseFloat(r.price) || 0;
            const isService = String(r.type || '').toLowerCase() === 'service';
            const stock = isService ? 0 : (parseInt(r.stock) || 0);
            if (!name || !category || isNaN(cost) || isNaN(price) || isNaN(stock)) {
                showToast('Please fill all fields correctly', 'error', null, null, 2000);
                render();
                return;
            }
            if (cost < 0 || price < 0 || stock < 0) {
                showToast('Invalid negative values', 'error', null, null, 2000);
                render();
                return;
            }
            if ((parseFloat(price) || 0) < (parseFloat(cost) || 0)) {
                const ok = confirm('Selling price is less than cost. Continue?');
                if (!ok) return;
            }
            const existingNames = new Set((state.products || []).map(p => String(p.name || '').toLowerCase()));
            const nl = name.toLowerCase();
            if (existingNames.has(nl)) {
                showToast('Duplicate product', 'error', null, null, 2000);
                render();
                return;
            }
            if (!state.categories.includes(category)) {
                state.categories.push(category);
                state.categoryKinds = state.categoryKinds || {};
                state.categoryKinds[category] = isService ? 'service' : 'product';
            }
            const product = { id: generateID('products'), name, category, cost, price, hasStock: !isService };
            state.products.push(product);
            state.inventory = state.inventory || {};
            if (!isService) state.inventory[name] = { stock: stock, minAlert: 5 };
            saveData();
            r.status = `${name}: Added`;
            r.statusType = 'success';
            state.bulkProductStatus.push({ type: 'success', message: r.status });
            try {
                if (syncEnabled) {
                    await upsertOne('products', { name, category: category || '', cost: cost || 0, price: price || 0, has_stock: !isService });
                    if (!isService) await upsertOne('inventory', { product_name: name, stock: stock || 0, min_alert: 5 });
                    const kindOut = isService ? 'service' : 'product';
                    await upsertOne('categories', { name: category, kind: kindOut });
                    syncInBackground();
                }
            } catch { }
            try {
                if (!isService) {
                    const purchaseDate = getTodayDateString();
                    const time = new Date().toISOString().slice(11, 16);
                    let cycleNumber = null;
                    const sel = String(r.invPeriod || '').trim();
                    if (sel) { const parsed = parseInt(sel, 10); if (!isNaN(parsed) && parsed > 0) cycleNumber = parsed; }
                    if (!cycleNumber) { cycleNumber = (state.inventoryPurchaseCycles || []).slice(-1)[0]?.number || null; }
                    if (!cycleNumber && (r.invCreateNew || r.invNewPeriodTitle)) { cycleNumber = ensurePeriodCreated(purchaseDate, time, String(r.invNewPeriodTitle || '').trim() || undefined); }
                    if (!cycleNumber) { cycleNumber = ensurePeriodCreated(purchaseDate, time, String(r.invNewPeriodTitle || '').trim() || undefined); }
                    const nowTs = Date.now();
                    const rec = { id: generateID('invPurchase'), cycleNumber, itemName: name, quantity: stock, unitCost: cost || 0, totalCost: Math.max(0, (stock || 0) * (cost || 0)), supplierName: '', supplierPhone: '', supplierAddress: '', purchaseDate, time, notes: 'Auto linked — bulk product creation', timestamp: nowTs, planned: false, activated: true, discount: 0 };
                    state.inventoryPurchases = state.inventoryPurchases || [];
                    state.inventoryPurchases.push(rec);
                    if (syncEnabled) {
                        await upsertOne('inventory_purchases', { period_number: rec.cycleNumber, item_name: rec.itemName, quantity: rec.quantity, unit_cost: rec.unitCost, total_cost: rec.totalCost, purchase_date: rec.purchaseDate, supplier_name: rec.supplierName, supplier_phone: rec.supplierPhone, supplier_address: rec.supplierAddress, notes: rec.notes, timestamp: rec.timestamp });
                    }
                }
            } catch { }
            showToast('✅ Product added!', 'success');
            // Clear all rows after single submission
            state.bulkProductRows = [];
            saveData();
            render();
        }

        async function submitBulkProducts(e) {
            e.preventDefault();
            const rows = state.bulkProductRows || [];
            state.bulkProductStatus = [];
            if (!rows.length) { showToast('No rows to submit', 'info'); return; }
            const anyLoss = rows.some(r => (parseFloat(r.price) || 0) < (parseFloat(r.cost) || 0));
            if (anyLoss) { const ok = confirm('Some rows have selling price less than cost. Continue?'); if (!ok) return; }
            const existingNames = new Set((state.products || []).map(p => String(p.name || '').toLowerCase()));
            const batchNames = new Set();
            const newCats = [];
            const createdPurchases = [];
            for (let i = 0; i < rows.length; i++) {
                const r = rows[i];
                let name = String(r.name || '').trim();
                name = capitalizeFirstWordValue(name);
                let category = String(r.categorySelect === 'new' ? (r.newCategoryName || '') : (r.category || '')).trim();
                category = capitalizeFirstWordValue(category);
                const cost = parseFloat(r.cost) || 0;
                const price = parseFloat(r.price) || 0;
                const isService = String(r.type || '').toLowerCase() === 'service';
                const stock = isService ? 0 : (parseInt(r.stock) || 0);
                if (!name || !category || isNaN(cost) || isNaN(price) || isNaN(stock)) {
                    showToast('Please fill all fields correctly', 'error', null, null, 2000);
                    continue;
                }
                if (cost < 0 || price < 0 || stock < 0) {
                    showToast('Invalid negative values', 'error', null, null, 2000);
                    continue;
                }
                const nl = name.toLowerCase();
                if (existingNames.has(nl) || batchNames.has(nl)) {
                    showToast('Duplicate product', 'error', null, null, 2000);
                    continue;
                }
                batchNames.add(nl);
                if (!state.categories.includes(category)) {
                    state.categories.push(category);
                    newCats.push(category);
                    state.categoryKinds = state.categoryKinds || {};
                    state.categoryKinds[category] = isService ? 'service' : 'product';
                }
                const product = { id: generateID('products'), name, category, cost, price, hasStock: !isService };
                state.products.push(product);
                state.inventory = state.inventory || {};
                if (!isService) state.inventory[name] = { stock: stock, minAlert: 5 };
                rows[i].status = `${name}: Added`;
                rows[i].statusType = 'success';
                state.bulkProductStatus.push({ type: 'success', message: rows[i].status });

                if (!isService) {
                    const purchaseDate = getTodayDateString();
                    const time = new Date().toISOString().slice(11, 16);
                    let cycleNumber = null;
                    const sel = String(r.invPeriod || '').trim();
                    if (sel) { const parsed = parseInt(sel, 10); if (!isNaN(parsed) && parsed > 0) cycleNumber = parsed; }
                    if (!cycleNumber) { cycleNumber = (state.inventoryPurchaseCycles || []).slice(-1)[0]?.number || null; }
                    if (!cycleNumber && (r.invCreateNew || r.invNewPeriodTitle)) { cycleNumber = ensurePeriodCreated(purchaseDate, time, String(r.invNewPeriodTitle || '').trim() || undefined); }
                    if (!cycleNumber) { cycleNumber = ensurePeriodCreated(purchaseDate, time, String(r.invNewPeriodTitle || '').trim() || undefined); }
                    const nowTs = Date.now() + i;
                    const rec = { id: generateID('invPurchase'), cycleNumber, itemName: name, quantity: stock, unitCost: cost || 0, totalCost: Math.max(0, (stock || 0) * (cost || 0)), supplierName: '', supplierPhone: '', supplierAddress: '', purchaseDate, time, notes: 'Auto linked — bulk product creation', timestamp: nowTs, planned: false, activated: true, discount: 0 };
                    createdPurchases.push(rec);
                }
            }
            saveData();
            render();
            if (syncEnabled) {
                try {
                    for (const s of state.bulkProductStatus) {
                        if (s.type !== 'success') continue;
                        const nm = s.message.split(':')[0];
                        const p = (state.products || []).find(x => x.name === nm);
                        if (p) {
                            await upsertOne('products', { name: p.name, category: p.category || '', cost: p.cost || 0, price: p.price || 0, has_stock: p.hasStock !== false });
                            if (p.hasStock !== false) {
                                const inv = state.inventory[p.name] || { stock: 0, minAlert: 5 };
                                await upsertOne('inventory', { product_name: p.name, stock: inv.stock || 0, min_alert: inv.minAlert || 5 });
                            }
                        }
                    }
                    for (const rec of createdPurchases) {
                        state.inventoryPurchases = state.inventoryPurchases || [];
                        state.inventoryPurchases.push(rec);
                        await upsertOne('inventory_purchases', { period_number: rec.cycleNumber, item_name: rec.itemName, quantity: rec.quantity, unit_cost: rec.unitCost, total_cost: rec.totalCost, purchase_date: rec.purchaseDate, supplier_name: rec.supplierName, supplier_phone: rec.supplierPhone, supplier_address: rec.supplierAddress, notes: rec.notes, timestamp: rec.timestamp });
                    }
                    for (const c of newCats) {
                        const kindOut = (state.categoryKinds && state.categoryKinds[c]) ? state.categoryKinds[c] : 'product';
                        await upsertOne('categories', { name: c, kind: kindOut });
                    }
                    syncInBackground();
                } catch { }
            }
            // Clear all rows after bulk submission
            state.bulkProductRows = [];
            saveData();
            render();
            const successCount = (state.bulkProductStatus || []).filter(s => s.type === 'success').length;
            if (successCount > 0) {
                showToast('✅ Products added!', 'success');
            }
        }

        // Toggle visibility of initial stock based on has-stock selection
        function toggleInitialStock() {
            const select = document.getElementById('productHasStock');
            const group = document.getElementById('initialStockGroup');
            const linkGroup = document.getElementById('productInventoryLinkGroup');
            if (!select || !group) return;
            if (select.value === 'no') {
                group.style.display = 'none';
                if (linkGroup) linkGroup.style.display = 'none';
            } else {
                group.style.display = 'block';
                if (linkGroup) linkGroup.style.display = 'block';
            }
        }

        function renderProductsList(searchPeriod = '') {
            let products = state.products.filter(p => !(p && p.deleted === true));
            if (searchPeriod) {
                const Period = searchPeriod.toLowerCase();
                products = products.filter(p =>
                    p.name.toLowerCase().includes(Period) ||
                    p.category.toLowerCase().includes(Period)
                );
            }
            products = filterItemsByTags(products, ((state.filterTags||{}).products)||[], false);

            if (products.length === 0) {
                return '<p style="text-align: center; color: #666;">No items found</p>';
            }
            const count = (state.listShowCount && state.listShowCount.products) ? state.listShowCount.products : 3;
            return products.slice(0, count).map((p, i) => {
                const actualIndex = state.products.indexOf(p);
                const inv = state.inventory[p.name] || { stock: 0 };
                const margin = ((p.price - p.cost) / p.cost * 100).toFixed(1);
                const editing = state.inlineEditProducts && state.inlineEditProducts[actualIndex];
                return `
        <div class="item">
            <div style="display: flex; gap: 12px; align-items: start;">
                <input type="checkbox" class="checkbox-select" 
                       ${state.selectedItems.products && state.selectedItems.products[p.id] ? 'checked' : ''}
                       onchange="toggleSelect('products', '${p.id}')">
                <div style="flex: 1;">
                        ${editing ? `
                        <div class="form-group" data-label="Name"><input type="text" id="prodName_${actualIndex}" value="${p.name || ''}" placeholder="Name"></div>
                        <div class="form-group" data-label="Category">
                            <select id="prodCategory_${actualIndex}" onchange="toggleInlineProductCategory(${actualIndex})">
                                <option value="new">+ Add New Category</option>
                                ${(state.categories || []).map(c => `<option value="${c}" ${p.category === c ? 'selected' : ''}>${c}</option>`).join('')}
                            </select>
                            <input type="text" id="newProdCategory_${actualIndex}" style="display:none; margin-top:5px;" placeholder="New Category Name">
                        </div>
                        <div class="form-group" data-label="Cost"><input type="text" class="money-input" id="prodCost_${actualIndex}" value="${p.cost || 0}" placeholder="Cost"></div>
                        <div class="form-group" data-label="Price"><input type="text" class="money-input" id="prodPrice_${actualIndex}" value="${p.price || 0}" placeholder="Price"></div>
                        <div class="form-group"><input type="text" id="prodSaleUnit_${actualIndex}" value="${p.saleUnit || ''}" placeholder="Sale Unit (e.g., piece)"></div>
                        <div class="form-group"><input type="text" id="prodPurchaseUnit_${actualIndex}" value="${p.purchaseUnit || ''}" placeholder="Purchase Unit (e.g., carton)"></div>
                        <div class="form-group"><input type="number" id="prodUnitsPer_${actualIndex}" value="${(p.unitsPerPurchase!=null)?p.unitsPerPurchase:''}" placeholder="Units per Purchase (e.g., 24)" min="1"></div>
                        <div class="form-group" data-label="Stock" style="${p.hasStock === false ? 'display:none;' : ''}"><input type="text" class="money-input" id="prodStock_${actualIndex}" value="${inv.stock || 0}" placeholder="Stock"></div>
                        <div class="form-group" data-label="Min Alert" style="${p.hasStock === false ? 'display:none;' : ''}"><input type="number" id="prodMinAlert_${actualIndex}" value="${inv.minAlert || 5}" placeholder="Min Alert" min="0"></div>
                        <div class="form-group"><select id="prodHasStock_${actualIndex}"><option value="yes" ${p.hasStock !== false ? 'selected' : ''}>Product (has stock)</option><option value="no" ${p.hasStock === false ? 'selected' : ''}>Service (no stock)</option></select></div>
                        ` : `
                        <div class="item-title">${p.name}</div>
                        <div class="item-subtitle">
                            Category: ${p.category} | ${p.hasStock === false ? 'Service (no stock)' : 'Stock: ' + inv.stock + ' units'}<br>
                            Margin: ${margin}%
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 8px; font-size: 14px;">
                            <span>Cost:  ${formatNumber(p.cost)} Tsh</span>
                            <span>Price:  ${formatNumber(p.price)} Tsh</span>
                            <span style="color: #2e7d32; font-weight: 600;">+${formatNumber(p.price - p.cost)} Tsh</span>
                        </div>
                        `}
                        <div class="flex-gap" style="margin-top:8px;">
                        ${editing ? `
                        <button class="btn-small btn-success" onclick="saveProductInlineEdit(${actualIndex})">Save</button>
                        <button class="btn-small btn-secondary" onclick="toggleProductInlineEdit(${actualIndex})">Cancel</button>
                        ` : `
                        <button class="btn-small" onclick="toggleProductInlineEdit(${actualIndex})">Edit</button>
                        `}
                        <button class="btn-small btn-danger btn-delete" data-action="delete" onclick="deleteProductIndex(${actualIndex})">Delete</button>
                        <button class="btn-small" style="${state.theme === 'dark' ? 'background:#1f2937;color:#e5e7eb;border:1px solid #374151;' : 'background:#e8e8e8;color:#333;border:1px solid #999;'}" onclick="openItemTagsModal('products', '${p.id}')">📌 Tag</button>
                    </div>
                    ${renderTagBadges(p)}
                </div>
            </div>
        </div>
    `;
            }).join('');
        }

        function toggleNewProductCategory() {
            const select = document.getElementById('productCategory');
            const group = document.getElementById('newCategoryFields');
            if (!select || !group) return;
            try { state.currentProductCategory = select.value || ''; saveData(); } catch {}
            group.style.display = (select.value === 'new') ? 'block' : 'none';
            if (select.value && select.value !== 'new') {
                const kind = getCategoryKind(select.value);
                const typeSel = document.getElementById('productHasStock');
                if (typeSel) {
                    typeSel.value = (kind === 'service') ? 'no' : 'yes';
                    try { toggleInitialStock(); } catch {}
                }
            }
        }

        function searchProducts(Period) {
            state.productSearch = Period;
            document.getElementById('productsList').innerHTML = renderProductsList(Period);
        }

        async function addProduct(e) {
            e.preventDefault();
            let name = document.getElementById('productName').value.trim();
            name = toTitleCase(name);
            let category = document.getElementById('productCategory').value;
            if (typeof category === 'string') category = category.trim();
            const saleUnit = (document.getElementById('productSaleUnit')?.value || '').trim();
            const purchaseUnit = (document.getElementById('productPurchaseUnit')?.value || '').trim();
            const unitsPerPurchaseRaw = (document.getElementById('productUnitsPerPurchase')?.value || '').trim();
            const unitsPerPurchaseVal = unitsPerPurchaseRaw ? parseFloat(unitsPerPurchaseRaw) : null;
            const cost = parseMoney(document.getElementById('productCost').value);
            const price = parseMoney(document.getElementById('productPrice').value);
            const stock = parseMoney(document.getElementById('productStock').value) || 0;
            let hasStock = (document.getElementById('productHasStock')?.value !== 'no');
            const selectedPeriod = document.getElementById('productInvPeriodSelect')?.value || '';
            const createNewPeriod = !!(document.getElementById('productInvCreateNewPeriod')?.checked);
            const newPeriodTitle = (document.getElementById('productInvNewPeriodTitle')?.value || '').trim();

            if (cost < 0 || price < 0) {
                return showToast('Cost and price must be positive', 'error');
            }

            if (price < cost) {
                if (!confirm('Warning: Selling price is less than cost. Continue?')) {
                    return;
                }
            }

            if (state.products.some(p => p.name.toLowerCase() === name.toLowerCase())) {
                return showToast('Product already exists', 'error');
            }

            if (category === 'new') {
                const newCat = (document.getElementById('newCategoryName')?.value || '').trim();
                if (!newCat) {
                    return showToast('Please enter new category name', 'error');
                }
                category = toCategoryCase(newCat);
            if (!state.categories.includes(category)) {
                state.categories.push(category);
                state.categoryKinds = state.categoryKinds || {};
                state.categoryKinds[category] = hasStock ? 'product' : 'service';
                saveData();
            }
            }
            if (category && category !== 'new') category = toCategoryCase(category);
            // Auto-select type from category kind
            if (category && category !== 'new') {
                const kind = getCategoryKind(category);
                hasStock = (kind === 'service') ? false : true;
                // Record category kind for future use
                state.categoryKinds = state.categoryKinds || {};
                state.categoryKinds[category] = kind;
            }

            const product = {
                id: generateID('products'),
                name,
                category,
                cost,
                price,
                hasStock,
                saleUnit: saleUnit || '',
                purchaseUnit: purchaseUnit || '',
                unitsPerPurchase: (typeof unitsPerPurchaseVal === 'number' && !isNaN(unitsPerPurchaseVal)) ? unitsPerPurchaseVal : null
            };
            state.products.push(product);

            // Initialize inventory for new product
            if (!state.inventory) {
                state.inventory = {};
            }

            // Only set initial stock for stock-tracked products
            if (hasStock) {
                state.inventory[name] = {
                    stock: parseInt(stock) || 0,
                    minAlert: 5
                };
                try {
                    const purchaseDate = getTodayDateString();
                    const time = new Date().toISOString().slice(11, 16);
                    let cycleNumber = null;
                    if (selectedPeriod) {
                        const parsed = parseInt(selectedPeriod, 10);
                        if (!isNaN(parsed) && parsed > 0) cycleNumber = parsed;
                    }
                    if (!cycleNumber) {
                        cycleNumber = (state.inventoryPurchaseCycles || []).slice(-1)[0]?.number || null;
                    }
                    if (!cycleNumber && createNewPeriod) {
                        cycleNumber = ensurePeriodCreated(purchaseDate, time, newPeriodTitle);
                    }
                    if (!cycleNumber) {
                        cycleNumber = ensurePeriodCreated(purchaseDate, time, newPeriodTitle);
                    }
                    const nowTs = Date.now();
                    const rec = {
                        id: generateID('invPurchase'),
                        cycleNumber,
                        itemName: name,
                        quantity: parseInt(stock) || 0,
                        unitCost: cost || 0,
                        totalCost: Math.max(0, (parseInt(stock) || 0) * (cost || 0)),
                        supplierName: '',
                        supplierPhone: '',
                        supplierAddress: '',
                        purchaseDate,
                        time,
                        notes: 'Auto linked — product creation',
                        timestamp: nowTs,
                        planned: false,
                        activated: true,
                        discount: 0
                    };
                    state.inventoryPurchases = state.inventoryPurchases || [];
                    state.inventoryPurchases.push(rec);
                    try {
                        if (syncEnabled) {
                            await upsertOne('inventory_purchases', {
                                period_number: rec.cycleNumber,
                                item_name: rec.itemName,
                                quantity: rec.quantity,
                                unit_cost: rec.unitCost,
                                total_cost: rec.totalCost,
                                purchase_date: rec.purchaseDate,
                                supplier_name: rec.supplierName,
                                supplier_phone: rec.supplierPhone,
                                supplier_address: rec.supplierAddress,
                                notes: rec.notes,
                                timestamp: rec.timestamp
                            });
                        }
                    } catch {}
                } catch {}
            }


            saveData();
            render();
            showToast("Product added", "info", null, null, 2000);

            try {
                await upsertOne('products', { name, category: category || '', cost: cost || 0, price: price || 0, has_stock: hasStock !== false, sale_unit: (saleUnit||null), purchase_unit: (purchaseUnit||null), units_per_purchase: ((typeof unitsPerPurchaseVal === 'number' && !isNaN(unitsPerPurchaseVal)) ? unitsPerPurchaseVal : null) });
                if (hasStock) {
                    const inv = state.inventory[name] || { stock: 0, minAlert: 5 };
                    await upsertOne('inventory', { product_name: name, stock: inv.stock || 0, min_alert: inv.minAlert || 5 });
                }
                if (category) {
                    const kindOut = (state.categoryKinds && state.categoryKinds[category]) ? state.categoryKinds[category] : (hasStock ? 'product' : 'service');
                    await upsertOne('categories', { name: category, kind: kindOut });
                }
                syncInBackground();
            } catch { }
        }

        function toggleInlineProductCategory(i) {
            const select = document.getElementById(`prodCategory_${i}`);
            const input = document.getElementById(`newProdCategory_${i}`);
            if (select && input) {
                input.style.display = (select.value === 'new') ? 'block' : 'none';
            }
        }

        async function toggleProductInlineEdit(i) {
            openProductInlineEditModal(i);
        }
        async function saveProductInlineEdit(i) {
            const p = state.products[i];
            if (!p) return false;
            const nameRaw = document.getElementById(`prodName_${i}`)?.value || p.name || '';
            const name = toTitleCase(String(nameRaw || '').trim());
            
            let category = document.getElementById(`prodCategory_${i}`)?.value || p.category || '';
            if (category === 'new') {
                const newCat = (document.getElementById(`newProdCategory_${i}`)?.value || '').trim();
                if (!newCat) { showToast('Please enter new category name', 'error'); return false; }
                category = toCategoryCase(newCat);
                if (!state.categories.includes(category)) {
                    state.categories.push(category);
                    state.categoryKinds = state.categoryKinds || {};
                    state.categoryKinds[category] = (document.getElementById(`prodHasStock_${i}`)?.value !== 'no') ? 'product' : 'service';
                    saveData();
                }
            } else {
                category = toCategoryCase(category);
            }

            const cost = parseMoney(document.getElementById(`prodCost_${i}`)?.value || p.cost || 0) || 0;
            const price = parseMoney(document.getElementById(`prodPrice_${i}`)?.value || p.price || 0) || 0;
            const hasStock = (document.getElementById(`prodHasStock_${i}`)?.value !== 'no');
            const saleUnit = (document.getElementById(`prodSaleUnit_${i}`)?.value || '').trim();
            const purchaseUnit = (document.getElementById(`prodPurchaseUnit_${i}`)?.value || '').trim();
            const unitsRaw = (document.getElementById(`prodUnitsPer_${i}`)?.value || '').trim();
            const unitsVal = unitsRaw ? parseFloat(unitsRaw) : null;
            if (cost < 0 || price < 0) { showToast('Cost and price must be positive', 'error'); return false; }
            const oldName = p.name;
            const oldCategory = p.category;
            p.name = name; p.category = category; p.cost = cost; p.price = price; p.hasStock = hasStock;
            p.saleUnit = saleUnit || '';
            p.purchaseUnit = purchaseUnit || '';
            p.unitsPerPurchase = (typeof unitsVal === 'number' && !isNaN(unitsVal) && unitsVal > 0) ? unitsVal : null;
            state.inventory = state.inventory || {};
            if (hasStock) {
                const stockRaw = document.getElementById(`prodStock_${i}`)?.value || '';
                const minRaw = document.getElementById(`prodMinAlert_${i}`)?.value || '';
                const newStock = parseInt(parseMoney(stockRaw || '0'), 10) || 0;
                const newMin = parseInt(minRaw || '5', 10);
                const invOld = state.inventory[oldName] || { stock: 0, minAlert: 5 };
                const invNew = { stock: newStock, minAlert: (isNaN(newMin) || newMin < 0) ? 5 : newMin };
                if (oldName !== p.name) { delete state.inventory[oldName]; }
                state.inventory[p.name] = invNew;
            } else {
                if (state.inventory[p.name]) delete state.inventory[p.name];
                if (oldName !== p.name && state.inventory[oldName]) delete state.inventory[oldName];
            }
            if (state.inventory && oldName !== p.name) {
                if (p.hasStock === false) {
                    if (state.inventory[oldName]) delete state.inventory[oldName];
                } else {
                    state.inventory[p.name] = state.inventory[oldName] || { stock: 0, minAlert: 5 };
                    delete state.inventory[oldName];
                }
            }
            if (oldName !== p.name || oldCategory !== p.category) {
                try {
                    const affectedSales = (state.sales || []).filter(s => s.productName === p.name || s.productName === oldName);
                    affectedSales.forEach(s => {
                        s.productName = p.name;
                        s.category = p.category;
                        const qty = s.quantity || 1;
                        s.costPerUnit = p.cost;
                        s.pricePerUnit = p.price;
                        s.totalCost = p.cost * qty;
                        s.totalPrice = p.price * qty;
                        s.profit = +(s.totalPrice - s.totalCost).toFixed(2);
                    });
                    (state.inventoryPurchases || []).forEach(ip => { if (ip.itemName === oldName) ip.itemName = p.name; });
                    
                    if (syncEnabled && affectedSales.length > 0) {
                        // Background sync for affected sales
                        affectedSales.forEach(async (s) => {
                            try {
                                await upsertOne('sales', {
                                    timestamp: s.timestamp,
                                    product_name: s.productName,
                                    category: s.category || '',
                                    date: s.date,
                                    time: s.time,
                                    customer: s.customer,
                                    quantity: s.quantity,
                                    cost_per_unit: s.costPerUnit,
                                    price_per_unit: s.pricePerUnit,
                                    total_cost: s.totalCost,
                                    total_price: s.totalPrice,
                                    profit: s.profit,
                                    payment: s.payment,
                                    status: s.status
                                });
                            } catch {}
                        });
                    }
                } catch { }
            } else {
                // If only prices changed
                try {
                    (state.sales || []).forEach(s => {
                        if (s.productName === p.name) {
                            const qty = s.quantity || 1;
                            s.costPerUnit = p.cost;
                            s.pricePerUnit = p.price;
                            s.totalCost = p.cost * qty;
                            s.totalPrice = p.price * qty;
                            s.profit = +(s.totalPrice - s.totalCost).toFixed(2);
                        }
                    });
                } catch { }
            }
            saveData();
            state.inlineEditProducts[i] = false;
            render();
            showToast('Product updated', 'success');
            if (syncEnabled) {
                try {
                    await upsertOne('products', { name: p.name, category: p.category || '', cost: p.cost || 0, price: p.price || 0, has_stock: p.hasStock !== false, sale_unit: (p.saleUnit||null), purchase_unit: (p.purchaseUnit||null), units_per_purchase: (p.unitsPerPurchase!=null?p.unitsPerPurchase:null) });
                    if (oldName !== p.name || oldCategory !== p.category) { try { await deleteOne('products', { name: oldName, category: oldCategory || '' }); } catch { } }
                    if (p.hasStock !== false) {
                        const inv = state.inventory[p.name] || { stock: 0, minAlert: 5 };
                        await upsertOne('inventory', { product_name: p.name, stock: inv.stock || 0, min_alert: inv.minAlert || 5 });
                        if (oldName !== p.name) { try { await deleteOne('inventory', { product_name: oldName }); } catch { } }
                    } else {
                        if (oldName !== p.name) { try { await deleteOne('inventory', { product_name: oldName }); } catch { } }
                    }
                } catch { }
                syncInBackground();
            }
            return true;
        }

        async function deleteProductIndex(i) {
            try { playDeleteSound(); } catch (e) { }
            const ok = await requirePinForDestructive('delete');
            if (!ok) { showToast('Delete failed: PIN required', 'error'); return; }
            
            const p = state.products[i];
            if (p && p.name && state.inventory && state.inventory[p.name]) delete state.inventory[p.name];
            if (p) {
                try {
                    if (navigator.onLine && syncEnabled && currentUser) {
                        await deleteOne('products', { name: p.name, category: p.category || '' });
                    } else {
                        await deleteOne('products', { name: p.name, category: p.category || '' });
                    }
                } catch { }
            }
            state.products.splice(i, 1);
            saveData();
            render();
            showToast("Product deleted", "success");

            // Sync in background
            if (syncEnabled) syncInBackground();
        }
        function renderCategories() {
            const q = state.categorySearch || '';
            return `
                <div class="search-box" style="margin:8px 0;">
                    <input type="search" name="search_field_unique_${Date.now()}" autocomplete="off" placeholder="🔍 Search categories..." oninput="searchCategories(this.value)" id="categorySearch" value="${q}" readonly onfocus="this.removeAttribute('readonly');">
                </div>
                ${renderBulkCategoriesSection()}
                <div class="card">
                    <h2>Add Category</h2>
                    <div class="card-header-buttons">
                        <button class="quick-nav-btn back" onclick="switchTab('products')">← Products/Services</button>
                    </div>
                    <form onsubmit="addCategory(event)">
                        <div class="form-group">
                            <input type="text" id="categoryName" placeholder="Category Name" required>
                        </div>
                        <div class="form-group">
                            <label>Category Type</label>
                            <select id="categoryKind">
                                <option value="product" selected>Product (has stock)</option>
                                <option value="service">Service (no stock)</option>
                            </select>
                        </div>
                        
                        <button type="submit">Add Category</button>
                    </form>
                </div>

               <div class="card">
    <h2>All Categories (${state.categories.length})</h2>
    <div class="search-box" style="margin:8px 0;">
        <input type="search" name="search_field_unique_${Date.now()}" autocomplete="off" placeholder="🔍 Search categories..." oninput="searchCategories(this.value)" id="categorySearchBottom" value="${q}" readonly onfocus="this.removeAttribute('readonly');">
    </div>
    
    ${state.categories.length > 0 ? `
        <div class="bulk-actions">
            <input type="checkbox" id="selectAll_categories" onchange="toggleSelectAllCategories()" class="checkbox-select">
            <label for="selectAll_categories">Select All</label>
            <span style="color: #666; font-size: 12px; margin-left: 8px;">
                ${getSelectedCategoryCount()} selected
            </span>
            <button class="btn-small btn-danger" onclick="bulkDeleteCategories()" ${!hasSelectedCategories() ? 'disabled' : ''}>
                🗑️ Delete Selected
            </button>
        </div>
    ` : ''}
    <div id="categoriesList" class="list-scroll-container">${renderCategoriesList(q)}</div>
    ${(() => { const total = (state.categories || []).filter(cat => !q || String(cat).toLowerCase().includes(q.toLowerCase())).length; const count = (state.listShowCount && state.listShowCount.categories) ? state.listShowCount.categories : 3; const hasMore = count < total; return `<div class=\"flex-gap\" style=\"justify-content:center;margin:8px 0;flex-wrap:nowrap;\"><button class=\"collapse-btn\" onclick=\"${hasMore ? `showMoreList('categories')` : `collapseList('categories')`}\"><span class=\"collapse-icon ${hasMore ? '' : 'expanded'}\">▼</span><span>${hasMore ? 'See more' : 'Hide'}</span></button><button class=\"collapse-btn\" onclick=\"showAllList('categories')\"><span class=\"collapse-icon\">▼</span><span>Show all</span></button></div>`; })()}
</div>
            `;
        }

        function renderCategoriesList(Period) {
            const q = String(Period || '').toLowerCase();
            let cats = state.categories.map((cat, i) => ({ cat, i }))
                .filter(({ cat }) => !q || String(cat).toLowerCase().includes(q))
            const count = (state.listShowCount && state.listShowCount.categories) ? state.listShowCount.categories : 3;
            return cats.slice(0, count).map(({ cat, i }) => `
            <div class="item">
                <div style="display: flex; gap: 12px; align-items: center;">
                    <input type="checkbox" class="checkbox-select" 
                           ${state.selectedItems.categories && state.selectedItems.categories[i] ? 'checked' : ''}
                           onchange="toggleSelectCategory(${i})">
                    <div style="flex: 1; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            ${(() => {
                    const editing = state.inlineEditCategories && state.inlineEditCategories[i]; return editing ? `
                            <div class=\"form-group\" data-label=\"Category\"><input type=\"text\" id=\"catName_${i}\" value=\"${cat}\" placeholder=\"Category\" style=\"padding:6px;border:1px solid #ddd;border-radius:6px;\"></div>
                            <div class=\"form-group\"><select id=\"catKind_${i}\"><option value=\"product\" ${getCategoryKind(cat)==='service'?'':'selected'}>Product (has stock)</option><option value=\"service\" ${getCategoryKind(cat)==='service'?'selected':''}>Service (no stock)</option></select></div>` : `<span class=\"item-title\">${cat}</span>`;
                })()}
                            <div class="item-subtitle">
                                ${state.products.filter(p => p.category === cat).length} products
                                &nbsp;•&nbsp;
                                Type: ${(() => { const k = getCategoryKind(cat); return k==='service'?'Service':(k==='product'?'Product':'Mixed'); })()}
                            </div>
                        </div>
                        <div class="flex-gap period-card-actions">
                            ${(() => {
                    const editing = state.inlineEditCategories && state.inlineEditCategories[i]; return editing ? `
                            <button class=\"btn-small btn-success\" onclick=\"saveCategoryInlineEdit(${i})\">Save</button>
                            <button class=\"btn-small btn-secondary\" onclick=\"toggleCategoryInlineEdit(${i})\">Cancel</button>` : `
                            <button class=\"btn-small\" onclick=\"toggleCategoryInlineEdit(${i})\">Edit</button>`;
                })()}
                            <button class="btn-small btn-danger btn-delete" data-action="delete" onclick="deleteCategoryIndex(${i})">Delete</button>
                        </div>
                    </div>
                </div>
            </div>
        `).join('') || '<p style="text-align: center; color: #666;">No categories yet</p>';
        }

        function searchCategories(Period) {
            state.categorySearch = Period;
            const el = document.getElementById('categoriesList');
            if (el) el.innerHTML = renderCategoriesList(Period);
        }

        function toggleSelectAllCategories() {
            if (!state.selectedItems.categories) state.selectedItems.categories = {};
            const boxes = Array.from(document.querySelectorAll(`input.checkbox-select[onchange^="toggleSelectCategory("]`)).filter(b => b.id !== 'selectAll_categories');
            if (boxes.length === 0) return;
            const allSelected = boxes.every(b => b.checked);
            const newState = !allSelected;
            boxes.forEach(b => {
                const oc = String(b.getAttribute('onchange') || '');
                const m = oc.match(/^toggleSelectCategory\((\d+)\)/);
                const idx = m ? parseInt(m[1], 10) : null;
                if (idx != null) state.selectedItems.categories[idx] = newState;
                try { b.checked = newState; } catch {}
            });
            saveData();
            render();
        }

        function toggleSelectCategory(index) {
            if (!state.selectedItems.categories) state.selectedItems.categories = {};
            state.selectedItems.categories[index] = !state.selectedItems.categories[index];
            saveData();
            render(); // RE-RENDER TO UPDATE CHECKBOXES AND COUNT
        }

        function hasSelectedCategories() {
            return state.selectedItems.categories && Object.values(state.selectedItems.categories).some(v => v);
        }

        function getSelectedCategoryCount() {
            if (!state.selectedItems.categories) return 0;
            return Object.values(state.selectedItems.categories).filter(v => v).length;
        }

        async function bulkDeleteCategories() {
            const selected = Object.keys(state.selectedItems.categories || {})
                .filter(i => state.selectedItems.categories[i])
                .map(i => parseInt(i));

            if (selected.length === 0) return showToast('No categories selected', 'info');
            try { playDeleteSound(); } catch (e) { }
            const ok = await requirePinForDestructive('delete');
            if (!ok) { showToast('Delete failed: PIN required', 'error'); return; }
            selected.sort((a, b) => b - a).forEach(i => {
                const name = state.categories[i];
                if (syncEnabled && name) { try { deleteOne('categories', { name }); } catch { } }
                state.categories.splice(i, 1);
            });

            state.selectedItems.categories = {};
            saveData();
            render();
            showToast(`${selected.length} categories deleted`, 'success');

            if (syncEnabled) syncInBackground();
        }

        async function addCategory(e) {
            e.preventDefault();
            const nameRaw = document.getElementById('categoryName').value.trim();
            const name = toCategoryCase(nameRaw);
            if (state.categories.includes(name)) return showToast('Category already exists', 'error');

            state.categories.push(name);
            try {
                const kindSel = document.getElementById('categoryKind');
                const kind = (kindSel && kindSel.value === 'service') ? 'service' : 'product';
                state.categoryKinds = state.categoryKinds || {};
                state.categoryKinds[name] = kind;
            } catch {}
            saveData();
            render();
            showToast("Category added", "success");

            if (syncEnabled) {
                const kind = (state.categoryKinds && state.categoryKinds[name]) ? state.categoryKinds[name] : 'product';
                await upsertOne('categories', { name, kind });
                syncInBackground();
            }
        }

        function toggleCategoryInlineEdit(i) { openCategoryInlineEditModal(i); }
        function saveCategoryInlineEdit(i) { const oldName = state.categories[i]; const nameVal = document.getElementById(`catName_${i}`)?.value || oldName; const newName = toCategoryCase(String(nameVal || '').trim()); if (!newName) return false; if (state.categories.includes(newName) && newName !== oldName) { showToast('Category already exists', 'error'); return false; } state.categories[i] = newName; state.products.forEach(p => { if (p.category === oldName) p.category = newName; }); state.categoryKinds = state.categoryKinds || {}; const kindSel = document.getElementById(`catKind_${i}`); if (kindSel) { state.categoryKinds[newName] = (kindSel.value === 'service') ? 'service' : 'product'; } else if (state.categoryKinds[oldName] && oldName !== newName) { state.categoryKinds[newName] = state.categoryKinds[oldName]; } if (oldName !== newName) { delete state.categoryKinds[oldName]; } saveData(); state.inlineEditCategories[i] = false; render(); showToast('Category updated', 'success'); if (syncEnabled) { const kindOut = state.categoryKinds[newName] || 'product'; upsertOne('categories', { name: newName, kind: kindOut }); if (oldName !== newName) { try { deleteOne('categories', { name: oldName }); } catch {} } syncInBackground(); } return true; }
        function getCategoryKind(cat){ try { const map = state.categoryKinds || {}; const k = map[cat]; if (k) return k; const prods = (state.products || []).filter(p => String(p.category || '') === String(cat)); if (!prods.length) return 'product'; const hasProd = prods.some(p => p.hasStock !== false); const hasServ = prods.some(p => p.hasStock === false); if (hasServ && !hasProd) return 'service'; if (hasProd && !hasServ) return 'product'; return 'mixed'; } catch { return 'product'; } }
        function renderBulkCategoriesSection(){
            state.bulkCategoryRows = state.bulkCategoryRows || [];
            const rows = (state.bulkCategoryRows || []).map((r, i) => `
                <div class="bulk-row" style="display:flex; gap:8px; align-items:flex-end;">
                    <div class="form-group" style="flex:0 0 auto; min-width:auto;">
                        <label>#</label>
                        <div style="padding:6px 10px; background:#eee; border-radius:8px; font-size:12px;">${i + 1}</div>
                    </div>
                    <div class="form-group" style="flex:2;">
                        <label>Category Name</label>
                        <input type="text" placeholder="e.g., Beverages" value="${r.name || ''}" oninput="updateBulkCategoryField('${r.id}','name',this.value)">
                    </div>
                    <div class="form-group" style="flex:1;">
                        <label>Category Type</label>
                        <select onchange="updateBulkCategoryField('${r.id}','kind',this.value)">
                            <option value="product" ${r.kind === 'service' ? '' : 'selected'}>Product (has stock)</option>
                            <option value="service" ${r.kind === 'service' ? 'selected' : ''}>Service (no stock)</option>
                        </select>
                    </div>
                    <button class="btn-small btn-danger" type="button" onclick="removeBulkCategoryRow('${r.id}')">Remove</button>
                    <button class="btn-small" type="button" onclick="submitSingleBulkCategoryRow('${r.id}')">Submit Row</button>
                </div>
            `).join('');
            const count = (state.bulkCategoryRows || []).length;
            return `
                <div class="card">
                    <h2>Bulk Add Categories</h2>
                    <form onsubmit="submitBulkCategories(event)">
                        <div style="display:flex; flex-direction:column; gap:8px;">${rows}</div>
                        <div class="flex-gap" style="margin-top:4px;">
                            <span class="badge">Rows: ${count}</span>
                        </div>
                        <div class="flex-gap" style="margin-top:8px;">
                            <input type="number" id="bulkCatAddCount" min="1" placeholder="e.g., 3" style="width:64px;" />
                            <button type="button" class="btn-small" onclick="addBulkCategoryRow()">+ Add Row</button>
                            <button type="submit" class="btn-small">Submit All</button>
                            <button type="button" class="btn-small btn-danger" onclick="clearBulkCategoryRows()">Remove All Rows</button>
                        </div>
                    </form>
                </div>
            `;
        }
        function addBulkCategoryRow(){
            state.bulkCategoryRows = state.bulkCategoryRows || [];
            const raw = document.getElementById('bulkCatAddCount')?.value;
            let c = parseInt((raw || '').trim(), 10);
            if (isNaN(c) || c < 1) c = 1; else c = Math.min(c, 50);
            for (let k = 0; k < c; k++) {
                const id = Date.now() + Math.random().toString().slice(2, 8) + (k ? '_' + k : '');
                state.bulkCategoryRows.push({ id, name: '', kind: 'product' });
            }
            saveData(); render();
        }
        function removeBulkCategoryRow(id){
            showConfirm('Remove this row?', function () {
                state.bulkCategoryRows = (state.bulkCategoryRows || []).filter(r => r.id !== id);
                saveData(); render();
            });
        }
        function clearBulkCategoryRows(){
            showConfirm('Remove all rows?', function(){
                state.bulkCategoryRows = [];
                saveData(); render();
            });
        }
        function updateBulkCategoryField(id, field, value){
            const rows = state.bulkCategoryRows || [];
            const r = rows.find(x => x.id === id);
            if (!r) return;
            r[field] = value;
            saveData();
        }
        async function submitSingleBulkCategoryRow(id){
            const rows = state.bulkCategoryRows || [];
            const r = rows.find(x => x.id === id);
            state.bulkCategoryStatus = state.bulkCategoryStatus || [];
            if (!r) { showToast('Row not found', 'error'); return; }
            let name = String(r.name || '').trim();
            name = toCategoryCase(name);
            const kind = (String(r.kind || 'product').toLowerCase() === 'service') ? 'service' : 'product';
            if (!name) { showToast('Enter category name', 'error'); return; }
            if (state.categories.includes(name)) { showToast('Category already exists', 'error'); return; }
            state.categories.push(name);
            state.categoryKinds = state.categoryKinds || {};
            state.categoryKinds[name] = kind;
            saveData();
            try {
                if (syncEnabled) { await upsertOne('categories', { name }); syncInBackground(); }
            } catch {}
            showToast('✅ Category added!', 'success');
            state.bulkCategoryRows = [];
            saveData(); render();
        }
        async function submitBulkCategories(e){
            e.preventDefault();
            const rows = state.bulkCategoryRows || [];
            if (!rows.length) { showToast('No rows to submit', 'info'); return; }
            const added = [];
            for (let i = 0; i < rows.length; i++) {
                const r = rows[i];
                let name = String(r.name || '').trim();
                name = toCategoryCase(name);
                const kind = (String(r.kind || 'product').toLowerCase() === 'service') ? 'service' : 'product';
                if (!name) { showToast('Missing category name', 'error'); continue; }
                if (state.categories.includes(name)) { showToast(`Duplicate: ${name}`, 'error'); continue; }
                state.categories.push(name);
                state.categoryKinds = state.categoryKinds || {};
                state.categoryKinds[name] = kind;
                added.push(name);
            }
            saveData(); render();
            if (syncEnabled && added.length) {
                try { for (const nm of added) { await upsertOne('categories', { name: nm }); } syncInBackground(); } catch {}
            }
            state.bulkCategoryRows = [];
            saveData(); render();
            showToast(`✅ ${added.length} categories added`, 'success');
        }

        async function deleteCategoryIndex(i) {
            try { playDeleteSound(); } catch (e) { }
            const ok = await requirePinForDestructive('delete');
            if (!ok) { showToast('Delete failed: PIN required', 'error'); return; }
            const cat = state.categories[i];
            if (!cat) return;
            state.categories.splice(i, 1);
            saveData();
            render();
            showToast("Category deleted", "success");

            if (syncEnabled) {
                try { await deleteOne('categories', { name: cat }); } catch {}
                syncInBackground();
            }
        }

        function renderExpenses() {
            const stats = getStats();

            let filteredExpenses = state.expenses.slice();
            filteredExpenses = filteredExpenses.filter(e => !(e && e.deleted === true));

            if (state.searchPeriod) {
                const Period = state.searchPeriod.toLowerCase();
                filteredExpenses = filteredExpenses.filter(e =>
                    e.description.toLowerCase().includes(Period) ||
                    e.category.toLowerCase().includes(Period)
                );
            }

            if (state.filterDateFrom) {
                filteredExpenses = filteredExpenses.filter(e => new Date(e.date) >= new Date(state.filterDateFrom));
            }

            if (state.filterDateTo) {
                filteredExpenses = filteredExpenses.filter(e => new Date(e.date) <= new Date(state.filterDateTo));
            }

            if (state.filterCategory) {
                filteredExpenses = filteredExpenses.filter(e => e.category === state.filterCategory);
            }
            filteredExpenses = filterItemsByTags(filteredExpenses, ((state.filterTags||{}).expenses)||[], false);

            return `
                <div class="stat-grid">
                    <div class="stat-card">
                        <div class="stat-label">TOTAL EXPENSES</div>
                        <div class="stat-value"> ${formatNumber(stats.totalExpenses)} Tsh</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">MONTH EXPENSES</div>
                        <div class="stat-value"> ${formatNumber(stats.monthExpenses)} Tsh</div>
                    </div>
                </div>

                

                <div class="card">
                    <h2>Add Expense</h2>
                    <div class="card-header-buttons">
                        <button class="btn-small" onclick="openExpensesReportRangeModal()">📄 Expenses Report (PDF)</button>
                    </div>
                    <form onsubmit="addExpense(event)">
                        <div class="form-group">
                            <label>Description</label>
                            <input type="text" id="expenseDesc" placeholder="e.g., Rent, Utilities" required>
                        </div>
                        <div class="form-group">
                            <label>Category</label>
                            <select id="expenseCategory" onchange="toggleExpenseCategory()">
                                <option value="new">+ Add New Category</option>
                                ${(() => { let cats = (state.expenseCategories || ['Miscellaneous']).slice(); const idx = cats.findIndex(c => String(c).toLowerCase() === 'miscellaneous'); if (idx === -1) cats.unshift('Miscellaneous'); else { const m = cats.splice(idx, 1)[0]; cats.unshift(m); } const current = String(state.currentExpenseCategory || ''); return cats.map((c, i) => `<option value="${c}" ${(current ? (current === String(c)) : (i === 0)) ? 'selected' : ''}>${c}</option>`).join(''); })()}
                            </select>
                        </div>
                        <div class="form-group" id="expenseCategoryNewGroup" style="display:none;">
                            <label>New Category</label>
                            <input type="text" id="expenseCategoryNew" placeholder="e.g., Utilities">
                        </div>
                        <div class="form-group">
                            <label>Amount</label>
                            <input type="text" id="expenseAmount" class="money-input" placeholder="0" required>
                        </div>
                        <div class="form-group">
                            <label>Payment Method</label>
                            <select id="expensePayment">
                                <option>Cash</option>
                                <option>Card</option>
                                <option>Mobile Money</option>
                                <option>M-Pesa Lipa Number</option>
                                <option>Bank Transfer</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Comment (Optional)</label>
                            <textarea id="expenseComment" placeholder="Additional notes..."></textarea>
                        </div>
                        <button type="submit" title="Save / Update" onclick="addExpense(event)">Save / Update</button>
                    </form>
                </div>

                <div class="card">
                    <h2>Recent Expenses (${filteredExpenses.length})</h2>
                    <div class="card-header-buttons"><button class="btn-small" onclick="copyAllExpenses()">📋 Copy All</button></div>
                    
                        <div class="search-box">
                            <input type="search" name="search_field_unique_${Date.now()}" autocomplete="off" id="expensesSearchInput" placeholder="🔍 Search expenses..." oninput="updateSearchPeriod(this.value); toggleClearButton('expensesSearchInput', 'expensesClearBtn')" value="${state.searchPeriod || ''}" readonly onfocus="this.removeAttribute('readonly');">
                            <button id="expensesClearBtn" class="clear-btn btn-small btn-secondary hint ${String(state.searchPeriod || '').trim() ? 'visible' : ''}" onclick="clearExpensesSearch()">Clear</button>
                        </div>
                        <div style="margin-bottom:8px;">${renderTagChips('expenses')}</div>

                    <div class="filter-row">
                        <input type="date" placeholder="From" onchange="updateFilterDateFrom(this.value)" value="${state.filterDateFrom || ''}">
                        <input type="date" placeholder="To" onchange="updateFilterDateTo(this.value)" value="${state.filterDateTo || ''}">
                        <select onchange="updateFilterCategory(this.value)">
                            <option value="">All Categories</option>
                            ${[...new Set(state.expenses.map(e => e.category))]
                    .filter(c => !!c)
                    .sort((a, b) => String(a).localeCompare(String(b)))
                    .map(c =>
                        `<option value="${c}" ${state.filterCategory === c ? 'selected' : ''}>${c}</option>`
                    ).join('')}
                        </select>
                        <button class="btn-small btn-secondary" onclick="clearFilters()">Clear</button>
                    </div>

    ${filteredExpenses.length > 0 ? `
        <div class="bulk-actions">
            <input type="checkbox" id="selectAll_expenses" onchange="toggleSelectAll('expenses')" class="checkbox-select">
            <label for="selectAll_expenses">Select All</label>
            <span style="color: #666; font-size: 12px; margin-left: 8px;">
                ${getSelectedCount('expenses')} selected
            </span>
            <button class="btn-small btn-danger" onclick="bulkDelete('expenses')" ${!hasSelected('expenses') ? 'disabled' : ''}>
                🗑️ Delete Selected
            </button>
            <button class="btn-small btn-tag" onclick="bulkApplyTag('expenses')" ${!hasSelected('expenses') ? 'disabled' : ''} title="📌 Apply Tag">📌 Apply Tag</button>
        </div>
    ` : ''}

                    <div id="expensesList" class="list-scroll-container"></div>
                    ${(() => { const total = filteredExpenses.length; const count = (state.listShowCount && state.listShowCount.expenses) ? state.listShowCount.expenses : 3; const hasMore = count < total; return `<div class=\"flex-gap\" style=\"justify-content:center;margin:8px 0;flex-wrap:nowrap;\"><button class=\"collapse-btn\" onclick=\"${hasMore ? `showMoreList('expenses')` : `collapseList('expenses')`}\"><span class=\"collapse-icon ${hasMore ? '' : 'expanded'}\">▼</span><span>${hasMore ? 'See more' : 'Hide'}</span></button><button class=\"collapse-btn\" onclick=\"showAllList('expenses')\"><span class=\"collapse-icon\">▼</span><span>Show all</span></button></div>`; })()}
                </div>
            `;
        }

        function updateFilterCategory(value) {
            state.filterCategory = value;
            render();
        }

        function toggleExpenseCategory() {
            const sel = document.getElementById('expenseCategory');
            const grp = document.getElementById('expenseCategoryNewGroup');
            if (!sel || !grp) return;
            try { state.currentExpenseCategory = sel.value || ''; saveData(); } catch {}
            grp.style.display = sel.value === 'new' ? '' : 'none';
        }

        async function addExpense(e) {
            e.preventDefault();
            if (state.__savingExpense) return; state.__savingExpense = true;
            try {
                const amtEl = document.getElementById('expenseAmount');
                const amountRaw = ((amtEl && amtEl.dataset && amtEl.dataset.numeric) ? amtEl.dataset.numeric : (amtEl ? amtEl.value : '')).trim();
                const amount = parseMoney(amountRaw);
                if (isNaN(amount) || amount <= 0) { showToast('Please enter a valid amount', 'error'); return; }

                const descEl = document.getElementById('expenseDesc');
                const desc = (descEl && descEl.value ? descEl.value : '').trim();
                if (!desc) { showToast('Enter a description', 'error'); return; }

                const now = new Date();

                const category = (() => {
                    const sel = document.getElementById('expenseCategory');
                    const v = sel ? sel.value : '';
                    if (v === 'new') {
                        const raw = (document.getElementById('expenseCategoryNew')?.value || '').trim();
                        if (!raw) { showToast('Enter a category name', 'error'); return null; }
                        const name = capitalizeFirstWordValue(raw);
                        const exists = (state.expenseCategories || []).some(c => String(c).toLowerCase() === name.toLowerCase());
                        if (!exists) {
                            const rest = (state.expenseCategories || []).filter(c => String(c).toLowerCase() !== 'miscellaneous' && String(c).toLowerCase() !== name.toLowerCase());
                            state.expenseCategories = ['Miscellaneous', name, ...rest];
                            saveData();
                        }
                        return name;
                    }
                    return v || 'Miscellaneous';
                })();
                if (!category) return;

                const expense = {
                    id: generateID('expenses'),
                    date: getTodayDateString(),
                    time: now.toLocaleTimeString(),
                    timestamp: now.getTime(),
                    description: desc,
                    category: category,
                    amount: amount,
                    payment: document.getElementById('expensePayment')?.value || 'Cash',
                    comment: document.getElementById('expenseComment')?.value.trim() || '',
                    title: desc,
                    updatedAt: now.getTime()
                };

                state.expenses.push(expense);
                saveData();
                render();
                showToast('Expense added', 'success');

                try { await upsertOne('expenses', { date: expense.date, time: expense.time, timestamp: expense.timestamp, description: expense.description, category: expense.category, amount: expense.amount, payment: expense.payment, comment: expense.comment }); } catch {}
                if (syncEnabled) syncInBackground();

                try {
                    if (descEl) descEl.value = '';
                    if (amtEl) { amtEl.value = ''; amtEl.dataset.numeric = ''; }
                    const cm = document.getElementById('expenseComment'); if (cm) cm.value = '';
                    const catSel = document.getElementById('expenseCategory'); if (catSel) { catSel.value = 'Miscellaneous'; toggleExpenseCategory(); }
                } catch {}
            } finally { state.__savingExpense = false; }
        }

        async function toggleExpenseInlineEdit(ts) { openExpenseInlineEditModal(ts); }
        async function saveExpenseInlineEdit(ts) { const idx = (state.expenses || []).findIndex(x => x.timestamp === ts); if (idx === -1) { showToast('Expense not found', 'error'); return false; } const e = state.expenses[idx]; const desc = document.getElementById(`expDesc_${ts}`)?.value || e.description; const amt = parseMoney(document.getElementById(`expAmt_${ts}`)?.value || e.amount); const pay = document.getElementById(`expPay_${ts}`)?.value || e.payment; const comm = document.getElementById(`expComment_${ts}`)?.value || e.comment || ''; if (isNaN(amt) || amt <= 0) { showToast('Invalid amount', 'error'); return false; } e.description = String(desc).trim(); e.title = e.description; e.amount = amt; e.payment = pay; e.comment = comm; e.updatedAt = Date.now(); saveData(); state.inlineEditExpenses[ts] = false; render(); showToast('Expense updated', 'success'); if (syncEnabled) { try { await upsertOne('expenses', { date: e.date, time: e.time, timestamp: e.timestamp, description: e.description, category: e.category, amount: e.amount, payment: e.payment, comment: e.comment }); } catch { } syncInBackground(); } return true; }

        function deleteExpenseIndex(i) {
            const e = state.expenses[i];
            if (!e) return showToast("Expense not found", "error");
            deleteExpenseByTimestamp(e.timestamp);
        }

        function deleteExpenseByTimestamp(ts) {
            const e = (state.expenses || []).find(x => x.timestamp === ts);
            if (!e) return showToast("Expense not found", "error");
            return deleteExpenseById(e.id);
        }

        async function deleteExpenseById(id) {
            try { playDeleteSound(); } catch (e) { }
            const ok = await requirePinForDestructive('delete');
            if (!ok) { showToast('Delete failed: PIN required', 'error'); return; }
            
            const idx = (state.expenses || []).findIndex(x => x.id === id);
            if (idx !== -1) {
                const exp = state.expenses[idx];
                try {
                    if (navigator.onLine && syncEnabled && currentUser) {
                        await deleteOne('expenses', { timestamp: exp.timestamp });
                    } else {
                        await deleteOne('expenses', { timestamp: exp.timestamp });
                    }
                } catch { }
                state.expenses.splice(idx, 1);
                saveData();
                render();
                showToast("Expense deleted", "success", "Undo", function(){ try { state.expenses.push(exp); saveData(); render(); } catch {} });
                if (syncEnabled) syncInBackground();
            } else {
                showToast("Expense not found", "error");
            }
        }

        function renderIncome() {
            const stats = getStats();
            let filtered = (state.income || []).slice();
            filtered = filtered.filter(i => !(i && i.deleted === true));
            if (state.searchPeriod) {
                const q = state.searchPeriod.toLowerCase();
                filtered = filtered.filter(i => String(i.source || '').toLowerCase().includes(q) || String(i.comment || '').toLowerCase().includes(q));
            }
            if (state.filterDateFrom) filtered = filtered.filter(i => new Date(i.date) >= new Date(state.filterDateFrom));
            if (state.filterDateTo) filtered = filtered.filter(i => new Date(i.date) <= new Date(state.filterDateTo));
            if (state.filterSource) filtered = filtered.filter(i => i.source === state.filterSource);
            return `
                <div class="stat-grid">
                    <div class="stat-card">
                        <div class="stat-label">TOTAL INCOME</div>
                        <div class="stat-value" style="color:#ffffff;">${formatNumber(stats.totalIncome)} Tsh</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">MONTH INCOME</div>
                        <div class="stat-value" style="color:#ffffff;">${formatNumber(stats.monthIncome)} Tsh</div>
                    </div>
                </div>

                <div class="card">
                    <h2>Add Income</h2>
                    <div class="card-header-buttons">
                        <button class="btn-small" onclick="openIncomeReportRangeModal()">📄 Income Report (PDF)</button>
                    </div>
                    <form onsubmit="addIncome(event)">
                        <div class="form-group">
                            <label>Source</label>
                            <select id="incomeSource" onchange="toggleIncomeSource()">
                                <option value="">-- Select Source --</option>
                                <option value="new">+ Add New Source</option>
                                ${(() => { let srcs = (state.incomeSources || ['Miscellaneous', 'Personal', 'Loan', 'Gift', 'Tip', 'Other']).slice(); const idx = srcs.findIndex(s => String(s).toLowerCase() === 'miscellaneous'); if (idx === -1) srcs.unshift('Miscellaneous'); else { const m = srcs.splice(idx, 1)[0]; srcs.unshift(m); } return srcs.map((s) => `<option value=\"${s}\">${s}</option>`).join(''); })()}
                            </select>
                        </div>
                        <div id="incomeLoanFormGroup" style="display:none; border:1px dashed #999; border-radius:8px; padding:8px; margin-bottom:8px;">
                            <div class="form-group" data-label="Borrower/Institution">
                                <input type="text" id="loanBorrowName" placeholder="Person/Institution">
                            </div>
                            <div class="form-group" data-label="Loan Amount">
                                <input type="text" id="loanBorrowAmount" class="money-input" placeholder="0.00">
                            </div>
                            <div class="form-group" data-label="Date">
                                <input type="date" id="loanBorrowDate" value="${getTodayDateString()}">
                            </div>
                            <div class="form-group" data-label="Notes">
                                <textarea id="loanBorrowNotes" placeholder="Notes..."></textarea>
                            </div>
                            <div class="flex-gap">
                                <button class="btn-small btn-success" type="button" onclick="saveBorrowedLoanFromIncome()">Save Borrowed Loan</button>
                            </div>
                        </div>
                        <div class="form-group" id="incomeSourceNewGroup" style="display:none;">
                            <label>New Source</label>
                            <input type="text" id="incomeSourceNew" placeholder="e.g., Donation">
                        </div>
                        <div class="form-group">
                            <label>Amount</label>
                            <input type="text" id="incomeAmount" class="money-input" placeholder="0" required>
                        </div>
                        <div class="form-group">
                            <label>Payment Method</label>
                            <select id="incomePayment">
                                <option>Cash</option>
                                <option>Card</option>
                                <option>Mobile Money</option>
                                <option>M-Pesa Lipa Number</option>
                                <option>Bank Transfer</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Comment (Optional)</label>
                            <textarea id="incomeComment" placeholder="Additional notes..."></textarea>
                        </div>
                        <div class="form-group">
                            <label>Capital</label>
                            <select id="incomeCapitalMode">
                                <option value="no">Is Not Capital</option>
                                <option value="yes" selected>Is Capital</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>10% (Tithing)</label>
                            <select id="incomeTithingMode">
                                <option value="with">With 10%</option>
                                <option value="without" selected>Without 10%</option>
                            </select>
                        </div>
                        <button type="submit">Add Income</button>
                        <button class="btn-small btn-secondary" type="button" onclick="cancelIncomeForm()">Cancel</button>
                    </form>
                </div>

                <div class="card">
                    <h2>Recent Income (${filtered.length})</h2>
                    <div class="card-header-buttons"><button class="btn-small" onclick="copyAllIncome()">📋 Copy All</button></div>
                    <div class="search-box">
                        <input type="search" name="search_field_unique_${Date.now()}" autocomplete="off" id="incomeSearchInput" placeholder="🔍 Search income..." oninput="updateSearchPeriod(this.value); toggleClearButton('incomeSearchInput', 'incomeClearBtn')" value="${state.searchPeriod || ''}" readonly onfocus="this.removeAttribute('readonly');">
                        <button id="incomeClearBtn" class="clear-btn btn-small btn-secondary hint ${String(state.searchPeriod || '').trim() ? 'visible' : ''}" onclick="clearIncomeSearch()">Clear</button>
                    </div>
                    <div class="filter-row">
                        <input type="date" placeholder="From" onchange="updateFilterDateFrom(this.value)" value="${state.filterDateFrom || ''}">
                        <input type="date" placeholder="To" onchange="updateFilterDateTo(this.value)" value="${state.filterDateTo || ''}">
                        <select onchange="updateFilterSource(this.value)">
                            <option value="">All Sources</option>
                            ${[...new Set((state.income || []).map(i => i.source))].filter(s => !!s).sort((a, b) => String(a).localeCompare(String(b))).map(s => `<option value="${s}" ${state.filterSource === s ? 'selected' : ''}>${s}</option>`).join('')}
                        </select>
                        <button class="btn-small btn-secondary" onclick="clearFilters()">Clear</button>
                    </div>
                    ${filtered.length > 0 ? `
                    <div class="bulk-actions">
                        <input type="checkbox" id="selectAll_income" onchange="toggleSelectAll('income')" class="checkbox-select">
                        <label for="selectAll_income">Select All</label>
                        <span style="color:#666;font-size:12px;margin-left:8px;">${getSelectedCount('income')} selected</span>
                        <button class="btn-small btn-danger" onclick="bulkDelete('income')" ${!hasSelected('income') ? 'disabled' : ''}>🗑️ Delete Selected</button>
                    </div>
                    ` : ''}
                    <div id="incomeList" class="list-scroll-container">
                        ${(() => {
                    filtered.sort((a, b) => Number(b.timestamp) - Number(a.timestamp));
                    const arr = filtered.slice(); const count = (state.listShowCount && state.listShowCount.income) ? state.listShowCount.income : 3; return arr.slice(0, count).map((i, idx) => `
                        <div class="item">
                          <div style="display:flex;gap:12px;align-items:start;">
                            <input type="checkbox" class="checkbox-select" ${state.selectedItems.income && state.selectedItems.income[i.id] ? 'checked' : ''} onchange="toggleSelect('income','${i.id}')">
                            <div style="flex:1;">
                                <div class="item-header">
                                    <span class="item-title">${i.source}${(i && (i.asCapital === true || i.as_capital === true)) ? ' <span class="badge badge-success">Capital</span>' : ''}${(i && (i.includeTithing === false || i.include_in_tithing === false)) ? ' <span class="badge badge-warning">No 10%</span>' : ''}</span>
                                    <span style="color:#2e7d32;font-weight:700;">${formatNumber(i.amount)} Tsh</span>
                                </div>
                                <div class="item-subtitle">${i.date} | ${i.payment}${i.comment ? '<br>💬 ' + i.comment : ''}</div>
                                ${(() => {
                            const idxRef = (state.income || []).indexOf(i); const editing = state.inlineEditIncome && state.inlineEditIncome[i.timestamp]; return editing ? `
                                <div class=\"form-group\" data-label=\"Source\"><input type=\"text\" id=\"incSource_${i.timestamp}\" value=\"${i.source}\" placeholder=\"Source\"></div>
                                <div class=\"form-group\" data-label=\"Amount\"><input type=\"text\" id=\"incAmt_${i.timestamp}\" class=\"money-input\" value=\"${i.amount}\" placeholder=\"Amount\"></div>
                                <div class=\"form-group\" data-label=\"Payment\"><select id=\"incPay_${i.timestamp}\"><option ${i.payment === 'Cash' ? 'selected' : ''}>Cash</option><option ${i.payment === 'Card' ? 'selected' : ''}>Card</option><option ${i.payment === 'Mobile Money' ? 'selected' : ''}>Mobile Money</option><option ${i.payment === 'Bank Transfer' ? 'selected' : ''}>Bank Transfer</option></select></div>
                                <div class=\"form-group\" data-label=\"Comment\"><input type=\"text\" id=\"incComment_${i.timestamp}\" value=\"${i.comment || ''}\" placeholder=\"Comment\"></div>
                                <div class=\"form-group\" data-label=\"Capital\"><select id=\"incCapital_${i.timestamp}\"><option value=\"no\" ${!(i && (i.asCapital === true || i.as_capital === true)) ? 'selected' : ''}>Is Not Capital</option><option value=\"yes\" ${(i && (i.asCapital === true || i.as_capital === true)) ? 'selected' : ''}>Is Capital</option></select></div>
                                <div class=\"form-group\" data-label=\"10% (Tithing)\"><label style=\"display:flex;gap:10px;align-items:center;user-select:none;\"><input type=\"checkbox\" id=\"incTithing_${i.timestamp}\" ${(i && (i.includeTithing === false || i.include_in_tithing === false)) ? '' : 'checked'}>Include in 10%</label></div>
                                <div class=\"flex-gap\" style=\"margin-top:8px;\"><button class=\"btn-small btn-success\" onclick=\"saveIncomeInlineEdit(${idxRef})\">Save</button><button class=\"btn-small btn-secondary\" onclick=\"toggleIncomeInlineEdit(${idxRef})\">Cancel</button><button class=\"btn-small\" style=\"${state.theme === 'dark' ? 'background:#1f2937;color:#e5e7eb;border:1px solid #374151;' : 'background:#e8e8e8;color:#333;border:1px solid #999;'}\" onclick=\"openItemTagsModal('income','${i.id}')\">📌 Tag</button></div>
                                ` : `
                                <div class=\"flex-gap\" style=\"margin-top:8px;\"><button class=\"btn-small\" onclick=\"toggleIncomeInlineEdit(${idxRef})\">Edit</button><button class=\"btn-small btn-danger btn-delete\" data-action=\"delete\" onclick=\"deleteIncomeIndex(${idxRef})\">Delete</button><button class=\"btn-small\" style=\"${state.theme === 'dark' ? 'background:#1f2937;color:#e5e7eb;border:1px solid #374151;' : 'background:#e8e8e8;color:#333;border:1px solid #999;'}\" onclick=\"openItemTagsModal('income','${i.id}')\">📌 Tag</button></div>
                                `;
                        })()}
                            ${renderTagBadges(i)}
                            </div>
                          </div>
                        </div>
                        `).join('') || '<p style="text-align:center;color:#666;">No income yet</p>';
                })()}
                    </div>
                    ${(() => { const total = filtered.length; const count = (state.listShowCount && state.listShowCount.income) ? state.listShowCount.income : 3; const hasMore = count < total; return `<div class=\"flex-gap\" style=\"justify-content:center;margin:8px 0;flex-wrap:nowrap;\"><button class=\"collapse-btn\" onclick=\"${hasMore ? `showMoreList('income')` : `collapseList('income')`}\"><span class=\"collapse-icon ${hasMore ? '' : 'expanded'}\">▼</span><span>${hasMore ? 'See more' : 'Hide'}</span></button><button class=\"collapse-btn\" onclick=\"showAllList('income')\"><span class=\"collapse-icon\">▼</span><span>Show all</span></button></div>`; })()}
                </div>
            `;
        }

        function updateFilterSource(v) { state.filterSource = v; render(); }

        function toggleIncomeSource() {
            const sel = document.getElementById('incomeSource');
            const grp = document.getElementById('incomeSourceNewGroup');
            const loanGrp = document.getElementById('incomeLoanFormGroup');
            if (!sel || !grp) return;
            grp.style.display = sel.value === 'new' ? '' : 'none';
            if (loanGrp) loanGrp.style.display = sel.value === 'Loan' ? '' : 'none';
        }
        function cancelIncomeForm() {
            try {
                const src = document.getElementById('incomeSource'); if (src) { src.value = ''; toggleIncomeSource(); }
                const ns = document.getElementById('incomeSourceNew'); if (ns) ns.value = '';
                const amt = document.getElementById('incomeAmount'); if (amt) amt.value = '';
                const pay = document.getElementById('incomePayment'); if (pay) pay.value = 'Cash';
                const cm = document.getElementById('incomeComment'); if (cm) cm.value = '';
                const cap = document.getElementById('incomeCapitalMode'); if (cap) cap.value = 'yes';
                const tithe = document.getElementById('incomeTithingMode'); if (tithe) tithe.value = 'without';
                const loanGrp = document.getElementById('incomeLoanFormGroup'); if (loanGrp) loanGrp.style.display = 'none';
            } catch {}
        }

        async function addIncome(e) {
            e.preventDefault();
            const amount = parseMoney(document.getElementById('incomeAmount').value);
            if (isNaN(amount) || amount <= 0) { return showToast('Please enter a valid amount', 'error'); }
            const now = new Date();
            let srcSel = document.getElementById('incomeSource').value;
            let srcName = srcSel;
            if (srcSel === 'new') {
                const raw = (document.getElementById('incomeSourceNew').value || '').trim();
                if (!raw) { return showToast('Enter a source name', 'error'); }
                srcName = capitalizeFirstWordValue(raw);
                const exists = (state.incomeSources || []).some(s => String(s).toLowerCase() === srcName.toLowerCase());
                if (!exists) {
                    const rest = (state.incomeSources || []).filter(s => String(s).toLowerCase() !== 'miscellaneous' && String(s).toLowerCase() !== srcName.toLowerCase());
                    state.incomeSources = ['Miscellaneous', srcName, ...rest];
                    saveData();
                }
            }
            const item = {
                id: generateID('income'),
                date: getTodayDateString(),
                time: now.toLocaleTimeString(),
                timestamp: Date.now(),
                source: srcName,
                amount,
                payment: document.getElementById('incomePayment').value,
                comment: document.getElementById('incomeComment').value,
                asCapital: (String(document.getElementById('incomeCapitalMode')?.value || 'no') === 'yes'),
                includeTithing: (String(document.getElementById('incomeTithingMode')?.value || 'without') !== 'without')
            };
            state.income = state.income || [];
            state.income.push(item);
            saveData();
            render();
            showToast('Income added', 'success');
            if (syncEnabled) { try { await upsertOne('income', { date: item.date, time: item.time, timestamp: item.timestamp, source: item.source, amount: item.amount, payment: item.payment, comment: item.comment, as_capital: item.asCapital === true, include_in_tithing: item.includeTithing !== false }); } catch {} }
        }

        async function saveBorrowedLoanFromIncome(){
            const name = String(document.getElementById('loanBorrowName')?.value || '').trim();
            const rawAmt = String(document.getElementById('loanBorrowAmount')?.value || '').trim();
            const date = String(document.getElementById('loanBorrowDate')?.value || '').trim();
            const notes = String(document.getElementById('loanBorrowNotes')?.value || '').trim();
            const amt = parseMoney(rawAmt);
            if (!name || !date || isNaN(amt) || amt <= 0) { showToast('Fill loan details correctly', 'error'); return; }
            await addLoan(name, 'taken', amt, date, notes);
            const incAmtEl = document.getElementById('incomeAmount');
            const incCommentEl = document.getElementById('incomeComment');
            if (incAmtEl) incAmtEl.value = String(amt);
            if (incCommentEl) incCommentEl.value = (`Loan intake: ${name}` + (notes ? ` — ${notes}` : ''));
            showToast('Borrowed loan recorded; income fields prefilled', 'success');
            try { document.getElementById('incomeSource').value = 'Loan'; toggleIncomeSource(); } catch {}
        }

        async function toggleIncomeInlineEdit(i) { openIncomeInlineEditModal(i); }
        async function saveIncomeInlineEdit(i) { const it = (state.income || [])[i]; if (!it) return false; const src = document.getElementById(`incSource_${it.timestamp}`)?.value || it.source; const amt = parseMoney(document.getElementById(`incAmt_${it.timestamp}`)?.value || it.amount); const pay = document.getElementById(`incPay_${it.timestamp}`)?.value || it.payment; const comm = document.getElementById(`incComment_${it.timestamp}`)?.value || it.comment || ''; const asCap = (String(document.getElementById(`incCapital_${it.timestamp}`)?.value || (it.asCapital === true || it.as_capital === true ? 'yes' : 'no')) === 'yes'); const includeT = !!document.getElementById(`incTithing_${it.timestamp}`)?.checked; if (isNaN(amt) || amt <= 0) { showToast('Invalid amount', 'error'); return false; } it.source = src; it.amount = amt; it.payment = pay; it.comment = comm; it.asCapital = asCap; it.includeTithing = includeT; saveData(); state.inlineEditIncome[it.timestamp] = false; render(); showToast('Income updated', 'success'); if (syncEnabled) { try { await upsertOne('income', { date: it.date, time: it.time, timestamp: it.timestamp, source: it.source, amount: it.amount, payment: it.payment, comment: it.comment || '', as_capital: it.asCapital === true, include_in_tithing: it.includeTithing !== false }); } catch {} } return true; }

        async function deleteIncomeIndex(i) {
            try { playDeleteSound(); } catch (e) { }
            const ok = await requirePinForDestructive('delete');
            if (!ok) { showToast('Delete failed: PIN required', 'error'); return; }
            const it = (state.income || [])[i];
            if (it) {
                try { await deleteOne('income', { timestamp: it.timestamp }); } catch { }
                state.income.splice(i, 1); saveData(); render();
                showToast('Income deleted', 'success');
            }
        }

        function renderInventory() {
            const trackedProducts = state.products.filter(p => p.hasStock !== false && !(p && p.deleted === true));
            const lowStock = trackedProducts.filter(p => {
                const inv = state.inventory[p.name] || { stock: 0, minAlert: 5 };
                return inv.stock <= inv.minAlert;
            });
            const q = state.stockSearch || '';
            const totalUnits = trackedProducts.reduce((sum, p) => sum + ((state.inventory[p.name] || { stock: 0 }).stock || 0), 0);
            const totalValue = trackedProducts.reduce((sum, p) => sum + (((state.inventory[p.name] || { stock: 0 }).stock || 0) * (p.cost || 0)), 0);

            return `
                ${lowStock.length > 0 ? `
                    <div class="alert-box-danger">
                        <strong>⚠️ ${lowStock.length} Products Low on Stock!</strong>
                    </div>
                ` : ''
                }

            <div class="card">
                <div class="flex-between">
                    <h2>Stock Levels</h2>
                    <div class="search-box" style="max-width:260px;">
                        <input type="search" name="search_field_unique_${Date.now()}" autocomplete="off" id="stockSearch" placeholder="🔍 Search stock..." oninput="searchStock(this.value)" value="${q}" readonly onfocus="this.removeAttribute('readonly');" />
                    </div>
                </div>
                <div class="flex-gap" style="margin-top:8px;">
                    <span class="badge">Items: ${trackedProducts.length}</span>
                    <span class="badge ${lowStock.length > 0 ? 'badge-danger' : 'badge-success'}">Low Stock: ${lowStock.length}</span>
                    <span class="badge">Units: ${formatNumber(totalUnits)}</span>
                    <span class="badge">Value: ${formatNumber(totalValue)} Tsh</span>
                </div>
                <div id="stockList" class="list-scroll-container">${renderStockList(q)}</div>
                ${(() => { const total = state.products.filter(p => p.hasStock !== false).filter(p => !q || p.name.toLowerCase().includes(q.toLowerCase()) || String(p.category || '').toLowerCase().includes(q.toLowerCase())).length; const count = (state.listShowCount && state.listShowCount.inventory) ? state.listShowCount.inventory : 3; const hasMore = count < total; return `<div class=\"flex-gap\" style=\"justify-content:center;margin:8px 0;flex-wrap:nowrap;\"><button class=\"collapse-btn\" onclick=\"${hasMore ? `showMoreList('inventory')` : `collapseList('inventory')`}\"><span class=\"collapse-icon ${hasMore ? '' : 'expanded'}\">▼</span><span>${hasMore ? 'See more' : 'Hide'}</span></button><button class=\"collapse-btn\" onclick=\"showAllList('inventory')\"><span class=\"collapse-icon\">▼</span><span>Show all</span></button></div>`; })()}
                </div>
            `;
        }

        function renderStockList(query) {
            const q = String(query || '').toLowerCase();
            const trackedProducts = state.products.filter(p => p.hasStock !== false && !(p && p.deleted === true));
            const count = (state.listShowCount && state.listShowCount.inventory) ? state.listShowCount.inventory : 3;
            return trackedProducts.filter(p => !q || p.name.toLowerCase().includes(q) || String(p.category || '').toLowerCase().includes(q)).slice(0, count).map(p => {
                const inv = state.inventory[p.name] || { stock: 0, minAlert: 5 };
                const isLow = inv.stock <= inv.minAlert;
                const stockValue = inv.stock * p.cost;
                return `
                <div class="item" style="${isLow ? 'border-left: 4px solid #d32f2f;' : ''}">
                                <div class="item-header">
                                    <span class="item-title">${p.name}</span>
                                    <span class="badge ${isLow ? 'badge-danger' : 'badge-success'}">
                                        ${isLow ? '⚠️ LOW' : '✅ OK'}
                                    </span>
                                </div>
                                <div class="item-subtitle">
                                    Stock: ${inv.stock} units | Min Alert: ${inv.minAlert}<br>
                                    Value:  ${formatNumber(stockValue)} Tsh
                                </div>
                                <div class="flex-gap" style="margin-top: 8px;">
                                    <button class="btn-success btn-small" onclick="adjustStock('${p.name}', 10)">+10</button>
                                    <button class="btn-success btn-small" onclick="adjustStock('${p.name}', 1)">+1</button>
                                    <button class="btn-danger btn-small" onclick="adjustStock('${p.name}', -1)">-1</button>
                                    <input type="number" id="inv_input_${encodeURIComponent(p.name)}" value="${inv.stock}" min="0" style="width:80px;padding:6px;" />
                                    <button class="btn-small" onclick="saveStockFor('${p.name}')">Save</button>
                                    <button class="btn-small btn-secondary" onclick="setMinAlert('${p.name}')">⚠️ ${inv.minAlert}</button>
                                </div>
                            </div >
                `;
            }).join('') || '<p style="text-align: center; color: #666;">No stock-tracked items yet</p>';
        }

        function searchStock(q) {
            state.stockSearch = q;
            const el = document.getElementById('stockList');
            if (el) el.innerHTML = renderStockList(q);
        }

        // Unified Inventory Tab: Purchases + Stock
        function renderInventoryTab() {
            // Summary
            const purchases = (state.inventoryPurchases || []).filter(p => !(p && p.deleted === true));
            const cycles = (state.inventoryPurchaseCycles || []).filter(c => !(c && c.deleted === true));
            const totalSpent = purchases.reduce((s, p) => s + (Number(p.totalCost) || Number(p.buyingPrice) || 0), 0);
            const uniqueSuppliers = Array.from(new Set(purchases.map(p => (p.supplierName || '').trim()).filter(Boolean))).length;

            // Filters
            const filter = state.inventoryFilters || {};
            const cycleOptions = cycles.length > 0
                ? `<option value="">All Periods</option>` + cycles.map(c => `<option value="${c.number}">Period ${c.number} ${c.title ? '– ' + c.title : ''}</option>`).join('')
                : '<option value="">No Periods yet</option>';

            // Filtered purchases
            const filtered = purchases.filter(p => {
                const matchPeriod = !filter.PeriodNumber || String(p.cycleNumber) === String(filter.PeriodNumber);
                const matchSupplier = !filter.supplier || (p.supplierName || '').toLowerCase().includes(filter.supplier.toLowerCase());
                const df = filter.dateFrom ? new Date(filter.dateFrom).getTime() : null;
                const dt = filter.dateTo ? new Date(filter.dateTo).getTime() : null;
                const ts = p.timestamp || (p.purchaseDate ? new Date(p.purchaseDate).getTime() : 0);
                const matchDate = (!df || ts >= df) && (!dt || ts <= dt);
                return matchPeriod && matchSupplier && matchDate;
            });

            // Group by Period
            const showCount = state.inventoryPeriodsShowCount || 3;
            const cyclesSorted = cycles.slice().sort((a, b) => b.number - a.number);
            const visibleCycles = cyclesSorted.slice(0, showCount);
            const groupedHTML = visibleCycles.map(cycle => {
                const cps = filtered.filter(p => p.cycleNumber === cycle.number).sort((a, b) => Number(b.timestamp || 0) - Number(a.timestamp || 0));
                const cycleTotal = cps.reduce((sum, p) => sum + (Number(p.totalCost) || Number(p.buyingPrice) || 0), 0);
                const cycleStart = cycle.startDate || (cps[0]?.purchaseDate) || '';
                const nextCycle = cycles.find(c => c.number === cycle.number + 1);
                const cycleEnd = cycle.endDate || (nextCycle?.startDate) || '';
                let lastedText = '';
                if (cycleStart && cycleEnd) {
                    const days = Math.round((new Date(cycleEnd).getTime() - new Date(cycleStart).getTime()) / (1000 * 60 * 60 * 24));
                    if (!isNaN(days)) lastedText = `Lasted: ${days} day${days === 1 ? '' : 's'} `;
                }
                return `
                <div class="card">
                    <div class="flex-between">
                        <h2>Period ${cycle.number} ${cycle.title ? '– ' + cycle.title : ''}</h2>
                        <div class="flex-gap">
                            <span class="badge">Items: ${cps.length}</span>
                            <span class="badge">Spent: <span class="money-text">${formatNumber(cycleTotal)} Tsh</span></span>
                            ${lastedText ? `<span class="badge">${lastedText}</span>` : ''}
                            <button class="btn-small" onclick="downloadInventoryCyclePDF(${cycle.number}, 'download')">📥 Period PDF</button>
                            <button class="btn-small" onclick="downloadInventoryCyclePDF(${cycle.number}, 'view')">View</button>
                            <button class="btn-small btn-danger btn-delete" data-action="delete" onclick="terminateInventoryPeriod(${cycle.number})">✖ Terminate</button>
                        </div>
                    </div>
                        ${cps.length === 0 ? '<p style="color:#666">No purchases in this Period</p>' : `
                            <div class="list-scroll-container"><div class="period-items">
                                ${cps.map(p => `
                                    <div class="period-item">
                                        <div class="item-header">
                                            <span class="item-title">${escapeHTML(p.itemName || '')}</span>
                                            <span class="badge">× ${p.quantity || 1}</span>
                                        </div>
                                        <div class="item-subtitle">
                                            ${escapeHTML(p.purchaseDate || '')} ${escapeHTML(p.time || '')}<br>
                                            Unit: <span class="money-text">${formatNumber(p.unitCost || p.buyingPrice)} Tsh</span><br>
                                            Total: <span class="money-text">${formatNumber(p.totalCost || (p.buyingPrice || 0))} Tsh</span>
                                            ${p.discount ? `<br>Discount: <span class="money-text">${formatNumber(p.discount)} Tsh</span>` : ''}
                                        </div>
                                        <div class="period-actions">
                                            <button class="btn-small" onclick="openInventoryPurchaseItemDialog(${p.timestamp})">View</button>
                                            <button class="btn-small" onclick="openUpdateInventoryForPurchase(${p.timestamp})">Update</button>
                                            <button class="btn-small btn-danger btn-delete" data-action="delete" onclick="deleteInventoryPurchaseByTimestamp(${p.timestamp})">Delete</button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div></div>
                        `}
                    </div>
                `;
            }).join('');

            // Build UI
            const summary = `
                <div class="card">
                    <div class="flex-between">
                        <h2>Inventory</h2>
                        <div class="flex-gap">
                            <button class="btn-success" onclick="openInventoryModal()">➕ Add Inventory Purchase</button>
                            <button class="btn-success" onclick="openInventoryPurchasesImportModal()">➕ Add Inventory Purchase from CSV</button>
                            <button class="btn-small" onclick="generateInventoryReport('csv')">📥 Generate Report (CSV)</button>
                            <button class="btn-small" onclick="downloadInventoryPurchasesReportPDF()">📄 Generate Report (PDF)</button>
                            <button class="btn-small" onclick="openStocksheetModal()">📄 Generate Stock Sheet (PDF)</button>
                        </div>
                    </div>
                    <div class="flex-gap" style="margin-top:8px;">
                        <span class="badge">Purchases: ${purchases.length}</span>
                        <span class="badge">Suppliers: ${uniqueSuppliers}</span>
                        <span class="badge">Total Spent: ${formatNumber(totalSpent)} Tsh</span>
                    </div>
                </div>`;

            const filters = `
                <div class="card">
                    <h3>Filter</h3>
                    <div class="grid-2" style="gap:12px;">
                        <div>
                            <label>Period</label>
                            <select id="invFilterPeriod" onchange="updateInventoryFilter('PeriodNumber', this.value)">${cycleOptions}</select>
                        </div>
                        <div>
                            <label>Supplier</label>
                            <input id="invFilterSupplier" type="text" value="${filter.supplier || ''}" placeholder="Supplier name" oninput="updateInventoryFilter('supplier', this.value)" />
                        </div>
                        <div>
                            <label>From</label>
                            <input id="invFilterFrom" type="date" value="${filter.dateFrom || ''}" onchange="updateInventoryFilter('dateFrom', this.value)" />
                        </div>
                        <div>
                            <label>To</label>
                            <input id="invFilterTo" type="date" value="${filter.dateTo || ''}" onchange="updateInventoryFilter('dateTo', this.value)" />
                        </div>
                    </div>
                </div>`;

            // Embed the existing stock view
            const stock = renderInventory();

            const moreBtn = (() => { const total = cyclesSorted.length; const hasMore = showCount < total; return `<div class=\"flex-gap\" style=\"justify-content:center;margin:8px 0;flex-wrap:nowrap;\">${hasMore ? `<button class=\"collapse-btn\" onclick=\"showMoreInventoryPeriods()\"><span class=\"collapse-icon\">▼</span><span>See more</span></button>` : `<button class=\"collapse-btn\" onclick=\"collapseInventoryPeriods()\"><span class=\"collapse-icon expanded\">▼</span><span>Hide</span></button>`}<button class=\"collapse-btn\" onclick=\"(function(){state.inventoryPeriodsShowCount=100000;render();})()\"><span class=\"collapse-icon\">▼</span><span>Show all</span></button></div>`; })();
            return summary + filters + (groupedHTML || '<p style="text-align:center;color:#666;">No Periods yet. Add an inventory purchase to create a new Period.</p>') + moreBtn + stock;
        }

        function showMoreInventoryPeriods() {
            const total = (state.inventoryPurchaseCycles || []).length;
            const current = state.inventoryPeriodsShowCount || 3;
            state.inventoryPeriodsShowCount = Math.min(total, current + 3);
            saveData();
            render();
        }

        function collapseInventoryPeriods() {
            state.inventoryPeriodsShowCount = 3;
            saveData();
            render();
        }

        function openInventoryForPeriod(num) {
            openInventoryModal();
            setTimeout(() => {
                try {
                    const perSel = document.getElementById('invPeriodSelect');
                    const chkNew = document.getElementById('invCreateNewPeriod');
                    if (perSel) perSel.value = String(num);
                    if (chkNew) chkNew.checked = false;
                } catch { }
            }, 50);
        }

        function processPlannedPurchases() {
            const todayTs = new Date(getTodayDateString()).getTime();
            (state.inventoryPurchases || []).forEach(p => {
                const pt = new Date(p.purchaseDate || getTodayDateString()).getTime();
                if (p.planned && !p.activated && pt <= todayTs) {
                    updateProductStock(p.itemName, p.quantity, true);
                    p.activated = true;
                }
            });
        }

        async function terminateInventoryPeriod(num) {
            try { playDeleteSound(); } catch (e) { }
            const ok = await requirePinForDestructive('delete');
            if (!ok) { showToast('Delete failed: PIN required', 'error'); return; }
            const purchases = (state.inventoryPurchases || []).filter(p => p.cycleNumber === num);
            purchases.forEach(p => {
                const inv = state.inventory[p.itemName] || { stock: 0, minAlert: 5 };
                inv.stock = Math.max(0, (inv.stock || 0) - (p.quantity || 0));
                state.inventory[p.itemName] = inv;
            });
            try { purchases.forEach(p => { try { deleteOne('inventory_purchases', { timestamp: p.timestamp }); } catch { } }); } catch { }
            state.inventoryPurchases = (state.inventoryPurchases || []).filter(p => p.cycleNumber !== num);
            state.inventoryPurchaseCycles = (state.inventoryPurchaseCycles || []).filter(c => c.number !== num);
            try {
                const idx = (state.expenses || []).findIndex(e => e.category === 'Inventory Purchase' && String(e.comment || '').trim() === `Period ${num}`);
                if (idx !== -1) {
                    const ex = state.expenses[idx];
                    try { deleteOne('expenses', { id: ex.id }); } catch { }
                    state.expenses.splice(idx, 1);
                }
            } catch { }
            saveData();
            render();
            showToast('Period terminated', 'success');
            (async () => {
                if (syncEnabled && currentUser) {
                    try {
                        const { error: perr } = await supabase
                            .from('inventory_purchase_periods')
                            .delete()
                            .match({ user_id: currentUser.id, period_number: num });
                        if (perr) console.warn('Cloud period delete error:', perr.message || perr);
                        const { error: eerr } = await supabase
                            .from('expenses')
                            .delete()
                            .match({ user_id: currentUser.id, comment: `Period ${num}`, category: 'Inventory Purchase' });
                        if (eerr) console.warn('Cloud expenses delete error:', eerr.message || eerr);
                        const affected = Array.from(new Set(purchases.map(p => p.itemName)));
                        for (const name of affected) {
                            const inv = state.inventory[name] || { stock: 0, minAlert: 5 };
                            await upsertOne('inventory', { product_name: name, stock: inv.stock || 0, min_alert: inv.minAlert || 5 });
                        }
                        syncInBackground();
                    } catch (err) {
                        console.warn('Cloud update after termination failed:', err?.message || err);
                    }
                }
            })();
        }

        function openInventoryPurchaseItemDialog(ts) {
            try {
                const p = (state.inventoryPurchases || []).find(x => x.timestamp === ts);
                if (!p) { showToast('Purchase not found', 'error'); return; }
                const cycle = (state.inventoryPurchaseCycles || []).find(c => c.number === p.cycleNumber);
                const html = `
                    <div class="card">
                        <div class="flex-between">
                            <h2>Inventory Item</h2>
                            <button class="quick-nav-btn" onclick="closeFloatModal()">Close ✖</button>
                        </div>
                        <div class="item-subtitle" style="margin-bottom:8px;">
                            Period ${p.cycleNumber} ${cycle && cycle.title ? '– ' + escapeHTML(cycle.title) : ''}
                        </div>
                        <div class="grid-2" style="gap:8px;">
                            <div>
                                <label>Item</label>
                                <div>${escapeHTML(p.itemName || '')}</div>
                            </div>
                            <div>
                                <label>Date & Time</label>
                                <div>${escapeHTML(p.purchaseDate || '')} ${escapeHTML(p.time || '')}</div>
                            </div>
                            <div>
                                <label>Quantity</label>
                                <div>${String(p.quantity || 1)}</div>
                            </div>
                            <div>
                                <label>Unit Cost</label>
                                <div>${formatNumber(p.unitCost || p.buyingPrice || 0)} Tsh</div>
                            </div>
                            <div>
                                <label>Discount</label>
                                <div>${formatNumber(p.discount || 0)} Tsh</div>
                            </div>
                            <div>
                                <label>Total</label>
                                <div>${formatNumber(p.totalCost || p.buyingPrice || 0)} Tsh</div>
                            </div>
                            <div>
                                <label>Supplier</label>
                                <div>${escapeHTML(p.supplierName || '')} ${p.supplierPhone ? '(' + escapeHTML(p.supplierPhone) + ')' : ''}</div>
                            </div>
                            <div>
                                <label>Address</label>
                                <div>${escapeHTML(p.supplierAddress || '')}</div>
                            </div>
                        </div>
                        ${p.notes ? `<div style="margin-top:8px;"><label>Notes</label><div>${escapeHTML(p.notes)}</div></div>` : ''}
                        <div class="flex-gap" style="margin-top:12px;">
                            <button class="btn-small" onclick="downloadInventoryPurchaseItemPDF(${ts}, 'view')">View PDF</button>
                            <button class="btn-small" onclick="downloadInventoryPurchaseItemPDF(${ts}, 'download')">Download PDF</button>
                        </div>
                    </div>
                `;
                const modal = document.getElementById('floatModal');
                const content = document.getElementById('floatModalContent');
                const titleEl = document.getElementById('floatModalTitle');
                if (titleEl) titleEl.textContent = 'Inventory Item Details';
                if (content) content.innerHTML = html;
                if (modal) modal.classList.add('show');
                try { window.__updateModalOverflow && window.__updateModalOverflow(); } catch { }
            } catch { showToast('Unable to open item view', 'error'); }
        }

        function updateInventoryFilter(key, value) {
            state.inventoryFilters = state.inventoryFilters || {};
            state.inventoryFilters[key] = value;
            saveData();
            render();
        }

        function openInventoryModal() {
            const modal = document.getElementById('inventoryModal');
            const content = document.getElementById('inventoryModalContent');
            if (!modal || !content) return;
            function getInventoryProductOptions() {
                const all = (state.products || []).filter(p => p.hasStock !== false);
                const placeholder = '<option value="">-- Select Product --</option>';
                const addNew = `<option class="opt-new" value="new">+ Add New Product</option>`;
                if (all.length === 0) return placeholder + addNew + '<option value="" selected>No products found</option>';
                const recent = all.slice(-3).map(p => p.name);
                const rest = all
                    .filter(p => !recent.includes(p.name))
                    .slice()
                    .sort((a, b) => String(a.name).localeCompare(String(b.name)))
                    .map(p => p.name);
                const ordered = [...recent, ...rest];
                const opts = ordered.map((name) => `<option value="${name}">${name}</option>`).join('');
                return placeholder + addNew + opts;
            }
            const productOptions = getInventoryProductOptions();
            const cycles = state.inventoryPurchaseCycles || [];
            const nextPeriodNumber = (cycles?.length || 0) + 1;
            const defaultTitle = new Date().toLocaleString('en-GB', { month: 'long', year: 'numeric' }) + ' Period';
            const cycleOptions = cycles.map(c => `<option value="${c.number}">Period ${c.number} ${c.title ? '– ' + c.title : ''}</option>`).join('');

            content.innerHTML = `
                <div id="invToolbar" style="display:flex;align-items:center;gap:8px;justify-content:space-between;margin-bottom:8px;">
                    <button class="btn-small" id="invBulkToggle" type="button" onclick="invToggleBulkMode()" aria-pressed="false">Bulk Mode: Off</button>
                    <button class="btn-small" id="invAddBulkBtn" type="button" onclick="invAddBulkRow()" style="margin-left:auto; display:none;">+ Add Product</button>
                </div>
                <div id="invBulkContainer" style="display:none; margin-bottom:12px;"></div>
                <div id="invNewProductFields" style="display:none; margin-bottom:12px;">
                    <div class="card">
                        <h3>New Product</h3>
                        <div class="grid-2" style="gap:8px;">
                            <div>
                                <label>Name</label>
                                <input type="text" id="invNewProductName" placeholder="Enter product name" />
                            </div>
                            <div>
                                <label>Category</label>
                                <select id="invNewProductCategory" onchange="invHandleCategorySelection()">
                                    <option value="">-- Select Category --</option>
                                    <option class="opt-new" value="new">+ Add New Category</option>
                                    ${state.categories.slice().sort((a, b) => String(a).localeCompare(String(b))).map(c => `<option value="${c}">${c}</option>`).join('')}
                                </select>
                            </div>
                            <div id="invNewCategoryField" class="grid-span-2" style="display:none;">
                                <label>New Category Name</label>
                                <input type="text" id="invNewCategoryName" placeholder="Enter category name" />
                            </div>
                            <div class="grid-span-2" style="display:flex;align-items:center;gap:8px;">
                                <label style="margin:0;">Track stock</label>
                                <input type="checkbox" id="invNewProductHasStock" checked onchange="invToggleNewProductHasStock()" />
                            </div>
                            <div>
                                <label>Cost (Capital)</label>
                                <input type="text" id="invNewProductCost" class="money-input" placeholder="0" />
                            </div>
                            <div>
                                <label>Price (Selling)</label>
                                <input type="text" id="invNewProductPrice" class="money-input" placeholder="0" />
                            </div>
                            <div>
                                <label>Sale Unit</label>
                                <input type="text" id="invNewSaleUnit" placeholder="Describe sale unit (e.g., piece, bottle)" />
                            </div>
                            <div>
                                <label>Purchase Unit</label>
                                <input type="text" id="invNewPurchaseUnit" placeholder="Describe purchase unit (e.g., carton, pack)" />
                            </div>
                            <div>
                                <label>Units per Purchase</label>
                                <input type="number" id="invNewUnitsPerPurchase" min="1" placeholder="e.g., 24" />
                            </div>
                            <div id="invNewProductStockGroup" class="grid-span-2">
                                <label>Initial Stock</label>
                                <input type="text" id="invNewProductStock" class="money-input" placeholder="0" value="0" />
                            </div>
                        </div>
                        <div class="flex-gap" style="margin-top:8px;">
                            <button class="btn-success" type="button" onclick="invSaveNewProductFromInventory()">✅ Save New Product</button>
                            <button class="btn-secondary" type="button" onclick="invCancelNewProduct()">✖ Cancel</button>
                        </div>
                    </div>
                </div>
                <div id="invSingleItemFields" class="grid-2" style="gap:12px;">
                    <div>
                        <label>Product</label>
                        <select id="invProductSelect" onchange="invHandleProductSelection()">${productOptions}</select>
                    </div>
                    <div>
                        <label>Quantity</label>
                        <input id="invQuantity" type="text" class="money-input" placeholder="Qty" />
                    </div>
                    <div>
                        <label>Unit Cost (Tsh)</label>
                        <input id="invUnitCost" type="text" class="money-input" placeholder="0" />
                    </div>
                    <div>
                        <label>Purchase Unit</label>
                        <input id="invPurchaseUnit" type="text" placeholder="e.g., carton" />
                    </div>
                    <div>
                        <label>Units per Purchase</label>
                        <input id="invUnitsPerPurchase" type="number" min="1" placeholder="e.g., 24" />
                    </div>
                    <div>
                        <label>Total Cost (auto)</label>
                        <input id="invTotalCost" type="text" placeholder="0" disabled />
                    </div>
                    <div>
                        <label>Discount (Tsh)</label>
                        <input id="invDiscount" type="text" class="money-input" placeholder="0" />
                    </div>
                </div>
                <div class="grid-2" style="gap:12px;">
                    <div>
                        <label>Supplier Name</label>
                        <input id="invSupplierName" type="text" placeholder="Supplier name" />
                    </div>
                    <div>
                        <label>Supplier Phone</label>
                        <input id="invSupplierPhone" type="text" placeholder="Phone" />
                    </div>
                    <div class="grid-span-2">
                        <label>Supplier Address</label>
                        <input id="invSupplierAddress" type="text" placeholder="Address" />
                    </div>
                    <div>
                        <label>Date</label>
                        <input id="invDate" type="date" value="${getTodayDateString()}" />
                    </div>
                    <div>
                        <label>Time</label>
                        <input id="invTime" type="time" value="${new Date().toISOString().slice(11, 16)}" />
                    </div>
                    <div class="grid-span-2">
                        <label>Notes (optional)</label>
                        <input id="invNotes" type="text" placeholder="Notes" />
                    </div>
                </div>

                <div id="invNewProductFields" style="display:none; margin-top:12px;">
                    <div class="card">
                        <h3>New Product</h3>
                        <div class="grid-2" style="gap:8px;">
                            <div>
                                <label>Name</label>
                                <input type="text" id="invNewProductName" placeholder="Enter product name" />
                            </div>
                            <div>
                                <label>Category</label>
                                <select id="invNewProductCategory" onchange="invHandleCategorySelection()">
                                    <option value="">-- Select Category --</option>
                                    <option class="opt-new" value="new">+ Add New Category</option>
                                    ${state.categories.slice().sort((a, b) => String(a).localeCompare(String(b))).map(c => `<option value="${c}">${c}</option>`).join('')}
                                </select>
                            </div>
                            <div id="invNewCategoryField" class="grid-span-2" style="display:none;">
                                <label>New Category Name</label>
                                <input type="text" id="invNewCategoryName" placeholder="Enter category name" />
                            </div>
                            <div class="grid-span-2" style="display:flex;align-items:center;gap:8px;">
                                <label style="margin:0;">Track stock</label>
                                <input type="checkbox" id="invNewProductHasStock" checked onchange="invToggleNewProductHasStock()" />
                            </div>
                            <div>
                                <label>Cost (Capital)</label>
                                <input type="text" id="invNewProductCost" class="money-input" placeholder="0" />
                            </div>
                            <div>
                                <label>Price (Selling)</label>
                                <input type="text" id="invNewProductPrice" class="money-input" placeholder="0" />
                            </div>
                            <div>
                                <label>Sale Unit</label>
                                <input type="text" id="invNewSaleUnit" placeholder="Describe sale unit (e.g., piece, bottle)" />
                            </div>
                            <div>
                                <label>Purchase Unit</label>
                                <input type="text" id="invNewPurchaseUnit" placeholder="Describe purchase unit (e.g., carton, pack)" />
                            </div>
                            <div>
                                <label>Units per Purchase</label>
                                <input type="number" id="invNewUnitsPerPurchase" min="1" placeholder="e.g., 24" />
                            </div>
                            <div id="invNewProductStockGroup" class="grid-span-2">
                                <label>Initial Stock</label>
                                <input type="text" id="invNewProductStock" class="money-input" placeholder="0" value="0" />
                            </div>
                        </div>
                        <div class="flex-gap" style="margin-top:8px;">
                            <button class="btn-success" type="button" onclick="invSaveNewProductFromInventory()">✅ Save New Product</button>
                            <button class="btn-secondary" type="button" onclick="invCancelNewProduct()">✖ Cancel</button>
                        </div>
                    </div>
                </div>

                    <div class="card" style="margin-top:12px;">
                        <h3>Period</h3>
                        <div class="flex-gap">
                            <label style="display:flex;align-items:center;gap:8px;">
                                <input id="invCreateNewPeriod" type="checkbox" checked />
                                Create new Period (recommended)
                            </label>
                            <div>
                                <label>Existing Period</label>
                                <select id="invPeriodSelect" onchange="invOnPeriodChange()"><option value="">—</option>${cycleOptions}</select>
                            </div>
                            <div>
                                <label>New Period Title</label>
                                <input id="invNewPeriodTitle" type="text" value="${defaultTitle}" />
                            </div>
                        </div>
                    </div>
            `;
            try { setTimeout(() => { applySearchableDropdowns(); }, 0); } catch { }

            // Attach money formatters in modal
            try {
                ['invQuantity', 'invUnitCost', 'invDiscount', 'invNewProductCost', 'invNewProductPrice', 'invNewProductStock'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) attachMoneyFormatter(el);
                });
            } catch { }

            // Auto-update total cost
            setTimeout(() => {
                const qtyEl = document.getElementById('invQuantity');
                const unitEl = document.getElementById('invUnitCost');
                const totalEl = document.getElementById('invTotalCost');
                const discEl = document.getElementById('invDiscount');
                function updateTotal() {
                    const q = parseMoney(qtyEl.value || '0');
                    const u = parseMoney(unitEl.value || '0');
                    const d = parseMoney(discEl.value || '0');
                    const t = Math.max(0, (q * u) - d);
                    totalEl.value = formatMoney(t);
                }
                qtyEl?.addEventListener('input', updateTotal);
                unitEl?.addEventListener('input', updateTotal);
                discEl?.addEventListener('input', updateTotal);
                updateTotal();
            }, 0);

            const handleOutside = (e) => {
                if (e.target === modal) {
                    closeInventoryModal();
                }
            };
            modal.addEventListener('click', handleOutside, { once: true });

            // Floating Add Product button behavior
            try {
                const contentEl = document.querySelector('#inventoryModal .modal-content');
                const toolbarEl = document.getElementById('invToolbar');
                const addBtn = document.getElementById('invAddBulkBtn');
                const closeBtn = document.querySelector('#inventoryModal .modal-close');
                const stickThreshold = (toolbarEl?.offsetHeight || 0) + 8;
                const updateFloating = () => {
                    if (!contentEl || !toolbarEl || !addBtn) return;
                    if (contentEl.scrollTop > stickThreshold && addBtn.style.display !== 'none') {
                        // Move next to the Close (to the left)
                        try { closeBtn?.insertAdjacentElement('afterend', addBtn); } catch { }
                        addBtn.classList.add('floating-add');
                    } else {
                        // Move back into toolbar
                        try { toolbarEl?.appendChild(addBtn); } catch { }
                        addBtn.classList.remove('floating-add');
                    }
                };
                contentEl.addEventListener('scroll', updateFloating);
                updateFloating();
            } catch { }

            try { window.__updateModalOverflow && window.__updateModalOverflow(); } catch { }

            window.invToggleBulkMode = function (force) {
                const btn = document.getElementById('invBulkToggle');
                const addBtn = document.getElementById('invAddBulkBtn');
                let active = false;
                if (typeof force === 'boolean') {
                    active = force;
                } else {
                    const pressed = btn && btn.getAttribute('aria-pressed') === 'true';
                    active = !pressed;
                }
                if (btn) {
                    btn.setAttribute('aria-pressed', active ? 'true' : 'false');
                    btn.classList.toggle('btn-success', active);
                    btn.textContent = active ? 'Bulk Mode: On' : 'Bulk Mode: Off';
                }
                if (addBtn) addBtn.style.display = active ? 'inline-block' : 'none';
                const cont = document.getElementById('invBulkContainer');
                const header = document.getElementById('invBulkHeader');
                const single = document.getElementById('invSingleItemFields');
                if (cont) cont.style.display = active ? 'block' : 'none';
                if (header) header.style.display = active ? 'grid' : 'none';
                if (single) single.style.display = active ? 'none' : 'grid';
                if (active && cont && cont.children.length === 0) {
                    try { invAddBulkRow(); } catch { }
                }
            };
            window.invOnPeriodChange = function () {
                const sel = document.getElementById('invPeriodSelect');
                const createNew = document.getElementById('invCreateNewPeriod');
                const titleEl = document.getElementById('invNewPeriodTitle');
                if (!sel) return;
                if (sel.value) {
                    if (createNew) createNew.checked = false;
                    // keep title editable to allow updating existing Period title
                } else {
                    if (createNew) createNew.checked = true;
                }
            };
            window.invAddBulkRow = function () {
                const cont = document.getElementById('invBulkContainer');
                if (!cont) return;
                const btn = document.getElementById('invBulkToggle');
                if (btn && btn.getAttribute('aria-pressed') !== 'true') {
                    invToggleBulkMode(true);
                }
                const all = (state.products || []).filter(p => p.hasStock !== false).map(p => p.name);
                const recent = all.slice(-3);
                const rest = all.filter(n => !recent.includes(n)).sort((a, b) => String(a).localeCompare(String(b)));
                const ordered = [...recent, ...rest];
                const opts = ordered.map(name => `<option value="${name}">${name}</option>`).join('');
                const row = document.createElement('div');
                row.className = 'inv-bulk-row';
                row.style.display = 'grid';
                row.style.gridTemplateColumns = '2fr 1fr 1fr 1fr 1fr 1fr auto';
                row.style.gap = '8px';
                row.style.marginBottom = '8px';
                row.innerHTML = `
                    <div>
                        <label class="bulk-label">Product</label>
                        <select class="inv-bulk-name">${opts}</select>
                    </div>
                    <div>
                        <label class="bulk-label">Quantity</label>
                        <input class="inv-bulk-qty money-input" type="text" placeholder="Qty" />
                    </div>
                    <div>
                        <label class="bulk-label">Unit Cost</label>
                        <input class="inv-bulk-unit money-input" type="text" placeholder="Unit Cost" />
                    </div>
                    <div>
                        <label class="bulk-label">Purchase Unit</label>
                        <input class="inv-bulk-punit" type="text" placeholder="e.g., carton, box" />
                    </div>
                    <div>
                        <label class="bulk-label">Units per Purchase</label>
                        <input class="inv-bulk-units money-input" type="text" placeholder="e.g., 24" />
                    </div>
                    <div>
                        <label class="bulk-label">Discount</label>
                        <input class="inv-bulk-disc money-input" type="text" placeholder="Discount" />
                    </div>
                    <div>
                        <label class="bulk-label">Action</label>
                        <button class="btn-small btn-danger" type="button">✖</button>
                    </div>
                `;
                row.querySelector('button')?.addEventListener('click', () => {
                    try { cont.removeChild(row); } catch { }
                    try { if (cont.children.length === 0) invToggleBulkMode(false); } catch { }
                });
                cont.appendChild(row);
                try { const selBulk = row.querySelector('.inv-bulk-name'); if (selBulk) makeSearchableDropdown(selBulk); } catch { }
                try { document.querySelectorAll('.money-input').forEach(el => attachMoneyFormatter(el)); } catch { }
            };

            modal.classList.add('show');
        }

        window.invHandleProductSelection = function () {
            const select = document.getElementById('invProductSelect');
            const newFields = document.getElementById('invNewProductFields');
            if (select && newFields) {
                if (select.value === 'new') {
                    newFields.style.display = 'block';
                    document.getElementById('invNewProductName').value = '';
                    document.getElementById('invNewProductCategory').value = '';
                    document.getElementById('invNewCategoryName').value = '';
                    document.getElementById('invNewProductCost').value = '';
                    document.getElementById('invNewProductPrice').value = '';
                    document.getElementById('invNewProductStock').value = '0';
                    document.getElementById('invNewCategoryField').style.display = 'none';
                    const hasStockEl = document.getElementById('invNewProductHasStock');
                    const stockGroup = document.getElementById('invNewProductStockGroup');
                    if (hasStockEl && stockGroup) { hasStockEl.checked = true; stockGroup.style.display = 'block'; }
                } else {
                    newFields.style.display = 'none';
                    const prod = (state.products || []).find(p => p.name === select.value);
                    const pu = document.getElementById('invPurchaseUnit');
                    const up = document.getElementById('invUnitsPerPurchase');
                    if (pu) pu.value = (prod && prod.purchaseUnit) ? prod.purchaseUnit : '';
                    if (up) up.value = (prod && prod.unitsPerPurchase) ? prod.unitsPerPurchase : '';
                }
            }
        };
        window.invHandleCategorySelection = function () {
            const select = document.getElementById('invNewProductCategory');
            const newCategoryField = document.getElementById('invNewCategoryField');
            if (select && newCategoryField) {
                newCategoryField.style.display = (select.value === 'new') ? 'block' : 'none';
                if (select.value !== 'new') document.getElementById('invNewCategoryName').value = '';
                const hasStockEl = document.getElementById('invNewProductHasStock');
                const stockGroup = document.getElementById('invNewProductStockGroup');
                if (hasStockEl) {
                    if (select.value === 'new') {
                        hasStockEl.checked = true;
                        if (stockGroup) stockGroup.style.display = 'block';
                    } else {
                        const kind = getCategoryKind(select.value);
                        hasStockEl.checked = (kind !== 'service');
                        if (stockGroup) stockGroup.style.display = hasStockEl.checked ? 'block' : 'none';
                    }
                }
            }
        };
        window.invToggleNewProductHasStock = function () {
            const hasStockEl = document.getElementById('invNewProductHasStock');
            const stockGroup = document.getElementById('invNewProductStockGroup');
            if (hasStockEl && stockGroup) stockGroup.style.display = hasStockEl.checked ? 'block' : 'none';
        };
        window.invSaveNewProductFromInventory = async function () {
            const nameRaw = document.getElementById('invNewProductName').value.trim();
            const name = capitalizeFirstWordValue(nameRaw);
            let categorySelect = document.getElementById('invNewProductCategory').value;
            if (typeof categorySelect === 'string') categorySelect = categorySelect.trim();
            const newCategoryNameRaw = document.getElementById('invNewCategoryName').value.trim();
            const newCategoryName = capitalizeFirstWordValue(newCategoryNameRaw);
            const cost = parseMoney(document.getElementById('invNewProductCost').value);
            const price = parseMoney(document.getElementById('invNewProductPrice').value);
            const hasStock = document.getElementById('invNewProductHasStock')?.checked !== false;
            const stock = hasStock ? (parseMoney(document.getElementById('invNewProductStock').value) || 0) : 0;
            const saleUnit = (document.getElementById('invNewSaleUnit')?.value || '').trim();
            const purchaseUnit = (document.getElementById('invNewPurchaseUnit')?.value || '').trim();
            const unitsPerPurchaseRaw = (document.getElementById('invNewUnitsPerPurchase')?.value || '').trim();
            const unitsPerPurchase = unitsPerPurchaseRaw ? parseFloat(unitsPerPurchaseRaw) : null;

            if (!name) return showToast('Please enter product name', 'error');
            let category;
            if (categorySelect === 'new') {
                if (!newCategoryName) return showToast('Please enter category name', 'error');
                if (!state.categories.includes(newCategoryName)) state.categories.push(newCategoryName);
                category = newCategoryName;
            } else {
                if (!categorySelect) return showToast('Please select or create a category', 'error');
                category = capitalizeFirstWordValue(categorySelect);
            }
            if (isNaN(cost) || cost < 0) return showToast('Please enter a valid cost', 'error');
            if (isNaN(price) || price < 0) return showToast('Please enter a valid price', 'error');
            if (price < cost && !confirm('Warning: Selling price is less than cost. Continue?')) return;
            if (state.products.some(p => p.name.toLowerCase() === name.toLowerCase())) return showToast('Product already exists', 'error');

            const product = { id: generateID('products'), name, category, cost, price, hasStock: hasStock ? true : false, saleUnit: saleUnit || '', purchaseUnit: purchaseUnit || '', unitsPerPurchase: (typeof unitsPerPurchase === 'number' && !isNaN(unitsPerPurchase)) ? unitsPerPurchase : null };
            state.products.push(product);
            state.inventory = state.inventory || {};
            if (hasStock) state.inventory[name] = { stock, minAlert: 5 };
            saveData();

            if (syncEnabled) {
                await upsertOne('products', { name, category, cost, price, has_stock: hasStock ? true : false, sale_unit: saleUnit || null, purchase_unit: purchaseUnit || null, units_per_purchase: ((typeof unitsPerPurchase === 'number' && !isNaN(unitsPerPurchase)) ? unitsPerPurchase : null) });
                if (hasStock) await upsertOne('inventory', { product_name: name, stock: stock, min_alert: 5 });
                if (category) await upsertOne('categories', { name: category });
                syncInBackground();
            }

            const select = document.getElementById('invProductSelect');
            if (select) {
                // rebuild options minimally
                select.insertAdjacentHTML('afterbegin', `<option value="${name}">${name}</option>`);
                select.value = name;
            }
            showToast('✅ Product added!', 'success');
            const newFields = document.getElementById('invNewProductFields');
            if (newFields) newFields.style.display = 'none';
        };
        window.invCancelNewProduct = function () {
            const newFields = document.getElementById('invNewProductFields');
            const select = document.getElementById('invProductSelect');
            if (newFields) newFields.style.display = 'none';
            if (select) { select.value = ''; try { select.dispatchEvent(new Event('change', { bubbles: true })); } catch {} }
            try {
                const nameEl = document.getElementById('invNewProductName'); if (nameEl) nameEl.value = '';
                const catSel = document.getElementById('invNewProductCategory'); if (catSel) catSel.value = '';
                const catNameEl = document.getElementById('invNewCategoryName'); if (catNameEl) catNameEl.value = '';
                const costEl = document.getElementById('invNewProductCost'); if (costEl) costEl.value = '';
                const priceEl = document.getElementById('invNewProductPrice'); if (priceEl) priceEl.value = '';
                const saleEl = document.getElementById('invNewSaleUnit'); if (saleEl) saleEl.value = '';
                const purchEl = document.getElementById('invNewPurchaseUnit'); if (purchEl) purchEl.value = '';
                const unitsEl = document.getElementById('invNewUnitsPerPurchase'); if (unitsEl) unitsEl.value = '';
                const hasStockEl = document.getElementById('invNewProductHasStock'); if (hasStockEl) hasStockEl.checked = true;
                const stockGroup = document.getElementById('invNewProductStockGroup'); if (stockGroup) stockGroup.style.display = 'block';
                const stockEl = document.getElementById('invNewProductStock'); if (stockEl) stockEl.value = '0';
                const newCatField = document.getElementById('invNewCategoryField'); if (newCatField) newCatField.style.display = 'none';
            } catch {}
        };

        function closeInventoryModal() {
            const modal = document.getElementById('inventoryModal');
            if (modal) modal.classList.remove('show');
            try { window.__updateModalOverflow && window.__updateModalOverflow(); } catch { }
        }

        function ensurePeriodCreated(purchaseDate, time, titleHint) {
            state.inventoryPurchaseCycles = state.inventoryPurchaseCycles || [];
            const existingNumbers = (state.inventoryPurchaseCycles || []).map(c => Number(c.number) || 0);
            const nextNumber = (existingNumbers.length ? Math.max.apply(null, existingNumbers) + 1 : 1);
            const title = titleHint || (new Date(purchaseDate).toLocaleString('en-GB', { month: 'long', year: 'numeric' }) + ' Period');
            const cycle = {
                id: generateID('invCycle'),
                number: nextNumber,
                title,
                startDate: purchaseDate,
                endDate: '',
                notes: ''
            };
            if (!(state.inventoryPurchaseCycles || []).some(c => Number(c.number) === nextNumber)) {
                state.inventoryPurchaseCycles.push(cycle);
            }
            // Persist new period immediately when online
            if (syncEnabled && currentUser) {
                upsertOne('inventory_purchase_periods', {
                    period_number: nextNumber,
                    title,
                    start_date: purchaseDate,
                    end_date: '',
                    notes: ''
                });
            }
            return nextNumber;
        }

        async function addInventoryRecord() {
            playTapSound();
            hapticShort();
            const productName = (document.getElementById('invProductSelect')?.value || '').trim();
            const quantity = parseMoney(document.getElementById('invQuantity')?.value || '0');
            const unitCost = parseMoney(document.getElementById('invUnitCost')?.value || '0');
            const discount = parseMoney(document.getElementById('invDiscount')?.value || '0');
            const totalCost = parseMoney(document.getElementById('invTotalCost')?.value || '0');
            const supplierName = (document.getElementById('invSupplierName')?.value || '').trim();
            const supplierPhone = (document.getElementById('invSupplierPhone')?.value || '').trim();
            const supplierAddress = (document.getElementById('invSupplierAddress')?.value || '').trim();
            const purchaseDate = document.getElementById('invDate')?.value || getTodayDateString();
            const time = document.getElementById('invTime')?.value || new Date().toISOString().slice(11, 16);
            const notes = (document.getElementById('invNotes')?.value || '').trim();
            const createNew = !!(document.getElementById('invCreateNewPeriod')?.checked);
            const selectedPeriod = document.getElementById('invPeriodSelect')?.value || '';
            const newPeriodTitle = (document.getElementById('invNewPeriodTitle')?.value || '').trim();
            const bulkModeToggle = document.getElementById('invBulkToggle');
            const bulkMode = !!(bulkModeToggle && bulkModeToggle.getAttribute('aria-pressed') === 'true');

            if (!bulkMode) {
                if (!productName) return showToast('Select a product', 'error');
                if (!quantity || quantity <= 0) return showToast('Enter a valid quantity', 'error');
                if (isNaN(unitCost) || unitCost <= 0) return showToast('Enter unit cost', 'error');
                if (discount < 0) return showToast('Discount cannot be negative', 'error');
            }

            // Determine Period number: only create when no selection and createNew toggled
            let cycleNumber = selectedPeriod ? parseInt(selectedPeriod, 10) : null;
            if (!cycleNumber && createNew) {
                cycleNumber = ensurePeriodCreated(purchaseDate, time, newPeriodTitle);
            }

            // If using existing Period and a new title is provided, update the Period locally and in cloud
            if (cycleNumber && !createNew && newPeriodTitle) {
                const existing = (state.inventoryPurchaseCycles || []).find(c => c.number === cycleNumber);
                if (existing) existing.title = newPeriodTitle;
                if (syncEnabled && currentUser) {
                    await upsertOne('inventory_purchase_periods', {
                        period_number: cycleNumber,
                        title: newPeriodTitle
                    });
                }
            }

            const nowTs = Date.now();
            const todayStr = getTodayDateString();
            const isPlanned = new Date(purchaseDate).getTime() > new Date(todayStr).getTime();
            let totalExpenseAmount = 0;
            let expenseDescription = '';

            state.inventoryPurchases = state.inventoryPurchases || [];
            const createdRecords = [];

            if (bulkMode) {
                const rows = Array.from(document.querySelectorAll('.inv-bulk-row'));
                if (rows.length === 0) return showToast('Add at least one product row', 'error');
                rows.forEach((row, idx) => {
                    const name = (row.querySelector('.inv-bulk-name')?.value || '').trim();
                    const q = parseMoney(row.querySelector('.inv-bulk-qty')?.value || '0');
                    const u = parseMoney(row.querySelector('.inv-bulk-unit')?.value || '0');
                    const units = parseFloat(row.querySelector('.inv-bulk-units')?.value || '0') || null;
                    const punit = (row.querySelector('.inv-bulk-punit')?.value || '').trim();
                    const d = parseMoney(row.querySelector('.inv-bulk-disc')?.value || '0');
                    if (!name || q <= 0 || u <= 0) return;
                    const rec = {
                        id: generateID('invPurchase'),
                        cycleNumber,
                        itemName: name,
                        quantity: q,
                        unitCost: u,
                        unitsPerPurchase: units,
                        purchaseUnit: punit || null,
                        discount: d,
                        totalCost: Math.max(0, (q * u) - d),
                        supplierName,
                        supplierPhone,
                        supplierAddress,
                        purchaseDate,
                        time,
                        notes: notes,
                        timestamp: nowTs + idx,
                        planned: isPlanned,
                        activated: !isPlanned
                    };
                    state.inventoryPurchases.push(rec);
                    createdRecords.push(rec);
                    if (!isPlanned) updateProductStock(name, q, true);
                    totalExpenseAmount += rec.totalCost;
                });
                expenseDescription = `Inventory(Bulk): ${rows.length} items`;
            } else {
                    const record = {
                        id: generateID('invPurchase'),
                        cycleNumber,
                        itemName: productName,
                        quantity,
                        unitCost,
                        unitsPerPurchase: (parseFloat(document.getElementById('invUnitsPerPurchase')?.value || '0') || null),
                        purchaseUnit: (document.getElementById('invPurchaseUnit')?.value || '').trim(),
                        discount,
                        totalCost: (isNaN(totalCost) || totalCost === 0) ? Math.max(0, (quantity * unitCost) - discount) : totalCost,
                        supplierName,
                        supplierPhone,
                        supplierAddress,
                    purchaseDate,
                    time,
                    notes: notes ? `${notes}${discount ? ' | Discount: ' + formatMoney(discount) + ' Tsh' : ''} ` : (discount ? `Discount: ${formatMoney(discount)} Tsh` : ''),
                    timestamp: nowTs,
                    planned: isPlanned,
                    activated: !isPlanned
                };
                state.inventoryPurchases.push(record);
                createdRecords.push(record);
                if (!isPlanned) updateProductStock(productName, quantity, true);
                totalExpenseAmount = record.totalCost;
                expenseDescription = `Inventory: ${productName} × ${quantity} `;
            }

            if (isPlanned) { showToast('Planned purchase saved', 'success'); }

            // Record as an expense (office money usage)
            const expenseTs = nowTs;
            // Upsert period-level expense (summary)
            const periodComment = `Period ${cycleNumber} `;
            const existingIdx = (state.expenses || []).findIndex(e => e.category === 'Inventory Purchase' && e.comment === periodComment);
            if (existingIdx !== -1) {
                state.expenses[existingIdx].amount = (state.expenses[existingIdx].amount || 0) + (totalExpenseAmount || 0);
                try {
                    const e = state.expenses[existingIdx];
                    await upsertOne('expenses', {
                        id: e.id,
                        date: e.date,
                        time: e.time,
                        timestamp: e.timestamp,
                        description: e.description,
                        category: e.category,
                        amount: e.amount,
                        payment: e.payment,
                        comment: e.comment
                    });
                } catch { }
            } else {
                const expense = {
                    id: generateID('expenses'),
                    date: purchaseDate,
                    time,
                    timestamp: expenseTs,
                    description: `Inventory Period ${cycleNumber} `,
                    category: 'Inventory Purchase',
                    amount: totalExpenseAmount,
                    payment: 'cash',
                    comment: periodComment
                };
                state.expenses.push(expense);
                try {
                    await upsertOne('expenses', {
                        id: expense.id,
                        date: expense.date,
                        time: expense.time,
                        timestamp: expense.timestamp,
                        description: expense.description,
                        category: expense.category,
                        amount: expense.amount,
                        payment: expense.payment,
                        comment: expense.comment
                    });
                } catch { }
            }

            saveData();
            closeInventoryModal();
            render();
            showToast('Inventory purchase saved', 'success');
                if (syncEnabled) {
                    try {
                        const last = createdRecords[createdRecords.length - 1];
                        if (last) {
                            await upsertOne('inventory_purchases', {
                                period_number: last.cycleNumber,
                                item_name: last.itemName,
                                quantity: last.quantity,
                                unit_cost: last.unitCost,
                                total_cost: last.totalCost,
                                purchase_unit: last.purchaseUnit || null,
                                units_per_purchase: last.unitsPerPurchase || null,
                                purchase_date: last.purchaseDate,
                                supplier_name: last.supplierName,
                                supplier_phone: last.supplierPhone,
                                supplier_address: last.supplierAddress,
                                notes: last.notes,
                                timestamp: last.timestamp
                            });
                        }
                        const inv = state.inventory[productName] || { stock: 0, minAlert: 5 };
                        await upsertOne('inventory', { product_name: productName, stock: inv.stock || 0, min_alert: inv.minAlert || 5 });
                        syncInBackground();
                    } catch { }
                }
        }

        function updateProductStock(productName, quantity, isPurchaseUnits = false) {
            if (!productName || !quantity) return;
            state.inventory = state.inventory || {};
            const inv = state.inventory[productName] || { stock: 0, minAlert: 5 };
            let delta = parseInt(quantity || 0, 10);
            if (isPurchaseUnits) {
                const prod = (state.products || []).find(p => String(p.name || '') === String(productName));
                const units = prod && prod.unitsPerPurchase ? parseFloat(prod.unitsPerPurchase) || 1 : 1;
                delta = Math.round(delta * units);
            }
            inv.stock = (parseInt(inv.stock || 0, 10) + delta);
            state.inventory[productName] = inv;
        }

        function generateInventoryReport(format = 'csv') {
            const purchases = state.inventoryPurchases || [];
            const cycles = state.inventoryPurchaseCycles || [];
            if (format === 'csv') {
                const headers = ['Product', 'Quantity', 'UnitCost', 'TotalCost', 'Supplier', 'Phone', 'Address', 'Period', 'Date', 'Time'];
                const rows = purchases.map(p => [
                    p.itemName,
                    p.quantity || 0,
                    (p.unitCost || p.buyingPrice || 0),
                    (p.totalCost || p.buyingPrice || 0),
                    p.supplierName || '',
                    p.supplierPhone || p.supplierContact || '',
                    p.supplierAddress || '',
                    p.cycleNumber,
                    p.purchaseDate || '',
                    p.time || ''
                ]);
                const csv = [headers.join(','), ...rows.map(r => r.map(v => String(v).replace(/\n/g, ' ').replace(/,/g, ';')).join(','))].join('\n');
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Inventory_Report_${getTodayDateString()}.csv`;
                document.body.appendChild(a);
                a.click();
                a.remove();
                URL.revokeObjectURL(url);
                showToast('CSV report downloaded', 'success');
            } else {
                downloadInventoryPurchasesReportPDF();
            }
        }

        // Inventory PDF generators
        async function downloadInventoryPurchasesReportPDF() {
            try { if (window.loadLibrary) await loadLibrary('jspdf'); } catch {}
            await ensureLogoReady();
            try {
                const { jsPDF } = window.jspdf || {};
                if (!jsPDF) {
                    console.error('jsPDF not loaded');
                    showToast('PDF library not loaded', 'error');
                    return;
                }
                const doc = new jsPDF({ unit: 'pt', format: 'a4' });
                const pageWidth = doc.internal.pageSize.getWidth();
                const centerX = pageWidth / 2;
                const margin = 50;
                const usableWidth = pageWidth - margin * 2;
                let y = 120;

                // Header (match Financial Report)
                doc.setFillColor(240, 240, 240);
                doc.rect(0, 0, pageWidth, 100, 'F');
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(24);
                doc.setFont(undefined, 'bold');
                const profile = (typeof getUserProfileData === 'function') ? getUserProfileData() : (state.userProfile || { businessName: 'TUBA', address: '', phone: '', email: '' });
                doc.text(profile.businessName || 'TUBA', centerX, 45, { align: 'center' });
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text(`${profile.address || ''} | ${profile.phone || ''} | ${profile.email || ''} `, centerX, 70, { align: 'center' });
                doc.setDrawColor(150, 150, 150);
                doc.setLineWidth(3);
                doc.line(margin, 85, pageWidth - margin, 85);

                // Title
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(18);
                doc.setFont(undefined, 'bold');
                doc.text('Inventory Purchases Report', margin, y);
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(100, 100, 100);
                doc.text(`Generated: ${getTodayDateString()} `, margin, y + 20);
                y += 50;

                const cycles = state.inventoryPurchaseCycles || [];
                const purchases = state.inventoryPurchases || [];

                const drawTable = (headers, rows, startY) => {
                    const colCount = headers.length;
                    const colWidth = usableWidth / colCount;
                    let curY = startY;
                    const headerH = 20;

                    doc.setFillColor(100, 100, 100);
                    doc.roundedRect(margin, curY, usableWidth, headerH, 3, 3, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFont(undefined, 'bold');
                    doc.setFontSize(10);
                    for (let i = 0; i < colCount; i++) {
                        const txtX = margin + i * colWidth + 8;
                        doc.text(String(headers[i]), txtX, curY + 14);
                    }
                    curY += headerH + 2;

                    doc.setFont(undefined, 'normal');
                    doc.setFontSize(9);
                    for (let r = 0; r < rows.length; r++) {
                        let maxLines = 1;
                        const cellLines = [];
                        for (let c = 0; c < colCount; c++) {
                            const txt = rows[r][c] === null || rows[r][c] === undefined ? '' : String(rows[r][c]);
                            const lines = doc.splitTextToSize(txt, colWidth - 16);
                            cellLines.push(lines);
                            if (lines.length > maxLines) maxLines = lines.length;
                        }
                        const lineH = 10;
                        const rowH = maxLines * lineH + 8;

                        if (curY + rowH > 750) {
                            doc.addPage();
                            curY = margin;
                        }

                        if (r % 2 === 0) {
                            doc.setFillColor(248, 249, 250);
                            doc.roundedRect(margin, curY, usableWidth, rowH, 2, 2, 'F');
                        }

                        doc.setTextColor(40, 40, 40);
                        for (let c = 0; c < colCount; c++) {
                            const txtX = margin + c * colWidth + 8;
                            const lines = cellLines[c];
                            for (let li = 0; li < lines.length; li++) {
                                doc.text(lines[li], txtX, curY + 14 + li * lineH);
                            }
                        }
                        curY += rowH;
                    }
                    return curY + 20;
                };

                if (cycles.length === 0) {
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'normal');
                    doc.text('No Periods found.', margin, y);
                } else {
                    cycles.forEach(cycle => {
                        const cps = purchases.filter(p => p.cycleNumber === cycle.number);
                        const cycleTotal = cps.reduce((sum, p) => sum + (Number(p.totalCost) || Number(p.buyingPrice) || 0), 0);
                        if (y > 650) { doc.addPage(); y = margin; }
                        doc.setFontSize(14);
                        doc.setFont(undefined, 'bold');
                        doc.setTextColor(0, 0, 0);
                        doc.text(`Period ${cycle.number} ${cycle.title ? '– ' + cycle.title : ''} `, margin, y);
                        doc.setFontSize(10);
                        doc.setFont(undefined, 'normal');
                        doc.setTextColor(100, 100, 100);
                        doc.text(`Items: ${cps.length} | Spent: ${formatNumber(cycleTotal)} Tsh`, margin, y + 16);
                        y += 36;

                        const headers = ['Date', 'Time', 'Item', 'Qty', 'Unit', 'Total', 'Supplier', 'Phone'];
                        const rows = cps.map(p => [
                            p.purchaseDate || '',
                            p.time || '',
                            p.itemName,
                            String(p.quantity || 1),
                            formatNumber(p.unitCost || p.buyingPrice || 0),
                            formatNumber(p.totalCost || p.buyingPrice || 0),
                            p.supplierName || '',
                            p.supplierPhone || p.supplierContact || ''
                        ]);
                        y = drawTable(headers, rows, y);
                    });
                }

                // Footer
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFillColor(240, 240, 240);
                    doc.rect(0, 792 - 30, pageWidth, 30, 'F');
                    doc.setTextColor(100, 100, 100);
                    doc.setFontSize(9);
                    doc.text(`Page ${i} of ${pageCount} `, margin, 792 - 11);
                    doc.text(`The Ultimate Business Architecture(TUBA) © ${new Date().getFullYear()} `, pageWidth - margin, 792 - 8, { align: 'right' });
                }

                downloadPDFSafe(doc, `Inventory_Purchases_${getTodayDateString()}.pdf`);
                showToast('Inventory report PDF ready', 'success');
            } catch (e) {
                console.error('Inventory PDF error:', e);
                showToast('Failed to generate PDF', 'error');
            }
        }

        async function downloadInventoryCyclePDF(cycleNumber, mode = 'download') {
            try { if (window.loadLibrary) await loadLibrary('jspdf'); } catch {}
            await ensureLogoReady();
            try {
                const { jsPDF } = window.jspdf || {};
                if (!jsPDF) {
                    console.error('jsPDF not loaded');
                    showToast('PDF library not loaded', 'error');
                    return;
                }
                const doc = new jsPDF({ unit: 'pt', format: 'a4' });
                const pageWidth = doc.internal.pageSize.getWidth();
                const centerX = pageWidth / 2;
                const margin = 50;
                const usableWidth = pageWidth - margin * 2;
                let y = 120;

                // Header (match Financial Report)
                doc.setFillColor(240, 240, 240);
                doc.rect(0, 0, pageWidth, 100, 'F');
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(24);
                doc.setFont(undefined, 'bold');
                const profile = (typeof getUserProfileData === 'function') ? getUserProfileData() : (state.userProfile || { businessName: 'TUBA', address: '', phone: '', email: '' });
                doc.text(profile.businessName || 'TUBA', centerX, 45, { align: 'center' });
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text(`${profile.address || ''} | ${profile.phone || ''} | ${profile.email || ''} `, centerX, 70, { align: 'center' });
                doc.setDrawColor(150, 150, 150);
                doc.setLineWidth(3);
                doc.line(margin, 85, pageWidth - margin, 85);

                const cycle = (state.inventoryPurchaseCycles || []).find(c => c.number === cycleNumber);
                const cps = (state.inventoryPurchases || []).filter(p => p.cycleNumber === cycleNumber);
                const cycleTotal = cps.reduce((sum, p) => sum + (Number(p.totalCost) || Number(p.buyingPrice) || 0), 0);

                // Title
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(18);
                doc.setFont(undefined, 'bold');
                doc.text(`Inventory Period ${cycleNumber} ${cycle?.title ? '– ' + cycle.title : ''} `, margin, y);
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(100, 100, 100);
                doc.text(`Items: ${cps.length} | Spent: ${formatNumber(cycleTotal)} Tsh`, margin, y + 20);
                y += 50;

                const headers = ['Date', 'Time', 'Item', 'Qty', 'Unit', 'Total', 'Supplier', 'Phone'];
                const rows = cps.map(p => [
                    p.purchaseDate || '',
                    p.time || '',
                    p.itemName,
                    String(p.quantity || 1),
                    formatNumber(p.unitCost || p.buyingPrice || 0),
                    formatNumber(p.totalCost || p.buyingPrice || 0),
                    p.supplierName || '',
                    p.supplierPhone || p.supplierContact || ''
                ]);

                const colCount = headers.length;
                const colWidth = usableWidth / colCount;
                let curY = y;
                const headerH = 20;
                doc.setFillColor(100, 100, 100);
                doc.roundedRect(margin, curY, usableWidth, headerH, 3, 3, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFont(undefined, 'bold');
                doc.setFontSize(10);
                for (let i = 0; i < colCount; i++) {
                    const txtX = margin + i * colWidth + 8;
                    doc.text(String(headers[i]), txtX, curY + 14);
                }
                curY += headerH + 2;
                doc.setFont(undefined, 'normal');
                doc.setFontSize(9);
                for (let r = 0; r < rows.length; r++) {
                    let maxLines = 1;
                    const cellLines = [];
                    for (let c = 0; c < colCount; c++) {
                        const txt = rows[r][c] === null || rows[r][c] === undefined ? '' : String(rows[r][c]);
                        const lines = doc.splitTextToSize(txt, colWidth - 16);
                        cellLines.push(lines);
                        if (lines.length > maxLines) maxLines = lines.length;
                    }
                    const lineH = 10;
                    const rowH = maxLines * lineH + 8;
                    if (curY + rowH > 750) {
                        doc.addPage();
                        curY = margin;
                        doc.setFillColor(100, 100, 100);
                        doc.roundedRect(margin, curY, usableWidth, headerH, 3, 3, 'F');
                        doc.setTextColor(255, 255, 255);
                        doc.setFont(undefined, 'bold');
                        doc.setFontSize(10);
                        for (let i = 0; i < colCount; i++) {
                            const txtX = margin + i * colWidth + 8;
                            doc.text(String(headers[i]), txtX, curY + 14);
                        }
                        curY += headerH + 2;
                        doc.setFont(undefined, 'normal');
                        doc.setFontSize(9);
                    }
                    if (r % 2 === 0) { doc.setFillColor(248, 249, 250); doc.roundedRect(margin, curY, usableWidth, rowH, 2, 2, 'F'); }
                    doc.setTextColor(40, 40, 40);
                    for (let c = 0; c < colCount; c++) {
                        const txtX = margin + c * colWidth + 8;
                        const lines = cellLines[c];
                        for (let li = 0; li < lines.length; li++) {
                            doc.text(lines[li], txtX, curY + 14 + li * lineH);
                        }
                    }
                    curY += rowH;
                }

                // Footer
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFillColor(240, 240, 240);
                    doc.rect(0, 792 - 30, pageWidth, 30, 'F');
                    doc.setTextColor(100, 100, 100);
                    doc.setFontSize(9);
                    doc.text(`Page ${i} of ${pageCount} `, margin, 792 - 11);
                    doc.text(`The Ultimate Business Architecture(TUBA) © ${new Date().getFullYear()} `, pageWidth - margin, 792 - 8, { align: 'right' });
                }

                const filename = `Inventory_Period_${cycleNumber}.pdf`;
                if (mode === 'view') {
                    try {
                        const blob = doc.output('blob');
                        const url = URL.createObjectURL(blob);
                        openPdfViewer(url, filename);
                    } catch { downloadPDFSafe(doc, filename); }
                } else {
                    downloadPDFSafe(doc, filename);
                }
                (async () => {
                    try {
                        if (syncEnabled && currentUser && supabase && supabase.storage) {
                            const blob = doc.output('blob');
                            const path = `${currentUser.id}/reports/${filename}`;
                            const { error: upErr } = await supabase.storage.from('reports').upload(path, blob, { upsert: true, contentType: 'application/pdf' });
                            if (!upErr) {
                                const { data } = supabase.storage.from('reports').getPublicUrl(path);
                                const publicUrl = data?.publicUrl || '';
                                if (publicUrl) {
                                    try {
                                        await upsertOne('notes', {
                                            title: `Inventory Period ${cycleNumber} PDF`,
                                            content: publicUrl,
                                            date: getTodayDateString(),
                                            time: new Date().toLocaleTimeString(),
                                            timestamp: Date.now()
                                        });
                                        syncInBackground();
                                    } catch { }
                                }
                            }
                        }
                    } catch { }
                })();
                showToast('Period report PDF ready', 'success');
            } catch (e) {
                console.error('Period PDF error:', e);
                showToast('Failed to generate Period PDF', 'error');
            }
        }

        async function downloadInventoryPurchaseItemPDF(ts, mode = 'view') {
            try { if (window.loadLibrary) await loadLibrary('jspdf'); } catch {}
            await ensureLogoReady();
            try {
                const { jsPDF } = window.jspdf || {};
                if (!jsPDF) { showToast('PDF library not loaded', 'error'); return; }
                const p = (state.inventoryPurchases || []).find(x => x.timestamp === ts);
                if (!p) { showToast('Purchase not found', 'error'); return; }
                const doc = new jsPDF({ unit: 'pt', format: 'a4' });
                const pageWidth = doc.internal.pageSize.getWidth();
                const centerX = pageWidth / 2;
                const margin = 50;
                const usableWidth = pageWidth - margin * 2;
                let y = 120;
                doc.setFillColor(240, 240, 240);
                doc.rect(0, 0, pageWidth, 100, 'F');
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(24);
                doc.setFont(undefined, 'bold');
                const profile = (typeof getUserProfileData === 'function') ? getUserProfileData() : (state.userProfile || { businessName: 'TUBA', address: '', phone: '', email: '' });
                doc.text(profile.businessName || 'TUBA', centerX, 45, { align: 'center' });
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text(`${profile.address || ''} | ${profile.phone || ''} | ${profile.email || ''} `, centerX, 70, { align: 'center' });
                doc.setDrawColor(150, 150, 150);
                doc.setLineWidth(3);
                doc.line(margin, 85, pageWidth - margin, 85);
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(18);
                doc.setFont(undefined, 'bold');
                const cycle = (state.inventoryPurchaseCycles || []).find(c => c.number === p.cycleNumber);
                doc.text(`Inventory Item — Period ${p.cycleNumber} ${cycle?.title ? '– ' + cycle.title : ''} `, margin, y);
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(100, 100, 100);
                doc.text(`Generated: ${getTodayDateString()} `, margin, y + 20);
                y += 50;
                const lines = [
                    `Item: ${p.itemName}`,
                    `Date: ${p.purchaseDate || ''}  Time: ${p.time || ''}`,
                    `Quantity: ${String(p.quantity || 1)}  Unit: ${formatNumber(p.unitCost || p.buyingPrice || 0)} Tsh`,
                    `Discount: ${formatNumber(p.discount || 0)} Tsh  Total: ${formatNumber(p.totalCost || p.buyingPrice || 0)} Tsh`,
                    `Supplier: ${(p.supplierName || '')} ${p.supplierPhone ? '(' + p.supplierPhone + ')' : ''}`,
                    `${p.supplierAddress || ''}`,
                    `${p.notes ? 'Notes: ' + p.notes : ''}`
                ].filter(Boolean);
                doc.setTextColor(40, 40, 40);
                doc.setFontSize(12);
                lines.forEach((t) => { doc.text(String(t), margin, y); y += 22; });
                const filename = `Inventory_Item_${ts}.pdf`;
                if (mode === 'view') {
                    try { const blob = doc.output('blob'); const url = URL.createObjectURL(blob); openPdfViewer(url, filename); } catch { downloadPDFSafe(doc, filename); }
                } else { downloadPDFSafe(doc, filename); }
                (async () => {
                    try {
                        if (syncEnabled && currentUser && supabase && supabase.storage) {
                            const blob = doc.output('blob');
                            const path = `${currentUser.id}/reports/${filename}`;
                            const { error: upErr } = await supabase.storage.from('reports').upload(path, blob, { upsert: true, contentType: 'application/pdf' });
                            if (!upErr) {
                                const { data } = supabase.storage.from('reports').getPublicUrl(path);
                                const publicUrl = data?.publicUrl || '';
                                if (publicUrl) {
                                    try {
                                        await upsertOne('notes', { title: `Inventory Item ${p.itemName} (${p.cycleNumber}) PDF`, content: publicUrl, date: getTodayDateString(), time: new Date().toLocaleTimeString(), timestamp: Date.now() });
                                        syncInBackground();
                                    } catch { }
                                }
                            }
                        }
                    } catch { }
                })();
                showToast('Item PDF ready', 'success');
            } catch (e) { showToast('Failed to generate Item PDF', 'error'); }
        }

        async function downloadInventoryStockSheetPDF(options = {}) {
            try { if (window.loadLibrary) await loadLibrary('jspdf'); } catch {}
            await ensureLogoReady();
            try {
                const { jsPDF } = window.jspdf || {};
                if (!jsPDF) {
                    showToast('PDF library not loaded', 'error');
                    return;
                }
                const doc = new jsPDF({ unit: 'pt', format: 'a4' });
                const pageWidth = doc.internal.pageSize.getWidth();
                const centerX = pageWidth / 2;
                const leftMargin = 50;
                const rightMargin = 24;
                const margin = leftMargin;
                const usableWidth = pageWidth - leftMargin - rightMargin;
                let y = 120;

                doc.setFillColor(240, 240, 240);
                doc.rect(0, 0, pageWidth, 100, 'F');
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(24);
                doc.setFont(undefined, 'bold');
                const profile = (typeof getUserProfileData === 'function') ? getUserProfileData() : (state.userProfile || { businessName: 'TUBA', address: '', phone: '', email: '' });
                doc.text(profile.businessName || 'TUBA', centerX, 45, { align: 'center' });
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text(`${profile.address || ''} | ${profile.phone || ''} | ${profile.email || ''} `, centerX, 70, { align: 'center' });
                doc.setDrawColor(150, 150, 150);
                doc.setLineWidth(3);
                doc.line(margin, 85, pageWidth - rightMargin, 85);

                doc.setTextColor(0, 0, 0);
                doc.setFontSize(18);
                doc.setFont(undefined, 'bold');
                doc.text('Inventory Stock Sheet', margin, y);
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(100, 100, 100);
                doc.text(`Generated: ${getTodayDateString()} `, margin, y + 20);
                y += 50;

                const headers = ['#', 'Product', 'Cost', 'S/P', 'QTY', 'Discount', 'Total'];
                const indexW = 18;
                const unitW = Math.round(usableWidth * 0.17);
                const qtyW = 56;
                const discW = Math.max(50, Math.round(unitW * 0.8));
                const totalW = unitW;
                const costW = unitW;
                const spW = unitW;
                const productW = usableWidth - (indexW + costW + spW + qtyW + discW + totalW);
                const cols = [indexW, productW, costW, spW, qtyW, discW, totalW];

                const drawHeader = () => {
                    doc.setFillColor(100, 100, 100);
                    doc.roundedRect(margin, y, usableWidth, 20, 3, 3, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFont(undefined, 'bold');
                    doc.setFontSize(10);
                    let hx = margin;
                    for (let i = 0; i < headers.length; i++) {
                        doc.text(String(headers[i]), hx + 6, y + 14);
                        hx += cols[i];
                    }
                    y += 22;
                    doc.setFont(undefined, 'normal');
                    doc.setFontSize(9);
                    doc.setTextColor(40, 40, 40);
                };

                drawHeader();

                const mode = (options && (options.mode === 'empty' || options.mode === 'empty_categories')) ? options.mode : 'product';
                const emptyRows = Math.max(1, Math.min(parseInt(options?.emptyRows || 10, 10) || 10, 500));
                const { TextField } = jsPDF.AcroForm || {};
                let rowIndex = 0;
                if (mode === 'product') {
                    const products = (state.products || []).filter(p => p.hasStock !== false);
                    const grouped = {};
                    products.forEach(p => {
                        const cat = String(p.category || 'Uncategorized');
                        (grouped[cat] = grouped[cat] || []).push(p);
                    });
                    const categories = Object.keys(grouped).sort((a, b) => String(a).localeCompare(String(b)));
                    for (let ci = 0; ci < categories.length; ci++) {
                        const cat = categories[ci];
                        const items = grouped[cat];
                        const catH = 24;
                        if (y + catH > 750) { doc.addPage(); y = margin; drawHeader(); }
                        doc.setFillColor(230, 230, 230);
                        doc.roundedRect(margin, y, usableWidth, catH, 3, 3, 'F');
                        doc.setTextColor(0, 0, 0);
                        doc.setFont(undefined, 'bold');
                        doc.setFontSize(11);
                        doc.text(String(cat || 'UNCATEGORIZED').toUpperCase(), centerX, y + 16, { align: 'center' });
                        y += catH + 4;
                        doc.setFont(undefined, 'normal');
                        doc.setFontSize(9);
                        doc.setTextColor(40, 40, 40);

                        for (let idx = 0; idx < items.length; idx++) {
                            const p = items[idx];
                            const stockVal = Math.max(0, Number(((state.inventory || {})[String(p.name || '')]?.stock) || 0));
                            const label = String(p.name || '') + ' {' + stockVal + '}';
                            const nameLines = doc.splitTextToSize(label, cols[1] - 16);
                            const rowH = Math.max(nameLines.length * 12 + 10, 34);
                            if (y + rowH > 750) { doc.addPage(); y = margin; drawHeader(); }
                            if (rowIndex % 2 === 0) { doc.setFillColor(248, 249, 250); doc.roundedRect(margin, y, usableWidth, rowH, 2, 2, 'F'); }
                            let x = margin;
                            doc.setTextColor(40, 40, 40);
                            doc.text(String(rowIndex + 1), x + 4, y + 14);
                            x += cols[0];
                            for (let li = 0; li < nameLines.length; li++) { doc.text(nameLines[li], x + 4, y + 14 + li * 10); }
                            x += cols[1];
                            doc.setDrawColor(0, 0, 0);
                            doc.setLineWidth(1);
                            doc.roundedRect(x + 4, y + 4, cols[2] - 8, rowH - 8, 4, 4);
                            if (TextField) { const f = new TextField(); f.fieldName = `cost_${rowIndex}`; f.showWhenPrinted = true; f.fontSize = 12; f.Rect = [x + 6, y + 6, cols[2] - 12, rowH - 12]; doc.addField(f); }
                            x += cols[2];
                            doc.setDrawColor(0, 0, 0);
                            doc.setLineWidth(1);
                            doc.roundedRect(x + 4, y + 4, cols[3] - 8, rowH - 8, 4, 4);
                            if (TextField) { const f2 = new TextField(); f2.fieldName = `sp_${rowIndex}`; f2.showWhenPrinted = true; f2.fontSize = 12; f2.Rect = [x + 6, y + 6, cols[3] - 12, rowH - 12]; doc.addField(f2); }
                            x += cols[3];
                            doc.setDrawColor(0, 0, 0);
                            doc.setLineWidth(1);
                            doc.roundedRect(x + 4, y + 4, cols[4] - 8, rowH - 8, 4, 4);
                            if (TextField) { const f3 = new TextField(); f3.fieldName = `qty_${rowIndex}`; f3.showWhenPrinted = true; f3.fontSize = 12; f3.Rect = [x + 6, y + 6, cols[4] - 12, rowH - 12]; doc.addField(f3); }
                            x += cols[4];
                            doc.setDrawColor(0, 0, 0);
                            doc.setLineWidth(1);
                            doc.roundedRect(x + 4, y + 4, cols[5] - 8, rowH - 8, 4, 4);
                            if (TextField) { const f4 = new TextField(); f4.fieldName = `disc_${rowIndex}`; f4.showWhenPrinted = true; f4.fontSize = 12; f4.Rect = [x + 6, y + 6, cols[5] - 12, rowH - 12]; doc.addField(f4); }
                            x += cols[5];
                            doc.setDrawColor(0, 0, 0);
                            doc.setLineWidth(1);
                            doc.roundedRect(x + 4, y + 4, cols[6] - 8, rowH - 8, 4, 4);
                            if (TextField) { const f5 = new TextField(); f5.fieldName = `total_${rowIndex}`; f5.showWhenPrinted = true; f5.fontSize = 12; f5.Rect = [x + 6, y + 6, cols[6] - 12, rowH - 12]; doc.addField(f5); }
                            y += rowH;
                            rowIndex++;
                        }
                    }
                } else if (mode === 'empty') {
                    for (let idx = 0; idx < emptyRows; idx++) {
                        const rowH = 34;
                        if (y + rowH > 750) { doc.addPage(); y = margin; drawHeader(); }
                        if (rowIndex % 2 === 0) { doc.setFillColor(248, 249, 250); doc.roundedRect(margin, y, usableWidth, rowH, 2, 2, 'F'); }
                        let x = margin;
                        doc.setTextColor(40, 40, 40);
                        doc.text(String(rowIndex + 1), x + 4, y + 14);
                        x += cols[0];
                        doc.setDrawColor(0, 0, 0);
                        doc.setLineWidth(1);
                        doc.roundedRect(x + 4, y + 4, cols[1] - 8, rowH - 8, 4, 4);
                        if (TextField) { const pf = new TextField(); pf.fieldName = `product_${rowIndex}`; pf.showWhenPrinted = true; pf.fontSize = 12; pf.Rect = [x + 6, y + 6, cols[1] - 12, rowH - 12]; doc.addField(pf); }
                        x += cols[1];
                        doc.setDrawColor(0, 0, 0);
                        doc.setLineWidth(1);
                        doc.roundedRect(x + 4, y + 4, cols[2] - 8, rowH - 8, 4, 4);
                        if (TextField) { const f = new TextField(); f.fieldName = `cost_${rowIndex}`; f.showWhenPrinted = true; f.fontSize = 12; f.Rect = [x + 6, y + 6, cols[2] - 12, rowH - 12]; doc.addField(f); }
                        x += cols[2];
                        doc.setDrawColor(0, 0, 0);
                        doc.setLineWidth(1);
                        doc.roundedRect(x + 4, y + 4, cols[3] - 8, rowH - 8, 4, 4);
                        if (TextField) { const f2 = new TextField(); f2.fieldName = `sp_${rowIndex}`; f2.showWhenPrinted = true; f2.fontSize = 12; f2.Rect = [x + 6, y + 6, cols[3] - 12, rowH - 12]; doc.addField(f2); }
                        x += cols[3];
                        doc.setDrawColor(0, 0, 0);
                        doc.setLineWidth(1);
                        doc.roundedRect(x + 4, y + 4, cols[4] - 8, rowH - 8, 4, 4);
                        if (TextField) { const f3 = new TextField(); f3.fieldName = `qty_${rowIndex}`; f3.showWhenPrinted = true; f3.fontSize = 12; f3.Rect = [x + 6, y + 6, cols[4] - 12, rowH - 12]; doc.addField(f3); }
                        x += cols[4];
                        doc.setDrawColor(0, 0, 0);
                        doc.setLineWidth(1);
                        doc.roundedRect(x + 4, y + 4, cols[5] - 8, rowH - 8, 4, 4);
                        if (TextField) { const f4 = new TextField(); f4.fieldName = `disc_${rowIndex}`; f4.showWhenPrinted = true; f4.fontSize = 12; f4.Rect = [x + 6, y + 6, cols[5] - 12, rowH - 12]; doc.addField(f4); }
                        x += cols[5];
                        doc.setDrawColor(0, 0, 0);
                        doc.setLineWidth(1);
                        doc.roundedRect(x + 4, y + 4, cols[6] - 8, rowH - 8, 4, 4);
                        if (TextField) { const f5 = new TextField(); f5.fieldName = `total_${rowIndex}`; f5.showWhenPrinted = true; f5.fontSize = 12; f5.Rect = [x + 6, y + 6, cols[6] - 12, rowH - 12]; doc.addField(f5); }
                        y += rowH;
                        rowIndex++;
                    }
                } else if (mode === 'empty_categories') {
                    const perCat = Math.max(1, Math.min(parseInt(options?.rowsPerCategory || 10, 10) || 10, 500));
                    let categories = Array.isArray(options?.categories) && options.categories.length ? options.categories.slice() : (Array.isArray(state.categories) ? state.categories.slice() : []);
                    if (!categories || categories.length === 0) { const products = (state.products || []); const set = new Set(); products.forEach(p => set.add(String(p.category || 'Uncategorized'))); categories = Array.from(set); }
                    categories.sort((a, b) => String(a).localeCompare(String(b)));
                    for (let ci = 0; ci < categories.length; ci++) {
                        const cat = categories[ci];
                        const catH = 24;
                        if (y + catH > 750) { doc.addPage(); y = margin; drawHeader(); }
                        doc.setFillColor(230, 230, 230);
                        doc.roundedRect(margin, y, usableWidth, catH, 3, 3, 'F');
                        doc.setTextColor(0, 0, 0);
                        doc.setFont(undefined, 'bold');
                        doc.setFontSize(11);
                        // Derive type suffix from products
                        const prods = (state.products || []).filter(p => String(p.category || 'Uncategorized') === String(cat));
                        const hasProd = prods.some(p => p.hasStock !== false);
                        const hasServ = prods.some(p => p.hasStock === false);
                        const typeSuffix = hasProd && hasServ ? ' (MIXED)' : (hasServ ? ' (SERVICES)' : ' (PRODUCTS)');
                        doc.text(String(cat || 'UNCATEGORIZED').toUpperCase() + typeSuffix, centerX, y + 16, { align: 'center' });
                        y += catH + 4;
                        doc.setFont(undefined, 'normal');
                        doc.setFontSize(9);
                        doc.setTextColor(40, 40, 40);
                        for (let idx = 0; idx < perCat; idx++) {
                            const rowH = 34;
                            if (y + rowH > 750) { doc.addPage(); y = margin; drawHeader(); }
                            if ((rowIndex + idx) % 2 === 0) { doc.setFillColor(248, 249, 250); doc.roundedRect(margin, y, usableWidth, rowH, 2, 2, 'F'); }
                            let x = margin;
                            doc.setTextColor(40, 40, 40);
                            doc.text(String(rowIndex + 1), x + 4, y + 14);
                            x += cols[0];
                            doc.setDrawColor(0, 0, 0); doc.setLineWidth(1);
                            doc.roundedRect(x + 4, y + 4, cols[1] - 8, rowH - 8, 4, 4);
                            if (TextField) { const pf = new TextField(); pf.fieldName = `product_${rowIndex}`; pf.showWhenPrinted = true; pf.fontSize = 12; pf.Rect = [x + 6, y + 6, cols[1] - 12, rowH - 12]; doc.addField(pf); }
                            x += cols[1];
                            doc.setDrawColor(0, 0, 0); doc.setLineWidth(1);
                            doc.roundedRect(x + 4, y + 4, cols[2] - 8, rowH - 8, 4, 4);
                            if (TextField) { const f = new TextField(); f.fieldName = `cost_${rowIndex}`; f.showWhenPrinted = true; f.fontSize = 12; f.Rect = [x + 6, y + 6, cols[2] - 12, rowH - 12]; doc.addField(f); }
                            x += cols[2];
                            doc.setDrawColor(0, 0, 0); doc.setLineWidth(1);
                            doc.roundedRect(x + 4, y + 4, cols[3] - 8, rowH - 8, 4, 4);
                            if (TextField) { const f2 = new TextField(); f2.fieldName = `sp_${rowIndex}`; f2.showWhenPrinted = true; f2.fontSize = 12; f2.Rect = [x + 6, y + 6, cols[3] - 12, rowH - 12]; doc.addField(f2); }
                            x += cols[3];
                            doc.setDrawColor(0, 0, 0); doc.setLineWidth(1);
                            doc.roundedRect(x + 4, y + 4, cols[4] - 8, rowH - 8, 4, 4);
                            if (TextField) { const f3 = new TextField(); f3.fieldName = `qty_${rowIndex}`; f3.showWhenPrinted = true; f3.fontSize = 12; f3.Rect = [x + 6, y + 6, cols[4] - 12, rowH - 12]; doc.addField(f3); }
                            x += cols[4];
                            doc.setDrawColor(0, 0, 0); doc.setLineWidth(1);
                            doc.roundedRect(x + 4, y + 4, cols[5] - 8, rowH - 8, 4, 4);
                            if (TextField) { const f4 = new TextField(); f4.fieldName = `disc_${rowIndex}`; f4.showWhenPrinted = true; f4.fontSize = 12; f4.Rect = [x + 6, y + 6, cols[5] - 12, rowH - 12]; doc.addField(f4); }
                            x += cols[5];
                            doc.setDrawColor(0, 0, 0); doc.setLineWidth(1);
                            doc.roundedRect(x + 4, y + 4, cols[6] - 8, rowH - 8, 4, 4);
                            if (TextField) { const f5 = new TextField(); f5.fieldName = `total_${rowIndex}`; f5.showWhenPrinted = true; f5.fontSize = 12; f5.Rect = [x + 6, y + 6, cols[6] - 12, rowH - 12]; doc.addField(f5); }
                            y += rowH;
                            rowIndex++;
                        }
                    }
                }

                const footerH = 30;
                if (y + footerH > 760) { doc.addPage(); y = margin; drawHeader(); }
                let fx = margin;
                doc.setFont(undefined, 'bold');
                doc.setFontSize(10);
                fx += cols[0]; // skip index column
                doc.text('Grand Totals', fx + 8, y + 16);
                doc.setFont(undefined, 'normal');
                fx += cols[1];
                doc.text('-', fx + 8, y + 16); // Cost
                fx += cols[2];
                doc.text('-', fx + 8, y + 16); // S/P
                fx += cols[3];
                doc.text('-', fx + 8, y + 16); // QTY
                fx += cols[4]; // move to Discount
                fx += cols[5]; // move to Total
                doc.setDrawColor(0, 0, 0);
                doc.setLineWidth(1);
                doc.roundedRect(fx + 4, y + 4, cols[6] - 8, footerH - 8, 4, 4);
                const { TextField: TF2 } = jsPDF.AcroForm || {};
                if (TF2) {
                    const grand = new TF2();
                    grand.fieldName = 'grand_total';
                    grand.showWhenPrinted = true;
                    grand.fontSize = 12;
                    grand.Rect = [fx + 6, y + 6, cols[6] - 12, footerH - 12];
                    doc.addField(grand);
                }
                y += footerH;

                if (y + 80 > 760) { doc.addPage(); y = margin; }
                doc.setFont(undefined, 'bold');
                doc.setFontSize(12);
                doc.text('Verification', centerX, y + 10, { align: 'center' });
                doc.setFontSize(9);
                doc.setFont(undefined, 'normal');
                doc.text('Prepared by: _________________________   Date: __________ ', centerX, y + 30, { align: 'center' });
                doc.text('Checked by:  _________________________   Date: __________ ', centerX, y + 50, { align: 'center' });

                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFillColor(240, 240, 240);
                    doc.rect(0, 792 - 30, pageWidth, 30, 'F');
                    doc.setTextColor(100, 100, 100);
                    doc.setFontSize(9);
                    doc.text(`Page ${i} of ${pageCount} `, margin, 792 - 11);
                    doc.text(`The Ultimate Business Architecture(TUBA) © ${new Date().getFullYear()} `, pageWidth - rightMargin, 792 - 8, { align: 'right' });
                }

                downloadPDFSafe(doc, `Inventory_Stocksheet_${getTodayDateString()}.pdf`);
                showToast('Stocksheet PDF ready', 'success');
            } catch (e) {
                console.error('Stocksheet PDF error:', e);
                showToast('Failed to generate stocksheet PDF', 'error');
            }
        }

        async function adjustStock(productName, amount) {
            if (!state.inventory[productName]) {
                state.inventory[productName] = { stock: 0, minAlert: 5 };
            }
            state.inventory[productName].stock = Math.max(0, state.inventory[productName].stock + amount);
            saveData();
            render();
            showToast(`Stock ${amount > 0 ? 'increased' : 'decreased'} `, 'success');
            if (syncEnabled) {
                const inv = state.inventory[productName] || { stock: 0, minAlert: 5 };
                await upsertOne('inventory', { product_name: productName, stock: inv.stock || 0, min_alert: inv.minAlert || 5 });
                syncInBackground();
            }
        }

        async function deleteInventoryByPeriod(productName) {
            const periods = Array.from(new Set((state.inventoryPurchases || [])
                .filter(p => p.itemName === productName)
                .map(p => p.cycleNumber))).sort((a, b) => a - b);
            if (periods.length === 0) { showToast('No purchases found for this product', 'info'); return; }
            let sel = periods[periods.length - 1];
            if (periods.length > 1) {
                const input = prompt(`Enter Period number to delete for ${productName}(${periods.join(', ')})`);
                if (!input) return;
                const num = parseInt(input, 10);
                if (!periods.includes(num)) { showToast('Invalid Period number', 'error'); return; }
                sel = num;
            }
            const toDelete = (state.inventoryPurchases || []).filter(p => p.itemName === productName && p.cycleNumber === sel);
            if (toDelete.length === 0) { showToast('No entries in selected Period', 'info'); return; }
            const qtySum = toDelete.reduce((s, p) => s + (p.quantity || 0), 0);
            const inv = state.inventory[productName] || { stock: 0, minAlert: 5 };
            showConfirm(`Delete ${toDelete.length} purchases for ${productName} in Period ${sel}?`, async function () {
                try { playDeleteSound(); } catch (e) { }
                const ok = await requirePinForDestructive('delete');
                if (!ok) { showToast('PIN Required', 'error'); return; }
                inv.stock = Math.max(0, (inv.stock || 0) - qtySum);
                state.inventory[productName] = inv;
                toDelete.forEach(p => { try { deleteOne('inventory_purchases', { timestamp: p.timestamp }); } catch { } });
                state.inventoryPurchases = (state.inventoryPurchases || []).filter(p => !(p.itemName === productName && p.cycleNumber === sel));
                saveData();
                render();
                showToast('Inventory updated', 'success');
                if (syncEnabled) {
                    await upsertOne('inventory', { product_name: productName, stock: inv.stock || 0, min_alert: inv.minAlert || 5 });
                    syncInBackground();
                }
            });
        }

        async function openUpdateInventoryForProduct(productName) {
            openInventoryModal();
            setTimeout(() => {
                try {
                    invToggleBulkMode(false);
                    const prodSel = document.getElementById('invProductSelect');
                    if (prodSel) { prodSel.value = productName; invHandleProductSelection(); }
                    const last = (state.inventoryPurchases || []).filter(p => p.itemName === productName).sort((a, b) => b.timestamp - a.timestamp)[0];
                    if (last) {
                        const qtyEl = document.getElementById('invQuantity');
                        const unitEl = document.getElementById('invUnitCost');
                        const discEl = document.getElementById('invDiscount');
                        const totalEl = document.getElementById('invTotalCost');
                        const supN = document.getElementById('invSupplierName');
                        const supP = document.getElementById('invSupplierPhone');
                        const supA = document.getElementById('invSupplierAddress');
                        const notesEl = document.getElementById('invNotes');
                        const perSel = document.getElementById('invPeriodSelect');
                        const chkNew = document.getElementById('invCreateNewPeriod');
                        const perTitle = document.getElementById('invNewPeriodTitle');
                        const dateEl = document.getElementById('invDate');
                        const timeEl = document.getElementById('invTime');
                        if (qtyEl) qtyEl.value = String(last.quantity || 1);
                        if (unitEl) unitEl.value = formatMoney(last.unitCost || 0);
                        if (discEl) discEl.value = formatMoney(last.discount || 0);
                        const computedTotal = Math.max(0, (last.quantity || 0) * (last.unitCost || 0) - (last.discount || 0));
                        if (totalEl) totalEl.value = formatMoney(computedTotal);
                        if (supN) supN.value = last.supplierName || '';
                        if (supP) supP.value = last.supplierPhone || '';
                        if (supA) supA.value = last.supplierAddress || '';
                        if (notesEl) notesEl.value = last.notes || '';
                        if (dateEl) dateEl.value = last.purchaseDate || dateEl.value;
                        if (timeEl) timeEl.value = last.time || timeEl.value;
                        if (perSel) perSel.value = String(last.cycleNumber || '');
                        if (chkNew) chkNew.checked = !Boolean(last.cycleNumber);
                        const cycle = (state.inventoryPurchaseCycles || []).find(c => c.number === last.cycleNumber);
                        if (perTitle && cycle && cycle.title) perTitle.value = cycle.title;
                    }
                } catch { }
            }, 50);
        }

        async function openUpdateInventoryForPurchase(ts) {
            const p = (state.inventoryPurchases || []).find(x => x.timestamp === ts);
            if (!p) { showToast('Purchase not found', 'error'); return; }
            openInventoryModal();
            setTimeout(() => {
                try {
                    invToggleBulkMode(false);
                    const prodSel = document.getElementById('invProductSelect');
                    if (prodSel) { prodSel.value = p.itemName; invHandleProductSelection(); }
                    const qtyEl = document.getElementById('invQuantity');
                    const unitEl = document.getElementById('invUnitCost');
                    const discEl = document.getElementById('invDiscount');
                    const totalEl = document.getElementById('invTotalCost');
                    const supN = document.getElementById('invSupplierName');
                    const supP = document.getElementById('invSupplierPhone');
                    const supA = document.getElementById('invSupplierAddress');
                    const notesEl = document.getElementById('invNotes');
                    const perSel = document.getElementById('invPeriodSelect');
                    const chkNew = document.getElementById('invCreateNewPeriod');
                    const perTitle = document.getElementById('invNewPeriodTitle');
                    const dateEl = document.getElementById('invDate');
                    const timeEl = document.getElementById('invTime');
                    if (qtyEl) qtyEl.value = String(p.quantity || 1);
                    if (unitEl) unitEl.value = formatMoney(p.unitCost || p.buyingPrice || 0);
                    if (discEl) discEl.value = formatMoney(p.discount || 0);
                    const computedTotal = Math.max(0, (p.quantity || 0) * (p.unitCost || p.buyingPrice || 0) - (p.discount || 0));
                    if (totalEl) totalEl.value = formatMoney(computedTotal);
                    if (supN) supN.value = p.supplierName || '';
                    if (supP) supP.value = p.supplierPhone || '';
                    if (supA) supA.value = p.supplierAddress || '';
                    if (notesEl) notesEl.value = p.notes || '';
                    if (dateEl) dateEl.value = p.purchaseDate || dateEl.value;
                    if (timeEl) timeEl.value = p.time || timeEl.value;
                    if (perSel) perSel.value = String(p.cycleNumber || '');
                    if (chkNew) chkNew.checked = !Boolean(p.cycleNumber);
                    const cycle = (state.inventoryPurchaseCycles || []).find(c => c.number === p.cycleNumber);
                    if (perTitle && cycle && cycle.title) perTitle.value = cycle.title;
                } catch { }
            }, 50);
        }

        async function deleteInventoryPurchaseByTimestamp(ts) {
            const p = (state.inventoryPurchases || []).find(x => x.timestamp === ts);
            if (!p) { showToast('Purchase not found', 'error'); return; }
            try { playDeleteSound(); } catch (e) { }
            const ok = await requirePinForDestructive('delete');
            if (!ok) { showToast('PIN Required', 'error'); return; }
            if (p.activated) {
                const inv = state.inventory[p.itemName] || { stock: 0, minAlert: 5 };
                inv.stock = Math.max(0, (inv.stock || 0) - (p.quantity || 0));
                state.inventory[p.itemName] = inv;
            }
            try { deleteOne('inventory_purchases', { timestamp: ts }); } catch { }
            state.inventoryPurchases = (state.inventoryPurchases || []).filter(x => x.timestamp !== ts);
            try {
                const periodComment = `Period ${p.cycleNumber} `;
                const idx = (state.expenses || []).findIndex(e => e.category === 'Inventory Purchase' && e.comment === periodComment);
                if (idx !== -1) {
                    state.expenses[idx].amount = Math.max(0, (state.expenses[idx].amount || 0) - (p.totalCost || p.buyingPrice || 0));
                    if (state.expenses[idx].amount === 0) {
                        const expId = state.expenses[idx].id;
                        try { deleteOne('expenses', { id: expId }); } catch { }
                        state.expenses.splice(idx, 1);
                    } else {
                        const e = state.expenses[idx];
                        await upsertOne('expenses', {
                            id: e.id,
                            date: e.date,
                            time: e.time,
                            timestamp: e.timestamp,
                            description: e.description,
                            category: e.category,
                            amount: e.amount,
                            payment: e.payment,
                            comment: e.comment
                        });
                    }
                }
            } catch { }
            saveData();
            render();
            showToast('Purchase deleted', 'success');
            if (syncEnabled) {
                const inv = state.inventory[p.itemName] || { stock: 0, minAlert: 5 };
                await upsertOne('inventory', { product_name: p.itemName, stock: inv.stock || 0, min_alert: inv.minAlert || 5 });
                syncInBackground();
            }
        }

        async function saveStockFor(productName) {
            const el = document.getElementById('inv_input_' + encodeURIComponent(productName));
            if (!el) return showToast("Input not found", "error");
            const v = parseInt(el.value);
            if (isNaN(v) || v < 0) return showToast("Invalid value", "error");
            if (!state.inventory) state.inventory = {};
            state.inventory[productName] = state.inventory[productName] || { stock: 0, minAlert: 5 };
            state.inventory[productName].stock = v;

            saveData();
            render();
            showToast("Stock updated", "success");

            // Sync inventory snapshot to cloud
            if (syncEnabled) {
                const inv = state.inventory[productName] || { stock: 0, minAlert: 5 };
                await upsertOne('inventory', { product_name: productName, stock: inv.stock || 0, min_alert: inv.minAlert || 5 });
                syncInBackground();
            }
        }

        function setMinAlert(productName) {
            const current = state.inventory[productName]?.minAlert || 5;
            const newValue = prompt(`Set minimum stock alert for ${productName}: `, current);
            if (newValue !== null) {
                const val = parseInt(newValue);
                if (!isNaN(val) && val >= 0) {
                    if (!state.inventory[productName]) {
                        state.inventory[productName] = { stock: 0, minAlert: 5 };
                    }
                    state.inventory[productName].minAlert = val;
                    saveData();
                    render();
                    showToast('Min alert updated', 'success');

                    // Sync in background
                    if (syncEnabled) syncInBackground();
                } else {
                    showToast('Invalid value', 'error');
                }
            }
        }

        function renderCustomers() {
            const q = state.customerSearch || '';
            let sortedCustomers = [...state.customers].filter(c => !(c && c.deleted === true));
            const sort = state.customerSort || 'purchases_desc';
            if (sort === 'name_asc') {
                sortedCustomers.sort((a, b) => String(a.name || '').localeCompare(String(b.name || '')));
            } else if (sort === 'purchases_desc') {
                sortedCustomers.sort((a, b) => (b.totalPurchases || 0) - (a.totalPurchases || 0));
            } else if (sort === 'recent') {
                const lastSale = name => {
                    const sl = (state.sales || []).filter(s => s.customer === name).sort((a, b) => Number(b.timestamp) - Number(a.timestamp));
                    return sl[0]?.timestamp || 0;
                };
                sortedCustomers.sort((a, b) => lastSale(b.name) - lastSale(a.name));
            }

            return `
                <div class="card">
                    <h2>Add Customer</h2>
                    <form onsubmit="addCustomer(event)">
                        <div class="form-group">
                            <label>Name</label>
                            <input type="text" id="customerName" placeholder="Full name" required>
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="customerEmail" placeholder="email@example.com">
                        </div>
                        <div class="form-group">
                            <label>Phone</label>
                            <input type="tel" id="customerPhone" placeholder="+255...">
                        </div>
                        <div class="form-group">
                            <label>Address</label>
                            <input type="text" id="customerAddress" placeholder="Address">
                        </div>
                        <button type="submit">Add Customer</button>
                    </form>
                    </div>

                <div class="card">
                    <h2>All Customers (${(state.customers || []).filter(c => !(c && c.deleted === true)).length})</h2>
                    <div class="card-header-buttons"><button class="btn-small" onclick="copyAllCustomers()">📋 Copy All</button></div>
                    <div class="flex-gap" style="align-items:center;margin-bottom:8px;">
                        <input type="search" name="search_field_unique_${Date.now()}" autocomplete="off" placeholder="🔍 Search customers..." oninput="searchCustomers(this.value)" id="customerSearch" value="${q}" style="flex:1;" readonly onfocus="this.removeAttribute('readonly');">
                        <select id="customerSort" onchange="setCustomerSort(this.value)" style="width:auto;">
                            <option value="purchases_desc" ${sort === 'purchases_desc' ? 'selected' : ''}>Sort by Purchases</option>
                            <option value="name_asc" ${sort === 'name_asc' ? 'selected' : ''}>Name A–Z</option>
                            <option value="recent" ${sort === 'recent' ? 'selected' : ''}>Recent Activity</option>
                        </select>
                    </div>
                    <div style="margin-bottom:8px;">${renderTagChips('customers')}</div>

                    ${state.customers.length > 0 ? `
        <div class="bulk-actions">
            <input type="checkbox" id="selectAll_customers" onchange="toggleSelectAll('customers')" class="checkbox-select">
            <label for="selectAll_customers">Select All</label>
            <span style="color: #666; font-size: 12px; margin-left: 8px;">
                ${getSelectedCount('customers')} selected
            </span>
            <button class="btn-small btn-danger" onclick="bulkDelete('customers')" ${!hasSelected('customers') ? 'disabled' : ''}>
                🗑️ Delete Selected
            </button>
            <button class="btn-small btn-tag" onclick="bulkApplyTag('customers')" ${!hasSelected('customers') ? 'disabled' : ''} title="📌 Apply Tag">📌 Apply Tag</button>
        </div>
    ` : ''}

                    <div id="customersList" class="list-scroll-container">${renderCustomersList(q, sortedCustomers)}</div>
                    ${(() => { const total = (state.customers || []).filter(c => !q || c.name.toLowerCase().includes(q.toLowerCase()) || (c.email && c.email.toLowerCase().includes(q.toLowerCase())) || (c.phone && c.phone.includes(q))).length; const count = (state.listShowCount && state.listShowCount.customers) ? state.listShowCount.customers : 3; const hasMore = count < total; return `<div class=\"flex-gap\" style=\"justify-content:center;margin:8px 0;flex-wrap:nowrap;\"><button class=\"collapse-btn\" onclick=\"${hasMore ? `showMoreList('customers')` : `collapseList('customers')`}\"><span class=\"collapse-icon ${hasMore ? '' : 'expanded'}\">▼</span><span>${hasMore ? 'See more' : 'Hide'}</span></button><button class=\"collapse-btn\" onclick=\"showAllList('customers')\"><span class=\"collapse-icon\">▼</span><span>Show all</span></button></div>`; })()}
                </div>
            `;
        }
        function setCustomerSort(val) { state.customerSort = String(val || 'purchases_desc'); render(); }

        function renderCustomersList(searchPeriod = '', sorted = null) {
            let customers = Array.isArray(sorted) ? sorted : state.customers;
            customers = customers.filter(c => !(c && c.deleted === true));
            if (searchPeriod) {
                const Period = searchPeriod.toLowerCase();
                customers = customers.filter(c =>
                    c.name.toLowerCase().includes(Period) ||
                    (c.email && c.email.toLowerCase().includes(Period)) ||
                    (c.phone && c.phone.includes(Period))
                );
            }
            customers = filterItemsByTags(customers, ((state.filterTags||{}).customers)||[], false);

            if (customers.length === 0) {
                return '<p style="text-align: center; color: #666;">No customers found</p>';
            }
            return customers.map((c, i) => {
                const actualIndex = state.customers.indexOf(c);
                const purchaseCount = state.sales.filter(s => s.customer === c.name).length;
                const editing = state.inlineEditCustomers && state.inlineEditCustomers[actualIndex];
                return `
                <div class="item">
                    <div style="display: flex; gap: 12px; align-items: start;">
                        <input type="checkbox" class="checkbox-select"
                            ${state.selectedItems.customers && state.selectedItems.customers[c.id] ? 'checked' : ''}
                            onchange="toggleSelect('customers', '${c.id}')">
                            <div style="flex: 1;">
                                ${editing ? `
                                <div class="form-group" data-label="Name"><input type="text" id="custName_${actualIndex}" value="${c.name || ''}" placeholder="Name"></div>
                                <div class="form-group" data-label="Email"><input type="email" id="custEmail_${actualIndex}" value="${c.email || ''}" placeholder="email@example.com"></div>
                                <div class="form-group" data-label="Phone"><input type="tel" id="custPhone_${actualIndex}" value="${c.phone || ''}" placeholder="+255..."></div>
                                <div class="form-group" data-label="Address"><input type="text" id="custAddress_${actualIndex}" value="${c.address || ''}" placeholder="Address"></div>
                                ` : `
                                <div class="item-title">${c.name}</div>
                                <div class="item-subtitle">
                                    ${c.email ? '📧 ' + c.email + '<br>' : ''}
                                    ${c.phone ? '📱 ' + c.phone + '<br>' : ''}
                                    ${c.address ? '📍 ' + c.address + '<br>' : ''}
                                    <div style="color: #2e7d32; font-weight: 600; margin-top: 4px;">
                                         Total Purchases:  ${formatNumber(c.totalPurchases || 0)} Tsh<br>
                                            📊 ${purchaseCount} transactions
                                    </div>
                                </div>
                                `}
                                <div class="flex-gap" style="margin-top:8px;">
                    <button class="btn-small" onclick="viewCustomerHistory(${actualIndex})">History</button>
                    ${editing ? `
                    <button class="btn-small btn-success" onclick="saveCustomerInlineEdit(${actualIndex})">Save</button>
                    <button class="btn-small btn-secondary" onclick="toggleCustomerInlineEdit(${actualIndex})">Cancel</button>
                    ` : `
                    <button class="btn-small" onclick="toggleCustomerInlineEdit(${actualIndex})">Edit</button>
                    <button class="btn-small btn-danger btn-delete" data-action="delete" onclick="deleteCustomerIndex(${actualIndex})">Delete</button>
                    `}
                    <button class="btn-small" style="${state.theme === 'dark' ? 'background:#1f2937;color:#e5e7eb;border:1px solid #374151;' : 'background:#e8e8e8;color:#333;border:1px solid #999;'}" onclick="openItemTagsModal('customers', '${c.id}')">📌 Tag</button>
                    <button class="btn-small" onclick="copyCustomerByIndex(${actualIndex})">📋 Copy</button>
                    
                </div>
                                ${renderTagBadges(c)}
                            </div>
                    </div>
        </div >
                `;
            }).join('');
        }

        function searchCustomers(Period) {
            state.customerSearch = Period;
            document.getElementById('customersList').innerHTML = renderCustomersList(Period);
        }

        function viewCustomerHistory(i) {
            const customer = state.customers[i];
            if (!customer) return showToast("Customer not found", "error");

            const sales = state.sales.filter(s => s.customer === customer.name);

            if (sales.length === 0) {
                showToast("No purchase history", "info");
                return;
            }

            let history = `${customer.name} 's Purchase History:\n\n`;
            sales.slice(-10).reverse().forEach(s => {
                history += `${s.date}: ${s.productName} (${s.category || 'N/A'}) - ${formatNumber(s.totalPrice)} Tsh\n`;
            });

            alert(history);
        }
        window.addEventListener('keydown', function (e) {
            const tag = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : '';
            const typing = (tag === 'input' || tag === 'textarea' || e.ctrlKey || e.metaKey);
            if (typing) return;
            if (e.key === '/') {
                if (state.activeTab === 'invoices') {
                    const el = document.getElementById('invoiceSearchInput');
                    if (el) el.focus();
                }
                e.preventDefault();
            } else if (e.key.toLowerCase() === 'n') {
                switchTab('sales');
            } else if (e.key.toLowerCase() === 'i') {
                switchTab('invoices');
                switchInvoiceTab('invoice');
            } else if (e.key === '?') {
                openShortcutsModal();
            }
        });
        function openShortcutsModal() {
            let m = document.getElementById('shortcutsModal');
            if (!m) {
                const el = document.createElement('div');
                el.className = 'modal';
                el.id = 'shortcutsModal';
                el.innerHTML = `
                    <div class="modal-content" style="max-width:520px;">
                        <button class="modal-close" onclick="closeShortcutsModal()">×</button>
                        <div class="modal-title">Keyboard Shortcuts</div>
                        <div class="card" style="margin-top:8px;">
                            <div class="item"><div class="item-header"><span class="item-title">/</span><span class="badge">Invoices</span></div><div class="item-subtitle">Focus invoice search</div></div>
                            <div class="item"><div class="item-header"><span class="item-title">N</span><span class="badge">Global</span></div><div class="item-subtitle">New Sale</div></div>
                            <div class="item"><div class="item-header"><span class="item-title">I</span><span class="badge">Global</span></div><div class="item-subtitle">Go to Invoices</div></div>
                            <div class="item"><div class="item-header"><span class="item-title">?</span><span class="badge">Global</span></div><div class="item-subtitle">Show shortcuts</div></div>
                        </div>
                    </div>`;
                document.body.appendChild(el);
                m = document.getElementById('shortcutsModal');
            }
            m.classList.add('show');
            try { window.__updateModalOverflow && window.__updateModalOverflow(); } catch {}
        }
        function closeShortcutsModal() {
            const m = document.getElementById('shortcutsModal');
            if (m) { m.classList.remove('show'); }
            try { window.__updateModalOverflow && window.__updateModalOverflow(); } catch {}
        }
        function openPdfPreviewFromDoc(doc, title) {
            try {
                const url = doc.output('bloburl');
                let m = document.getElementById('pdfPreviewModal');
                if (!m) {
                    const el = document.createElement('div');
                    el.className = 'modal';
                    el.id = 'pdfPreviewModal';
                    el.innerHTML = `
                        <div class="modal-content" style="max-width:820px;">
                            <button class="modal-close" onclick="closePdfPreview()">×</button>
                            <div class="modal-title">${title || 'Preview'}</div>
                            <iframe id="pdfPreviewFrame" style="width:100%;height:70vh;border:1px solid #ddd;border-radius:6px;"></iframe>
                        </div>`;
                    document.body.appendChild(el);
                    m = document.getElementById('pdfPreviewModal');
                }
                const frame = document.getElementById('pdfPreviewFrame');
                if (frame) frame.src = url;
                m.classList.add('show');
                try { window.__updateModalOverflow && window.__updateModalOverflow(); } catch {}
            } catch (e) { console.error('Preview error:', e); showToast('Preview failed', 'error'); }
        }
        function closePdfPreview() {
            const m = document.getElementById('pdfPreviewModal');
            if (m) { m.classList.remove('show'); }
            try { window.__updateModalOverflow && window.__updateModalOverflow(); } catch {}
        }
        function matchesInvoiceFilter(inv) {
            const f = state.invoiceFilter || 'all';
            if (f === 'all') return true;
            if (f === 'unpaid') return inv.status !== 'Paid';
            if (f === 'paid') return inv.status === 'Paid';
            if (f === 'overdue') return inv.status !== 'Paid' && new Date(inv.dueDate) < new Date();
            if (f === 'month') {
                const d = new Date(inv.date);
                const now = new Date();
                return d.getFullYear() === now.getFullYear() && d.getMonth() === now.getMonth();
            }
            return true;
        }
        function setInvoiceFilter(f) { state.invoiceFilter = f; render(); }
        function matchesInvoiceSearch(inv) {
            const q = (state.invoiceSearch || '').trim().toLowerCase();
            if (!q) return true;
            const num = String(inv.number || '').toLowerCase();
            const cust = String(inv.customer || '').toLowerCase();
            return num.includes(q) || cust.includes(q);
        }
        function matchesInvoiceTagFilter(inv) {
            const sel = ((state.filterTags || {}).invoices) || [];
            if (!sel.length) return true;
            const tags = getItemTags(inv);
            return sel.some(t => tags.includes(t));
        }
        function searchInvoices(val) {
            state.invoiceSearch = String(val || '');
            render();
        }
        function copyText(txt) {
            try { navigator.clipboard.writeText(String(txt || '')); showToast('Copied', 'success'); } catch { }
        }

        function copyInvoiceDetails(idx) {
            const inv = (state.invoices || [])[idx];
            if (!inv) return;
            const custName = String(inv.customer || '').trim();
            const cust = (state.customers || []).find(c => String(c.name || '').trim().toLowerCase() === custName.toLowerCase());
            const email = cust ? String(cust.email || '') : '';
            const phone = cust ? String(cust.phone || '') : '';
            const address = cust ? String(cust.address || '') : '';
            const currency = getCurrencySymbol();
            const items = Array.isArray(inv.items) ? inv.items.map(it => `${String(it.description || it.item || '').trim()} — ${formatNumber(Number(it.amount || it.price || 0))} ${currency}`).join('\n') : '';
            const lines = [
                `Invoice: ${String(inv.number || '')}`,
                `Customer: ${custName}`,
                email ? `Email: ${email}` : '',
                phone ? `Phone: ${phone}` : '',
                address ? `Address: ${address}` : '',
                inv.date ? `Date: ${inv.date}` : '',
                inv.dueDate ? `Due: ${inv.dueDate}` : '',
                `Status: ${String(inv.status || '')}`,
                `Amount: ${formatNumber(Number(inv.amount || 0))} ${currency}`,
                items ? `Items:\n${items}` : ''
            ].filter(Boolean).join('\n');
            copyText(lines);
        }

        function copyAllSales() {
            const currency = getCurrencySymbol();
            const lines = (state.sales || []).map(s => `${s.date} ${s.time} — ${s.productName} — ${s.customer} — Qty: ${s.quantity} — ${s.payment} — Cost: ${formatNumber(s.totalCost)} ${currency} — Price: ${formatNumber(s.totalPrice)} ${currency} — Profit: ${formatNumber(s.profit)} ${currency}`).join('\n');
            const header = `SALES (${(state.sales || []).length})`;
            copyText([header, lines].filter(Boolean).join('\n'));
        }
        function copySaleByTimestamp(ts) {
            const s = (state.sales || []).find(x => Number(x.timestamp) === Number(ts));
            if (!s) return;
            const currency = getCurrencySymbol();
            const lines = [
                `Date: ${s.date} ${s.time}`,
                `Product: ${s.productName}`,
                `Customer: ${s.customer}`,
                `Qty: ${s.quantity}`,
                `Payment: ${s.payment}`,
                `Cost/Unit: ${formatNumber(s.costPerUnit)} ${currency}`,
                `Price/Unit: ${formatNumber(s.pricePerUnit)} ${currency}`,
                `Total Cost: ${formatNumber(s.totalCost)} ${currency}`,
                `Total Price: ${formatNumber(s.totalPrice)} ${currency}`,
                `Profit: ${formatNumber(s.profit)} ${currency}`
            ].join('\n');
            copyText(lines);
        }
        function copyCurrentSaleEntry() {
            const idx = document.getElementById('saleProduct')?.value;
            const product = state.products[idx];
            if (!product) { copyText(''); return; }
            const quantity = parseMoney(document.getElementById('saleQuantity')?.value) || 1;
            const payment = document.getElementById('salePayment')?.value || 'Cash';
            const sel = document.getElementById('saleCustomer')?.value;
            let customerName = 'WALK IN';
            if (sel === 'new') {
                const nm = (document.getElementById('newCustomerName')?.value || '').trim();
                if (nm) customerName = nm;
            } else if (sel) {
                const c = state.customers[sel];
                customerName = (c && c.name) ? c.name : 'WALK IN';
            }
            const cogsMethod = String(state.cogsMethod || 'product_cost');
            const avgCost = computeAveragePurchaseCost(product.name);
            const fifoCost = computeFifoUnitCost(product.name, Date.now(), quantity);
            let unitCost = (product.cost || 0);
            if (cogsMethod === 'avg_purchase_cost' && avgCost > 0) unitCost = avgCost;
            if (cogsMethod === 'fifo' && fifoCost > 0) unitCost = fifoCost;
            const manualEl = document.getElementById('manualPrice');
            const pricePerUnit = manualEl ? (parseMoney(manualEl.value) || product.price) : product.price;
            const totalCost = unitCost * quantity;
            const totalPrice = pricePerUnit * quantity;
            const now = new Date();
            const text = `${getTodayDateString()} ${now.toLocaleTimeString()}\n${customerName} | Qty: ${quantity} | ${payment}\nCost: ${formatNumber(totalCost)} | Price: ${formatNumber(totalPrice)}`;
            copyText(text);
        }
        function copyAllTransactions() {
            const ch = state.activeTransactionChannel || 'mpesa';
            const currency = getCurrencySymbol();
            const tx = (state.transactions || []).filter(t => t.channel === ch);
            const lines = tx.map(t => `${t.date} ${t.time} — ${t.channel.toUpperCase()} — ${t.type.toUpperCase()} — ${t.customerName || 'N/A'} — ${t.type === 'deposit' ? '+' : '-'}${formatNumber(t.amount)} ${currency}`).join('\n');
            const header = `TRANSACTIONS ${ch.toUpperCase()} (${tx.length})`;
            copyText([header, lines].filter(Boolean).join('\n'));
        }
        function copyTransactionByTimestamp(ts) {
            const t = (state.transactions || []).find(x => Number(x.timestamp) === Number(ts));
            if (!t) return;
            const currency = getCurrencySymbol();
            const sign = t.type === 'deposit' ? '+' : '-';
            const lines = [
                `Date: ${t.date} ${t.time}`,
                `Channel: ${String(t.channel || '').toUpperCase()}`,
                `Type: ${String(t.type || '').toUpperCase()}`,
                `Customer: ${t.customerName || 'N/A'}`,
                `Amount: ${sign}${formatNumber(t.amount)} ${currency}`
            ].join('\n');
            copyText(lines);
        }
        function copyAllIncome() {
            const currency = getCurrencySymbol();
            const lines = (state.income || []).map(i => `${i.date} ${i.time} — ${i.source} — ${formatNumber(i.amount)} ${currency} — ${i.payment || ''}${i.comment ? ' — ' + i.comment : ''}`).join('\n');
            const header = `INCOME (${(state.income || []).length})`;
            copyText([header, lines].filter(Boolean).join('\n'));
        }
        function copyIncomeByTimestamp(ts) {
            const i = (state.income || []).find(x => Number(x.timestamp) === Number(ts));
            if (!i) return;
            const currency = getCurrencySymbol();
            const lines = [
                `Date: ${i.date} ${i.time}`,
                `Source: ${i.source}`,
                `Amount: ${formatNumber(i.amount)} ${currency}`,
                `Payment: ${i.payment || ''}`,
                i.comment ? `Comment: ${i.comment}` : ''
            ].filter(Boolean).join('\n');
            copyText(lines);
        }
        function copyAllExpenses() {
            const currency = getCurrencySymbol();
            const lines = (state.expenses || []).map(e => `${e.date} ${e.time} — ${e.description} — ${e.category} — ${formatNumber(e.amount)} ${currency} — ${e.payment || ''}${e.comment ? ' — ' + e.comment : ''}`).join('\n');
            const header = `EXPENSES (${(state.expenses || []).length})`;
            copyText([header, lines].filter(Boolean).join('\n'));
        }
        function copyCustomerByIndex(idx) {
            const c = (state.customers || [])[idx];
            if (!c) return;
            const currency = getCurrencySymbol();
            const purchaseCount = (state.sales || []).filter(s => s.customer === c.name).length;
            const lines = [
                `Name: ${c.name}`,
                c.email ? `Email: ${c.email}` : '',
                c.phone ? `Phone: ${c.phone}` : '',
                c.address ? `Address: ${c.address}` : '',
                `Total Purchases: ${formatNumber(c.totalPurchases || 0)} ${currency}`,
                `Transactions: ${purchaseCount}`
            ].filter(Boolean).join('\n');
            copyText(lines);
        }
        function copyReceiptDetails(idx) {
            const r = (state.receipts || [])[idx];
            if (!r) return;
            const currency = getCurrencySymbol();
            const lines = [
                `Receipt: ${String(r.number || '')}`,
                `Customer: ${String(r.customer || '')}`,
                `Date: ${r.date} ${r.time}`,
                `Description: ${String(r.description || '')}`,
                `Amount: ${formatNumber(Number(r.amount || 0))} ${currency}`,
                `Payment Method: ${String(r.paymentMethod || '')}`
            ].join('\n');
            copyText(lines);
        }
        function copyAllReceipts() {
            const currency = getCurrencySymbol();
            const lines = (state.receipts || []).map(r => `${r.date} ${r.time} — ${r.number} — ${r.customer} — ${formatNumber(Number(r.amount || 0))} ${currency} — ${r.paymentMethod || ''}`).join('\n');
            const header = `RECEIPTS (${(state.receipts || []).length})`;
            copyText([header, lines].filter(Boolean).join('\n'));
        }
        function copyUserProfile() {
            const p = getUserProfileData();
            const currency = `${state.currencyCode || 'TZS'} (${getCurrencySymbol() || 'Tsh'})`;
            const lines = [
                `Business: ${p.businessName || ''}`,
                `Email: ${p.email || ''}`,
                `Phone: ${p.phone || ''}`,
                `Country: ${p.country || ''}`,
                `City: ${p.city || ''}`,
                `Address: ${p.address || ''}`,
                p.tinNumber ? `TIN: ${p.tinNumber}` : '',
                p.blNumber ? `BL-No: ${p.blNumber}` : '',
                p.hasVAT ? `VAT: ${p.vatNumber || ''}` : '',
                `Role: ${p.role || 'owner'}`,
                `Currency: ${currency}`,
                `COGS: ${String(state.cogsMethod || 'product_cost')}`,
                `Default Tax Rate: ${typeof state.defaultTaxRate === 'number' ? state.defaultTaxRate : (state.defaultTaxRate || 0)}%`
            ].filter(Boolean).join('\n');
            copyText(lines);
        }
        function copyAllCustomers() {
            const lines = (state.customers || []).map(c => {
                const purchaseCount = (state.sales || []).filter(s => s.customer === c.name).length;
                return `${c.name}${c.email ? ' — ' + c.email : ''}${c.phone ? ' — ' + c.phone : ''}${c.address ? ' — ' + c.address : ''} — Purchases: ${formatNumber(c.totalPurchases || 0)} — Transactions: ${purchaseCount}`;
            }).join('\n');
            const header = `CUSTOMERS (${(state.customers || []).length})`;
            copyText([header, lines].filter(Boolean).join('\n'));
        }



        async function addCustomer(e) {
            e.preventDefault();
            const name = document.getElementById('customerName').value.trim();

            if (state.customers.some(c => c.name.toLowerCase() === name.toLowerCase())) {
                return showToast('Customer already exists', 'error');
            }

            const customer = {
                id: generateID('customers'),
                name: name,
                email: document.getElementById('customerEmail').value.trim(),
                phone: document.getElementById('customerPhone').value.trim(),
                address: document.getElementById('customerAddress').value.trim(),
                totalPurchases: 0
            };

            state.customers.push(customer);
            saveData();
            render();
            showToast("Customer added", "success");

            // Sync in background
            if (syncEnabled) syncInBackground();
        }
        async function toggleCustomerInlineEdit(i) {
            openCustomerInlineEditModal(i);
        }
        async function saveCustomerInlineEdit(i) {
            const c = state.customers[i];
            if (!c) return false;
            const oldName = c.name;
            const oldEmail = c.email || '';
            const name = document.getElementById(`custName_${i}`)?.value || c.name || '';
            const email = document.getElementById(`custEmail_${i}`)?.value || c.email || '';
            const phone = document.getElementById(`custPhone_${i}`)?.value || c.phone || '';
            const address = document.getElementById(`custAddress_${i}`)?.value || c.address || '';
            c.name = name.trim();
            c.email = email.trim();
            c.phone = phone.trim();
            c.address = address.trim();
            saveData();
            state.inlineEditCustomers[i] = false;
            render();
            showToast('Customer updated', 'success');
            if (syncEnabled) {
                try {
                    await upsertOne('customers', { name: c.name, email: c.email || '', phone: c.phone || '', address: c.address || '' });
                    if (oldName !== c.name || oldEmail !== (c.email || '')) {
                        try { await deleteOne('customers', { name: oldName, email: oldEmail }); } catch {}
                    }
                } catch { }
                syncInBackground();
            }
            return true;
        }

        async function deleteCustomerIndex(i) {
            try { playDeleteSound(); } catch (e) { }
            const ok = await requirePinForDestructive('delete');
            if (!ok) { showToast('PIN Required', 'error'); return; }
            const c = state.customers[i];
            if (c) {
                try {
                    if (navigator.onLine && syncEnabled && currentUser) {
                        await deleteOne('customers', { name: c.name, email: c.email || '' });
                    } else {
                        await deleteOne('customers', { name: c.name, email: c.email || '' });
                    }
                } catch { }
            }
            state.customers.splice(i, 1);
            saveData();
            render();
            showToast("Customer deleted", "success");

            if (syncEnabled) syncInBackground();
        }

        function renderInvoices() {
            const stats = getStats();
            const unpaidCount = (state.invoices || []).filter(i => i.status !== 'Paid' && i.deleted !== true).length;
            const overdueCount = (state.invoices || []).filter(i => i.status !== 'Paid' && i.deleted !== true && new Date(i.dueDate) < new Date()).length;
            const draft = (state.invoiceDraft && typeof state.invoiceDraft === 'object') ? state.invoiceDraft : {};
            const draftCustomer = (draft.customerSelect != null) ? String(draft.customerSelect) : '';
            const draftItems = (Array.isArray(draft.items) && draft.items.length) ? draft.items : [{ description: '', amount: '' }];
            const escAttr = (v) => String(v == null ? '' : v).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/"/g, '&quot;');
            return `
    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-bottom: 12px;">
        <div class="stat-card" style="padding: 12px;">
            <div class="stat-label" style="font-size: 10px;">TOTAL INVOICED</div>
            <div class="stat-value" style="font-size: 16px;"> ${formatNumber(stats.totalInvoiced)} ${getCurrencySymbol()}</div>
        </div>
        <div class="stat-card" style="background: #2e7d32; padding: 12px;">
            <div class="stat-label" style="font-size: 10px;">PAID</div>
            <div class="stat-value" style="font-size: 16px;"> ${formatNumber(stats.totalPaid)} ${getCurrencySymbol()}</div>
        </div>
    </div>
    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-bottom: 12px;">
        <div class="stat-card" style="padding: 12px;">
            <div class="stat-label" style="font-size: 10px;">UNPAID</div>
            <div class="stat-value" style="font-size: 16px;">${unpaidCount}</div>
        </div>
        <div class="stat-card" style="background: #d32f2f; padding: 12px; color: #fff;">
            <div class="stat-label" style="font-size: 10px; color: #fff;">OVERDUE</div>
            <div class="stat-value" style="font-size: 16px;">${overdueCount}</div>
        </div>
    </div>

    <div class="card" style="margin-top:8px;">
        <div class="flex-gap" style="align-items:center;">
            <input type="search" name="search_field_unique_${Date.now()}" autocomplete="off" id="invoiceSearchInput" placeholder="🔍 Search invoices by number or customer" value="${state.invoiceSearch || ''}" oninput="searchInvoices(this.value)" style="flex:1;" readonly onfocus="this.removeAttribute('readonly');">
            <button class="btn-small btn-secondary" onclick="searchInvoices('')">Clear</button>
        </div>
        <div style="margin-top:8px;">${renderTagChips('invoices')}</div>
    </div>
    <div class="card">
        <h2>📋 Create Document</h2>
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 16px;">
            <button class="transaction-tab ${state.activeInvoiceTab === 'invoice' ? 'mpesa active' : 'mpesa'}" 
                    style="opacity: ${state.activeInvoiceTab === 'invoice' ? '1' : '0.6'};"
                    onclick="switchInvoiceTab('invoice')">
                📄 Invoice
            </button>
            <button class="transaction-tab ${state.activeInvoiceTab === 'receipt' ? 'crdb active' : 'crdb'}" 
                    style="opacity: ${state.activeInvoiceTab === 'receipt' ? '1' : '0.6'};"
                    onclick="switchInvoiceTab('receipt')">
                🧾 Receipt
            </button>
        </div>

        ${state.activeInvoiceTab === 'invoice' ? `
            <form onsubmit="createInvoice(event)">
                <div class="form-group">
                    <label>Customer</label>
                    <select id="invoiceCustomer" onchange="toggleInvoiceCustomerInput()" required>
                        <option value="" ${draftCustomer === '' ? 'selected' : ''}>-- Walk-in --</option>
                        <option value="new" ${draftCustomer === 'new' ? 'selected' : ''}>+ Add New Customer</option>
                        ${state.customers
                        .map((c, i) => ({ c, i }))
                        .sort((a, b) => String(a.c.name).localeCompare(String(b.c.name)))
                        .map(({ c, i }) => `<option value="${i}" ${draftCustomer === String(i) ? 'selected' : ''}>${c.name}</option>`).join('')}
                    </select>
                </div>
                <div id="newInvoiceCustomerFields" style="${draftCustomer === 'new' ? '' : 'display:none;'}">
                    <div class="form-group">
                        <label>New Customer Name</label>
                        <input type="text" id="newInvoiceCustomerName" placeholder="Enter customer name" value="${escAttr(draft.newCustomerName || '')}">
                    </div>
                    <div class="form-group">
                        <label>Phone (Optional)</label>
                        <input type="tel" id="newInvoiceCustomerPhone" placeholder="+255..." value="${escAttr(draft.newCustomerPhone || '')}">
                    </div>
                    <div class="form-group">
                        <label>Email (Optional)</label>
                        <input type="email" id="newInvoiceCustomerEmail" placeholder="customer@email.com" value="${escAttr(draft.newCustomerEmail || '')}">
                    </div>
                </div>
                <div class="form-group">
                    <label>Due Date</label>
                    <input type="date" id="invoiceDueDate" required value="${escAttr(draft.dueDate || '')}">
                </div>
                <div class="form-group">
                    <label>Payment Periods</label>
                    <input type="text" id="invoicePeriods" placeholder="Due within 7 days" value="${escAttr(draft.periods || 'Due within 7 days')}">
                </div>
                <div class="form-group">
    <label>Items/Services</label>
    <div id="invoiceItemsList">
        ${draftItems.map((it, idx) => `
        <div class="invoice-item-row" style="display: flex; gap: 8px; margin-bottom: 8px;">
            <input type="text" class="item-description" placeholder="Item description" style="flex: 2;" required value="${escAttr((it && it.description) || '')}">
            <input type="text" class="item-amount money-input" placeholder="0" style="flex: 1;" required value="${escAttr((it && it.amount) || '')}" oninput="calculateInvoiceSubtotal()">
            <button type="button" class="btn-small btn-danger" onclick="removeInvoiceItem(this)" style="width: auto; padding: 8px 12px;">✕</button>
        </div>
        `).join('')}
    </div>
    <button type="button" class="btn-secondary" onclick="addInvoiceItem()" style="margin-top: 8px;">+ Add Item</button>
</div>
<div class="form-group">
    <label>Subtotal (Auto-calculated)</label>
                    <input type="text" id="invoiceSubtotal" readonly value="${formatMoney(0)} ${getCurrencySymbol()}" style="background: rgba(0,0,0,0.05);">
</div>
                <div class="form-group">
                    <label>Tax Rate (%)</label>
                    <input type="number" id="invoiceTaxRate" placeholder="0" step="0.01" value="${escAttr((draft.taxRate != null && String(draft.taxRate) !== '') ? draft.taxRate : (typeof state.defaultTaxRate === 'number' ? state.defaultTaxRate : 0))}" min="0" max="100" oninput="calculateInvoiceSubtotal()">
                </div>
                <div class="form-group">
                    <label>Total (With Tax)</label>
                    <input type="text" id="invoiceTotal" readonly value="${formatMoney(0)} ${getCurrencySymbol()}" style="background: rgba(0,0,0,0.05);">
                </div>
                <div class="form-group">
                    <label>Payment Method</label>
                    <input type="text" id="invoicePaymentMethod" placeholder="Bank Transfer / Mobile Money" value="${escAttr(draft.paymentMethod || 'Bank Transfer / Mobile Money')}">
                </div>
                <div class="form-group">
                    <label>Notes (Optional)</label>
                    <textarea id="invoiceNotes" placeholder="Thank you for your business...">${escAttr(draft.notes || '')}</textarea>
                </div>
                <button type="submit">Create Invoice</button>
            </form>
        ` : `
<form onsubmit="createReceipt(event)">
    <div class="form-group">
        <label>Received From</label>
        <select id="receiptCustomer" onchange="updateReceiptFromCustomer()" required>
            <option value="" selected>-- Walk-in --</option>
            ${state.customers
                    .map((c, i) => ({ c, i }))
                    .sort((a, b) => String(a.c.name).localeCompare(String(b.c.name)))
                    .map(({ c, i }) => `<option value="${i}">${c.name}</option>`).join('')}
            <option value="manual">✏️ Enter Manually</option>
        </select>
    </div>
    <div id="manualReceiptCustomerField" style="display:none;">
        <div class="form-group">
            <label>Customer Name</label>
            <input type="text" id="manualReceiptCustomerName" placeholder="Enter customer name">
        </div>
        <div class="form-group">
            <label>Customer Email (Optional)</label>
            <input type="email" id="manualReceiptCustomerEmail" placeholder="customer@email.com">
        </div>
    </div>
    <div class="form-group" id="invoiceSelectionGroup" style="display:none;">
        <label>Related Invoice (Optional)</label>
        <select id="receiptInvoice" onchange="updateReceiptFromInvoice()">
            <option value="">-- No Invoice --</option>
        </select>
    </div>
    <div class="form-group">
        <label>Description</label>
        <textarea id="receiptDescription" placeholder="Payment for services rendered" required></textarea>
    </div>
                <div class="form-group">
                    <label>Amount Paid</label>
                    <input type="text" id="receiptAmount" class="money-input" placeholder="0" required>
                </div>
                <div class="form-group">
                    <label>Payment Method</label>
                    <select id="receiptPaymentMethod">
                        <option>Cash</option>
                        <option>M-Pesa</option>
                        <option>Bank Transfer</option>
                        <option>Card</option>
                        <option>Airtel Money</option>
                        <option>Halopesa</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Reference Number (Optional)</label>
                    <input type="text" id="receiptReference" placeholder="REF123XYZ">
                </div>
                <button type="submit">Create Receipt</button>
            </form>
        `}
    </div>

    <div class="card" style="margin-top:8px;">
        <div class="flex-gap" style="flex-wrap:wrap;">
            <button class="btn-small ${state.invoiceFilter === 'all' ? 'btn-success' : ''}" onclick="setInvoiceFilter('all')">All</button>
            <button class="btn-small ${state.invoiceFilter === 'unpaid' ? 'btn-success' : ''}" onclick="setInvoiceFilter('unpaid')">Unpaid (${unpaidCount})</button>
            <button class="btn-small ${state.invoiceFilter === 'overdue' ? 'btn-danger' : ''}" onclick="setInvoiceFilter('overdue')">Overdue (${overdueCount})</button>
            <button class="btn-small ${state.invoiceFilter === 'paid' ? 'btn-success' : ''}" onclick="setInvoiceFilter('paid')">Paid</button>
            <button class="btn-small ${state.invoiceFilter === 'month' ? 'btn-secondary' : ''}" onclick="setInvoiceFilter('month')">This Month</button>
        </div>
    </div>

    <div class="card">
        <h2>Unpaid Invoices (${state.invoices.filter(i => i.status !== 'Paid' && i.deleted !== true && matchesInvoiceSearch(i) && matchesInvoiceTagFilter(i)).length})</h2>
        
        ${state.invoices.filter(i => i.status !== 'Paid' && i.deleted !== true && matchesInvoiceSearch(i) && matchesInvoiceFilter(i) && matchesInvoiceTagFilter(i)).length > 0 ? `
            <div class="bulk-actions">
                <input type="checkbox" id="selectAll_unpaid_invoices" onchange="toggleSelectAllUnpaidInvoices()" class="checkbox-select">
                <label for="selectAll_unpaid_invoices">Select All</label>
                <span style="color: #666; font-size: 12px; margin-left: 8px;">
                    ${getSelectedUnpaidInvoiceCount()} selected
                </span>
                <button class="btn-small btn-success" onclick="bulkMarkInvoicesPaid()" ${!hasSelectedUnpaidInvoices() ? 'disabled' : ''}>
                    ✓ Mark as Paid
                </button>
                <button class="btn-small btn-danger" onclick="bulkDeleteUnpaidInvoices()" ${!hasSelectedUnpaidInvoices() ? 'disabled' : ''}>
                    🗑️ Delete Selected
                </button>
            </div>
            
    <div class="list-scroll-container">${state.invoices.filter(i => i.status !== 'Paid' && i.deleted !== true && matchesInvoiceSearch(i) && matchesInvoiceFilter(i) && matchesInvoiceTagFilter(i)).sort((a, b) => Number(b.timestamp || 0) - Number(a.timestamp || 0)).map((inv, origIdx) => {
                        const actualIndex = state.invoices.findIndex(i => i === inv);
                        return `
                <div class="item">
                    <div style="display: flex; gap: 12px; align-items: start;">
                        <input type="checkbox" class="checkbox-select" 
                               ${state.selectedItems.unpaid_invoices && state.selectedItems.unpaid_invoices[actualIndex] ? 'checked' : ''}
                               onchange="toggleSelectUnpaidInvoice(${actualIndex})">
                        <div style="flex: 1;">
                            <div class="item-header">
                                <span class="item-title">${inv.number}</span>
                                <button class="btn-small" onclick="copyInvoiceDetails(${actualIndex})" title="Copy Details">📋</button>
                                <span class="badge ${((new Date(inv.dueDate) < new Date()) && inv.status !== 'Paid') ? 'badge-danger' : 'badge-warning'}">
                                    ${((new Date(inv.dueDate) < new Date()) && inv.status !== 'Paid') ? 'Overdue' : inv.status}
                                </span>
                            </div>
                            <div class="item-subtitle">
                                ${inv.customer}<br>
                                Due: ${inv.dueDate}<br>
                                <span style="font-weight: 700;">Amount: <span class="money-text"> ${formatNumber(inv.amount)} ${getCurrencySymbol()}</span></span>
                            </div>
                            <div class="flex-gap" style="margin-top:8px;">
                                <button class="btn-small" onclick="downloadInvoicePDF(${actualIndex})">📥 Invoice PDF</button>
                                <button class="btn-small" onclick="toggleInvoiceStatus(${actualIndex})">Change Status</button>
                                <button class="btn-small btn-danger btn-delete" data-action="delete" onclick="deleteInvoice(${actualIndex})">Delete</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
                    }).join('')}
        ` : '<p style="text-align: center; color: #666;">No unpaid invoices</p>'}
    </div>

    <div class="card">
        <h2>Paid Invoices (${state.invoices.filter(i => i.status === 'Paid' && i.deleted !== true && matchesInvoiceSearch(i) && matchesInvoiceTagFilter(i)).length})</h2>
        
        ${state.invoices.filter(i => i.status === 'Paid' && matchesInvoiceSearch(i) && matchesInvoiceFilter(i) && matchesInvoiceTagFilter(i)).length > 0 ? `
            <div class="bulk-actions">
                <input type="checkbox" id="selectAll_paid_invoices" onchange="toggleSelectAllPaidInvoices()" class="checkbox-select">
                <label for="selectAll_paid_invoices">Select All</label>
                <span style="color: #666; font-size: 12px; margin-left: 8px;">
                    ${getSelectedPaidInvoiceCount()} selected
                </span>
                <button class="btn-small btn-danger" onclick="bulkDeletePaidInvoices()" ${!hasSelectedPaidInvoices() ? 'disabled' : ''}>
                    🗑️ Delete Selected
                </button>
            </div>
            
            <div class="list-scroll-container">${state.invoices.filter(i => i.status === 'Paid' && i.deleted !== true && matchesInvoiceSearch(i) && matchesInvoiceFilter(i) && matchesInvoiceTagFilter(i)).sort((a, b) => Number(b.timestamp || 0) - Number(a.timestamp || 0)).map((inv, origIdx) => {
                        const actualIndex = state.invoices.findIndex(i => i === inv);
                        return `
                <div class="item">
                    <div style="display: flex; gap: 12px; align-items: start;">
                        <input type="checkbox" class="checkbox-select" 
                               ${state.selectedItems.paid_invoices && state.selectedItems.paid_invoices[actualIndex] ? 'checked' : ''}
                               onchange="toggleSelectPaidInvoice(${actualIndex})">
                        <div style="flex: 1;">
                            <div class="item-header">
                                <span class="item-title">📄 ${inv.number}</span>
                                <button class="btn-small" onclick="copyInvoiceDetails(${actualIndex})" title="Copy Details">📋</button>
                                <span class="badge badge-success">Paid</span>
                            </div>
                            <div class="item-subtitle">
                                ${inv.customer}<br>
                                Paid: ${inv.date}<br>
                                <span style="font-weight: 700;">Amount: <span class="money-text"> ${formatNumber(inv.amount)} ${getCurrencySymbol()}</span></span>
                            </div>
                            <div class="flex-gap" style="margin-top:8px;">
                                <button class="btn-small" onclick="downloadInvoicePDF(${actualIndex})">📥 Invoice PDF</button>
                                <button class="btn-small btn-danger btn-delete" data-action="delete" onclick="deleteInvoice(${actualIndex})">Delete</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
                    }).join('')}
        ` : '<p style="text-align: center; color: #666;">No paid invoices</p>'}
    </div>

    <div class="card">
        <h2>Receipts (${(state.receipts || []).filter(r => !(r && r.deleted === true)).length})</h2>
        <div class="card-header-buttons"><button class="btn-small" onclick="copyAllReceipts()">📋 Copy All</button></div>
        
        ${(state.receipts && state.receipts.length > 0) ? `
            <div class="bulk-actions">
                <input type="checkbox" id="selectAll_receipts" onchange="toggleSelectAllReceipts()" class="checkbox-select">
                <label for="selectAll_receipts">Select All</label>
                <span style="color: #666; font-size: 12px; margin-left: 8px;">
                    ${getSelectedReceiptCount()} selected
                </span>
                <button class="btn-small btn-danger" onclick="bulkDeleteReceipts()" ${!hasSelectedReceipts() ? 'disabled' : ''}>
                    🗑️ Delete Selected
                </button>
            </div>
            
            <div class="list-scroll-container">${(state.receipts || []).filter(r => !(r && r.deleted === true)).map((receipt, idx) => `
                <div class="item">
                    <div style="display: flex; gap: 12px; align-items: start;">
                        <input type="checkbox" class="checkbox-select" 
                               ${state.selectedItems.receipts && state.selectedItems.receipts[idx] ? 'checked' : ''}
                               onchange="toggleSelectReceipt(${idx})">
                        <div style="flex: 1;">
                            <div class="item-header">
                                <span class="item-title">🧾 ${receipt.number}</span>
                                <span class="badge badge-success">Receipt</span>
                            </div>
                            <div class="item-subtitle">
                                ${receipt.customer}<br>
                                Date: ${receipt.date} ${receipt.time}<br>
                                <span style="font-weight: 700;">Amount: <span class="money-text"> ${formatNumber(receipt.amount)} ${getCurrencySymbol()}</span></span>
                                ${receipt.linkedInvoice ? `<br>Linked to: ${receipt.linkedInvoice}` : ''}
                            </div>
                            <div class="flex-gap" style="margin-top:8px;">
                                <button class="btn-small" onclick="downloadReceiptPDF(${idx})">📥 Receipt PDF</button>
                                <button class="btn-small" onclick="copyReceiptDetails(${idx})">📋 Copy</button>
                                <button class="btn-small btn-danger btn-delete" data-action="delete" onclick="deleteReceipt(${idx})">Delete</button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('')}</div>
        ` : '<p style="text-align: center; color: #666;">No receipts yet</p>'}
    </div>
    `;
        }

        function computeAveragePurchaseCost(productName) {
            try {
                const purchases = (state.inventoryPurchases || []).filter(p => p.itemName === productName);
                if (purchases.length === 0) return 0;
                let qtySum = 0; let costSum = 0;
                for (const p of purchases) {
                    const qPurchase = parseFloat(p.quantity || 0) || 0;
                    const uPurchase = parseFloat(p.unitCost || 0) || 0;
                    const units = (p.unitsPerPurchase != null ? parseFloat(p.unitsPerPurchase) : null)
                                  ?? (((state.products || []).find(pp => pp.name === productName)?.unitsPerPurchase) || 1);
                    const qSaleUnits = qPurchase * (units || 1);
                    const unitCostPerSale = (units && units > 0) ? (uPurchase / units) : uPurchase;
                    qtySum += qSaleUnits;
                    costSum += (qSaleUnits * unitCostPerSale);
                }
                if (qtySum <= 0) return 0;
                return +(costSum / qtySum).toFixed(2);
            } catch { return 0; }
        }
        function computeFifoUnitCost(productName, saleTimestamp, saleQty) {
            try {
                const purchases = (state.inventoryPurchases || []).filter(p => p.itemName === productName).sort((a, b) => Number(a.timestamp) - Number(b.timestamp));
                if (purchases.length === 0) return 0;
                const priorSalesQty = (state.sales || []).filter(s => s.productName === productName && Number(s.timestamp) < Number(saleTimestamp)).reduce((sum, s) => sum + (Number(s.quantity) || 0), 0);
                // Build remaining layers after consuming prior sales
                let remainingToConsume = priorSalesQty;
                const layers = [];
                for (const p of purchases) {
                    const units = (p.unitsPerPurchase != null ? parseFloat(p.unitsPerPurchase) : null)
                                  ?? (((state.products || []).find(pp => pp.name === productName)?.unitsPerPurchase) || 1);
                    let layerQty = (Number(p.quantity) || 0) * (units || 1);
                    const unit = (units && units > 0) ? ((Number(p.unitCost) || 0) / units) : (Number(p.unitCost) || 0);
                    if (remainingToConsume > 0) {
                        const consume = Math.min(remainingToConsume, layerQty);
                        layerQty -= consume;
                        remainingToConsume -= consume;
                    }
                    if (layerQty > 0) {
                        layers.push({ qty: layerQty, unit });
                    }
                }
                if (layers.length === 0) return 0;
                // Take from earliest layers to cover saleQty and compute weighted average unit cost
                let need = Number(saleQty) || 0;
                let totalCost = 0;
                let totalQty = 0;
                for (const l of layers) {
                    if (need <= 0) break;
                    const take = Math.min(need, l.qty);
                    totalCost += take * l.unit;
                    totalQty += take;
                    need -= take;
                }
                if (totalQty <= 0) return 0;
                return +(totalCost / totalQty).toFixed(2);
            } catch { return 0; }
        }

        function toggleSelectAllUnpaidInvoices() {
            if (!state.selectedItems.unpaid_invoices) state.selectedItems.unpaid_invoices = {};
            const boxes = Array.from(document.querySelectorAll(`input.checkbox-select[onchange^="toggleSelectUnpaidInvoice("]`)).filter(b => b.id !== 'selectAll_unpaid_invoices');
            if (boxes.length === 0) return;
            const allSelected = boxes.every(b => b.checked);
            const newState = !allSelected;
            boxes.forEach(b => {
                const oc = String(b.getAttribute('onchange') || '');
                const m = oc.match(/^toggleSelectUnpaidInvoice\((\d+)\)/);
                const idx = m ? parseInt(m[1], 10) : null;
                if (idx != null) state.selectedItems.unpaid_invoices[idx] = newState;
                try { b.checked = newState; } catch {}
            });
            saveData();
            render();
        }

        function toggleSelectUnpaidInvoice(index) {
            if (!state.selectedItems.unpaid_invoices) state.selectedItems.unpaid_invoices = {};
            state.selectedItems.unpaid_invoices[index] = !state.selectedItems.unpaid_invoices[index];
            saveData();
            render(); // RE-RENDER TO UPDATE CHECKBOXES AND COUNT
        }

        function hasSelectedUnpaidInvoices() {
            return state.selectedItems.unpaid_invoices && Object.values(state.selectedItems.unpaid_invoices).some(v => v);
        }

        function getSelectedUnpaidInvoiceCount() {
            if (!state.selectedItems.unpaid_invoices) return 0;
            return Object.values(state.selectedItems.unpaid_invoices).filter(v => v).length;
        }

        function bulkMarkInvoicesPaid() {
            if (!canUpsertTable('invoices')) { showToast('Not permitted', 'error'); return; }
            const selected = Object.keys(state.selectedItems.unpaid_invoices || {})
                .filter(i => state.selectedItems.unpaid_invoices[i])
                .map(i => parseInt(i));

            if (selected.length === 0) return showToast('No invoices selected', 'info');

            showConfirm(`Mark ${selected.length} invoices as paid?`, async function () {
                selected.forEach(i => {
                    if (state.invoices[i]) {
                        state.invoices[i].status = 'Paid';
                    }
                });

                state.selectedItems.unpaid_invoices = {};
                saveData();
                render();
                showToast(`${selected.length} invoices marked as paid`, 'success');

                if (syncEnabled) syncInBackground();
            });
        }

        async function bulkDeleteUnpaidInvoices() {
            if (!requireCapability('delete')) { return; }
            const selected = Object.keys(state.selectedItems.unpaid_invoices || {})
                .filter(i => state.selectedItems.unpaid_invoices[i])
                .map(i => parseInt(i));

            if (selected.length === 0) return showToast('No invoices selected', 'info');
            try { playDeleteSound(); } catch (e) { }
            const ok = await requirePinForDestructive('delete');
            if (!ok) { showToast('Delete failed: PIN required', 'error'); return; }
            selected.sort((a, b) => b - a).forEach(i => {
                const inv = state.invoices[i];
                if (syncEnabled && inv) { try { deleteOne('invoices', { number: inv.number }); } catch { } }
                state.invoices.splice(i, 1);
            });

            state.selectedItems.unpaid_invoices = {};
            saveData();
            render();
            showToast(`${selected.length} invoices deleted`, 'success');

            if (syncEnabled) syncInBackground();
        }

        function toggleSelectAllPaidInvoices() {
            if (!state.selectedItems.paid_invoices) state.selectedItems.paid_invoices = {};
            const boxes = Array.from(document.querySelectorAll(`input.checkbox-select[onchange^="toggleSelectPaidInvoice("]`)).filter(b => b.id !== 'selectAll_paid_invoices');
            if (boxes.length === 0) return;
            const allSelected = boxes.every(b => b.checked);
            const newState = !allSelected;
            boxes.forEach(b => {
                const oc = String(b.getAttribute('onchange') || '');
                const m = oc.match(/^toggleSelectPaidInvoice\((\d+)\)/);
                const idx = m ? parseInt(m[1], 10) : null;
                if (idx != null) state.selectedItems.paid_invoices[idx] = newState;
                try { b.checked = newState; } catch {}
            });
            saveData();
            render();
        }

        function toggleSelectPaidInvoice(index) {
            if (!state.selectedItems.paid_invoices) state.selectedItems.paid_invoices = {};
            state.selectedItems.paid_invoices[index] = !state.selectedItems.paid_invoices[index];
            saveData();
            render(); // RE-RENDER TO UPDATE CHECKBOXES AND COUNT
        }

        function hasSelectedPaidInvoices() {
            return state.selectedItems.paid_invoices && Object.values(state.selectedItems.paid_invoices).some(v => v);
        }

        function getSelectedPaidInvoiceCount() {
            if (!state.selectedItems.paid_invoices) return 0;
            return Object.values(state.selectedItems.paid_invoices).filter(v => v).length;
        }

        async function bulkDeletePaidInvoices() {
            if (!requireCapability('delete')) { return; }
            const selected = Object.keys(state.selectedItems.paid_invoices || {})
                .filter(i => state.selectedItems.paid_invoices[i])
                .map(i => parseInt(i));

            if (selected.length === 0) return showToast('No invoices selected', 'info');
            try { playDeleteSound(); } catch (e) { }
            const ok = await requirePinForDestructive('delete');
            if (!ok) { showToast('Delete failed: PIN required', 'error'); return; }
            selected.sort((a, b) => b - a).forEach(i => {
                const inv = state.invoices[i];
                if (syncEnabled && inv) { try { deleteOne('invoices', { number: inv.number }); } catch { } }
                state.invoices.splice(i, 1);
            });

            state.selectedItems.paid_invoices = {};
            saveData();
            render();
            showToast(`${selected.length} invoices deleted`, 'success');

            if (syncEnabled) syncInBackground();
        }

        async function deleteInvoice(index) {
            try { playDeleteSound(); } catch (e) { }
            const ok = await requirePinForDestructive('delete');
            if (!ok) { showToast('Delete failed: PIN required', 'error'); return; }
            const inv = state.invoices[index];
            if (inv) {
                try {
                    if (navigator.onLine && syncEnabled && currentUser) {
                        await deleteOne('invoices', { number: inv.number });
                    } else {
                        await deleteOne('invoices', { number: inv.number });
                    }
                } catch { }
            }
            state.invoices.splice(index, 1);
            saveData();
            render();
            showToast("Invoice deleted", "success");

            if (syncEnabled) syncInBackground();
        }

        function toggleInvoiceCustomerInput() {
            const select = document.getElementById('invoiceCustomer');
            const fields = document.getElementById('newInvoiceCustomerFields');
            if (select && fields) {
                if (select.value === 'new') {
                    fields.style.display = 'block';
                } else {
                    fields.style.display = 'none';
                }
            }
        }

        function switchInvoiceTab(tab) {
            state.activeInvoiceTab = tab;
            saveData();
            render();
        }

        function toggleReceiptCustomerInput() {
            const select = document.getElementById('receiptCustomer');
            const fields = document.getElementById('newReceiptCustomerFields');
            if (select && fields) {
                if (select.value === 'new') {
                    fields.style.display = 'block';
                } else {
                    fields.style.display = 'none';
                }
            }
        }

        function addInvoiceItem() {
            const container = document.getElementById('invoiceItemsList');
            const newRow = document.createElement('div');
            newRow.className = 'invoice-item-row';
            newRow.style.cssText = 'display: flex; gap: 8px; margin-bottom: 8px;';
            newRow.innerHTML = `
        <input type="text" class="item-description" placeholder="Item description" style="flex: 2;" required>
        <input type="text" class="item-amount money-input" placeholder="0" style="flex: 1;" required oninput="calculateInvoiceSubtotal()">
        <button type="button" class="btn-small btn-danger" onclick="removeInvoiceItem(this)" style="width: auto; padding: 8px 12px;">✕</button>
    `;
            container.appendChild(newRow);

            // Add event listener to first input too
            const firstAmount = container.querySelector('.item-amount');
            if (firstAmount && !firstAmount.hasAttribute('oninput')) {
                firstAmount.setAttribute('oninput', 'calculateInvoiceSubtotal()');
            }
            try { window.__saveInvoiceDraftFromDOM && window.__saveInvoiceDraftFromDOM(); } catch { }
        }

        function updateReceiptFromCustomer() {
            const select = document.getElementById('receiptCustomer');
            const manualField = document.getElementById('manualReceiptCustomerField');
            const invoiceGroup = document.getElementById('invoiceSelectionGroup');
            const invoiceSelect = document.getElementById('receiptInvoice');

            if (select.value === 'manual') {
                manualField.style.display = 'block';
                invoiceGroup.style.display = 'none';
                return;
            }

            manualField.style.display = 'none';

            if (select.value === '') {
                invoiceGroup.style.display = 'none';
                return;
            }

            const customer = state.customers[select.value];
            if (!customer) return;

            // Find invoices for this customer
            const customerInvoices = state.invoices.filter(inv =>
                inv.customer === customer.name && inv.status !== 'Paid'
            );

            if (customerInvoices.length > 0) {
                invoiceGroup.style.display = 'block';
                invoiceSelect.innerHTML = '<option value="">-- No Invoice --</option>' +
                    customerInvoices.map((inv, idx) => {
                        const actualIndex = state.invoices.indexOf(inv);
                        return `<option value="${actualIndex}">${inv.number} - ${formatNumber(inv.amount)} ${getCurrencySymbol()} (Due: ${inv.dueDate})</option>`;
                    }).join('');

                // Auto-select first invoice
                if (customerInvoices.length === 1) {
                    invoiceSelect.selectedIndex = 1;
                    updateReceiptFromInvoice();
                }
            } else {
                invoiceGroup.style.display = 'none';
            }
        }

        function updateReceiptFromInvoice() {
            const invoiceSelect = document.getElementById('receiptInvoice');
            const descField = document.getElementById('receiptDescription');
            const amountField = document.getElementById('receiptAmount');

            if (!invoiceSelect.value) return;

            const invoice = state.invoices[invoiceSelect.value];
            if (!invoice) return;

            // Format items properly
            let itemsDescription = '';
            if (Array.isArray(invoice.items)) {
                itemsDescription = invoice.items.map(item =>
                    `${item.description} (${formatMoney(item.amount)} ${getCurrencySymbol()})`
                ).join(', ');
            } else {
                itemsDescription = String(invoice.items);
            }

            descField.value = `Payment for ${itemsDescription} (Invoice ${invoice.number})`;
            amountField.value = formatMoney(invoice.amount);
        }

        function removeInvoiceItem(button) {
            const container = document.getElementById('invoiceItemsList');
            if (container.children.length > 1) {
                showConfirm('Remove this invoice item?', function () {
                    button.parentElement.remove();
                    calculateInvoiceSubtotal();
                    try { window.__saveInvoiceDraftFromDOM && window.__saveInvoiceDraftFromDOM(); } catch { }
                });
            } else {
                showToast('At least one item is required', 'error');
            }
        }

        function calculateInvoiceSubtotal() {
            const amounts = document.querySelectorAll('.item-amount');
            let subtotal = 0;
            amounts.forEach(input => {
                const val = parseMoney(input.value) || 0;
                subtotal += val;
            });

            const subtotalField = document.getElementById('invoiceSubtotal');
            if (subtotalField) {
                subtotalField.value = formatMoney(subtotal) + ' ' + getCurrencySymbol();
            }

            // Update total with tax
            const taxRate = parseFloat(document.getElementById('invoiceTaxRate')?.value || 0) / 100;
            const tax = subtotal * taxRate;
            const total = subtotal + tax;

            const totalField = document.getElementById('invoiceTotal');
            if (totalField) {
                totalField.value = formatMoney(total) + ' ' + getCurrencySymbol();
            }

            // You can add a total display field if needed
            try { window.__saveInvoiceDraftFromDOM && window.__saveInvoiceDraftFromDOM(); } catch { }
        }

        (function setupInvoiceDraftPersistence() {
            const KEY = 'tuba-invoice-draft-v1';
            let t = 0;

            function collect() {
                try {
                    const customerEl = document.getElementById('invoiceCustomer');
                    const dueEl = document.getElementById('invoiceDueDate');
                    const periodsEl = document.getElementById('invoicePeriods');
                    const taxEl = document.getElementById('invoiceTaxRate');
                    const payEl = document.getElementById('invoicePaymentMethod');
                    const notesEl = document.getElementById('invoiceNotes');
                    const list = document.getElementById('invoiceItemsList');
                    if (!customerEl || !dueEl || !periodsEl || !taxEl || !payEl || !notesEl || !list) return null;

                    const rows = Array.from(list.querySelectorAll('.invoice-item-row'));
                    const items = rows.map(r => {
                        const d = r.querySelector('.item-description');
                        const a = r.querySelector('.item-amount');
                        return { description: (d && d.value) ? d.value : '', amount: (a && a.value) ? a.value : '' };
                    });

                    return {
                        customerSelect: customerEl.value || '',
                        newCustomerName: (document.getElementById('newInvoiceCustomerName')?.value || ''),
                        newCustomerPhone: (document.getElementById('newInvoiceCustomerPhone')?.value || ''),
                        newCustomerEmail: (document.getElementById('newInvoiceCustomerEmail')?.value || ''),
                        dueDate: dueEl.value || '',
                        periods: periodsEl.value || '',
                        taxRate: taxEl.value || '',
                        paymentMethod: payEl.value || '',
                        notes: notesEl.value || '',
                        items,
                        updatedAt: Date.now()
                    };
                } catch { return null; }
            }

            function write(draft) {
                try {
                    if (!draft) return;
                    state.invoiceDraft = draft;
                    try { localStorage.setItem(KEY, JSON.stringify(draft)); } catch { }
                } catch { }
            }

            function schedule() {
                try { clearTimeout(t); } catch { }
                t = setTimeout(() => {
                    const d = collect();
                    write(d);
                }, 180);
            }

            window.__hydrateInvoiceDraft = function () {
                try {
                    if (state.invoiceDraft && typeof state.invoiceDraft === 'object') return;
                    const raw = localStorage.getItem(KEY);
                    if (!raw) return;
                    const d = JSON.parse(raw);
                    if (d && typeof d === 'object') state.invoiceDraft = d;
                } catch { }
            };

            window.__saveInvoiceDraftFromDOM = function () {
                try {
                    const d = collect();
                    write(d);
                } catch { }
            };

            window.__clearInvoiceDraft = function () {
                try { state.invoiceDraft = null; } catch { }
                try { localStorage.removeItem(KEY); } catch { }
                try { saveData(); } catch { }
            };

            document.addEventListener('input', (e) => {
                const el = e && e.target;
                if (!el) return;
                const id = String(el.id || '');
                if (id.startsWith('invoice') || id.startsWith('newInvoiceCustomer')) schedule();
                else if (el.classList && (el.classList.contains('item-description') || el.classList.contains('item-amount'))) schedule();
            }, true);
            document.addEventListener('change', (e) => {
                const el = e && e.target;
                if (!el) return;
                const id = String(el.id || '');
                if (id.startsWith('invoice') || id.startsWith('newInvoiceCustomer')) schedule();
            }, true);
        })();

        async function createReceipt(e) {
            e.preventDefault();

            const customerSelect = document.getElementById('receiptCustomer').value;
            let customer;
            let customerName = '';
            let customerEmail = '';

            if (customerSelect === 'manual') {
                customerName = document.getElementById('manualReceiptCustomerName')?.value.trim();
                customerEmail = document.getElementById('manualReceiptCustomerEmail')?.value.trim();

                if (!customerName) return showToast('Please enter customer name', 'error');

                // Optionally add to customers list
                customer = {
                    id: generateID('customers'),
                    name: customerName,
                    email: customerEmail,
                    phone: '',
                    address: '',
                    totalPurchases: 0
                };
                // Don't auto-add manual entries to avoid clutter
                // state.customers.push(customer);
            } else if (customerSelect) {
                customer = state.customers[customerSelect];
                customerName = customer.name;
                customerEmail = customer.email || '';
            } else {
                customerName = 'WALK IN';
                customerEmail = '';
            }

            const amount = parseMoney(document.getElementById('receiptAmount').value);
            if (isNaN(amount) || amount <= 0) {
                return showToast('Please enter a valid amount', 'error');
            }

            const now = new Date();
            const paymentMethod = document.getElementById('receiptPaymentMethod').value;
            const reference = document.getElementById('receiptReference')?.value.trim();

            // Check if linked to an invoice
            const invoiceSelect = document.getElementById('receiptInvoice');
            let linkedInvoice = null;
            if (invoiceSelect && invoiceSelect.value) {
                linkedInvoice = state.invoices[invoiceSelect.value];
                // Mark invoice as paid
                if (linkedInvoice) {
                    linkedInvoice.status = 'Paid';
                    showToast('Invoice marked as paid', 'success');
                }
            }

            const receipt = {
                id: generateID('receipts'),
                number: 'RCPT-' + Date.now().toString().slice(-6),
                customer: customerName,
                customerEmail: customerEmail,
                date: getTodayDateString(),
                time: now.toLocaleTimeString(),
                timestamp: now.getTime(),
                description: document.getElementById('receiptDescription').value.trim(),
                amount: amount,
                paymentMethod: paymentMethod + (reference ? ' (Ref: ' + reference + ')' : ''),
                linkedInvoice: linkedInvoice ? linkedInvoice.number : null
            };

            if (!state.receipts) state.receipts = [];
            state.receipts.push(receipt);

            saveData();
            render();
            showToast("Receipt created successfully!", "success");

            if (syncEnabled) syncInBackground();
        }

        async function downloadReceiptPDF(idx) {
            let mode = arguments[1] || 'download';
            try { if (window.loadLibrary) await loadLibrary('jspdf'); } catch {}
            await ensureLogoReady();
            const receipt = state.receipts[idx];
            if (!receipt) return showToast("Receipt not found", "error");

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ unit: 'pt', format: [226.77, 396.85] });
            const margin = 20;
            const centerX = 226.77 / 2;
            let y = 30;

            // Draw zigzag borders
            doc.setDrawColor(0, 0, 0);
            doc.setLineWidth(1);
            const zigzagSize = 8;
            const zigzagCount = Math.floor(226.77 / zigzagSize);

            for (let i = 0; i < zigzagCount; i++) {
                const x1 = i * zigzagSize;
                const x2 = (i + 0.5) * zigzagSize;
                const x3 = (i + 1) * zigzagSize;
                if (i % 2 === 0) {
                    doc.line(x1, 10, x2, 5);
                    doc.line(x2, 5, x3, 10);
                } else {
                    doc.line(x1, 10, x2, 15);
                    doc.line(x2, 15, x3, 10);
                }
            }

            doc.line(10, 10, 10, 396.85 - 10);
            doc.line(226.77 - 10, 10, 226.77 - 10, 396.85 - 10);

            const profile = getUserProfileData();

            // Header
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text(profile.businessName, centerX, y, { align: 'center' });
            y += 18;

            doc.setFontSize(7);
            doc.setFont(undefined, 'normal');
            if (profile.address) {
                const addressLines = doc.splitTextToSize(profile.address, 186.77);
                addressLines.forEach(line => {
                    doc.text(line, centerX, y, { align: 'center' });
                    y += 10;
                });
            }
            if (profile.phone) {
                doc.text(`Tel: ${profile.phone}`, centerX, y, { align: 'center' });
                y += 10;
            }
            if (profile.email) {
                doc.text(`Email: ${profile.email}`, centerX, y, { align: 'center' });
                y += 10;
            }
            if (profile.tinNumber || profile.blNumber) {
                if (profile.tinNumber) {
                    doc.text(`TIN: ${profile.tinNumber}`, centerX, y, { align: 'center' });
                    y += 10;
                }
                if (profile.blNumber) {
                    doc.text(`BL-No: ${profile.blNumber}`, centerX, y, { align: 'center' });
                    y += 10;
                }
            }
            if (profile.hasVAT && profile.vatNumber) {
                doc.text(`VAT: ${profile.vatNumber}`, centerX, y, { align: 'center' });
                y += 10;
            }
            y += 8;

            doc.setLineWidth(0.5);
            doc.line(margin, y, 226.77 - margin, y);
            y += 15;

            // Receipt Title
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text('PAYMENT RECEIPT', centerX, y, { align: 'center' });
            y += 18;

            // Receipt Details
            doc.setFontSize(8);
            doc.setFont(undefined, 'normal');
            doc.text(`Receipt No: ${receipt.number}`, margin, y);
            y += 11;
            doc.text(`Date: ${receipt.date}`, margin, y);
            y += 11;
            doc.text(`Time: ${receipt.time}`, margin, y);
            y += 16;

            doc.line(margin, y, 226.77 - margin, y);
            y += 13;

            // Received From
            doc.setFont(undefined, 'bold');
            doc.setFontSize(7);
            doc.text('RECEIVED FROM', margin, y);
            y += 11;
            doc.setFont(undefined, 'normal');
            doc.setFontSize(9);
            doc.text(receipt.customer, margin, y);
            if (receipt.customerEmail) {
                y += 11;
                doc.setFontSize(7);
                doc.text(receipt.customerEmail, margin, y);
            }
            y += 16;

            // Description
            doc.setFont(undefined, 'bold');
            doc.setFontSize(7);
            doc.text('DESCRIPTION', margin, y);
            y += 11;
            doc.setFont(undefined, 'normal');
            doc.setFontSize(8);
            const descLines = doc.splitTextToSize(receipt.description, 186.77);
            descLines.forEach(line => {
                if (y > 320) return; // Prevent overflow
                doc.text(line, margin, y);
                y += 10;
            });
            y += 8;

            doc.line(margin, y, 226.77 - margin, y);
            y += 13;

            // Amount
            doc.setFont(undefined, 'bold');
            doc.setFontSize(7);
            doc.text('AMOUNT PAID', margin, y);
            y += 14;
            doc.setFontSize(14);
            doc.text(`${formatNumber(receipt.amount)} ${getCurrencySymbol()}`, centerX, y, { align: 'center' });
            y += 16;

            doc.setFontSize(7);
            doc.setFont(undefined, 'normal');
            const paymentLines = doc.splitTextToSize(`Payment Method: ${receipt.paymentMethod}`, 186.77);
            paymentLines.forEach(line => {
                doc.text(line, centerX, y, { align: 'center' });
                y += 10;
            });
            y += 10;

            // Linked Invoice
            if (receipt.linkedInvoice) {
                doc.setFontSize(7);
                doc.text(`Related Invoice: ${receipt.linkedInvoice}`, centerX, y, { align: 'center' });
                y += 12;
            }

            doc.line(margin, y, 226.77 - margin, y);
            y += 13;

            // Footer
            doc.setFont(undefined, 'bold');
            doc.setFontSize(8);
            doc.text('The Ultimate Business Architecture - TUBA', centerX, y, { align: 'center' });
            y += 11;
            doc.setFontSize(7);
            doc.setFont(undefined, 'normal');
            doc.text(`© ${new Date().getFullYear()}`, centerX, y, { align: 'center' });


            // Bottom zigzag
            const bottomY = 396.85 - 10;
            for (let i = 0; i < zigzagCount; i++) {
                const x1 = i * zigzagSize;
                const x2 = (i + 0.5) * zigzagSize;
                const x3 = (i + 1) * zigzagSize;
                if (i % 2 === 0) {
                    doc.line(x1, bottomY, x2, bottomY + 5);
                    doc.line(x2, bottomY + 5, x3, bottomY);
                } else {
                    doc.line(x1, bottomY, x2, bottomY - 5);
                    doc.line(x2, bottomY - 5, x3, bottomY);
                }
            }

            downloadPDFSafe(doc, `${receipt.number}.pdf`);
            showToast("Receipt PDF ready", "success");
        }

        async function deleteReceipt(idx) {
            try { playDeleteSound(); } catch (e) { }
            const ok = await requirePinForDestructive('delete');
            if (!ok) { showToast('Delete failed: PIN required', 'error'); return; }
            const r = state.receipts[idx];
            if (r) {
                try {
                    if (navigator.onLine && syncEnabled && currentUser) {
                        await deleteOne('receipts', { timestamp: r.timestamp });
                    } else {
                        await deleteOne('receipts', { timestamp: r.timestamp });
                    }
                } catch { }
            }
            state.receipts.splice(idx, 1);
            saveData();
            render();
            showToast("Receipt deleted", "success");

            if (syncEnabled) syncInBackground();
        }
        function toggleSelectAllReceipts() {
            if (!state.selectedItems.receipts) state.selectedItems.receipts = {};
            const boxes = Array.from(document.querySelectorAll(`input.checkbox-select[onchange^="toggleSelectReceipt("]`)).filter(b => b.id !== 'selectAll_receipts');
            if (boxes.length === 0) return;
            const allSelected = boxes.every(b => b.checked);
            const newState = !allSelected;
            boxes.forEach(b => {
                const oc = String(b.getAttribute('onchange') || '');
                const m = oc.match(/^toggleSelectReceipt\((\d+)\)/);
                const idx = m ? parseInt(m[1], 10) : null;
                if (idx != null) state.selectedItems.receipts[idx] = newState;
                try { b.checked = newState; } catch {}
            });
            saveData();
            render();
        }

        function toggleSelectReceipt(index) {
            if (!state.selectedItems.receipts) state.selectedItems.receipts = {};
            state.selectedItems.receipts[index] = !state.selectedItems.receipts[index];
            saveData();
            render(); // RE-RENDER TO UPDATE CHECKBOXES AND COUNT
        }

        function hasSelectedReceipts() {
            return state.selectedItems.receipts && Object.values(state.selectedItems.receipts).some(v => v);
        }

        function getSelectedReceiptCount() {
            if (!state.selectedItems.receipts) return 0;
            return Object.values(state.selectedItems.receipts).filter(v => v).length;
        }

        async function bulkDeleteReceipts() {
            if (!requireCapability('delete')) { return; }
            const selected = Object.keys(state.selectedItems.receipts || {})
                .filter(i => state.selectedItems.receipts[i])
                .map(i => parseInt(i));

            if (selected.length === 0) return showToast('No receipts selected', 'info');
            try { playDeleteSound(); } catch (e) { }
            const ok = await requirePinForDestructive('delete');
            if (!ok) { showToast('Delete failed: PIN required', 'error'); return; }
            selected.sort((a, b) => b - a).forEach(i => {
                const r = state.receipts[i];
                if (syncEnabled && r) { try { deleteOne('receipts', { timestamp: r.timestamp }); } catch { } }
                state.receipts.splice(i, 1);
            });

            state.selectedItems.receipts = {};
            saveData();
            render();
            showToast(`${selected.length} receipts deleted`, 'success');

            if (syncEnabled) syncInBackground();
        }

        function toggleInvoiceStatus(idx) {
            if (!canUpsertTable('invoices')) { showToast('Not permitted', 'error'); return; }
            const inv = state.invoices[idx];
            if (!inv) return;

            const statuses = ['Pending', 'Paid', 'Overdue'];
            const currentIdx = statuses.indexOf(inv.status);
            const prevStatus = inv.status;
            const newStatus = statuses[(currentIdx + 1) % statuses.length];
            inv.status = newStatus;

            try {
                const today = getTodayDateString();
                if (newStatus === 'Paid') {
                    const exists = (state.sales || []).some(s => s.productName === ('Invoice ' + inv.number) && s.date === today);
                    if (!exists) {
                        const now = new Date();
                        (state.sales = state.sales || []).push({
                            id: generateID('sales'),
                            date: today,
                            time: now.toLocaleTimeString(),
                            timestamp: now.getTime(),
                            productName: 'Invoice ' + inv.number,
                            customer: inv.customer || 'N/A',
                            quantity: 1,
                            costPerUnit: 0,
                            pricePerUnit: inv.amount || 0,
                            totalCost: 0,
                            totalPrice: inv.amount || 0,
                            profit: inv.amount || 0,
                            payment: 'Invoice'
                        });
                    }
                } else if (prevStatus === 'Paid') {
                    const toRemoveIdx = (state.sales || []).findIndex(s => s.productName === ('Invoice ' + inv.number));
                    if (toRemoveIdx !== -1) { state.sales.splice(toRemoveIdx, 1); }
                }
            } catch { }

            saveData();
            render();
            showToast(`Invoice status changed to ${inv.status}`, 'success');

            // Sync in background
            if (syncEnabled) syncInBackground();
        }

        async function createInvoice(e) {
            e.preventDefault();
            const customerSelect = document.getElementById('invoiceCustomer').value;
            let customer;

            if (customerSelect === 'new') {
                const newName = document.getElementById('newInvoiceCustomerName')?.value.trim();
                if (!newName) return showToast('Please enter customer name', 'error');
                const newPhone = document.getElementById('newInvoiceCustomerPhone')?.value.trim();
                const newEmail = document.getElementById('newInvoiceCustomerEmail')?.value.trim();

                // Check if customer already exists
                const existingCustomer = state.customers.find(c => c.name.toLowerCase() === newName.toLowerCase());

                if (existingCustomer) {
                    customer = existingCustomer;
                } else {
                    customer = {
                        id: generateID('customers'),
                        name: newName,
                        email: newEmail,
                        phone: newPhone,
                        address: '',
                        totalPurchases: 0
                    };
                    state.customers.push(customer);
                    showToast('New customer added to customers list', 'info');
                }
            } else if (customerSelect) {
                customer = state.customers[customerSelect];
            } else {
                customer = { name: 'WALK IN', email: '', phone: '', address: '', totalPurchases: 0 };
            }

            // Collect all items
            const itemRows = document.querySelectorAll('.invoice-item-row');
            const items = [];
            let subtotal = 0;

            itemRows.forEach(row => {
                const desc = row.querySelector('.item-description').value.trim();
                const amount = parseMoney(row.querySelector('.item-amount').value) || 0;

                if (desc && amount > 0) {
                    items.push({ description: desc, amount: amount });
                    subtotal += amount;
                }
            });

            if (items.length === 0) {
                return showToast('Please add at least one item with an amount', 'error');
            }

            const taxRate = parseFloat(document.getElementById('invoiceTaxRate')?.value || 0) / 100;
            const taxAmount = subtotal * taxRate;
            const total = subtotal + taxAmount;

            const now = new Date();
            const invoice = {
                id: generateID('invoices'),
                number: 'INV-' + Date.now().toString().slice(-6),
                customer: customer.name,
                customerEmail: customer.email || '',
                customerAddress: customer.address || '',
                customerPhone: customer.phone || '',
                date: getTodayDateString(),
                time: now.toLocaleTimeString(),
                timestamp: now.getTime(),
                dueDate: document.getElementById('invoiceDueDate').value,
                Periods: document.getElementById('invoicePeriods')?.value.trim() || 'Due within 7 days',
                items: items,
                subtotal: subtotal,
                taxRate: taxRate * 100,
                taxAmount: taxAmount,
                amount: total,
                currencyCode: state.currencyCode,
                currencySymbol: state.currencySymbol,
                paymentMethod: document.getElementById('invoicePaymentMethod')?.value.trim() || 'Bank Transfer',
                notes: document.getElementById('invoiceNotes')?.value.trim() || '',
                status: 'Pending'
            };

            state.invoices.push(invoice);
            try { state.invoiceDraft = null; } catch { }
            try { localStorage.removeItem('tuba-invoice-draft-v1'); } catch { }
            saveData();
            render();
            showToast("Invoice created successfully!", "success");
            if (syncEnabled) {
                await upsertOne('invoices', {
                    number: invoice.number,
                    customer: invoice.customer,
                    date: invoice.date,
                    due_date: invoice.dueDate,
                    items: invoice.items,
                    amount: invoice.amount,
                    status: invoice.status,
                    subtotal: invoice.subtotal,
                    tax_rate: invoice.taxRate,
                    tax_amount: invoice.taxAmount,
                    currency_code: state.currencyCode,
                    currency_symbol: state.currencySymbol
                });
                syncInBackground();
            }
        }

        async function downloadInvoicePDF(i) {
            try { if (window.loadLibrary) await loadLibrary('jspdf'); } catch {}
            await ensureLogoReady();
            const inv = state.invoices[i];
            if (!inv) return showToast("Invoice not found", "error");

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ unit: 'pt', format: 'a4' });
            const pageWidth = 595.28;
            const margin = 50;
            const usableWidth = pageWidth - margin * 2;
            let y = 50;

            const profile = getUserProfileData();

            // Header background (single shading) — dynamically cover all header lines
            const headerBaseY = 70;
            let headerLines = 0;
            if (profile.address) headerLines++;
            if (profile.phone) headerLines++;
            if (profile.email) headerLines++;
            if (profile.role) headerLines++;
            if (profile.tinNumber) headerLines++;
            if (profile.blNumber) headerLines++;
            if (profile.hasVAT) headerLines++;
            const underlineYEst = headerBaseY + (headerLines * 14) + 5;
            const shadeHeight = Math.max(120, underlineYEst - 3);
            doc.setFillColor(240, 240, 240);
            doc.rect(0, 0, pageWidth, shadeHeight, 'F');

            // Company name + logo
            doc.setTextColor(40, 40, 40);
            doc.setFontSize(26);
            doc.setFont(undefined, 'bold');
            const titleX = margin;
            doc.text(profile.businessName || 'Your Business Name', titleX, 45);

            // Company details - show all profile info
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.setTextColor(80, 80, 80);
            let headerY = 70;

            if (profile.address) {
                doc.text(`Address: ${profile.address}`, margin, headerY);
                headerY += 14;
            }
            if (profile.phone) {
                doc.text(`Phone: ${profile.phone}`, margin, headerY);
                headerY += 14;
            }
            if (profile.email) {
                doc.text(`Email: ${profile.email}`, margin, headerY);
                headerY += 14;
            }
            if (profile.role) {
                doc.text(`Role: ${profile.role}`, margin, headerY);
                headerY += 14;
            }
            if (profile.tinNumber || profile.blNumber) {
                if (profile.tinNumber) {
                    doc.text(`TIN: ${profile.tinNumber}`, margin, headerY);
                    headerY += 14;
                }
                if (profile.blNumber) {
                    doc.text(`BL-No: ${profile.blNumber}`, margin, headerY);
                    headerY += 14;
                }
            }
            if (profile.hasVAT && profile.vatNumber) {
                doc.text(`VAT: ${profile.vatNumber}`, margin, headerY);
                headerY += 14;
            }

            // Add a subtle line separator
            doc.setDrawColor(150, 150, 150);
            doc.setLineWidth(2);
            doc.line(margin, headerY + 5, pageWidth - margin, headerY + 5);

            // Invoice details (right side)
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('INVOICE', pageWidth - margin, 45, { align: 'right' });

            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(`${inv.number}`, pageWidth - margin, 65, { align: 'right' });
            doc.text(`Date: ${inv.date}`, pageWidth - margin, 80, { align: 'right' });
            doc.text(`Due: ${inv.dueDate}`, pageWidth - margin, 95, { align: 'right' });
            if (inv.currencyCode) {
                doc.text(`Currency: ${inv.currencyCode}`, pageWidth - margin, 110, { align: 'right' });
            }

            y = 165;
            doc.setTextColor(0, 0, 0);

            // Bill To section
            doc.setFillColor(248, 248, 248);
            doc.roundedRect(margin, y, (usableWidth / 2) - 10, 100, 5, 5, 'F');

            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(107, 114, 128);
            doc.text('BILL TO', margin + 15, y + 20);

            doc.setTextColor(0, 0, 0);
            doc.setFont(undefined, 'normal');
            doc.setFontSize(11);
            doc.text(inv.customer, margin + 15, y + 40);

            let billY = y + 55;
            if (inv.customerEmail) {
                doc.setFontSize(9);
                doc.setTextColor(107, 114, 128);
                doc.text(inv.customerEmail, margin + 15, billY);
                billY += 12;
            }
            if (inv.customerPhone) {
                doc.text(inv.customerPhone, margin + 15, billY);
                billY += 12;
            }
            if (inv.customerAddress) {
                doc.text(inv.customerAddress, margin + 15, billY);
            }

            // Payment Periods section
            doc.setFillColor(248, 248, 248);
            doc.roundedRect(margin + (usableWidth / 2) + 10, y, (usableWidth / 2) - 10, 80, 5, 5, 'F');

            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(107, 114, 128);
            doc.text('PAYMENT PeriodS', margin + (usableWidth / 2) + 25, y + 20);

            doc.setTextColor(0, 0, 0);
            doc.setFont(undefined, 'normal');
            doc.setFontSize(10);
            doc.text(inv.Periods || 'Due within 7 days', margin + (usableWidth / 2) + 25, y + 40);

            doc.setFont(undefined, 'bold');
            doc.text('Payment Method', margin + (usableWidth / 2) + 25, y + 60);
            doc.setFont(undefined, 'normal');
            doc.text(inv.paymentMethod || 'Bank Transfer', margin + (usableWidth / 2) + 25, y + 75);

            y += 120;

            // Items table
            doc.setFillColor(100, 100, 100);
            doc.rect(margin, y, usableWidth, 25, 'F');

            doc.setTextColor(255, 255, 255);
            doc.setFont(undefined, 'bold');
            doc.setFontSize(10);
            doc.text('Item / Service', margin + 10, y + 16);
            doc.text('Amount', pageWidth - margin - 10, y + 16, { align: 'right' });

            y += 25;
            doc.setTextColor(0, 0, 0);
            doc.setFont(undefined, 'normal');
            doc.setFontSize(10);

            y += 25;
            doc.setTextColor(0, 0, 0);
            doc.setFont(undefined, 'normal');
            doc.setFontSize(10);

            // Parse items properly
            let items = [];
            if (Array.isArray(inv.items)) {
                items = inv.items;
            } else if (typeof inv.items === 'string') {
                try {
                    // Try to parse as JSON first
                    items = JSON.parse(inv.items);
                } catch (e) {
                    // If not JSON, split by comma
                    items = inv.items.split(',').map(s => ({ description: s.trim(), amount: 0 })).filter(i => i.description);
                }
            } else if (typeof inv.items === 'object') {
                items = [inv.items];
            }

            items.forEach((item, idx) => {
                if (idx % 2 === 0) {
                    doc.setFillColor(248, 249, 250);
                    doc.rect(margin, y, usableWidth, 20, 'F');
                }

                const description = item.description || String(item);
                const amount = item.amount || 0;

                const maxDescWidth = usableWidth - 20;
                const descLines = doc.splitTextToSize(description, maxDescWidth);
                for (let li = 0; li < descLines.length; li++) {
                    doc.text(descLines[li], margin + 10, y + 14 + li * 12);
                }
                if (amount > 0) {
                    doc.text(`${formatNumber(amount)} ${getCurrencySymbol()}`, pageWidth - margin - 10, y + 14, { align: 'right' });
                }
                y += Math.max(20, descLines.length * 12 + 6);
            });

            y += 10;

            // Totals section
            const totalsX = pageWidth - margin - 150;

            if (inv.subtotal !== undefined) {
                doc.setDrawColor(200, 200, 200);
                doc.line(totalsX - 20, y, pageWidth - margin, y);
                y += 15;

                doc.setFont(undefined, 'normal');
                doc.text('Subtotal:', totalsX, y);
                doc.text(`${formatNumber(inv.subtotal)} ${getCurrencySymbol()}`, pageWidth - margin, y, { align: 'right' });
                y += 18;

                if (inv.taxAmount && inv.taxAmount > 0) {
                    doc.text(`Tax (${inv.taxRate}%):`, totalsX, y);
                    doc.text(`${formatNumber(inv.taxAmount)} ${getCurrencySymbol()}`, pageWidth - margin, y, { align: 'right' });
                    y += 18;
                }
            }

            doc.setDrawColor(100, 100, 100);
            doc.setLineWidth(2);
            doc.line(totalsX - 20, y, pageWidth - margin, y);
            y += 18;

            doc.setFont(undefined, 'bold');
            doc.setFontSize(12);
            doc.text('Total Due:', totalsX, y);
            doc.text(`${formatNumber(inv.amount)} ${getCurrencySymbol()}`, pageWidth - margin, y, { align: 'right' });

            // Notes
            if (inv.notes) {
                y += 40;
                doc.setFontSize(9);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(107, 114, 128);
                doc.text('Notes:', margin, y);
                y += 12;
                doc.setFont(undefined, 'normal');
                const noteLines = doc.splitTextToSize(inv.notes, usableWidth);
                noteLines.forEach(line => {
                    doc.text(line, margin, y);
                    y += 12;
                });
            }

            // Footer
            doc.setFillColor(80, 80, 80);
            doc.rect(0, 792 - 50, pageWidth, 50, 'F');
            doc.setFontSize(11);
            doc.setTextColor(255, 255, 255);
            doc.setFont(undefined, 'bold');
            doc.text('The Ultimate Business Architecture', pageWidth / 2, 792 - 28, { align: 'center' });
            doc.setFontSize(14);
            doc.text('- TUBA -', pageWidth / 2, 792 - 12, { align: 'center' });
            downloadPDFSafe(doc, `${inv.number}.pdf`);
            showToast("Invoice PDF ready", "success");
        }


        function isUserProfileIncompleteForDocs(){
            const p = getUserProfileData();
            return !p.businessName || !p.phone || !p.address;
        }
        function navigateToUserProfileCard(){
            try { switchTab('account'); } catch {}
            setTimeout(() => {
                const el = document.getElementById('userProfileCard');
                if (el) {
                    try { el.scrollIntoView({ behavior: 'smooth', block: 'start' }); }
                    catch { try { el.scrollIntoView(); } catch {} }
                }
            }, 250);
        }
        function promptProfileSetupChoice(){
            return new Promise(resolve => {
                const modal = document.getElementById('profileSetupPromptModal');
                const setupBtn = document.getElementById('profileSetupGo');
                const proceedBtn = document.getElementById('profileSetupProceed');
                if (!modal || !setupBtn || !proceedBtn) {
                    const ok = window.confirm('Your profile is incomplete. Set up your profile now?');
                    if (ok) { navigateToUserProfileCard(); resolve(false); }
                    else resolve(true);
                    return;
                }
                openModalById('profileSetupPromptModal');
                let handlerFired = false;
                const cleanup = function(){
                    setupBtn.removeEventListener('click', onSetup);
                    proceedBtn.removeEventListener('click', onProceed);
                    modal.removeEventListener('click', onClose);
                };
                const onSetup = function(){
                    if (handlerFired) return;
                    handlerFired = true;
                    cleanup();
                    closeModalById('profileSetupPromptModal');
                    navigateToUserProfileCard();
                    resolve(false);
                };
                const onProceed = function(){
                    if (handlerFired) return;
                    handlerFired = true;
                    cleanup();
                    closeModalById('profileSetupPromptModal');
                    resolve(true);
                };
                const onClose = function(e){
                    if (e.target === modal || e.target.classList.contains('modal-close')) {
                        if (handlerFired) return;
                        handlerFired = true;
                        cleanup();
                        closeModalById('profileSetupPromptModal');
                        resolve(false);
                    }
                };
                setupBtn.addEventListener('click', onSetup);
                proceedBtn.addEventListener('click', onProceed);
                modal.addEventListener('click', onClose);
            });
        }
        async function downloadSaleReceiptPDF(timestamp) {
            const needsProfile = isUserProfileIncompleteForDocs();
            if (needsProfile) {
                const proceed = await promptProfileSetupChoice();
                if (!proceed) return;
            }
            try { if (window.loadLibrary) await loadLibrary('jspdf'); } catch {}
            await ensureLogoReady();
            const sale = state.sales.find(s => s.timestamp === timestamp);
            if (!sale) return showToast("Sale not found", "error");

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ unit: 'pt', format: [226.77, 396.85] }); // 80mm x 140mm receipt size
            const margin = 20;
            const contentWidth = 226.77 - (margin * 2);
            let y = 30;

            // Draw zigzag top border
            doc.setDrawColor(0, 0, 0);
            doc.setLineWidth(1);
            const zigzagSize = 8;
            const zigzagCount = Math.floor(226.77 / zigzagSize);

            // Top zigzag
            for (let i = 0; i < zigzagCount; i++) {
                const x1 = i * zigzagSize;
                const x2 = (i + 0.5) * zigzagSize;
                const x3 = (i + 1) * zigzagSize;
                if (i % 2 === 0) {
                    doc.line(x1, 10, x2, 5);
                    doc.line(x2, 5, x3, 10);
                } else {
                    doc.line(x1, 10, x2, 15);
                    doc.line(x2, 15, x3, 10);
                }
            }

            // Left border
            doc.line(10, 10, 10, 396.85 - 10);

            // Right border
            doc.line(226.77 - 10, 10, 226.77 - 10, 396.85 - 10);

            // Get profile data
            const profile = getUserProfileData();

            // Header - Logo + Business Name
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            const centerX = 226.77 / 2;
            doc.text(profile.businessName || 'Your Business', centerX, y, { align: 'center' });
            y += 20;

            // Business Info
            doc.setFontSize(8);
            doc.setFont(undefined, 'normal');

            if (profile.address) {
                const addressLines = doc.splitTextToSize(profile.address, 186.77);
                addressLines.forEach(line => {
                    doc.text(line, centerX, y, { align: 'center' });
                    y += 10;
                });
            }

            if (profile.phone) {
                doc.text(`Tel: ${profile.phone}`, centerX, y, { align: 'center' });
                y += 10;
            }

            if (profile.email) {
                doc.text(`Email: ${profile.email}`, centerX, y, { align: 'center' });
                y += 10;
            }

            // Separator line
            y += 8;
            doc.setLineWidth(0.5);
            doc.line(margin, y, 226.77 - margin, y);
            y += 15;

            // Receipt Title
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text('SALES RECEIPT', centerX, y, { align: 'center' });
            y += 18;

            // Date and Time
            doc.setFontSize(9);
            doc.setFont(undefined, 'normal');
            doc.text(`Date: ${sale.date}`, margin, y);
            y += 12;
            doc.text(`Time: ${sale.time}`, margin, y);
            y += 12;
            doc.text(`Customer: ${sale.customer}`, margin, y);
            y += 18;

            // Separator line
            doc.line(margin, y, 226.77 - margin, y);
            y += 15;

            // Item Details Header
            doc.setFontSize(8);
            doc.setFont(undefined, 'bold');
            const pageWidth = 226.77;
            const priceX = pageWidth - margin; // Right aligned at content edge
            const qtyX = priceX - 60; // Leave 60pt gap from price
            doc.text('ITEM/DESCRIPTION', margin, y);
            doc.text('QTY', qtyX, y);
            doc.text('PRICE', priceX, y, { align: 'right' });
            y += 12;

            doc.setFont(undefined, 'normal');

            // Item Details
            doc.text(sale.productName, margin, y);
            y += 12;
            doc.text(`${sale.quantity}`, qtyX, y);
            doc.text(`${formatNumber(sale.pricePerUnit)}`, priceX, y, { align: 'right' });
            y += 18;

            // Separator line
            doc.line(margin, y, 226.77 - margin, y);
            y += 15;

            // Totals
            doc.setFontSize(9);
            doc.text('Subtotal:', margin, y);
            doc.text(`${formatNumber(sale.totalPrice)} ${getCurrencySymbol()}`, 160, y, { align: 'right' });
            y += 15;

            doc.setFont(undefined, 'bold');
            doc.setFontSize(11);
            doc.text('TOTAL:', margin, y);
            doc.text(`${formatNumber(sale.totalPrice)} ${getCurrencySymbol()}`, 160, y, { align: 'right' });
            y += 18;

            // Payment Method
            doc.setFontSize(8);
            doc.setFont(undefined, 'normal');
            doc.text(`Payment: ${sale.payment}`, margin, y);
            y += 20;

            // Separator line
            doc.line(margin, y, 226.77 - margin, y);
            y += 15;

            // Footer
            doc.setFontSize(8);
            doc.text('Thank you for your business!', centerX, y, { align: 'center' });
            y += 12;
            doc.text('Visit us again', centerX, y, { align: 'center' });
            y += 18;

            // Transaction ID
            doc.setFontSize(7);
            doc.text(`Trans ID: ${sale.id || timestamp}`, centerX, y, { align: 'center' });

            // Bottom zigzag
            const bottomY = 396.85 - 10;
            for (let i = 0; i < zigzagCount; i++) {
                const x1 = i * zigzagSize;
                const x2 = (i + 0.5) * zigzagSize;
                const x3 = (i + 1) * zigzagSize;
                if (i % 2 === 0) {
                    doc.line(x1, bottomY, x2, bottomY + 5);
                    doc.line(x2, bottomY + 5, x3, bottomY);
                } else {
                    doc.line(x1, bottomY, x2, bottomY - 5);
                    doc.line(x2, bottomY - 5, x3, bottomY);
                }
            }

            // Save the PDF
            downloadPDFSafe(doc, `Receipt_${sale.id || timestamp}.pdf`);
            showToast("Receipt PDF ready", "success");
        }

        function renderUnpaid() {
            const unpaidList = state.unpaidEntries.filter(e => !e.paid && !(e && e.deleted === true));
            const unpaidTotal = unpaidList.reduce((sum, e) => sum + (e.amount || 0), 0);
            const unpaidSorted = unpaidList.slice().sort((a, b) => Number(b.timestamp || 0) - Number(a.timestamp || 0));
            const unpaidShow = state.unpaidEntriesShowCount || 2;
            const unpaidVisible = unpaidSorted.slice(0, unpaidShow);
            const paidSorted = state.unpaidEntries.filter(e => e.paid && !(e && e.deleted === true)).slice().sort((a, b) => Number(b.timestamp || 0) - Number(a.timestamp || 0));
            const paidShow = state.paidEntriesShowCount || 2;
            const paidVisible = paidSorted.slice(0, paidShow);

            return `
                <div class="stat-grid">
                    <div class="stat-card">
                        <div class="stat-label">UNPAID ENTRIES</div>
                        <div class="stat-value">${unpaidList.length}</div>
                    </div>
                    <div class="stat-card" style="background: #d32f2f;">
                        <div class="stat-label">UNPAID AMOUNT</div>
                        <div class="stat-value"> ${formatNumber(unpaidTotal)} Tsh</div>
                    </div>
                </div>

                <div class="card">
                    <h2>Add Unpaid Entry</h2>
                    <form onsubmit="addUnpaidEntry(event)">
                        <div class="form-group">
                            <label>Customer</label>
                            <select id="unpaidCustomer">
                                <option value="" selected>-- Walk-in --</option>
                                ${state.customers
                    .map((c, i) => ({ c, i }))
                    .sort((a, b) => String(a.c.name).localeCompare(String(b.c.name)))
                    .map(({ c, i }) => `<option value="${i}">${c.name}</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>OR Enter Customer Name</label>
                            <input type="text" id="unpaidName" placeholder="Enter name manually">
                        </div>
                        <div class="form-group">
                            <label>Product/Service</label>
                            <select id="unpaidProduct" onchange="updateUnpaidAmount()">
                                <option value="">-- Select Product/Service --</option>
                                ${state.products.map((p, i) => `<option value="${i}">${p.name} -  ${formatNumber(p.price)} Tsh</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>OR Transaction Type</label>
                            <input type="text" id="unpaidType" placeholder="e.g., Product Sale">
                        </div>
                        <div class="form-group">
                            <label>Amount</label>
                            <input type="text" id="unpaidAmount" class="money-input" placeholder="0" required>
                        </div>
                        <button type="submit">Add Unpaid Entry</button>
                    </form>
                </div>

                <div class="card" id="unpaidEntriesCard">
                    <h2>Unpaid Entries (${unpaidList.length})</h2>
                    
                    <div class="bulk-actions">
                        <input type="checkbox" id="selectAll_unpaidEntries" onchange="toggleSelectAll('unpaidEntries')" class="checkbox-select">
                        <label for="selectAll_unpaidEntries">Select All</label>
                        <span style="color: #666; font-size: 12px; margin-left: 8px;">
                            ${getSelectedCount('unpaidEntries')} selected
                        </span>
                        <button class="btn-small btn-success" onclick="bulkMarkPaid()" ${!hasSelected('unpaidEntries') ? 'disabled' : ''}>
                            ✓ Mark Selected as Paid
                        </button>
                        <button class="btn-small btn-danger" onclick="bulkDelete('unpaidEntries')" ${!hasSelected('unpaidEntries') ? 'disabled' : ''}>
                            🗑️ Delete Selected
                        </button>
                    </div>

                    <div class="list-scroll-container">${unpaidVisible.map((entry, idx) => `
                        <div class="item" style="border-left: 4px solid #d32f2f;">
                            <div style="display: flex; gap: 12px; align-items: start;">
                                <input type="checkbox" class="checkbox-select" 
                                       ${state.selectedItems.unpaidEntries && state.selectedItems.unpaidEntries[entry.id] ? 'checked' : ''}
                                       onchange="toggleSelect('unpaidEntries', '${entry.id}')">
                                <div style="flex: 1;">
                                    <div class="item-header">
                                        <span class="item-title">${entry.name}</span>
                                        <span class="badge badge-unpaid">UNPAID</span>
                                    </div>
                                    <div class="item-subtitle">
                                        ${entry.date} ${entry.time}<br>
                                        Type: ${entry.type}<br>
                                        Amount: <strong style="color: #d32f2f;"><span class="money-text"> ${formatNumber(entry.amount)} Tsh</span></strong>
                                    </div>
                                    <div class="flex-gap" style="margin-top:8px;">
                                        <button class="btn-success btn-small" onclick="markAsPaid(${entry.timestamp})">✓ Mark Paid</button>
                                        <button class="btn-small btn-danger btn-delete" data-action="delete" onclick="deleteUnpaidEntry(${entry.timestamp})">Delete</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('') || '<p style="text-align: center; color: #666;">No unpaid entries</p>'}</div>
                    ${unpaidSorted.length > unpaidShow ? `<div style="display:flex;justify-content:center;margin-top:8px;"><button class="btn-small" onclick="showMoreUnpaidEntries()">Show more</button></div>` : ''}
                </div>

                <div class="card" id="paidEntriesCard">
                    <h2>Paid Entries (${paidSorted.length})</h2>
                    <div class="list-scroll-container">${paidVisible.map(entry => `
                        <div class="item">
                            <div class="item-header">
                                <span class="item-title">${entry.name}</span>
                                <span class="badge badge-paid">✓ PAID</span>
                            </div>
                            <div class="item-subtitle">
                                ${entry.date} ${entry.time}<br>
                                Type: ${entry.type}<br>
                                Amount:  ${formatNumber(entry.amount)} Tsh
                            </div>
                        </div>
                    `).join('') || '<p style="text-align: center; color: #666;">No paid entries yet</p>'}</div>
                    ${paidSorted.length > paidShow ? `<div style="display:flex;justify-content:center;margin-top:8px;"><button class="btn-small" onclick="showMorePaidEntries()">Show more</button></div>` : ''}
                </div>
            `;
        }

        function showMoreUnpaidEntries() {
            const total = state.unpaidEntries.filter(e => !e.paid).length;
            const current = state.unpaidEntriesShowCount || 2;
            state.unpaidEntriesShowCount = Math.min(total, current + 3);
            saveData();
            render();
        }

        function showMorePaidEntries() {
            const total = state.unpaidEntries.filter(e => e.paid).length;
            const current = state.paidEntriesShowCount || 2;
            state.paidEntriesShowCount = Math.min(total, current + 3);
            saveData();
            render();
        }

        function updateUnpaidAmount() {
            const productIndex = document.getElementById('unpaidProduct')?.value;
            if (productIndex !== null && productIndex !== '') {
                const product = state.products[productIndex];
                if (product) {
                    document.getElementById('unpaidAmount').value = formatMoney(product.price);
                }
            }
        }

        async function addUnpaidEntry(e) {
            e.preventDefault();
            const now = new Date();
            state.unpaidEntries = state.unpaidEntries || [];

            const customerIndex = document.getElementById('unpaidCustomer')?.value;
            const manualName = document.getElementById('unpaidName')?.value.trim();
            let customerName = manualName;
            if (!customerName && customerIndex) {
                customerName = state.customers[customerIndex].name;
            }
            if (!customerName) {
                customerName = 'WALK IN';
            }

            const productIndex = document.getElementById('unpaidProduct')?.value;
            const manualType = document.getElementById('unpaidType')?.value.trim();
            let transactionType = manualType;
            if (!transactionType && productIndex !== null && productIndex !== '') {
                transactionType = state.products[productIndex].name;
            }
            if (!transactionType) {
                return showToast("Please select product or enter transaction type", "error");
            }

            const amount = parseMoney(document.getElementById('unpaidAmount').value);
            if (isNaN(amount) || amount <= 0) {
                return showToast("Please enter a valid amount", "error");
            }

            const entry = {
                name: customerName,
                type: transactionType,
                amount: amount,
                date: getTodayDateString(),
                time: now.toLocaleTimeString(),
                timestamp: now.getTime(),
                paid: false
            };

            state.unpaidEntries.push(entry);
            saveData();
            render();
            showToast("Unpaid entry added", "success");

            // Sync in background
            if (syncEnabled) syncInBackground();
        }

        async function markAsPaid(timestamp) {
            const entry = state.unpaidEntries.find(e => e.timestamp === timestamp);
            if (!entry) return showToast("Entry not found", "error");

            entry.paid = true;
            const now = new Date();
            state.sales.push({
                date: getTodayDateString(),
                time: now.toLocaleTimeString(),
                timestamp: now.getTime(),
                productName: entry.type,
                customer: entry.name,
                quantity: 1,
                costPerUnit: 0,
                pricePerUnit: entry.amount,
                totalCost: 0,
                totalPrice: entry.amount,
                profit: entry.amount,
                payment: 'Unpaid Entry - Now Paid'
            });

            // Update customer total
            const customer = state.customers.find(c => c.name === entry.name);
            if (customer) {
                customer.totalPurchases = (customer.totalPurchases || 0) + entry.amount;
            }

            saveData();
            render();
            showToast("Marked as paid and added to sales", "success");

            // Sync in background
            if (syncEnabled) syncInBackground();
        }

        async function deleteUnpaidEntry(timestamp) {
            try { playDeleteSound(); } catch (e) { }
            const ok = await requirePinForDestructive('delete');
            if (!ok) { showToast('Delete failed: PIN required', 'error'); return; }
            const idx = state.unpaidEntries.findIndex(e => e.timestamp === timestamp);
            if (idx !== -1) {
                const entry = state.unpaidEntries[idx];
                if (entry) {
                    (async () => {
                        try {
                            if (navigator.onLine && syncEnabled && currentUser) {
                                await deleteOne('unpaid_entries', { timestamp: entry.timestamp });
                            } else {
                                await deleteOne('unpaid_entries', { timestamp: entry.timestamp });
                            }
                        } catch { }
                    })();
                }
                state.unpaidEntries.splice(idx, 1);
                saveData();
                render();
                showToast("Entry deleted", "success");
            }
        }

        function renderNotes() {
            return `
                <div class="card">
                    <h2>Add Note</h2>
                    <form onsubmit="addNote(event)">
                        <div class="form-group">
                            <label>Note Title (Optional)</label>
                            <input type="text" id="noteTitle" placeholder="Brief title...">
                        </div>
                        <div class="form-group">
                            <textarea id="noteContent" placeholder="Write your note here..." required></textarea>
                        </div>
                        <button type="submit">Save Note</button>
                    </form>
                </div>

                <div class="card">
                    <h2>All Notes (${(state.notes || []).filter(n => !(n && n.deleted === true)).length})</h2>
                    <div class="search-box">
                        <input type="text" placeholder="🔍 Search notes..." oninput="searchNotes(this.value)" id="noteSearch">
                    </div>
                    <div style="margin-bottom:8px;">${renderTagChips('notes')}</div>
                    <div id="notesList" class="list-scroll-container">
                        ${renderNotesList()}
                    </div>
                    ${(() => { const total = state.notes.length; const count = (state.listShowCount && state.listShowCount.notes) ? state.listShowCount.notes : 3; const hasMore = count < total; return `<div class=\"flex-gap\" style=\"justify-content:center;margin:8px 0;flex-wrap:nowrap;\"><button class=\"collapse-btn\" onclick=\"${hasMore ? `showMoreList('notes')` : `collapseList('notes')`}\"><span class=\"collapse-icon ${hasMore ? '' : 'expanded'}\">▼</span><span>${hasMore ? 'See more' : 'Hide'}</span></button><button class=\"collapse-btn\" onclick=\"showAllList('notes')\"><span class=\"collapse-icon\">▼</span><span>Show all</span></button></div>`; })()}
                </div>
            `;
        }

        function renderNotesList(searchPeriod = '') {
            let notes = state.notes.slice().filter(n => !(n && n.deleted === true)).sort((a, b) => Number(b.timestamp || 0) - Number(a.timestamp || 0));
            if (searchPeriod) {
                const Period = searchPeriod.toLowerCase();
                notes = notes.filter(n =>
                    n.content.toLowerCase().includes(Period) ||
                    (n.title && n.title.toLowerCase().includes(Period))
                );
            }
            notes = filterItemsByTags(notes, ((state.filterTags||{}).notes)||[], false);
            const count = (state.listShowCount && state.listShowCount.notes) ? state.listShowCount.notes : 3;
            notes = notes.slice(0, count);

            if (notes.length === 0) {
                return '<p style="text-align: center; color: #666;">No notes found</p>';
            }

            return notes.map((note, idx) => {
                const actualIndex = state.notes.indexOf(note);
                const isEditing = state.editingNoteIndex === actualIndex;

                if (isEditing) {
                    return `
                <div class="item">
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px;">Title (Optional)</label>
                        <input type="text" id="editNoteTitle_${actualIndex}" 
                               value="${(note.title || '').replace(/"/g, '&quot;')}" 
                               placeholder="Note title..."
                               style="width: 100%; padding: 10px; border: 2px solid #667eea; border-radius: 8px;">
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px;">Content</label>
                        <textarea id="editNoteContent_${actualIndex}" 
                                  style="width: 100%; min-height: 150px; padding: 10px; border: 2px solid #667eea; border-radius: 8px;"
                                  placeholder="Write your note here...">${note.content}</textarea>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn-success btn-small" onclick="saveNoteEdit(${actualIndex})">💾 Save</button>
                        <button class="btn-secondary btn-small" onclick="cancelNoteEdit()">✖ Cancel</button>
                    </div>
                </div>
            `;
                }

                return `
            <div class="item">
                <div class="note-preview" onclick="openNoteModal(${actualIndex})" style="cursor: pointer;">
                    ${note.title ? `<div class="item-title" style="margin-bottom: 8px;">${escapeHTML(note.title)}</div>` : ''}
                    <div class="item-subtitle" style="margin-bottom: 8px;">${escapeHTML(note.date)} ${escapeHTML(note.time)}</div>
                    <div style="white-space: pre-wrap;">${escapeHTML(note.content)}</div>
                </div>
                <div style="display: flex; gap: 6px; margin-top: 8px;">
                    <button class="btn-small" onclick="startEditingNote(${actualIndex})">✏️ Edit</button>
                    <button class="btn-small btn-danger btn-delete" data-action="delete" onclick="deleteNoteByIndex(${actualIndex})">🗑️ Delete</button>
                    <button type="button" class="btn-small btn-tag" onclick="openItemTagsModal('notes', '${note.id}')" title="📌 Tag">📌 Tag</button>
                </div>
                ${renderTagBadges(note)}
            </div>
        `;
            }).join('');
        }

        function startEditingNote(index) {
            state.currentNoteIndex = index;
            state.noteModalEditing = true;
            openNoteModal(index, true);
        }

        function cancelNoteEdit() {
            state.editingNoteIndex = null;
            saveData();
            render();
        }

        async function saveNoteEdit(index) {
            playTapSound();
            hapticShort();
            const titleInput = document.getElementById(`editNoteTitle_${index}`);
            const contentInput = document.getElementById(`editNoteContent_${index}`);

            if (!contentInput || !contentInput.value.trim()) {
                return showToast('Note content cannot be empty', 'error');
            }

            state.notes[index].title = titleInput ? titleInput.value.trim() : '';
            state.notes[index].content = contentInput.value.trim();
            state.editingNoteIndex = null;

            saveData();
            render();
            showToast('Note updated successfully', 'success');
            if (syncEnabled) {
                const n = state.notes[index];
                await upsertOne('notes', {
                    title: n.title || '',
                    content: n.content,
                    date: n.date,
                    time: n.time,
                    timestamp: n.timestamp
                });
                syncInBackground();
            }
        }

        function searchNotes(Period) {
            document.getElementById('notesList').innerHTML = renderNotesList(Period);
        }

        async function addNote(e) {
            e.preventDefault();
            playTapSound();
            hapticShort();
            const now = new Date();
            const content = document.getElementById('noteContent').value.trim();
            const title = document.getElementById('noteTitle')?.value.trim();

            if (!content) {
                return showToast('Please enter note content', 'error');
            }

            const note = {
                title: title || '',
                content: content,
                date: getTodayDateString(),
                time: now.toLocaleTimeString(),
                timestamp: now.getTime()
            };

            state.notes.push(note);
            saveData();
            render();
            showToast("Note saved", "success");

            if (syncEnabled) {
                await upsertOne('notes', {
                    title: note.title || '',
                    content: note.content,
                    date: note.date,
                    time: note.time,
                    timestamp: note.timestamp
                });
                syncInBackground();
            }
        }

        function renderNoteModalView(index) {
            const note = state.notes[index];
            const raw = (note.content || '').trim();
            const isUrl = /^https?:\/\/\S+$/i.test(raw);
            const body = isUrl
                ? `<div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;"><button class="btn-small btn-success" onclick="downloadNoteUrlFromModal()">Download PDF</button></div>`
                : `<div style="white-space: pre-wrap; line-height: 1.6;">${escapeHTML(raw)}</div>`;
            return `
                ${note.title ? `<h3 class="modal-title" style="margin-bottom: 12px;">${escapeHTML(note.title)}</h3>` : ''}
                <div style="margin-bottom: 12px; color: #666; font-size: 13px;">${escapeHTML(note.date)} ${escapeHTML(note.time)}</div>
                ${body}
            `;
        }

        function renderNoteModalEdit(index) {
            const note = state.notes[index];
            return `
                <div class="pin-gate-wrapper">
                    <div class="form-group">
                        <label>Enter Security PIN to Edit</label>
                        <input type="password" id="noteModalPinGateInput" maxlength="4" placeholder="••••" inputmode="numeric" style="padding-right: 40px;">
                        <div id="noteModalPinGateIcon" class="pin-icon-status"></div>
                    </div>
                    <div id="noteModalPinGateToast" class="pin-toast-inline">Authenticated!.</div>
                </div>
                <div id="noteModalLockedArea" class="locked-content">
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px;">Title (Optional)</label>
                        <input type="text" id="noteModalEditTitle" value="${escapeHTML(note.title || '')}" placeholder="Note title..." style="width: 100%; padding: 10px; border: 2px solid #667eea; border-radius: 8px;">
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px;">Content</label>
                        <textarea id="noteModalEditContent" style="width: 100%; min-height: 150px; padding: 10px; border: 2px solid #667eea; border-radius: 8px;" placeholder="Write your note here...">${escapeHTML(note.content || '')}</textarea>
                    </div>
                </div>
            `;
        }

        function updateNoteModalActions(isEditing) {
            const viewActions = document.getElementById('noteModalActions');
            const editActions = document.getElementById('noteModalEditActions');
            if (viewActions) viewActions.style.display = isEditing ? 'none' : 'flex';
            if (editActions) editActions.style.display = isEditing ? 'flex' : 'none';
        }

        function setupNoteModalPinGate() {
            const pinInput = document.getElementById('noteModalPinGateInput');
            const statusIcon = document.getElementById('noteModalPinGateIcon');
            const toastMsg = document.getElementById('noteModalPinGateToast');
            const lockedArea = document.getElementById('noteModalLockedArea');
            const saveBtn = document.querySelector('#noteModalEditActions .btn-success');
            let pinTimer;
            if (saveBtn) saveBtn.disabled = true;
            setTimeout(() => { try { pinInput && pinInput.focus(); } catch {} }, 100);
            if (!pinInput) return;
            pinInput.oninput = (e) => {
                const val = String(e.target.value || '').replace(/\D/g, '').slice(0, 4);
                if (e.target.value !== val) e.target.value = val;
                clearTimeout(pinTimer);
                if (statusIcon) {
                    statusIcon.className = 'pin-icon-status';
                    statusIcon.style.display = 'none';
                }
                if (toastMsg) {
                    toastMsg.classList.remove('show');
                    toastMsg.textContent = 'Authenticated!.';
                }
                if (val.length === 4) {
                    if (statusIcon) {
                        statusIcon.style.display = 'block';
                        statusIcon.className = 'pin-icon-status pin-spinner';
                    }
                    pinTimer = setTimeout(async () => {
                        const correctHash = (state && state.securityPinHash) || '';
                        let ok = false;
                        try {
                            const h = await window.hashPin(val);
                            ok = !!correctHash && String(h || '') === String(correctHash || '');
                        } catch {}
                        if (ok) {
                            if (pinInput) pinInput.style.borderColor = '';
                            if (statusIcon) statusIcon.className = 'pin-icon-status pin-checkmark';
                            if (toastMsg) toastMsg.classList.add('show');
                            if (lockedArea) lockedArea.classList.remove('locked-content');
                            if (saveBtn) saveBtn.disabled = false;
                            setTimeout(() => { if (toastMsg) toastMsg.classList.remove('show'); }, 3000);
                        } else {
                            if (statusIcon) {
                                statusIcon.style.display = 'block';
                                statusIcon.className = 'pin-icon-status pin-cross';
                            }
                            if (toastMsg) {
                                toastMsg.textContent = 'Wrong PIN.';
                                toastMsg.classList.add('show');
                            }
                            if (pinInput) {
                                pinInput.style.borderColor = 'red';
                                setTimeout(() => { try { pinInput.style.borderColor = ''; } catch {} }, 1000);
                            }
                        }
                    }, 600);
                }
            };
        }

        function openNoteModal(index, forceEdit = false) {
            state.currentNoteIndex = index;
            state.noteModalEditing = !!forceEdit;
            const modal = document.getElementById('noteModal');
            const content = document.getElementById('noteModalContent');
            if (content) {
                content.innerHTML = state.noteModalEditing ? renderNoteModalEdit(index) : renderNoteModalView(index);
            }
            updateNoteModalActions(state.noteModalEditing);
            if (state.noteModalEditing) {
                try { setupNoteModalPinGate(); } catch {}
            }
            modal.classList.add('show');
            modal.setAttribute('aria-modal', 'true');
            const handleOutside = (e) => {
                if (e.target === modal) {
                    closeNoteModal();
                }
            };
            modal.addEventListener('click', handleOutside, { once: true });
        }

        function closeNoteModal() {
            document.getElementById('noteModal').classList.remove('show');
            state.currentNoteIndex = null;
            state.noteModalEditing = false;
            setTimeout(() => { try { if (window._originalRender) window._originalRender(); else render(); } catch {} }, 0);
        }

        function composeNoteText(note) {
            const title = (note.title || '').trim();
            const content = (note.content || '').trim();
            return title ? (title + '\n\n' + content) : content;
        }

        async function copyNoteFromModal() {
            if (state.currentNoteIndex === null) return;
            try { playTapSound(); } catch { }
            try { hapticShort(); } catch { }
            const note = state.notes[state.currentNoteIndex] || {};
            const text = composeNoteText(note);
            try {
                await navigator.clipboard.writeText(text);
                showToast('Note copied', 'success');
            } catch (e) {
                try {
                    const ta = document.createElement('textarea');
                    ta.value = text;
                    ta.setAttribute('readonly', '');
                    ta.style.position = 'fixed';
                    ta.style.opacity = '0';
                    document.body.appendChild(ta);
                    ta.select();
                    document.execCommand('copy');
                    document.body.removeChild(ta);
                    showToast('Note copied', 'success');
                } catch {
                    showToast('Copy failed', 'error');
                }
            }
        }

        async function copyNoteUrlFromModal() {
            if (state.currentNoteIndex === null) return;
            try { playTapSound(); } catch { }
            try { hapticShort(); } catch { }
            const note = state.notes[state.currentNoteIndex] || {};
            const raw = (note.content || '').trim();
            if (!/^https?:\/\/\S+$/i.test(raw)) {
                return showToast('No URL to copy', 'info');
            }
            try {
                await navigator.clipboard.writeText(raw);
                showToast('URL copied', 'success');
            } catch {
                try {
                    const ta = document.createElement('textarea');
                    ta.value = raw;
                    ta.setAttribute('readonly', '');
                    ta.style.position = 'fixed';
                    ta.style.opacity = '0';
                    document.body.appendChild(ta);
                    ta.select();
                    document.execCommand('copy');
                    document.body.removeChild(ta);
                    showToast('URL copied', 'success');
                } catch {
                    showToast('Copy failed', 'error');
                }
            }
        }

        async function downloadNoteUrlFromModal() {
            if (state.currentNoteIndex === null) return;
            try { playTapSound(); } catch { }
            try { hapticShort(); } catch { }
            const note = state.notes[state.currentNoteIndex] || {};
            const raw = (note.content || '').trim();
            if (!/^https?:\/\/\S+$/i.test(raw)) {
                return showToast('No file to download', 'info');
            }
            let filename = 'Report.pdf';
            try {
                const urlObj = new URL(raw);
                const path = urlObj.pathname || '';
                const last = path.split('/').filter(Boolean).pop() || '';
                filename = decodeURIComponent(last || filename);
                if (!/\.pdf$/i.test(filename)) filename = filename + '.pdf';
            } catch {}
            try {
                const res = await fetch(raw);
                if (!res.ok) throw new Error('Failed to fetch file');
                const blob = await res.blob();
                const dlUrl = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = dlUrl;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                setTimeout(() => { try { document.body.removeChild(a); URL.revokeObjectURL(dlUrl); } catch {} }, 0);
                showToast('PDF downloaded', 'success');
            } catch (e) {
                try { window.open(raw, '_blank', 'noopener'); showToast('Opened in new tab', 'info'); } catch { showToast('Download failed', 'error'); }
            }
        }

        async function shareNoteFromModal() {
            if (state.currentNoteIndex === null) return;
            try { playTapSound(); } catch { }
            try { hapticShort(); } catch { }
            const note = state.notes[state.currentNoteIndex] || {};
            const title = (note.title || 'Note').trim() || 'Note';
            const text = composeNoteText(note);
            const ua = navigator.userAgent || navigator.vendor || window.opera;
            const isIOS = /iPad|iPhone|iPod/.test(ua) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
            const isAndroid = /Android/.test(ua);
            if (navigator.share) {
                try {
                    await navigator.share({ title, text });
                    showToast('Shared', 'success');
                    return;
                } catch { }
            }
            try {
                const smsBody = encodeURIComponent(text);
                const smsUrl = isIOS ? `sms:&body=${smsBody}` : `sms:?body=${smsBody}`;
                window.location.href = smsUrl;
                return;
            } catch { }
            try {
                await navigator.clipboard.writeText(text);
                showToast('Copied. Share via any app', 'info');
            } catch {
                showToast('Sharing not supported', 'error');
            }
        }

        function editNoteFromModal() {
            if (state.currentNoteIndex === null) return;
            state.noteModalEditing = true;
            const idx = state.currentNoteIndex;
            const content = document.getElementById('noteModalContent');
            if (content) content.innerHTML = renderNoteModalEdit(idx);
            updateNoteModalActions(true);
            try { setupNoteModalPinGate(); } catch {}
            setTimeout(() => {
                const contentInput = document.getElementById('noteModalEditContent');
                if (contentInput && typeof contentInput.focus === 'function') {
                    try { contentInput.focus(); contentInput.selectionStart = contentInput.value.length; contentInput.selectionEnd = contentInput.value.length; } catch (e) { }
                }
            }, 50);
        }

        async function saveNoteEditFromModal() {
            if (state.currentNoteIndex === null) return;
            playTapSound();
            hapticShort();
            const idx = state.currentNoteIndex;
            const titleInput = document.getElementById('noteModalEditTitle');
            const contentInput = document.getElementById('noteModalEditContent');
            if (!contentInput || !contentInput.value.trim()) {
                return showToast('Note content cannot be empty', 'error');
            }
            state.notes[idx].title = titleInput ? titleInput.value.trim() : '';
            state.notes[idx].content = contentInput.value.trim();
            state.noteModalEditing = false;
            saveData();
            render();
            closeNoteModal();
            showToast('Note updated successfully', 'success');
            if (syncEnabled) {
                const n = state.notes[idx];
                await upsertOne('notes', {
                    title: n.title || '',
                    content: n.content,
                    date: n.date,
                    time: n.time,
                    timestamp: n.timestamp
                });
                syncInBackground();
            }
        }

        function cancelNoteEditFromModal() {
            closeNoteModal();
        }

        function deleteNoteFromModal() {
            if (state.currentNoteIndex === null) return;
            showConfirm("Delete this note?", async function () {
                try { playDeleteSound(); } catch (e) { }
                const ok = await requirePinForDestructive('delete');
                if (!ok) { showToast('Delete failed: PIN required', 'error'); return; }
                const note = state.notes[state.currentNoteIndex];
                if (note) {
                    try {
                        if (navigator.onLine && syncEnabled && currentUser) {
                            await deleteOne('notes', { timestamp: note.timestamp });
                        } else {
                            await deleteOne('notes', { timestamp: note.timestamp });
                        }
                    } catch { }
                }
                state.notes.splice(state.currentNoteIndex, 1);
                saveData();
                closeNoteModal();
                render();
                showToast("Note deleted", "success");

                // Sync in background
                if (syncEnabled) syncInBackground();
            });
        }

        function renderAssets() {
            const assets = (state.assets || []).filter(a => !(a && a.deleted === true)).slice().sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
            const listHtml = assets.map((a, i) => {
                const editing = (state.inlineEditAssets && state.inlineEditAssets[a.timestamp]);
                return `
                <div style="display:grid; grid-template-columns: ${editing ? '1fr' : '1fr auto'}; gap:12px; align-items:start; padding:12px; border-bottom:1px solid rgba(0,0,0,0.08); word-wrap: break-word; overflow-wrap: break-word;">
                    <div style="min-width:0; overflow:hidden; ${editing ? 'display:flex; flex-direction:column; gap:10px;' : ''}">
                        ${editing ? `
                        <div class="form-group" data-label="Asset Name"><input type="text" id="assetName_${a.timestamp}" value="${escapeHTML(a.name || '')}" placeholder="Asset name" style="width:100%"></div>
                        <div class="form-group" data-label="Purchase Date"><input type="date" id="assetDate_${a.timestamp}" value="${escapeHTML(a.purchaseDate || '')}" style="width:100%"></div>
                        <div class="form-group" data-label="Cost"><input type="text" id="assetCost_${a.timestamp}" class="money-input" value="${String(a.cost || 0)}" placeholder="0.00" style="width:100%"></div>
                        <div class="form-group" data-label="Money Source"><select id="assetSrc_${a.timestamp}" style="width:100%">
                            <option value="business" ${String(a.moneySource||'business')==='business'?'selected':''}>Business Capital</option>
                            <option value="personal" ${String(a.moneySource||'')==='personal'?'selected':''}>Personal</option>
                            <option value="loan" ${String(a.moneySource||'')==='loan'?'selected':''}>Loan</option>
                            <option value="gift" ${String(a.moneySource||'')==='gift'?'selected':''}>Gift/Reward</option>
                            <option value="other" ${String(a.moneySource||'')==='other'?'selected':''}>Other</option>
                        </select></div>
                        <div class="form-group" data-label="Description"><textarea id="assetDesc_${a.timestamp}" rows="2" style="width:100%">${escapeHTML(a.description || '')}</textarea></div>
                        <div style="display:flex; gap:6px; justify-content:flex-end; margin-top:6px;">
                            <button class="btn-small btn-success" onclick="saveAssetInlineEdit(${a.timestamp})">Save</button>
                            <button class="btn-small btn-secondary" onclick="toggleAssetInlineEdit(${a.timestamp})">Cancel</button>
                        </div>
                        ` : `
                        <div class="item-title">${escapeHTML(a.name || '')}</div>
                        <div class="item-subtitle">${escapeHTML(a.purchaseDate || '')}</div>
                        <div style="margin-top:6px;">Cost: ${formatMoney(a.cost || 0)}</div>
                        <div style="margin-top:6px;">Source: ${escapeHTML(a.moneySource || 'business')}</div>
                        <div style="margin-top:6px; white-space:pre-wrap;">${escapeHTML(a.description || '')}</div>
                        `}
                    </div>
                    ${editing ? '' : `
                        <div style="display:flex; flex-direction:column; align-items:flex-end; gap:6px; white-space:nowrap;">
                            <div style="display:flex; gap:4px; flex-wrap:wrap; justify-content:flex-end;">
                                <button class="btn-small" onclick="toggleAssetInlineEdit(${a.timestamp})">✏️ Edit</button>
                                <button class="btn-small btn-danger btn-delete" data-action="delete" onclick="deleteAsset(${i})">🗑️ Delete</button>
                            </div>
                        </div>
                    `}
                </div>`;
            }).join('');
            return `
                <div class="card">
                    <h2>${(typeof state.editingAssetIndex === 'number' && (state.assets || [])[state.editingAssetIndex]) ? 'Edit Asset' : 'Add Asset'}</h2>
                    <form onsubmit="${(typeof state.editingAssetIndex === 'number' && (state.assets || [])[state.editingAssetIndex]) ? 'updateAsset(event)' : 'addAsset(event)'}">
                        <div class="form-group">
                            <label>Asset Name</label>
                            <input id="assetName" type="text" placeholder="Asset name" required value="${(typeof state.editingAssetIndex === 'number' && (state.assets || [])[state.editingAssetIndex]) ? escapeHTML((state.assets || [])[state.editingAssetIndex].name || '') : ''}" />
                        </div>
                        <div class="form-group">
                            <label>Purchase Date</label>
                            <input id="assetPurchaseDate" type="date" required value="${(typeof state.editingAssetIndex === 'number' && (state.assets || [])[state.editingAssetIndex]) ? escapeHTML((state.assets || [])[state.editingAssetIndex].purchaseDate || '') : ''}" />
                        </div>
                        <div class="form-group">
                            <label>Asset Cost</label>
                            <input id="assetCost" type="text" class="money-input" placeholder="0.00" required value="${(typeof state.editingAssetIndex === 'number' && (state.assets || [])[state.editingAssetIndex]) ? String((state.assets || [])[state.editingAssetIndex].cost || 0) : ''}" />
                        </div>
                        <div class="form-group">
                            <label>Money Source</label>
                            <select id="assetMoneySource">
                                <option value="business" ${(typeof state.editingAssetIndex === 'number' && (state.assets || [])[state.editingAssetIndex] && (state.assets || [])[state.editingAssetIndex].moneySource) ? ((state.assets || [])[state.editingAssetIndex].moneySource === 'business' ? 'selected' : '') : 'selected'}>Business Capital</option>
                                <option value="personal" ${(typeof state.editingAssetIndex === 'number' && (state.assets || [])[state.editingAssetIndex] && (state.assets || [])[state.editingAssetIndex].moneySource === 'personal') ? 'selected' : ''}>Personal</option>
                                <option value="loan" ${(typeof state.editingAssetIndex === 'number' && (state.assets || [])[state.editingAssetIndex] && (state.assets || [])[state.editingAssetIndex].moneySource === 'loan') ? 'selected' : ''}>Loan</option>
                                <option value="gift" ${(typeof state.editingAssetIndex === 'number' && (state.assets || [])[state.editingAssetIndex] && (state.assets || [])[state.editingAssetIndex].moneySource === 'gift') ? 'selected' : ''}>Gift/Reward</option>
                                <option value="other" ${(typeof state.editingAssetIndex === 'number' && (state.assets || [])[state.editingAssetIndex] && (state.assets || [])[state.editingAssetIndex].moneySource === 'other') ? 'selected' : ''}>Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Description</label>
                            <textarea id="assetDescription" placeholder="Description" rows="2">${(typeof state.editingAssetIndex === 'number' && (state.assets || [])[state.editingAssetIndex]) ? escapeHTML((state.assets || [])[state.editingAssetIndex].description || '') : ''}</textarea>
                        </div>
                        <div style="display:flex; gap:8px;">
                            <button class="btn-success" type="submit">${(typeof state.editingAssetIndex === 'number' && (state.assets || [])[state.editingAssetIndex]) ? 'Update Asset' : 'Save Asset'}</button>
                            ${(typeof state.editingAssetIndex === 'number' && (state.assets || [])[state.editingAssetIndex]) ? '<button type="button" class="btn-small" onclick="cancelAssetEdit()">Cancel</button>' : ''}
                        </div>
                    </form>
                </div>
                <div class="card">
                    <h2>Registered Assets (${assets.length})</h2>
                    ${listHtml || '<div style="padding:12px; color:#666;">No assets yet</div>'}
                </div>
            `;
        }

        async function addAsset(e) {
            e.preventDefault();
            const name = String(document.getElementById('assetName')?.value || '').trim();
            const purchaseDate = String(document.getElementById('assetPurchaseDate')?.value || '').trim();
            const rawCost = String(document.getElementById('assetCost')?.value || '').trim();
            const moneySource = String(document.getElementById('assetMoneySource')?.value || 'business').trim();
            const description = String(document.getElementById('assetDescription')?.value || '').trim();
            if (!name || !purchaseDate || !rawCost) return;
            const cost = parseMoney(rawCost);
            const now = new Date();
            const ts = Date.now();
            const time = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
            const asset = { id: `AST-${ts}`, name, purchaseDate, cost, description, date: purchaseDate, time, timestamp: ts, moneySource };
            state.assets = [asset].concat(state.assets || []);
            try { await upsertOne('assets', { name, purchase_date: purchaseDate, time, timestamp: ts, cost, description, money_source: moneySource }); } catch { }
            if (moneySource === 'business') {
                const exp = {
                    id: generateID('expenses'),
                    date: purchaseDate,
                    time,
                    timestamp: ts,
                    description: `Asset: ${name}`,
                    category: 'Asset Purchase',
                    amount: cost,
                    payment: 'Cash',
                    comment: description
                };
                state.expenses = [exp].concat(state.expenses || []);
                try { await upsertOne('expenses', { date: exp.date, time: exp.time, timestamp: exp.timestamp, description: exp.description, category: exp.category, amount: exp.amount, payment: exp.payment, comment: exp.comment }); } catch {}
            }
            saveData();
            render();
            showToast('Asset added', 'success');
        }

        async function deleteAsset(index) {
            const arr = state.assets || [];
            const it = arr[index];
            if (!it) return;
            try { playDeleteSound(); } catch {}
            const ok = await requirePinForDestructive('delete');
            if (!ok) { showToast('Delete failed: PIN required', 'error'); return; }
            try { deleteOne('assets', { timestamp: it.timestamp }); } catch { }
            arr.splice(index, 1);
            state.assets = arr;
            saveData();
            render();
            showToast('Asset deleted', 'success');
        }

        function editAsset(index) {
            state.editingAssetIndex = index;
            render();
        }

        function cancelAssetEdit() {
            state.editingAssetIndex = null;
            render();
        }

        async function updateAsset(e) {
            e.preventDefault();
            const idx = state.editingAssetIndex;
            const arr = state.assets || [];
            const old = typeof idx === 'number' ? arr[idx] : null;
            if (!old) return;
            const name = String(document.getElementById('assetName')?.value || '').trim();
            const purchaseDate = String(document.getElementById('assetPurchaseDate')?.value || '').trim();
            const rawCost = String(document.getElementById('assetCost')?.value || '').trim();
            const moneySource = String(document.getElementById('assetMoneySource')?.value || 'business').trim();
            const description = String(document.getElementById('assetDescription')?.value || '').trim();
            if (!name || !purchaseDate || !rawCost) return;
            const cost = parseMoney(rawCost);
            const updated = { ...old, name, purchaseDate, cost, description, date: purchaseDate, moneySource };
            arr[idx] = updated;
            state.assets = arr;
            try { await upsertOne('assets', { name, purchase_date: purchaseDate, time: old.time, timestamp: old.timestamp, cost, description, money_source: moneySource }); } catch { }
            const expIdx = (state.expenses || []).findIndex(e => e.timestamp === old.timestamp);
            if (moneySource === 'business') {
                if (expIdx >= 0) {
                    const e = state.expenses[expIdx];
                    e.date = purchaseDate;
                    e.time = old.time;
                    e.description = `Asset: ${name}`;
                    e.category = 'Asset Purchase';
                    e.amount = cost;
                    e.payment = e.payment || 'Cash';
                    e.comment = description;
                    try { await upsertOne('expenses', { date: e.date, time: e.time, timestamp: e.timestamp, description: e.description, category: e.category, amount: e.amount, payment: e.payment, comment: e.comment }); } catch {}
                } else {
                    const e = {
                        id: generateID('expenses'),
                        date: purchaseDate,
                        time: old.time,
                        timestamp: old.timestamp,
                        description: `Asset: ${name}`,
                        category: 'Asset Purchase',
                        amount: cost,
                        payment: 'Cash',
                        comment: description
                    };
                    state.expenses = [e].concat(state.expenses || []);
                    try { await upsertOne('expenses', { date: e.date, time: e.time, timestamp: e.timestamp, description: e.description, category: e.category, amount: e.amount, payment: e.payment, comment: e.comment }); } catch {}
                }
            } else {
                if (expIdx >= 0) {
                    const e = state.expenses[expIdx];
                    try { await deleteOne('expenses', { timestamp: e.timestamp }); } catch {}
                    state.expenses.splice(expIdx, 1);
                }
            }
            state.editingAssetIndex = null;
            saveData();
            render();
            showToast('Asset updated', 'success');
        }
        async function toggleAssetInlineEdit(ts){
            openAssetInlineEditModal(ts);
        }
        async function saveAssetInlineEdit(ts){
            const arr = state.assets || [];
            const idx = arr.findIndex(a => a.timestamp === ts);
            if (idx === -1) return false;
            const old = arr[idx];
            const name = String(document.getElementById(`assetName_${ts}`)?.value || old.name || '').trim();
            const purchaseDate = String(document.getElementById(`assetDate_${ts}`)?.value || old.purchaseDate || '').trim();
            const rawCost = String(document.getElementById(`assetCost_${ts}`)?.value || old.cost || '').trim();
            const description = String(document.getElementById(`assetDesc_${ts}`)?.value || old.description || '').trim();
            const moneySource = String(document.getElementById(`assetSrc_${ts}`)?.value || old.moneySource || 'business').trim();
            if (!name || !purchaseDate || !rawCost) return false;
            const cost = parseMoney(rawCost);
            arr[idx] = { ...old, name, purchaseDate, cost, description, moneySource, date: purchaseDate };
            state.assets = arr;
            try { await upsertOne('assets', { name, purchase_date: purchaseDate, time: old.time, timestamp: old.timestamp, cost, description, money_source: moneySource }); } catch { }
            const expIdx = (state.expenses || []).findIndex(e => e.timestamp === old.timestamp);
            if (moneySource === 'business') {
                if (expIdx >= 0) {
                    const e = state.expenses[expIdx];
                    e.date = purchaseDate; e.time = old.time; e.description = `Asset: ${name}`; e.category = 'Asset Purchase'; e.amount = cost; e.payment = e.payment || 'Cash'; e.comment = description;
                    try { await upsertOne('expenses', { date: e.date, time: e.time, timestamp: e.timestamp, description: e.description, category: e.category, amount: e.amount, payment: e.payment, comment: e.comment }); } catch {}
                } else {
                    const e = { id: generateID('expenses'), date: purchaseDate, time: old.time, timestamp: old.timestamp, description: `Asset: ${name}`, category: 'Asset Purchase', amount: cost, payment: 'Cash', comment: description };
                    state.expenses = [e].concat(state.expenses || []);
                    try { await upsertOne('expenses', { date: e.date, time: e.time, timestamp: e.timestamp, description: e.description, category: e.category, amount: e.amount, payment: e.payment, comment: e.comment }); } catch {}
                }
            } else {
                if (expIdx >= 0) {
                    const e = state.expenses[expIdx];
                    try { await deleteOne('expenses', { timestamp: e.timestamp }); } catch {}
                    state.expenses.splice(expIdx, 1);
                }
            }
            state.inlineEditAssets[ts] = false;
            saveData();
            render();
            showToast('Asset updated', 'success');
            return true;
        }

        function renderMaintenance() {
            const assets = (state.assets || []).filter(a => !(a && a.deleted === true));
            const maint = (state.maintenance || []).filter(m => !(m && m.deleted === true)).slice().sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
            const listHtml = maint.map((m, i) => {
                const editing = (state.inlineEditMaintenance && state.inlineEditMaintenance[m.timestamp]);
                const optionsInline = assets.length
                    ? `<option value="">Select Asset</option>` + assets.map(a => `<option value="${escapeHTML(a.name)}" ${a.name === m.assetName ? 'selected' : ''}>${escapeHTML(a.name)}</option>`).join('')
                    : `<option value="">No assets available</option>`;
                return `
                <div style="display:grid; grid-template-columns: ${editing ? '1fr' : '1fr auto'}; gap:12px; align-items:start; padding:12px; border-bottom:1px solid rgba(0,0,0,0.08); word-wrap: break-word; overflow-wrap: break-word;">
                    <div style="min-width:0; overflow:hidden; ${editing ? 'display:flex; flex-direction:column; gap:10px;' : ''}">
                        ${editing ? `
                        <div class="form-group" data-label="Asset"><select id="maintAsset_${m.timestamp}" style="width:100%">${optionsInline}</select></div>
                        <div class="form-group" data-label="Date"><input type="date" id="maintDate_${m.timestamp}" value="${escapeHTML(m.date || '')}" style="width:100%"></div>
                        <div class="form-group" data-label="Amount"><input type="text" id="maintAmt_${m.timestamp}" class="money-input" value="${String(m.amount || 0)}" placeholder="0.00" style="width:100%"></div>
                        <div class="form-group" data-label="Money Source"><select id="maintSrc_${m.timestamp}" style="width:100%">
                            <option value="business" ${String(m.moneySource||'business')==='business'?'selected':''}>Business Capital</option>
                            <option value="personal" ${String(m.moneySource||'')==='personal'?'selected':''}>Personal</option>
                            <option value="loan" ${String(m.moneySource||'')==='loan'?'selected':''}>Loan</option>
                            <option value="other" ${String(m.moneySource||'')==='other'?'selected':''}>Other</option>
                        </select></div>
                        <div class="form-group" data-label="Description"><textarea id="maintDesc_${m.timestamp}" rows="2" style="width:100%">${escapeHTML(m.description || '')}</textarea></div>
                        <div style="display:flex; gap:6px; justify-content:flex-end; margin-top:6px;">
                            <button class="btn-small btn-success" onclick="saveMaintenanceInlineEdit(${m.timestamp})">Save</button>
                            <button class="btn-small btn-secondary" onclick="toggleMaintenanceInlineEdit(${m.timestamp})">Cancel</button>
                        </div>
                        ` : `
                        <div class="item-title">${escapeHTML(m.assetName || '')}</div>
                        <div class="item-subtitle">${escapeHTML(m.date || '')}</div>
                        <div style="margin-top:6px;">Amount: <span class="money-text">${formatMoney(m.amount || 0)} ${getCurrencySymbol()}</span></div>
                        <div style="margin-top:6px;">Source: ${escapeHTML(m.moneySource || 'business')}</div>
                        <div style="margin-top:6px; white-space:pre-wrap;">${escapeHTML(m.description || '')}</div>
                        `}
                    </div>
                    ${editing ? '' : `
                        <div style="display:flex; flex-direction:column; align-items:flex-end; gap:6px; white-space:nowrap;">
                            <div style="display:flex; gap:4px; flex-wrap:wrap; justify-content:flex-end;">
                                <button class="btn-small" onclick="toggleMaintenanceInlineEdit(${m.timestamp})">✏️ Edit</button>
                                <button class="btn-small btn-danger btn-delete" data-action="delete" onclick="deleteMaintenance(${i})">🗑️ Delete</button>
                            </div>
                        </div>
                    `}
                </div>`;
            }).join('');
            return `
                <div class="card">
                    <h2>${(typeof state.editingMaintenanceIndex === 'number' && (state.maintenance || [])[state.editingMaintenanceIndex]) ? 'Edit Maintenance' : 'Add Maintenance'}</h2>
                    <form onsubmit="${(typeof state.editingMaintenanceIndex === 'number' && (state.maintenance || [])[state.editingMaintenanceIndex]) ? 'updateMaintenance(event)' : 'addMaintenance(event)'}">
                        <div class="form-group">
                            <label>Asset</label>
                            <select id="maintenanceAsset" ${assets.length ? '' : 'disabled'}>
                                ${assets.length ? `<option value="">Select Asset</option>${assets.map(a => `<option value="${escapeHTML(a.name)}">${escapeHTML(a.name)}</option>`).join('')}` : `<option value="">No assets available</option>`}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Money Source</label>
                            <select id="maintenanceMoneySource">
                                <option value="business" ${(typeof state.editingMaintenanceIndex === 'number' && (state.maintenance || [])[state.editingMaintenanceIndex] && (state.maintenance || [])[state.editingMaintenanceIndex].moneySource) ? (((state.maintenance || [])[state.editingMaintenanceIndex].moneySource || 'business') === 'business' ? 'selected' : '') : 'selected'}>Business Capital</option>
                                <option value="personal" ${(typeof state.editingMaintenanceIndex === 'number' && (state.maintenance || [])[state.editingMaintenanceIndex] && (state.maintenance || [])[state.editingMaintenanceIndex].moneySource === 'personal') ? 'selected' : ''}>Personal</option>
                                <option value="loan" ${(typeof state.editingMaintenanceIndex === 'number' && (state.maintenance || [])[state.editingMaintenanceIndex] && (state.maintenance || [])[state.editingMaintenanceIndex].moneySource === 'loan') ? 'selected' : ''}>Loan</option>
                                <option value="other" ${(typeof state.editingMaintenanceIndex === 'number' && (state.maintenance || [])[state.editingMaintenanceIndex] && (state.maintenance || [])[state.editingMaintenanceIndex].moneySource === 'other') ? 'selected' : ''}>Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Date</label>
                            <input id="maintenanceDate" type="date" required value="${(typeof state.editingMaintenanceIndex === 'number' && (state.maintenance || [])[state.editingMaintenanceIndex]) ? escapeHTML((state.maintenance || [])[state.editingMaintenanceIndex].date || '') : ''}" />
                        </div>
                        <div class="form-group">
                            <label>Amount</label>
                            <input id="maintenanceAmount" type="text" class="money-input" placeholder="0.00" required value="${(typeof state.editingMaintenanceIndex === 'number' && (state.maintenance || [])[state.editingMaintenanceIndex]) ? String((state.maintenance || [])[state.editingMaintenanceIndex].amount || 0) : ''}" />
                        </div>
                        <div class="form-group">
                            <label>Description</label>
                            <textarea id="maintenanceDescription" placeholder="Description" rows="2">${(typeof state.editingMaintenanceIndex === 'number' && (state.maintenance || [])[state.editingMaintenanceIndex]) ? escapeHTML((state.maintenance || [])[state.editingMaintenanceIndex].description || '') : ''}</textarea>
                        </div>
                        <div style="display:flex; gap:8px;">
                            <button class="btn-success" type="submit" ${assets.length ? '' : 'disabled'}>${(typeof state.editingMaintenanceIndex === 'number' && (state.maintenance || [])[state.editingMaintenanceIndex]) ? 'Update Maintenance' : 'Save Maintenance'}</button>
                            ${(typeof state.editingMaintenanceIndex === 'number' && (state.maintenance || [])[state.editingMaintenanceIndex]) ? '<button type="button" class="btn-small" onclick="cancelMaintenanceEdit()">Cancel</button>' : ''}
                        </div>
                    </form>
                </div>
                <div class="card">
                    <h2>Maintenance Records (${maint.length})</h2>
                    ${listHtml || '<div style="padding:12px; color:#666;">No maintenance records yet</div>'}
                </div>
            `;
        }

        function addMaintenance(e) {
            e.preventDefault();
            const assetName = String(document.getElementById('maintenanceAsset')?.value || '').trim();
            const moneySource = String(document.getElementById('maintenanceMoneySource')?.value || 'business').trim();
            const date = String(document.getElementById('maintenanceDate')?.value || '').trim();
            const rawAmount = String(document.getElementById('maintenanceAmount')?.value || '').trim();
            const description = String(document.getElementById('maintenanceDescription')?.value || '').trim();
            if (!assetName || !date || !rawAmount) return;
            const amount = parseMoney(rawAmount);
            const ts = Date.now();
            const now = new Date();
            const time = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
            const m = { id: `MTN-${ts}`, assetName, amount, date, description, time, timestamp: ts, moneySource };
            state.maintenance = [m].concat(state.maintenance || []);
            try { upsertOne('maintenance', { asset_name: assetName, amount, date, time, timestamp: ts, description, money_source: moneySource }); } catch { }

            if (moneySource === 'business') {
                const exp = {
                    id: `E-${ts}`,
                    date,
                    time,
                    timestamp: ts,
                    title: `Maintenance - ${assetName}`,
                    description: `Maintenance - ${assetName}`,
                    comment: description,
                    category: 'Maintenance',
                    amount,
                    payment: 'Cash'
                };
                state.expenses = [exp].concat(state.expenses || []);
                try { upsertOne('expenses', exp); } catch { }
            }

            saveData();
            render();
            showToast(moneySource === 'business' ? 'Maintenance saved and recorded to expenses' : 'Maintenance saved', 'success');
        }

        async function deleteMaintenance(index) {
            const arr = state.maintenance || [];
            const it = arr[index];
            if (!it) return;
            try { playDeleteSound(); } catch {}
            const ok = await requirePinForDestructive('delete');
            if (!ok) { showToast('Delete failed: PIN required', 'error'); return; }
            try { deleteOne('maintenance', { timestamp: it.timestamp }); } catch { }
            try {
                const expIdx = (state.expenses || []).findIndex(e => Number(e.timestamp) === Number(it.timestamp) && String(e.category || '').toLowerCase() === 'maintenance');
                if (expIdx >= 0) {
                    const ex = state.expenses[expIdx];
                    try { deleteOne('expenses', { timestamp: ex.timestamp }); } catch { }
                    state.expenses.splice(expIdx, 1);
                }
            } catch {}
            arr.splice(index, 1);
            state.maintenance = arr;
            saveData();
            render();
            showToast('Maintenance record deleted', 'success');
        }

        function editMaintenance(index) {
            state.editingMaintenanceIndex = index;
            const assets = state.assets || [];
            const it = (state.maintenance || [])[index];
            setTimeout(() => {
                try {
                    const sel = document.getElementById('maintenanceAsset');
                    if (sel && assets.length) sel.value = it?.assetName || '';
                } catch { }
                try {
                    const src = document.getElementById('maintenanceMoneySource');
                    if (src) src.value = it?.moneySource || 'business';
                } catch { }
            }, 0);
            render();
        }

        function cancelMaintenanceEdit() {
            state.editingMaintenanceIndex = null;
            render();
        }

        function updateMaintenance(e) {
            e.preventDefault();
            const idx = state.editingMaintenanceIndex;
            const arr = state.maintenance || [];
            const old = typeof idx === 'number' ? arr[idx] : null;
            if (!old) return;
            const assetName = String(document.getElementById('maintenanceAsset')?.value || '').trim();
            const moneySource = String(document.getElementById('maintenanceMoneySource')?.value || 'business').trim();
            const date = String(document.getElementById('maintenanceDate')?.value || '').trim();
            const rawAmount = String(document.getElementById('maintenanceAmount')?.value || '').trim();
            const description = String(document.getElementById('maintenanceDescription')?.value || '').trim();
            if (!assetName || !date || !rawAmount) return;
            const amount = parseMoney(rawAmount);
            const now = new Date();
            const time = old.time || `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
            const updated = { ...old, assetName, date, amount, description, moneySource };
            arr[idx] = updated;
            state.maintenance = arr;
            try { upsertOne('maintenance', { asset_name: assetName, amount, date, time, timestamp: old.timestamp, description, money_source: moneySource }); } catch { }
            let expIdx = (state.expenses || []).findIndex(e => e.timestamp === old.timestamp);
            if (moneySource === 'business') {
                if (expIdx >= 0) {
                    state.expenses[expIdx] = { ...state.expenses[expIdx], date, time, title: `Maintenance - ${assetName}`, description: `Maintenance - ${assetName}`, comment: description, category: 'Maintenance', amount };
                    try { upsertOne('expenses', state.expenses[expIdx]); } catch { }
                } else {
                    const exp = { id: `E-${old.timestamp}`, date, time, timestamp: old.timestamp, title: `Maintenance - ${assetName}`, description: `Maintenance - ${assetName}`, comment: description, category: 'Maintenance', amount, payment: 'Cash' };
                    state.expenses = [exp].concat(state.expenses || []);
                    try { upsertOne('expenses', exp); } catch { }
                }
            } else {
                if (expIdx >= 0) {
                    const ex = state.expenses[expIdx];
                    try { deleteOne('expenses', { timestamp: ex.timestamp }); } catch {}
                    state.expenses.splice(expIdx, 1);
                }
            }
            state.editingMaintenanceIndex = null;
            saveData();
            render();
            showToast('Maintenance updated', 'success');
        }

        async function toggleMaintenanceInlineEdit(ts){
            openMaintenanceInlineEditModal(ts);
        }
        async function saveMaintenanceInlineEdit(ts){
            const arr = state.maintenance || [];
            const idx = arr.findIndex(x => x.timestamp === ts);
            if (idx === -1) return false;
            const old = arr[idx];
            const assetName = String(document.getElementById(`maintAsset_${ts}`)?.value || old.assetName || '').trim();
            const date = String(document.getElementById(`maintDate_${ts}`)?.value || old.date || '').trim();
            const rawAmount = String(document.getElementById(`maintAmt_${ts}`)?.value || old.amount || '').trim();
            const moneySource = String(document.getElementById(`maintSrc_${ts}`)?.value || old.moneySource || 'business').trim();
            const description = String(document.getElementById(`maintDesc_${ts}`)?.value || old.description || '').trim();
            if (!assetName || !date || !rawAmount) return false;
            const amount = parseMoney(rawAmount);
            const now = new Date();
            const time = old.time || `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
            const updated = { ...old, assetName, date, amount, description, moneySource };
            arr[idx] = updated;
            state.maintenance = arr;
            try { await upsertOne('maintenance', { asset_name: assetName, amount, date, time, timestamp: old.timestamp, description, money_source: moneySource }); } catch { }
            let expIdx = (state.expenses || []).findIndex(e => e.timestamp === old.timestamp);
            if (moneySource === 'business') {
                if (expIdx >= 0) {
                    state.expenses[expIdx] = { ...state.expenses[expIdx], date, time, title: `Maintenance - ${assetName}`, description: `Maintenance - ${assetName}`, comment: description, category: 'Maintenance', amount };
                    try { await upsertOne('expenses', state.expenses[expIdx]); } catch { }
                } else {
                    const exp = { id: `E-${old.timestamp}`, date, time, timestamp: old.timestamp, title: `Maintenance - ${assetName}`, description: `Maintenance - ${assetName}`, comment: description, category: 'Maintenance', amount, payment: 'Cash' };
                    state.expenses = [exp].concat(state.expenses || []);
                    try { await upsertOne('expenses', exp); } catch { }
                }
            } else {
                if (expIdx >= 0) {
                    const ex = state.expenses[expIdx];
                    try { deleteOne('expenses', { timestamp: ex.timestamp }); } catch {}
                    state.expenses.splice(expIdx, 1);
                }
            }
            state.inlineEditMaintenance[ts] = false;
            saveData();
            render();
            showToast('Maintenance updated', 'success');
            return true;
        }

        // Offline info modal control
        function openOfflineInfoModal() {
            const modal = document.getElementById('offlineInfoModal');
            if (!modal) return;
            modal.classList.add('show');
            const handleOutside = (e) => {
                if (e.target === modal) {
                    closeOfflineInfoModal();
                }
            };
            modal.addEventListener('click', handleOutside, { once: true });
        }

        function closeOfflineInfoModal() {
            const modal = document.getElementById('offlineInfoModal');
            if (modal) modal.classList.remove('show');
        }

        function renderLoans() {
            const filter = String(document.getElementById('loanFilter')?.value || 'all');
            let givenTotal = 0;
            let takenTotal = 0;
            const loans = (state.loans || []).slice();
            const tagSel = ((state.filterTags || {}).loans) || [];
            let filteredLoans = loans.filter(l => {
                if (filter === 'all') return true;
                return String(l.type || '') === filter;
            });
            filteredLoans = filterItemsByTags(filteredLoans, tagSel, false);
            filteredLoans = filteredLoans.filter(l => !(l && l.deleted === true));
            const listHtml = filteredLoans.map((loan, index) => {
                const paid = (loan.payments || []).reduce((sum, p) => sum + (Number(p.amount) || 0), 0);
                const remaining = Math.max(0, (Number(loan.amount) || 0) - paid);
                if (remaining > 0) {
                    if (loan.type === 'given') givenTotal += remaining;
                    else takenTotal += remaining;
                }
                const isPaid = remaining <= 0;
                const statusColor = isPaid ? 'green' : (loan.type === 'given' ? '#1976d2' : '#d84315');
                const arrowIcon = loan.type === 'given' ? '↗' : '↙';
                return `
                <div class="item card">
                    <div class="item-header">
                        <span class="item-title" style="color:${statusColor}">${arrowIcon} ${escapeHTML(loan.name || '')}</span>
                        <span class="money-text">${formatNumber(remaining)} / ${formatNumber(loan.amount || 0)} ${getCurrencySymbol()}</span>
                    </div>
                    <div class="item-subtitle">
                        ${loan.type === 'given' ? 'Lent on' : 'Borrowed on'} ${escapeHTML(loan.date || '')}
                        ${isPaid ? ' • <span style="color:green">PAID OFF</span>' : ''}
                    </div>
                    <div class="flex-gap" style="margin-top:10px;">
                        ${!isPaid ? `<button class="btn-small" onclick="toggleLoanPaymentInline(${index})">${loan.type==='given'?'Record Repayment':'Record Payment'}</button>` : ''}
                        <button class="btn-small btn-secondary" onclick="deleteLoan(${index})">Delete</button>
                        <button class="btn-small" style="${state.theme === 'dark' ? 'background:#1f2937;color:#e5e7eb;border:1px solid #374151;' : 'background:#e8e8e8;color:#333;border:1px solid #999;'}" onclick="openItemTagsModal('loans', '${(loan.id || loan.timestamp)}')">📌 Tag</button>
                    </div>
                    ${renderTagBadges(loan)}
                    ${(() => {
                        const editing = (state.inlineLoanEdit && state.inlineLoanEdit[loan.id]);
                        if (!editing) return '';
                        return `
                        <div class="flex-gap" style="margin-top:8px; flex-wrap:wrap;">
                            <div class="form-group" data-label="Amount">
                                <input type="text" id="loanPayAmt_${loan.id}" class="money-input" placeholder="0.00">
                            </div>
                            <div class="form-group" data-label="Date">
                                <input type="date" id="loanPayDate_${loan.id}" value="${getTodayDateString()}">
                            </div>
                            ${loan.type==='given' ? `
                            <div class="form-group" data-label="Destination">
                                <select id="loanPayDest_${loan.id}">
                                    <option value="business">To Business (+Revenue)</option>
                                    <option value="personal">To Personal</option>
                                    <option value="other">To Other</option>
                                </select>
                            </div>` : `
                            <div class="form-group" data-label="Source">
                                <select id="loanPaySrc_${loan.id}">
                                    <option value="business">Business Capital</option>
                                    <option value="personal">Personal</option>
                                    <option value="other">Other</option>
                                    <option value="loan">Loan</option>
                                </select>
                            </div>`}
                            <div class="flex-gap">
                                <button class="btn-small btn-success" onclick="saveLoanPayment(${index})">Save</button>
                                <button class="btn-small btn-secondary" onclick="toggleLoanPaymentInline(${index})">Cancel</button>
                            </div>
                        </div>`;
                    })()}
                </div>`;
            }).join('') || '<div style="padding:12px;color:#666;">No loans yet</div>';
            const html = `
            <div class="card">
                <div class="flex-between">
                    <h2>Loan Manager</h2>
                </div>
                <div style="margin-bottom:8px;">${renderTagChips('loans')}</div>
                <div class="stat-grid" style="margin-bottom:8px;">
                    <div class="stat-card">
                        <div class="stat-value money-text" id="total-owed-to-me">${formatNumber(givenTotal)} ${getCurrencySymbol()}</div>
                        <div class="stat-label">Owed to Me (Assets)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value money-text" id="total-i-owe">${formatNumber(takenTotal)} ${getCurrencySymbol()}</div>
                        <div class="stat-label">I Owe (Liabilities)</div>
                    </div>
                </div>
                <div class="form-group" data-label="Type">
                    <select id="loanTypeSel" onchange="toggleLoanTypeFields()"><option value="given">I Lent (Given)</option><option value="taken">I Borrowed (Taken)</option></select>
                </div>
                <div class="form-group" id="loanGivenSourceGroup" data-label="Source" style="display:block;">
                    <select id="loanGivenSourceSel">
                        <option value="business">Business Capital</option>
                        <option value="personal">Personal</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group" data-label="Name">
                    <input type="text" id="loanName" placeholder="Person/Institution" required>
                </div>
                <div class="form-group" data-label="Amount">
                    <input type="text" id="loanAmount" class="money-input" placeholder="0.00" required>
                </div>
                <div class="form-group" data-label="Date">
                    <input type="date" id="loanDate" required>
                </div>
                <div class="form-group" data-label="Notes">
                    <textarea id="loanNotes" placeholder="Notes..."></textarea>
                </div>
                <div class="flex-gap" style="margin-top:12px;">
                    <button class="btn-success btn-small" onclick="submitNewLoan()">Save</button>
                </div>
                <div class="filter-row" style="margin: 12px 0;">
                    <div class="form-group" data-label="Filter">
                        <select id="loanFilter" onchange="renderLoans()">
                            <option value="all" ${filter==='all'?'selected':''}>All Loans</option>
                            <option value="given" ${filter==='given'?'selected':''}>Given (Lent Out)</option>
                            <option value="taken" ${filter==='taken'?'selected':''}>Taken (Borrowed)</option>
                        </select>
                    </div>
                </div>
                <div id="loans-list" class="item-list">${listHtml}</div>
            </div>
            `;
            return html;
        }
        function toggleLoanTypeFields(){
            const typeEl = document.getElementById('loanTypeSel');
            const grp = document.getElementById('loanGivenSourceGroup');
            if (typeEl && grp) grp.style.display = (typeEl.value === 'given') ? 'block' : 'none';
        }
        function ensureLoansArray(){ state.loans = Array.isArray(state.loans) ? state.loans : []; }
        function openAddLoanModal(){
            ensureLoansArray();
            const id = 'addLoanModal';
            let m = document.getElementById(id);
            if (!m){
                m = document.createElement('div');
                m.className = 'modal';
                m.id = id;
                m.innerHTML = `
                <div class="modal-content">
                    <button class="modal-close" onclick="closeAddLoanModal()">×</button>
                    <div class="modal-title">New Loan</div>
                    <div class="form-group" data-label="Type">
                        <select id="loanTypeSel"><option value="given">I Lent (Given)</option><option value="taken">I Borrowed (Taken)</option></select>
                    </div>
                    <div class="form-group" data-label="Name">
                        <input type="text" id="loanName" placeholder="Person/Institution" required>
                    </div>
                    <div class="form-group" data-label="Amount">
                        <input type="text" id="loanAmount" class="money-input" placeholder="0.00" required>
                    </div>
                    <div class="form-group" data-label="Date">
                        <input type="date" id="loanDate" required>
                    </div>
                    <div class="form-group" data-label="Notes">
                        <textarea id="loanNotes" placeholder="Notes..."></textarea>
                    </div>
                    <div class="flex-gap" style="margin-top:12px;">
                        <button class="btn-success btn-small" onclick="submitNewLoan()">Save</button>
                        <button class="btn-secondary btn-small" onclick="closeAddLoanModal()">Cancel</button>
                    </div>
                </div>`;
                document.body.appendChild(m);
            }
            m.classList.add('show');
        }
        function closeAddLoanModal(){ const m=document.getElementById('addLoanModal'); if (m) m.classList.remove('show'); }
        function submitNewLoan(){
            const name = String(document.getElementById('loanName')?.value || '').trim();
            const type = String(document.getElementById('loanTypeSel')?.value || 'given').trim();
            const rawAmt = String(document.getElementById('loanAmount')?.value || '').trim();
            const amount = parseMoney(rawAmt);
            const date = String(document.getElementById('loanDate')?.value || '').trim();
            const notes = String(document.getElementById('loanNotes')?.value || '').trim();
            if (!name || !date || isNaN(amount) || amount <= 0){ showToast('Fill all fields correctly', 'error'); return; }
            const moneySource = type === 'given' ? (String(document.getElementById('loanGivenSourceSel')?.value || 'business').trim()) : null;
            addLoan(name, type, amount, date, notes, moneySource);
            closeAddLoanModal();
            showToast('Loan added', 'success');
        }
        async function addLoan(name, type, amount, date, notes, moneySource=null){
            ensureLoansArray();
            const ts = Date.now();
            state.loans.push({ id: ts, timestamp: ts, name, type, amount: Number(amount)||0, date, notes: notes||'', moneySource: moneySource || null, payments: [] });
            if (type === 'given' && moneySource === 'business'){
                const time = new Date().toLocaleTimeString();
                const exp = { id: generateID('expenses'), date, time, timestamp: ts, description: `Loan Given: ${name}`, category: 'Loan Given', amount: Number(amount)||0, payment: 'Cash', comment: notes||'' };
                state.expenses = [exp].concat(state.expenses || []);
                try { await upsertOne('expenses', { date: exp.date, time: exp.time, timestamp: exp.timestamp, description: exp.description, category: exp.category, amount: exp.amount, payment: exp.payment, comment: exp.comment }); } catch {}
            }
            try { await upsertOne('loans', { timestamp: ts, name, type, amount: Number(amount)||0, date, notes: notes||'', money_source: moneySource || null }); } catch {}
            saveData();
            render();
        }
        function toggleLoanPaymentInline(index){
            ensureLoansArray();
            state.inlineLoanEdit = state.inlineLoanEdit || {};
            const ln = state.loans[index];
            if (!ln) return;
            state.inlineLoanEdit[ln.id] = !state.inlineLoanEdit[ln.id];
            render();
        }
        async function saveLoanPayment(index){
            ensureLoansArray();
            const ln = state.loans[index];
            if (!ln) return;
            const amt = parseMoney(document.getElementById(`loanPayAmt_${ln.id}`)?.value || '');
            if (!amt || isNaN(amt) || amt <= 0) { showToast('Invalid amount', 'error'); return; }
            const date = document.getElementById(`loanPayDate_${ln.id}`)?.value || getTodayDateString();
            ln.payments = Array.isArray(ln.payments) ? ln.payments : [];
            const payTs = Date.now();
            if (ln.type === 'given'){
                const dest = document.getElementById(`loanPayDest_${ln.id}`)?.value || 'business';
                ln.payments.push({ date, amount: Number(amt), destination: dest, timestamp: payTs });
            } else {
                const src = document.getElementById(`loanPaySrc_${ln.id}`)?.value || 'business';
                ln.payments.push({ date, amount: Number(amt), source: src, timestamp: payTs });
            }
            saveData();
            state.inlineLoanEdit[ln.id] = false;
            render();
            showToast('Payment recorded', 'success');
            if (typeof syncEnabled !== 'undefined' && syncEnabled) {
                const time = new Date().toLocaleTimeString();
                const ts = payTs;
                if (ln.type === 'given') {
                    const dest = document.getElementById(`loanPayDest_${ln.id}`)?.value || 'business';
                    if (dest === 'business') {
                        try { await upsertOne('income', { date, time, timestamp: ts, source: 'Loan Repayment', amount: amt, payment: 'Cash', comment: `Loan repayment: ${ln.name}` }); } catch {}
                    }
                    try { await upsertOne('loan_payments', { loan_timestamp: (ln.timestamp || ln.id), amount: amt, date, timestamp: ts, destination: dest }); } catch {}
                } else {
                    const src = document.getElementById(`loanPaySrc_${ln.id}`)?.value || 'business';
                    if (src === 'business') {
                        try { await upsertOne('expenses', { date, time, timestamp: ts, description: `Loan repayment: ${ln.name}`, category: 'Loan Repayment', amount: amt, payment: 'Cash', comment: '' }); } catch {}
                    }
                    try { await upsertOne('loan_payments', { loan_timestamp: (ln.timestamp || ln.id), amount: amt, date, timestamp: ts, source: src }); } catch {}
                }
                try { syncInBackground && syncInBackground(); } catch {}
            }
        }
        function deleteLoan(index){
            ensureLoansArray();
            const ln = state.loans[index];
            if (!ln) return;
            showConfirm('Delete this loan record?', async function () {
                try { playDeleteSound(); } catch (e) { }
                const ok = await requirePinForDestructive('delete');
                if (!ok) { showToast('Delete failed: PIN required', 'error'); return; }
                const ts = ln.timestamp || ln.id;
                const payments = Array.isArray(ln.payments) ? ln.payments.slice() : [];
                state.loans.splice(index, 1);
                if (String(ln.type || '').toLowerCase() === 'given' && String((ln.moneySource || ln.money_source || '')).toLowerCase() === 'business') {
                    try {
                        const exIdx = (state.expenses || []).findIndex(e => e && e.timestamp === ts && String(e.category || '').toLowerCase() === 'loan given');
                        if (exIdx !== -1) state.expenses.splice(exIdx, 1);
                    } catch {}
                }
                saveData();
                render();
                showToast('Loan deleted', 'success');
                if (syncEnabled) {
                    try { await deleteOne('loans', { timestamp: ts }); } catch {}
                    if (String(ln.type || '').toLowerCase() === 'given' && String((ln.moneySource || ln.money_source || '')).toLowerCase() === 'business') {
                        try { await deleteOne('expenses', { timestamp: ts }); } catch {}
                    }
                    for (const p of payments) {
                        const payTs = p.timestamp || p.ts;
                        if (!payTs) continue;
                        try { await deleteOne('loan_payments', { timestamp: payTs }); } catch {}
                    }
                    try { syncInBackground && syncInBackground(); } catch {}
                }
            });
        }
        // 10% Profit Share Analytics Modal
        let currentProfitSharePeriod = 'weekly';

        function openProfitShareAnalyticsModal() {
            const modal = document.getElementById('profitShareAnalyticsModal');
            if (!modal) return;

            // Close side nav if open
            try {
                const sideNav = document.getElementById('sideNav');
                if (sideNav && sideNav.classList.contains('show')) {
                    toggleSideNav();
                }
            } catch (e) { }

            // Set default period to weekly
            currentProfitSharePeriod = 'weekly';

            modal.classList.add('show');
            renderProfitShareAnalytics();

            // Add click outside to close
            setTimeout(() => {
                const handleOutsideClick = (e) => {
                    if (e.target === modal) {
                        closeProfitShareAnalyticsModal();
                        modal.removeEventListener('click', handleOutsideClick);
                    }
                };
                modal.addEventListener('click', handleOutsideClick);
            }, 100);
        }

        function closeProfitShareAnalyticsModal() {
            const modal = document.getElementById('profitShareAnalyticsModal');
            if (modal) modal.classList.remove('show');
        }

        function switchProfitSharePeriod(period) {
            currentProfitSharePeriod = period;
            renderProfitShareAnalytics();
        }

        function renderProfitShareAnalytics() {
            const content = document.getElementById('profitShareAnalyticsContent');
            if (!content) return;

            // Update tab styles
            ['weekly', 'monthly', 'halfYear', 'yearly'].forEach(p => {
                const tab = document.getElementById('profitPeriod' + p.charAt(0).toUpperCase() + p.slice(1));
                if (tab) {
                    if (p === currentProfitSharePeriod) {
                        tab.style.opacity = '1';
                        tab.style.boxShadow = '0 8px 25px rgba(25, 118, 210, 0.4), inset 0 -2px 5px rgba(0, 0, 0, 0.1)';
                    } else {
                        tab.style.opacity = '0.6';
                        tab.style.boxShadow = '0 4px 15px rgba(0, 0, 0, 0.2), inset 0 -2px 5px rgba(0, 0, 0, 0.1)';
                    }
                }
            });

            // Calculate date range
            const today = new Date();
            today.setHours(23, 59, 59, 999); // End of today
            let startDate = new Date();
            let periodLabel;

            switch (currentProfitSharePeriod) {
                case 'weekly':
                    startDate.setDate(today.getDate() - 7);
                    startDate.setHours(0, 0, 0, 0);
                    periodLabel = 'Last 7 Days';
                    break;
                case 'monthly':
                    startDate.setDate(today.getDate() - 30);
                    startDate.setHours(0, 0, 0, 0);
                    periodLabel = 'Last 30 Days';
                    break;
                case 'halfYear':
                    startDate.setMonth(today.getMonth() - 6);
                    startDate.setHours(0, 0, 0, 0);
                    periodLabel = 'Last 6 Months';
                    break;
                case 'yearly':
                    startDate.setFullYear(today.getFullYear() - 1);
                    startDate.setHours(0, 0, 0, 0);
                    periodLabel = 'Last 12 Months';
                    break;
            }

            // Format dates as YYYY-MM-DD for comparison
            const formatDate = (date) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };

            const startDateStr = formatDate(startDate);
            const todayStr = formatDate(today);

            console.log(`Filtering sales from ${startDateStr} to ${todayStr} for period: ${periodLabel}`);

            // Filter sales in date range and calculate profit
            const sales = (state.sales || []).filter(s => !(s && s.deleted === true)).filter(s => {
                if (!s.date) return false;
                return s.date >= startDateStr && s.date <= todayStr;
            });

            const totalProfit = sales.reduce((sum, s) => sum + (s.profit || 0), 0);
            const incomes = (state.income || []).filter(i => !(i && i.deleted === true)).filter(i => {
                if (!i.date) return false;
                return i.date >= startDateStr && i.date <= todayStr;
            }).filter(isIncomeIncludedInTithing);
            const totalIncomeAmt = incomes.reduce((sum, i) => sum + (i.amount || 0), 0);
            const profitShareBase = totalProfit + totalIncomeAmt;
            const profitShare = profitShareBase > 0 ? profitShareBase * 0.1 : 0;
            const totalSales = sales.length;

            // Group by category
            const byCategory = {};
            sales.forEach(s => {
                const product = state.products.find(p => p.name === s.productName);
                const category = product ? product.category : 'Uncategorized';

                if (!byCategory[category]) {
                    byCategory[category] = { count: 0, profit: 0, profitShare: 0 };
                }
                byCategory[category].count++;
                byCategory[category].profit += (s.profit || 0);
                const p = (s.profit || 0);
                byCategory[category].profitShare += p > 0 ? p * 0.1 : 0;
            });

            // Render content
            let html = `
                <div class="card" style="margin-bottom: 12px;">
                    <h3 style="margin: 0 0 12px 0; font-size: 16px; color: #1976d2;">📊 ${periodLabel} Summary</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <div style="background: linear-gradient(145deg, #1976d2, #0d47a1); padding: 12px; border-radius: 12px; color: white;">
                            <div style="font-size: 11px; opacity: 0.9; margin-bottom: 4px;">Total Sales</div>
                            <div style="font-size: 20px; font-weight: 700;">${totalSales}</div>
                        </div>
                        <div style="background: linear-gradient(145deg, #2e7d32, #1b5e20); padding: 12px; border-radius: 12px; color: white;">
                            <div style="font-size: 11px; opacity: 0.9; margin-bottom: 4px;">Total Profit</div>
                            <div style="font-size: 20px; font-weight: 700;">${formatNumber(totalProfit)} Tsh</div>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 12px;">
                        <div style="background: linear-gradient(145deg, #1976d2, #0d47a1); padding: 12px; border-radius: 12px; color: white;">
                            <div style="font-size: 11px; opacity: 0.9; margin-bottom: 4px;">Total Income</div>
                            <div style="font-size: 20px; font-weight: 700;">${formatNumber(totalIncomeAmt)} Tsh</div>
                        </div>
                        <div style="background: linear-gradient(145deg, #2e7d32, #1b5e20); padding: 12px; border-radius: 12px; color: white;">
                            <div style="font-size: 11px; opacity: 0.9; margin-bottom: 4px;">10% (Profit + Income)</div>
                            <div style="font-size: 20px; font-weight: 700;">${formatNumber(profitShare)} Tsh</div>
                        </div>
                    </div>
                    <div style="margin-top: 12px; padding: 16px; background: linear-gradient(145deg, #2e7d32, #1b5e20); border-radius: 12px; color: white; text-align: center;">
                        <div style="font-size: 12px; opacity: 0.95; margin-bottom: 6px;">💵 10% Profit Analysis</div>
                        <div style="font-size: 28px; font-weight: 800;">${formatNumber(profitShare)} Tsh</div>
                    </div>
                </div>

                <div class="card">
                    <h3 style="margin: 0 0 12px 0; font-size: 16px; color: #667eea;">📑 By Category</h3>
            `;

            if (Object.keys(byCategory).length === 0) {
                html += `<p style="text-align: center; color: #999; padding: 20px;">No sales data for this period</p>`;
            } else {
                Object.keys(byCategory).sort().forEach(category => {
                    const data = byCategory[category];
                    const percentage = totalProfit > 0 ? ((data.profit / totalProfit) * 100).toFixed(1) : 0;

                    html += `
                        <div style="padding: 12px; background: rgba(25, 118, 210, 0.06); border-radius: 8px; margin-bottom: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                                <div style="font-weight: 600; font-size: 14px;">${category}</div>
                                <div style="font-weight: 700; color: #2e7d32;">${formatNumber(data.profitShare)} Tsh</div>
                            </div>
                            <div style="display: flex; justify-content: space-between; font-size: 12px; color: #666; margin-bottom: 4px;">
                                <div>${data.count} sale${data.count !== 1 ? 's' : ''}</div>
                                <div>Profit: ${formatNumber(data.profit)} Tsh</div>
                            </div>
                            <div style="font-size: 11px; color: #999; margin-bottom: 6px;">${percentage}% of total profit</div>
                            <div style="margin-top: 6px; height: 6px; background: rgba(0,0,0,0.1); border-radius: 3px; overflow: hidden;">
                                <div style="height: 100%; background: linear-gradient(90deg, #1976d2, #0d47a1); width: ${percentage}%;"></div>
                            </div>
                        </div>
                    `;
                });
            }

            html += `</div>`;

            const bySource = {};
            incomes.forEach(i => {
                const src = i.source || 'Miscellaneous';
                if (!bySource[src]) {
                    bySource[src] = { count: 0, amount: 0, share: 0 };
                }
                bySource[src].count++;
                bySource[src].amount += (i.amount || 0);
                const a = (i.amount || 0);
                bySource[src].share += a > 0 ? a * 0.1 : 0;
            });

            html += `
                <div class="card" style="margin-top: 12px;">
                    <h3 style="margin: 0 0 12px 0; font-size: 16px; color: #2e7d32;"> Income Analysis</h3>
                    ${Object.keys(bySource).length === 0 ? `<p style="text-align: center; color: #999; padding: 20px;">No income data for this period</p>` : Object.keys(bySource).sort().map(src => {
                const data = bySource[src];
                const pct = totalIncomeAmt > 0 ? ((data.amount / totalIncomeAmt) * 100).toFixed(1) : 0;
                return `
                        <div style="padding: 12px; background: rgba(46, 125, 50, 0.06); border-radius: 8px; margin-bottom: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                                <div style="font-weight: 600; font-size: 14px;">${src}</div>
                                <div style="font-weight: 700; color: #2e7d32;">${formatNumber(data.share)} Tsh</div>
                            </div>
                            <div style="display: flex; justify-content: space-between; font-size: 12px; color: #666; margin-bottom: 4px;">
                                <div>${data.count} item${data.count !== 1 ? 's' : ''}</div>
                                <div>Income: ${formatNumber(data.amount)} Tsh</div>
                            </div>
                            <div style="font-size: 11px; color: #999; margin-bottom: 6px;">${pct}% of total income</div>
                            <div style="margin-top: 6px; height: 6px; background: rgba(0,0,0,0.1); border-radius: 3px; overflow: hidden;">
                                <div style="height: 100%; background: linear-gradient(90deg, #2e7d32, #1b5e20); width: ${pct}%;"></div>
                            </div>
                        </div>`;
            }).join('')}</div>
                </div>`;

            content.innerHTML = html;
        }

        function deleteNoteFromModal() {
            if (state.currentNoteIndex === null) return;
            showConfirm("Delete this note?", async function () {
                try { playDeleteSound(); } catch (e) { }
                const ok = await requirePinForDestructive('delete');
                if (!ok) { showToast('Delete failed: PIN required', 'error'); return; }
                const note = state.notes[state.currentNoteIndex];
                if (note) {
                    try {
                        if (navigator.onLine && syncEnabled && currentUser) {
                            await deleteOne('notes', { timestamp: note.timestamp });
                        } else {
                            await deleteOne('notes', { timestamp: note.timestamp });
                        }
                    } catch { }
                }
                state.notes.splice(state.currentNoteIndex, 1);
                saveData();
                closeNoteModal();
                render();
                showToast("Note deleted", "success");

                // Sync in background
                if (syncEnabled) syncInBackground();
            });
        }


        async function deleteNoteByIndex(index) {
            try { playDeleteSound(); } catch (e) { }
            const ok = await requirePinForDestructive('delete');
            if (!ok) { showToast('Delete failed: PIN required', 'error'); return; }
            const note = state.notes[index];
            if (note) {
                try {
                    if (navigator.onLine && syncEnabled && currentUser) {
                        await deleteOne('notes', { timestamp: note.timestamp });
                    } else {
                        await deleteOne('notes', { timestamp: note.timestamp });
                    }
                } catch { }
            }
            state.notes.splice(index, 1);
            saveData();
            render();
            showToast("Note deleted", "success");

            if (syncEnabled) syncInBackground();
        }

        function togglePrivacy() {
            state.privacyBlurred = !state.privacyBlurred;
            saveData();
            try {
                const btn = document.getElementById('privacyToggleBtn');
                if (btn) { btn.classList.add('bounce'); setTimeout(() => btn.classList.remove('bounce'), 600); }
            } catch { }
            render();
        }

        function toggleDashboardPrivacy() {
            state.dashboardPrivacyBlurred = !state.dashboardPrivacyBlurred;
            saveData();
            try {
                const btn = document.getElementById('dashboardPrivacyToggleBtn');
                if (btn) { btn.classList.add('bounce'); setTimeout(() => btn.classList.remove('bounce'), 600); }
            } catch { }
            render();
        }

        function renderAnalytics() {
            const stats = getStats();
            const netProfit = stats.netProfit;

            return `
    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-bottom: 12px;">
    <div class="stat-card" style="padding: 12px;">
        <div class="stat-label" style="font-size: 10px;">REVENUE</div>
        <div class="stat-value" style="font-size: 16px;cursor:pointer;" onclick="switchTab('dashboard')"> ${formatNumber(stats.totalRevenue)} ${getCurrencySymbol()}</div>
    </div>
    <div class="stat-card" style="padding: 12px;">
        <div class="stat-label" style="font-size: 10px;cursor:pointer;" onclick="switchTab('income')">INCOME</div>
        <div class="stat-value" style="font-size: 16px;"> ${formatNumber(stats.totalIncome)} ${getCurrencySymbol()}</div>
    </div>
    <div class="stat-card" style="background: ${netProfit >= 0 ? '#2e7d32' : '#d32f2f'}; padding: 12px;">
        <div class="stat-label" style="font-size: 10px;">NET PROFIT</div>
        <div class="stat-value" style="font-size: 16px;cursor:pointer;" onclick="switchTab('dashboard')"> ${formatNumber(netProfit)} ${getCurrencySymbol()}</div>
        <div class="stat-subvalue" style="font-size: 10px;">Income: ${formatNumber(stats.totalIncome)} ${getCurrencySymbol()} | Expenses: ${formatNumber(stats.totalExpenses)} ${getCurrencySymbol()}</div>
    </div>
    <div class="stat-card" style="background: #1976d2; padding: 12px;">
        <div class="stat-label" style="font-size: 10px;">TOTAL SALES</div>
        <div class="stat-value" style="font-size: 16px;cursor:pointer;" onclick="switchTab('sales')">${stats.totalSalesCount}</div>
    </div>
    ${(() => {
                    const monthKey = getMonthKey(new Date());
                    const d = new Date(); const monthName = d.toLocaleString(undefined, { month: 'long' }); const year = d.getFullYear();
                    const rec = ensureTithing(monthKey);
                    const due = rec.due || 0;
                    const paid = rec.paid || 0;
                    const remaining = Math.max(0, due - paid);
                    const pct = due > 0 ? Math.min(100, Math.round((paid / due) * 100)) : 0;
                    const status = paid >= due ? 'PAID' : (paid > 0 ? 'PARTIAL' : 'UNPAID');
                    const statusClass = paid >= due ? 'paid' : (paid > 0 ? 'partial' : 'unpaid');
                    const pulseClass = status === 'UNPAID' ? 'tithe-pulse' : '';
                    const dark = String(state.theme || '').toLowerCase() === 'dark';
                    const bg = dark ? '#000' : 'linear-gradient(145deg, #1976d2, #0d47a1)';
                    const textColor = '#fff';
                    const currency = getCurrencySymbol();
                    const displayAmount = paid > 0 ? remaining : due;
                    return `
        <div class=\"stat-card ${pulseClass}\" onclick=\"openTithingModal()\" style=\"background:${bg};padding:12px;\">
            <div class=\"stat-label\" style=\"font-size:10px;display:flex;align-items:center;gap:6px;color:${textColor}\"><span class=\"tithe-icon\">🙏</span>TITHING <span class=\"tithe-status ${statusClass}\">${status}</span></div>
            <div class=\"stat-subvalue\" style=\"font-size:10px;opacity:0.85;color:${textColor}\">Monthly Obligation • ${monthName} ${year}</div>
            <div class=\"stat-value\" style=\"font-size:16px;color:${textColor}\"> ${formatNumber(displayAmount)} ${currency}</div>
            <div class=\"stat-subvalue\" style=\"font-size:10px;color:${textColor}\">Paid: ${formatNumber(paid)} ${currency} • Remaining: ${formatNumber(remaining)} ${currency}</div>
            <div class=\"tithe-progress\"><div class=\"tithe-bar\" style=\"width:${pct}%\"></div></div>
        </div>`;
                })()}
</div>

        <div class="card">
            <h2>Download Reports</h2>
            <button onclick="downloadDailyReportPDF()">📥 DAILY REPORT (PDF)</button>
            <button style="margin-top:8px;" onclick="openReportRangeModal()">📄 General Report (PDF)</button>
            <button style="margin-top:8px;" onclick="openReportRangeModal()">📥 Download Report (Excel)</button>
            <button style="margin-top:8px;" onclick="openTenPercentReportModal()">📄 10% Report (PDF)</button>
            <button style="margin-top:8px;" onclick="openExpensesReportRangeModal()">📄 Expenses Report (PDF)</button>
            <button style="margin-top:8px;" onclick="openIncomeReportRangeModal()">📄 Income Report (PDF)</button>
            ${(() => window.__devToolsEnabled ? `<button style="margin-top:8px;" onclick="downloadAuditCSV()">📥 Audit Log (CSV)</button>` : '')()}
            <button class="btn-secondary" style="margin-top:8px;" onclick="downloadBackup()">💾 Backup All Data</button>
        </div>

    <div class="card">
        <h2>Payment Methods</h2>
        ${getPaymentMethodsHTML()}
    </div>

    <div class="card">
        <h2>Money Transactions Summary</h2>
        ${getTransactionSummaryHTML()}
    </div>

    <div class="card">
        <h2>Category Performance</h2>
        ${getCategoryPerformanceHTML()}
    </div>

    <div class="card">
        <h2>Top Products by Profit</h2>
        ${getTopProductsHTML()}
    </div>

    <div class="card">
        <h2>Analytics Chart</h2>
        <canvas id="analyticsChart"></canvas>
    </div>
    ${(() => {
        if (!window.__devToolsEnabled) return '';
        const logs = (state.auditLogs || []).slice(0, 8);
        const body = logs.length ? logs.map(l => {
            const t = new Date(l.timestamp || l.created_at || Date.now());
            const dt = t.toLocaleString();
            return `
                <div class="item">
                    <div class="item-header">
                        <span class="item-title">${String(l.action || '').toUpperCase()} — ${l.table_name}</span>
                        <span class="badge">${dt}</span>
                    </div>
                    <div class="item-subtitle">${l.item_key || ''}</div>
                </div>`;
        }).join('') : '<p style="text-align: center; color: #666;">No audit logs yet</p>';
        return `<div class="card"><h2>Audit Trail</h2>${body}</div>`;
    })()}
`;
        }

        function downloadAuditCSV() {
            try {
                const logs = state.auditLogs || [];
                const rows = [];
                rows.push(['timestamp', 'created_at', 'action', 'table_name', 'item_key']);
                for (const l of logs) {
                    const ts = Number(l.timestamp || 0);
                    const dt = l.created_at ? new Date(l.created_at).toISOString() : (ts ? new Date(ts).toISOString() : '');
                    rows.push([String(ts), dt, String(l.action || ''), String(l.table_name || ''), String(l.item_key || '')]);
                }
                const csv = rows.map(r => r.map(v => ('"' + String(v).replace(/"/g, '""') + '"')).join(',')).join('\n');
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Audit_${getTodayDateString()}.csv`;
                document.body.appendChild(a);
                a.click();
                setTimeout(() => { try { document.body.removeChild(a); URL.revokeObjectURL(url); } catch { } }, 1000);
                showToast('Audit CSV downloaded', 'success');
            } catch (e) {
                console.error('Audit CSV error:', e);
                showToast('Failed to download audit CSV', 'error');
            }
        }

        function getCategoryPerformanceHTML() {
            const categoryStats = {};
            state.sales.forEach(s => {
                const product = state.products.find(p => p.name === s.productName);
                if (product) {
                    if (!categoryStats[product.category]) {
                        categoryStats[product.category] = { profit: 0, revenue: 0, count: 0 };
                    }
                    categoryStats[product.category].profit += s.profit;
                    categoryStats[product.category].revenue += s.totalPrice;
                    categoryStats[product.category].count += 1;
                }
            });

            const entries = Object.entries(categoryStats)
                .sort((a, b) => b[1].profit - a[1].profit)
                .slice(0, 2);

            if (entries.length === 0) {
                return '<p style="text-align: center; color: #666;">No category data yet</p>';
            }

            return entries.map(([category, data]) => `
                <div class="item">
                    <div class="item-header">
                        <span class="item-title">${category}</span>
                        <span style="color: #2e7d32; font-weight: 700;"> ${formatNumber(data.profit)} ${getCurrencySymbol()}</span>
                    </div>
                    <div class="item-subtitle">
                        Revenue: ${formatNumber(data.revenue)} ${getCurrencySymbol()} | ${data.count} sales
                    </div>
                </div>
            `).join('');
        }

        function getTopProductsHTML() {
            const productStats = {};
            state.sales.forEach(s => {
                if (!productStats[s.productName]) {
                    productStats[s.productName] = { profit: 0, quantity: 0, revenue: 0 };
                }
                productStats[s.productName].profit += s.profit;
                productStats[s.productName].quantity += s.quantity;
                productStats[s.productName].revenue += s.totalPrice;
            });

            const entries = Object.entries(productStats)
                .sort((a, b) => b[1].profit - a[1].profit)
                .slice(0, 2);

            if (entries.length === 0) {
                return '<p style="text-align: center; color: #666;">No product data yet</p>';
            }

            return entries.map(([product, data], index) => `
                <div class="item">
                    <div class="item-header">
                        <span class="item-title">${index + 1}. ${product}</span>
                        <span style="color: #2e7d32; font-weight: 700;"> ${formatNumber(data.profit)} ${getCurrencySymbol()}</span>
                    </div>
                    <div class="item-subtitle">
                        Sold: ${data.quantity} units | Revenue: ${formatNumber(data.revenue)} ${getCurrencySymbol()}
                    </div>
                </div>
            `).join('');
        }

        function getPaymentMethodsHTML() {
            const paymentTotals = {};
            state.sales.forEach(s => {
                paymentTotals[s.payment] = (paymentTotals[s.payment] || 0) + s.totalPrice;
            });
            if (Object.keys(paymentTotals).length === 0) {
                return '<p style="text-align: center; color: #666;">No payment data yet</p>';
            }

            const entries = Object.entries(paymentTotals)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 2);
            return entries.map(([method, total]) => `
                <div class="item">
                    <div style="display: flex; justify-content: space-between;">
                        <span class="item-title">${method}</span>
                        <span style="font-weight: 700;"> ${formatNumber(total)} ${getCurrencySymbol()}</span>
                    </div>
                </div>
            `).join('');
        }

        function getTransactionSummaryHTML() {
            const transactionTotals = {
                mpesa: { deposit: 0, withdrawal: 0 },
                crdb: { deposit: 0, withdrawal: 0 },
                nmb: { deposit: 0, withdrawal: 0 },
                airtel: { deposit: 0, withdrawal: 0 },
                halopesa: { deposit: 0, withdrawal: 0 },
                yas: { deposit: 0, withdrawal: 0 }
            };

            (state.transactions || []).forEach(t => {
                if (transactionTotals[t.channel]) {
                    transactionTotals[t.channel][t.type] += t.amount || 0;
                }
            });

            const channelLabels = {
                mpesa: 'M-Pesa',
                crdb: 'CRDB',
                nmb: 'NMB',
                airtel: 'Airtel Money',
                halopesa: 'Halopesa',
                yas: 'Yas Tanzania'
            };

            const channelColors = {
                mpesa: '#d32f2f',
                crdb: '#2e7d32',
                nmb: '#e65100',
                airtel: '#b71c1c',
                halopesa: '#fdd835',
                yas: '#0d47a1'
            };

            const hasTransactions = Object.values(transactionTotals).some(val => val.deposit > 0 || val.withdrawal > 0);

            if (!hasTransactions) {
                return '<p style="text-align: center; color: #666;">No transaction data yet</p>';
            }

            const entries = Object.entries(transactionTotals)
                .filter(([channel, amounts]) => amounts.deposit > 0 || amounts.withdrawal > 0)
                .map(([channel, amounts]) => ([channel, amounts, (amounts.deposit + amounts.withdrawal)]))
                .sort((a, b) => b[2] - a[2])
                .slice(0, 2);

            return entries.map(([channel, amounts]) => `
                <div class="item">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                        <span style="width: 12px; height: 12px; border-radius: 50%; background: ${channelColors[channel]};"></span>
                        <span class="item-title">${channelLabels[channel]}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-size: 13px; color: #666;">
                        <span>Deposits: <strong style="color: #2e7d32;"> ${formatNumber(amounts.deposit)} ${getCurrencySymbol()}</strong></span>
                        <span>Withdrawals: <strong style="color: #d32f2f;"> ${formatNumber(amounts.withdrawal)} ${getCurrencySymbol()}</strong></span>
                    </div>
                    <div style="margin-top: 4px; font-weight: 600;">
                        Net: <span style="color: ${amounts.deposit - amounts.withdrawal >= 0 ? '#2e7d32' : '#d32f2f'};">
                            ${amounts.deposit - amounts.withdrawal >= 0 ? '+' : ''} ${formatNumber(amounts.deposit - amounts.withdrawal)} ${getCurrencySymbol()}
                </span>
            </div>
        </div>
    `).join('');
        }

        function createAnalyticsChart() {
            setTimeout(async () => {
                try { if (window.loadLibrary) await loadLibrary('chart'); } catch { }
                const canvas = document.getElementById('analyticsChart');
                if (!canvas) return;

                if (chartInstance) {
                    chartInstance.destroy();
                }

                const stats = getStats();
                const revenue = stats.totalRevenue;
                const income = stats.totalIncome;
                const expenses = stats.totalExpenses;
                const profit = stats.totalProfit;
                const loans = (state.loans || []).slice();
                const loanRemaining = (ln) => {
                    const paid = (ln.payments || []).reduce((sum, p) => sum + (Number(p.amount) || 0), 0);
                    return Math.max(0, (Number(ln.amount) || 0) - paid);
                };
                const owedToMe = loans.filter(l => String(l.type || '').toLowerCase() === 'given')
                    .reduce((sum, l) => sum + loanRemaining(l), 0);
                const iOwe = loans.filter(l => String(l.type || '').toLowerCase() === 'taken')
                    .reduce((sum, l) => sum + loanRemaining(l), 0);

                const ctx = canvas.getContext('2d');
                chartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Revenue', 'Income', 'Expenses', 'Profit', 'Owed To Me', 'I Owe'],
                        datasets: [{
                            label: 'Amount (' + getCurrencySymbol() + ')',
                            data: [
                                revenue,
                                income,
                                expenses,
                                profit,
                                owedToMe,
                                iOwe
                            ],
                            backgroundColor: [
                                '#1976d2',
                                '#d32f2f',
                                '#fbc02d',
                                '#0d47a1',
                                '#2e7d32',
                                '#d84315'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        const label = context.dataset.label || '';
                                        const value = context.parsed.y || 0;
                                        return label + ': ' + formatNumber(value) + ' ' + getCurrencySymbol();
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function (value) { return formatNumber(value) + ' ' + getCurrencySymbol(); }
                                }
                            }
                        }
                    }
                });
            }, 100);
        }
        async function downloadSalesReportPDF(startDate = null, endDate = null, mode = (window.reportMode || 'stacked')) {
            playTapSound();
            hapticShort();
            try { if (window.loadLibrary) await loadLibrary('jspdf'); } catch {}
            await ensureLogoReady();
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ unit: 'pt', format: 'a4' });
            const pageWidth = 595.28;
            const leftMargin = 50;
            const rightMargin = 24;
            const margin = leftMargin;
            const usableWidth = pageWidth - leftMargin - rightMargin;
            let y = 50;
            const centerX = pageWidth / 2;

            // Header
            doc.setFillColor(240, 240, 240);
            doc.rect(0, 0, pageWidth, 100, 'F');

            doc.setTextColor(0, 0, 0);
            doc.setFontSize(24);
            doc.setFont(undefined, 'bold');
            const profile = getUserProfileData();
            doc.text(profile.businessName, centerX, 45, { align: 'center' });

            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            const contactLine = buildProfileContactLine(profile);
            if (contactLine) doc.text(contactLine, centerX, 70, { align: 'center' });
            doc.setFontSize(10);
            doc.setTextColor(0, 0, 0);
            doc.setFont(undefined, 'normal');
            const taxLine = buildProfileTaxLine(profile);
            if (taxLine) doc.text(taxLine, centerX, 90, { align: 'center' });

            doc.setDrawColor(150, 150, 150);
            doc.setLineWidth(3);
            doc.line(margin, 100, pageWidth - rightMargin, 100);

            y = 120;
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(18);
            doc.setFont(undefined, 'bold');
            doc.text("Financial Report", margin, y);

            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.setTextColor(100, 100, 100);
            const rangeLabel = (startDate || endDate) ? `Range: ${startDate || '...'} to ${endDate || '...'}` : 'All data';
            doc.text(`Generated: ${getTodayDateString()} | ${rangeLabel}`, margin, y + 20);
            y += 50;

            function drawTable(headers, rows, startY) {
                const colCount = headers.length;
                const colWidth = usableWidth / colCount;
                let curY = startY;
                const headerH = 22;

                doc.setFillColor(100, 100, 100);
                doc.roundedRect(margin, curY, usableWidth, headerH, 3, 3, 'F');

                doc.setTextColor(255, 255, 255);
                doc.setFont(undefined, 'bold');
                doc.setFontSize(10);
                for (let i = 0; i < colCount; i++) {
                    const txtX = margin + i * colWidth + 8;
                    doc.text(String(headers[i]), txtX, curY + 15);
                }
                curY += headerH + 2;

                doc.setFont(undefined, 'normal');
                doc.setFontSize(9);
                for (let r = 0; r < rows.length; r++) {
                    let maxLines = 1;
                    const cellLines = [];
                    for (let c = 0; c < colCount; c++) {
                        const txt = rows[r][c] === null || rows[r][c] === undefined ? '' : String(rows[r][c]);
                        const lines = doc.splitTextToSize(txt, colWidth - 16);
                        cellLines.push(lines);
                        if (lines.length > maxLines) maxLines = lines.length;
                    }
                    const lineH = 10;
                    const rowH = maxLines * lineH + 8;

                    if (curY + rowH > 750) {
                        doc.addPage();
                        curY = margin;
                    }

                    if (r % 2 === 0) {
                        doc.setFillColor(248, 249, 250);
                        doc.roundedRect(margin, curY, usableWidth, rowH, 2, 2, 'F');
                    }

                    doc.setTextColor(40, 40, 40);
                    for (let c = 0; c < colCount; c++) {
                        const txtX = margin + c * colWidth + 8;
                        const lines = cellLines[c];
                        for (let li = 0; li < lines.length; li++) {
                            doc.text(lines[li], txtX, curY + 15 + li * lineH);
                        }
                    }
                    curY += rowH;
                }
                return curY + 20;
            }

            // Sales
            const salesHeaders = ["Date", (mode === 'stacked' ? "Category" : "Product"), "Customer", "Qty", "Price", "Profit"];
            const inRange = (d) => {
                if (!startDate && !endDate) return true;
                const ts = new Date(d).getTime();
                const from = startDate ? new Date(startDate).getTime() : -Infinity;
                const to = endDate ? new Date(endDate).getTime() : Infinity;
                return ts >= from && ts <= to;
            };
            const salesData = (state.sales || []).filter(s => inRange(s.date));
            let salesRows;
            if (mode === 'stacked') {
                const byCat = {};
                for (const s of salesData) {
                    const key = String(s.category || 'Uncategorized');
                    if (!byCat[key]) byCat[key] = { qty: 0, price: 0, profit: 0 };
                    byCat[key].qty += (s.quantity || 0);
                    byCat[key].price += (s.totalPrice || 0);
                    byCat[key].profit += (s.profit || 0);
                }
                salesRows = Object.keys(byCat).sort((a,b)=>String(a).localeCompare(String(b))).map(cat => [
                    "-", cat, "-", byCat[cat].qty, formatNumber(byCat[cat].price) + ' ' + getCurrencySymbol(), formatNumber(byCat[cat].profit) + ' ' + getCurrencySymbol()
                ]);
            } else {
                salesRows = salesData.map(s => [
                    s.date, s.productName, s.customer, s.quantity, formatNumber(s.totalPrice) + ' ' + getCurrencySymbol(), formatNumber(s.profit) + ' ' + getCurrencySymbol()
                ]);
            }
            if (salesRows.length > 0) {
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(0, 0, 0);
                doc.text("Sales Records", margin, y);
                y += 15;
                y = drawTable(salesHeaders, salesRows, y);
                const totalQty = (mode === 'stacked') ? salesRows.reduce((sum, r) => sum + (Number(r[3]) || 0), 0) : salesData.reduce((sum, s) => sum + (s.quantity || 0), 0);
                const totalPrice = (mode === 'stacked') ? salesRows.reduce((sum, r) => sum + (parseFloat(String(r[4]).replace(/[^\d.]/g,'')) || 0), 0) : salesData.reduce((sum, s) => sum + (s.totalPrice || 0), 0);
                const totalProfit = (mode === 'stacked') ? salesRows.reduce((sum, r) => sum + (parseFloat(String(r[5]).replace(/[^\d.]/g,'')) || 0), 0) : salesData.reduce((sum, s) => sum + (s.profit || 0), 0);
                const colCount = salesHeaders.length;
                const colWidth = usableWidth / colCount;
                const rowHeight = 22;
                if (y + rowHeight > 750) { doc.addPage(); y = margin; }
                doc.setFillColor(245, 245, 245);
                doc.setDrawColor(180, 180, 180);
                doc.setLineWidth(0.75);
                doc.roundedRect(margin, y, usableWidth, rowHeight, 2, 2, 'FD');
                doc.setTextColor(40, 40, 40);
                doc.setFont(undefined, 'bold');
                doc.setFontSize(10);
                doc.text('Totals', margin + 2 * colWidth + 8, y + 15);
                doc.text(String(totalQty), margin + 3 * colWidth + 8, y + 15);
                doc.text(formatNumber(totalProfit) + ' ' + getCurrencySymbol(), margin + 5 * colWidth + 8, y + 15);
                y += rowHeight + 20;
            }

            // Expenses
            // Group inventory purchases per period, keep other expenses as is
            const groups = {};
            (state.expenses || []).filter(e => inRange(e.date)).forEach(e => {
                if (e.category === 'Inventory Purchase' && /^Period \d+/.test(e.comment || '')) {
                    const key = e.comment;
                    groups[key] = groups[key] || { amount: 0, date: e.date, time: e.time };
                    groups[key].amount += (e.amount || 0);
                }
            });
            const periodRows = Object.keys(groups).sort((a, b) => {
                const na = parseInt(a.replace('Period ', ''), 10);
                const nb = parseInt(b.replace('Period ', ''), 10);
                return na - nb;
            }).map(key => [groups[key].date, key, 'Inventory Purchase', formatNumber(groups[key].amount) + ' ' + getCurrencySymbol()]);
            let otherRows;
            if (mode === 'stacked') {
                const byCatE = {};
                (state.expenses || []).filter(e => inRange(e.date) && e.category !== 'Inventory Purchase').forEach(e => {
                    const key = String(e.category || 'Uncategorized');
                    byCatE[key] = (byCatE[key] || 0) + (e.amount || 0);
                });
                otherRows = Object.keys(byCatE).sort((a,b)=>String(a).localeCompare(String(b))).map(cat => ["-", "-", cat, formatNumber(byCatE[cat]) + ' ' + getCurrencySymbol()]);
            } else {
                otherRows = (state.expenses || []).filter(e => inRange(e.date) && e.category !== 'Inventory Purchase').map(e => [
                    e.date, e.description, e.category, formatNumber(e.amount || 0) + ' ' + getCurrencySymbol()
                ]);
            }
            const expHeaders = ["Date", "Description", "Category", "Amount"];
            const expRows = [...otherRows, ...periodRows];
            if (expRows.length > 0) {
                if (y > 650) { doc.addPage(); y = margin; }
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text("Expenses", margin, y);
                y += 15;
                y = drawTable(expHeaders, expRows, y);
                const totalExp = (state.expenses || []).filter(e => inRange(e.date)).reduce((sum, e) => sum + (e.amount || 0), 0);
                const colCountE = expHeaders.length;
                const colWidthE = usableWidth / colCountE;
                const rowHeightE = 22;
                if (y + rowHeightE > 750) { doc.addPage(); y = margin; }
                doc.setFillColor(245, 245, 245);
                doc.setDrawColor(180, 180, 180);
                doc.setLineWidth(0.75);
                doc.roundedRect(margin, y, usableWidth, rowHeightE, 2, 2, 'FD');
                doc.setTextColor(40, 40, 40);
                doc.setFont(undefined, 'bold');
                doc.setFontSize(10);
                doc.text('Total', margin + 2 * colWidthE + 8, y + 15);
                doc.text(formatNumber(totalExp) + ' ' + getCurrencySymbol(), margin + 3 * colWidthE + 8, y + 15);
                y += rowHeightE + 20;
            }

            // Income
            const incHeaders = ["Date", "Source", "Payment", "Amount"];
            let incomeRows;
            if (mode === 'stacked') {
                const bySrc = {};
                (state.income || []).filter(i => inRange(i.date)).forEach(i => {
                    const key = String(i.source || 'Miscellaneous');
                    bySrc[key] = (bySrc[key] || 0) + (i.amount || 0);
                });
                incomeRows = Object.keys(bySrc).sort((a,b)=>String(a).localeCompare(String(b))).map(src => ["-", src, "-", formatNumber(bySrc[src]) + ' ' + getCurrencySymbol()]);
            } else {
                incomeRows = (state.income || []).filter(i => inRange(i.date)).map(i => [i.date, i.source, i.payment || "-", formatNumber(i.amount || 0) + ' ' + getCurrencySymbol()]);
            }
            if (incomeRows.length > 0) {
                if (y > 650) { doc.addPage(); y = margin; }
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text("Income", margin, y);
                y += 15;
                y = drawTable(incHeaders, incomeRows, y);
                const totalInc = (state.income || []).filter(i => inRange(i.date)).reduce((sum, i) => sum + (i.amount || 0), 0);
                const colCountI = incHeaders.length;
                const colWidthI = usableWidth / colCountI;
                const rowHeightI = 22;
                if (y + rowHeightI > 750) { doc.addPage(); y = margin; }
                doc.setFillColor(245, 245, 245);
                doc.setDrawColor(180, 180, 180);
                doc.setLineWidth(0.75);
                doc.roundedRect(margin, y, usableWidth, rowHeightI, 2, 2, 'FD');
                doc.setTextColor(40, 40, 40);
                doc.setFont(undefined, 'bold');
                doc.setFontSize(10);
                doc.text('Total', margin + 2 * colWidthI + 8, y + 15);
                doc.text(formatNumber(totalInc) + ' ' + getCurrencySymbol(), margin + 3 * colWidthI + 8, y + 15);
                y += rowHeightI + 20;
            }

            // Commissions
            const comHeaders = ["Date", "Channel", "Target", "Amount"];
            const commissionRows = (state.commissions || []).filter(c => inRange(c.date)).map(c => [c.date, c.channel.toUpperCase(), c.target === 'cash' ? 'Cash' : 'Account', formatNumber(c.amount || 0) + ' ' + getCurrencySymbol()]);
            if (commissionRows.length > 0) {
                if (y > 650) { doc.addPage(); y = margin; }
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text("Commissions", margin, y);
                y += 15;
                y = drawTable(comHeaders, commissionRows, y);
                const totalCom = (state.commissions || []).filter(c => inRange(c.date)).reduce((sum, c) => sum + (c.amount || 0), 0);
                const colCountC = comHeaders.length;
                const colWidthC = usableWidth / colCountC;
                const rowHeightC = 22;
                if (y + rowHeightC > 750) { doc.addPage(); y = margin; }
                doc.setFillColor(245, 245, 245);
                doc.setDrawColor(180, 180, 180);
                doc.setLineWidth(0.75);
                doc.roundedRect(margin, y, usableWidth, rowHeightC, 2, 2, 'FD');
                doc.setTextColor(40, 40, 40);
                doc.setFont(undefined, 'bold');
                doc.setFontSize(10);
                doc.text('Total', margin + 2 * colWidthC + 8, y + 15);
                doc.text(formatNumber(totalCom) + ' ' + getCurrencySymbol(), margin + 3 * colWidthC + 8, y + 15);
                y += rowHeightC + 20;
            }

            // Transactions
            const transHeaders = ["Channel", "Txn Type", "Date", "Customer", "Amount"];
            let transRows;
            if (mode === 'stacked') {
                const byKey = {};
                (state.transactions || []).filter(t => inRange(t.date)).forEach(t => {
                    const key = `${String(t.channel||'').toUpperCase()}|${String(t.type||'').toUpperCase()}`;
                    byKey[key] = (byKey[key] || 0) + (t.amount || 0);
                });
                transRows = Object.keys(byKey).sort().map(k => {
                    const [ch, tp] = k.split('|');
                    return [ch, tp, "-", "-", formatNumber(byKey[k]) + ' ' + getCurrencySymbol()];
                });
            } else {
                transRows = (state.transactions || []).filter(t => inRange(t.date)).map(t => [
                    (t.channel || '').toUpperCase(), (t.type || '').toUpperCase(), t.date, t.customerName || 'N/A', formatNumber(t.amount || 0) + ' ' + getCurrencySymbol()
                ]);
            }
            if (transRows.length > 0) {
                if (y > 650) { doc.addPage(); y = margin; }
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text("Money Transactions", margin, y);
                y += 15;
                y = drawTable(transHeaders, transRows, y);
            }

            const floatKeys = Object.keys(state.transactionFloats || {});
            if (floatKeys.length > 0) {
                if (y > 650) { doc.addPage(); y = margin; }
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text("Float Balances", margin, y);
                y += 15;
                const fHeaders = ["Channel", "Init Acc", "Init Cash", "Curr Acc", "Curr Cash", "Total"];
                const fRows = floatKeys.map(ch => {
                    const fd = state.transactionFloats[ch] || { initialAccount: 0, initialCash: 0, currentAccount: 0, currentCash: 0 };
                    const diff = (fd.currentCash || 0) - (fd.initialCash || 0);
                    return [
                        String(ch).toUpperCase(),
                        formatNumber(fd.initialAccount || 0) + ' ' + getCurrencySymbol(),
                        formatNumber(fd.initialCash || 0) + ' ' + getCurrencySymbol(),
                        formatNumber(fd.currentAccount || 0) + ' ' + getCurrencySymbol(),
                        formatNumber(fd.currentCash || 0) + ' ' + getCurrencySymbol(),
                        formatNumber(((fd.currentAccount || 0) + (fd.currentCash || 0))) + ' ' + getCurrencySymbol()
                    ];
                });
                y = drawTable(fHeaders, fRows, y);
            }

            const assetsHeaders = ["Date", "Name", "Cost", "Source", "Description"];
            const assetsRows = (state.assets || []).filter(a => inRange(a.date || a.purchaseDate || '')).map(a => [
                a.date || a.purchaseDate || '', a.name || '', formatNumber(a.cost || 0) + ' ' + getCurrencySymbol(), String(a.moneySource || 'business'), String(a.description || '')
            ]);
            if (assetsRows.length > 0) {
                if (y > 650) { doc.addPage(); y = margin; }
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text("Assets", margin, y);
                y += 15;
                y = drawTable(assetsHeaders, assetsRows, y);
                const totalAssets = (state.assets || []).filter(a => inRange(a.date || a.purchaseDate || '')).reduce((sum, a) => sum + (a.cost || 0), 0);
                const cc = assetsHeaders.length; const cw = usableWidth / cc; const rh = 22;
                if (y + rh > 750) { doc.addPage(); y = margin; }
                doc.setFillColor(245, 245, 245); doc.setDrawColor(180, 180, 180); doc.setLineWidth(0.75);
                doc.roundedRect(margin, y, usableWidth, rh, 2, 2, 'FD'); doc.setTextColor(40, 40, 40); doc.setFont(undefined, 'bold'); doc.setFontSize(10);
                doc.text('Total Cost', margin + 2 * cw + 8, y + 15);
                doc.text(formatNumber(totalAssets) + ' ' + getCurrencySymbol(), margin + 3 * cw + 8, y + 15);
                y += rh + 20;
            }

            const maintHeaders = ["Date", "Asset", "Amount", "Source", "Description"];
            const maintRows = (state.maintenance || []).filter(mn => inRange(mn.date)).map(mn => [
                mn.date || '', mn.assetName || '', formatNumber(mn.amount || 0) + ' ' + getCurrencySymbol(), String(mn.moneySource || 'business'), String(mn.description || '')
            ]);
            if (maintRows.length > 0) {
                if (y > 650) { doc.addPage(); y = margin; }
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text("Maintenance", margin, y);
                y += 15;
                y = drawTable(maintHeaders, maintRows, y);
                const totalMaint = (state.maintenance || []).filter(mn => inRange(mn.date)).reduce((sum, mn) => sum + (mn.amount || 0), 0);
                const cc = maintHeaders.length; const cw = usableWidth / cc; const rh = 22;
                if (y + rh > 750) { doc.addPage(); y = margin; }
                doc.setFillColor(245, 245, 245); doc.setDrawColor(180, 180, 180); doc.setLineWidth(0.75);
                doc.roundedRect(margin, y, usableWidth, rh, 2, 2, 'FD'); doc.setTextColor(40, 40, 40); doc.setFont(undefined, 'bold'); doc.setFontSize(10);
                doc.text('Total', margin + 2 * cw + 8, y + 15);
                doc.text(formatNumber(totalMaint) + ' ' + getCurrencySymbol(), margin + 3 * cw + 8, y + 15);
                y += rh + 20;
            }

            const loansHeaders = ["Date", "Type", "Amount", "Source", "Status"];
            const loansRows = (state.loans || []).filter(ln => inRange(ln.date)).map(ln => {
                const paid = (Array.isArray(ln.payments) ? ln.payments.reduce((sum, p) => sum + (p.amount || 0), 0) : 0);
                const remaining = Math.max(0, (ln.amount || 0) - paid);
                const status = remaining <= 0 ? 'PAID OFF' : ('Remaining: ' + formatNumber(remaining) + ' ' + getCurrencySymbol());
                return [ln.date || '', String(ln.type || '').toUpperCase(), formatNumber(ln.amount || 0) + ' ' + getCurrencySymbol(), String(ln.moneySource || ln.money_source || 'business'), status];
            });
            if (loansRows.length > 0) {
                if (y > 650) { doc.addPage(); y = margin; }
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text("Loans", margin, y);
                y += 15;
                y = drawTable(loansHeaders, loansRows, y);
            }

            const loanPayHeaders = ["Date", "Type", "Amount", "Source"];
            const loanPayRows = (state.loans || []).flatMap(ln => (ln.payments || []).filter(p => inRange(p.date)).map(p => [p.date || '', String(ln.type || '').toUpperCase(), formatNumber(p.amount || 0) + ' ' + getCurrencySymbol(), String(p.source || '')]));
            if (loanPayRows.length > 0) {
                if (y > 650) { doc.addPage(); y = margin; }
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text("Loan Payments", margin, y);
                y += 15;
                y = drawTable(loanPayHeaders, loanPayRows, y);
                const totalLoanPay = loanPayRows.reduce((sum, r) => {
                    const amtTxt = r[2] || '0'; const n = parseFloat(String(amtTxt).replace(/[^\d.]/g, '')) || 0; return sum + n;
                }, 0);
                const cc = loanPayHeaders.length; const cw = usableWidth / cc; const rh = 22;
                if (y + rh > 750) { doc.addPage(); y = margin; }
                doc.setFillColor(245, 245, 245); doc.setDrawColor(180, 180, 180); doc.setLineWidth(0.75);
                doc.roundedRect(margin, y, usableWidth, rh, 2, 2, 'FD'); doc.setTextColor(40, 40, 40); doc.setFont(undefined, 'bold'); doc.setFontSize(10);
                doc.text('Total', margin + 2 * cw + 8, y + 15);
                doc.text(formatNumber(totalLoanPay) + ' ' + getCurrencySymbol(), margin + 3 * cw + 8, y + 15);
                y += rh + 20;
            }

            const invpHeaders = ["Date", "Period", "Item", "Qty", "Total Cost"];
            let invpRows;
            if (mode === 'stacked') {
                const byItem = {};
                (state.inventoryPurchases || []).filter(p => inRange(p.date || '')).forEach(p => {
                    const key = String(p.itemName || 'Item');
                    if (!byItem[key]) byItem[key] = { qty: 0, cost: 0 };
                    byItem[key].qty += (p.quantity || 0);
                    byItem[key].cost += ((p.totalCost || p.buyingPrice || 0) || 0);
                });
                invpRows = Object.keys(byItem).sort((a,b)=>String(a).localeCompare(String(b))).map(name => [
                    "-", "-", name, String(byItem[name].qty), formatNumber(byItem[name].cost) + ' ' + getCurrencySymbol()
                ]);
            } else {
                invpRows = (state.inventoryPurchases || []).filter(p => inRange(p.date || '')).map(p => [
                    p.date || '', String(p.cycleNumber || ''), p.itemName || '', String(p.quantity || 0), formatNumber((p.totalCost || p.buyingPrice || 0)) + ' ' + getCurrencySymbol()
                ]);
            }
            if (invpRows.length > 0) {
                if (y > 650) { doc.addPage(); y = margin; }
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text("Inventory Purchases", margin, y);
                y += 15;
                y = drawTable(invpHeaders, invpRows, y);
                const totalInvp = invpRows.reduce((sum, r) => { const n = parseFloat(String(r[4]).replace(/[^\d.]/g, '')) || 0; return sum + n; }, 0);
                const cc = invpHeaders.length; const cw = usableWidth / cc; const rh = 22;
                if (y + rh > 750) { doc.addPage(); y = margin; }
                doc.setFillColor(245, 245, 245); doc.setDrawColor(180, 180, 180); doc.setLineWidth(0.75);
                doc.roundedRect(margin, y, usableWidth, rh, 2, 2, 'FD'); doc.setTextColor(40, 40, 40); doc.setFont(undefined, 'bold'); doc.setFontSize(10);
                doc.text('Total', margin + 3 * cw + 8, y + 15);
                doc.text(formatNumber(totalInvp) + ' ' + getCurrencySymbol(), margin + 4 * cw + 8, y + 15);
                y += rh + 20;
            }

            // Chart
            if (chartInstance) {
                doc.addPage();
                doc.setFontSize(16);
                doc.setFont(undefined, 'bold');
                doc.text("Analytics Overview", margin, 50);

                const chartImage = chartInstance.toBase64Image();
                const grayImage = await toGrayscaleDataURL(chartImage);
                doc.addImage(grayImage || chartImage, 'PNG', margin, 70, usableWidth, 250);
            }

            // Footer
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFillColor(240, 240, 240);
                doc.rect(0, 792 - 30, pageWidth, 30, 'F');
                doc.setTextColor(100, 100, 100);
                doc.setFontSize(9);
                doc.text(`Page ${i} of ${pageCount}`, margin, 792 - 11);
                doc.text(`The Ultimate Business Achitecture (TUBA) © ${new Date().getFullYear()}`, pageWidth - rightMargin, 792 - 8, { align: 'right' });
            }

            downloadPDFSafe(doc, `Financial_Report_${getTodayDateString()}.pdf`);
            showToast("PDF ready", "success");
        }

        async function downloadDailyReportPDF() {
            playTapSound();
            hapticShort();
            try { if (window.loadLibrary) await loadLibrary('jspdf'); } catch {}
            await ensureLogoReady();
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ unit: 'pt', format: 'a4' });
            const pageWidth = 595.28;
            const leftMargin = 50;
            const rightMargin = 24;
            const margin = leftMargin;
            const usableWidth = pageWidth - leftMargin - rightMargin;
            let y = 50;
            const centerX = pageWidth / 2;

            const today = getTodayDateString();
            const todaySales = state.sales.filter(s => s.date === today);
            const todayIncome = (state.income || []).filter(i => i.date === today);
            const todayCommissions = (state.commissions || []).filter(c => c.date === today);
            const todayTransactions = state.transactions.filter(t => t.date === today);

            // Calculate today's stats
            const todayRevenue = todaySales.reduce((sum, s) => sum + (s.totalPrice || 0), 0);
            const todayProfit = todaySales.reduce((sum, s) => sum + (s.profit || 0), 0);
            const todayExpensesTotal = (state.expenses || []).filter(e => e.date === today).reduce((sum, e) => sum + (e.amount || 0), 0);
            const todayIncomeTotal = todayIncome.reduce((sum, i) => sum + (i.amount || 0), 0);
            const todayCommissionTotal = todayCommissions.reduce((sum, c) => sum + (c.amount || 0), 0);
            const todayNetProfit = (todayProfit + todayIncomeTotal - todayExpensesTotal);

            // Header
            doc.setFillColor(240, 240, 240);
            doc.rect(0, 0, pageWidth, 100, 'F');

            doc.setTextColor(0, 0, 0);
            doc.setFontSize(24);
            doc.setFont(undefined, 'bold');

            const profile = getUserProfileData();
            doc.text(profile.businessName, centerX, 45, { align: 'center' });

            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            const contactLine = buildProfileContactLine(profile);
            if (contactLine) doc.text(contactLine, centerX, 70, { align: 'center' });
            doc.setFontSize(10);
            doc.setTextColor(0, 0, 0);
            doc.setFont(undefined, 'normal');
            const taxLine = buildProfileTaxLine(profile);
            if (taxLine) doc.text(taxLine, centerX, 90, { align: 'center' });

            doc.setDrawColor(150, 150, 150);
            doc.setLineWidth(3);
            doc.line(margin, 100, pageWidth - rightMargin, 100);

            y = 120;
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(18);
            doc.setFont(undefined, 'bold');
            doc.text("Daily Report", margin, y);

            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            doc.setTextColor(100, 100, 100);
            doc.text(`Date: ${today}`, margin, y + 20);
            y += 50;

            // Summary Box
            doc.setFillColor(240, 240, 240);
            doc.roundedRect(margin, y, usableWidth, 100, 5, 5, 'F');
            doc.setDrawColor(180, 180, 180);
            doc.setLineWidth(2);
            doc.roundedRect(margin, y, usableWidth, 100, 5, 5, 'S');

            doc.setTextColor(0, 0, 0);
            doc.setFontSize(11);
            doc.setFont(undefined, 'bold');
            doc.text("TODAY'S SUMMARY", margin + 15, y + 20);

            doc.setFont(undefined, 'normal');
            doc.setFontSize(10);
            const leftX = margin + 15;
            const rightX = margin + (usableWidth / 2) + 15;
            doc.text(`Total Sales: ${todaySales.length}`, leftX, y + 40);
            doc.text(`Revenue: ${formatNumber(todayRevenue)} ${getCurrencySymbol()}`, leftX, y + 55);
            doc.text(`Profit: ${formatNumber(todayProfit)} ${getCurrencySymbol()}`, leftX, y + 70);
            doc.text(`Income: ${formatNumber(todayIncomeTotal)} ${getCurrencySymbol()}`, rightX, y + 40);
            doc.text(`Expenses: ${formatNumber(todayExpensesTotal)} ${getCurrencySymbol()}`, rightX, y + 55);
            doc.text(`Net Profit: ${formatNumber(todayNetProfit)} ${getCurrencySymbol()}`, rightX, y + 70);

            doc.setTextColor(80, 80, 80);
            doc.setFont(undefined, 'bold');
            doc.setFontSize(10);
            doc.text(`Status: ${todayNetProfit >= 0 ? 'Profitable ✓' : 'Loss ✗'}`, margin + 200, y + 95);

            y += 120;

            function drawTable(headers, rows, startY) {
                const colCount = headers.length;
                const colWidth = usableWidth / colCount;
                let curY = startY;
                const rowHeight = 22;

                doc.setFillColor(100, 100, 100);
                doc.roundedRect(margin, curY, usableWidth, rowHeight, 3, 3, 'F');

                doc.setTextColor(255, 255, 255);
                doc.setFont(undefined, 'bold');
                doc.setFontSize(10);
                for (let i = 0; i < colCount; i++) {
                    const txtX = margin + i * colWidth + 8;
                    doc.text(String(headers[i]), txtX, curY + 15);
                }
                curY += rowHeight + 2;

                doc.setFont(undefined, 'normal');
                doc.setFontSize(9);
                for (let r = 0; r < rows.length; r++) {
                    if (curY + rowHeight > 750) {
                        doc.addPage();
                        curY = margin;
                    }

                    if (r % 2 === 0) {
                        doc.setFillColor(248, 249, 250);
                        doc.roundedRect(margin, curY, usableWidth, rowHeight, 2, 2, 'F');
                    }

                    doc.setTextColor(40, 40, 40);
                    for (let c = 0; c < colCount; c++) {
                        const txt = rows[r][c] === null || rows[r][c] === undefined ? '' : String(rows[r][c]);
                        const txtX = margin + c * colWidth + 8;
                        doc.text(txt, txtX, curY + 15, { maxWidth: colWidth - 16 });
                    }
                    curY += rowHeight;
                }
                return curY + 20;
            }

            // Today's Sales
            if (todaySales.length > 0) {
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(0, 0, 0);
                doc.text("Today's Sales", margin, y);
                y += 15;
                const salesHeaders = ["Time", "Product", "Customer", "Qty", "Price", "Profit"];
                const salesRows = todaySales.map(s => [
                    s.time, s.productName, s.customer, s.quantity,
                    formatNumber(s.totalPrice) + ' ' + getCurrencySymbol(), formatNumber(s.profit) + ' ' + getCurrencySymbol()
                ]);
                y = drawTable(salesHeaders, salesRows, y);
                const totalQty = todaySales.reduce((sum, s) => sum + (s.quantity || 0), 0);
                const totalPrice = todaySales.reduce((sum, s) => sum + (s.totalPrice || 0), 0);
                const totalProfit = todaySales.reduce((sum, s) => sum + (s.profit || 0), 0);
                const colCount = salesHeaders.length;
                const colWidth = usableWidth / colCount;
                const rowHeight = 22;
                if (y + rowHeight > 750) { doc.addPage(); y = margin; }
                doc.setFillColor(245, 245, 245);
                doc.setDrawColor(180, 180, 180);
                doc.setLineWidth(0.75);
                doc.roundedRect(margin, y, usableWidth, rowHeight, 2, 2, 'FD');
                doc.setTextColor(40, 40, 40);
                doc.setFont(undefined, 'bold');
                doc.setFontSize(10);
                doc.text('Totals', margin + 2 * colWidth + 8, y + 15);
                doc.text(String(totalQty), margin + 3 * colWidth + 8, y + 15);
                doc.text(formatNumber(totalProfit) + ' ' + getCurrencySymbol(), margin + 5 * colWidth + 8, y + 15);
                y += rowHeight + 20;
            }

            // Today's Expenses
            const todayExpenses = (state.expenses || []).filter(e => e.date === today);
            if (todayExpenses.length > 0) {
                if (y > 650) { doc.addPage(); y = margin; }
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text("Today's Expenses", margin, y);
                y += 15;
                const expHeaders = ["Time", "Name", "Category", "Amount"];
                const expRows = todayExpenses.map(e => [e.time, e.description, e.category, `${formatNumber(e.amount || 0)} ${getCurrencySymbol()}`]);
                y = (function (headers, rows, startY) {
                    const colCount = headers.length; const colWidth = usableWidth / colCount; let curY = startY; const rowHeight = 22;
                    doc.setFillColor(100, 100, 100); doc.roundedRect(margin, curY, usableWidth, rowHeight, 3, 3, 'F');
                    doc.setTextColor(255, 255, 255); doc.setFont(undefined, 'bold'); doc.setFontSize(10);
                    for (let i = 0; i < colCount; i++) { const txtX = margin + i * colWidth + 8; doc.text(String(headers[i]), txtX, curY + 15); }
                    curY += rowHeight + 2; doc.setFont(undefined, 'normal'); doc.setFontSize(9);
                    for (let r = 0; r < rows.length; r++) {
                        if (curY + rowHeight > 750) { doc.addPage(); curY = margin; }
                        if (r % 2 === 0) { doc.setFillColor(248, 249, 250); doc.roundedRect(margin, curY, usableWidth, rowHeight, 2, 2, 'F'); }
                        doc.setTextColor(40, 40, 40); for (let c = 0; c < colCount; c++) { const txtX = margin + c * colWidth + 8; const txt = String(rows[r][c]); doc.text(txt, txtX, curY + 15, { maxWidth: colWidth - 16 }); }
                        curY += rowHeight;
                    }
                    return curY + 20;
                })(expHeaders, expRows, y);
                const totalExp = todayExpensesTotal; const colCount = expHeaders.length; const colWidth = usableWidth / colCount; const rowH = 22;
                if (y + rowH > 750) { doc.addPage(); y = margin; }
                doc.setFillColor(245, 245, 245); doc.setDrawColor(180, 180, 180); doc.setLineWidth(0.75);
                doc.roundedRect(margin, y, usableWidth, rowH, 2, 2, 'FD'); doc.setTextColor(40, 40, 40);
                doc.setFont(undefined, 'bold'); doc.setFontSize(10);
                doc.text('Total', margin + 2 * colWidth + 8, y + 15);
                doc.text(formatNumber(totalExp) + ' ' + getCurrencySymbol(), margin + 3 * colWidth + 8, y + 15);
                y += rowH + 20;
            }

            // Today's Income
            if (todayIncome.length > 0) {
                if (y > 650) { doc.addPage(); y = margin; }
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text("Today's Income", margin, y);
                y += 15;
                const incHeaders = ["Time", "Source", "Amount", "Payment"];
                const incRows = todayIncome.map(i => [i.time, i.source, formatNumber(i.amount || 0) + ' ' + getCurrencySymbol(), i.payment]);
                y = drawTable(incHeaders, incRows, y);
                const totalInc = todayIncomeTotal;
                const colCountI = incHeaders.length;
                const colWidthI = usableWidth / colCountI;
                const rowHeightI = 22;
                if (y + rowHeightI > 750) { doc.addPage(); y = margin; }
                doc.setFillColor(245, 245, 245);
                doc.setDrawColor(180, 180, 180);
                doc.setLineWidth(0.75);
                doc.roundedRect(margin, y, usableWidth, rowHeightI, 2, 2, 'FD');
                doc.setTextColor(40, 40, 40);
                doc.setFont(undefined, 'bold');
                doc.setFontSize(10);
                doc.text('Total', margin + 2 * colWidthI + 8, y + 15);
                doc.text(formatNumber(totalInc) + ' ' + getCurrencySymbol(), margin + 3 * colWidthI + 8, y + 15);
                y += rowHeightI + 20;
            }

            // Today's Transactions
            if (todayTransactions.length > 0) {
                if (y > 650) { doc.addPage(); y = margin; }
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text("Today's Transactions", margin, y);
                y += 15;
                const transHeaders = ["Channel", "Txn Type", "Time", "Customer", "Amount"];
                const transRows = todayTransactions.map(t => [
                    (t.channel || '').toUpperCase(), (t.type || '').toUpperCase(), t.time, t.customerName || 'N/A',
                    formatNumber(t.amount || 0) + ' ' + getCurrencySymbol()
                ]);
                y = drawTable(transHeaders, transRows, y);
            }

            const floatKeysDaily = Object.keys(state.transactionFloats || {});
            if (floatKeysDaily.length > 0) {
                if (y > 650) { doc.addPage(); y = margin; }
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text("Float Balances", margin, y);
                y += 15;
                const fHeadersD = ["Channel", "Init Acc", "Init Cash", "Curr Acc", "Curr Cash", "Total"];
                const fRowsD = floatKeysDaily.map(ch => {
                    const fd = state.transactionFloats[ch] || { initialAccount: 0, initialCash: 0, currentAccount: 0, currentCash: 0 };
                    const diff = (fd.currentCash || 0) - (fd.initialCash || 0);
                    return [
                        String(ch).toUpperCase(),
                        formatNumber(fd.initialAccount || 0) + ' ' + getCurrencySymbol(),
                        formatNumber(fd.initialCash || 0) + ' ' + getCurrencySymbol(),
                        formatNumber(fd.currentAccount || 0) + ' ' + getCurrencySymbol(),
                        formatNumber(fd.currentCash || 0) + ' ' + getCurrencySymbol(),
                        formatNumber(((fd.currentAccount || 0) + (fd.currentCash || 0))) + ' ' + getCurrencySymbol()
                    ];
                });
                y = drawTable(fHeadersD, fRowsD, y);
            }

            // Footer
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFillColor(240, 240, 240);
                doc.rect(0, 792 - 30, pageWidth, 30, 'F');
                doc.setTextColor(100, 100, 100);
                doc.setFontSize(9);
                doc.text(`Page ${i} of ${pageCount}`, margin, 792 - 12);
                doc.text(`The Ultimate Business Achitecture (TUBA) © ${new Date().getFullYear()}`, pageWidth - rightMargin, 792 - 8, { align: 'right' });
            }

            downloadPDFSafe(doc, `Daily_Report_${today}.pdf`);
            showToast("Daily report PDF ready", "success");
        }

        async function downloadUserGuidePDF() {
            playTapSound(); hapticShort(); await ensureLogoReady(); const { jsPDF } = window.jspdf; const doc = new jsPDF({ unit: 'pt', format: 'a4' }); const pageWidth = 595.28; const leftMargin = 42; const rightMargin = 24; const margin = leftMargin; const usableWidth = pageWidth - leftMargin - rightMargin; const centerX = pageWidth / 2; const profile = getUserProfileData(); function header(title, subtitle){ doc.setFillColor(240,240,240); doc.rect(0,0,pageWidth,80,'F'); doc.setTextColor(0,0,0); doc.setFontSize(22); doc.setFont(undefined,'bold'); doc.text('TUBA -The Ultimate Business Architecture', centerX, 44, { align:'center' }); doc.setFontSize(11); doc.setFont(undefined,'normal'); doc.setTextColor(100,100,100); doc.text('Welcome to TUBA FINANCES APP !!', centerX, 64, { align:'center' }); doc.setDrawColor(150,150,150); doc.setLineWidth(2); doc.line(margin, 80, pageWidth - rightMargin, 80); } function footer(){ const pageCount = doc.internal.getNumberOfPages(); for (let i=1;i<=pageCount;i++){ doc.setPage(i); doc.setFillColor(240,240,240); doc.rect(0, 792 - 26, pageWidth, 26, 'F'); doc.setTextColor(100,100,100); doc.setFontSize(9); doc.text(`Page ${i} of ${pageCount}`, margin, 792 - 12); doc.text(`The Ultimate Business Architecture (TUBA) © ${new Date().getFullYear()}`, pageWidth - rightMargin, 792 - 12, { align:'right' }); } } function addH1(text, y){ doc.setTextColor(0,0,0); doc.setFont(undefined,'bold'); doc.setFontSize(16); doc.text(text, margin, y); return y + 16; } function addH2(text, y){ doc.setTextColor(20,20,20); doc.setFont(undefined,'bold'); doc.setFontSize(13); doc.text(text, margin, y); return y + 12; } function addPara(text, y){ doc.setTextColor(60,60,60); doc.setFont(undefined,'normal'); doc.setFontSize(10); const lines = doc.splitTextToSize(text, usableWidth); for (const ln of lines){ if (y > 766){ doc.addPage(); header('', ''); y = 96; } doc.text(ln, margin, y); y += 10; } return y; } function addSteps(steps, y){ doc.setTextColor(35,35,35); doc.setFont(undefined,'normal'); doc.setFontSize(10); let n=1; for (const s of steps){ if (y > 766){ doc.addPage(); header('', ''); y = 96; } const lines = doc.splitTextToSize(`${n}. ${s}`, usableWidth); for (const ln of lines){ doc.text(ln, margin, y); y += 10; } n++; } return y; } function illustrationBox(title, items, y){ if (y > 740){ doc.addPage(); header('', ''); y = 96; } const boxH = 110; doc.setDrawColor(180,180,180); doc.setFillColor(248,249,250); doc.roundedRect(margin, y, usableWidth, boxH, 6, 6, 'FD'); doc.setTextColor(30,30,30); doc.setFont(undefined,'bold'); doc.setFontSize(11); doc.text(title, margin + 10, y + 16); doc.setFont(undefined,'normal'); doc.setFontSize(10); let iy = y + 32; for (const it of items){ const lines = doc.splitTextToSize(`• ${it}`, usableWidth - 20); for (const ln of lines){ if (iy > y + boxH - 10) break; doc.text(ln, margin + 10, iy); iy += 10; } } return y + boxH + 8; }
            header('User Guide', 'Step-by-step instructions'); let y = 96; y = addH1('Introduction', y); y = addPara('TUBA helps you manage sales, inventory, finances, and reports with a mobile-friendly interface and offline-first reliability. This guide walks you through each section with steps and visual cues.', y);
            y = addH1('Table of Contents', y); const toc = ['Login & Sign-in','Account & Profile','Navigation & Dashboard','Sales','Transactions','Products & Services','Categories','Income','Expenses','Inventory','Inventory Purchases','Customers','Invoices & Receipts','Analytics','Unpaid','Notes','Tags & Organization','Float Balances','Tithing (10%)','Reports & Exports','Offline & Backup','Cloud Sync']; for (const t of toc){ if (y > 766){ doc.addPage(); header('User Guide',''); y = 96; } y = addPara(`• ${t}`, y); }
            doc.addPage(); header('Login & Sign-in',''); y = 96; y = addH2('Goal', y); y = addPara('Access the app securely and restore your account when needed.', y); y = addH2('Steps', y); y = addSteps(['Open the app and tap Profile','Tap Sign in and enter email/password','Use Forgot Password to receive a reset link','If on a device-installed app, inline reset opens; otherwise the web reset screen loads','After signing in, the paywall overlay disappears when your account is active'], y); y = illustrationBox('Illustration — Sign-in', ['Profile tab at left','Email and password inputs','Sign in button','Forgot password link','Paywall overlay with activation instructions'], y);
            doc.addPage(); header('Account & Profile',''); y = 96; y = addH2('Configure Business', y); y = addPara('Set currency, tax rate, COGS method, and upload a logo for PDFs.', y); y = addSteps(['Open Account tab','Fill Business Name, Address, Phone, Email','Set Currency Code and Symbol','Set Default Tax Rate and COGS method','Upload Logo (PNG/JPEG)'], y); y = illustrationBox('Illustration — Settings', ['Form fields with business info','Currency and tax selectors','Upload logo area','Save Settings button'], y);
            doc.addPage(); header('Navigation & Dashboard',''); y = 96; y = addPara('Use the bottom nav or side drawer to access tabs. Dashboard shows totals, Today’s Profit, and a Daily Target ring.', y); y = addSteps(['Open Dashboard to see quick stats','Use FAB and Quick Downloads in the side drawer','Check Today’s Profit card top-right for target progress'], y); y = illustrationBox('Illustration — Today’s Profit', ['Daily target label + circular progress','Totals and subvalues','Blue mode visibility with white text'], y);
            doc.addPage(); header('Sales',''); y = 96; y = addPara('Record new sales and track profit automatically.', y); y = addSteps(['Open Sales','Choose Product/Service (searchable dropdown)','Set Quantity and Payment Method','Set Status: Paid or Unpaid','Tap Record Sale'], y); y = illustrationBox('Illustration — Add Sale', ['Product dropdown','Quantity input','Payment selector','Status selector','Record Sale button'], y);
            doc.addPage(); header('Transactions',''); y = 96; y = addPara('Record money transactions across channels and types.', y); y = addSteps(['Open Money tab','Enter Transaction details','Save and review balances'], y);
            doc.addPage(); header('Products & Services',''); y = 96; y = addSteps(['Open Products/Services','Add item with category, cost, price','Enable stock for products','Track inventory automatically'], y);
            doc.addPage(); header('Categories',''); y = 96; y = addSteps(['Open Categories','Add or edit names','Assign kind: product/service','Changes propagate to related items'], y);
            doc.addPage(); header('Income',''); y = 96; y = addSteps(['Open Income','Record source, amount, payment','Export summaries later from Reports'], y);
            doc.addPage(); header('Expenses',''); y = 96; y = addSteps(['Open Expenses','Record description, category, amount','Generate expense reports (PDF) with date ranges'], y);
            doc.addPage(); header('Inventory',''); y = 96; y = addSteps(['Open Stock','Adjust stock and set alerts','Inventory levels update in sales'], y);
            doc.addPage(); header('Inventory Purchases',''); y = 96; y = addPara('Organize purchases by periods and import bulk data.', y); y = addSteps(['Open Inventory tab (Purchases)','Create or select a Period','Add purchase details or import CSV','Periods dedupe by number; next number uses max+1'], y);
            doc.addPage(); header('Customers',''); y = 96; y = addSteps(['Open Customers','Add or edit customer info','Attach sales and export contacts'], y);
            doc.addPage(); header('Invoices & Receipts',''); y = 96; y = addSteps(['Open Invoices & Receipts','Generate documents from records','Download or preview PDFs'], y);
            doc.addPage(); header('Analytics',''); y = 96; y = addSteps(['Open Analytics','Review revenue, profit, and trends','Plan targets accordingly'], y);
            doc.addPage(); header('Unpaid',''); y = 96; y = addSteps(['Open Unpaid','Review unpaid sales','Mark as Paid or open detail'], y);
            doc.addPage(); header('Notes',''); y = 96; y = addSteps(['Open Notes','Add quick notes; tag and filter','Share or edit when needed'], y);
            doc.addPage(); header('Tags & Organization',''); y = 96; y = addPara('Apply tags to items and use filters to organize. In blue mode, selected tags show a yellow border.', y); y = addSteps(['Open Tags from Tools','Select a tag; active state becomes yellow in blue mode','Apply tags in modals or item lists'], y);
            doc.addPage(); header('Float Balances',''); y = 96; y = addSteps(['Open Float breakdown','Set initial floats','Track current account/cash and totals'], y);
            doc.addPage(); header('Tithing (10%)',''); y = 96; y = addPara('Monthly tithing calculates due based on sales profit + income. Partial payments sync to cloud.', y); y = addSteps(['Open Tithing modal','Record Partial or Paid','Amounts sync to Supabase even if account activation is pending'], y);
            doc.addPage(); header('Reports & Exports',''); y = 96; y = addSteps(['Use side nav Quick Downloads','Daily PDF and General PDF/Excel','Stock sheet PDF and range-based reports'], y);
            doc.addPage(); header('Offline & Backup',''); y = 96; y = addSteps(['Work offline; changes save locally','Use Backup button before deletes','Export JSON via 💾 Save offline'], y);
            doc.addPage(); header('Cloud Sync',''); y = 96; y = addPara('Sync runs in the background when online. Upserts queue and retry automatically. Diagnostics helps verify policies.', y); y = addSteps(['Sign in to enable sync','Upserts queue when offline','Run Cloud Diagnostics from Tools'], y);
            footer(); downloadPDFSafe(doc, `TUBA_User_Guide_${getTodayDateString()}.pdf`); showToast('User guide downloaded', 'success');
        }

        async function downloadUserGuidePDF() {
            playTapSound();
            hapticShort();
            await ensureLogoReady();
            const { jsPDF } = window.jspdf || {};
            if (!jsPDF) return showToast('PDF library not loaded', 'error');
            const doc = new jsPDF({ unit: 'pt', format: 'a4' });
            const pageWidth = 595.28;
            const pageHeight = 841.89;
            const leftMargin = 42;
            const rightMargin = 24;
            const margin = leftMargin;
            const usableWidth = pageWidth - leftMargin - rightMargin;
            const centerX = pageWidth / 2;
            const profile = getUserProfileData();

            function header(subtitle) {
                doc.setFillColor(240, 240, 240);
                doc.rect(0, 0, pageWidth, 80, 'F');
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(22);
                doc.setFont(undefined, 'bold');
                doc.text('TUBA -The Ultimate Business Architecture', centerX, 44, { align: 'center' });
                doc.setFont(undefined, 'normal');
                doc.setTextColor(100, 100, 100);
                doc.text('Welcome to TUBA FINANCES APP !!', centerX, 64, { align: 'center' });
                doc.setDrawColor(150, 150, 150);
                doc.setLineWidth(2);
                doc.line(margin, 80, pageWidth - rightMargin, 80);
            }

            function footer() {
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFillColor(240, 240, 240);
                    doc.rect(0, pageHeight - 26, pageWidth, 26, 'F');
                    doc.setTextColor(100, 100, 100);
                    doc.setFontSize(9);
                    doc.text(`Page ${i} of ${pageCount}`, margin, pageHeight - 12);
                    doc.text(`The Ultimate Business Architecture (TUBA) © ${new Date().getFullYear()}`, pageWidth - rightMargin, pageHeight - 12, { align: 'right' });
                }
            }

            function ensureY(y) {
                if (y > pageHeight - 60) {
                    doc.addPage();
                    header('User Guide');
                    return 96;
                }
                return y;
            }

            function addHeading(level, text, y) {
                y = ensureY(y);
                const sizes = { 1: 16, 2: 13, 3: 12, 4: 11, 5: 10, 6: 10 };
                const size = sizes[level] || 11;
                doc.setTextColor(0, 0, 0);
                doc.setFont(undefined, 'bold');
                doc.setFontSize(size);
                doc.text(text, margin, y);
                return y + size + 6;
            }

            function addParagraph(text, y, indent = 0) {
                doc.setTextColor(60, 60, 60);
                doc.setFont(undefined, 'normal');
                doc.setFontSize(10);
                const w = usableWidth - indent;
                const lines = doc.splitTextToSize(text, w);
                for (const ln of lines) {
                    y = ensureY(y);
                    doc.text(ln, margin + indent, y);
                    y += 11;
                }
                return y + 2;
            }

            function mdToLines(md) {
                const raw = String(md || '').replace(/\r\n/g, '\n').split('\n');
                const out = [];
                for (const line of raw) {
                    const s = String(line || '');
                    if (!s.trim()) {
                        out.push({ t: 'spacer' });
                        continue;
                    }
                    const h = s.match(/^(#{1,6})\s+(.*)$/);
                    if (h) {
                        out.push({ t: 'h', lvl: h[1].length, text: h[2].trim() });
                        continue;
                    }
                    const b = s.match(/^\s*[-*]\s+(.*)$/);
                    if (b) {
                        out.push({ t: 'b', text: b[1].trim() });
                        continue;
                    }
                    const n = s.match(/^\s*\d+\.\s+(.*)$/);
                    if (n) {
                        out.push({ t: 'b', text: n[1].trim() });
                        continue;
                    }
                    const q = s.match(/^\s*>\s+(.*)$/);
                    if (q) {
                        out.push({ t: 'q', text: q[1].trim() });
                        continue;
                    }
                    out.push({ t: 'p', text: s.trim() });
                }
                return out;
            }

            let md = '';
            try {
                const base = (window.APP_BASE_URL || new URL('.', window.location.href).href);
                const url = new URL('docs/user-guide.md', base);
                url.searchParams.set('v', String(Date.now()));
                const res = await fetch(url.toString(), { cache: 'no-store' });
                if (!res.ok) throw new Error('fetch failed');
                md = await res.text();
            } catch (e) {
                md = '# TUBA User Guide\n\nUser guide file could not be loaded.\n\nOpen the app and use Dashboard, Sales, Stock, Income, Expenses, Loans, Assets, and Maintenance to manage your business.';
            }

            header('User Guide');
            let y = 96;
            const parts = mdToLines(md);
            for (const it of parts) {
                if (it.t === 'spacer') { y += 6; continue; }
                if (it.t === 'h') { y = addHeading(it.lvl, it.text, y); continue; }
                if (it.t === 'q') { y = addParagraph(it.text, y, 10); continue; }
                if (it.t === 'b') { y = addParagraph('• ' + it.text, y, 10); continue; }
                y = addParagraph(it.text, y, 0);
            }

            footer();
            downloadPDFSafe(doc, `TUBA_User_Guide_${getTodayDateString()}.pdf`);
            showToast('User guide downloaded', 'success');
        }

        async function downloadSalesReportExcel() {
            playTapSound();
            hapticShort();
            try { if (window.loadLibrary) await loadLibrary('xlsx'); } catch {}
            const totalSalesQty = (state.sales || []).reduce((sum, s) => sum + (s.quantity || 0), 0);
            const totalSalesPrice = (state.sales || []).reduce((sum, s) => sum + (s.totalPrice || 0), 0);
            const totalSalesProfit = (state.sales || []).reduce((sum, s) => sum + (s.profit || 0), 0);
            const totalTransactions = (state.transactions || []).reduce((sum, t) => sum + (t.amount || 0), 0);
            const profile = getUserProfileData();
            const contactLine = buildProfileContactLine(profile);
            const taxLine = buildProfileTaxLine(profile);
            const rows = [
                ["TUBA - The Ultimate Business Architecture"],
                ["Financial Report"],
                [profile.businessName || ''],
                [contactLine],
                [taxLine],
                [`Generated: ${getTodayDateString()}`],
                [],
                ["SALES RECORDS"],
                ["Date", "Product", "Customer", "Quantity", "Price (" + getCurrencySymbol() + ")", "Profit (" + getCurrencySymbol() + ")"],
                ...((state.sales || []).map(s => [s.date, s.productName, s.customer, s.quantity, s.totalPrice, s.profit])),
                ["", "", "Totals", totalSalesQty, totalSalesPrice, totalSalesProfit],
                [],

                ["MONEY TRANSACTIONS"],
                ["Channel", "Txn Type", "Date", "Customer", "Amount (" + getCurrencySymbol() + ")"],
                ...((state.transactions || []).map(t => [String(t.channel || '').toUpperCase(), String(t.type || '').toUpperCase(), t.date, t.customerName || 'N/A', t.amount])),
                ["", "", "", "Total", totalTransactions],
                [],
                ["FLOAT BALANCES"],
                ["Channel", "Initial Account (" + getCurrencySymbol() + ")", "Initial Cash (" + getCurrencySymbol() + ")", "Current Account (" + getCurrencySymbol() + ")", "Current Cash (" + getCurrencySymbol() + ")", "Total (" + getCurrencySymbol() + ")"],
                ...(
                    Object.keys(state.transactionFloats || {}).map(ch => {
                        const fd = state.transactionFloats[ch] || { initialAccount: 0, initialCash: 0, currentAccount: 0, currentCash: 0 };
                        const currTotal = (fd.currentAccount || 0) + (fd.currentCash || 0);
                        return [String(ch).toUpperCase(), fd.initialAccount || 0, fd.initialCash || 0, fd.currentAccount || 0, fd.currentCash || 0, currTotal];
                    })
                )
            ];

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(rows);

            ws['!cols'] = [
                { wch: 15 }, { wch: 20 }, { wch: 20 }, { wch: 12 }, { wch: 15 }, { wch: 15 }
            ];

            XLSX.utils.book_append_sheet(wb, ws, "Financial Report");
            XLSX.writeFile(wb, `Financial_Report_${getTodayDateString()}.xlsx`);
            showToast("Excel downloaded successfully!", "success");
        }
        async function downloadSalesReportExcelMode(mode) {
            playTapSound();
            hapticShort();
            try { if (window.loadLibrary) await loadLibrary('xlsx'); } catch {}
            const profile = getUserProfileData();
            const contactLine2 = `${profile.address || ''} | ${profile.phone || ''} | ${profile.email || ''}`.replace(/^\s*\|\s*|\s*\|\s*$/g,'').replace(/\s*\|\s*\|\s*/g,' | ');
            const taxLine2 = `TIN: ${profile.tinNumber || ''} | BL-No: ${profile.blNumber || ''}${profile.hasVAT && profile.vatNumber ? ' | VAT: ' + profile.vatNumber : ''}`.replace(/(\s*\|\s*)+/g,' | ').replace(/^(\s*\|\s*)|(\s*\|\s*)$/g,'').trim();
            const rows = [
                ["TUBA - The Ultimate Business Architecture"],
                ["Financial Report"],
                [profile.businessName || ''],
                [contactLine2],
                [taxLine2],
                [`Generated: ${getTodayDateString()}`],
                [],
                ["SALES RECORDS"],
                [mode === 'stacked' ? "Category" : "Date", mode === 'stacked' ? "Totals" : "Product", mode === 'stacked' ? "-" : "Customer", "Quantity", "Price (" + getCurrencySymbol() + ")", "Profit (" + getCurrencySymbol() + ")"],
                ...(
                    mode === 'stacked'
                    ? (() => {
                        const byCat = {};
                        (state.sales || []).forEach(s => {
                            const key = String(s.category || 'Uncategorized');
                            if (!byCat[key]) byCat[key] = { qty: 0, price: 0, profit: 0 };
                            byCat[key].qty += (s.quantity || 0);
                            byCat[key].price += (s.totalPrice || 0);
                            byCat[key].profit += (s.profit || 0);
                        });
                        return Object.keys(byCat).sort((a,b)=>String(a).localeCompare(String(b))).map(cat => [cat, "–", "–", byCat[cat].qty, byCat[cat].price, byCat[cat].profit]);
                    })()
                    : ((state.sales || []).map(s => [s.date, s.productName, s.customer, s.quantity, s.totalPrice, s.profit]))
                ),
                [],
                ["MONEY TRANSACTIONS"],
                ["Channel", "Txn Type", "Date", "Customer", "Amount (" + getCurrencySymbol() + ")"],
                ...(
                    mode === 'stacked'
                    ? (() => {
                        const byKey = {};
                        (state.transactions || []).forEach(t => {
                            const key = `${String(t.channel||'').toUpperCase()}|${String(t.type||'').toUpperCase()}`;
                            byKey[key] = (byKey[key] || 0) + (t.amount || 0);
                        });
                        return Object.keys(byKey).sort().map(k => {
                            const [ch, tp] = k.split('|');
                            return [ch, tp, "–", "–", byKey[k]];
                        });
                    })()
                    : ((state.transactions || []).map(t => [String(t.channel || '').toUpperCase(), String(t.type || '').toUpperCase(), t.date, t.customerName || 'N/A', t.amount]))
                )
            ];
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(rows);
            XLSX.utils.book_append_sheet(wb, ws, "Financial Report");
            XLSX.writeFile(wb, `Financial_Report_${getTodayDateString()}.xlsx`);
            showToast("Excel downloaded successfully!", "success");
        }

        async function downloadExpensesReportPDF(startDate = null, endDate = null, mode = (window.reportMode || 'stacked')) {
            playTapSound();
            hapticShort();
            await ensureLogoReady();
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ unit: 'pt', format: 'a4' });
            const pageWidth = 595.28;
            const leftMargin = 50;
            const rightMargin = 24;
            const margin = leftMargin;
            const usableWidth = pageWidth - leftMargin - rightMargin;
            let y = 50;
            const centerX = pageWidth / 2;

            doc.setFillColor(240, 240, 240);
            doc.rect(0, 0, pageWidth, 100, 'F');
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(24);
            doc.setFont(undefined, 'bold');
            const profile = getUserProfileData();
            doc.text(profile.businessName, centerX, 45, { align: 'center' });
            doc.setFont(undefined, 'normal');
            const contactLine = buildProfileContactLine(profile);
            if (contactLine) doc.text(contactLine, centerX, 70, { align: 'center' });
            doc.setFontSize(10);
            doc.setTextColor(0, 0, 0);
            doc.setFont(undefined, 'normal');
            const taxLine = buildProfileTaxLine(profile);
            if (taxLine) doc.text(taxLine, centerX, 90, { align: 'center' });
            doc.setDrawColor(150, 150, 150);
            doc.setLineWidth(3);
            doc.line(margin, 100, pageWidth - rightMargin, 100);

            y = 120;
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(18);
            doc.setFont(undefined, 'bold');
            doc.text("Expenses Report", margin, y);
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.setTextColor(100, 100, 100);
            const rangeLabel = (startDate || endDate) ? `Range: ${startDate || '...'} to ${endDate || '...'}` : 'All data';
            doc.text(`Generated: ${getTodayDateString()} | ${rangeLabel}`, margin, y + 20);
            y += 50;

            function drawTable(headers, rows, startY) {
                const colCount = headers.length;
                const colWidth = usableWidth / colCount;
                let curY = startY;
                const headerH = 22;
                doc.setFillColor(100, 100, 100);
                doc.roundedRect(margin, curY, usableWidth, headerH, 3, 3, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFont(undefined, 'bold');
                doc.setFontSize(10);
                for (let i = 0; i < colCount; i++) {
                    const txtX = margin + i * colWidth + 8;
                    doc.text(String(headers[i]), txtX, curY + 15);
                }
                curY += headerH + 2;
                doc.setFont(undefined, 'normal');
                doc.setFontSize(9);
                for (let r = 0; r < rows.length; r++) {
                    let maxLines = 1;
                    const cellLines = [];
                    for (let c = 0; c < colCount; c++) {
                        const txt = rows[r][c] === null || rows[r][c] === undefined ? '' : String(rows[r][c]);
                        const lines = doc.splitTextToSize(txt, colWidth - 16);
                        cellLines.push(lines);
                        if (lines.length > maxLines) maxLines = lines.length;
                    }
                    const lineH = 10;
                    const rowH = maxLines * lineH + 8;
                    if (curY + rowH > 750) { doc.addPage(); curY = margin; }
                    if (r % 2 === 0) {
                        doc.setFillColor(248, 249, 250);
                        doc.roundedRect(margin, curY, usableWidth, rowH, 2, 2, 'F');
                    }
                    doc.setTextColor(40, 40, 40);
                    for (let c = 0; c < colCount; c++) {
                        const txtX = margin + c * colWidth + 8;
                        const lines = cellLines[c];
                        for (let li = 0; li < lines.length; li++) {
                            doc.text(lines[li], txtX, curY + 15 + li * lineH);
                        }
                    }
                    curY += rowH;
                }
                return curY + 20;
            }

            const inRange = (d) => {
                if (!startDate && !endDate) return true;
                const ts = new Date(d).getTime();
                const from = startDate ? new Date(startDate).getTime() : -Infinity;
                const to = endDate ? new Date(endDate).getTime() : Infinity;
                return ts >= from && ts <= to;
            };

            const headers = ["Date", (mode === 'stacked' ? "Category" : "Name"), (mode === 'stacked' ? "–" : "Category"), "Notes", "Amount"];
            let rows;
            if (mode === 'stacked') {
                const byCat = {};
                (state.expenses || []).filter(e => inRange(e.date)).forEach(e => {
                    const key = String(e.category || 'Miscellaneous');
                    byCat[key] = (byCat[key] || 0) + (e.amount || 0);
                });
                rows = Object.keys(byCat).sort((a,b)=>String(a).localeCompare(String(b))).map(cat => ["-", cat, "–", "", `${formatNumber(byCat[cat] || 0)} ${getCurrencySymbol()}`]);
            } else {
                rows = (state.expenses || []).filter(e => inRange(e.date)).sort((a, b) => Number(a.timestamp) - Number(b.timestamp)).map(e => [e.date, e.description, e.category, e.comment || "", `${formatNumber(e.amount || 0)} ${getCurrencySymbol()}`]);
            }
            if (rows.length > 0) {
                y = drawTable(headers, rows, y);
                const total = (state.expenses || []).filter(e => inRange(e.date)).reduce((sum, e) => sum + (e.amount || 0), 0);
                const colCount = headers.length;
                const colWidth = usableWidth / colCount;
                const rowHeight = 22;
                if (y + rowHeight > 750) { doc.addPage(); y = margin; }
                doc.setFillColor(245, 245, 245);
                doc.setDrawColor(180, 180, 180);
                doc.setLineWidth(0.75);
                doc.roundedRect(margin, y, usableWidth, rowHeight, 2, 2, 'FD');
                doc.setTextColor(40, 40, 40);
                doc.setFont(undefined, 'bold');
                doc.setFontSize(10);
                doc.text('Total', margin + 3 * colWidth + 8, y + 15);
                doc.text(formatNumber(total) + ' ' + getCurrencySymbol(), margin + 4 * colWidth + 8, y + 15);
                y += rowHeight + 20;
            }

            const filename = `Expenses_Report_${getTodayDateString()}.pdf`;
            downloadPDFSafe(doc, filename);
        }

        async function downloadIncomeReportPDF(startDate = null, endDate = null, mode = (window.reportMode || 'stacked')) {
            playTapSound();
            hapticShort();
            await ensureLogoReady();
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ unit: 'pt', format: 'a4' });
            const pageWidth = 595.28;
            const leftMargin = 50;
            const rightMargin = 24;
            const margin = leftMargin;
            const usableWidth = pageWidth - leftMargin - rightMargin;
            let y = 50;
            const centerX = pageWidth / 2;

            doc.setFillColor(240, 240, 240);
            doc.rect(0, 0, pageWidth, 100, 'F');
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(24);
            doc.setFont(undefined, 'bold');
            const profile = getUserProfileData();
            doc.text(profile.businessName, centerX, 45, { align: 'center' });
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            const contactLine = buildProfileContactLine(profile);
            if (contactLine) doc.text(contactLine, centerX, 70, { align: 'center' });
            doc.setFontSize(10);
            doc.setTextColor(0, 0, 0);
            doc.setFont(undefined, 'normal');
            const taxLine = buildProfileTaxLine(profile);
            if (taxLine) doc.text(taxLine, centerX, 90, { align: 'center' });
            doc.setDrawColor(150, 150, 150);
            doc.setLineWidth(3);
            doc.line(margin, 100, pageWidth - rightMargin, 100);

            y = 120;
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(18);
            doc.setFont(undefined, 'bold');
            doc.text("Income Report", margin, y);
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.setTextColor(100, 100, 100);
            const rangeLabel = (startDate || endDate) ? `Range: ${startDate || '...'} to ${endDate || '...'}` : 'All data';
            doc.text(`Generated: ${getTodayDateString()} | ${rangeLabel}`, margin, y + 20);
            y += 50;

            function drawTable(headers, rows, startY) {
                const colCount = headers.length;
                const colWidth = usableWidth / colCount;
                let curY = startY;
                const headerH = 22;
                doc.setFillColor(100, 100, 100);
                doc.roundedRect(margin, curY, usableWidth, headerH, 3, 3, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFont(undefined, 'bold');
                doc.setFontSize(10);
                for (let i = 0; i < colCount; i++) {
                    const txtX = margin + i * colWidth + 8;
                    doc.text(String(headers[i]), txtX, curY + 15);
                }
                curY += headerH + 2;
                doc.setFont(undefined, 'normal');
                doc.setFontSize(9);
                for (let r = 0; r < rows.length; r++) {
                    let maxLines = 1;
                    const cellLines = [];
                    for (let c = 0; c < colCount; c++) {
                        const txt = rows[r][c] === null || rows[r][c] === undefined ? '' : String(rows[r][c]);
                        const lines = doc.splitTextToSize(txt, colWidth - 16);
                        cellLines.push(lines);
                        if (lines.length > maxLines) maxLines = lines.length;
                    }
                    const lineH = 10;
                    const rowH = maxLines * lineH + 8;
                    if (curY + rowH > 750) { doc.addPage(); curY = margin; }
                    if (r % 2 === 0) {
                        doc.setFillColor(248, 249, 250);
                        doc.roundedRect(margin, curY, usableWidth, rowH, 2, 2, 'F');
                    }
                    doc.setTextColor(40, 40, 40);
                    for (let c = 0; c < colCount; c++) {
                        const txtX = margin + c * colWidth + 8;
                        const lines = cellLines[c];
                        for (let li = 0; li < lines.length; li++) {
                            doc.text(lines[li], txtX, curY + 15 + li * lineH);
                        }
                    }
                    curY += rowH;
                }
                return curY + 20;
            }

            const inRange = (d) => {
                if (!startDate && !endDate) return true;
                const ts = new Date(d).getTime();
                const from = startDate ? new Date(startDate).getTime() : -Infinity;
                const to = endDate ? new Date(endDate).getTime() : Infinity;
                return ts >= from && ts <= to;
            };

            const headers = ["Date", "Source", "Payment", "Notes", "Amount"];
            let rows;
            if (mode === 'stacked') {
                const bySrc = {};
                (state.income || [])
                    .filter(i => inRange(i.date))
                    .forEach(i => {
                        const key = String(i.source || 'Miscellaneous');
                        bySrc[key] = (bySrc[key] || 0) + (i.amount || 0);
                    });
                rows = Object.keys(bySrc).sort((a,b)=>String(a).localeCompare(String(b))).map(src => ["-", src, "–", "", `${formatNumber(bySrc[src] || 0)} ${getCurrencySymbol()}`]);
            } else {
                rows = (state.income || [])
                    .filter(i => inRange(i.date))
                    .sort((a, b) => Number(a.timestamp) - Number(b.timestamp))
                    .map(i => [i.date, i.source, i.payment || "", i.comment || "", `${formatNumber(i.amount || 0)} ${getCurrencySymbol()}`]);
            }
            if (rows.length > 0) {
                y = drawTable(headers, rows, y);
                const total = (state.income || []).filter(i => inRange(i.date)).reduce((sum, it) => sum + (it.amount || 0), 0);
                const colCount = headers.length;
                const colWidth = usableWidth / colCount;
                const rowHeight = 22;
                if (y + rowHeight > 750) { doc.addPage(); y = margin; }
                doc.setFillColor(245, 245, 245);
                doc.setDrawColor(180, 180, 180);
                doc.setLineWidth(0.75);
                doc.roundedRect(margin, y, usableWidth, rowHeight, 2, 2, 'FD');
                doc.setTextColor(40, 40, 40);
                doc.setFont(undefined, 'bold');
                doc.setFontSize(10);
                doc.text('Total', margin + 3 * colWidth + 8, y + 15);
                doc.text(formatNumber(total) + ' ' + getCurrencySymbol(), margin + 4 * colWidth + 8, y + 15);
                y += rowHeight + 20;
            }

            const filename = `Income_Report_${getTodayDateString()}.pdf`;
            downloadPDFSafe(doc, filename);
        }

        function notificationsSupported(){ try { return ('Notification' in window); } catch { return false; } }
        function getNotificationsPref(){ try { const v = localStorage.getItem('tuba-notifications-enabled'); if (v === 'false') return false; if (v === 'true') return true; return true; } catch { return true; } }
        function setNotificationsPref(val){ try { localStorage.setItem('tuba-notifications-enabled', val ? 'true' : 'false'); } catch {} try { const txt = document.getElementById('sideNavSoundText'); if (txt) txt.textContent = `Sound: ${val ? 'On' : 'Off'}`; } catch {} }
        function enableNotifications(){ if (!notificationsSupported()) { showToast && showToast('Notifications not supported', 'error'); return; } const p = Notification.permission; if (p === 'granted') { setNotificationsPref(true); try { if (typeof subscribeToPush === 'function') { subscribeToPush(); } } catch {} showToast && showToast('Notifications enabled', 'success'); closeNotificationsModal(); return; } if (p !== 'denied') { try { Notification.requestPermission().then(function(permission){ if (permission === 'granted') { setNotificationsPref(true); try { if (typeof subscribeToPush === 'function') { subscribeToPush(); } } catch {} try { new Notification('Notifications Enabled!', { body: 'You will now receive alerts from this app.', icon: './icons/tuba-icon-192.png' }); } catch {} showToast && showToast('Notifications enabled', 'success'); closeNotificationsModal(); } else { showToast && showToast('Permission not granted', 'error'); } }); } catch {} } else { showToast && showToast('Notifications blocked. Enable in browser settings.', 'error'); } }
        async function disableNotifications(){ try { setNotificationsPref(false); const reg = await navigator.serviceWorker.ready; const sub = await reg.pushManager.getSubscription(); if (sub) { try { const info = sub.toJSON(); try { await sub.unsubscribe(); } catch {} try { if (window.currentUser && window.supabase) { await supabase.from('push_subscriptions').delete().eq('user_id', window.currentUser.id).eq('endpoint', info.endpoint); } } catch {} } catch {} } showToast && showToast('Notifications disabled', 'info'); closeNotificationsModal(); } catch { showToast && showToast('Disable failed', 'error'); } }
        function sendNotification(title, body){ if (!notificationsSupported()) return; if (!getNotificationsPref()) return; const opts = { body: String(body||''), icon: './icons/tuba-icon-192.png' }; if (Notification.permission === 'granted') { try { if (navigator.serviceWorker && navigator.serviceWorker.getRegistration) { navigator.serviceWorker.getRegistration().then(function(reg){ try { if (reg && reg.showNotification) { reg.showNotification(String(title||'Alert'), opts); } else { try { new Notification(String(title||'Alert'), opts); } catch {} } } catch { try { new Notification(String(title||'Alert'), opts); } catch {} } }); } else { try { new Notification(String(title||'Alert'), opts); } catch {} } } catch {} } else { showToast && showToast('Enable notifications first', 'info'); } }
        // Default Push configuration (frontend preconfigured)
        window.DEFAULT_PUSH_PUBLIC_KEY = 'BI9-beXmdvuVfj7kwX7c8zGy4UPbWhayx5kC4JrrDvcHSmSKZY-PytL_bI1hzsVA5AFeFwhv-k5c6E8MKANQWAY';
        window.DEFAULT_PUSH_SERVER_URL = 'https://YOUR_PROJECT_REF.functions.supabase.co/push-handler/subscribe';
        function urlBase64ToUint8Array(base64String){ const padding='='.repeat((4-base64String.length%4)%4); const base64=(base64String+padding).replace(/-/g,'+').replace(/_/g,'/'); const raw=atob(base64); const output=new Uint8Array(raw.length); for(let i=0;i<raw.length;++i){ output[i]=raw.charCodeAt(i); } return output; }
        function getPushConfig(){ try { const pk = localStorage.getItem('tuba-push-public-key'); const su = localStorage.getItem('tuba-push-server-url'); return { publicKey: (pk && pk.trim()) || window.DEFAULT_PUSH_PUBLIC_KEY, serverUrl: (su && su.trim()) || window.DEFAULT_PUSH_SERVER_URL }; } catch { return { publicKey: window.DEFAULT_PUSH_PUBLIC_KEY, serverUrl: window.DEFAULT_PUSH_SERVER_URL }; } }
        function seedDefaultPushConfig(){ try { const cur=getPushConfig(); localStorage.setItem('tuba-push-public-key', cur.publicKey); localStorage.setItem('tuba-push-server-url', cur.serverUrl); } catch {} }
        function configurePush(){ try { const cur=getPushConfig(); const pk=prompt('Enter VAPID Public Key (URL-safe base64):', cur.publicKey||''); if (pk){ localStorage.setItem('tuba-push-public-key', pk.trim()); } const su=prompt('Optional: Push Server URL to receive subscriptions (e.g., https://yourdomain/api/push/subscribe):', cur.serverUrl||''); if (su){ localStorage.setItem('tuba-push-server-url', su.trim()); } showToast && showToast('Push configured', 'success'); } catch { showToast && showToast('Failed to configure push', 'error'); } }
        async function enableBackgroundPush(){ try { if (!notificationsSupported()) { showToast && showToast('Notifications not supported', 'error'); return; } if (Notification.permission!=='granted'){ showToast && showToast('Grant notifications first', 'info'); enableNotifications(); return; } const cfg=getPushConfig(); if (!cfg.publicKey){ showToast && showToast('Configure VAPID public key', 'error'); return; } const reg=await navigator.serviceWorker.ready; const existing=await reg.pushManager.getSubscription(); if (existing){ try { localStorage.setItem('tuba-push-subscription', JSON.stringify(existing)); } catch {} showToast && showToast('Background push already enabled', 'success'); return; } const sub=await reg.pushManager.subscribe({ userVisibleOnly:true, applicationServerKey: urlBase64ToUint8Array(cfg.publicKey) }); try { localStorage.setItem('tuba-push-subscription', JSON.stringify(sub)); } catch {} showToast && showToast('Background push enabled', 'success'); try { if (cfg.serverUrl){ await fetch(cfg.serverUrl, { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ subscription: sub, user_id: (window.currentUser && window.currentUser.id) || null }) }); } } catch {} } catch(e){ console.error('Enable push error', e); showToast && showToast('Enable push failed', 'error'); } }
        async function testBackgroundPush(){ try { const cfg=getPushConfig(); const subRaw=localStorage.getItem('tuba-push-subscription'); if (!cfg.serverUrl){ showToast && showToast('Set push server URL to test', 'info'); return; } if (!subRaw){ showToast && showToast('Enable background push first', 'info'); return; } const sub=JSON.parse(subRaw); const uid=(window.currentUser && window.currentUser.id) || null; await fetch(cfg.serverUrl, { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ subscription: sub, user_id: uid, type:'test', title:'Background Push', body:'This is a test notification' }) }); showToast && showToast('Test push request sent', 'success'); } catch { showToast && showToast('Test push failed', 'error'); } }
        function autoEnableBackgroundPushIfGranted(){ try { if (!notificationsSupported()) return; seedDefaultPushConfig(); if (getNotificationsPref() && Notification.permission==='granted'){ enableBackgroundPush(); } } catch {} }
        try { window.addEventListener('load', autoEnableBackgroundPushIfGranted); } catch {}
        function sendTestNotification(){ sendNotification('System Alert', 'This is a placeholder for your future content.'); }
        function notifToday(){ try { return (typeof getTodayDateString === 'function') ? getTodayDateString() : (new Date().toISOString().slice(0,10)); } catch { const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; } }
        function notifKey(k){ return `tuba-notif-${k}-${notifToday()}`; }
        function notifSent(k){ try { return localStorage.getItem(notifKey(k)) === '1'; } catch { return false; } }
        function markNotif(k){ try { localStorage.setItem(notifKey(k), '1'); } catch {} }
        function evaluateNotifications(){ try { if (!notificationsSupported()) return; if (!getNotificationsPref()) return; const stats = (typeof getStats === 'function') ? getStats() : (window.getStats ? window.getStats() : {}); const target = Number((window.state && window.state.dailyTarget) || 0) || 0; const revenue = Number(stats.todayRevenue || 0); const profit = Number(stats.todayProfit || 0); const expenses = Number(stats.todayExpenses || 0); const hour = (new Date()).getHours(); if (hour>=7 && hour<=10 && !notifSent('morning-sales-reminder')) { sendNotification('Good Morning', 'Remember to record today’s sales'); markNotif('morning-sales-reminder'); } if (hour>=9 && hour<=10 && !notifSent('expenses-reminder-1')) { sendNotification('Record Expenses', 'Record today’s expenses to keep reports accurate'); markNotif('expenses-reminder-1'); } if (hour>=13 && hour<=14 && !notifSent('expenses-reminder-2')) { sendNotification('Record Expenses', 'Midday reminder to record expenses'); markNotif('expenses-reminder-2'); } if (hour>=18 && hour<=19 && !notifSent('expenses-reminder-3')) { sendNotification('Record Expenses', 'Evening reminder to record expenses'); markNotif('expenses-reminder-3'); } if (target > 0 && revenue >= target && !notifSent('target-met')) { sendNotification('Daily Target Reached', `You have reached your daily target: ${formatNumber(revenue)} ${getCurrencySymbol()}`); markNotif('target-met'); } if (target > 0 && hour >= 20 && revenue < target && !notifSent('target-not-met-end')) { sendNotification('Day Ending — Target Not Met', `Reached ${Math.round((revenue/target)*100)}% of target. Keep pushing!`); markNotif('target-not-met-end'); } if (expenses > profit && !notifSent('expenses-over-profit')) { sendNotification('Expenses Exceed Profit', `Expenses: ${formatNumber(expenses)} ${getCurrencySymbol()} | Profit: ${formatNumber(profit)} ${getCurrencySymbol()}`); markNotif('expenses-over-profit'); } try { const inv = (window.state && window.state.inventory) || {}; const low = Object.keys(inv).filter(n => { const it = inv[n]||{}; const s = Number(it.stock||0); const m = Number(it.minAlert||0); return s <= m && m>0; }).slice(0,3); if (low.length && !notifSent('low-stock')){ sendNotification('Low Stock Alerts', `Low: ${low.join(', ')}`); markNotif('low-stock'); } } catch {} try { const unpaidCount = ((window.state && window.state.sales) || []).filter(s => String(s.status||'').toLowerCase()==='unpaid').length; if (unpaidCount>0 && hour>=12 && !notifSent('unpaid-reminder')){ sendNotification('Unpaid Sales', `${unpaidCount} unpaid entries need attention`); markNotif('unpaid-reminder'); } } catch {} if (hour>=21 && !notifSent('backup-reminder')) { sendNotification('Backup Reminder', 'Use the top nav Save (💾) button to back up your data'); markNotif('backup-reminder'); } } catch {} }
        function scheduleNotifications(){ try { evaluateNotifications(); setInterval(evaluateNotifications, 300000); } catch {} }
        try { window.addEventListener('load', scheduleNotifications); } catch {}
        function openNotificationsModal(){ const m = document.getElementById('notificationsModal'); if (!m) return; m.classList.add('show'); try { window.__updateModalOverflow && window.__updateModalOverflow(); } catch {} const handleOutside = function(e){ if (e.target === m) { closeNotificationsModal(); } }; m.addEventListener('click', handleOutside, { once: true }); }
        function closeNotificationsModal(){ const m = document.getElementById('notificationsModal'); if (m) m.classList.remove('show'); try { window.__updateModalOverflow && window.__updateModalOverflow(); } catch {} }
        function checkNotificationsOnStartup(){ if (!notificationsSupported()) return; if (!getNotificationsPref()) { closeNotificationsModal(); return; } const p = Notification.permission; if (p === 'granted') { closeNotificationsModal(); } else { openNotificationsModal(); } }
        try { window.addEventListener('load', checkNotificationsOnStartup); } catch {}

        async function downloadTenPercentReportPDF(mode = 'month', weeksCount = 1) {
            playTapSound();
            hapticShort();
            await ensureLogoReady();
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ unit: 'pt', format: 'a4' });
            const pageWidth = 595.28;
            const leftMargin = 50;
            const rightMargin = 24;
            const margin = leftMargin;
            const usableWidth = pageWidth - leftMargin - rightMargin;
            let y = 50;
            const centerX = pageWidth / 2;

            doc.setFillColor(240, 240, 240);
            doc.rect(0, 0, pageWidth, 100, 'F');
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(24);
            doc.setFont(undefined, 'bold');
            const profile = getUserProfileData();
            doc.text(profile.businessName, centerX, 45, { align: 'center' });
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            const contactLine = buildProfileContactLine(profile);
            if (contactLine) doc.text(contactLine, centerX, 70, { align: 'center' });
            doc.setFontSize(10);
            doc.setTextColor(0, 0, 0);
            doc.setFont(undefined, 'normal');
            const taxLine = buildProfileTaxLine(profile);
            if (taxLine) doc.text(taxLine, centerX, 90, { align: 'center' });
            doc.setDrawColor(150, 150, 150);
            doc.setLineWidth(3);
            doc.line(margin, 100, pageWidth - rightMargin, 100);

            const fmtMonthName = (yyyyMm) => {
                const [yStr, mStr] = yyyyMm.split('-');
                const y = parseInt(yStr, 10);
                const m = parseInt(mStr, 10) - 1;
                const d = new Date(y, m, 1);
                return d.toLocaleString('en-US', { month: 'long', year: 'numeric' });
            };

            const getYyyyMm = (dateStr) => {
                const d = new Date(dateStr);
                const y = d.getFullYear();
                const m = String(d.getMonth() + 1).padStart(2, '0');
                return `${y}-${m}`;
            };

            const todayStr = getTodayDateString();
            const lastWeeksStart = (w) => { const d = new Date(); const weeks = Math.max(1, parseInt(w, 10) || 1); d.setDate(d.getDate() - (weeks * 7)); return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`; };
            const monthStartStr = (() => { const d = new Date(); d.setDate(1); return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`; })();

            const inRange = (dateStr, startStr, endStr) => {
                const ds = new Date(dateStr).getTime();
                const s = new Date(startStr).getTime();
                const e = new Date(endStr).getTime();
                return ds >= s && ds <= e;
            };

            const sumProfitInRange = (startStr, endStr) => (state.sales || []).filter(s => s.date && inRange(s.date, startStr, endStr)).reduce((sum, s) => sum + (s.profit || 0), 0);
            const sumIncomeInRange = (startStr, endStr) => (state.income || []).filter(i => i.date && inRange(i.date, startStr, endStr)).filter(isIncomeIncludedInTithing).reduce((sum, i) => sum + (i.amount || 0), 0);

            y = 120;
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(18);
            doc.setFont(undefined, 'bold');
            doc.text("10% Report", margin, y);
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.setTextColor(100, 100, 100);

            let rangeLabel = '';
            if (mode === 'weeks') rangeLabel = `Last ${Math.max(1, parseInt(weeksCount, 10) || 1)} Weeks`;
            else if (mode === 'month') rangeLabel = 'Current Month';
            else rangeLabel = 'All (Monthly)';
            doc.text(`Generated: ${getTodayDateString()} | ${rangeLabel}`, margin, y + 20);
            y += 50;

            function drawTable(headers, rows, startY) {
                const colCount = headers.length;
                const colWidth = usableWidth / colCount;
                let curY = startY;
                const headerH = 22;
                doc.setFillColor(100, 100, 100);
                doc.roundedRect(margin, curY, usableWidth, headerH, 3, 3, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFont(undefined, 'bold');
                doc.setFontSize(10);
                for (let i = 0; i < colCount; i++) {
                    const txtX = margin + i * colWidth + 8;
                    doc.text(String(headers[i]), txtX, curY + 15);
                }
                curY += headerH + 2;
                doc.setFont(undefined, 'normal');
                doc.setFontSize(9);
                for (let r = 0; r < rows.length; r++) {
                    let maxLines = 1;
                    const cellLines = [];
                    for (let c = 0; c < colCount; c++) {
                        const txt = rows[r][c] === null || rows[r][c] === undefined ? '' : String(rows[r][c]);
                        const lines = doc.splitTextToSize(txt, colWidth - 16);
                        cellLines.push(lines);
                        if (lines.length > maxLines) maxLines = lines.length;
                    }
                    const lineH = 10;
                    const rowH = maxLines * lineH + 8;
                    if (curY + rowH > 750) { doc.addPage(); curY = margin; }
                    if (r % 2 === 0) {
                        doc.setFillColor(248, 249, 250);
                        doc.roundedRect(margin, curY, usableWidth, rowH, 2, 2, 'F');
                    }
                    doc.setTextColor(40, 40, 40);
                    for (let c = 0; c < colCount; c++) {
                        const txtX = margin + c * colWidth + 8;
                        const lines = cellLines[c];
                        for (let li = 0; li < lines.length; li++) {
                            doc.text(lines[li], txtX, curY + 15 + li * lineH);
                        }
                    }
                    curY += rowH;
                }
                return curY + 20;
            }

            if (mode === 'all') {
                const monthsSet = new Set();
                (state.sales || []).forEach(s => { if (s.date) monthsSet.add(getYyyyMm(s.date)); });
                (state.income || []).filter(isIncomeIncludedInTithing).forEach(i => { if (i.date) monthsSet.add(getYyyyMm(i.date)); });
                const months = Array.from(monthsSet).sort();
                const headers = ["Month", "Monthly Profit", "Monthly Income", "Monthly 10%"];
                const rows = months.map(ym => {
                    const profit = (state.sales || []).filter(s => s.date && getYyyyMm(s.date) === ym).reduce((sum, s) => sum + (s.profit || 0), 0);
                    const income = (state.income || []).filter(i => i.date && getYyyyMm(i.date) === ym).filter(isIncomeIncludedInTithing).reduce((sum, i) => sum + (i.amount || 0), 0);
                    const ten = (profit + income) * 0.1;
                    return [fmtMonthName(ym), `${formatNumber(profit)} Tsh`, `${formatNumber(income)} Tsh`, `${formatNumber(ten)} Tsh`];
                });
                y = drawTable(headers, rows, y);
            } else if (mode === 'weeks') {
                const w = Math.max(1, parseInt(weeksCount, 10) || 1);
                const headers = ["Week", "Profit", "Income", "10%"];
                const rows = [];
                const today = new Date();
                const dow = today.getDay(); // 0=Sun .. 6=Sat
                const mondayOffset = (dow + 6) % 7; // days since Monday
                const currentWeekStart = new Date(today);
                currentWeekStart.setDate(today.getDate() - mondayOffset);
                for (let i = w - 1; i >= 0; i--) {
                    const weekStart = new Date(currentWeekStart);
                    weekStart.setDate(currentWeekStart.getDate() - (i * 7));
                    const weekEnd = new Date(weekStart);
                    weekEnd.setDate(weekStart.getDate() + 6);
                    const startStr = `${weekStart.getFullYear()}-${String(weekStart.getMonth() + 1).padStart(2, '0')}-${String(weekStart.getDate()).padStart(2, '0')}`;
                    const endStr = `${weekEnd.getFullYear()}-${String(weekEnd.getMonth() + 1).padStart(2, '0')}-${String(weekEnd.getDate()).padStart(2, '0')}`;
                    const profit = sumProfitInRange(startStr, endStr);
                    const income = sumIncomeInRange(startStr, endStr);
                    const ten = (profit + income) * 0.1;
                    const label = `${startStr} to ${endStr}`;
                    rows.push([label, `${formatNumber(profit)} ${getCurrencySymbol()}`, `${formatNumber(income)} ${getCurrencySymbol()}`, `${formatNumber(ten)} ${getCurrencySymbol()}`]);
                }
                y = drawTable(headers, rows, y);
            } else {
                const profit = sumProfitInRange(monthStartStr, todayStr);
                const income = sumIncomeInRange(monthStartStr, todayStr);
                const ten = (profit + income) * 0.1;
                const headers = ["Period", "Profit", "Income", "10%"];
                const monthName = new Date().toLocaleString('en-US', { month: 'long', year: 'numeric' });
                const rows = [[monthName, `${formatNumber(profit)} ${getCurrencySymbol()}`, `${formatNumber(income)} ${getCurrencySymbol()}`, `${formatNumber(ten)} ${getCurrencySymbol()}`]];
                y = drawTable(headers, rows, y);
            }

            const filename = `TenPercent_Report_${getTodayDateString()}.pdf`;
            downloadPDFSafe(doc, filename);
        }

        function downloadExpensesReportCSV() {
            const headers = ['Date', 'Name', 'Category', 'Notes', 'Amount'];
            const rows = (state.expenses || []).sort((a, b) => Number(a.timestamp) - Number(b.timestamp)).map(e => [e.date, e.description, e.category, (e.comment || '').replace(/\n/g, ' '), e.amount || 0]);
            const total = rows.reduce((sum, r) => sum + (Number(r[4]) || 0), 0);
            const csv = [headers.join(','), ...rows.map(r => r.map(v => String(v).replace(/\n/g, ' ').replace(/,/g, ';')).join(',')), ['', '', '', 'Total', String(total)]].join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Expenses_Report_${getTodayDateString()}.csv`;
            a.rel = 'noopener';
            document.body.appendChild(a);
            a.click();
            setTimeout(() => { try { document.body.removeChild(a); URL.revokeObjectURL(url); } catch { } }, 0);
            showToast('CSV downloaded successfully!', 'success');
        }

        function downloadBackup() {
            playTapSound();
            hapticShort();
            exportData();
        }


        function openCleanupModal() {
            if (!currentUser) {
                showToast('You must be signed in to clean duplicates.', 'info');
                return;
            }
            const modal = document.getElementById('cleanupModal');
            modal.classList.add('show');
            const handleOutside = (e) => { if (e.target === modal) { closeCleanupModal(); } };
            modal.addEventListener('click', handleOutside, { once: true });
        }

        function closeCleanupModal() {
            document.getElementById('cleanupModal').classList.remove('show');
        }

        async function confirmCleanup() {
            closeCleanupModal();
            await cleanDuplicatesInSupabase();
        }

        async function cleanDuplicatesInSupabase() {
            if (!supabase || !currentUser) {
                showToast('You must be signed in before cleaning.', 'error');
                return;
            }

            showToast('🧹 Starting cleanup...', 'info');
            updateSyncIndicator('syncing');

            // Delegate to comprehensive cleaner (content-based + clear-and-push)
            try {
                const result = await cleanAllDuplicates();
                updateSyncIndicator('synced');
                showToast(`✅ Removed ${result.totalRemoved} duplicates!`, 'success');
            } catch (e) {
                console.error('Cleanup error:', e);
                updateSyncIndicator('synced');
                showToast('❌ Cleanup failed', 'error');
            }
        }

        function exportData(customMessage = null, customDurationMs = null) {
            const snapshot = buildOfflineSnapshot();
            const ownerId = (window.currentUser && window.currentUser.id) || (state.userProfile && state.userProfile.ownerId) || '';
            const data = Object.assign({
                owner_id: ownerId,
                user_id: ownerId,
                exportDate: new Date().toISOString(),
                version: '3.0'
            }, snapshot);
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            (function(){
                const nameRaw = (state.userProfile && state.userProfile.businessName) || (window.currentUser && window.currentUser.email) || 'user';
                const nameSan = String(nameRaw || 'user').toLowerCase().replace(/[^a-z0-9]+/gi, '_').replace(/^_+|_+$/g, '');
                a.download = `TUBA_backup_${nameSan || 'user'}.json`;
            })();
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast(customMessage || 'Data exported successfully!', 'success', null, null, customDurationMs || 3000);
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = async (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        const importOwnerId = String(data.owner_id || data.user_id || '').trim();
                        const currentOwnerId = String((window.currentUser && window.currentUser.id) || (state.userProfile && state.userProfile.ownerId) || '').trim();
                        if (importOwnerId && currentOwnerId && importOwnerId !== currentOwnerId) {
                            showToast('Import blocked: file belongs to another user.', 'error');
                            return;
                        }
                        const doMerge = async () => {
                            const prev = window.__suppressPinForImport;
                            window.__suppressPinForImport = true;
                            try {
                            // Merge arrays and deduplicate
                            state.products = deduplicateByContent([...(state.products || []), ...(data.products || [])], 'products');
                            state.sales = deduplicateByContent([...(state.sales || []), ...(data.sales || [])], 'sales');
                            state.expenses = deduplicateByContent([...(state.expenses || []), ...(data.expenses || [])], 'expenses');
                            state.customers = deduplicateByContent([...(state.customers || []), ...(data.customers || [])], 'customers');
                            state.invoices = deduplicateByContent([...(state.invoices || []), ...(data.invoices || [])], 'invoices');
                            state.notes = deduplicateByContent([...(state.notes || []), ...(data.notes || [])], 'notes');
                            state.transactions = deduplicateByContent([...(state.transactions || []), ...(data.transactions || [])], 'transactions');
                            state.unpaidEntries = deduplicateByContent([...(state.unpaidEntries || []), ...(data.unpaidEntries || [])], 'unpaid');

                            // Merge categories (set-based)
                            state.categories = Array.from(new Set([...(state.categories || []), ...((data.categories || []))]));

                            // Merge inventory by product name without overwriting local values
                            state.inventory = state.inventory || {};
                            const importedInventory = data.inventory || {};
                            Object.keys(importedInventory).forEach(name => {
                                if (!(name in state.inventory)) {
                                    state.inventory[name] = {
                                        stock: parseInt(importedInventory[name].stock) || 0,
                                        minAlert: parseInt(importedInventory[name].minAlert) || 5
                                    };
                                }
                            });

                            // Floats: merge per channel without overwriting
                            state.transactionFloats = state.transactionFloats || {};
                            const importedFloats = data.transactionFloats || {};
                            Object.keys(importedFloats).forEach(ch => {
                                if (!(ch in state.transactionFloats)) {
                                    state.transactionFloats[ch] = { initial: parseFloat(importedFloats[ch].initial) || 0, current: 0 };
                                }
                            });

                            // Targets: keep existing unless missing
                            if (state.dailyTarget == null) state.dailyTarget = data.dailyTarget || 0;
                            if (state.monthlyTarget == null) state.monthlyTarget = data.monthlyTarget || 0;

                            // Additional collections
                            state.receipts = deduplicateByContent([...(state.receipts || []), ...(data.receipts || [])], 'receipts');
                            state.loans = deduplicateByContent([...(state.loans || []), ...(data.loans || [])], 'loans');
                            state.assets = deduplicateByContent([...(state.assets || []), ...(data.assets || [])], 'assets');
                            state.maintenance = deduplicateByContent([...(state.maintenance || []), ...(data.maintenance || [])], 'maintenance');
                            state.auditLogs = deduplicateByContent([...(state.auditLogs || []), ...(data.auditLogs || [])], 'audit_logs');
                            if (Array.isArray(data.inventoryPurchases)) {
                                state.inventoryPurchases = deduplicateByContent([...(state.inventoryPurchases || []), ...data.inventoryPurchases], 'inventory_purchases');
                            }
                            if (Array.isArray(data.inventoryPurchaseCycles)) {
                                const existing = (state.inventoryPurchaseCycles || []).slice();
                                const incoming = data.inventoryPurchaseCycles.slice();
                                const byNumber = new Map(existing.map(c => [String(c.number), c]));
                                incoming.forEach(cy => { const k = String(cy.number); if (!byNumber.has(k)) byNumber.set(k, cy); });
                                state.inventoryPurchaseCycles = Array.from(byNumber.values());
                            }

                            // Tags and tithing
                            if (Array.isArray(data.tags)) {
                                state.tags = Array.from(new Set([...(state.tags || []), ...data.tags]));
                            }
                            if (data.tagColors) {
                                state.tagColors = Object.assign({}, data.tagColors, state.tagColors || {});
                            }
                            if (data.tithingRecords) {
                                state.tithingRecords = Object.assign({}, data.tithingRecords, state.tithingRecords || {});
                            }

                            // User profile and settings
                            if (data.userProfile) {
                                const up = data.userProfile || {};
                                const cur = state.userProfile || {};
                                state.userProfile = Object.assign({}, up, cur);
                            }
                            const s = data.settings || {};
                            if (s.currency_code && s.currency_symbol) { setCurrency(s.currency_code, s.currency_symbol); }
                            if (typeof s.default_tax_rate === 'number') state.defaultTaxRate = s.default_tax_rate;
                            if (s.cogs_method) state.cogsMethod = s.cogs_method;
                            if (typeof s.daily_target === 'number') state.dailyTarget = s.daily_target;
                            if (typeof s.monthly_target === 'number') state.monthlyTarget = s.monthly_target;

                            calculateFloatBalances();
                            saveData();
                            render();
                            showToast('Data imported and merged successfully!', 'success');

                            // If signed-in, upsert merged data to cloud in background
                            if (syncEnabled && currentUser) {
                                try { await clearAndPushAllData(true); } catch (e) { /* no-op */ }
                            }
                            } finally {
                                window.__suppressPinForImport = prev || false;
                            }
                        };
                        showConfirm('Import will MERGE with existing data (no overwrite). Continue?', doMerge);
                    } catch (error) {
                        showToast('Error importing file. Please check the file format.', 'error');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function updateHeaderDate() {
            const dateElement = document.getElementById('headerDate');
            if (!dateElement) return;

            const now = new Date();

            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');

            let hours = now.getHours();
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');

            const ampm = hours >= 12 ? 'PM' : 'AM';
            hours = hours % 12;
            hours = hours ? hours : 12; // Convert 0 to 12

            dateElement.innerHTML = `${year}-${month}-${day}<br>${hours}:${minutes}:${seconds} ${ampm}`;
        }

        function render() {
            let activeId = null, selStart = null, selEnd = null, activeValue = null;
            const app = document.getElementById('app');
            const pageScrollTop = (document.scrollingElement && document.scrollingElement.scrollTop) ? document.scrollingElement.scrollTop : (window.scrollY || 0);
            const appScrollTop = app ? app.scrollTop : null;
            const listScrollTops = Array.from(document.querySelectorAll('.list-scroll-container')).map(el => ({ top: el.scrollTop }));
            try {
                const ae = document.activeElement;
                const tag = (ae && ae.tagName) ? ae.tagName.toLowerCase() : '';
                if (tag === 'input' || tag === 'textarea') {
                    activeId = ae.id || null;
                    activeValue = ae.value;
                    try { selStart = ae.selectionStart; selEnd = ae.selectionEnd; } catch {}
                }

    try { if (!state.userProfile) state.userProfile = {}; if (!state.userProfile.ownerId && window.currentUser && window.currentUser.id) { state.userProfile.ownerId = window.currentUser.id; saveData(); } } catch {}
            } catch {}
            state.inlineEditSales = {};
            state.inlineEditTransactions = {};
            state.inlineEditProducts = {};
            state.inlineEditExpenses = {};
            state.inlineEditIncome = {};
            state.inlineEditCustomers = {};
            state.inlineEditCategories = {};
            state.inlineEditAssets = {};
            state.inlineEditMaintenance = {};
            state.editingNoteIndex = null;
            try { processPlannedPurchases(); } catch { }

            try { const today = getTodayDateString(); if (state.__lastDailyDate !== today) { state.__lastDailyDate = today; state.showSalesHistory = false; } } catch {}

            // Initialize tag system
            try {
                initTagColors();
                document.getElementById('tagsModalsContainer').innerHTML = renderTagsModal();
            } catch (e) { console.error('Tag initialization error:', e); }

            switch (state.activeTab) {
                case 'dashboard': app.innerHTML = renderDashboard(); break;
                case 'account': app.innerHTML = renderAccount(); break;
                case 'sales': app.innerHTML = renderSales(); setTimeout(() => { try { setupSalesHistoryCollapsed(); setupSalesVirtual(); } catch {} try { const sel = document.getElementById('saleProduct'); if (sel && state.currentSaleProductIndex != null && state.currentSaleProductIndex !== '') { sel.value = String(state.currentSaleProductIndex); updateSaleTotal(); } } catch {} try { if (!window.__salesBootScrollApplied) { const content = document.getElementById('app'); if (content) { try { content.scrollTop = 0; } catch {} } try { if (document.scrollingElement) document.scrollingElement.scrollTop = 0; } catch {} try { window.scrollTo(0, 0); } catch {} window.__salesBootScrollApplied = true; } } catch {} }, 0); break;
                case 'transactions': app.innerHTML = renderTransactions(); break;
                case 'loans': app.innerHTML = renderLoans(); break;
                case 'products': app.innerHTML = renderProducts(); break;
                case 'categories': app.innerHTML = renderCategories(); break;
                case 'income': app.innerHTML = renderIncome(); setTimeout(()=>{ try { setupIncomeVirtual(); } catch {} }, 0); break;
                case 'expenses': app.innerHTML = renderExpenses(); setTimeout(()=>{ try { setupExpensesVirtual(); } catch {} }, 0); break;
                case 'inventory': app.innerHTML = renderInventory(); break;
                case 'inventoryPurchases': app.innerHTML = renderInventoryTab(); break;
                case 'customers': app.innerHTML = renderCustomers(); break;
                case 'invoices': app.innerHTML = renderInvoices(); break;
                case 'analytics':
                    app.innerHTML = renderAnalytics();
                    createAnalyticsChart();
                    break;
                case 'unpaid': app.innerHTML = renderUnpaid(); break;
                case 'notes': app.innerHTML = renderNotes(); break;
                case 'assets': app.innerHTML = renderAssets(); break;
                case 'maintenance': app.innerHTML = renderMaintenance(); break;
            }
            try {
                if (activeId) {
                    const el = document.getElementById(activeId);
                    if (el && (el.tagName.toLowerCase() === 'input' || el.tagName.toLowerCase() === 'textarea')) {
                        el.value = activeValue || el.value;
                        el.focus();
                        try { if (selStart != null && selEnd != null) el.setSelectionRange(selStart, selEnd); } catch {}
                    }
                }
            } catch {}
            renderNav();
            updateSideNavActiveState();
            try { updateSideNavToolsVisibility(); } catch {}
            setTimeout(() => {
                try {
                    const lists = document.querySelectorAll('.list-scroll-container');
                    lists.forEach((el, i) => { const saved = listScrollTops[i]; if (saved) el.scrollTop = saved.top; });
                    if (app && appScrollTop != null) app.scrollTop = appScrollTop;
                    if (document.scrollingElement) document.scrollingElement.scrollTop = pageScrollTop;
                    else window.scrollTo(0, pageScrollTop);
                } catch {}
            }, 0);

            // Update all "Select All" checkboxes after render
            setTimeout(() => {
                updateSelectAllCheckbox('sales');
                updateSelectAllCheckbox('products');
                updateSelectAllCheckbox('expenses');
                updateSelectAllCheckbox('income');
                updateSelectAllCheckbox('customers');
                updateSelectAllCheckbox('transactions');
                updateSelectAllCheckbox('unpaidEntries');
            }, 0);
            try {
                document.querySelectorAll('.money-input').forEach(el => attachMoneyFormatter(el));
                if (state.activeTab === 'transactions') {
                    const ta = document.getElementById('transactionAmount');
                    if (ta) attachMoneyFormatter(ta);
                }
                try { document.querySelectorAll('form').forEach(f => { f.removeAttribute('data-sub-locked'); }); } catch {}
                const countInput = document.getElementById('bulkAddCount');
                const addBtn = document.getElementById('bulkAddButton');
                const updateLabel = () => {
                    const raw = countInput?.value;
                    const c = parseInt((raw || '').trim(), 10);
                    if (addBtn) addBtn.textContent = (raw && !isNaN(c) && c > 0) ? '+ Add Rows' : '+ Add Row';
                };
                if (countInput) {
                    countInput.addEventListener('input', updateLabel);
                    updateLabel();
                }
                Array.from(document.querySelectorAll('input[type="text"]:not(.money-input):not([data-nocap]), textarea:not([data-nocap])'))
                    .filter(el => el.type !== 'email')
                    .forEach(el => attachFirstWordCapitalizer(el));
                const dt = document.getElementById('dailyTarget');
                const mt = document.getElementById('monthlyTarget');
                dt && dt.addEventListener('blur', () => { try { setDailyTarget(); } catch { } });
                mt && mt.addEventListener('blur', () => { try { setMonthlyTarget(); } catch { } });
                if (state.activeTab === 'dashboard') {
                    setTimeout(() => { try { positionDashboardPrivacyButton(); } catch { } }, 0);
                }
                // Account page: manual country/city (no remote data)
                if (state.activeTab === 'expenses') { setupWindowVirtualList('expenses'); }
                if (state.activeTab === 'products') { setupWindowVirtualList('products'); }
                if (state.activeTab === 'categories') { setupWindowVirtualList('categories'); }
                if (state.activeTab === 'customers') { setupWindowVirtualList('customers'); }
                if (state.activeTab === 'notes') { setupWindowVirtualList('notes'); }
            } catch { }
            try {
                if (state.activeTab === 'transactions') {
                    const ta2 = document.getElementById('transactionAmount');
                    if (ta2) attachMoneyFormatter(ta2);
                }
            } catch { }
            try {
                if (state.activeTab === 'invoices' && state.activeInvoiceTab === 'invoice') {
                    setTimeout(() => {
                        try { toggleInvoiceCustomerInput(); } catch { }
                        try { calculateInvoiceSubtotal(); } catch { }
                    }, 0);
                }
            } catch { }
            try { adjustContentPadding(); } catch { }
            try { if (!state.__currencyAppliedOnce) { applyCurrencySymbols(); state.__currencyAppliedOnce = true; } } catch { }
            try { applyRoleGatingToUI(); } catch { }
            try { setupListScrollEdgeStop(); } catch {}
            try { if (state.activeTab === 'sales' && !window.__salesBootScrollApplied) { forceSalesViewportTop(); } } catch {}
        }

        function adjustContentPadding() {
            const content = document.getElementById('app');
            const header = document.querySelector('.header');
            const bottom = document.getElementById('bottomNav');
            const banner = document.getElementById('offlineBanner');
            const auth = document.getElementById('authBanner');
            if (!content) return;
            const bannerH = (banner && banner.style.display !== 'none') ? banner.offsetHeight : 0;
            const authH = (auth && auth.style.display !== 'none') ? auth.offsetHeight : 0;
            const gap = 8;
            const topH = (header ? header.offsetHeight : 70) + bannerH + authH + gap;
            const bottomGap = 8;
            const bottomH = (bottom ? bottom.offsetHeight : 90) + bottomGap;
            content.style.paddingTop = topH + 'px';
            content.style.scrollPaddingTop = topH + 'px';
            content.style.paddingBottom = bottomH + 'px';
            content.style.scrollPaddingBottom = bottomH + 'px';
            if (banner && header) banner.style.top = header.offsetHeight + 'px';
            if (auth && header) auth.style.top = (header.offsetHeight + (bannerH || 0)) + 'px';
        }
        function setupListScrollEdgeStop() {
            try {
                const nodes = document.querySelectorAll('.tags-scroll');
                nodes.forEach(node => {
                    if (node.__guarded) return;
                    node.__guarded = true;
                    try { node.style.touchAction = 'pan-x'; } catch {}
                    // Desktop wheel: translate vertical wheel to horizontal scroll and block page scroll
                    node.addEventListener('wheel', function (e) {
                        try {
                            const dx = e.deltaX || 0;
                            const dy = e.deltaY || 0;
                            const delta = Math.abs(dy) > Math.abs(dx) ? dy : dx;
                            node.scrollLeft += delta;
                            e.preventDefault();
                            e.stopPropagation();
                        } catch { }
                    }, { passive: false });
                    // Mobile touch: manually scroll horizontally and block propagation
                    let lastX = 0;
                    node.addEventListener('touchstart', function (e) {
                        try { lastX = (e.changedTouches && e.changedTouches[0] ? e.changedTouches[0].clientX : 0); } catch { lastX = 0; }
                        e.stopPropagation();
                    }, { passive: true });
                    node.addEventListener('touchmove', function (e) {
                        try {
                            const x = (e.changedTouches && e.changedTouches[0] ? e.changedTouches[0].clientX : lastX);
                            const dx = x - lastX;
                            lastX = x;
                            node.scrollLeft -= dx;
                            e.preventDefault();
                            e.stopPropagation();
                        } catch { }
                    }, { passive: false });
                    node.addEventListener('touchend', function (e) {
                        try { e.stopPropagation(); } catch { }
                    }, { passive: true });
                });
            } catch { }
        }

        function forceSalesViewportTop() {
            try {
                const content = document.getElementById('app');
                const reset = function() {
                    try { if (content) content.scrollTop = 0; } catch {}
                    try { if (document.scrollingElement) document.scrollingElement.scrollTop = 0; } catch {}
                    try { window.scrollTo(0, 0); } catch {}
                };
                reset();
                requestAnimationFrame(reset);
                setTimeout(reset, 50);
                setTimeout(reset, 120);
            } catch {}
        }

        function positionDashboardPrivacyButton() {
            const btn = document.getElementById('dashboardPrivacyToggleBtn');
            if (!btn || !btn.parentElement) return;
            const cards = btn.parentElement.querySelectorAll('div > .stat-card');
            if (!cards || cards.length < 4) return;
            const r1 = cards[0].getBoundingClientRect();
            const r2 = cards[1].getBoundingClientRect();
            const r3 = cards[2].getBoundingClientRect();
            const r4 = cards[3].getBoundingClientRect();
            const topRowBottom = Math.max(r1.bottom, r2.bottom);
            const secondRowTop = Math.min(r3.top, r4.top);
            const y = (topRowBottom + secondRowTop) / 2;
            const leftColRight = Math.max(r1.right, r3.right);
            const rightColLeft = Math.min(r2.left, r4.left);
            const x = (leftColRight + rightColLeft) / 2;
            const containerRect = btn.parentElement.getBoundingClientRect();
            btn.style.top = (y - containerRect.top) + 'px';
            btn.style.left = (x - containerRect.left) + 'px';
            btn.style.transform = 'translate(-50%, -50%)';
        }
        window.addEventListener('resize', () => { if (state.activeTab === 'dashboard') { try { positionDashboardPrivacyButton(); } catch { } } });

        function runFormattingTests() {
            const cases = [1000, 999999, 999999999, 0, -12345];
            let passed = 0;
            cases.forEach(n => {
                const s = formatMoney(n);
                const back = parseMoney(s);
                if (Math.round(back) === Math.round(n)) passed++;
            });
            showToast(`Formatting tests: ${passed}/${cases.length} passed`, passed === cases.length ? 'success' : 'error');
        }
        async function runTargetSyncTests() {
            if (!syncEnabled || !currentUser) { showToast('Sign in to run sync tests', 'info'); return; }
            const val = Math.floor(Math.random() * 1000000);
            await upsertOne('settings', { daily_target: val });
            const ok = await verifyCloudSettings('daily_target', val);
            showToast(`Cloud verify daily_target: ${ok ? 'OK' : 'FAIL'}`, ok ? 'success' : 'error');
        }
        window.addEventListener('keydown', function(e){
            try {
                const k = String(e.key || '').toLowerCase();
                if (e.ctrlKey && k === 's') { e.preventDefault(); exportData('Saved', 2000); }
                else if (e.ctrlKey && k === 'n') { e.preventDefault(); if (state.activeTab === 'sales') openQuickSaleNotesModal(); }
            } catch {}
        });

        // Side Navigation Functions
        function toggleSideNav() {
            try { hapticShort(); } catch (e) { }
            const sideNav = document.getElementById('sideNav');
            const overlay = document.getElementById('sideNavOverlay');
            const body = document.body;

            sideNav.classList.toggle('open');
            overlay.classList.toggle('show');
            try { window.__updateModalOverflow && window.__updateModalOverflow(); } catch (e) { }

            try { updateSideNavSoundButton(); } catch (e) { }
            try { updateSideNavThemeButton(); } catch (e) { }
            try { updateSideNavActiveState(); } catch (e) { }
        }

        function navigateToTab(tabId) {
            switchTab(tabId);
            toggleSideNav();
        }

        function updateSideNavActiveState() {
            const items = document.querySelectorAll('.side-nav-item');
            items.forEach(item => {
                item.classList.remove('active');
            });
            const activeItem = Array.from(items).find(item => {
                const onclick = item.getAttribute('onclick');
                return onclick && onclick.includes(`'${state.activeTab}'`);
            });
            if (activeItem) {
                activeItem.classList.add('active');
            }
        }
        function isDesktopMode(){
            try {
                const fine = window.matchMedia && window.matchMedia('(pointer: fine)').matches;
                const ua = navigator.userAgent || '';
                const mobile = /Mobi|Android|iPhone|iPad|iPod/i.test(ua);
                return !!fine && !mobile;
            } catch { return true; }
        }
        function updateSideNavToolsVisibility(){
            const show = !!window.__devToolsEnabled;
            const el1 = document.getElementById('sideNavCloudDiagnostics');
            const el2 = document.getElementById('sideNavSendTestAlert');
            const el3 = document.getElementById('quickTestBtn');
            if (el1) el1.style.display = show ? '' : 'none';
            if (el2) el2.style.display = show ? '' : 'none';
            if (el3) el3.style.display = show ? '' : 'none';
        }
        function toggleDeveloperMode(){
            window.__devToolsEnabled = !window.__devToolsEnabled;
            try { localStorage.setItem('tuba-dev-tools', window.__devToolsEnabled ? '1' : '0'); } catch {}
            updateSideNavToolsVisibility();
            try { showToast(window.__devToolsEnabled ? 'Developer tools visible' : 'Developer tools hidden', 'info'); } catch {}
        }
        function updateQuickButtonsState(){
            try {
                const themeBtn = document.getElementById('quickThemeBtn');
                const soundBtn = document.getElementById('quickSoundBtn');
                const pushBtn = document.getElementById('quickPushBtn');
                const prefsBtn = document.getElementById('quickPrefsBtn');
                if (themeBtn) themeBtn.classList.toggle('active', state.theme === 'dark');
                if (soundBtn) {
                    const on = !!state.soundEnabled;
                    soundBtn.classList.toggle('on', on);
                    soundBtn.classList.toggle('off', !on);
                }
                const pushEnabled = !!(state.pushEnabled || (localStorage.getItem('tuba-push-enabled') === '1'));
                if (pushBtn) {
                    pushBtn.classList.toggle('on', pushEnabled);
                    pushBtn.classList.toggle('off', !pushEnabled);
                }
                const pp = (state.pushPrefs || {});
                const anyPref = !!(pp.morning || pp.evening || pp.backup || pp.destructive);
                if (prefsBtn) prefsBtn.classList.toggle('active', anyPref);
            } catch {}
        }
        function toggleThemeQuick(){
            try {
                state.theme = (state.theme === 'dark') ? 'light' : 'dark';
                saveData();
                applyTheme();
                updateQuickButtonsState();
                showToast(state.theme === 'dark' ? 'Dark mode' : 'Light mode', 'info');
            } catch {}
        }
        async function togglePushQuick(){
            try {
                const enabled = !!(state.pushEnabled || (localStorage.getItem('tuba-push-enabled') === '1'));
                if (enabled) {
                    const reg = await navigator.serviceWorker.ready;
                    const sub = await reg.pushManager.getSubscription();
                    if (sub) {
                        try {
                            const info = sub.toJSON();
                            await sub.unsubscribe();
                            try { if (window.currentUser && window.supabase) { await supabase.from('push_subscriptions').delete().eq('user_id', window.currentUser.id).eq('endpoint', info.endpoint); } } catch {}
                        } catch {}
                    }
                    state.pushEnabled = false;
                    try { localStorage.setItem('tuba-push-enabled', '0'); } catch {}
                    showToast && showToast('Push disabled', 'info');
                } else {
                    await subscribeToPush();
                    state.pushEnabled = true;
                    try { localStorage.setItem('tuba-push-enabled', '1'); } catch {}
                    showToast && showToast('Push enabled', 'success');
                }
                updateQuickButtonsState();
            } catch {}
        }
        try {
            document.addEventListener('keydown', (e) => {
                const k = String(e.key || '').toLowerCase();
                if (e.ctrlKey && e.altKey && k === 't') {
                    if (!isDesktopMode()) return;
                    window.__devToolsEnabled = !window.__devToolsEnabled;
                    updateSideNavToolsVisibility();
                    const msg = window.__devToolsEnabled ? 'Developer tools visible' : 'Developer tools hidden';
                    try { showToast(msg, 'info'); } catch {}
                }
            });
        } catch {}

        // Initialize - OFFLINE FIRST
        (async function () {
            function wait(ms) { return new Promise(r => setTimeout(r, ms)); }

            // Step 1: Load local data immediately (offline-first)
            try { await hydrateStateFromIndexedDB(); } catch {}
            try { loadData(); } catch (e) {
                console.error('Error loading local data:', e);
                try { localStorage.removeItem('financeManagerData'); } catch {}
            }
            try {
                const sessionKey = 'tuba_session_active';
                const wasClosed = !sessionStorage.getItem(sessionKey);
                sessionStorage.setItem(sessionKey, '1');
                if (wasClosed) {
                    state.activeTab = 'sales';
                    saveData();
                }
            } catch {}
            try {
                state.searchPeriod = '';
                state.productSearch = '';
                state.categorySearch = '';
                state.customerSearch = '';
                state.stockSearch = '';
                state.invoiceSearch = '';
                state.transactionSearch = '';
            } catch {}
            try { (function normalizeDataCasingOnStartup(){ state.categories = Array.from(new Set((state.categories || []).map(toCategoryCase).filter(Boolean))); state.products = (state.products || []).map(function(p){ if (!p) return p; p.category = toCategoryCase(p.category || ''); return p; }); saveData(); })(); } catch {}
            try {
                if (!navigator.onLine) {
                    const hasLocal = ((state.products||[]).length || (state.sales||[]).length || (state.customers||[]).length || (state.expenses||[]).length || (state.income||[]).length);
                    if (!hasLocal) { await tryLoadOfflineSnapshot(); }
                }
                render(); console.log('✅ Loaded local data and rendered UI instantly');
                window.__uiRenderedOnce = true;
                try { window.__runDeferredAuthBootstrap && window.__runDeferredAuthBootstrap(); } catch {}
            } catch (e) {
                console.error('Initial render error:', e);
                try {
                    const app = document.getElementById('app');
                    if (app) app.innerHTML = '<div style="padding:16px;font-size:14px;">Loading...</div>';
                } catch {}
            }

            // Step 2: Update offline banner (delayed to ensure it's defined)
            setTimeout(() => {
                try {
                    window.updateOfflineBanner && window.updateOfflineBanner();
                    window.updateAuthBanner && window.updateAuthBanner();
                } catch (e) {
                    console.warn('Error updating banners:', e);
                }
            }, 100);

            // Step 3: Only attempt cloud sync if online
            async function attemptCloudSync() {
                try {
                    if (!navigator.onLine) {
                        syncEnabled = false;
                        updateSyncIndicator('offline');
                        try { window.setAuthRestoring && window.setAuthRestoring(false); } catch { }
                        try { window.updateOfflineBanner && window.updateOfflineBanner(); } catch { }
                        return;
                    }

                    if (window.supabase && window.supabase.createClient) {
                        initSupabase();
                        try { window.setAuthRestoring(true); } catch { }
                        let restoredOk = false;
                        try { restoredOk = await restoreSession(); } catch { restoredOk = false; }
                        try { window.setAuthRestoring(!!restoredOk); } catch { }
                        try {
                            const navEntry = (performance && performance.getEntriesByType) ? (performance.getEntriesByType('navigation') || [])[0] : null;
                            const isReload = !!(navEntry && navEntry.type === 'reload') || (!!performance && performance.navigation && performance.navigation.type === 1);
                            const ua = navigator.userAgent || navigator.vendor || window.opera;
                            const isIOSDevice = /iPad|iPhone|iPod/.test(ua) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
                            const force = sessionStorage.getItem('tuba_force_cloud_refresh') === '1';
                            const shouldForceCloudPull = force || isReload || isIOSDevice;

                            if (shouldForceCloudPull && currentUser) {
                                sessionStorage.removeItem('tuba_force_cloud_refresh');
                                const localHasData = (state.sales.length > 0 || state.products.length > 0);
                                showToast('Refreshing data from cloud...', 'info', null, null, 6000);
                                if (localHasData) { await smartMergeData(); } else { await pullDataFromSupabase(); }
                            } else {
                                await maybeAutoPullCloudData();
                            }
                        } catch { }
                        try { window.setAuthRestoring(false); } catch { }
                        return;
                    }

                    let tries = 0;
                    while (tries < 240 && navigator.onLine) {
                        await wait(100);
                        if (window.supabase && window.supabase.createClient) {
                            initSupabase();
                            try { window.setAuthRestoring(true); } catch { }
                            let restoredOk2 = false;
                            try { restoredOk2 = await restoreSession(); } catch { restoredOk2 = false; }
                            try { window.setAuthRestoring(!!restoredOk2); } catch { }
                            try {
                                const navEntry = (performance && performance.getEntriesByType) ? (performance.getEntriesByType('navigation') || [])[0] : null;
                                const isReload = !!(navEntry && navEntry.type === 'reload') || (!!performance && performance.navigation && performance.navigation.type === 1);
                                const ua = navigator.userAgent || navigator.vendor || window.opera;
                                const isIOSDevice = /iPad|iPhone|iPod/.test(ua) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
                                const force = sessionStorage.getItem('tuba_force_cloud_refresh') === '1';
                                const shouldForceCloudPull = force || isReload || isIOSDevice;

                                if (shouldForceCloudPull && currentUser) {
                                    sessionStorage.removeItem('tuba_force_cloud_refresh');
                                    const localHasData = (state.sales.length > 0 || state.products.length > 0);
                                    showToast('Refreshing data from cloud...', 'info', null, null, 6000);
                                    if (localHasData) { await smartMergeData(); } else { await pullDataFromSupabase(); }
                                } else {
                                    await maybeAutoPullCloudData();
                                }
                            } catch { }
                            try { window.setAuthRestoring(false); } catch { }
                            return;
                        }
                        tries++;
                    }
                    // Fallback: schedule another attempt if library loaded later
                    setTimeout(() => { if (navigator.onLine) attemptCloudSync(); }, 3000);
                } catch (e) {
                    console.warn('Cloud sync attempt failed:', e);
                }
            }

            // Attempt cloud sync in background
            attemptCloudSync();
            document.addEventListener('DOMContentLoaded', () => { try { attemptCloudSync(); } catch {} });
            window.attemptCloudSync = attemptCloudSync;
            try { window.__offlineWasDetected = window.__offlineWasDetected || !navigator.onLine; } catch {}

            // Re-attempt cloud sync when connection is restored
            window.addEventListener('online', async () => {
                try { window.updateOfflineBanner && window.updateOfflineBanner(); } catch { }
                try { window.updateAuthBanner && window.updateAuthBanner(); } catch { }
                try {
                    if (window.__offlineWasDetected) {
                        window.__offlineWasDetected = false;
                        try { window.__autoExportTriggered = false; } catch {}
                        try {
                            try { state.lastInteractionInProgress = false; } catch {}
                            try { render && render(); } catch {}
                            var b = document.querySelector('button[aria-label="Refresh"]');
                            if (b && typeof b.click === 'function') { b.click(); } else { refreshApp(); }
                        } catch { }
                        return;
                    }
                } catch { }
                await attemptCloudSync();
            });

            // Update banners when connection is lost
            window.addEventListener('offline', () => {
                try { window.updateOfflineBanner && window.updateOfflineBanner(); } catch { }
                try { window.__offlineWasDetected = true; } catch { }
                try {
                    if (!window.__autoExportTriggered) {
                        window.__autoExportTriggered = true;
                        var s = document.querySelector('button[title="💾"]');
                        if (s && typeof s.click === 'function') { s.click(); } else { exportData(); }
                    }
                } catch { }
            });

            // iOS Safari: ensure data/banners re-evaluate on bfcache restore
            window.addEventListener('pageshow', async (e) => {
                try { window.updateOfflineBanner && window.updateOfflineBanner(); } catch {}
                try { window.updateAuthBanner && window.updateAuthBanner(); } catch {}
                try {
                    if (navigator.onLine) {
                        await attemptCloudSync();
                    }
                } catch {}
            });
        })();

        // ============================================
        // TUBA SWIPE NAVIGATION v2.0
        // Enables left/right swipe with smooth transitions
        // ============================================

        (function () {
            console.log('👆 Initializing smooth swipe navigation...');

            let touchStartX = 0;
            let touchEndX = 0;
            let touchStartY = 0;
            let touchEndY = 0;
            let isSwiping = false;
            const SWIPE_THRESHOLD = 80; // Minimum swipe distance in pixels
            const VERTICAL_THRESHOLD = 50; // Maximum vertical movement to count as horizontal swipe

            // Platform detection for performance tuning
            const ua = navigator.userAgent || navigator.vendor || window.opera || '';
            const isIOS = /iPad|iPhone|iPod/.test(ua) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
            const isAndroid = /Android/i.test(ua);
            const prefersReducedMotion = (window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches) || false;
            const enableAnimations = !!(isIOS && !prefersReducedMotion);

            // Add performance-aware transition CSS
            const style = document.createElement('style');
            if (enableAnimations) {
                style.textContent = `
                    .content {
                        transition: opacity 0.25s ease, transform 0.25s cubic-bezier(0.4, 0, 0.2, 1);
                        will-change: opacity, transform;
                    }
                    .content.swipe-exit-left { opacity: 0; transform: translateX(-30px); }
                    .content.swipe-exit-right { opacity: 0; transform: translateX(30px); }
                    .content.swipe-enter-left { opacity: 0; transform: translateX(30px); }
                    .content.swipe-enter-right { opacity: 0; transform: translateX(-30px); }
                    .content.swipe-active { opacity: 1; transform: translateX(0); }
                    .bottom-nav { transition: transform 0.25s ease, background 0.25s ease; will-change: transform; }
                    .nav-item { transition: color 0.2s ease, background 0.2s ease, transform 0.2s ease; will-change: transform; }
                    .nav-item.active { transition: color 0.2s ease, background 0.2s ease, transform 0.2s ease; }
                `;
            } else {
                style.textContent = `
                    .content { transition: none !important; will-change: auto !important; }
                    .content.swipe-exit-left,
                    .content.swipe-exit-right,
                    .content.swipe-enter-left,
                    .content.swipe-enter-right,
                    .content.swipe-active { opacity: 1 !important; transform: none !important; }
                    .bottom-nav { transition: none !important; }
                    .nav-item { transition: none !important; will-change: auto !important; }
                    /* Chrome/Android performance: virtualize offscreen card rendering */
                    .card { content-visibility: auto; contain-intrinsic-size: 300px; }
                    /* Prevent scroll chaining causing flicker */
                    html, body { overscroll-behavior: contain; }
                `;
            }
            document.head.appendChild(style);

            // Get tab order from tabs array
            const tabOrder = tabs.map(t => t.id);

            function getCurrentTabIndex() {
                return tabOrder.indexOf(state.activeTab);
            }

            function switchToTabByIndexWithAnimation(index, direction) {
                if (index < 0 || index >= tabOrder.length || isSwiping) {
                    return;
                }

                isSwiping = true;
                const newTab = tabOrder[index];
                const content = document.querySelector('.content');

                if (!content || !enableAnimations) {
                    switchTab(newTab);
                    isSwiping = false;
                    return;
                }

                // Exit animation
                content.classList.remove('swipe-active', 'swipe-enter-left', 'swipe-enter-right');
                content.classList.add(direction === 'left' ? 'swipe-exit-left' : 'swipe-exit-right');

                // Switch tab after exit animation starts
                setTimeout(() => {
                    state.activeTab = newTab;
                    render();

                    // Enter animation
                    const newContent = document.querySelector('.content');
                    if (newContent) {
                        newContent.classList.remove('swipe-active');
                        newContent.classList.add(direction === 'left' ? 'swipe-enter-right' : 'swipe-enter-left');

                        // Force reflow
                        void newContent.offsetWidth;

                        // Activate
                        requestAnimationFrame(() => {
                            newContent.classList.remove('swipe-enter-left', 'swipe-enter-right');
                            newContent.classList.add('swipe-active');

                            setTimeout(() => {
                                isSwiping = false;
                            }, 300);
                        });
                    } else {
                        isSwiping = false;
                    }
                }, 150);

                console.log(`📱 Smooth swipe to: ${newTab}`);
            }

            function handleSwipe() {
                const swipeDistanceX = touchEndX - touchStartX;
                const swipeDistanceY = Math.abs(touchEndY - touchStartY);

                // Check if it's a horizontal swipe (not vertical)
                if (swipeDistanceY > VERTICAL_THRESHOLD) {
                    return;
                }

                const currentIndex = getCurrentTabIndex();

                if (swipeDistanceX > SWIPE_THRESHOLD) {
                    // Swipe right - go to previous tab
                    console.log('👉 Swipe right detected');
                    switchToTabByIndexWithAnimation(currentIndex - 1, 'right');
                } else if (swipeDistanceX < -SWIPE_THRESHOLD) {
                    // Swipe left - go to next tab
                    console.log('👈 Swipe left detected');
                    switchToTabByIndexWithAnimation(currentIndex + 1, 'left');
                }
            }

            // Add touch event listeners to the main content area
            const app = document.getElementById('app');
            if (!app) {
                console.error('❌ App element not found');
                return;
            }

            app.addEventListener('touchstart', (e) => {
                if (isSwiping) return;
                touchStartX = e.changedTouches[0].screenX;
                touchStartY = e.changedTouches[0].screenY;
            }, { passive: true });

            app.addEventListener('touchend', (e) => {
                if (isSwiping) return;
                touchEndX = e.changedTouches[0].screenX;
                touchEndY = e.changedTouches[0].screenY;
                handleSwipe();
            }, { passive: true });

            // Initialize content with active class
            setTimeout(() => {
                const content = document.querySelector('.content');
                if (content) {
                    content.classList.add('swipe-active');
                }
            }, 100);

            console.log('✅ Smooth swipe navigation initialized!');
            console.log('   👈 Swipe left = Next tab (smooth)');
            console.log('   👉 Swipe right = Previous tab (smooth)');
            console.log(`   📊 Tab order: ${tabOrder.join(' → ')}`);
        })();

        updateHeaderDate();

        // Load local data IMMEDIATELY - don't wait
        console.log('📱 Loading local data...');
        (async function(){ try { await hydrateStateFromIndexedDB(); } catch {} try { loadData(); } catch {} })();
        try { window.__restoreTabFromInteraction && window.__restoreTabFromInteraction(); } catch (e) { }
        try { window.__hydrateInvoiceDraft && window.__hydrateInvoiceDraft(); } catch (e) { }
        try { applyTheme(); } catch (e) { }
        try { render(); } catch (e) { }
        try { window.updateOfflineBanner && window.updateOfflineBanner(); } catch (e) { }
        try { window.updateAuthBanner && window.updateAuthBanner(); } catch (e) { }
        setTimeout(() => { try { ensureIDs(); normalizeLegacyBulkTimestamps(); saveData(); } catch { } }, 0);
        // Delay initial render until after session restore attempt
        (function setupBottomNavFastClick() {
            const nav = document.getElementById('bottomNav');
            if (!nav || nav.__fastSetup) return;
            nav.__fastSetup = true;
            const MOVE_PX = 10;
            const MAX_TAP_MS = 500;
            let tracking = false;
            let moved = false;
            let startX = 0;
            let startY = 0;
            let startTime = 0;
            let activeBtn = null;
            let activePointerId = null;

            function reset() {
                tracking = false;
                moved = false;
                startX = 0;
                startY = 0;
                startTime = 0;
                activeBtn = null;
                activePointerId = null;
            }

            function getNavBtn(target) {
                return target && target.closest && target.closest('.nav-item');
            }

            nav.addEventListener('pointerdown', (e) => {
                try {
                    if (e.pointerType !== 'touch') return;
                    const btn = getNavBtn(e.target);
                    if (!btn) return;
                    tracking = true;
                    moved = false;
                    startX = e.clientX;
                    startY = e.clientY;
                    startTime = performance.now();
                    activeBtn = btn;
                    activePointerId = e.pointerId;
                } catch { }
            }, true);

            nav.addEventListener('pointermove', (e) => {
                try {
                    if (!tracking || e.pointerId !== activePointerId) return;
                    const dx = Math.abs((e.clientX || 0) - startX);
                    const dy = Math.abs((e.clientY || 0) - startY);
                    if (dx > MOVE_PX || dy > MOVE_PX) moved = true;
                } catch { }
            }, true);

            nav.addEventListener('pointerup', (e) => {
                try {
                    if (!tracking || e.pointerId !== activePointerId) return;
                    const elapsed = performance.now() - startTime;
                    const isTap = !!activeBtn && !moved && elapsed <= MAX_TAP_MS;
                    nav.__blockNextClick = true;
                    const btn = activeBtn;
                    reset();
                    if (!isTap) return;
                    e.preventDefault();
                    e.stopImmediatePropagation();
                    const tabId = btn.getAttribute('data-tab');
                    if (!tabId) return;
                    try { switchTab(tabId); } catch { }
                } catch { reset(); }
            }, true);

            nav.addEventListener('pointercancel', () => {
                try { nav.__blockNextClick = true; } catch { }
                reset();
            }, true);

            nav.addEventListener('click', (e) => {
                try {
                    if (!nav.__blockNextClick) return;
                    nav.__blockNextClick = false;
                    e.preventDefault();
                    e.stopImmediatePropagation();
                } catch { }
            }, true);
        })();
        try { setupKeyboardDismiss(); } catch (e) { }



        // Update header date every second
        setInterval(() => {
            updateHeaderDate();
        }, 1000);

        // Auto-save every 15 seconds
        setInterval(() => {
            saveData();
        }, 15000);

        

        // ============================================
        // TUBA SALES ENHANCEMENT PATCH v1.0
        // Added: Dynamic Product & Category Creation
        // ============================================

        // Store original renderSales function
        const originalRenderSales = window.renderSales;

        // Override renderSales function
        window.renderSales = function () {
            const stats = getStats();

            // Filter sales based on search and filters
            let filteredSales = state.sales.slice();
            filteredSales = filteredSales.filter(s => !(s && s.deleted === true));

            if (state.searchPeriod) {
                const Period = state.searchPeriod.toLowerCase();
                filteredSales = filteredSales.filter(s =>
                    s.productName.toLowerCase().includes(Period) ||
                    s.customer.toLowerCase().includes(Period) ||
                    s.payment.toLowerCase().includes(Period)
                );
            }

            if (state.filterDateFrom) {
                filteredSales = filteredSales.filter(s => new Date(s.date) >= new Date(state.filterDateFrom));
            }

            if (state.filterDateTo) {
                filteredSales = filteredSales.filter(s => new Date(s.date) <= new Date(state.filterDateTo));
            }

            if (state.filterCustomer) {
                filteredSales = filteredSales.filter(s => s.customer === state.filterCustomer);
            }

            // Newest-first ordering by timestamp (fallback to date+time)
            try {
                filteredSales.sort((a, b) => {
                    const ta = Number(a.timestamp) || new Date(`${a.date} ${a.time}`).getTime() || 0;
                    const tb = Number(b.timestamp) || new Date(`${b.date} ${b.time}`).getTime() || 0;
                    return tb - ta;
                });
            } catch { }

            return `
        <div class="privacy-container">
            <button class="privacy-toggle-btn show" id="privacyToggleBtn" onclick="togglePrivacy()">
                ${state.privacyBlurred ? '🔒' : '🔓'}
            </button>

        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-bottom: 12px;">
            <div class="stat-card ${state.privacyBlurred ? 'privacy-blur' : ''}" style="padding: 12px;">
                <div class="stat-label" style="font-size: 10px;">AVAILABLE CAPITAL</div>
                <div class="stat-value" style="font-size: 16px;"> ${formatNumber(stats.availableCapital || 0)} Tsh</div>
                <div class="stat-subvalue" style="font-size: 10px;">Inventory spend: ${formatNumber(stats.inventorySpendTotal || 0)} Tsh</div>
                <div class="stat-subvalue" style="font-size: 10px;">Stock value: ${formatNumber(stats.inventoryStockValue || 0)} Tsh</div>
            </div>
            <div class="stat-card ${state.privacyBlurred ? 'privacy-blur' : ''}" style="padding: 12px;">
                <div class="stat-label" style="font-size: 10px;">TOTAL PROFIT</div>
                <div class="stat-value" style="font-size: 16px;"> ${formatNumber(stats.totalProfit)} Tsh</div>
            </div>
            <div class="stat-card ${state.privacyBlurred ? 'privacy-blur' : ''}" style="padding: 12px;">
                <div class="stat-label" style="font-size: 10px;">TODAY'S PROFIT</div>
                ${(() => {
                    const t = getTodayDateString(); const salesToday = (state.sales || []).filter(s => s.status !== 'unpaid' && s.date === t); const profitToday = salesToday.reduce((sum, s) => sum + (Number(s.profit) || ((Number(s.totalPrice) || 0) - (Number(s.totalCost) || 0))), 0); const expToday = (state.expenses || []).filter(e => e.date === t).reduce((sum, e) => sum + (Number(e.amount) || 0), 0); const capToday = salesToday.reduce((sum, s) => sum + (Number(s.totalCost) || 0), 0); return `
                <div class=\"stat-value\" style=\"font-size: 16px;\"> ${formatNumber(profitToday)} Tsh</div>
                <div class=\"stat-subvalue\" style=\"font-size: 10px;\">Expenses today: ${formatNumber(expToday)} Tsh</div>
                <div class=\"stat-subvalue\" style=\"font-size: 10px;\">Capital today: ${formatNumber(capToday)} Tsh</div>
                `;
                })()}
            </div>
            <div class="stat-card ${state.privacyBlurred ? 'privacy-blur' : ''}" style="padding: 12px;" onclick="openTithingModal()">
                ${(() => {
                    const curKey = getMonthKey(new Date()); const rec = ensureTithing(curKey); const due = rec.due || 0; const paid = rec.paid || 0; const remain = Math.max(0, due - paid); return `
                <div class=\"stat-label\" style=\"font-size: 10px;\">10% (MONTH)</div>
                <div class=\"stat-value\" style=\"font-size: 16px;\"> ${formatNumber(due)} Tsh</div>
                <div class=\"stat-subvalue\" style=\"font-size: 10px;\">Paid: ${formatNumber(paid)} Tsh | Remaining: ${formatNumber(remain)} Tsh</div>
                `;
                })()}
            </div>
        </div>
    </div>
        </div>
</div>
        ${(() => { const unpaidCount = (state.sales || []).filter(s => String(s.status || '').toLowerCase() === 'unpaid').length; return unpaidCount > 0 ? `<div class=\"alert-box\" style=\"margin-top:8px; cursor:pointer;\" onclick=\"openUnpaidSalesModal()\"><strong>Unpaid sales:</strong> ${unpaidCount} — Click to review</div>` : '' })()}

        <div class="card">
            <h2>Add Sale</h2>
            <div class="card-header-buttons">
                <button id="saleFormClearBtn" class="btn-small btn-secondary" style="${(state.currentSaleProductIndex !== '' && state.currentSaleProductIndex != null) ? 'display:inline-flex;' : 'display:none;'}" onclick="clearSaleForm()">Clear</button>
            </div>
            <form onsubmit="addSale(event)" onkeydown="handleSaleEnter(event)">
                <div class="form-group">
                    <label>Product/Service</label>
                    <select id="saleProduct" onchange="handleProductSelection()" required>
                        <option value="">-- Select Product/Service --</option>
                        <option class="opt-new" value="new" ${String(state.currentSaleProductIndex || '') === 'new' ? 'selected' : ''}>+ Add New Product/Service</option>
                        ${(() => {
                    const usage = {};
                    (state.sales || []).forEach(s => {
                        const k = String(s.productName || '');
                        const t = Number(s.timestamp) || 0;
                        if (!k) return;
                        const u = usage[k] = usage[k] || { last: 0, count: 0 };
                        u.last = Math.max(u.last, t);
                        u.count += 1;
                    });
                    const entries = (state.products || []).map((p, i) => {
                        const u = usage[p.name] || { last: 0, count: 0 };
                        return { p, i, last: u.last, count: u.count };
                    });
                    entries.sort((a, b) => {
                        if (b.last !== a.last) return b.last - a.last;
                        if (b.count !== a.count) return b.count - a.count;
                        return String(a.p.name).localeCompare(String(b.p.name));
                    });
                    return entries.map(({ p, i }) => {
                        const stockVal = (state.inventory[p.name] || { stock: 0 }).stock;
                        const label = (p.hasStock === false)
                            ? `${p.name} - ${p.category}`
                            : `${p.name} - ${p.category} (Stock: ${stockVal})`;
                        const selected = String(state.currentSaleProductIndex || '') === String(i) ? 'selected' : '';
                        return `<option value="${i}" ${selected}>${label}</option>`;
                    }).join('');
                })()}
                    </select>
                </div>
                
                <div id="newProductFields" style="${String(state.currentSaleProductIndex || '') === 'new' ? 'display:block;' : 'display:none;'}">
                    <div class="form-group bulk-row" style="display:flex; gap:8px; align-items:end;">
                        <div style="flex:1;">
                            <label>Item Type</label>
                            <select id="newProductType" onchange="toggleNewProductType(); try { state.saleNewProductType = this.value; saveData(); } catch {}">
                                <option value="product" ${String(state.saleNewProductType || 'product') === 'product' ? 'selected' : ''}>Product (has stock)</option>
                                <option value="service" ${String(state.saleNewProductType || 'product') === 'service' ? 'selected' : ''}>Service (no stock)</option>
                            </select>
                        </div>
                        <div style="flex:2;">
                            <label>New Product Name</label>
                            <input type="text" id="newProductName" placeholder="Enter product name" value="${(state.saleNewProductForm && state.saleNewProductForm.name) || ''}" oninput="try { state.saleNewProductForm = state.saleNewProductForm || {}; state.saleNewProductForm.name = this.value; saveData(); } catch {}">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Category</label>
                        <select id="newProductCategory" onchange="handleCategorySelection()">
                            <option value="">-- Select Category --</option>
                            <option class="opt-new" value="new" ${String(state.currentNewProductCategory || '') === 'new' ? 'selected' : ''}>+ Add New Category</option>
                            ${state.categories.slice().sort((a, b) => String(a).localeCompare(String(b))).map(c => `<option value="${c}" ${String(state.currentNewProductCategory || '') === String(c) ? 'selected' : ''}>${c}</option>`).join('')}
                        </select>
                    </div>
                    
                    <div id="newCategoryField" style="${String(state.currentNewProductCategory || '') === 'new' ? 'display:block;' : 'display:none;'}">
                        <div class="form-group">
                            <label>New Category Name</label>
                            <input type="text" id="newCategoryName" placeholder="Enter category name" value="${(state.saleNewProductForm && state.saleNewProductForm.newCategoryName) || ''}" oninput="try { state.saleNewProductForm = state.saleNewProductForm || {}; state.saleNewProductForm.newCategoryName = this.value; saveData(); } catch {}">
                        </div>
                    </div>

                    
                    
                    <div class="form-group" id="newProductStockGroup">
                        <label>Cost (Capital)</label>
                        <input type="text" id="newProductCost" class="money-input" placeholder="0" value="${(state.saleNewProductForm && state.saleNewProductForm.cost) || ''}" oninput="try { state.saleNewProductForm = state.saleNewProductForm || {}; state.saleNewProductForm.cost = this.value; saveData(); } catch {}">
                    </div>
                    <div class="form-group">
                        <label>Price (Selling)</label>
                        <input type="text" id="newProductPrice" class="money-input" placeholder="0" value="${(state.saleNewProductForm && state.saleNewProductForm.price) || ''}" oninput="try { state.saleNewProductForm = state.saleNewProductForm || {}; state.saleNewProductForm.price = this.value; saveData(); } catch {}">
                    </div>
                    <div class="form-group" id="newProductInitialStockGroup" style="${String(state.saleNewProductType || 'product') === 'service' ? 'display:none;' : 'display:block;'}">
                        <label>Initial Stock</label>
                        <input type="text" id="newProductStock" class="money-input" placeholder="0" value="${(state.saleNewProductForm && state.saleNewProductForm.stock) || '0'}" oninput="try { state.saleNewProductForm = state.saleNewProductForm || {}; state.saleNewProductForm.stock = this.value; saveData(); } catch {}">
                    </div>
                    <button type="button" class="btn-success" onclick="saveNewProductFromSales()" style="margin-bottom: 12px;">
                        ✅ Save New Product
                    </button>
                    <button type="button" class="btn-secondary" onclick="cancelNewProduct()" style="margin-bottom: 12px;">
                        ✖ Cancel
                    </button>
                </div>

                <div class="form-group">
                    <label>Customer</label>
                    <select id="saleCustomer" onchange="toggleCustomerInput(); updateSaleTotal()">
                        <option value="">-- Walk-in --</option>
                        <option value="new" ${String(state.currentSaleCustomerIndex || '') === 'new' ? 'selected' : ''}>+ Add New Customer</option>
                        ${state.customers.map((c, i) => `<option value="${i}" ${String(state.currentSaleCustomerIndex || '') === String(i) ? 'selected' : ''}>${c.name}</option>`).join('')}
                    </select>
                </div>
                <div id="newCustomerFields" style="${String(state.currentSaleCustomerIndex || '') === 'new' ? 'display:block;' : 'display:none;'}">
                    <div class="form-group">
                        <label>New Customer Name</label>
                        <input type="text" id="newCustomerName" placeholder="Enter customer name" value="${(state.saleNewCustomerForm && state.saleNewCustomerForm.name) || ''}" oninput="try { state.saleNewCustomerForm = state.saleNewCustomerForm || {}; state.saleNewCustomerForm.name = this.value; saveData(); } catch {}">
                    </div>
                    <div class="form-group">
                        <label>Phone (Optional)</label>
                        <input type="tel" id="newCustomerPhone" placeholder="+255..." value="${(state.saleNewCustomerForm && state.saleNewCustomerForm.phone) || ''}" oninput="try { state.saleNewCustomerForm = state.saleNewCustomerForm || {}; state.saleNewCustomerForm.phone = this.value; saveData(); } catch {}">
                    </div>
                </div>
                <div class="form-group">
                    <label>Quantity</label>
                    <input type="text" id="saleQuantity" class="money-input" value="1" onchange="updateSaleTotal()" onfocus="this.value='';" onblur="(function(el){ var v=parseMoney(el.value); if (!String(el.value||'').trim() || isNaN(v) || v<1) el.value='1'; })(this); updateSaleTotal();" required>
                </div>
                <div class="form-group">
                    <label>Payment Method</label>
                    <select id="salePayment" onchange="updateSaleTotal()">
                        <option>Cash</option>
                        <option>Card</option>
                        <option>Mobile Money</option>
                        <option>M-Pesa Lipa Number</option>
                        <option>Bank Transfer</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select id="saleStatus">
                        <option value="paid" selected>Paid</option>
                        <option value="unpaid">Unpaid</option>
                    </select>
                </div>
                <div id="saleInfo" style="display:none;"></div>
                <button type="submit">Record Sale</button>
            </form>
        </div>

        <div class="card">
            <h2>Recent Sales (${filteredSales.length})</h2>
            
            <div class="search-box">
                <input type="text" id="salesSearchInput" placeholder="🔍 Search sales..." oninput="updateSearchPeriod(this.value)" value="${state.searchPeriod || ''}">
            </div>

            <div class="filter-row">
                <div class="form-group">
                    <label>From...</label>
                    <input type="date" onchange="updateFilterDateFrom(this.value)" value="${state.filterDateFrom || ''}" placeholder="mm/dd/yyyy">
                </div>
                <div class="form-group">
                    <label>To...</label>
                    <input type="date" onchange="updateFilterDateTo(this.value)" value="${state.filterDateTo || ''}" placeholder="mm/dd/yyyy">
                </div>
                <div class="form-group">
                    <label>Customer</label>
                    <select onchange="updateFilterCustomer(this.value)">
                        <option value="">All Customers</option>
                        ${[...new Set(state.sales.map(s => s.customer))].map(c =>
                    `<option value="${c}" ${state.filterCustomer === c ? 'selected' : ''}>${c}</option>`
                ).join('')}
                    </select>
                </div>
                <button class="btn-small btn-secondary" onclick="clearFilters()" title="Clear">Clear</button>
                <button class="btn-small" onclick="scrollToSalesHistory()" title="History">History</button>
            </div>

            ${(() => {
                    const arr = filteredSales.slice();
                    const count = (state.listShowCount && state.listShowCount.sales) ? state.listShowCount.sales : 3;
                    const bulk = `
                <div class="bulk-actions">
                    <input type="checkbox" id="selectAll_sales" onchange="toggleSelectAll('sales')" class="checkbox-select">
                    <label for="selectAll_sales">Select All</label>
                    <span style="color: #666; font-size: 12px; margin-left: 8px;">${getSelectedCount('sales')} selected</span>
                    <button class="btn-small btn-danger" onclick="bulkDelete('sales')" ${!hasSelected('sales') ? 'disabled' : ''}>🗑️ Delete Selected</button>
                </div>`;
                    const items = arr.slice(0, count).map((s) => `
                    <div class="item">
                        <div style="display: flex; gap: 12px; align-items: start;">
                            <input type="checkbox" class="checkbox-select" ${state.selectedItems.sales && state.selectedItems.sales[s.id] ? 'checked' : ''} onchange="toggleSelect('sales', '${s.id}')">
                            <div style="flex: 1;">
                                <div class="item-header">
                                    <span class="item-title">${s.productName} ${(s.status === 'unpaid') ? '<span class=\"badge badge-danger\">Unpaid</span>' : ''}</span>
                                    <span style="color: #2e7d32; font-weight: 700;"><span class="money-text"> ${formatNumber(s.profit)} Tsh</span></span>
                                </div>
                                ${(() => {
                            const editing = state.inlineEditSales && state.inlineEditSales[s.timestamp]; return editing ? `
                                <div class=\"form-group\" data-label=\"Qty\"><input type=\"text\" id=\"saleQty_${s.timestamp}\" class=\"money-input\" value=\"${s.quantity}\" placeholder=\"Qty\"></div>
                                <div class=\"form-group\" data-label=\"Price\"><input type=\"text\" id=\"salePrice_${s.timestamp}\" class=\"money-input\" value=\"${s.pricePerUnit}\" placeholder=\"Price per unit\"></div>
                                <div class=\"form-group\"><select id=\"salePay_${s.timestamp}\"><option ${s.payment === 'Cash' ? 'selected' : ''}>Cash</option><option ${s.payment === 'Card' ? 'selected' : ''}>Card</option><option ${s.payment === 'Mobile Money' ? 'selected' : ''}>Mobile Money</option><option ${s.payment === 'Bank Transfer' ? 'selected' : ''}>Bank Transfer</option></select></div>
                                ` : `
                                <div class=\"item-subtitle\">${s.date} ${s.time}<br>${s.customer} | Qty: ${s.quantity} | ${s.payment}<br>Cost: <span class=\"money-text\">${formatNumber(s.totalCost)} Tsh</span> | Price: <span class=\"money-text\">${formatNumber(s.totalPrice)} Tsh</span></div>
                                `;
                        })()}
                                <div class="flex-gap" style="margin-top:8px;">
                                    <button class="btn-small btn-receipt" style="background: linear-gradient(145deg, #ffeb3b, #fbc02d); color: #333;" onclick="downloadSaleReceiptPDF(${s.timestamp})">📄 Receipt</button>
                                    ${state.inlineEditSales && state.inlineEditSales[s.timestamp] ? `<button class=\"btn-small btn-success\" type=\"button\" onclick=\"saveSaleInlineEdit(${s.timestamp})\">Save</button><button class=\"btn-small btn-secondary\" type=\"button\" onclick=\"toggleSaleInlineEdit(${s.timestamp})\">Cancel</button>` : `<button class=\"btn-small\" type=\"button\" onclick=\"toggleSaleInlineEdit(${s.timestamp})\">Edit</button>`}
                                    <button class="btn-small" type="button" onclick="copySaleByTimestamp(${s.timestamp})">📋 Copy</button>
                                    <button class="btn-small btn-danger btn-delete" data-action="delete" onclick="event.stopPropagation(); deleteSaleByTimestamp(${s.timestamp})">Delete</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('') || '<p style="text-align: center; color: #666;">No sales found</p>';
                    const total = arr.length;
                    const hasMore = count < total;
                    const moreBtn = `<div class=\"flex-gap\" style=\"justify-content:center;margin:8px 0;flex-wrap:nowrap;\"><button class=\"collapse-btn\" onclick=\"${hasMore ? `showMoreList('sales')` : `collapseList('sales')`}\"><span class=\"collapse-icon ${hasMore ? '' : 'expanded'}\">▼</span><span>${hasMore ? 'See more' : 'Hide'}</span></button><button class=\"collapse-btn\" onclick=\"showAllList('sales')\"><span class=\"collapse-icon\">▼</span><span>Show all</span></button></div>`;
                    const showHistory = arr.length > 50;
                    const historyItems = showHistory ? arr.slice(50).map((s) => `
                        <div class=\"item\">
                            <div class=\"item-header\">
                                <span class=\"item-title\">${s.productName} ${(s.status === 'unpaid') ? '<span class\\"badge badge-danger\\">Unpaid</span>' : ''}</span>
                                <span style=\"color: #2e7d32; font-weight: 700;\"><span class=\"money-text\"> ${formatNumber(s.profit)} Tsh</span></span>
                            </div>
                            <div class=\"item-subtitle\">${s.date} ${s.time}<br>${s.customer} | Qty: ${s.quantity} | ${s.payment}<br>Cost: <span class=\"money-text\">${formatNumber(s.totalCost)} Tsh</span> | Price: <span class=\"money-text\">${formatNumber(s.totalPrice)} Tsh</span></div>
                            ${renderTagBadges(s)}
                        </div>
                    `).join('') : '';
                    const historyCard = showHistory ? `
                        <div class=\"card\" id=\"salesHistoryCard\">
                            <h2>Sales History (${Math.max(0, arr.length - 50)})</h2>
                            <div id=\"salesHistoryContent\" class=\"list-scroll-container\">${historyItems}</div>
                        </div>
                    ` : '';
                return bulk + items + moreBtn + historyCard;
            })()}
        </div>
    `;
        };

        // New function: Handle product selection
        window.handleProductSelection = function () {
            const select = document.getElementById('saleProduct');
            const newFields = document.getElementById('newProductFields');
            const infoDiv = document.getElementById('saleInfo');
            const clearBtn = document.getElementById('saleFormClearBtn');

            if (select && newFields) {
                const v = String(select.value || '');
                try { state.currentSaleProductIndex = v; saveData(); } catch {}
                if (v === '') {
                    if (infoDiv) { try { infoDiv.innerHTML = ''; infoDiv.style.display = 'none'; } catch {} }
                    newFields.style.display = 'none';
                    if (clearBtn) clearBtn.style.display = 'none';
                    return;
                }
                if (v === 'new') {
                    newFields.style.display = 'block';
                    if (clearBtn) clearBtn.style.display = 'inline-flex';
                    const typeEl = document.getElementById('newProductType');
                    const stockGroup = document.getElementById('newProductInitialStockGroup');
                    if (typeEl && stockGroup) {
                        try { typeEl.value = String(state.saleNewProductType || 'product'); } catch {}
                        stockGroup.style.display = (typeEl.value === 'service') ? 'none' : 'block';
                    }
                    const catSel = document.getElementById('newProductCategory');
                    const catField = document.getElementById('newCategoryField');
                    if (catSel && catField) {
                        const cur = String(state.currentNewProductCategory || '');
                        catField.style.display = (cur === 'new' || catSel.value === 'new') ? 'block' : 'none';
                    }
                    if (infoDiv) { try { infoDiv.innerHTML = ''; infoDiv.style.display = 'none'; } catch {} }
                } else {
                    newFields.style.display = 'none';
                    if (clearBtn) clearBtn.style.display = 'inline-flex';
                    if (infoDiv) { try { infoDiv.style.display = ''; } catch {} }
                    updateSaleTotal();
                }
            }
        };

        // New function: Handle category selection in new product form
        window.handleCategorySelection = function () {
            const select = document.getElementById('newProductCategory');
            const newCategoryField = document.getElementById('newCategoryField');

            if (select && newCategoryField) {
                try { state.currentNewProductCategory = select.value || ''; saveData(); } catch {}
                if (select.value === 'new') {
                    newCategoryField.style.display = 'block';
                } else {
                    newCategoryField.style.display = 'none';
                }
            }
        };

        window.renderSales = function(){ const stats=getStats(); let filteredSales=state.sales.slice(); filteredSales = filteredSales.filter(s => !(s && s.deleted === true)); if(state.searchPeriod){ const q=state.searchPeriod.toLowerCase(); filteredSales=filteredSales.filter(s=> s.productName.toLowerCase().includes(q)|| s.customer.toLowerCase().includes(q)|| s.payment.toLowerCase().includes(q)); } if(state.filterDateFrom){ filteredSales=filteredSales.filter(s=> new Date(s.date) >= new Date(state.filterDateFrom)); } if(state.filterDateTo){ filteredSales=filteredSales.filter(s=> new Date(s.date) <= new Date(state.filterDateTo)); } if(state.filterCustomer){ filteredSales=filteredSales.filter(s=> s.customer===state.filterCustomer); } try{ filteredSales.sort((a,b)=>{ const ta=Number(a.timestamp)|| new Date(`${a.date} ${a.time}`).getTime()||0; const tb=Number(b.timestamp)|| new Date(`${b.date} ${b.time}`).getTime()||0; return tb-ta; }); }catch{} state.lastFilteredSales = filteredSales; const count=(state.listShowCount && state.listShowCount.sales)? state.listShowCount.sales:3; const items = filteredSales.slice(0,count).map((s)=> `<div class="item"><div class="item-header"><span class="item-title">${s.productName} ${(s.status==='unpaid')?'<span class=\"badge badge-danger\">Unpaid</span>':''}</span><span style="color:#2e7d32;font-weight:700;"> ${formatNumber(s.profit)} Tsh</span></div><div class="item-subtitle">${s.date} ${s.time}<br>${s.customer} | Qty: ${s.quantity} | ${s.payment}<br>Cost: ${formatNumber(s.totalCost)} | Price: ${formatNumber(s.totalPrice)}</div></div>`).join('') || '<p style="text-align:center;color:#666;">No sales found</p>'; const total = filteredSales.length; const hasMore = count < total; const moreBtn = `<div class="flex-gap" style="justify-content:center;margin:8px 0;flex-wrap:nowrap;"><button class="collapse-btn" onclick="${hasMore ? `showMoreList('sales')` : `collapseList('sales')`}"><span class="collapse-icon ${hasMore ? '' : 'expanded'}">▼</span><span>${hasMore ? 'See more' : 'Hide'}</span></button><button class="collapse-btn" onclick="showAllList('sales')"><span class="collapse-icon">▼</span><span>Show all</span></button></div>`; const historyCount = Math.max(0, filteredSales.length - 50); const historyControls = historyCount ? `<div class="flex-gap" style="justify-content:flex-end;margin:4px 0;flex-wrap:nowrap;"><button class="collapse-btn" onclick="loadSalesHistory()"><span class="collapse-icon">▼</span><span>Load history</span></button><button class="collapse-btn" onclick="collapseSalesHistory()"><span class="collapse-icon">▼</span><span>Hide</span></button><button class="collapse-btn" onclick="showAllSalesHistory()"><span class="collapse-icon">▼</span><span>Show all</span></button></div>` : ''; const historyCard = historyCount ? `<div class="card" id="salesHistoryCard"><h2>Sales History (${historyCount})</h2>${historyControls}<div id="salesHistoryContent" class="list-scroll-container"></div></div>` : ''; return `<div class="card"><h2>Recent Sales (${filteredSales.length})</h2><div class="search-box"><input type="text" placeholder="🔍 Search sales..." oninput="updateSearchPeriod(this.value)"></div><div class="list-scroll-container">${items}</div>${moreBtn}${historyCard}</div>`; };
        window.loadSalesHistory = function(){ try { const el=document.getElementById('salesHistoryContent'); if(!el) return; const arr=(state.lastFilteredSales||state.sales||[]).slice(); const arr2=arr.filter(s=> !(s && s.deleted===true)); if(!el.dataset.populated){ const html = arr2.slice(51).map(function(s){ const statusBadge=(s.status==='unpaid')?'<span class="badge badge-danger">Unpaid</span>':''; return `<div class="item"><div class="item-header"><span class="item-title">${s.productName} ${statusBadge}</span><span style="color:#2e7d32;font-weight:700;"><span class="money-text"> ${formatNumber(s.profit)} Tsh</span></span></div><div class="item-subtitle">${s.date} ${s.time}<br>${s.customer} | Qty: ${s.quantity} | ${s.payment}<br>Cost: <span class="money-text">${formatNumber(s.totalCost)} Tsh</span> | Price: <span class="money-text">${formatNumber(s.totalPrice)} Tsh</span></div>${renderTagBadges(s)}</div>`; }).join(''); el.innerHTML = html; el.dataset.populated='1'; } el.style.display='block'; state.salesHistoryLoaded=true; } catch(e){} };
        window.collapseSalesHistory = function(){ try { const el=document.getElementById('salesHistoryContent'); if(el) el.style.display='none'; state.salesHistoryLoaded=false; state.salesHistoryShowAll=false; } catch(e){} };
        window.showAllSalesHistory = function(){ try { const el=document.getElementById('salesHistoryContent'); if(!el) return; const arr=(state.lastFilteredSales||state.sales||[]).slice(); const arr2=arr.filter(s=> !(s && s.deleted===true)); const html = arr2.slice(51).map(function(s){ const statusBadge=(s.status==='unpaid')?'<span class="badge badge-danger">Unpaid</span>':''; return `<div class="item"><div class="item-header"><span class="item-title">${s.productName} ${statusBadge}</span><span style="color:#2e7d32;font-weight:700;"><span class="money-text"> ${formatNumber(s.profit)} Tsh</span></span></div><div class="item-subtitle">${s.date} ${s.time}<br>${s.customer} | Qty: ${s.quantity} | ${s.payment}<br>Cost: <span class="money-text">${formatNumber(s.totalCost)} Tsh</span> | Price: <span class="money-text">${formatNumber(s.totalPrice)} Tsh</span></div>${renderTagBadges(s)}</div>`; }).join(''); el.innerHTML = html; el.dataset.populated='1'; el.style.display='block'; state.salesHistoryShowAll=true; } catch(e){} };

        window.setupSalesHistoryCollapsed = function(){ try { const card=document.getElementById('salesHistoryCard'); if(!card) return; const h2=card.querySelector('h2'); if(h2 && !document.getElementById('salesHistoryControls')){ const controls=document.createElement('div'); controls.id='salesHistoryControls'; controls.className='flex-gap'; controls.style.cssText='justify-content:center;margin:8px 0;flex-wrap:nowrap;'; controls.innerHTML = `<button class="collapse-btn" onclick="loadSalesHistory()" title="▼See more"><span class="collapse-icon">▼</span><span>See more</span></button><button class="collapse-btn" onclick="showAllSalesHistory()" title="▼Show all"><span class="collapse-icon">▼</span><span>Show all</span></button><button class="collapse-btn" onclick="collapseSalesHistory()" title="▼Hide"><span class="collapse-icon">▼</span><span>Hide</span></button>`; h2.parentNode.insertBefore(controls, h2.nextSibling); }
            let content=card.querySelector('#salesHistoryContent'); if(!content){ content=document.createElement('div'); content.id='salesHistoryContent'; content.classList.add('list-scroll-container'); content.style.display='none'; card.appendChild(content); } else { try { content.classList.add('list-scroll-container'); } catch {} }
            const items=Array.from(card.querySelectorAll('.item'));
            if(items.length<=1){ return; }
            const rest=items.slice(1);
            content.innerHTML=''; rest.forEach(el=>content.appendChild(el)); content.style.display='none'; } catch(e){} };

        try { if (typeof originalRenderSales === 'function') { window.renderSales = originalRenderSales; } } catch {}

        // Toggle initial stock visibility based on hasStock checkbox
        window.toggleNewProductType = function () {
            const typeEl = document.getElementById('newProductType');
            const stockGroup = document.getElementById('newProductInitialStockGroup');
            if (typeEl && stockGroup) {
                stockGroup.style.display = (typeEl.value === 'service') ? 'none' : 'block';
                try { state.saleNewProductType = typeEl.value; saveData(); } catch {}
            }
        };

        // New function: Save new product from sales form
        window.saveNewProductFromSales = async function () {
            const nameRaw = document.getElementById('newProductName').value.trim();
            const name = capitalizeFirstWordValue(nameRaw);
            let categorySelect = document.getElementById('newProductCategory').value;
            if (typeof categorySelect === 'string') categorySelect = categorySelect.trim();
            const newCategoryNameRaw = document.getElementById('newCategoryName').value.trim();
            const newCategoryName = capitalizeFirstWordValue(newCategoryNameRaw);
            const cost = parseMoney(document.getElementById('newProductCost').value);
            const price = parseMoney(document.getElementById('newProductPrice').value);
            const typeEl = document.getElementById('newProductType');
            const hasStock = (typeEl?.value !== 'service');
            const stock = hasStock ? (parseMoney(document.getElementById('newProductStock').value) || 0) : 0;

            // Validation
            if (!name) {
                return showToast('Please enter product name', 'error');
            }

            let category;
            if (categorySelect === 'new') {
                if (!newCategoryName) {
                    return showToast('Please enter category name', 'error');
                }
                // Check if category already exists
                if (state.categories.includes(newCategoryName)) {
                    category = newCategoryName;
                    showToast('Category already exists, using existing one', 'info');
                } else {
                    // Add new category
                    state.categories.push(newCategoryName);
                    category = newCategoryName;
                    showToast('New category added!', 'success');
                }
            } else {
                if (!categorySelect) {
                    return showToast('Please select or create a category', 'error');
                }
                category = capitalizeFirstWordValue(categorySelect);
            }

            if (isNaN(cost) || cost < 0) {
                return showToast('Please enter a valid cost', 'error');
            }

            if (isNaN(price) || price < 0) {
                return showToast('Please enter a valid price', 'error');
            }

            if (price < cost) {
                if (!confirm('Warning: Selling price is less than cost. Continue?')) {
                    return;
                }
            }

            // Check if product already exists
            if (state.products.some(p => p.name.toLowerCase() === name.toLowerCase())) {
                return showToast('Product already exists', 'error');
            }

            // Create new product
            const product = {
                id: generateID('products'),
                name,
                category,
                cost,
                price,
                hasStock: hasStock ? true : false
            };
            state.products.push(product);

            // Initialize inventory
            if (!state.inventory) {
                state.inventory = {};
            }
            if (hasStock) {
                state.inventory[name] = {
                    stock: stock,
                    minAlert: 5
                };
            }

            const newProductIndex = state.products.length - 1;
            try {
                state.currentSaleProductIndex = String(newProductIndex);
                state.saleNewProductForm = {};
                state.saleNewProductType = 'product';
                state.currentNewProductCategory = '';
                saveData();
            } catch {}

            render();

            setTimeout(() => {
                const updatedSelect = document.getElementById('saleProduct');
                if (updatedSelect) {
                    updatedSelect.value = String(newProductIndex);
                    try { updateSearchableDropdownDisplay(updatedSelect); } catch {}
                }
                const nf = document.getElementById('newProductFields'); if (nf) nf.style.display = 'none';
                const clearBtn = document.getElementById('saleFormClearBtn'); if (clearBtn) clearBtn.style.display = 'inline-flex';
                try {
                    const qtyEl = document.getElementById('saleQuantity'); if (qtyEl) qtyEl.value = '1';
                    const payEl = document.getElementById('salePayment'); if (payEl) payEl.value = 'Cash';
                    const statEl = document.getElementById('saleStatus'); if (statEl) statEl.value = 'paid';
                    updateSaleTotal();
                } catch {}
            }, 0);

            if (syncEnabled) {
                (async () => {
                    try { await upsertOne('products', { name, category, cost, price, has_stock: hasStock ? true : false }); } catch {}
                    if (hasStock) { try { await upsertOne('inventory', { product_name: name, stock: stock, min_alert: 5 }); } catch {} }
                    if (category) { try { await upsertOne('categories', { name: category }); } catch {} }
                    try { syncInBackground(); } catch {}
                })();
            }

            showToast('✅ Product added successfully!', 'success');
        };

        // New function: Cancel new product creation
        window.cancelNewProduct = function () {
            try {
                const sp = document.getElementById('saleProduct');
                if (sp) {
                    sp.value = '';
                    try { sp.dispatchEvent(new Event('change', { bubbles: true })); } catch {}
                }
            } catch {}
            document.getElementById('newProductFields').style.display = 'none';
            try {
                state.saleNewProductForm = {};
                state.saleNewProductType = 'product';
                state.currentNewProductCategory = '';
                saveData();
            } catch {}
            try {
                const nameEl = document.getElementById('newProductName'); if (nameEl) nameEl.value = '';
                const catSel = document.getElementById('newProductCategory'); if (catSel) catSel.value = '';
                const catNameEl = document.getElementById('newCategoryName'); if (catNameEl) catNameEl.value = '';
                const costEl = document.getElementById('newProductCost'); if (costEl) costEl.value = '';
                const priceEl = document.getElementById('newProductPrice'); if (priceEl) priceEl.value = '';
                const stockEl = document.getElementById('newProductStock'); if (stockEl) stockEl.value = '0';
                const typeEl = document.getElementById('newProductType'); if (typeEl) typeEl.value = 'product';
                const stockGroup = document.getElementById('newProductInitialStockGroup'); if (stockGroup) stockGroup.style.display = 'block';
                const newCategoryField = document.getElementById('newCategoryField'); if (newCategoryField) newCategoryField.style.display = 'none';
            } catch {}
            const infoDiv = document.getElementById('saleInfo');
            if (infoDiv) { try { infoDiv.innerHTML = ''; infoDiv.style.display = 'none'; } catch {} }
            try { state.currentSaleProductIndex = ''; saveData(); } catch {}
        };

        console.log('✅ TUBA Sales Enhancement Patch loaded successfully!');
        // END OF PATCH


        // ============================================
        // TUBA COMPLETE ENHANCEMENT v2.0
        // ============================================

        console.log('🚀 Loading TUBA enhancements...');

        // ============================================
        // FIX 1: Deterministic ID Generation
        // ============================================

        function generateDeterministicID(type, item) {
            let hashBase = '';

            switch (type) {
                case 'sales':
                    hashBase = `${item.productName}|${item.customer}|${item.timestamp || Date.now()}`;
                    break;
                case 'products':
                    hashBase = `${item.name}|${item.category}|${item.cost}|${item.price}`;
                    break;
                case 'expenses':
                    hashBase = `${item.description}|${item.category}|${item.timestamp || Date.now()}`;
                    break;
                case 'customers':
                    hashBase = `${item.name}|${item.email || ''}|${item.phone || ''}`;
                    break;
                case 'transactions':
                    hashBase = `${item.channel}|${item.type}|${item.timestamp || Date.now()}`;
                    break;
                case 'unpaid':
                    hashBase = `${item.name}|${item.type}|${item.timestamp || Date.now()}`;
                    break;
                case 'notes':
                    hashBase = `${item.content.substring(0, 50)}|${item.timestamp || Date.now()}`;
                    break;
                default:
                    hashBase = JSON.stringify(item);
            }

            let hash = 0;
            for (let i = 0; i < hashBase.length; i++) {
                const char = hashBase.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }

            const prefix = {
                'sales': 'S',
                'products': 'P',
                'expenses': 'E',
                'customers': 'C',
                'transactions': 'T',
                'unpaid': 'U',
                'notes': 'N'
            }[type] || 'X';

            return `${prefix}-${Math.abs(hash).toString(36).toUpperCase()}`;
        }

        function generateIDSafe(type, item = null) {
            if (item && typeof item === 'object') {
                return generateDeterministicID(type, item);
            }
            return generateID(type);
        }

        // ============================================
        // FIX 2: Content-Based Deduplication
        // ============================================

        function deduplicateByContent(items, type) {
            if (!Array.isArray(items) || items.length === 0) return items;

            const uniqueMap = new Map();

            items.forEach(item => {
                let contentKey;

                switch (type) {
                    case 'sales':
                        contentKey = `${item.productName}|${item.customer}|${item.date}|${item.time}|${item.quantity}|${item.totalPrice}`;
                        break;
                    case 'products':
                        contentKey = `${(item.name || '').trim()}|${(item.category || '').trim()}`;
                        break;
                    case 'expenses':
                        contentKey = (item.timestamp != null ? String(item.timestamp) : `${item.description}|${item.date}|${item.time}|${item.amount}`);
                        break;
                    case 'customers':
                        contentKey = `${item.name}|${item.email || ''}|${item.phone || ''}`;
                        break;
                    case 'transactions':
                        contentKey = `${item.channel}|${item.date}|${item.time}|${item.amount}|${item.type}`;
                        break;
                    case 'unpaid':
                        contentKey = `${item.name}|${item.type}|${item.date}|${item.amount}`;
                        break;
                    case 'notes':
                        contentKey = `${item.content}|${item.date}|${item.time}`;
                        break;
                    default:
                        contentKey = JSON.stringify(item);
                }

                if (!uniqueMap.has(contentKey)) {
                    if (!item.id) {
                        item.id = generateDeterministicID(type, item);
                    }
                    uniqueMap.set(contentKey, item);
                } else {
                    const existing = uniqueMap.get(contentKey);
                    const merged = { ...existing, ...item };
                    merged.id = existing.id;

                    uniqueMap.set(contentKey, merged);
                }
            });

            return Array.from(uniqueMap.values());
        }

        // ============================================
        // FIX 3: Improved Smart Merge
        // ============================================

        async function smartMergeDataFixed() {
            try {
                updateSyncIndicator('syncing');
                showToast('Loading Data...', 'info', null, null, 8000);
                console.log('🔄 Starting smart merge with duplicate prevention...');

                const localData = {
                    sales: [...(state.sales || [])],
                    products: [...(state.products || [])],
                    expenses: [...(state.expenses || [])],
                    customers: [...(state.customers || [])],
                    transactions: [...(state.transactions || [])],
                    unpaidEntries: [...(state.unpaidEntries || [])],
                    notes: [...(state.notes || [])]
                };

                console.log('📦 Local data backed up');

                const cloudData = {
                    sales: [],
                    products: [],
                    expenses: [],
                    customers: [],
                    transactions: [],
                    unpaidEntries: [],
                    notes: []
                };

                try {
                    const { data: products } = await supabase
                        .from('products')
                        .select('*')
                        .eq('user_id', currentUser.id);
                    if (products) {
                        cloudData.products = products.map(p => ({
                            name: p.name,
                            category: p.category,
                            cost: parseFloat(p.cost),
                            price: parseFloat(p.price),
                            hasStock: (p.has_stock === false) ? false : true
                        }));
                    }

                    const { data: sales } = await supabase
                        .from('sales')
                        .select('*')
                        .eq('user_id', currentUser.id)
                        .order('timestamp', { ascending: false });
                    if (sales) {
                        cloudData.sales = sales.map(s => ({
                            date: s.date,
                            time: s.time,
                            timestamp: s.timestamp,
                            productName: s.product_name,
                            customer: s.customer,
                            quantity: s.quantity,
                            costPerUnit: parseFloat(s.cost_per_unit),
                            pricePerUnit: parseFloat(s.price_per_unit),
                            totalCost: parseFloat(s.total_cost),
                            totalPrice: parseFloat(s.total_price),
                            profit: parseFloat(s.profit),
                            payment: s.payment
                        }));
                    }

                    const { data: expenses } = await supabase
                        .from('expenses')
                        .select('*')
                        .eq('user_id', currentUser.id);
                    if (expenses) {
                        cloudData.expenses = expenses.map(e => ({
                            date: e.date,
                            time: e.time,
                            timestamp: e.timestamp,
                            description: e.description,
                            category: e.category,
                            amount: parseFloat(e.amount),
                            payment: e.payment,
                            comment: e.comment
                        }));
                    }

                    const { data: customers } = await supabase
                        .from('customers')
                        .select('*')
                        .eq('user_id', currentUser.id);
                    if (customers) {
                        cloudData.customers = customers.map(c => ({
                            name: c.name,
                            email: c.email || '',
                            phone: c.phone || '',
                            address: c.address || '',
                            totalPurchases: parseFloat(c.total_purchases || 0)
                        }));
                    }

                    const { data: transactions } = await supabase
                        .from('transactions')
                        .select('*')
                        .eq('user_id', currentUser.id);
                    if (transactions) {
                        cloudData.transactions = transactions.map(t => ({
                            channel: t.channel,
                            customerName: t.customer_name,
                            type: t.type,
                            amount: parseFloat(t.amount),
                            date: t.date,
                            time: t.time,
                            timestamp: t.timestamp
                        }));
                    }

                    const { data: unpaidEntries } = await supabase
                        .from('unpaid_entries')
                        .select('*')
                        .eq('user_id', currentUser.id);
                    if (unpaidEntries) {
                        cloudData.unpaidEntries = unpaidEntries.map(u => ({
                            name: u.name,
                            type: u.type,
                            amount: parseFloat(u.amount),
                            date: u.date,
                            time: u.time,
                            timestamp: u.timestamp,
                            paid: u.paid
                        }));
                    }

                    const { data: notes } = await supabase
                        .from('notes')
                        .select('*')
                        .eq('user_id', currentUser.id);
                    if (notes) {
                        cloudData.notes = notes.map(n => ({
                            title: n.title || '',
                            content: n.content,
                            date: n.date,
                            time: n.time,
                            timestamp: n.timestamp
                        }));
                    }

                    console.log('☁️  Cloud data fetched');

                } catch (fetchError) {
                    console.error('Error fetching cloud data:', fetchError);
                    throw fetchError;
                }

                console.log('🔀 Merging data...');

                state.sales = [...localData.sales, ...cloudData.sales];
                state.products = [...localData.products, ...cloudData.products];
                state.expenses = [...localData.expenses, ...cloudData.expenses];
                state.customers = [...localData.customers, ...cloudData.customers];
                state.transactions = [...localData.transactions, ...cloudData.transactions];
                state.unpaidEntries = [...localData.unpaidEntries, ...cloudData.unpaidEntries];
                state.notes = [...localData.notes, ...cloudData.notes];

                state.sales = deduplicateByContent(state.sales, 'sales');
                state.products = deduplicateByContent(state.products, 'products');
                state.expenses = deduplicateByContent(state.expenses, 'expenses');
                state.customers = deduplicateByContent(state.customers, 'customers');
                state.transactions = deduplicateByContent(state.transactions, 'transactions');
                state.unpaidEntries = deduplicateByContent(state.unpaidEntries, 'unpaid');
                state.notes = deduplicateByContent(state.notes, 'notes');

                console.log('✅ Deduplication complete');
                console.log(`📊 Final counts: ${state.sales.length} sales, ${state.products.length} products`);

                saveData();

                console.log('⬆️  Pushing merged data to cloud...');
                await clearAndPushAllData();

                updateSyncIndicator('synced');
                console.log('✅ Smart merge completed successfully');

            } catch (error) {
                console.error('Smart merge error:', error);
                updateSyncIndicator('synced');
                throw error;
            }
        }

        window.smartMergeData = smartMergeDataFixed;

        // ============================================
        // FIX 4: Sync Lock
        // ============================================

        let syncLock = false;

        async function syncInBackgroundSafe() {
            if (!syncEnabled || !currentUser) return;
            if (syncLock) {
                console.log('⏸️  Sync already in progress, skipping...');
                return;
            }

            syncLock = true;
            try {
                await clearAndPushAllData();
                try { await upsertQueue.process(); } catch { }
                try { await deleteQueue.process(); } catch { }
                console.log('✅ Background sync complete');
            } catch (error) {
                console.error('❌ Background sync error:', error);
            } finally {
                syncLock = false;
            }
        }

        window.syncInBackground = syncInBackgroundSafe;

        // ============================================
        // FIX 5: Manual Duplicate Cleaner
        // ============================================

        async function cleanAllDuplicates() {
            console.log('🧹 Cleaning duplicates...');

            const beforeCounts = {
                sales: state.sales.length,
                products: state.products.length,
                expenses: state.expenses.length,
                customers: state.customers.length,
                transactions: state.transactions.length,
                unpaidEntries: state.unpaidEntries.length,
                notes: state.notes.length
            };

            state.sales = deduplicateByContent(state.sales, 'sales');
            state.products = deduplicateByContent(state.products, 'products');
            state.expenses = deduplicateByContent(state.expenses, 'expenses');
            state.customers = deduplicateByContent(state.customers, 'customers');
            state.transactions = deduplicateByContent(state.transactions, 'transactions');
            state.unpaidEntries = deduplicateByContent(state.unpaidEntries, 'unpaid');
            state.notes = deduplicateByContent(state.notes, 'notes');

            const afterCounts = {
                sales: state.sales.length,
                products: state.products.length,
                expenses: state.expenses.length,
                customers: state.customers.length,
                transactions: state.transactions.length,
                unpaidEntries: state.unpaidEntries.length,
                notes: state.notes.length
            };

            const removed = {
                sales: beforeCounts.sales - afterCounts.sales,
                products: beforeCounts.products - afterCounts.products,
                expenses: beforeCounts.expenses - afterCounts.expenses,
                customers: beforeCounts.customers - afterCounts.customers,
                transactions: beforeCounts.transactions - afterCounts.transactions,
                unpaidEntries: beforeCounts.unpaidEntries - afterCounts.unpaidEntries,
                notes: beforeCounts.notes - afterCounts.notes
            };

            const totalRemoved = Object.values(removed).reduce((a, b) => a + b, 0);

            console.log('✅ Duplicates removed:', removed);
            console.log(`🎉 Total duplicates removed: ${totalRemoved}`);

            saveData();

            if (syncEnabled && currentUser) {
                await clearAndPushAllData();
            }

            render();
            showToast(`🧹 Removed ${totalRemoved} duplicates!`, 'success');

            return { removed, totalRemoved };
        }

        window.cleanAllDuplicates = cleanAllDuplicates;

        // ============================================
        // FIX 6: Auto Duplicate Detection on Load
        // ============================================

        function detectDuplicatesOnLoad() {
            console.log('🔍 Checking for duplicates on load...');

            const duplicateCounts = {
                sales: 0,
                products: 0,
                expenses: 0,
                customers: 0,
                transactions: 0,
                unpaidEntries: 0,
                notes: 0
            };

            // Check sales
            const salesMap = new Map();
            state.sales.forEach(s => {
                const key = `${s.productName}|${s.customer}|${s.date}|${s.time}`;
                if (salesMap.has(key)) duplicateCounts.sales++;
                salesMap.set(key, true);
            });

            // Check products
            const productsMap = new Map();
            state.products.forEach(p => {
                const key = `${p.name}|${p.category}`;
                if (productsMap.has(key)) duplicateCounts.products++;
                productsMap.set(key, true);
            });

            // Check expenses
            const expensesMap = new Map();
            state.expenses.forEach(e => {
                const key = `${e.description}|${e.date}|${e.time}`;
                if (expensesMap.has(key)) duplicateCounts.expenses++;
                expensesMap.set(key, true);
            });

            // Check customers
            const customersMap = new Map();
            state.customers.forEach(c => {
                const key = `${c.name}|${c.email || ''}`;
                if (customersMap.has(key)) duplicateCounts.customers++;
                customersMap.set(key, true);
            });

            // Check transactions
            const transactionsMap = new Map();
            state.transactions.forEach(t => {
                const key = `${t.channel}|${t.date}|${t.time}|${t.amount}`;
                if (transactionsMap.has(key)) duplicateCounts.transactions++;
                transactionsMap.set(key, true);
            });

            // Check unpaid
            const unpaidMap = new Map();
            state.unpaidEntries.forEach(u => {
                const key = `${u.name}|${u.type}|${u.date}`;
                if (unpaidMap.has(key)) duplicateCounts.unpaidEntries++;
                unpaidMap.set(key, true);
            });

            // Check notes
            const notesMap = new Map();
            state.notes.forEach(n => {
                const key = `${n.content}|${n.date}|${n.time}`;
                if (notesMap.has(key)) duplicateCounts.notes++;
                notesMap.set(key, true);
            });

            const totalDuplicates = Object.values(duplicateCounts).reduce((a, b) => a + b, 0);

            if (totalDuplicates > 0) {
                console.warn(`⚠️  Found ${totalDuplicates} potential duplicates!`, duplicateCounts);
                state.hasDuplicates = true;
                state.duplicateCounts = duplicateCounts;
            } else {
                console.log('✅ No duplicates detected');
                state.hasDuplicates = false;
                state.duplicateCounts = null;
            }

            return { hasDuplicates: totalDuplicates > 0, counts: duplicateCounts, total: totalDuplicates };
        }

        window.detectDuplicatesOnLoad = detectDuplicatesOnLoad;

        // ============================================
        // FIX 7: Enhanced Dashboard with Duplicate Alert
        // ============================================

        const originalRenderDashboard = window.renderDashboard;

        window.renderDashboard = function () {
            const dashboardHTML = originalRenderDashboard();

            // Check for duplicates
            const dupeCheck = detectDuplicatesOnLoad();

            if (dupeCheck.hasDuplicates) {
                const dupeAlert = `
                <div class="alert-box-danger" style="animation: highlightFade 2s ease-out;">
                    <strong>⚠️  Duplicate Data Detected!</strong><br>
                    Found ${dupeCheck.total} potential duplicates in your data.<br>
                    <div style="margin-top: 8px; font-size: 12px;">
                        Sales: ${dupeCheck.counts.sales} | 
                        Products: ${dupeCheck.counts.products} | 
                        Expenses: ${dupeCheck.counts.expenses} |
                        Customers: ${dupeCheck.counts.customers}
                    </div>
                    <button class="btn-danger" style="margin-top: 12px; width: 100%;" onclick="cleanDuplicatesFromUI()">
                        🧹 Clean All Duplicates Now
                    </button>
                </div>
            `;

                return dupeAlert + dashboardHTML;
            }

            return dashboardHTML;
        };

        // ============================================
        // FIX 8: Clean Duplicates UI Function
        // ============================================

        async function cleanDuplicatesFromUI() {
            playTapSound();
            hapticShort();
            showConfirm('This will remove all duplicate entries. Continue?', async function () {
                showToast('🧹 Cleaning duplicates...', 'info');
                try {
                    const result = await cleanAllDuplicates();
                    if (result.totalRemoved > 0) {
                        showToast(`✅ Removed ${result.totalRemoved} duplicates!`, 'success');
                    } else {
                        showToast('✅ No duplicates found!', 'success');
                    }
                } catch (error) {
                    console.error('Error cleaning duplicates:', error);
                    showToast('❌ Error cleaning duplicates', 'error');
                }
            });
        }

        window.cleanDuplicatesFromUI = cleanDuplicatesFromUI;

        // ============================================
        // FIX 9: Update Side Nav with Clean Button
        // ============================================

        const sideNavCleanupItem = document.querySelector('.side-nav-item[onclick="openCleanupModal()"]');
        if (sideNavCleanupItem) {
            sideNavCleanupItem.setAttribute('onclick', 'cleanDuplicatesFromUI(); toggleSideNav();');
            sideNavCleanupItem.innerHTML = `
            <span class="side-nav-icon">🧹</span>
            <span>Clean Duplicates</span>
        `;
        }

        // ============================================
        // FIX 10: Run Detection on First Load
        // ============================================

        setTimeout(() => {
            const dupeCheck = detectDuplicatesOnLoad();
            if (dupeCheck.hasDuplicates && state.activeTab === 'dashboard') {
                render();
            }
        }, 2000);

        console.log('✅ All TUBA enhancements loaded successfully!');
        console.log('📋 Available functions:');
        console.log('   • cleanAllDuplicates() - Manual duplicate cleaning');
        console.log('   • detectDuplicatesOnLoad() - Check for duplicates');
        console.log('   • cleanDuplicatesFromUI() - UI-triggered cleaning');


        // ============================================
        // UI ENHANCEMENT FUNCTIONS
        // ============================================

        console.log('🎨 Loading UI enhancements...');

        // Update side nav auth button based on login state
        function updateSideNavAuthButton() {
            const authButton = document.getElementById('sideNavAuthButton');
            const authIcon = document.getElementById('sideNavAuthIcon');
            const authText = document.getElementById('sideNavAuthText');

            if (!authButton || !authIcon || !authText) return;

            if (currentUser && syncEnabled) {
                // User is logged in
                authIcon.textContent = '🚪';
                authText.textContent = 'Logout';
                authButton.style.background = 'linear-gradient(145deg, #d32f2f, #b71c1c)';
            } else {
                // User is logged out
                authIcon.textContent = '🔐';
                authText.textContent = 'Login';
                authButton.style.background = 'linear-gradient(145deg, #2e7d32, #1b5e20)';
            }
        }

        // Handle side nav auth button click
        async function handleSideNavAuth() {
            // Double-check actual session to avoid UI desync
            let effectiveUser = null;
            try {
                const { data: { session } } = await supabase.auth.getSession();
                effectiveUser = session?.user || null;
            } catch { }

            if (effectiveUser && syncEnabled) {
                try { await signOut(); } catch {}
                try { toggleSideNav(); } catch {}
                try { showToast('Logged out successfully', 'info'); } catch {}
            } else {
                // User is logged out - go to account tab
                switchTab('account');
                toggleSideNav();
            }
        }

        function updateSideNavSoundButton() {
            const btn = document.getElementById('sideNavSoundButton');
            const icon = document.getElementById('sideNavSoundIcon');
            const text = document.getElementById('sideNavSoundText');
            const headerIcon = document.getElementById('sideNavSoundHeaderIcon');
            if (!btn || !icon || !text) return;
            if (state.soundEnabled) {
                icon.textContent = '🔊';
                text.textContent = 'Sound: On';
                btn.style.background = 'linear-gradient(145deg, #2e7d32, #1b5e20)';
                btn.style.color = 'white';
                if (headerIcon) headerIcon.textContent = '🔊';
            } else {
                icon.textContent = '🔇';
                text.textContent = 'Sound: Off';
                btn.style.background = 'linear-gradient(145deg, #9e9e9e, #616161)';
                btn.style.color = 'white';
                if (headerIcon) headerIcon.textContent = '🔇';
            }
        }

        function updateSideNavThemeButton() {
            const headerIcon = document.getElementById('sideNavThemeHeaderIcon');
            if (!headerIcon) return;
            headerIcon.textContent = (state.theme === 'dark' ? '🌙' : ((state.theme === 'blue' || state.theme === 'paywall') ? '🔷' : '🌞'));
        }

        function applyTheme() {
            try {
                document.body.classList.toggle('theme-dark', state.theme === 'dark');
                document.body.classList.toggle('theme-blue', state.theme === 'blue' || state.theme === 'paywall');
                updateSideNavThemeButton();
            } catch (e) { }
        }

        async function toggleTheme() {
            state.theme = (state.theme === 'dark') ? 'blue' : (state.theme === 'blue' ? 'light' : 'dark');
            saveData();
            applyTheme();
            showToast(state.theme === 'dark' ? 'Dark mode enabled' : ((state.theme === 'blue' || state.theme === 'paywall') ? 'Blue theme enabled' : 'Light mode enabled'), 'info');
            try {
                if (syncEnabled && currentUser && supabase && supabase.auth) {
                    await supabase.auth.updateUser({ data: { theme: state.theme } });
                }
            } catch (e) { }
        }

        function setupThemeHotkey() {
            if (window.__themeHotkeySetup) return;
            window.__themeHotkeySetup = true;
            document.addEventListener('keydown', function (e) {
                const isCtrl = e.ctrlKey || e.metaKey;
                const isL = e.key === 'l' || e.key === 'L';
                if (isCtrl && isL) { e.preventDefault(); toggleTheme(); }
            });
        }

        setupThemeHotkey();

        function setupKeyboardDismiss() {
            if (window.__keyboardDismissSetup) return;
            window.__keyboardDismissSetup = true;
            const isInputEl = el => el && (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA' || el.tagName === 'SELECT' || el.isContentEditable);
            const isInteractiveTarget = el => !!(el && el.closest('input, textarea, select, .search-box, .money-input, .filter-row, .form-group, .modal-content, .searchable-dropdown, .dropdown-display, .dropdown-panel, .dropdown-options, .dropdown-option'));
            const rememberCaret = el => { try { const s = el.selectionStart; const e = el.selectionEnd; el.__caret = { s, e }; } catch { } };
            const restoreCaret = el => { try { if (el.__caret && el.setSelectionRange) el.setSelectionRange(el.__caret.s, el.__caret.e); } catch { } };
            document.addEventListener('focusin', e => { const el = e.target; if (isInputEl(el)) restoreCaret(el); }, true);
            document.addEventListener('blur', e => { const el = e.target; if (isInputEl(el)) rememberCaret(el); }, true);
            const handler = e => {
                const active = document.activeElement;
                if (!active || !isInputEl(active)) return;
                if (isInteractiveTarget(e.target)) return;
                rememberCaret(active);
                try { active.blur(); } catch { }
                try { document.getElementById('hiddenFocusTarget')?.focus(); } catch { }
            };
            document.addEventListener('pointerdown', handler, true);
            document.addEventListener('touchstart', handler, true);
            document.addEventListener('mousedown', handler, true);
        }

        function toggleSoundNotifications() {
            state.soundEnabled = !state.soundEnabled;
            saveData();
            updateSideNavSoundButton();
            showToast(state.soundEnabled ? 'Sound notifications enabled' : 'Sound notifications disabled', 'info');
            try { updateQuickButtonsState(); } catch {}
        }

        // Override the original render to update auth button
        const originalRender = window.render;
        window.render = function () {
            originalRender();
            updateSideNavAuthButton();
            // Auto-submit login if autofill populated credentials
            if (state.activeTab === 'account' && !currentUser) {
                try { autoSubmitLoginIfAutofilled(); } catch (e) { /* no-op */ }
            }
            try { applyHoverHints(); } catch { }
            try { applySearchableDropdowns(); } catch { }
        };

        function applyHoverHints() {
            const setTitle = (selector, build) => {
                document.querySelectorAll(selector).forEach(el => {
                    if (!el.getAttribute('title')) {
                        const t = typeof build === 'function' ? build(el) : (build || el.textContent.trim());
                        if (t) el.setAttribute('title', t);
                    }
                });
            };
            setTitle('button', el => el.textContent.trim());
            setTitle('.collapse-btn', el => el.textContent.trim());
            setTitle('.note-preview', () => 'Open note');
            setTitle('#inventoryModal .modal-close', () => 'Close');
            setTitle('#floatModal .modal-close', () => 'Close');
            setTitle('#productsImportModal .modal-close', () => 'Close');
            setTitle('#invPurchasesImportModal .modal-close', () => 'Close');
        }

        function makeSearchableDropdown(selectEl) {
            if (!selectEl || selectEl.__searchableApplied) return;
            const options = Array.from(selectEl.options || []);
            if (options.length === 0) return;
            selectEl.style.display = 'none';
            selectEl.__searchableApplied = true;
            const wrap = document.createElement('div');
            wrap.className = 'searchable-dropdown';
            const display = document.createElement('div');
            display.className = 'dropdown-display';
            display.textContent = (selectEl.selectedOptions[0]?.text || options[0]?.text || 'Choose…');
            const panel = document.createElement('div');
            panel.className = 'dropdown-panel hidden';
            const input = document.createElement('input');
            input.className = 'dropdown-search';
            input.placeholder = (selectEl.getAttribute('data-search-placeholder') || 'Search...');
            const list = document.createElement('div');
            list.className = 'dropdown-options';
            panel.appendChild(input);
            panel.appendChild(list);
            wrap.appendChild(display);
            wrap.appendChild(panel);
            selectEl.parentNode.insertBefore(wrap, selectEl.nextSibling);
            const chevron = document.createElement('span');
            chevron.className = 'dropdown-chevron';
            chevron.innerHTML = '<svg viewBox="0 0 24 24" width="16" height="16" aria-hidden="true"><path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>';
            display.appendChild(chevron);
            let activeIndex = -1;
            const setActive = (idx) => {
                const items = Array.from(list.children);
                items.forEach((el, i) => { el.classList.toggle('active', i === idx); });
                activeIndex = idx;
            };
            const buildList = (query = '') => {
                const q = String(query || '').toLowerCase();
                list.innerHTML = '';
                options.forEach(opt => {
                    const txt = String(opt.text || '').trim();
                    if (!q || txt.toLowerCase().includes(q)) {
                        const item = document.createElement('div');
                        item.className = 'dropdown-option';
                        item.textContent = txt;
                        item.setAttribute('data-value', opt.value);
                        item.onclick = () => {
                            selectEl.value = opt.value;
                            try { selectEl.dispatchEvent(new Event('change', { bubbles: true })); } catch { }
                            display.textContent = txt;
                            panel.classList.add('hidden');
                        };
                        list.appendChild(item);
                    }
                });
                const itemsNow = Array.from(list.children);
                if (itemsNow.length > 0) setActive(0); else setActive(-1);
            };
            buildList('');
            const isMobile = () => {
                try {
                    return (window.matchMedia && window.matchMedia('(pointer: coarse)').matches) || /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent || '');
                } catch { return false; }
            };
            const openPanel = () => { panel.classList.remove('hidden'); input.value = ''; buildList(''); try { const card = wrap.closest('.card'); if (card) card.classList.add('dropdown-open'); } catch {} if (!isMobile()) { try { input.focus(); } catch { } } };
            const closePanel = () => { panel.classList.add('hidden'); try { const card = wrap.closest('.card'); if (card) card.classList.remove('dropdown-open'); } catch {} };
            display.addEventListener('click', (e) => { e.stopPropagation(); if (panel.classList.contains('hidden')) { openPanel(); } else { closePanel(); } });
            input.addEventListener('input', () => { buildList(input.value); });
            input.addEventListener('keydown', (e) => {
                const items = Array.from(list.children);
                if (e.key === 'Enter') {
                    e.preventDefault();
                    if (activeIndex >= 0 && items[activeIndex]) items[activeIndex].click();
                } else if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    if (items.length > 0) setActive(Math.min(items.length - 1, Math.max(0, activeIndex + 1)));
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    if (items.length > 0) setActive(Math.max(0, Math.min(items.length - 1, activeIndex - 1)));
                }
            });
            document.addEventListener('click', (e) => { if (!wrap.contains(e.target)) closePanel(); });
            document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closePanel(); });
            selectEl.addEventListener('change', () => {
                const opt = Array.from(selectEl.options).find(o => o.value === selectEl.value);
                display.textContent = (opt?.text || display.textContent);
            });
        }

        function updateSearchableDropdownDisplay(selectEl){
            if (!selectEl) return;
            let wrap = selectEl.nextSibling;
            while (wrap && wrap.nodeType === 3) wrap = wrap.nextSibling;
            if (!wrap || !wrap.classList || !wrap.classList.contains('searchable-dropdown')) return;
            const display = wrap.querySelector('.dropdown-display');
            if (!display) return;
            const opt = Array.from(selectEl.options || []).find(o => o.value === selectEl.value) || selectEl.options[0];
            const label = (opt && opt.text) ? opt.text : '';
            let chevron = display.querySelector('.dropdown-chevron');
            display.textContent = label;
            if (!chevron) {
                chevron = document.createElement('span');
                chevron.className = 'dropdown-chevron';
                chevron.innerHTML = '<svg viewBox="0 0 24 24" width="16" height="16" aria-hidden="true"><path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>';
            }
            display.appendChild(chevron);
            const list = wrap.querySelector('.dropdown-options');
            if (list) {
                Array.from(list.children).forEach(el => {
                    const val = el.getAttribute('data-value');
                    el.classList.toggle('active', String(val || '') === String(selectEl.value || ''));
                });
            }
        }

        function applySearchableDropdowns() {
            document.querySelectorAll('select').forEach(sel => {
                try {
                    if (!sel.__searchableApplied && sel.options && sel.options.length > 12) {
                        makeSearchableDropdown(sel);
                    }
                } catch { }
            });
            ['saleProduct', 'saleCustomer', 'expenseCategory', 'incomeSource', 'productCategory', 'newProductCategory', 'invProductSelect', 'invNewProductCategory', 'invFilterPeriod', 'invPeriodSelect', 'unpaidCustomer', 'unpaidProduct', 'receiptCustomer', 'invoiceCustomer', 'receiptInvoice', 'maintenanceAsset']
                .forEach(id => { const el = document.getElementById(id); if (el && !el.__searchableApplied) { try { makeSearchableDropdown(el); } catch { } } });
        }

        // Override toggleSideNav to update button when opened
        const originalToggleSideNav = window.toggleSideNav;
        window.toggleSideNav = function () {
            originalToggleSideNav();
            setTimeout(updateSideNavAuthButton, 100);
        };

        // Update button on initial load
        setTimeout(updateSideNavAuthButton, 1000);

        // Enhanced renderDashboard with new quick actions

        window.renderDashboard = function () {
            let html = originalRenderDashboard();

            // Check if quick actions need updating (for older versions)
            if (!html.includes('📄 Invoices')) {
                const quickActionsRegex = /<div class="card">\s*<h2>Quick Actions<\/h2>\s*<div class="flex-gap">([\s\S]*?)<\/div>\s*<\/div>/;

                const newQuickActions = `<div class="card">
                    <h2>Quick Actions</h2>
                    <div class="flex-gap">
                        <button class="btn-success btn-small" onclick="switchTab('sales')">➕ New Sale</button>
                        <button class="btn-danger btn-small" onclick="switchTab('expenses')">💸 Add Expense</button>
                        <button class="btn-small" onclick="switchTab('products')">🛒 Manage Products/Services</button>
                        <button class="btn-small" onclick="switchTab('transactions')">💳 Transactions</button>
                        <button class="btn-small" onclick="switchTab('inventoryPurchases')">📦 Inventory</button>
                        <button class="btn-small" onclick="switchTab('invoices')" style="background: linear-gradient(145deg, #1976d2, #0d47a1); color: white;">📄 Invoices</button>
                        <button class="btn-small" onclick="switchTab('notes')" style="background: linear-gradient(145deg, #e65100, #bf360c); color: white;">📝 Notes</button>
                        <button class="btn-small" onclick="switchTab('analytics')" style="background: linear-gradient(145deg, #7b1fa2, #4a148c); color: white;">📈 Analytics</button>
                    </div>
                </div>`;

                if (quickActionsRegex.test(html)) {
                    html = html.replace(quickActionsRegex, newQuickActions);
                }
            }

            try {
                const upItems = Array.isArray(upsertQueue?.items) ? upsertQueue.items : [];
                const delItems = Array.isArray(deleteQueue?.items) ? deleteQueue.items : [];
                const upCount = upItems.length;
                const delCount = delItems.length;
                const fmt = v => {
                    try { return escapeHTML(JSON.stringify(v)).slice(0, 160); } catch { return String(v); }
                };
                const upList = upItems.slice(0, 10).map(i => `
                    <div class="item">
                        <div class="item-header">
                            <span class="item-title">${escapeHTML(i.table || '')}</span>
                            <span class="badge">${escapeHTML((i.id || '').slice(0, 8))}</span>
                        </div>
                        <div class="item-subtitle">${fmt(i.payload || {})}</div>
                        <div class="flex-gap" style="margin-top:8px;">
                            <button class="btn-small" onclick="retryQueuedActions()">Retry Now</button>
                            <button class="btn-small btn-danger" onclick="removeQueuedUpsert('${i.id}')">Remove</button>
                        </div>
                    </div>
                `).join('') || '<p style="text-align:center;color:#666;">No upserts queued</p>';
                const delList = delItems.slice(0, 10).map(i => `
                    <div class="item">
                        <div class="item-header">
                            <span class="item-title">${escapeHTML(i.table || '')}</span>
                            <span class="badge">${escapeHTML((i.id || '').slice(0, 8))}</span>
                        </div>
                        <div class="item-subtitle">${fmt(i.keySource || {})}</div>
                        <div class="flex-gap" style="margin-top:8px;">
                            <button class="btn-small" onclick="retryQueuedActions()">Retry Now</button>
                            <button class="btn-small btn-danger" onclick="removeQueuedDelete('${i.id}')">Remove</button>
                        </div>
                    </div>
                `).join('') || '<p style="text-align:center;color:#666;">No deletes queued</p>';
                const queuedHTML = `
                    <div class="card queued-card">
                        <h2>Queued Actions</h2>
                        <div class="flex-gap queued-badges" style="margin-bottom:8px;">
                            <span class="badge">Upserts: ${upCount}</span>
                            <span class="badge">Deletes: ${delCount}</span>
                            <button class="btn-small" onclick="retryQueuedActions()">Process Now</button>
                            <button class="btn-small btn-danger" onclick="clearQueuedActions()">Delete All</button>
                        </div>
                        <div class="queued-grid">
                            <div>
                                <h3 style="font-size:14px; margin-bottom:6px;">Upserts</h3>
                                ${upList}
                            </div>
                            <div>
                                <h3 style="font-size:14px; margin-bottom:6px;">Deletes</h3>
                                ${delList}
                            </div>
                        </div>
                    </div>
                `;
                html += queuedHTML;
            } catch { }

            return html;
        };

        window.retryQueuedActions = async function () {
            if (!navigator.onLine || !syncEnabled || !currentUser) { showToast('Not signed in or offline', 'error'); return; }
            const beforeU = (upsertQueue?.items || []).length;
            const beforeD = (deleteQueue?.items || []).length;
            try { await upsertQueue.process(); } catch { }
            try { await deleteQueue.process(); } catch { }
            try { await syncInBackground(); } catch { }
            const afterU = (upsertQueue?.items || []).length;
            const afterD = (deleteQueue?.items || []).length;
            const processed = (beforeU - afterU) + (beforeD - afterD);
            showToast(processed > 0 ? `Processed ${processed} queued actions` : 'No queued actions processed', processed > 0 ? 'success' : 'info');
            render();
        };
        window.clearQueuedActions = function () {
            showConfirm('Delete all queued actions?', function () {
                try { upsertQueue.items = []; upsertQueue.save(); } catch { }
                try { deleteQueue.items = []; deleteQueue.save(); } catch { }
                showToast('Cleared queued actions', 'success');
                render();
            });
        };
        window.removeQueuedUpsert = function (id) {
            try { upsertQueue.items = (upsertQueue.items || []).filter(x => x.id !== id); upsertQueue.save(); showToast('Removed queued upsert', 'info'); render(); } catch { }
        };
        window.removeQueuedDelete = function (id) {
            try { deleteQueue.items = (deleteQueue.items || []).filter(x => x.id !== id); deleteQueue.save(); showToast('Removed queued delete', 'info'); render(); } catch { }
        };

        console.log('✅ UI enhancements loaded successfully!');

        function openQuickSaleNotesModal() {
            const modal = document.getElementById('floatModal');
            const content = document.getElementById('floatModalContent');
            const titleEl = document.getElementById('floatModalTitle');
            if (titleEl) titleEl.textContent = 'Quick Notes';
            const notes = (state.notes || [])
                .filter(n => hasTag(n, 'sales'))
                .slice()
                .sort((a, b) => Number(b.timestamp || 0) - Number(a.timestamp || 0))
                .slice(0, 8);
            const list = notes.map(n => `
                <div class="item">
                    <div class="item-header">
                        <span class="item-title">${escapeHTML(n.title || 'Note')}</span>
                        <span class="item-subtitle">${escapeHTML(n.date || '')} ${escapeHTML(n.time || '')}</span>
                    </div>
                    <div style="white-space:pre-wrap; margin-top:6px;">${escapeHTML(n.content || '')}</div>
                    <div class="flex-gap" style="margin-top:8px;">
                        <button class="btn-small" onclick="quickNotesStartEdit(${n.timestamp})">✏️ Edit</button>
                        <button class="btn-small btn-danger" onclick="quickNotesDelete(${n.timestamp})">🗑️ Delete</button>
                    </div>
                </div>
            `).join('');
            content.innerHTML = `
                <div class="card">
                    <h3>Add Quick Note</h3>
                    <div class="form-group">
                        <label>Title (Optional)</label>
                        <input type="text" id="quickNoteTitle" placeholder="Brief title...">
                    </div>
                    <div class="form-group">
                        <textarea id="quickNoteContent" placeholder="Write your note..." required></textarea>
                    </div>
                    <div class="flex-gap">
                        <button class="btn-success btn-small" onclick="quickNotesSave()">Save</button>
                        <button class="btn-secondary btn-small" onclick="closeFloatModal()">Close</button>
                    </div>
                </div>
                <div class="card">
                    <h3>Recent Notes</h3>
                    <div id="quickNotesList" class="list-scroll-container">${list || '<p style="text-align:center;color:#666;">No notes yet</p>'}</div>
                </div>
            `;
            modal.classList.add('show');
            try { window.__updateModalOverflow && window.__updateModalOverflow(); } catch { }
            if (modal.__outsideClickHandler) modal.removeEventListener('click', modal.__outsideClickHandler);
            modal.__outsideClickHandler = (e) => { if (e.target === modal) { closeFloatModal(); } };
            modal.addEventListener('click', modal.__outsideClickHandler);
        }
        async function quickNotesSave() {
            const now = new Date();
            const title = (document.getElementById('quickNoteTitle')?.value || '').trim();
            const content = (document.getElementById('quickNoteContent')?.value || '').trim();
            if (!content) { showToast('Enter note content', 'error'); return; }
            const note = { title, content, date: getTodayDateString(), time: now.toLocaleTimeString(), timestamp: now.getTime() };
            addTagToItem(note, 'sales');
            state.notes = state.notes || [];
            state.notes.push(note);
            saveData();
            showToast('Note saved', 'success');
            try {
                if (syncEnabled) {
                    const tagsStr = Array.isArray(note.tags) ? note.tags.join(',') : null;
                    await upsertOne('notes', { title: note.title || '', content: note.content, date: note.date, time: note.time, timestamp: note.timestamp, tags: tagsStr });
                    syncInBackground();
                }
            } catch {}
            try { openQuickSaleNotesModal(); } catch {}
        }
        function quickNotesStartEdit(ts) {
            const idx = (state.notes || []).findIndex(n => Number(n.timestamp) === Number(ts));
            if (idx === -1) return;
            closeFloatModal();
            startEditingNote(idx);
        }
        async function quickNotesSaveEdit(ts) {
            const idx = (state.notes || []).findIndex(n => Number(n.timestamp) === Number(ts));
            if (idx === -1) return;
            const title = (document.getElementById(`quickEditTitle_${ts}`)?.value || '').trim();
            const content = (document.getElementById(`quickEditContent_${ts}`)?.value || '').trim();
            if (!content) { showToast('Enter note content', 'error'); return; }
            state.notes[idx].title = title || '';
            state.notes[idx].content = content;
            saveData();
            showToast('Note updated', 'success');
            try {
                if (syncEnabled) {
                    const n = state.notes[idx];
                    const tagsStr = Array.isArray(n.tags) ? n.tags.join(',') : null;
                    await upsertOne('notes', { title: n.title || '', content: n.content, date: n.date, time: n.time, timestamp: n.timestamp, tags: tagsStr });
                    syncInBackground();
                }
            } catch {}
            try { openQuickSaleNotesModal(); } catch {}
        }
        async function quickNotesDelete(ts) {
            const idx = (state.notes || []).findIndex(n => Number(n.timestamp) === Number(ts));
            if (idx === -1) return;
            closeFloatModal();
            try { playDeleteSound(); } catch (e) { }
            const ok = await requirePinForDestructive('delete');
            if (!ok) { showToast('Delete failed: PIN required', 'error'); return; }
            const note = state.notes[idx];
            state.notes.splice(idx, 1);
            saveData();
            showToast('Note deleted', 'success');
            try {
                if (syncEnabled && note) {
                    await deleteOne('notes', { timestamp: note.timestamp });
                    syncInBackground();
                }
            } catch {}
            try { openQuickSaleNotesModal(); } catch {}
        }

        // ============================================
        // TUBA AUTHENTICATION FIX PATCH v1.0
        // Auto-applied on 2025-10-20T19:50:55.516Z
        // Fixes 404 error during registration
        // ============================================

        (function () {
            console.log('🔧 Applying authentication fix patch...');

            // Override signUp function with enhanced error handling
            window.signUp = async function (email, password) {
                try {
                    console.log('📧 Attempting to sign up:', email);

                    // Validate inputs
                    if (!email || !password) {
                        showToast('Please provide email and password', 'error');
                        return null;
                    }

                    if (password.length < 6) {
                        showToast('Password must be at least 6 characters', 'error');
                        return null;
                    }

                    // Check if supabase is initialized
                    if (!supabase) {
                        console.error('❌ Supabase not initialized');
                        showToast('Database connection error. Please refresh the page.', 'error');
                        return null;
                    }

                    // Attempt sign up with enhanced options
                    const { data, error } = await supabase.auth.signUp({
                        email: email.trim(),
                        password: password,
                        options: {
                            emailRedirectTo: 'https://tubawelcomescreen.vercel.app/',
                            data: {
                                created_at: new Date().toISOString(),
                                app_version: '2.0',
                                theme: 'dark'
                            }
                        }
                    });

                    if (error) {
                        console.error('❌ Sign up error:', error);

                        // Handle specific error codes
                        if (error.message.includes('User already registered') || error.message.includes('already been registered')) {
                            showToast('This email is already registered. Try signing in instead.', 'error');
                        } else if (error.message.includes('Invalid email')) {
                            showToast('Please enter a valid email address', 'error');
                        } else if (error.status === 404 || error.message.includes('404')) {
                            showToast('⚠️ Authentication service configuration error', 'error');
                            console.error('🔍 Possible causes:');
                            console.error('   1. Invalid Supabase URL');
                            console.error('   2. Wrong API key');
                            console.error('   3. Email auth not enabled in Supabase dashboard');
                            console.error('   4. Project paused or deleted');
                            console.error('   → Check your Supabase dashboard: https://supabase.com/dashboard');
                        } else if (error.message.includes('Email not confirmed')) {
                            showToast('Please confirm your email address', 'info');
                        } else {
                            showToast('Sign up error: ' + error.message, 'error');
                        }

                        return null;
                    }

                    console.log('✅ Sign up response:', data);

                    // Check if email confirmation is required
                    if (data.user && !data.session) {
                        showToast('✅ Account created! Please check your email to confirm.', 'success');
                        console.log('📧 Email confirmation required. Check your inbox.');
                    } else if (data.user && data.session) {
                        showToast('✅ Account created and logged in successfully!', 'success');
                        currentUser = data.user;
                        syncEnabled = true;
                        updateSyncIndicator('synced');

                        // Initialize user profile
                        await loadUserProfile();
                        render();
                    } else if (data.user && data.user.identities && data.user.identities.length === 0) {
                        showToast('This email is already registered. Please sign in instead.', 'info');
                    }

                    return data;

                } catch (error) {
                    console.error('❌ Sign up exception:', error);
                    showToast('Unexpected error during sign up. Please try again.', 'error');
                    return null;
                }
            };

            // Override handleSignUp function
            window.handleSignUp = async function () {
                const email = document.getElementById('signupEmail')?.value;
                const password = document.getElementById('signupPassword')?.value;
                const confirm = document.getElementById('signupPasswordConfirm')?.value;

                if (!email || !password || !confirm) {
                    return showToast('Please fill in all fields', 'error');
                }

                // Email validation
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email)) {
                    return showToast('Please enter a valid email address', 'error');
                }

                if (password !== confirm) {
                    return showToast('Passwords do not match', 'error');
                }

                if (password.length < 6) {
                    return showToast('Password must be at least 6 characters', 'error');
                }

                // Disable buttons during sign up
                const signupForm = document.getElementById('signupForm');
                if (signupForm) {
                    const buttons = signupForm.querySelectorAll('button');
                    buttons.forEach(btn => {
                        btn.disabled = true;
                        btn.style.opacity = '0.6';
                        btn.style.cursor = 'not-allowed';
                    });
                }

                try {
                    await window.signUp(email, password);
                } finally {
                    // Re-enable buttons
                    if (signupForm) {
                        const buttons = signupForm.querySelectorAll('button');
                        buttons.forEach(btn => {
                            btn.disabled = false;
                            btn.style.opacity = '1';
                            btn.style.cursor = 'pointer';
                        });
                    }
                }
            };

            // Enhanced handleSignIn with better error handling
            const originalHandleSignIn = window.handleSignIn;
            window.handleSignIn = async function () {
                try { state.autoAuthDisabled = false; saveData(); } catch { }
                const email = document.getElementById('loginEmail')?.value;
                const password = document.getElementById('loginPassword')?.value;

                if (!email || !password) {
                    return showToast('Please fill in all fields', 'error');
                }

                // Email validation
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email)) {
                    return showToast('Please enter a valid email address', 'error');
                }

                // Disable button during sign in
                const loginForm = document.getElementById('loginForm');
                if (loginForm) {
                    const buttons = loginForm.querySelectorAll('button');
                    buttons.forEach(btn => {
                        btn.disabled = true;
                        btn.style.opacity = '0.6';
                        btn.style.cursor = 'not-allowed';
                    });
                }

                try {
                    const result = await signIn(email, password);
                    if (result) {
                        render();
                    }
                } catch (error) {
                    console.error('Handle sign in error:', error);
                } finally {
                    // Re-enable buttons
                    if (loginForm) {
                        const buttons = loginForm.querySelectorAll('button');
                        buttons.forEach(btn => {
                            btn.disabled = false;
                            btn.style.opacity = '1';
                            btn.style.cursor = 'pointer';
                        });
                    }
                }
            };

            // Enhanced signIn function with better error handling
            const originalSignIn = window.signIn;
            window.signIn = async function (email, password) {
                try {
                    console.log('🔐 Attempting to sign in:', email);

                    const { data, error } = await supabase.auth.signInWithPassword({
                        email: email.trim(),
                        password: password
                    });

                    if (error) {
                        console.error('❌ Sign in error:', error);

                        if (error.message.includes('Invalid login credentials')) {
                            showToast('Invalid email or password', 'error');
                        } else if (error.message.includes('Email not confirmed')) {
                            showToast('Please confirm your email address first', 'error');
                        } else if (error.status === 404) {
                            showToast('Authentication service error. Check your connection.', 'error');
                        } else {
                            showToast('Sign in error: ' + error.message, 'error');
                        }

                        currentUser = null;
                        syncEnabled = false;
                        return null;
                    }

                    currentUser = data.user;
                    syncEnabled = true;

                    showToast('✅ Signed in successfully!', 'success');

                    try {
                        state.activeTab = 'sales';
                        saveData();
                        if (typeof switchTab === 'function') switchTab('sales');
                    } catch {}

                    // Hydrate profile and logo
                    await loadUserProfile();
                    try { await ensureLogoReady(); } catch (e) { /* no-op */ }
                    // if (state.userLogoDataUrl) {
                    //     try { await uploadLogoToSupabase(state.userLogoDataUrl, state.userLogoMime || 'image/png'); } catch (e) { console.warn('Logo upload after sign-in failed:', e); }
                    // }
                    try { window.updateAuthBanner && window.updateAuthBanner(); } catch (e) { /* no-op */ }

                    // Load user profile first
                    await loadUserProfile();

                    // Ensure base64 logo is hydrated (attachment mode)
                    if (state.userLogoDataUrl) {
                        const payload = { logo_data: state.userLogoDataUrl, logo_mime: state.userLogoMime || 'image/png' };
                        if (syncEnabled && currentUser) {
                            if (typeof upsertOne === 'function') {
                                try { await upsertOne('user_profiles', payload, true); } catch (e) { console.warn('Logo persist after sign-in failed:', e); }
                            } else {
                                try { await supabase.from('user_profiles').upsert({ user_id: currentUser.id, ...payload }, { onConflict: 'user_id' }); } catch (e) { console.warn('Logo persist after sign-in failed:', e); }
                            }
                        } else {
                            if (typeof upsertQueue !== 'undefined' && typeof upsertQueue.enqueue === 'function') {
                                try { upsertQueue.enqueue('user_profiles', payload); } catch {}
                            }
                        }
                    }

                    // Check if local data exists
                    const localHasData = state.sales.length > 0 || state.products.length > 0;

                    try {
                        if (localHasData) {
                            showToast('Loading Data...', 'info', null, null, 8000);
                            Promise.resolve().then(() => smartMergeData()).catch((syncError) => {
                                console.error('Sync error after sign in:', syncError);
                                showToast('Signed in but sync failed. Try manual sync.', 'error');
                            });
                        } else {
                            showToast('Loading Data...', 'info', null, null, 8000);
                            Promise.resolve().then(() => pullDataFromSupabase()).catch((syncError) => {
                                console.error('Sync error after sign in:', syncError);
                                showToast('Signed in but sync failed. Try manual sync.', 'error');
                            });
                        }
                    } catch (syncError) {
                        console.error('Sync error after sign in:', syncError);
                        showToast('Signed in but sync failed. Try manual sync.', 'error');
                    }

                    try {
                        if (window.isSecureContext && navigator.credentials && window.PasswordCredential) {
                            const c = new PasswordCredential({ id: email.trim(), password: password });
                            try { navigator.credentials.store(c); } catch (e) { }
                        }
                    } catch (e) { }
                    return data;
                } catch (error) {
                    console.error('Sign in exception:', error);
                    showToast('Sign in error: ' + error.message, 'error');
                    currentUser = null;
                    syncEnabled = false;
                    return null;
                }
            };

            // Diagnostic function - run this in console to test connection
            window.testSupabaseConnection = async function () {
                console.log('🔍 Running Supabase diagnostics...');
                console.log('==========================================');
                console.log('URL:', SUPABASE_URL);
                console.log('Key:', SUPABASE_ANON_KEY.substring(0, 30) + '...');
                console.log('Supabase initialized:', !!supabase);
                console.log('Current user:', currentUser?.email || 'Not logged in');
                console.log('Sync enabled:', syncEnabled);
                console.log('==========================================');

                if (!supabase) {
                    console.error('❌ Supabase not initialized!');
                    console.error('→ Check if the Supabase script loaded correctly');
                    return false;
                }

                try {
                    // Test session
                    console.log('Testing session...');
                    const { data: sessionData, error: sessionError } = await supabase.auth.getSession();

                    if (sessionError) {
                        console.error('❌ Session test failed:', sessionError);
                    } else {
                        console.log('✅ Session test passed');
                    }

                    // Test direct auth endpoint
                    console.log('Testing auth endpoint...');
                    const response = await fetch(SUPABASE_URL + '/auth/v1/health', {
                        headers: {
                            'apikey': SUPABASE_ANON_KEY
                        }
                    });

                    console.log('Auth endpoint status:', response.status);

                    if (response.status === 404) {
                        console.error('❌ 404 Error - Possible issues:');
                        console.error('   1. Incorrect Supabase URL');
                        console.error('   2. Project paused or deleted');
                        console.error('   3. Invalid API key');
                        console.error('→ Go to: https://supabase.com/dashboard');
                        console.error('→ Verify your project settings');
                        return false;
                    } else if (response.ok) {
                        console.log('✅ Auth endpoint accessible');
                    }

                    console.log('==========================================');
                    console.log('✅ Diagnostics complete');
                    return true;

                } catch (error) {
                    console.error('❌ Connection test exception:', error);
                    console.error('→ Check your internet connection');
                    console.error('→ Verify Supabase project is active');
                    return false;
                }
            };

            // Auto-run diagnostics if there's a connection issue
            setTimeout(() => {
                if (!window.supabase || !SUPABASE_URL || !SUPABASE_ANON_KEY) {
                    console.error('⚠️ Supabase configuration incomplete!');
                    console.error('Run testSupabaseConnection() in console for diagnostics');
                }
            }, 2000);

            console.log('✅ Authentication fix patch applied successfully!');
            console.log('💡 Available commands:');
            console.log('   • testSupabaseConnection() - Test your Supabase setup');
            console.log('');
            console.log('🔧 Troubleshooting steps:');
            console.log('   1. Run: testSupabaseConnection()');
            console.log('   2. Check Supabase dashboard: https://supabase.com/dashboard');
            console.log('   3. Verify Email auth is enabled');
            console.log('   4. Check if email confirmation is required');
        })();

        // Mobile App Enhancements
        (function () {
            'use strict';

            // Splash Screen Management
            // Removed in-app pull-to-refresh functionality

            // Offline banner: ensure element exists and update immediately and on connectivity changes
            (function () {
                const getOfflineBannerEl = () => {
                    let el = document.getElementById('offlineBanner');
                    if (!el) {
                        el = document.createElement('div');
                        el.id = 'offlineBanner';
                        el.className = 'offline-banner';
                        el.setAttribute('role', 'status');
                        el.setAttribute('aria-live', 'polite');
                        el.setAttribute('aria-atomic', 'true');
                        const headerEl = document.querySelector('.header');
                        if (headerEl && headerEl.parentNode) {
                            headerEl.parentNode.insertBefore(el, headerEl.nextSibling);
                        } else if (document.body) {
                            document.body.insertBefore(el, document.body.firstChild);
                        }
                    }
                    return el;
                };

                // State tracking - default to navigator.onLine
                let isAppOnline = navigator.onLine;
                let lastPingSuccessAt = 0;
                const ua = navigator.userAgent || navigator.vendor || window.opera;
                const isIOS = /iPad|iPhone|iPod/.test(ua) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
                window.isEffectivelyOnline = function () { return isAppOnline; };

                const updateOfflineBanner = () => {
                    const offlineBannerEl = getOfflineBannerEl();
                    if (!offlineBannerEl) return;

                    const recentPingOK = (Date.now() - lastPingSuccessAt) < 15000;
                    const effectiveOnline = navigator.onLine || recentPingOK || isAppOnline;

                    if (effectiveOnline) {
                        offlineBannerEl.style.display = 'none';
                        offlineBannerEl.textContent = '';
                        offlineBannerEl.onclick = null;
                        offlineBannerEl.classList.remove('clickable');
                    } else {
                        offlineBannerEl.innerHTML = "You're offline — Changes are saved locally <span style='opacity:0.9'>(Click for Info)</span>";
                        offlineBannerEl.style.display = 'block';
                        offlineBannerEl.onclick = () => { try { openOfflineInfoModal(); } catch (e) { } };
                        offlineBannerEl.classList.add('clickable');
                    }
                    try { adjustContentPadding(); } catch { }
                };

                // Robust connectivity check (for secondary verification)
                async function checkConnectivity() {
                    if (!navigator.onLine) return false;
                    try {
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 3000);
                        const res = await fetch(SUPABASE_URL + '/auth/v1/health', {
                            method: 'GET',
                            headers: { 'apikey': SUPABASE_ANON_KEY },
                            cache: 'no-store',
                            signal: controller.signal
                        });
                        clearTimeout(timeoutId);
                        lastPingSuccessAt = Date.now();
                        return true; // treat any response as reachable
                    } catch (e) {
                        return false;
                    }
                }

                // Event listeners - respond IMMEDIATELY to browser events
                window.addEventListener('online', async () => {
                    if (isIOS) {
                        isAppOnline = true;
                        lastPingSuccessAt = Date.now();
                        updateOfflineBanner();
                        window.updateAuthBanner && window.updateAuthBanner();
                        try {
                            if (currentUser) {
                                syncEnabled = true;
                                updateSyncIndicator('synced');
                                try { upsertQueue && upsertQueue.process && upsertQueue.process(); } catch { }
                                try { deleteQueue && deleteQueue.process && deleteQueue.process(); } catch { }
                            } else {
                                syncEnabled = false;
                                updateSyncIndicator('offline');
                            }
                        } catch { }
                        try {
                            if (window.__offlineWasDetected) {
                                window.__offlineWasDetected = false;
                                try {
                                    try { state.lastInteractionInProgress = false; } catch {}
                                    try { render && render(); } catch {}
                                    var b = document.querySelector('button[aria-label="Refresh"]');
                                    if (b && typeof b.click === 'function') { b.click(); } else { refreshApp(); }
                                } catch { }
                                return;
                            }
                        } catch { }
                    } else {
                        // Show online immediately based on browser event
                        isAppOnline = true;
                        updateOfflineBanner();
                        try {
                            if (currentUser) {
                                syncEnabled = true;
                                updateSyncIndicator('synced');
                                try { upsertQueue && upsertQueue.process && upsertQueue.process(); } catch { }
                                try { deleteQueue && deleteQueue.process && deleteQueue.process(); } catch { }
                            } else {
                                syncEnabled = false;
                                updateSyncIndicator('offline');
                            }
                        } catch { }
                        // Then verify with ping in background (don't wait for it)
                        // Do not flip offline banner based on server reachability; keep using navigator.onLine
                        try {
                            if (window.__offlineWasDetected) {
                                window.__offlineWasDetected = false;
                                try {
                                    try { state.lastInteractionInProgress = false; } catch {}
                                    try { render && render(); } catch {}
                                    var b2 = document.querySelector('button[aria-label="Refresh"]');
                                    if (b2 && typeof b2.click === 'function') { b2.click(); } else { refreshApp(); }
                                } catch { }
                                return;
                            }
                        } catch { }
                    }
                });

                window.addEventListener('offline', () => {
                    // Show offline IMMEDIATELY
                    isAppOnline = false;
                    updateOfflineBanner();
                    try {
                        syncEnabled = false;
                        updateSyncIndicator('offline');
                        window.updateAuthBanner && window.updateAuthBanner();
                        window.__offlineWasDetected = true;
                        if (!window.__autoExportTriggered) {
                            window.__autoExportTriggered = true;
                            var s = document.querySelector('button[title="💾"]');
                            if (s && typeof s.click === 'function') { s.click(); } else { exportData(); }
                        }
                    } catch { }
                    // Probe connectivity; if reachable, clear offline state
                    checkConnectivity().then(ok => { if (ok) { isAppOnline = true; updateOfflineBanner(); window.updateAuthBanner && window.updateAuthBanner(); } });
                });

                // Periodic check loop (every 2 seconds); special handling for iOS to prevent flicker
                setInterval(async () => {
                    const navOnline = navigator.onLine;

                    if (isIOS) {
                        if (!navOnline && isAppOnline) {
                            isAppOnline = false;
                            updateOfflineBanner();
                            window.updateAuthBanner && window.updateAuthBanner();
                            checkConnectivity().then(ok => { if (ok) { isAppOnline = true; updateOfflineBanner(); window.updateAuthBanner && window.updateAuthBanner(); } });
                        } else if (navOnline && !isAppOnline) {
                            isAppOnline = true;
                            lastPingSuccessAt = Date.now();
                            updateOfflineBanner();
                            window.updateAuthBanner && window.updateAuthBanner();
                            try {
                                if (window.__offlineWasDetected) {
                                    window.__offlineWasDetected = false;
                                    try {
                                        var b3 = document.querySelector('button[aria-label="Refresh"]');
                                        if (b3 && typeof b3.click === 'function') { b3.click(); } else { refreshApp(); }
                                    } catch { }
                                    return;
                                }
                            } catch { }
                        }
                    } else {
                        if (navOnline !== isAppOnline) {
                            isAppOnline = navOnline;
                            updateOfflineBanner();
                            window.updateAuthBanner && window.updateAuthBanner();
                            try {
                                if (navOnline && window.__offlineWasDetected) {
                                    window.__offlineWasDetected = false;
                                    try {
                                        var b4 = document.querySelector('button[aria-label="Refresh"]');
                                        if (b4 && typeof b4.click === 'function') { b4.click(); } else { refreshApp(); }
                                    } catch { }
                                    try { window.__autoExportTriggered = false; } catch {}
                                    return;
                                }
                            } catch { }
                        }
                    }
                }, 2000);

                // Initial check - start optimistically online to prevent flicker
                // Don't show banner immediately, verify connectivity first
                (async () => {
                    isAppOnline = navigator.onLine;
                    if (!isAppOnline) {
                        const ok = await checkConnectivity();
                        isAppOnline = !!ok;
                    } else {
                        checkConnectivity().catch(()=>{});
                    }
                    updateOfflineBanner();
                })();

                window.updateOfflineBanner = updateOfflineBanner;
            })();

            (function(){
                try {
                    const orig = window.fetch;
                    window.fetch = async function(input, init){
                        try {
                            const url = (typeof input === 'string') ? input : (input && input.url ? input.url : '');
                            if (typeof url === 'string' && url.indexOf(SUPABASE_URL + '/rest/v1') === 0) {
                                const u = new URL(url);
                                u.searchParams.delete('columns');
                                const hdrs = new Headers((init && init.headers) || ((typeof input !== 'string' && input && input.headers) ? input.headers : {}));
                                if (SUPABASE_ANON_KEY) {
                                    if (!hdrs.has('apikey')) hdrs.set('apikey', SUPABASE_ANON_KEY);
                                    if (!hdrs.has('Authorization')) hdrs.set('Authorization', 'Bearer ' + SUPABASE_ANON_KEY);
                                }
                                if (u.searchParams.get('on_conflict') && !hdrs.has('Prefer')) hdrs.set('Prefer', 'resolution=merge-duplicates,return=representation');
                                const method = (init && init.method) || ((typeof input !== 'string' && input && input.method) ? input.method : 'GET');
                                if (method && method.toUpperCase() !== 'GET' && method.toUpperCase() !== 'HEAD') {
                                    if (!hdrs.has('Content-Type')) hdrs.set('Content-Type', 'application/json');
                                    if (init && init.body && typeof init.body !== 'string') init.body = JSON.stringify(init.body);
                                }
                                init = { ...(init || {}), headers: hdrs };
                                input = (typeof input === 'string') ? u.toString() : new Request(u.toString(), init);
                            }
                        } catch {}
                        return orig.apply(this, arguments);
                    };
                } catch {}
            })();
            (function () {
                let isAuthRestoring = false;
                const getAuthBannerEl = () => {
                    let el = document.getElementById('authBanner');
                    if (!el) {
                        el = document.createElement('div');
                        el.id = 'authBanner';
                        el.className = 'offline-banner auth-banner';
                        el.setAttribute('role', 'status');
                        el.setAttribute('aria-live', 'polite');
                        el.setAttribute('aria-atomic', 'true');
                        const headerEl = document.querySelector('.header');
                        if (headerEl && headerEl.parentNode) {
                            headerEl.parentNode.insertBefore(el, headerEl.nextSibling.nextSibling);
                        } else if (document.body) {
                            document.body.insertBefore(el, document.body.firstChild);
                        }
                    }
                    return el;
                };
                window.updateAuthBanner = () => {
                    const el = getAuthBannerEl();
                    if (!el) return;

                    // PRIORITY 1: If offline (effective), hide auth banner (offline banner takes priority)
                    const effectiveOnline = (window.isEffectivelyOnline ? window.isEffectivelyOnline() : navigator.onLine);
                    if (!effectiveOnline) {
                        el.style.display = 'none';
                        el.textContent = '';
                        el.onclick = null;
                        try { adjustContentPadding(); } catch { }
                        return;
                    }

                    // PRIORITY 2: If restoring session, show restoring message
                    if (isAuthRestoring) {
                        el.innerHTML = "Restoring session…";
                        el.style.display = 'block';
                        el.onclick = null;
                    }
                    // PRIORITY 3: If signed in, hide auth banner
                    else if (currentUser && syncEnabled) {
                        el.style.display = 'none';
                        el.textContent = '';
                        el.onclick = null;
                    }
                    // PRIORITY 4: If online but not signed in, show sign-in prompt
                    else {
                        el.innerHTML = "You're not signed in — tap to sign in and sync.";
                        el.style.display = 'block';
                        el.onclick = () => {
                            try {
                                switchTab('account');
                                setTimeout(() => {
                                    try { switchAuthTab('login'); } catch (e) { }
                                    const card = document.getElementById('cloudSyncCard');
                                    card && card.scrollIntoView({ behavior: 'smooth', block: 'start' });
                                }, 50);
                            } catch (e) { }
                        };
                    }
                    try { adjustContentPadding(); } catch { }
                };
                window.updateAuthBanner();

                // When coming online: hide offline banner, restore session, update auth banner
                window.addEventListener('online', async () => {
                    try {
                        // 1. Hide offline banner immediately
                        if (window.updateOfflineBanner) window.updateOfflineBanner();

                        // 2. Attempt session restore
                        if (window.supabase && supabase && supabase.auth && !currentUser) {
                            try {
                                window.setAuthRestoring && window.setAuthRestoring(true);
                                window.updateAuthBanner && window.updateAuthBanner();

                                const { data: { session } } = await supabase.auth.getSession();
                                if (session && session.user) {
                                    currentUser = session.user;
                                    syncEnabled = true;
                                    console.log('✅ Session restored on reconnect');
                                }
                            } catch (e) {
                                console.warn('Session restore on reconnect failed:', e);
                            } finally {
                                window.setAuthRestoring && window.setAuthRestoring(false);
                            }
                        }

                        // 3. Update auth banner based on new state
                        window.updateAuthBanner && window.updateAuthBanner();

                // 4. Show toast if not signed in
                if (!currentUser) {
                    showToast('Back online — sign in to sync your data', 'info');
                }
                try { state.lastInteractionInProgress = false; } catch {}
                try { render && render(); } catch {}
                    } catch (e) {
                        console.error('Online event handler error:', e);
                    }
                });

                // When going offline: hide auth banner, show offline banner
                window.addEventListener('offline', () => {
                    try {
                        window.updateAuthBanner && window.updateAuthBanner();
                        window.updateOfflineBanner && window.updateOfflineBanner();
                    } catch { }
                });

                // iOS offline detection workaround for auth banner
                // iOS browsers don't reliably fire offline/online events
                let lastAuthOnlineState = navigator.onLine;
                setInterval(() => {
                    const currentAuthOnlineState = navigator.onLine;
                    if (currentAuthOnlineState !== lastAuthOnlineState) {
                        lastAuthOnlineState = currentAuthOnlineState;
                        console.log(`📡 Auth banner connection state changed (iOS workaround): ${currentAuthOnlineState ? 'online' : 'offline'}`);
                        try { window.updateAuthBanner(); } catch { }
                        if (currentAuthOnlineState && !currentUser) {
                            try { showToast('Back online — sign in to sync your data', 'info'); } catch { }
                        }
                    }
                }, 1000); // Check every 1 second

                window.setAuthRestoring = (v) => {
                    isAuthRestoring = !!v;
                    try { window.updateAuthBanner && window.updateAuthBanner(); } catch {}
                    if (isAuthRestoring) {
                        const startedAt = Date.now();
                        setTimeout(() => {
                            try {
                                const stillRestoring = isAuthRestoring === true;
                                const noUser = !currentUser;
                                const online = (window.isEffectivelyOnline ? window.isEffectivelyOnline() : navigator.onLine);
                                if (stillRestoring && noUser && online && (Date.now() - startedAt) >= 3000) {
                                    isAuthRestoring = false;
                                    window.updateAuthBanner && window.updateAuthBanner();
                                }
                            } catch {}
                        }, 3000);
                    }
                };
                })();

            // Service Worker Registration and Capacitor Initialization
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', async () => {
                    try {
                        // Initialize Capacitor plugins if available
                        if (window.Capacitor) {
                            const { CapacitorApp } = await import('@capacitor/app');
                            const { StatusBar, Style } = await import('@capacitor/status-bar');

                            // Set status bar style
                            await StatusBar.setStyle({ style: Style.Dark });

                            console.log('Capacitor plugins initialized');
                        }

                        const swUrl = './sw.js' + (window.APP_VERSION ? ('?v=' + window.APP_VERSION) : '');
                        const registration = await navigator.serviceWorker.register(swUrl);
                        try { await registration.update(); } catch {}
                        console.log('SW registered: ', registration);
                        try { await registration.update(); } catch { }
                        try {
                            setInterval(() => { registration.update().catch(() => {}); }, 60000);
                        } catch {}

                        try {
                            window.addEventListener('visibilitychange', () => {
                                if (document.visibilityState === 'visible') {
                                    registration.update().catch(() => {});
                                }
                            });
                        } catch {}

                        try {
                            window.addEventListener('focus', () => {
                                registration.update().catch(() => {});
                            });
                        } catch {}

                        try {
                            window.addEventListener('online', () => {
                                registration.update().catch(() => {});
                            });
                        } catch {}

                        try {
                            navigator.serviceWorker.addEventListener('message', (event) => {
                                const d = event && event.data;
                                if (d && (d.type === 'sw-updated' || d.type === 'content-updated')) {
                                    try { window.location.reload(); } catch { }
                                }
                            });
                        } catch { }

                        try {
                            navigator.serviceWorker.addEventListener('controllerchange', () => {
                                try { window.location.reload(); } catch { }
                            });
                        } catch { }





                        // Initial state and event listeners
                        window.updateAuthBanner && window.updateAuthBanner();
                        // Periodic auth heartbeat to keep UI in sync
                        async function refreshAuthState() {
                            try {
                                if (!navigator.onLine) return;
                                if (!window.supabase || !supabase || !supabase.auth) return;
                                const { data: { session } } = await supabase.auth.getSession();
                                if (session && session.user) {
                                    currentUser = session.user;
                                    syncEnabled = true;
                                    try { clearAllSearchInputs(); } catch {}
                                    try {
                                        const t = (session.user?.user_metadata?.theme || '').toLowerCase();
                                        if (t === 'dark' || t === 'light' || t === 'paywall' || t === 'blue') {
                                            const normalized = (t === 'paywall') ? 'blue' : t;
                                            if (state.theme !== normalized) {
                                                state.theme = normalized;
                                                saveData();
                                                applyTheme();
                                            }
                                        }
                                    } catch (e) { }
                                } else {
                                    currentUser = null;
                                    syncEnabled = false;
                                }
                            } catch { }
                            try { window.setAuthRestoring(false); } catch { }
                            window.updateAuthBanner && window.updateAuthBanner();
                            updateSideNavAuthButton && updateSideNavAuthButton();
                        }
                        // On load, after SW ready, reconcile auth state
                        try { refreshAuthState(); } catch { }
                        // Also reconcile on online and visibility changes
                        window.addEventListener('online', refreshAuthState);
                        document.addEventListener('visibilitychange', () => { if (!document.hidden) refreshAuthState(); });
                        // Cross-tab sync via storage events
                        window.addEventListener('storage', (e) => {
                            const k = e.key || '';
                            if (k.includes('tuba-auth-token') || k.includes('sb-')) {
                                refreshAuthState();
                            }
                        });
                        // Periodic heartbeat
                        setInterval(refreshAuthState, 60000);
                        window.addEventListener('online', () => {
                            window.updateAuthBanner && window.updateAuthBanner();
                            try {
                                if (navigator.serviceWorker && navigator.serviceWorker.ready) {
                                    navigator.serviceWorker.ready.then(reg => {
                                        if (reg.sync && typeof reg.sync.register === 'function') {
                                            reg.sync.register('background-sync').catch(() => { });
                                        }
                                    });
                                }
                                // Trigger a background sync merge immediately when online
                                if (syncEnabled && currentUser) {
                                    try { syncInBackground(); } catch (e) { /* no-op */ }
                                }
                            } catch (e) { /* no-op */ }
                        });
                        window.addEventListener('offline', () => {
                            window.updateAuthBanner && window.updateAuthBanner();
                        });

                        // Check for updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    showToast('New version available! Refresh to update.', 'info');
                                }
                            });
                        });
                        // FAB removed; bottom tabs used for navigation
                    } catch (error) {
                        console.log('SW registration failed: ', error);
                    }
                });
            }

            // Enhanced Touch Feedback
            function addTouchFeedback() {
                const touchElements = document.querySelectorAll('button, .btn, .nav-item, .stat-card, .item, .quick-nav-btn');

                touchElements.forEach(element => {
                    element.addEventListener('touchstart', function () {
                        this.style.transform = 'scale(0.98)';
                        this.style.transition = 'transform 0.1s ease';
                    });

                    element.addEventListener('touchend', function () {
                        this.style.transform = '';
                    });

                    element.addEventListener('touchcancel', function () {
                        this.style.transform = '';
                    });
                });
            }

            // Prevent zoom on double tap
            let lastTouchEnd = 0;
            document.addEventListener('touchend', function (event) {
                const now = (new Date()).getTime();
                if (now - lastTouchEnd <= 300) {
                    event.preventDefault();
                }
                lastTouchEnd = now;
            }, false);

            // Initialize mobile features
            document.addEventListener('DOMContentLoaded', function () {
                addTouchFeedback();
                try { if (!isIOSSafari()) { attemptSilentCredentialSignIn(); } } catch (e) { }
                if (!currentUser && !isIOSSafari()) {
                    try { autoSubmitLoginIfAutofilled(); } catch (e) { }
                }

                // Ensure apple-touch-icon hrefs are absolute for iOS launchers
                try {
                    const origin = window.location.origin || '';
                    document.querySelectorAll('link[rel="apple-touch-icon"], link[rel="apple-touch-icon-precomposed"]').forEach(link => {
                        const href = link.getAttribute('href') || '';
                        if (href && !href.startsWith('http') && origin) {
                            link.setAttribute('href', origin.replace(/\/$/, '') + '/' + href.replace(/^\//, ''));
                        }
                    });
                } catch { }

                window.addEventListener('orientationchange', function () {
                    setTimeout(() => {
                        window.scrollTo(0, 1);
                        try { adjustContentPadding(); } catch { }
                    }, 500);
                });

                document.addEventListener('visibilitychange', function () {
                    if (document.visibilityState === 'visible') {
                        console.log('App became visible');
                    }
                });
            });

            // Expose functions globally for debugging
            window.mobileApp = {
                installApp,
                addTouchFeedback
            };
        })();

    </script>
    <div class="modal" id="reportRangeModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeReportRangeModal()">×</button>
            <div class="modal-title">General Report (PDF)</div>
            <div style="margin-top:8px;">
                <div class="grid-2" style="gap:8px;">
                    <div>
                        <label>From</label>
                        <input type="date" id="reportFromDate" />
                    </div>
                    <div>
                        <label>To</label>
                        <input type="date" id="reportToDate" />
                    </div>
                </div>
            </div>
            <div class="form-group" style="margin-top:8px;">
                <label>Mode</label>
                <select id="reportModeSelect">
                    <option value="stacked" selected>Stacked Summaries</option>
                    <option value="individual">Individual Items</option>
                </select>
            </div>
            <div class="flex-gap" style="margin-top:12px;">
                <button class="btn-small" onclick="applyReportRange('selected')">Download Selected (PDF)</button>
                <button class="btn-small" onclick="applyReportRange('all')">Download All (PDF)</button>
                <button class="btn-small" onclick="applyReportExcel()">Download Excel</button>
                <button class="btn-secondary btn-small" onclick="closeReportRangeModal()">Cancel</button>
                <button class="btn-secondary btn-small" onclick="closeReportRangeModal()">Exit</button>
            </div>
        </div>
    </div>
    
    <script src="js/main.js" type="module"></script>
</body>

</html>
